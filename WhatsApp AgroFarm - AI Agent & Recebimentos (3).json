{
  "name": "WhatsApp AgroFarm - AI Agent & Recebimentos",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-recebido",
        "options": {}
      },
      "id": "6f38ce0a-a5ed-49ef-85c7-e63e645a02e3",
      "name": "Webhook Z-API",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -500,
        1536
      ],
      "webhookId": "c9cb34e7-772f-4587-9910-bb4c4b57570b"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ !!$json.body?.audio?.audioUrl }}",
              "value2": true
            }
          ]
        }
      },
      "id": "a1b2c3d4-1111-2222-3333-444455556666",
      "name": "√â √Åudio?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -300,
        1536
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://agrofarm01-production.up.railway.app/api/farm/webhook/n8n/transcribe-audio",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={ \"audioUrl\": \"{{ $('Webhook Z-API').first().json.body.audio.audioUrl }}\" }",
        "options": {}
      },
      "id": "a1b2c3d4-5555-6666-7777-888899990000",
      "name": "Transcrever √Åudio (Gemini)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -100,
        1376
      ]
    },
    {
      "parameters": {
        "jsCode": "// Monta o payload como se fosse uma mensagem de texto normal\n// para o AI Agent processar a transcri√ß√£o do √°udio\nconst webhookData = $('Webhook Z-API').first().json;\nconst transcription = $input.first().json.transcription || 'N√£o consegui entender o √°udio';\n\nreturn [{\n  json: {\n    body: {\n      phone: webhookData.body.phone,\n      text: { message: transcription },\n      message: transcription,\n      isAudioTranscription: true\n    }\n  }\n}];"
      },
      "id": "a1b2c3d4-aaaa-bbbb-cccc-ddddeeeeffff",
      "name": "Montar Texto do √Åudio",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        100,
        1376
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ !!$json.body?.image?.imageUrl || !!$json.body?.document?.documentUrl }}",
              "value2": true
            }
          ]
        }
      },
      "id": "79d8473a-2327-400f-a042-a65225928733",
      "name": "√â Imagem?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -100,
        1680
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://agrofarm01-production.up.railway.app/api/farm/webhook/n8n/receipt",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={ \"whatsapp_number\": \"{{ $json.body.phone }}\", \"imageUrl\": \"{{ $json.body.image?.imageUrl || $json.body.document?.documentUrl }}\" }",
        "options": {}
      },
      "id": "fd5bd74f-7009-4f2e-b705-538ba97c39c6",
      "name": "Processar Recibo Inteligente",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        200,
        1536
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3EE9E067CA2DB1B055091AD735EF201A/token/9938EA066A5F1A693D48545A/send-text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F17220cd7efa3420282c5cc5f3f0746b9S"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $node[\"Webhook Z-API\"].json.body.phone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.message }}"
            }
          ]
        },
        "options": {}
      },
      "id": "cb43d113-6bf6-422b-b872-3336eb3f718f",
      "name": "Responder (Sucesso Imagem)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        500,
        1536
      ]
    },
    {
      "parameters": {
        "text": "=Mensagem: {{ $json.body.text.message || $json.body.message }} | Celular Autorizado: {{ $json.body.phone }}",
        "options": {
          "systemMessage": "=Voc√™ √© o *AgroZap* üåæü§ñ, assistente virtual da AgroFarm Digital. Voc√™ √© simp√°tico, pr√≥ximo e entende o dia a dia do agricultor. Fale como um parceiro de confian√ßa ‚Äî nunca rob√≥tico.\n\n## PERSONALIDADE\n- Seja caloroso e amig√°vel, como algu√©m que trabalha junto no campo\n- Use linguagem natural do agro (safra, talh√£o, lavoura, aplica√ß√£o, defensivo)\n- Use emojis com modera√ß√£o: üåæüöúüí∞üì¶üåø‚úÖ (m√°ximo 2-3 por mensagem)\n- Responda de forma CURTA (m√°ximo 3-4 linhas), exceto quando listar dados\n- Trate o agricultor pelo nome se poss√≠vel\n- Se n√£o souber algo, diga \"n√£o encontrei\" de forma gentil e sugira o que ele pode fazer\n\n## TOM DE VOZ\n- ‚ùå \"N√£o encontrei resultados para sua consulta\" ‚Üí ‚ùå Rob√≥tico\n- ‚úÖ \"Hmm, n√£o achei esse produto no seu hist√≥rico ü§î Tenta me dizer o nome completo?\" ‚Üí ‚úÖ Humano\n- ‚ùå \"Aqui est√£o os dados solicitados:\" ‚Üí ‚ùå Formal demais\n- ‚úÖ \"Achei! Olha s√≥ os pre√ßos que voc√™ pagou:\" ‚Üí ‚úÖ Natural\n\n## FORMATO DAS RESPOSTAS\n- Para LISTAS de produtos/pre√ßos/estoque: use formato de lista com quebras de linha\n  üì¶ *Produto:* nome\n  üí∞ *Pre√ßo:* R$ X,XX\n  üìÖ *Data:* DD/MM/YYYY\n  üè™ *Fornecedor:* nome\n- Para respostas SIMPLES: texto corrido natural\n- Use *negrito* para destaque (padr√£o WhatsApp)\n- NUNCA use markdown com # ou ```\n\n## INTELIG√äNCIA CONVERSACIONAL\n- Se o agricultor fizer uma sauda√ß√£o (oi, ol√°, bom dia), cumprimente de volta e pergunte como pode ajudar\n- Se perguntar algo vago como \"pre√ßo\", pergunte: \"De qual produto voc√™ quer saber o pre√ßo? üåæ\"\n- Se o dado retornado estiver vazio, sugira alternativas: \"N√£o encontrei esse produto. Quer que eu busque por outro nome?\"\n- SEMPRE interprete os dados retornados pelas ferramentas e responda de forma resumida e √∫til\n- Se houver v√°rios resultados, destaque o mais recente como refer√™ncia principal\n- Compare pre√ßos quando houver hist√≥rico: \"O Flumitop custou R$ 94,00 em setembro. Quer que eu veja se tem mais recente?\"\n\n## FERRAMENTAS DISPON√çVEIS\nVoc√™ tem 5 ferramentas. Use a mais adequada para cada pergunta:\n1. *ConsultarEstoque* ‚Üí \"quanto tenho de...\", \"tem X no estoque?\"\n2. *ConsultarAplicacoes* ‚Üí \"√∫ltimas aplica√ß√µes\", \"o que foi aplicado?\"\n3. *ConsultarPrecoProduto* ‚Üí \"pre√ßo do glifosato\", \"quanto paguei por...\", \"hist√≥rico de compra\"\n4. *Tool_ConsultarFaturas* ‚Üí \"faturas\", \"despesas\", \"notas fiscais\"\n5. *ConsultarManuaisAgronomicos* ‚Üí \"como aplicar X?\", \"bula do produto\", \"dose recomendada\"\n\n## REGRAS T√âCNICAS\n- WhatsApp do agricultor: {{$json.body.phone}}\n- Passe sempre como STRING ao chamar tools\n- Para pre√ßos, envie o nome do produto no par√¢metro 'search'\n- Se os dados retornados pela tool estiverem vazios, N√ÉO invente dados"
        }
      },
      "id": "5f1cb8e3-71c2-4274-ac28-7f35e60477ad",
      "name": "AgroFarm AI Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1,
      "position": [
        300,
        1800
      ]
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.5
        }
      },
      "id": "1f153d8d-8869-49eb-9aab-1672246964c2",
      "name": "Google Gemini Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        100,
        2064
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/3EE9E067CA2DB1B055091AD735EF201A/token/9938EA066A5F1A693D48545A/send-text",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "client-token",
              "value": "F17220cd7efa3420282c5cc5f3f0746b9S"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "phone",
              "value": "={{ $('Webhook Z-API').first().json.body.phone }}"
            },
            {
              "name": "message",
              "value": "={{ $json.output }}"
            }
          ]
        },
        "options": {}
      },
      "id": "dcb1f530-15a3-4e10-b5cb-0f9e7c0a7d3a",
      "name": "Responder (IA Agent Text)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        600,
        1800
      ]
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Webhook Z-API').first().json.body.phone }}"
      },
      "id": "c78b5b31-9c34-443e-b60d-b77ab6ad4a03",
      "name": "Mem√≥ria (Window Buffer)",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1,
      "position": [
        300,
        2064
      ]
    },
    {
      "parameters": {
        "toolDescription": "Usa esta ferramenta para consultar despesas e faturas recentes do agricultor. Retorna fornecedor, valor total, data e status de cada fatura.",
        "url": "https://agrofarm01-production.up.railway.app/api/farm/webhook/n8n/invoices",
        "sendQuery": true,
        "parametersQuery": {
          "values": [
            {
              "name": "whatsapp_number",
              "valueProvider": "fieldValue",
              "value": "={{ $('Webhook Z-API').first().json.body.phone }}"
            }
          ]
        },
        "sendHeaders": true,
        "parametersHeaders": {
          "values": [
            {
              "name": "User-Agent",
              "valueProvider": "fieldValue",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            }
          ]
        }
      },
      "id": "9c1fe4b2-e1cb-4f9c-8f7f-8d0f9b1c3e5a",
      "name": "Tool_ConsultarFaturas",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1,
      "position": [
        -16,
        2208
      ]
    },
    {
      "parameters": {
        "url": "https://agrofarm01-production.up.railway.app/api/farm/webhook/n8n/stock",
        "sendQuery": true,
        "parametersQuery": {
          "values": [
            {
              "name": "whatsapp_number",
              "valueProvider": "fieldValue",
              "value": "={{ $('Webhook Z-API').first().json.body.phone }}"
            }
          ]
        },
        "sendHeaders": true,
        "parametersHeaders": {
          "values": [
            {
              "name": "User-Agent",
              "valueProvider": "fieldValue",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            }
          ]
        },
        "toolDescription": "Usa esta ferramenta para verificar a quantidade de produtos dispon√≠veis no estoque do usu√°rio (fazenda) no momento."
      },
      "id": "e5b5205a-6da4-45f8-8d9a-75ecf6462aa6",
      "name": "ConsultarEstoque",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1,
      "position": [
        184,
        2208
      ]
    },
    {
      "parameters": {
        "url": "https://agrofarm01-production.up.railway.app/api/farm/webhook/n8n/applications",
        "sendQuery": true,
        "parametersQuery": {
          "values": [
            {
              "name": "whatsapp_number",
              "valueProvider": "fieldValue",
              "value": "={{ $('Webhook Z-API').first().json.body.phone }}"
            }
          ]
        },
        "sendHeaders": true,
        "parametersHeaders": {
          "values": [
            {
              "name": "User-Agent",
              "valueProvider": "fieldValue",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            }
          ]
        },
        "toolDescription": "Usa esta ferramenta para consultar as aplica√ß√µes de produtos realizadas no campo pelo agricultor."
      },
      "id": "b3a4c5d6-7e8f-9a0b-1c2d-3e4f5a6b7c8d",
      "name": "ConsultarAplicacoes",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1,
      "position": [
        384,
        2208
      ]
    },
    {
      "parameters": {
        "toolDescription": "Usa esta ferramenta para consultar manuais e bulas agron√¥micas dos produtos. Envie o nome do produto a ser pesquisado.",
        "url": "https://agrofarm01-production.up.railway.app/api/farm/webhook/n8n/manuals",
        "sendQuery": true,
        "parametersQuery": {
          "values": [
            {
              "name": "whatsapp_number",
              "valueProvider": "fieldValue",
              "value": "={{ $('Webhook Z-API').first().json.body.phone }}"
            },
            {
              "name": "search",
              "valueProvider": "fieldValue",
              "value": "={{ $fromAI('search', 'Nome do produto para buscar o manual/bula', 'string') }}"
            }
          ]
        },
        "sendHeaders": true,
        "parametersHeaders": {
          "values": [
            {
              "name": "User-Agent",
              "valueProvider": "fieldValue",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            }
          ]
        }
      },
      "id": "d5e6f7a8-b9c0-1d2e-3f4a-5b6c7d8e9f0a",
      "name": "ConsultarManuaisAgronomicos",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1,
      "position": [
        584,
        2208
      ]
    },
    {
      "parameters": {
        "toolDescription": "Usa esta ferramenta para consultar o PRE√áO de um produto espec√≠fico comprado pelo agricultor. Envie o nome do produto no par√¢metro 'search'. Retorna data da compra, fornecedor, produto, quantidade e pre√ßo unit√°rio.",
        "url": "https://agrofarm01-production.up.railway.app/api/farm/webhook/n8n/prices",
        "sendQuery": true,
        "parametersQuery": {
          "values": [
            {
              "name": "whatsapp_number",
              "valueProvider": "fieldValue",
              "value": "={{ $('Webhook Z-API').first().json.body.phone }}"
            },
            {
              "name": "search",
              "valueProvider": "fieldValue",
              "value": "={{ $fromAI('search', 'Nome do produto a buscar. Ex: glifosato, flumitop, semente', 'string') }}"
            }
          ]
        },
        "sendHeaders": true,
        "parametersHeaders": {
          "values": [
            {
              "name": "User-Agent",
              "valueProvider": "fieldValue",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
            }
          ]
        }
      },
      "id": "e6e0dc69-727e-4b4e-8744-e09c57d29fcf",
      "name": "ConsultarPrecoProduto",
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1,
      "position": [
        784,
        2208
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook Z-API": {
      "main": [
        [
          {
            "node": "√â √Åudio?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "√â √Åudio?": {
      "main": [
        [
          {
            "node": "Transcrever √Åudio (Gemini)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "√â Imagem?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcrever √Åudio (Gemini)": {
      "main": [
        [
          {
            "node": "Montar Texto do √Åudio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Montar Texto do √Åudio": {
      "main": [
        [
          {
            "node": "AgroFarm AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "√â Imagem?": {
      "main": [
        [
          {
            "node": "Processar Recibo Inteligente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AgroFarm AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Recibo Inteligente": {
      "main": [
        [
          {
            "node": "Responder (Sucesso Imagem)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AgroFarm AI Agent": {
      "main": [
        [
          {
            "node": "Responder (IA Agent Text)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Model": {
      "ai_languageModel": [
        [
          {
            "node": "AgroFarm AI Agent",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "ConsultarManuaisAgronomicos",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Mem√≥ria (Window Buffer)": {
      "ai_memory": [
        [
          {
            "node": "AgroFarm AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Tool_ConsultarFaturas": {
      "ai_tool": [
        [
          {
            "node": "AgroFarm AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "ConsultarEstoque": {
      "ai_tool": [
        [
          {
            "node": "AgroFarm AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "ConsultarAplicacoes": {
      "ai_tool": [
        [
          {
            "node": "AgroFarm AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "ConsultarManuaisAgronomicos": {
      "ai_tool": [
        [
          {
            "node": "AgroFarm AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "ConsultarPrecoProduto": {
      "ai_tool": [
        [
          {
            "node": "AgroFarm AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false
  },
  "versionId": "bb2126d2-b137-4688-89c3-d7d792d3df5d",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "a939899d1215f1aae302cbc8a068b07f3522ec7c828451b54c395d8f2a932836"
  },
  "id": "xQ3HPqxlxhOf5k0J",
  "tags": []
}