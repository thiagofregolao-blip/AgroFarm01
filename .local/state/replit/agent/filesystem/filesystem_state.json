{"file_contents":{"client/src/pages/metas.tsx":{"content":"import Navbar from \"@/components/layout/navbar\";\nimport Header from \"@/components/layout/header\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from \"@/components/ui/alert-dialog\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Plus, Target, TrendingUp, Calendar, Edit, CheckCircle, Trash2 } from \"lucide-react\";\nimport { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';\nimport { format } from \"date-fns\";\nimport type { Season, SeasonGoal, InsertSeasonGoal } from \"@shared/schema\";\n\nexport default function Metas() {\n  const [showNewGoalModal, setShowNewGoalModal] = useState(false);\n  const [selectedSeason, setSelectedSeason] = useState(\"\");\n  const [editingGoal, setEditingGoal] = useState<SeasonGoal | null>(null);\n  const [goalToDelete, setGoalToDelete] = useState<string | null>(null);\n  const { toast } = useToast();\n\n  const [formData, setFormData] = useState({\n    seasonId: \"\",\n    goalAmount: \"\",\n    metaAgroquimicos: \"\",\n    metaEspecialidades: \"\",\n    metaSementesMilho: \"\",\n    metaSementesSoja: \"\",\n    metaSementesTrigo: \"\",\n    metaSementesDiversas: \"\",\n    metaFertilizantes: \"\",\n    metaCorretivos: \"\",\n  });\n\n  const { data: seasons } = useQuery<Season[]>({\n    queryKey: [\"/api/seasons\"],\n  });\n\n  const { data: analytics } = useQuery({\n    queryKey: [\"/api/analytics/sales\"],\n  });\n\n  const { data: categories } = useQuery({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const { data: seasonGoals, isLoading: goalsLoading } = useQuery<SeasonGoal[]>({\n    queryKey: [\"/api/season-goals\"],\n  });\n\n  const createGoalMutation = useMutation({\n    mutationFn: async (goalData: InsertSeasonGoal) => {\n      return apiRequest(\"POST\", \"/api/season-goals\", goalData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/season-goals\"] });\n      toast({\n        title: \"Meta cadastrada\",\n        description: \"A meta foi cadastrada com sucesso.\",\n      });\n      setShowNewGoalModal(false);\n      resetForm();\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao cadastrar meta. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateGoalMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<InsertSeasonGoal> }) => {\n      return apiRequest(\"PATCH\", `/api/season-goals/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/season-goals\"] });\n      toast({\n        title: \"Meta atualizada\",\n        description: \"A meta foi atualizada com sucesso.\",\n      });\n      setEditingGoal(null);\n      setShowNewGoalModal(false);\n      resetForm();\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao atualizar meta. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteGoalMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/season-goals/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/season-goals\"] });\n      toast({\n        title: \"Meta excluída\",\n        description: \"A meta foi excluída com sucesso.\",\n      });\n      setGoalToDelete(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao excluir meta. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      seasonId: \"\",\n      goalAmount: \"\",\n      metaAgroquimicos: \"\",\n      metaEspecialidades: \"\",\n      metaSementesMilho: \"\",\n      metaSementesSoja: \"\",\n      metaSementesTrigo: \"\",\n      metaSementesDiversas: \"\",\n      metaFertilizantes: \"\",\n      metaCorretivos: \"\",\n    });\n    setEditingGoal(null);\n  };\n\n  const handleEditClick = (goal: SeasonGoal) => {\n    setEditingGoal(goal);\n    setFormData({\n      seasonId: goal.seasonId,\n      goalAmount: goal.goalAmount,\n      metaAgroquimicos: goal.metaAgroquimicos || \"0\",\n      metaEspecialidades: goal.metaEspecialidades || \"0\",\n      metaSementesMilho: goal.metaSementesMilho || \"0\",\n      metaSementesSoja: goal.metaSementesSoja || \"0\",\n      metaSementesTrigo: goal.metaSementesTrigo || \"0\",\n      metaSementesDiversas: goal.metaSementesDiversas || \"0\",\n      metaFertilizantes: goal.metaFertilizantes || \"0\",\n      metaCorretivos: goal.metaCorretivos || \"0\",\n    });\n    setShowNewGoalModal(true);\n  };\n\n  const handleDeleteClick = (goalId: string) => {\n    setGoalToDelete(goalId);\n  };\n\n  const confirmDelete = () => {\n    if (goalToDelete) {\n      deleteGoalMutation.mutate(goalToDelete);\n    }\n  };\n\n  const calculateGlobalGoal = () => {\n    const agro = parseFloat(formData.metaAgroquimicos) || 0;\n    const espec = parseFloat(formData.metaEspecialidades) || 0;\n    const sementesMilho = parseFloat(formData.metaSementesMilho) || 0;\n    const sementesSoja = parseFloat(formData.metaSementesSoja) || 0;\n    const sementesTrigo = parseFloat(formData.metaSementesTrigo) || 0;\n    const sementesDiversas = parseFloat(formData.metaSementesDiversas) || 0;\n    const fert = parseFloat(formData.metaFertilizantes) || 0;\n    const corr = parseFloat(formData.metaCorretivos) || 0;\n    return agro + espec + sementesMilho + sementesSoja + sementesTrigo + sementesDiversas + fert + corr;\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    const globalGoal = calculateGlobalGoal();\n    \n    if (!formData.seasonId || globalGoal === 0) {\n      toast({\n        title: \"Campos obrigatórios\",\n        description: \"Selecione uma safra e preencha pelo menos uma meta de categoria.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const goalData: InsertSeasonGoal = {\n      seasonId: formData.seasonId,\n      goalAmount: globalGoal.toString(),\n      metaAgroquimicos: formData.metaAgroquimicos || \"0\",\n      metaEspecialidades: formData.metaEspecialidades || \"0\",\n      metaSementesMilho: formData.metaSementesMilho || \"0\",\n      metaSementesSoja: formData.metaSementesSoja || \"0\",\n      metaSementesTrigo: formData.metaSementesTrigo || \"0\",\n      metaSementesDiversas: formData.metaSementesDiversas || \"0\",\n      metaFertilizantes: formData.metaFertilizantes || \"0\",\n      metaCorretivos: formData.metaCorretivos || \"0\",\n      userId: \"default-vendedor-id\",\n    };\n\n    if (editingGoal) {\n      updateGoalMutation.mutate({ id: editingGoal.id, data: goalData });\n    } else {\n      createGoalMutation.mutate(goalData);\n    }\n  };\n\n  const getSeasonName = (seasonId: string) => {\n    return seasons?.find(s => s.id === seasonId)?.name || \"Safra não encontrada\";\n  };\n\n  const getTypeBadgeClass = (type: string) => {\n    switch (type) {\n      case \"soja_verao\": return \"bg-verde/10 text-verde border-verde/20\";\n      case \"soja_safrinha\": return \"bg-chart-2/10 text-chart-2 border-chart-2/20\";\n      case \"milho\": return \"bg-amarela/10 text-amarela border-amarela/20\";\n      case \"trigo\": return \"bg-chart-4/10 text-chart-4 border-chart-4/20\";\n      default: return \"bg-muted text-muted-foreground\";\n    }\n  };\n\n  const getTypeLabel = (type: string) => {\n    switch (type) {\n      case \"soja_verao\": return \"Soja Verão\";\n      case \"soja_safrinha\": return \"Soja Safrinha\";\n      case \"milho\": return \"Milho\";\n      case \"trigo\": return \"Trigo\";\n      default: return type;\n    }\n  };\n\n  const { data: sales } = useQuery({\n    queryKey: [\"/api/sales\"],\n  });\n\n  const goalsWithDetails = (seasonGoals || []).map(goal => {\n    const season = seasons?.find(s => s.id === goal.seasonId);\n    const goalSales = (sales as any[])?.filter(s => s.seasonId === goal.seasonId) || [];\n    \n    const categoryMap: Record<string, string> = {\n      \"Agroquímicos\": \"cat-agroquimicos\",\n      \"Especialidades\": \"cat-especialidades\",\n      \"Sementes Milho\": \"cat-sem-milho\",\n      \"Sementes Soja\": \"cat-sem-soja\",\n      \"Sementes Trigo\": \"cat-sem-trigo\",\n      \"Sementes Diversas\": \"cat-sem-diversas\",\n      \"Fertilizantes\": \"cat-fertilizantes\",\n      \"Corretivos\": \"cat-corretivos\",\n    };\n    \n    const salesByCategory = goalSales.reduce((acc: Record<string, number>, sale: any) => {\n      const categoryId = sale.categoryId;\n      const amount = parseFloat(sale.totalAmount || \"0\");\n      acc[categoryId] = (acc[categoryId] || 0) + amount;\n      return acc;\n    }, {});\n    \n    const realizadoAgroquimicos = salesByCategory[categoryMap[\"Agroquímicos\"]] || 0;\n    const realizadoEspecialidades = salesByCategory[categoryMap[\"Especialidades\"]] || 0;\n    const realizadoSementesMilho = salesByCategory[categoryMap[\"Sementes Milho\"]] || 0;\n    const realizadoSementesSoja = salesByCategory[categoryMap[\"Sementes Soja\"]] || 0;\n    const realizadoSementesTrigo = salesByCategory[categoryMap[\"Sementes Trigo\"]] || 0;\n    const realizadoSementesDiversas = salesByCategory[categoryMap[\"Sementes Diversas\"]] || 0;\n    const realizadoFertilizantes = salesByCategory[categoryMap[\"Fertilizantes\"]] || 0;\n    const realizadoCorretivos = salesByCategory[categoryMap[\"Corretivos\"]] || 0;\n    \n    const achievedAmount = realizadoAgroquimicos + realizadoEspecialidades + \n                          realizadoSementesMilho + realizadoSementesSoja + \n                          realizadoSementesTrigo + realizadoSementesDiversas + \n                          realizadoFertilizantes + realizadoCorretivos;\n    \n    const metaAgroquimicosNum = parseFloat(goal.metaAgroquimicos || \"0\");\n    const metaEspecialidadesNum = parseFloat(goal.metaEspecialidades || \"0\");\n    const metaSementesMilhoNum = parseFloat(goal.metaSementesMilho || \"0\");\n    const metaSementesSojaNum = parseFloat(goal.metaSementesSoja || \"0\");\n    const metaSementesTrigoNum = parseFloat(goal.metaSementesTrigo || \"0\");\n    const metaSementesDiversasNum = parseFloat(goal.metaSementesDiversas || \"0\");\n    const metaFertilizantesNum = parseFloat(goal.metaFertilizantes || \"0\");\n    const metaCorretivosNum = parseFloat(goal.metaCorretivos || \"0\");\n    \n    const percentAgroquimicos = metaAgroquimicosNum > 0 ? (realizadoAgroquimicos / metaAgroquimicosNum) * 100 : 0;\n    const percentEspecialidades = metaEspecialidadesNum > 0 ? (realizadoEspecialidades / metaEspecialidadesNum) * 100 : 0;\n    const percentSementesMilho = metaSementesMilhoNum > 0 ? (realizadoSementesMilho / metaSementesMilhoNum) * 100 : 0;\n    const percentSementesSoja = metaSementesSojaNum > 0 ? (realizadoSementesSoja / metaSementesSojaNum) * 100 : 0;\n    const percentSementesTrigo = metaSementesTrigoNum > 0 ? (realizadoSementesTrigo / metaSementesTrigoNum) * 100 : 0;\n    const percentSementesDiversas = metaSementesDiversasNum > 0 ? (realizadoSementesDiversas / metaSementesDiversasNum) * 100 : 0;\n    const percentFertilizantes = metaFertilizantesNum > 0 ? (realizadoFertilizantes / metaFertilizantesNum) * 100 : 0;\n    const percentCorretivos = metaCorretivosNum > 0 ? (realizadoCorretivos / metaCorretivosNum) * 100 : 0;\n    \n    const goalAmountNum = parseFloat(goal.goalAmount);\n    const percentage = goalAmountNum > 0 ? (achievedAmount / goalAmountNum) * 100 : 0;\n\n    return {\n      id: goal.id,\n      seasonId: goal.seasonId,\n      seasonName: season?.name || \"Safra desconhecida\",\n      seasonType: season?.type || \"unknown\",\n      goalAmount: goalAmountNum,\n      achievedAmount,\n      percentage,\n      status: percentage >= 100 ? \"concluida\" as const : \"em_andamento\" as const,\n      metaAgroquimicos: goal.metaAgroquimicos || \"0\",\n      metaEspecialidades: goal.metaEspecialidades || \"0\",\n      metaSementesMilho: goal.metaSementesMilho || \"0\",\n      metaSementesSoja: goal.metaSementesSoja || \"0\",\n      metaSementesTrigo: goal.metaSementesTrigo || \"0\",\n      metaSementesDiversas: goal.metaSementesDiversas || \"0\",\n      metaFertilizantes: goal.metaFertilizantes || \"0\",\n      metaCorretivos: goal.metaCorretivos || \"0\",\n      realizadoAgroquimicos,\n      realizadoEspecialidades,\n      realizadoSementesMilho,\n      realizadoSementesSoja,\n      realizadoSementesTrigo,\n      realizadoSementesDiversas,\n      realizadoFertilizantes,\n      realizadoCorretivos,\n      percentAgroquimicos,\n      percentEspecialidades,\n      percentSementesMilho,\n      percentSementesSoja,\n      percentSementesTrigo,\n      percentSementesDiversas,\n      percentFertilizantes,\n      percentCorretivos,\n    };\n  });\n\n  const totalGoals = goalsWithDetails.length;\n  const activeGoals = goalsWithDetails.filter(g => g.status === \"em_andamento\").length;\n  const averageAchievement = totalGoals > 0 \n    ? goalsWithDetails.reduce((sum, goal) => sum + goal.percentage, 0) / totalGoals \n    : 0;\n\n  return (\n    <div className=\"h-screen flex flex-col overflow-hidden\" data-testid=\"metas-container\">\n      <Header \n        onNewSale={() => {}}\n        title=\"Gestão de Metas\"\n        subtitle=\"Definição e acompanhamento de metas por safra\"\n      />\n      <Navbar />\n      \n      <main className=\"flex-1 overflow-y-auto\">\n\n        <div className=\"p-8\">\n          {/* Summary Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8\">\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center\">\n                    <Target className=\"text-primary\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Total de Metas</p>\n                    <p className=\"text-2xl font-bold\">{totalGoals}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                    <Calendar className=\"text-chart-2\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Metas Ativas</p>\n                    <p className=\"text-2xl font-bold\">{activeGoals}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-verde/10 rounded-lg flex items-center justify-center\">\n                    <TrendingUp className=\"text-verde\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Atingimento Médio</p>\n                    <p className=\"text-2xl font-bold\">{averageAchievement.toFixed(0)}%</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-accent/10 rounded-lg flex items-center justify-center\">\n                    <CheckCircle className=\"text-accent\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Meta Atual</p>\n                    <p className=\"text-2xl font-bold\">82%</p>\n                    <p className=\"text-xs text-muted-foreground\">Soja 25/26</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Goals Management */}\n          <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n            {/* Goals List */}\n            <div className=\"lg:col-span-2\">\n              <Card className=\"shadow-sm\">\n                <CardHeader className=\"flex flex-row items-center justify-between\">\n                  <CardTitle>Metas por Safra</CardTitle>\n                  <Dialog open={showNewGoalModal} onOpenChange={(open) => {\n                    setShowNewGoalModal(open);\n                    if (!open) resetForm();\n                  }}>\n                    <DialogTrigger asChild>\n                      <Button data-testid=\"button-new-goal\">\n                        <Plus className=\"h-4 w-4 mr-2\" />\n                        Nova Meta\n                      </Button>\n                    </DialogTrigger>\n                    <DialogContent data-testid=\"new-goal-modal\">\n                      <DialogHeader>\n                        <DialogTitle>{editingGoal ? \"Editar Meta de Safra\" : \"Nova Meta de Safra\"}</DialogTitle>\n                      </DialogHeader>\n                      <form onSubmit={handleSubmit} className=\"space-y-4\">\n                        <div>\n                          <Label htmlFor=\"season\">Safra *</Label>\n                          <Select value={formData.seasonId} onValueChange={(value) => \n                            setFormData(prev => ({ ...prev, seasonId: value }))\n                          }>\n                            <SelectTrigger data-testid=\"select-season\">\n                              <SelectValue placeholder=\"Selecione a safra\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {seasons?.map((season) => (\n                                <SelectItem key={season.id} value={season.id}>\n                                  {season.name}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n\n                        <div className=\"space-y-3\">\n                          <Label className=\"text-base font-semibold\">Metas por Categoria (USD)</Label>\n                          \n                          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                            <div>\n                              <Label htmlFor=\"metaAgroquimicos\">Agroquímicos</Label>\n                              <Input\n                                type=\"number\"\n                                step=\"0.01\"\n                                value={formData.metaAgroquimicos}\n                                onChange={(e) => setFormData(prev => ({ ...prev, metaAgroquimicos: e.target.value }))}\n                                placeholder=\"0.00\"\n                                className=\"font-mono\"\n                                data-testid=\"input-meta-agroquimicos\"\n                              />\n                            </div>\n\n                            <div>\n                              <Label htmlFor=\"metaEspecialidades\">Especialidades</Label>\n                              <Input\n                                type=\"number\"\n                                step=\"0.01\"\n                                value={formData.metaEspecialidades}\n                                onChange={(e) => setFormData(prev => ({ ...prev, metaEspecialidades: e.target.value }))}\n                                placeholder=\"0.00\"\n                                className=\"font-mono\"\n                                data-testid=\"input-meta-especialidades\"\n                              />\n                            </div>\n\n                            <div>\n                              <Label htmlFor=\"metaSementesMilho\">Sementes Milho</Label>\n                              <Input\n                                type=\"number\"\n                                step=\"0.01\"\n                                value={formData.metaSementesMilho}\n                                onChange={(e) => setFormData(prev => ({ ...prev, metaSementesMilho: e.target.value }))}\n                                placeholder=\"0.00\"\n                                className=\"font-mono\"\n                                data-testid=\"input-meta-sementes-milho\"\n                              />\n                            </div>\n\n                            <div>\n                              <Label htmlFor=\"metaSementesSoja\">Sementes Soja</Label>\n                              <Input\n                                type=\"number\"\n                                step=\"0.01\"\n                                value={formData.metaSementesSoja}\n                                onChange={(e) => setFormData(prev => ({ ...prev, metaSementesSoja: e.target.value }))}\n                                placeholder=\"0.00\"\n                                className=\"font-mono\"\n                                data-testid=\"input-meta-sementes-soja\"\n                              />\n                            </div>\n\n                            <div>\n                              <Label htmlFor=\"metaSementesTrigo\">Sementes Trigo</Label>\n                              <Input\n                                type=\"number\"\n                                step=\"0.01\"\n                                value={formData.metaSementesTrigo}\n                                onChange={(e) => setFormData(prev => ({ ...prev, metaSementesTrigo: e.target.value }))}\n                                placeholder=\"0.00\"\n                                className=\"font-mono\"\n                                data-testid=\"input-meta-sementes-trigo\"\n                              />\n                            </div>\n\n                            <div>\n                              <Label htmlFor=\"metaSementesDiversas\">Sementes Diversas</Label>\n                              <Input\n                                type=\"number\"\n                                step=\"0.01\"\n                                value={formData.metaSementesDiversas}\n                                onChange={(e) => setFormData(prev => ({ ...prev, metaSementesDiversas: e.target.value }))}\n                                placeholder=\"0.00\"\n                                className=\"font-mono\"\n                                data-testid=\"input-meta-sementes-diversas\"\n                              />\n                            </div>\n\n                            <div>\n                              <Label htmlFor=\"metaFertilizantes\">Fertilizantes</Label>\n                              <Input\n                                type=\"number\"\n                                step=\"0.01\"\n                                value={formData.metaFertilizantes}\n                                onChange={(e) => setFormData(prev => ({ ...prev, metaFertilizantes: e.target.value }))}\n                                placeholder=\"0.00\"\n                                className=\"font-mono\"\n                                data-testid=\"input-meta-fertilizantes\"\n                              />\n                            </div>\n\n                            <div>\n                              <Label htmlFor=\"metaCorretivos\">Corretivos</Label>\n                              <Input\n                                type=\"number\"\n                                step=\"0.01\"\n                                value={formData.metaCorretivos}\n                                onChange={(e) => setFormData(prev => ({ ...prev, metaCorretivos: e.target.value }))}\n                                placeholder=\"0.00\"\n                                className=\"font-mono\"\n                                data-testid=\"input-meta-corretivos\"\n                              />\n                            </div>\n                          </div>\n                        </div>\n\n                        <div className=\"bg-muted p-4 rounded-lg\">\n                          <Label className=\"text-base font-semibold\">Meta Global (USD)</Label>\n                          <p className=\"text-2xl font-bold font-mono mt-2 text-primary\">\n                            ${calculateGlobalGoal().toLocaleString()}\n                          </p>\n                          <p className=\"text-sm text-muted-foreground mt-1\">\n                            Soma das metas por categoria\n                          </p>\n                        </div>\n\n                        <div className=\"flex justify-end gap-3 pt-4\">\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            onClick={() => setShowNewGoalModal(false)}\n                            data-testid=\"button-cancel\"\n                          >\n                            Cancelar\n                          </Button>\n                          <Button\n                            type=\"submit\"\n                            disabled={createGoalMutation.isPending}\n                            data-testid=\"button-save\"\n                          >\n                            {createGoalMutation.isPending ? \"Salvando...\" : \"Salvar Meta\"}\n                          </Button>\n                        </div>\n                      </form>\n                    </DialogContent>\n                  </Dialog>\n                </CardHeader>\n                <CardContent>\n                  {goalsLoading ? (\n                    <div className=\"text-center py-12 text-muted-foreground\">\n                      Carregando metas...\n                    </div>\n                  ) : goalsWithDetails.length === 0 ? (\n                    <div className=\"text-center py-12\">\n                      <Target className=\"h-16 w-16 mx-auto text-muted-foreground mb-4\" />\n                      <p className=\"text-muted-foreground mb-4\">Nenhuma meta definida</p>\n                      <Button \n                        onClick={() => setShowNewGoalModal(true)}\n                        data-testid=\"button-first-goal\"\n                      >\n                        <Plus className=\"h-4 w-4 mr-2\" />\n                        Definir primeira meta\n                      </Button>\n                    </div>\n                  ) : (\n                    <div className=\"overflow-x-auto\">\n                      <Table>\n                        <TableHeader>\n                          <TableRow>\n                            <TableHead>Safra</TableHead>\n                            <TableHead>Tipo</TableHead>\n                            <TableHead className=\"text-right\">Meta (USD)</TableHead>\n                            <TableHead className=\"text-right\">Realizado (USD)</TableHead>\n                            <TableHead>Atingimento</TableHead>\n                            <TableHead className=\"text-center\">Status</TableHead>\n                            <TableHead className=\"text-center\">Ações</TableHead>\n                          </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                          {goalsWithDetails.map((goal) => (\n                            <TableRow key={goal.id} data-testid={`goal-row-${goal.id}`}>\n                              <TableCell className=\"font-medium\">{goal.seasonName}</TableCell>\n                              <TableCell>\n                                <Badge className={getTypeBadgeClass(goal.seasonType)}>\n                                  {getTypeLabel(goal.seasonType)}\n                                </Badge>\n                              </TableCell>\n                              <TableCell className=\"text-right\">\n                                <div>\n                                  <p className=\"font-mono font-bold\">${goal.goalAmount.toLocaleString()}</p>\n                                  <div className=\"text-xs text-muted-foreground mt-1 space-y-0.5\">\n                                    {parseFloat(goal.metaAgroquimicos || \"0\") > 0 && (\n                                      <p>Agroquímicos: ${parseFloat(goal.metaAgroquimicos).toLocaleString()}</p>\n                                    )}\n                                    {parseFloat(goal.metaEspecialidades || \"0\") > 0 && (\n                                      <p>Especialidades: ${parseFloat(goal.metaEspecialidades).toLocaleString()}</p>\n                                    )}\n                                    {parseFloat(goal.metaSementesMilho || \"0\") > 0 && (\n                                      <p>Sementes Milho: ${parseFloat(goal.metaSementesMilho).toLocaleString()}</p>\n                                    )}\n                                    {parseFloat(goal.metaSementesSoja || \"0\") > 0 && (\n                                      <p>Sementes Soja: ${parseFloat(goal.metaSementesSoja).toLocaleString()}</p>\n                                    )}\n                                    {parseFloat(goal.metaSementesTrigo || \"0\") > 0 && (\n                                      <p>Sementes Trigo: ${parseFloat(goal.metaSementesTrigo).toLocaleString()}</p>\n                                    )}\n                                    {parseFloat(goal.metaSementesDiversas || \"0\") > 0 && (\n                                      <p>Sementes Diversas: ${parseFloat(goal.metaSementesDiversas).toLocaleString()}</p>\n                                    )}\n                                    {parseFloat(goal.metaFertilizantes || \"0\") > 0 && (\n                                      <p>Fertilizantes: ${parseFloat(goal.metaFertilizantes).toLocaleString()}</p>\n                                    )}\n                                    {parseFloat(goal.metaCorretivos || \"0\") > 0 && (\n                                      <p>Corretivos: ${parseFloat(goal.metaCorretivos).toLocaleString()}</p>\n                                    )}\n                                  </div>\n                                </div>\n                              </TableCell>\n                              <TableCell className=\"text-right\">\n                                <div>\n                                  <p className=\"font-mono font-bold\">${goal.achievedAmount.toLocaleString()}</p>\n                                  <div className=\"text-xs text-muted-foreground mt-1 space-y-0.5\">\n                                    {goal.realizadoAgroquimicos > 0 && (\n                                      <p>Agroquímicos: ${goal.realizadoAgroquimicos.toLocaleString()}</p>\n                                    )}\n                                    {goal.realizadoEspecialidades > 0 && (\n                                      <p>Especialidades: ${goal.realizadoEspecialidades.toLocaleString()}</p>\n                                    )}\n                                    {goal.realizadoSementesMilho > 0 && (\n                                      <p>Sementes Milho: ${goal.realizadoSementesMilho.toLocaleString()}</p>\n                                    )}\n                                    {goal.realizadoSementesSoja > 0 && (\n                                      <p>Sementes Soja: ${goal.realizadoSementesSoja.toLocaleString()}</p>\n                                    )}\n                                    {goal.realizadoSementesTrigo > 0 && (\n                                      <p>Sementes Trigo: ${goal.realizadoSementesTrigo.toLocaleString()}</p>\n                                    )}\n                                    {goal.realizadoSementesDiversas > 0 && (\n                                      <p>Sementes Diversas: ${goal.realizadoSementesDiversas.toLocaleString()}</p>\n                                    )}\n                                    {goal.realizadoFertilizantes > 0 && (\n                                      <p>Fertilizantes: ${goal.realizadoFertilizantes.toLocaleString()}</p>\n                                    )}\n                                    {goal.realizadoCorretivos > 0 && (\n                                      <p>Corretivos: ${goal.realizadoCorretivos.toLocaleString()}</p>\n                                    )}\n                                  </div>\n                                </div>\n                              </TableCell>\n                              <TableCell>\n                                <div className=\"space-y-2\">\n                                  <div className=\"flex items-center justify-between\">\n                                    <span className=\"text-sm font-mono\">{goal.percentage.toFixed(0)}%</span>\n                                  </div>\n                                  <Progress \n                                    value={Math.min(goal.percentage, 100)} \n                                    className=\"h-2\"\n                                  />\n                                </div>\n                              </TableCell>\n                              <TableCell className=\"text-center\">\n                                {goal.status === \"concluida\" ? (\n                                  <Badge className=\"bg-verde/10 text-verde\">\n                                    {goal.percentage >= 100 ? \"Atingida\" : \"Concluída\"}\n                                  </Badge>\n                                ) : goal.percentage >= 100 ? (\n                                  <Badge className=\"bg-verde/10 text-verde\">Superada</Badge>\n                                ) : goal.percentage >= 80 ? (\n                                  <Badge className=\"bg-amarela/10 text-amarela\">Próxima</Badge>\n                                ) : (\n                                  <Badge variant=\"outline\">Em andamento</Badge>\n                                )}\n                              </TableCell>\n                              <TableCell className=\"text-center\">\n                                <div className=\"flex items-center justify-center gap-1\">\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    onClick={() => handleEditClick(seasonGoals?.find(g => g.id === goal.id) as SeasonGoal)}\n                                    data-testid={`button-edit-${goal.id}`}\n                                  >\n                                    <Edit className=\"h-4 w-4\" />\n                                  </Button>\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    onClick={() => handleDeleteClick(goal.id)}\n                                    data-testid={`button-delete-${goal.id}`}\n                                    className=\"text-destructive hover:text-destructive\"\n                                  >\n                                    <Trash2 className=\"h-4 w-4\" />\n                                  </Button>\n                                </div>\n                              </TableCell>\n                            </TableRow>\n                          ))}\n                        </TableBody>\n                      </Table>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n\n            {/* Goal Summary */}\n            <div>\n              <Card className=\"shadow-sm\">\n                <CardHeader>\n                  <CardTitle className=\"text-base\">Progresso por Categoria</CardTitle>\n                  <p className=\"text-xs text-muted-foreground mt-1\">Atingimento individual de cada segmento</p>\n                </CardHeader>\n                <CardContent className=\"space-y-3\">\n                  {goalsWithDetails.length > 0 && goalsWithDetails[0] && (\n                    <>\n                      {parseFloat(goalsWithDetails[0].metaAgroquimicos) > 0 && (\n                        <div className=\"space-y-1\">\n                          <div className=\"flex justify-between text-xs\">\n                            <span className=\"text-muted-foreground\">Agroquímicos</span>\n                            <span className=\"font-mono font-semibold\">{goalsWithDetails[0].percentAgroquimicos.toFixed(0)}%</span>\n                          </div>\n                          <Progress value={Math.min(goalsWithDetails[0].percentAgroquimicos, 100)} className=\"h-1.5\" />\n                          <div className=\"flex justify-between text-[10px] text-muted-foreground\">\n                            <span>${goalsWithDetails[0].realizadoAgroquimicos.toLocaleString()}</span>\n                            <span>${parseFloat(goalsWithDetails[0].metaAgroquimicos).toLocaleString()}</span>\n                          </div>\n                        </div>\n                      )}\n                      \n                      {parseFloat(goalsWithDetails[0].metaEspecialidades) > 0 && (\n                        <div className=\"space-y-1\">\n                          <div className=\"flex justify-between text-xs\">\n                            <span className=\"text-muted-foreground\">Especialidades</span>\n                            <span className=\"font-mono font-semibold\">{goalsWithDetails[0].percentEspecialidades.toFixed(0)}%</span>\n                          </div>\n                          <Progress value={Math.min(goalsWithDetails[0].percentEspecialidades, 100)} className=\"h-1.5\" />\n                          <div className=\"flex justify-between text-[10px] text-muted-foreground\">\n                            <span>${goalsWithDetails[0].realizadoEspecialidades.toLocaleString()}</span>\n                            <span>${parseFloat(goalsWithDetails[0].metaEspecialidades).toLocaleString()}</span>\n                          </div>\n                        </div>\n                      )}\n                      \n                      {parseFloat(goalsWithDetails[0].metaSementesMilho) > 0 && (\n                        <div className=\"space-y-1\">\n                          <div className=\"flex justify-between text-xs\">\n                            <span className=\"text-muted-foreground\">Sementes Milho</span>\n                            <span className=\"font-mono font-semibold\">{goalsWithDetails[0].percentSementesMilho.toFixed(0)}%</span>\n                          </div>\n                          <Progress value={Math.min(goalsWithDetails[0].percentSementesMilho, 100)} className=\"h-1.5\" />\n                          <div className=\"flex justify-between text-[10px] text-muted-foreground\">\n                            <span>${goalsWithDetails[0].realizadoSementesMilho.toLocaleString()}</span>\n                            <span>${parseFloat(goalsWithDetails[0].metaSementesMilho).toLocaleString()}</span>\n                          </div>\n                        </div>\n                      )}\n                      \n                      {parseFloat(goalsWithDetails[0].metaSementesSoja) > 0 && (\n                        <div className=\"space-y-1\">\n                          <div className=\"flex justify-between text-xs\">\n                            <span className=\"text-muted-foreground\">Sementes Soja</span>\n                            <span className=\"font-mono font-semibold\">{goalsWithDetails[0].percentSementesSoja.toFixed(0)}%</span>\n                          </div>\n                          <Progress value={Math.min(goalsWithDetails[0].percentSementesSoja, 100)} className=\"h-1.5\" />\n                          <div className=\"flex justify-between text-[10px] text-muted-foreground\">\n                            <span>${goalsWithDetails[0].realizadoSementesSoja.toLocaleString()}</span>\n                            <span>${parseFloat(goalsWithDetails[0].metaSementesSoja).toLocaleString()}</span>\n                          </div>\n                        </div>\n                      )}\n                      \n                      {parseFloat(goalsWithDetails[0].metaSementesTrigo) > 0 && (\n                        <div className=\"space-y-1\">\n                          <div className=\"flex justify-between text-xs\">\n                            <span className=\"text-muted-foreground\">Sementes Trigo</span>\n                            <span className=\"font-mono font-semibold\">{goalsWithDetails[0].percentSementesTrigo.toFixed(0)}%</span>\n                          </div>\n                          <Progress value={Math.min(goalsWithDetails[0].percentSementesTrigo, 100)} className=\"h-1.5\" />\n                          <div className=\"flex justify-between text-[10px] text-muted-foreground\">\n                            <span>${goalsWithDetails[0].realizadoSementesTrigo.toLocaleString()}</span>\n                            <span>${parseFloat(goalsWithDetails[0].metaSementesTrigo).toLocaleString()}</span>\n                          </div>\n                        </div>\n                      )}\n                      \n                      {parseFloat(goalsWithDetails[0].metaSementesDiversas) > 0 && (\n                        <div className=\"space-y-1\">\n                          <div className=\"flex justify-between text-xs\">\n                            <span className=\"text-muted-foreground\">Sementes Diversas</span>\n                            <span className=\"font-mono font-semibold\">{goalsWithDetails[0].percentSementesDiversas.toFixed(0)}%</span>\n                          </div>\n                          <Progress value={Math.min(goalsWithDetails[0].percentSementesDiversas, 100)} className=\"h-1.5\" />\n                          <div className=\"flex justify-between text-[10px] text-muted-foreground\">\n                            <span>${goalsWithDetails[0].realizadoSementesDiversas.toLocaleString()}</span>\n                            <span>${parseFloat(goalsWithDetails[0].metaSementesDiversas).toLocaleString()}</span>\n                          </div>\n                        </div>\n                      )}\n                      \n                      {parseFloat(goalsWithDetails[0].metaFertilizantes) > 0 && (\n                        <div className=\"space-y-1\">\n                          <div className=\"flex justify-between text-xs\">\n                            <span className=\"text-muted-foreground\">Fertilizantes</span>\n                            <span className=\"font-mono font-semibold\">{goalsWithDetails[0].percentFertilizantes.toFixed(0)}%</span>\n                          </div>\n                          <Progress value={Math.min(goalsWithDetails[0].percentFertilizantes, 100)} className=\"h-1.5\" />\n                          <div className=\"flex justify-between text-[10px] text-muted-foreground\">\n                            <span>${goalsWithDetails[0].realizadoFertilizantes.toLocaleString()}</span>\n                            <span>${parseFloat(goalsWithDetails[0].metaFertilizantes).toLocaleString()}</span>\n                          </div>\n                        </div>\n                      )}\n                      \n                      {parseFloat(goalsWithDetails[0].metaCorretivos) > 0 && (\n                        <div className=\"space-y-1\">\n                          <div className=\"flex justify-between text-xs\">\n                            <span className=\"text-muted-foreground\">Corretivos</span>\n                            <span className=\"font-mono font-semibold\">{goalsWithDetails[0].percentCorretivos.toFixed(0)}%</span>\n                          </div>\n                          <Progress value={Math.min(goalsWithDetails[0].percentCorretivos, 100)} className=\"h-1.5\" />\n                          <div className=\"flex justify-between text-[10px] text-muted-foreground\">\n                            <span>${goalsWithDetails[0].realizadoCorretivos.toLocaleString()}</span>\n                            <span>${parseFloat(goalsWithDetails[0].metaCorretivos).toLocaleString()}</span>\n                          </div>\n                        </div>\n                      )}\n                    </>\n                  )}\n                  \n                  {goalsWithDetails.length === 0 && (\n                    <div className=\"text-center py-8 text-sm text-muted-foreground\">\n                      Crie uma meta para visualizar o progresso\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </div>\n          </div>\n        </div>\n      </main>\n\n      {/* Delete Confirmation Dialog */}\n      <AlertDialog open={!!goalToDelete} onOpenChange={(open) => !open && setGoalToDelete(null)}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Confirmar exclusão</AlertDialogTitle>\n            <AlertDialogDescription>\n              Tem certeza que deseja excluir esta meta? Esta ação não pode ser desfeita.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete\">Cancelar</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmDelete}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete\"\n            >\n              Excluir\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","size_bytes":45555},"client/src/pages/produtos.tsx":{"content":"import Navbar from \"@/components/layout/navbar\";\nimport Header from \"@/components/layout/header\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Search, Plus, Package, Tag, Boxes, TrendingUp, Pencil, Wand2 } from \"lucide-react\";\nimport type { Product, Category, InsertProduct, Subcategory } from \"@shared/schema\";\n\nexport default function Produtos() {\n  const [showNewProductModal, setShowNewProductModal] = useState(false);\n  const [showEditProductModal, setShowEditProductModal] = useState(false);\n  const [editingProduct, setEditingProduct] = useState<Product | null>(null);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [selectedCategory, setSelectedCategory] = useState(\"\");\n  const { toast } = useToast();\n\n  const [formData, setFormData] = useState({\n    name: \"\",\n    categoryId: \"\",\n    description: \"\",\n  });\n\n  const [editFormData, setEditFormData] = useState({\n    name: \"\",\n    categoryId: \"\",\n    subcategoryId: \"\",\n    description: \"\",\n    segment: \"\",\n  });\n\n  const { data: products, isLoading } = useQuery<Product[]>({\n    queryKey: [\"/api/products\"],\n  });\n\n  const { data: categories, isLoading: categoriesLoading } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const { data: subcategories } = useQuery<Subcategory[]>({\n    queryKey: [\"/api/subcategories\"],\n  });\n\n  const createProductMutation = useMutation({\n    mutationFn: async (productData: InsertProduct) => {\n      return apiRequest(\"POST\", \"/api/products\", productData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/products\"] });\n      toast({\n        title: \"Produto cadastrado\",\n        description: \"O produto foi cadastrado com sucesso.\",\n      });\n      setShowNewProductModal(false);\n      resetForm();\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao cadastrar produto. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateProductMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<Product> }) => {\n      return apiRequest(\"PATCH\", `/api/products/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/products\"] });\n      toast({\n        title: \"Produto atualizado\",\n        description: \"O produto foi atualizado com sucesso.\",\n      });\n      setShowEditProductModal(false);\n      setEditingProduct(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao atualizar produto. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const autoPopulateMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/products/auto-populate-segments\", {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/products\"] });\n      toast({\n        title: \"Segmentos atualizados\",\n        description: \"Os segmentos dos produtos agroquímicos foram atualizados com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao atualizar segmentos. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const processSojaSpreadsheetMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/products/process-soja-spreadsheet\", {});\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/products\"] });\n      toast({\n        title: \"Planilha processada\",\n        description: `${data.updated} produtos atualizados. ${data.notFound > 0 ? `${data.notFound} não encontrados.` : ''}`,\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao processar planilha. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      name: \"\",\n      categoryId: \"\",\n      description: \"\",\n    });\n  };\n\n  const openEditModal = (product: Product) => {\n    if (categoriesLoading) {\n      toast({\n        title: \"Carregando\",\n        description: \"Aguarde o carregamento das categorias.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setEditingProduct(product);\n    setEditFormData({\n      name: product.name,\n      categoryId: product.categoryId,\n      subcategoryId: product.subcategoryId || \"\",\n      description: product.description || \"\",\n      segment: product.segment || \"\",\n    });\n    setShowEditProductModal(true);\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!formData.name || !formData.categoryId) {\n      toast({\n        title: \"Campos obrigatórios\",\n        description: \"Preencha todos os campos obrigatórios.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const productData: InsertProduct = {\n      name: formData.name,\n      categoryId: formData.categoryId,\n      description: formData.description || null,\n      isActive: true,\n    };\n\n    createProductMutation.mutate(productData);\n  };\n\n  const handleEditSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!editingProduct || !editFormData.name || !editFormData.categoryId) {\n      toast({\n        title: \"Campos obrigatórios\",\n        description: \"Preencha todos os campos obrigatórios.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const categoryType = getCategoryType(editFormData.categoryId);\n    if (categoryType === \"agroquimicos\" && !editFormData.segment) {\n      toast({\n        title: \"Segmento obrigatório\",\n        description: \"Selecione um segmento para produtos agroquímicos.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const updateData: Partial<Product> = {\n      name: editFormData.name,\n      categoryId: editFormData.categoryId,\n      subcategoryId: editFormData.subcategoryId || null,\n      description: editFormData.description || null,\n    };\n\n    if (categoryType === \"agroquimicos\" && editFormData.segment) {\n      updateData.segment = editFormData.segment;\n    }\n\n    updateProductMutation.mutate({ id: editingProduct.id, data: updateData });\n  };\n\n  const getCategoryName = (categoryId: string) => {\n    return categories?.find(c => c.id === categoryId)?.name || \"Categoria não encontrada\";\n  };\n\n  const getCategoryType = (categoryId: string) => {\n    return categories?.find(c => c.id === categoryId)?.type || \"\";\n  };\n\n  const getCategoryBadgeClass = (type: string) => {\n    switch (type) {\n      case \"fertilizantes\": return \"bg-chart-1/10 text-chart-1 border-chart-1/20\";\n      case \"sementes\": return \"bg-chart-2/10 text-chart-2 border-chart-2/20\";\n      case \"especialidades\": return \"bg-chart-3/10 text-chart-3 border-chart-3/20\";\n      case \"agroquimicos\": return \"bg-chart-4/10 text-chart-4 border-chart-4/20\";\n      default: return \"bg-muted text-muted-foreground\";\n    }\n  };\n\n  const getSubcategoryName = (subcategoryId: string | null) => {\n    if (!subcategoryId) return null;\n    return subcategories?.find(s => s.id === subcategoryId)?.name || null;\n  };\n\n  const filteredProducts = products?.filter(product => {\n    const nameMatch = product.name.toLowerCase().includes(searchTerm.toLowerCase());\n    const categoryMatch = !selectedCategory || selectedCategory === \"all\" || product.categoryId === selectedCategory;\n    return nameMatch && categoryMatch && product.isActive;\n  }) || [];\n\n  const groupedByCategory = filteredProducts.reduce((acc, product) => {\n    const categoryName = getCategoryName(product.categoryId);\n    if (!acc[categoryName]) {\n      acc[categoryName] = [];\n    }\n    acc[categoryName].push(product);\n    return acc;\n  }, {} as Record<string, Product[]>);\n\n  const totalProducts = products?.filter(p => p.isActive).length || 0;\n  const totalCategories = categories?.length || 0;\n\n  const agroquimicosCategory = categories?.find(c => c.type === \"agroquimicos\");\n  const hasAgroquimicosWithoutSegment = products?.some(\n    p => p.categoryId === agroquimicosCategory?.id && p.isActive && !p.segment\n  ) || false;\n\n  if (isLoading) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-32 w-32 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-screen flex flex-col overflow-hidden\" data-testid=\"produtos-container\">\n      <Header \n        onNewSale={() => {}}\n        title=\"Gestão de Produtos\"\n        subtitle=\"Catálogo de produtos por categoria\"\n      />\n      <Navbar />\n      \n      <main className=\"flex-1 overflow-y-auto\">\n\n        <div className=\"p-8\">\n          {/* Summary Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8\">\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center\">\n                    <Package className=\"text-primary\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Total de Produtos</p>\n                    <p className=\"text-2xl font-bold\">{totalProducts}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                    <Tag className=\"text-chart-2\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Categorias</p>\n                    <p className=\"text-2xl font-bold\">{totalCategories}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-chart-1/10 rounded-lg flex items-center justify-center\">\n                    <Boxes className=\"text-chart-1\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Fertilizantes</p>\n                    <p className=\"text-2xl font-bold\">\n                      {products?.filter(p => getCategoryType(p.categoryId) === \"fertilizantes\" && p.isActive).length || 0}\n                    </p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-verde/10 rounded-lg flex items-center justify-center\">\n                    <TrendingUp className=\"text-verde\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Sementes</p>\n                    <p className=\"text-2xl font-bold\">\n                      {products?.filter(p => getCategoryType(p.categoryId) === \"sementes\" && p.isActive).length || 0}\n                    </p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Filters and Actions */}\n          <Card className=\"shadow-sm mb-8\">\n            <CardHeader>\n              <CardTitle>Filtros e Ações</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex flex-wrap gap-4 items-end\">\n                <div className=\"flex-1 min-w-64\">\n                  <div className=\"relative\">\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                    <Input\n                      placeholder=\"Buscar por nome do produto...\"\n                      value={searchTerm}\n                      onChange={(e) => setSearchTerm(e.target.value)}\n                      className=\"pl-10\"\n                      data-testid=\"search-products\"\n                    />\n                  </div>\n                </div>\n\n                <Select value={selectedCategory} onValueChange={setSelectedCategory}>\n                  <SelectTrigger className=\"w-48\" data-testid=\"filter-category\">\n                    <SelectValue placeholder=\"Filtrar por categoria\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todas as categorias</SelectItem>\n                    {categories?.map((category) => (\n                      <SelectItem key={category.id} value={category.id}>\n                        {category.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n\n                {hasAgroquimicosWithoutSegment && (\n                  <Button\n                    variant=\"outline\"\n                    onClick={() => autoPopulateMutation.mutate()}\n                    disabled={autoPopulateMutation.isPending}\n                    data-testid=\"button-auto-populate-segments\"\n                  >\n                    <Wand2 className=\"h-4 w-4 mr-2\" />\n                    {autoPopulateMutation.isPending ? \"Processando...\" : \"Auto-popular Segmentos\"}\n                  </Button>\n                )}\n\n                <Button\n                  variant=\"outline\"\n                  onClick={() => processSojaSpreadsheetMutation.mutate()}\n                  disabled={processSojaSpreadsheetMutation.isPending}\n                  data-testid=\"button-process-soja-spreadsheet\"\n                >\n                  <Package className=\"h-4 w-4 mr-2\" />\n                  {processSojaSpreadsheetMutation.isPending ? \"Processando...\" : \"Processar SOJA 25-26\"}\n                </Button>\n\n                <Dialog open={showNewProductModal} onOpenChange={setShowNewProductModal}>\n                  <DialogTrigger asChild>\n                    <Button data-testid=\"button-new-product\">\n                      <Plus className=\"h-4 w-4 mr-2\" />\n                      Novo Produto\n                    </Button>\n                  </DialogTrigger>\n                  <DialogContent className=\"max-w-2xl\" data-testid=\"new-product-modal\">\n                    <DialogHeader>\n                      <DialogTitle>Novo Produto</DialogTitle>\n                    </DialogHeader>\n                    <form onSubmit={handleSubmit} className=\"space-y-4\">\n                      <div>\n                        <Label htmlFor=\"name\">Nome do Produto *</Label>\n                        <Input\n                          value={formData.name}\n                          onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}\n                          placeholder=\"Ex: NPK 20-20-20, Semente Soja Premium\"\n                          data-testid=\"input-product-name\"\n                        />\n                      </div>\n\n                      <div>\n                        <Label htmlFor=\"category\">Categoria *</Label>\n                        <Select value={formData.categoryId} onValueChange={(value) => \n                          setFormData(prev => ({ ...prev, categoryId: value }))\n                        }>\n                          <SelectTrigger data-testid=\"select-category\">\n                            <SelectValue placeholder=\"Selecione a categoria\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {categories?.map((category) => (\n                              <SelectItem key={category.id} value={category.id}>\n                                {category.name}\n                              </SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n\n                      <div>\n                        <Label htmlFor=\"description\">Descrição</Label>\n                        <Textarea\n                          value={formData.description}\n                          onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}\n                          placeholder=\"Descrição detalhada do produto (opcional)\"\n                          rows={3}\n                          data-testid=\"input-description\"\n                        />\n                      </div>\n\n                      <div className=\"flex justify-end gap-3 pt-4\">\n                        <Button\n                          type=\"button\"\n                          variant=\"outline\"\n                          onClick={() => setShowNewProductModal(false)}\n                          data-testid=\"button-cancel\"\n                        >\n                          Cancelar\n                        </Button>\n                        <Button\n                          type=\"submit\"\n                          disabled={createProductMutation.isPending}\n                          data-testid=\"button-save\"\n                        >\n                          {createProductMutation.isPending ? \"Salvando...\" : \"Salvar Produto\"}\n                        </Button>\n                      </div>\n                    </form>\n                  </DialogContent>\n                </Dialog>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Products by Category */}\n          {Object.keys(groupedByCategory).length === 0 ? (\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-12 text-center\">\n                <Package className=\"h-16 w-16 mx-auto text-muted-foreground mb-4\" />\n                <p className=\"text-muted-foreground mb-4\">Nenhum produto encontrado</p>\n                <Button \n                  onClick={() => setShowNewProductModal(true)}\n                  data-testid=\"button-first-product\"\n                >\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Cadastrar primeiro produto\n                </Button>\n              </CardContent>\n            </Card>\n          ) : (\n            <div className=\"space-y-8\">\n              {Object.entries(groupedByCategory).map(([categoryName, categoryProducts]) => {\n                const categoryData = categories?.find(c => c.name === categoryName);\n                \n                return (\n                  <Card key={categoryName} className=\"shadow-sm\">\n                    <CardHeader>\n                      <div className=\"flex items-center justify-between\">\n                        <div className=\"flex items-center gap-3\">\n                          <CardTitle className=\"text-lg\">{categoryName}</CardTitle>\n                          <Badge className={getCategoryBadgeClass(categoryData?.type || \"\")}>\n                            {categoryProducts.length} produtos\n                            {categoryData && (\n                              <span className=\"ml-2\">\n                                | Comissões: {parseFloat(categoryData.greenCommission).toFixed(2)}% {parseFloat(categoryData.yellowCommission).toFixed(2)}% {parseFloat(categoryData.redCommission).toFixed(2)}%\n                              </span>\n                            )}\n                          </Badge>\n                        </div>\n                      </div>\n                    </CardHeader>\n                    <CardContent>\n                      <div className=\"overflow-x-auto\">\n                        <Table>\n                          <TableHeader>\n                            <TableRow>\n                              <TableHead>Produto</TableHead>\n                              <TableHead>Descrição</TableHead>\n                              <TableHead>Subcategorias</TableHead>\n                              <TableHead className=\"text-center\">Status</TableHead>\n                              <TableHead className=\"text-center\">Ações</TableHead>\n                            </TableRow>\n                          </TableHeader>\n                          <TableBody>\n                            {categoryProducts.map((product) => (\n                              <TableRow key={product.id} data-testid={`product-row-${product.id}`}>\n                                <TableCell className=\"font-medium\">{product.name}</TableCell>\n                                <TableCell className=\"max-w-md truncate\">\n                                  {product.description || \"Sem descrição\"}\n                                </TableCell>\n                                <TableCell>\n                                  {product.subcategoryId ? (\n                                    <Badge variant=\"outline\" className=\"text-xs\">\n                                      {getSubcategoryName(product.subcategoryId) || \"Subcategoria\"}\n                                    </Badge>\n                                  ) : (\n                                    <span className=\"text-muted-foreground text-sm\">-</span>\n                                  )}\n                                </TableCell>\n                                <TableCell className=\"text-center\">\n                                  <Badge variant={product.isActive ? \"default\" : \"secondary\"}>\n                                    {product.isActive ? \"Ativo\" : \"Inativo\"}\n                                  </Badge>\n                                </TableCell>\n                                <TableCell className=\"text-center\">\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"sm\"\n                                    onClick={() => openEditModal(product)}\n                                    data-testid={`button-edit-product-${product.id}`}\n                                  >\n                                    <Pencil className=\"h-4 w-4\" />\n                                  </Button>\n                                </TableCell>\n                              </TableRow>\n                            ))}\n                          </TableBody>\n                        </Table>\n                      </div>\n                    </CardContent>\n                  </Card>\n                );\n              })}\n            </div>\n          )}\n\n          {/* Edit Product Modal */}\n          <Dialog open={showEditProductModal} onOpenChange={setShowEditProductModal}>\n            <DialogContent className=\"max-w-2xl\" data-testid=\"edit-product-modal\">\n              <DialogHeader>\n                <DialogTitle>Editar Produto</DialogTitle>\n              </DialogHeader>\n              {categoriesLoading ? (\n                <div className=\"flex justify-center items-center py-8\">\n                  <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-primary\"></div>\n                </div>\n              ) : (\n              <form onSubmit={handleEditSubmit} className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"edit-name\">Nome do Produto *</Label>\n                  <Input\n                    id=\"edit-name\"\n                    value={editFormData.name}\n                    onChange={(e) => setEditFormData(prev => ({ ...prev, name: e.target.value }))}\n                    placeholder=\"Ex: NPK 20-20-20, Semente Soja Premium\"\n                    data-testid=\"input-edit-product-name\"\n                  />\n                </div>\n\n                <div>\n                  <Label htmlFor=\"edit-category\">Categoria *</Label>\n                  <Select \n                    value={editFormData.categoryId} \n                    onValueChange={(value) => setEditFormData(prev => ({ ...prev, categoryId: value, subcategoryId: \"\" }))}\n                  >\n                    <SelectTrigger data-testid=\"select-edit-category\">\n                      <SelectValue placeholder=\"Selecione a categoria\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {categories?.map((category) => (\n                        <SelectItem key={category.id} value={category.id}>\n                          {category.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                {editFormData.categoryId && (subcategories?.filter(s => s.categoryId === editFormData.categoryId).length ?? 0) > 0 && (\n                  <div>\n                    <Label htmlFor=\"edit-subcategory\">Subcategoria</Label>\n                    <Select \n                      value={editFormData.subcategoryId} \n                      onValueChange={(value) => setEditFormData(prev => ({ ...prev, subcategoryId: value }))}\n                    >\n                      <SelectTrigger data-testid=\"select-edit-subcategory\">\n                        <SelectValue placeholder=\"Selecione a subcategoria (opcional)\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"\">Nenhuma</SelectItem>\n                        {subcategories\n                          ?.filter(s => s.categoryId === editFormData.categoryId)\n                          .map((subcategory) => (\n                            <SelectItem key={subcategory.id} value={subcategory.id}>\n                              {subcategory.name}\n                            </SelectItem>\n                          ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                )}\n\n                {getCategoryType(editFormData.categoryId) === \"agroquimicos\" && (\n                  <div>\n                    <Label htmlFor=\"edit-segment\">Segmento *</Label>\n                    <Select \n                      value={editFormData.segment} \n                      onValueChange={(value) => setEditFormData(prev => ({ ...prev, segment: value }))}\n                    >\n                      <SelectTrigger data-testid=\"select-edit-segment\">\n                        <SelectValue placeholder=\"Selecione o segmento\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"fungicida\">Fungicida</SelectItem>\n                        <SelectItem value=\"inseticida\">Inseticida</SelectItem>\n                        <SelectItem value=\"herbicida\">Herbicida</SelectItem>\n                        <SelectItem value=\"ts\">TS</SelectItem>\n                        <SelectItem value=\"outros\">Outros</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                )}\n\n                <div>\n                  <Label htmlFor=\"edit-description\">Descrição</Label>\n                  <Textarea\n                    id=\"edit-description\"\n                    value={editFormData.description}\n                    onChange={(e) => setEditFormData(prev => ({ ...prev, description: e.target.value }))}\n                    placeholder=\"Descrição detalhada do produto (opcional)\"\n                    rows={3}\n                    data-testid=\"input-edit-description\"\n                  />\n                </div>\n\n                <div className=\"flex justify-end gap-3 pt-4\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={() => setShowEditProductModal(false)}\n                    data-testid=\"button-edit-cancel\"\n                  >\n                    Cancelar\n                  </Button>\n                  <Button\n                    type=\"submit\"\n                    disabled={updateProductMutation.isPending || categoriesLoading}\n                    data-testid=\"button-edit-save\"\n                  >\n                    {updateProductMutation.isPending ? \"Salvando...\" : \"Salvar Alterações\"}\n                  </Button>\n                </div>\n              </form>\n              )}\n            </DialogContent>\n          </Dialog>\n        </div>\n      </main>\n    </div>\n  );\n}\n","size_bytes":28910},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","size_bytes":4885},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":711},"client/src/components/dashboard/recent-sales.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Link } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { Sale, Client, Product, Category, Region } from \"@shared/schema\";\n\nexport default function RecentSales() {\n  const { data: sales, isLoading: salesLoading } = useQuery<Sale[]>({\n    queryKey: [\"/api/sales\"],\n  });\n\n  const { data: clients } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: products } = useQuery<Product[]>({\n    queryKey: [\"/api/products\"],\n  });\n\n  const { data: categories } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const { data: regions } = useQuery<Region[]>({\n    queryKey: [\"/api/regions\"],\n  });\n\n  const getTierBadgeClass = (tier: string) => {\n    switch (tier) {\n      case 'verde': return 'badge-verde';\n      case 'amarela': return 'badge-amarela';\n      case 'vermelha': return 'badge-vermelha';\n      default: return 'badge-verde';\n    }\n  };\n\n  const getTierColor = (tier: string) => {\n    switch (tier) {\n      case 'verde': return 'text-verde';\n      case 'amarela': return 'text-amarela';\n      case 'vermelha': return 'text-vermelha';\n      default: return 'text-verde';\n    }\n  };\n\n  const recentSales = sales\n    ?.sort((a, b) => new Date(b.saleDate).getTime() - new Date(a.saleDate).getTime())\n    .slice(0, 5)\n    .map(sale => {\n      const client = clients?.find(c => c.id === sale.clientId);\n      const product = products?.find(p => p.id === sale.productId);\n      const category = categories?.find(c => c.id === sale.categoryId);\n      const region = regions?.find(r => r.id === client?.regionId);\n      \n      return {\n        id: sale.id,\n        client: client?.name || \"Cliente desconhecido\",\n        region: region?.name || \"Região desconhecida\",\n        product: product?.name || \"Produto desconhecido\",\n        category: category?.name || \"Categoria desconhecida\",\n        value: parseFloat(sale.totalAmount),\n        commission: parseFloat(sale.commissionAmount),\n        tier: sale.commissionTier\n      };\n    }) || [];\n\n  if (salesLoading) {\n    return (\n      <Card className=\"shadow-sm\" data-testid=\"recent-sales\">\n        <CardHeader className=\"flex items-center justify-between\">\n          <CardTitle className=\"text-lg font-bold\">Vendas Recentes</CardTitle>\n          <Link href=\"/vendas\" className=\"text-sm text-primary hover:underline\">\n            Ver todas\n          </Link>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-center py-8 text-muted-foreground\">\n            Carregando vendas...\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (!recentSales || recentSales.length === 0) {\n    return (\n      <Card className=\"shadow-sm\" data-testid=\"recent-sales\">\n        <CardHeader className=\"flex items-center justify-between\">\n          <CardTitle className=\"text-lg font-bold\">Vendas Recentes</CardTitle>\n          <Link href=\"/vendas\" className=\"text-sm text-primary hover:underline\">\n            Ver todas\n          </Link>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-center py-8 text-muted-foreground\">\n            Nenhuma venda registrada\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className=\"shadow-sm\" data-testid=\"recent-sales\">\n      <CardHeader className=\"flex items-center justify-between\">\n        <CardTitle className=\"text-lg font-bold\">Vendas Recentes</CardTitle>\n        <Link href=\"/vendas\" className=\"text-sm text-primary hover:underline\">\n          Ver todas\n        </Link>\n      </CardHeader>\n      <CardContent>\n        <div className=\"overflow-x-auto\">\n          <table className=\"w-full\">\n            <thead>\n              <tr className=\"border-b border-border\">\n                <th className=\"text-left py-3 px-4 text-xs font-semibold text-muted-foreground uppercase\">Cliente</th>\n                <th className=\"text-left py-3 px-4 text-xs font-semibold text-muted-foreground uppercase\">Produto</th>\n                <th className=\"text-left py-3 px-4 text-xs font-semibold text-muted-foreground uppercase\">Categoria</th>\n                <th className=\"text-right py-3 px-4 text-xs font-semibold text-muted-foreground uppercase\">Valor (USD)</th>\n                <th className=\"text-right py-3 px-4 text-xs font-semibold text-muted-foreground uppercase\">Comissão</th>\n                <th className=\"text-center py-3 px-4 text-xs font-semibold text-muted-foreground uppercase\">Faixa</th>\n              </tr>\n            </thead>\n            <tbody>\n              {recentSales.map((sale) => (\n                <tr \n                  key={sale.id} \n                  className=\"border-b border-border hover:bg-muted/50 transition-colors\"\n                  data-testid={`sale-row-${sale.id}`}\n                >\n                  <td className=\"py-3 px-4\">\n                    <div>\n                      <p className=\"text-sm font-medium text-foreground\">{sale.client}</p>\n                      <p className=\"text-xs text-muted-foreground\">{sale.region}</p>\n                    </div>\n                  </td>\n                  <td className=\"py-3 px-4 text-sm text-foreground\">{sale.product}</td>\n                  <td className=\"py-3 px-4 text-sm text-foreground\">{sale.category}</td>\n                  <td className=\"py-3 px-4 text-right font-mono font-semibold text-foreground\">\n                    ${sale.value.toLocaleString()}\n                  </td>\n                  <td className={`py-3 px-4 text-right font-mono font-semibold ${getTierColor(sale.tier)}`}>\n                    ${sale.commission.toLocaleString()}\n                  </td>\n                  <td className=\"py-3 px-4 text-center\">\n                    <Badge className={`${getTierBadgeClass(sale.tier)} text-xs font-medium capitalize`}>\n                      {sale.tier}\n                    </Badge>\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":6115},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","size_bytes":261},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","size_bytes":4845},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, text, varchar, decimal, integer, timestamp, boolean, jsonb, unique } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\nexport const session = pgTable(\"session\", {\n  sid: varchar(\"sid\").primaryKey(),\n  sess: jsonb(\"sess\").notNull(),\n  expire: timestamp(\"expire\").notNull(),\n});\n\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  username: text(\"username\").notNull().unique(),\n  password: text(\"password\").notNull(),\n  name: text(\"name\").notNull(),\n  role: text(\"role\").notNull().default(\"consultor\"), // consultor, gerente, administrador, faturista\n  managerId: varchar(\"manager_id\").references((): any => users.id), // gerente responsável (apenas para consultores)\n});\n\nexport const passwordResetTokens = pgTable(\"password_reset_tokens\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  token: text(\"token\").notNull().unique(),\n  expiresAt: timestamp(\"expires_at\").notNull(),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  usedAt: timestamp(\"used_at\"),\n});\n\nexport const categories = pgTable(\"categories\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  type: text(\"type\").notNull(), // fertilizantes, sementes, especialidades, agroquimicos\n  greenCommission: decimal(\"green_commission\", { precision: 5, scale: 3 }).notNull(),\n  greenMarginMin: decimal(\"green_margin_min\", { precision: 5, scale: 2 }).notNull(),\n  yellowCommission: decimal(\"yellow_commission\", { precision: 5, scale: 3 }).notNull(),\n  yellowMarginMin: decimal(\"yellow_margin_min\", { precision: 5, scale: 2 }).notNull(),\n  yellowMarginMax: decimal(\"yellow_margin_max\", { precision: 5, scale: 2 }).notNull(),\n  redCommission: decimal(\"red_commission\", { precision: 5, scale: 3 }).notNull(),\n  redMarginMin: decimal(\"red_margin_min\", { precision: 5, scale: 2 }).notNull(),\n  redMarginMax: decimal(\"red_margin_max\", { precision: 5, scale: 2 }).notNull(),\n  belowListCommission: decimal(\"below_list_commission\", { precision: 5, scale: 3 }).notNull(),\n  defaultIva: decimal(\"default_iva\", { precision: 4, scale: 2 }).notNull().default(\"10.00\"),\n});\n\nexport const subcategories = pgTable(\"subcategories\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  categoryId: varchar(\"category_id\").notNull().references(() => categories.id),\n  displayOrder: integer(\"display_order\").notNull().default(0),\n});\n\nexport const products = pgTable(\"products\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  categoryId: varchar(\"category_id\").notNull().references(() => categories.id),\n  subcategoryId: varchar(\"subcategory_id\").references(() => subcategories.id),\n  description: text(\"description\"),\n  marca: text(\"marca\"), // brand name (e.g., \"Timac\")\n  packageSize: decimal(\"package_size\", { precision: 10, scale: 2 }), // extracted from product name (e.g., 20 from \"20LTS\")\n  segment: text(\"segment\"), // for agrochemicals: fungicida, inseticida, herbicida, ts, outros\n  timacPoints: decimal(\"timac_points\", { precision: 10, scale: 2 }).default(\"0.00\"), // points generated for Timac program\n  isActive: boolean(\"is_active\").notNull().default(true),\n});\n\nexport const regions = pgTable(\"regions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  country: text(\"country\").notNull().default(\"Paraguay\"),\n});\n\nexport const timacSettings = pgTable(\"timac_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  consultorValue: decimal(\"consultor_value\", { precision: 10, scale: 2 }).notNull().default(\"0.76\"), // value per point for Consultor\n  gerentesValue: decimal(\"gerentes_value\", { precision: 10, scale: 2 }).notNull().default(\"0.76\"), // value per point for Gerentes\n  faturistasValue: decimal(\"faturistas_value\", { precision: 10, scale: 2 }).notNull().default(\"0.76\"), // value per point for Faturistas\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\nexport const clients = pgTable(\"clients\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  regionId: varchar(\"region_id\").notNull().references(() => regions.id),\n  plantingArea: decimal(\"planting_area\", { precision: 10, scale: 2 }).notNull(), // hectares\n  cultures: jsonb(\"cultures\").notNull().default(\"[]\"), // array of strings\n  plantingProgress: decimal(\"planting_progress\", { precision: 5, scale: 2 }).notNull().default(\"0.00\"), // percentage\n  isTop80_20: boolean(\"is_top80_20\").notNull().default(false),\n  includeInMarketArea: boolean(\"include_in_market_area\").notNull().default(false), // mark client as part of market area for potential calculations\n  isActive: boolean(\"is_active\").notNull().default(true),\n  userId: varchar(\"user_id\").references(() => users.id),\n});\n\n// Master clients database - shared across all users\nexport const masterClients = pgTable(\"master_clients\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  regionId: varchar(\"region_id\").references(() => regions.id),\n  plantingArea: decimal(\"planting_area\", { precision: 10, scale: 2 }),\n  cultures: jsonb(\"cultures\").default(\"[]\"),\n  creditLine: decimal(\"credit_line\", { precision: 12, scale: 2 }), // Linha de Crédito\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\n// Links users to master clients\nexport const userClientLinks = pgTable(\"user_client_links\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  masterClientId: varchar(\"master_client_id\").notNull().references(() => masterClients.id, { onDelete: \"cascade\" }),\n  customName: text(\"custom_name\"), // optional: override master client name for this user\n  plantingArea: decimal(\"planting_area\", { precision: 10, scale: 2 }), // optional: override for this user\n  cultures: jsonb(\"cultures\"), // optional: override for this user\n  plantingProgress: decimal(\"planting_progress\", { precision: 5, scale: 2 }).default(\"0.00\"),\n  isTop80_20: boolean(\"is_top80_20\").notNull().default(false),\n  includeInMarketArea: boolean(\"include_in_market_area\").notNull().default(false), // mark client as part of market area for potential calculations\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n});\n\nexport const clientFamilyRelations = pgTable(\"client_family_relations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  clientId: varchar(\"client_id\").notNull().references(() => userClientLinks.id, { onDelete: \"cascade\" }),\n  relatedClientId: varchar(\"related_client_id\").notNull().references(() => userClientLinks.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n});\n\nexport const alertSettings = pgTable(\"alert_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id).unique(),\n  emailEnabled: boolean(\"email_enabled\").notNull().default(false),\n  notificationsEnabled: boolean(\"notifications_enabled\").notNull().default(true),\n  goalAlerts: boolean(\"goal_alerts\").notNull().default(true),\n  opportunityAlerts: boolean(\"opportunity_alerts\").notNull().default(true),\n  seasonDeadlineAlerts: boolean(\"season_deadline_alerts\").notNull().default(true),\n  goalThresholdPercent: decimal(\"goal_threshold_percent\", { precision: 5, scale: 2 }).notNull().default(\"80.00\"),\n  email: text(\"email\"),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\nexport const alerts = pgTable(\"alerts\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  type: text(\"type\").notNull(), // meta, oportunidade, prazo_safra\n  title: text(\"title\").notNull(),\n  message: text(\"message\").notNull(),\n  severity: text(\"severity\").notNull().default(\"info\"), // info, warning, urgent\n  relatedId: varchar(\"related_id\"), // seasonId, clientId, etc\n  relatedType: text(\"related_type\"), // season, client, goal, etc\n  isRead: boolean(\"is_read\").notNull().default(false),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n});\n\nexport const seasons = pgTable(\"seasons\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(), // e.g., \"Soja 25/26\", \"Milho 25/25\"\n  type: text(\"type\").notNull(), // soja_verao, soja_safrinha, milho, trigo\n  year: integer(\"year\").notNull(),\n  startDate: timestamp(\"start_date\").notNull(),\n  endDate: timestamp(\"end_date\").notNull(),\n  isActive: boolean(\"is_active\").notNull().default(true),\n});\n\nexport const seasonGoals = pgTable(\"season_goals\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  seasonId: varchar(\"season_id\").notNull().references(() => seasons.id),\n  goalAmount: decimal(\"goal_amount\", { precision: 15, scale: 2 }).notNull(),\n  metaAgroquimicos: decimal(\"meta_agroquimicos\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  metaEspecialidades: decimal(\"meta_especialidades\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  metaSementesMilho: decimal(\"meta_sementes_milho\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  metaSementesSoja: decimal(\"meta_sementes_soja\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  metaSementesTrigo: decimal(\"meta_sementes_trigo\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  metaSementesDiversas: decimal(\"meta_sementes_diversas\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  metaFertilizantes: decimal(\"meta_fertilizantes\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  metaCorretivos: decimal(\"meta_corretivos\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n});\n\nexport const sales = pgTable(\"sales\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  clientId: varchar(\"client_id\").notNull().references(() => userClientLinks.id),\n  productId: varchar(\"product_id\").notNull().references(() => products.id),\n  categoryId: varchar(\"category_id\").notNull().references(() => categories.id),\n  seasonId: varchar(\"season_id\").notNull().references(() => seasons.id),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  saleDate: timestamp(\"sale_date\").notNull(),\n  dueDate: timestamp(\"due_date\").notNull(),\n  totalAmount: decimal(\"total_amount\", { precision: 15, scale: 2 }).notNull(), // USD\n  quantity: decimal(\"quantity\", { precision: 15, scale: 2 }), // calculated quantity (Cant. Pedido × packageSize)\n  margin: decimal(\"margin\", { precision: 5, scale: 2 }).notNull(), // percentage\n  ivaRate: decimal(\"iva_rate\", { precision: 4, scale: 2 }).notNull(),\n  commissionRate: decimal(\"commission_rate\", { precision: 5, scale: 3 }).notNull(),\n  commissionAmount: decimal(\"commission_amount\", { precision: 15, scale: 2 }).notNull(),\n  commissionTier: text(\"commission_tier\").notNull(), // verde, amarela, vermelha, abaixo_lista\n  timacPoints: decimal(\"timac_points\", { precision: 10, scale: 2 }), // Timac reward points\n  isManual: boolean(\"is_manual\").notNull().default(false),\n  importBatchId: varchar(\"import_batch_id\"),\n  orderCode: varchar(\"order_code\"), // Código do pedido da planilha (ex: \"120051\") para evitar duplicatas\n  pdfFileName: text(\"pdf_file_name\"),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n});\n\nexport const seasonParameters = pgTable(\"season_parameters\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  type: text(\"type\").notNull(), // soja_verao, soja_safrinha, milho, trigo\n  dueDateMonth: integer(\"due_date_month\").notNull(),\n  dueDateDay: integer(\"due_date_day\").notNull(),\n  labelPattern: text(\"label_pattern\").notNull(), // e.g., \"Soja {year}/{next_year}\", \"Milho {year}/{year}\"\n});\n\nexport const salesHistory = pgTable(\"sales_history\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  clientId: varchar(\"client_id\").notNull().references(() => userClientLinks.id),\n  seasonId: varchar(\"season_id\").notNull().references(() => seasons.id),\n  totalSales: decimal(\"total_sales\", { precision: 15, scale: 2 }).notNull(),\n  totalCommissions: decimal(\"total_commissions\", { precision: 15, scale: 2 }).notNull(),\n  productsSold: jsonb(\"products_sold\").notNull().default(\"[]\"), // array of product info\n});\n\nexport const marketInvestmentRates = pgTable(\"market_investment_rates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  categoryId: varchar(\"category_id\").notNull().references(() => categories.id),\n  investmentPerHa: decimal(\"investment_per_ha\", { precision: 10, scale: 2 }).notNull(), // USD per hectare\n  subcategories: jsonb(\"subcategories\"), // optional breakdown for categories like Agroquímicos\n});\n\nexport const clientMarketRates = pgTable(\"client_market_rates\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  clientId: varchar(\"client_id\").notNull().references(() => userClientLinks.id),\n  categoryId: varchar(\"category_id\").notNull().references(() => categories.id),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  seasonId: varchar(\"season_id\").notNull().references(() => seasons.id),\n  investmentPerHa: decimal(\"investment_per_ha\", { precision: 10, scale: 2 }).notNull(), // USD per hectare\n  subcategories: jsonb(\"subcategories\"), // optional breakdown for categories like Agroquímicos\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\n// Client Market Values - Valores da coluna \"Mercado\" (vendas com concorrentes)\nexport const clientMarketValues = pgTable(\"client_market_values\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  clientId: varchar(\"client_id\").notNull().references(() => userClientLinks.id, { onDelete: \"cascade\" }),\n  categoryId: varchar(\"category_id\").notNull().references(() => categories.id),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  seasonId: varchar(\"season_id\").notNull().references(() => seasons.id),\n  marketValue: decimal(\"market_value\", { precision: 12, scale: 2 }).notNull().default(\"0.00\"), // valor manual ou automático de vendas perdidas para concorrentes\n  subcategories: jsonb(\"subcategories\"), // breakdown para Agroquímicos\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\nexport const marketBenchmarks = pgTable(\"market_benchmarks\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  categoryId: varchar(\"category_id\").notNull().references(() => categories.id),\n  seasonId: varchar(\"season_id\").notNull().references(() => seasons.id),\n  marketPercentage: decimal(\"market_percentage\", { precision: 5, scale: 2 }).notNull(), // percentage (0-100)\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\nexport const externalPurchases = pgTable(\"external_purchases\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  clientId: varchar(\"client_id\").notNull().references(() => userClientLinks.id),\n  categoryId: varchar(\"category_id\").notNull().references(() => categories.id),\n  seasonId: varchar(\"season_id\").notNull().references(() => seasons.id),\n  amount: decimal(\"amount\", { precision: 15, scale: 2 }).notNull(), // USD amount purchased externally\n  company: text(\"company\"), // optional: name of external company\n  subcategories: jsonb(\"subcategories\"), // optional breakdown for Agroquímicos: {Dessecação: 1000, Inseticidas: 2000, etc}\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\n// BARTER MODULE TABLES\nexport const barterProducts = pgTable(\"barter_products\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  category: text(\"category\").notNull(), // sementes, fertilizantes, herbicidas, inseticidas, fungicidas, especialidades, tratamento_sementes, dessecacao\n  principioAtivo: text(\"principio_ativo\"), // active ingredient / technical description\n  dosePerHa: text(\"dose_per_ha\"), // dose/hectare as text (e.g., \"2ml/Kg\", \"1Lt/Há\")\n  unit: text(\"unit\").notNull(), // kg, lt, sc, etc\n  fabricante: text(\"fabricante\"), // manufacturer/brand\n  priceUsd: decimal(\"price_usd\", { precision: 10, scale: 2 }).notNull(), // default price (verde)\n  priceVermelha: decimal(\"price_vermelha\", { precision: 10, scale: 2 }), // red tier price\n  priceAmarela: decimal(\"price_amarela\", { precision: 10, scale: 2 }), // yellow tier price\n  priceVerde: decimal(\"price_verde\", { precision: 10, scale: 2 }), // green tier price\n  seasonId: varchar(\"season_id\").references(() => seasons.id), // optional: associate with specific season\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\nexport const barterSettings = pgTable(\"barter_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  key: text(\"key\").notNull().unique(), // sack_price, buffer_percentage, min_products, etc\n  value: text(\"value\").notNull(),\n  description: text(\"description\"),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\nexport const barterSimulations = pgTable(\"barter_simulations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  clientId: varchar(\"client_id\").notNull().references(() => userClientLinks.id),\n  clientName: text(\"client_name\").notNull(),\n  areaHa: decimal(\"area_ha\", { precision: 10, scale: 2 }).notNull(),\n  totalUsd: decimal(\"total_usd\", { precision: 15, scale: 2 }).notNull(),\n  sackPriceUsd: decimal(\"sack_price_usd\", { precision: 10, scale: 2 }).notNull(),\n  bufferPercentage: decimal(\"buffer_percentage\", { precision: 5, scale: 2 }).notNull(),\n  grainQuantityKg: decimal(\"grain_quantity_kg\", { precision: 15, scale: 2 }).notNull(),\n  grainQuantitySacks: decimal(\"grain_quantity_sacks\", { precision: 15, scale: 3 }).notNull(),\n  status: text(\"status\").notNull().default(\"draft\"), // draft, approved, executed, cancelled\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\nexport const barterSimulationItems = pgTable(\"barter_simulation_items\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  simulationId: varchar(\"simulation_id\").notNull().references(() => barterSimulations.id, { onDelete: \"cascade\" }),\n  productId: varchar(\"product_id\").notNull().references(() => barterProducts.id),\n  productName: text(\"product_name\").notNull(),\n  category: text(\"category\").notNull(),\n  quantity: decimal(\"quantity\", { precision: 10, scale: 3 }).notNull(),\n  unit: text(\"unit\").notNull(),\n  priceUsd: decimal(\"price_usd\", { precision: 10, scale: 2 }).notNull(),\n  totalUsd: decimal(\"total_usd\", { precision: 15, scale: 2 }).notNull(),\n});\n\n// Action Plans (Manager feature)\nexport const actionPlans = pgTable(\"action_plans\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  managerId: varchar(\"manager_id\").notNull().references(() => users.id),\n  seasonId: varchar(\"season_id\").notNull().references(() => seasons.id),\n  title: text(\"title\").notNull(),\n  meetingDate: timestamp(\"meeting_date\").notNull(),\n  targetAmount: decimal(\"target_amount\", { precision: 15, scale: 2 }).notNull(),\n  currentAmount: decimal(\"current_amount\", { precision: 15, scale: 2 }).notNull(),\n  status: text(\"status\").notNull().default(\"planejado\"), // planejado, em_andamento, concluido, atrasado\n  strengths: text(\"strengths\"), // pontos fortes\n  challenges: text(\"challenges\"), // desafios\n  opportunities: text(\"opportunities\"), // oportunidades\n  nextMeetingDate: timestamp(\"next_meeting_date\"),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\nexport const actionPlanItems = pgTable(\"action_plan_items\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  planId: varchar(\"plan_id\").notNull().references(() => actionPlans.id, { onDelete: \"cascade\" }),\n  consultorId: varchar(\"consultor_id\").notNull().references(() => users.id),\n  description: text(\"description\").notNull(),\n  categoryId: varchar(\"category_id\").references(() => categories.id),\n  clientId: varchar(\"client_id\").references(() => userClientLinks.id),\n  deadline: timestamp(\"deadline\").notNull(),\n  expectedValue: decimal(\"expected_value\", { precision: 15, scale: 2 }).notNull(),\n  actualValue: decimal(\"actual_value\", { precision: 15, scale: 2 }),\n  status: text(\"status\").notNull().default(\"pendente\"), // pendente, em_progresso, concluida, cancelada\n  notes: text(\"notes\"),\n  completedAt: timestamp(\"completed_at\"),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n});\n\nexport const actionPlanParticipants = pgTable(\"action_plan_participants\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  planId: varchar(\"plan_id\").notNull().references(() => actionPlans.id, { onDelete: \"cascade\" }),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n});\n\n// Insert schemas\nexport const insertUserSchema = createInsertSchema(users).pick({\n  username: true,\n  password: true,\n  name: true,\n  role: true,\n  managerId: true,\n});\n\nexport const insertCategorySchema = createInsertSchema(categories).omit({\n  id: true,\n});\n\nexport const insertSubcategorySchema = createInsertSchema(subcategories).omit({\n  id: true,\n});\n\nexport const insertProductSchema = createInsertSchema(products).omit({\n  id: true,\n});\n\nexport const insertRegionSchema = createInsertSchema(regions).omit({\n  id: true,\n});\n\nexport const insertTimacSettingsSchema = createInsertSchema(timacSettings).omit({\n  id: true,\n  updatedAt: true,\n});\n\nexport const insertClientSchema = createInsertSchema(clients).omit({\n  id: true,\n});\n\nexport const insertSeasonSchema = createInsertSchema(seasons).omit({\n  id: true,\n});\n\nexport const insertSeasonGoalSchema = z.object({\n  seasonId: z.string(),\n  goalAmount: z.string(),\n  metaAgroquimicos: z.string().optional(),\n  metaEspecialidades: z.string().optional(),\n  metaSementesMilho: z.string().optional(),\n  metaSementesSoja: z.string().optional(),\n  metaSementesTrigo: z.string().optional(),\n  metaSementesDiversas: z.string().optional(),\n  metaFertilizantes: z.string().optional(),\n  metaCorretivos: z.string().optional(),\n  userId: z.string(),\n});\n\nexport const insertSaleSchema = createInsertSchema(sales).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertSeasonParameterSchema = createInsertSchema(seasonParameters).omit({\n  id: true,\n});\n\nexport const insertMarketInvestmentRateSchema = createInsertSchema(marketInvestmentRates).omit({\n  id: true,\n});\n\nexport const insertClientMarketRateSchema = createInsertSchema(clientMarketRates).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertClientMarketValueSchema = createInsertSchema(clientMarketValues).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertMarketBenchmarkSchema = createInsertSchema(marketBenchmarks).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertExternalPurchaseSchema = createInsertSchema(externalPurchases).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertClientFamilyRelationSchema = createInsertSchema(clientFamilyRelations).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertAlertSettingsSchema = createInsertSchema(alertSettings).omit({\n  id: true,\n  updatedAt: true,\n});\n\nexport const insertAlertSchema = createInsertSchema(alerts).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const purchaseHistory = pgTable(\"purchase_history\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  clientId: varchar(\"client_id\").notNull().references(() => userClientLinks.id),\n  seasonId: varchar(\"season_id\").references(() => seasons.id),\n  seasonName: text(\"season_name\").notNull(), // extracted from PDF if season not matched\n  sourceFile: text(\"source_file\").notNull(),\n  importDate: timestamp(\"import_date\").notNull().default(sql`now()`),\n  totalAmount: decimal(\"total_amount\", { precision: 15, scale: 2 }).notNull().default(\"0\"),\n});\n\nexport const purchaseHistoryItems = pgTable(\"purchase_history_items\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  purchaseHistoryId: varchar(\"purchase_history_id\").notNull().references(() => purchaseHistory.id, { onDelete: \"cascade\" }),\n  productCode: text(\"product_code\").notNull(), // from PDF (e.g., \"925041\")\n  productName: text(\"product_name\").notNull(),\n  packageType: text(\"package_type\"), // envase (e.g., \"BIDON 20L\")\n  quantity: decimal(\"quantity\", { precision: 10, scale: 2 }).notNull(),\n  unitPrice: decimal(\"total_price\", { precision: 15, scale: 2 }).notNull(),\n  totalPrice: decimal(\"unit_price\", { precision: 15, scale: 2 }).notNull(),\n  purchaseDate: timestamp(\"purchase_date\").notNull(), // emisión date\n  orderCode: text(\"order_code\"), // Cód.Int from PDF\n});\n\nexport const insertPurchaseHistorySchema = createInsertSchema(purchaseHistory).omit({\n  id: true,\n  importDate: true,\n});\n\nexport const insertPurchaseHistoryItemSchema = createInsertSchema(purchaseHistoryItems).omit({\n  id: true,\n});\n\n// Types\nexport type User = typeof users.$inferSelect;\nexport type InsertUser = z.infer<typeof insertUserSchema>;\n\nexport type Category = typeof categories.$inferSelect;\nexport type InsertCategory = z.infer<typeof insertCategorySchema>;\n\nexport type Subcategory = typeof subcategories.$inferSelect;\nexport type InsertSubcategory = z.infer<typeof insertSubcategorySchema>;\n\nexport type Product = typeof products.$inferSelect;\nexport type InsertProduct = z.infer<typeof insertProductSchema>;\n\nexport type Region = typeof regions.$inferSelect;\nexport type InsertRegion = z.infer<typeof insertRegionSchema>;\n\nexport type TimacSettings = typeof timacSettings.$inferSelect;\nexport type InsertTimacSettings = z.infer<typeof insertTimacSettingsSchema>;\n\nexport type Client = typeof clients.$inferSelect;\nexport type InsertClient = z.infer<typeof insertClientSchema>;\n\nexport type Season = typeof seasons.$inferSelect;\nexport type InsertSeason = z.infer<typeof insertSeasonSchema>;\n\nexport type SeasonGoal = typeof seasonGoals.$inferSelect;\nexport type InsertSeasonGoal = z.infer<typeof insertSeasonGoalSchema>;\n\nexport type Sale = typeof sales.$inferSelect;\nexport type InsertSale = z.infer<typeof insertSaleSchema>;\n\nexport type SeasonParameter = typeof seasonParameters.$inferSelect;\nexport type InsertSeasonParameter = z.infer<typeof insertSeasonParameterSchema>;\n\nexport type SalesHistory = typeof salesHistory.$inferSelect;\n\nexport type MarketInvestmentRate = typeof marketInvestmentRates.$inferSelect;\nexport type InsertMarketInvestmentRate = z.infer<typeof insertMarketInvestmentRateSchema>;\n\nexport type ClientMarketRate = typeof clientMarketRates.$inferSelect;\nexport type InsertClientMarketRate = z.infer<typeof insertClientMarketRateSchema>;\n\nexport type ClientMarketValue = typeof clientMarketValues.$inferSelect;\nexport type InsertClientMarketValue = z.infer<typeof insertClientMarketValueSchema>;\n\nexport type MarketBenchmark = typeof marketBenchmarks.$inferSelect;\nexport type InsertMarketBenchmark = z.infer<typeof insertMarketBenchmarkSchema>;\n\nexport type ExternalPurchase = typeof externalPurchases.$inferSelect;\nexport type InsertExternalPurchase = z.infer<typeof insertExternalPurchaseSchema>;\n\nexport type ClientFamilyRelation = typeof clientFamilyRelations.$inferSelect;\nexport type InsertClientFamilyRelation = z.infer<typeof insertClientFamilyRelationSchema>;\n\nexport type AlertSettings = typeof alertSettings.$inferSelect;\nexport type InsertAlertSettings = z.infer<typeof insertAlertSettingsSchema>;\n\nexport type Alert = typeof alerts.$inferSelect;\nexport type InsertAlert = z.infer<typeof insertAlertSchema>;\n\nexport type PurchaseHistory = typeof purchaseHistory.$inferSelect;\nexport type InsertPurchaseHistory = z.infer<typeof insertPurchaseHistorySchema>;\n\nexport type PurchaseHistoryItem = typeof purchaseHistoryItems.$inferSelect;\nexport type InsertPurchaseHistoryItem = z.infer<typeof insertPurchaseHistoryItemSchema>;\n\nexport type MasterClient = typeof masterClients.$inferSelect;\nexport const insertMasterClientSchema = createInsertSchema(masterClients).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertMasterClient = z.infer<typeof insertMasterClientSchema>;\n\nexport type UserClientLink = typeof userClientLinks.$inferSelect;\nexport const insertUserClientLinkSchema = createInsertSchema(userClientLinks).omit({ id: true, createdAt: true });\nexport type InsertUserClientLink = z.infer<typeof insertUserClientLinkSchema>;\n\nexport type BarterProduct = typeof barterProducts.$inferSelect;\nexport const insertBarterProductSchema = createInsertSchema(barterProducts).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertBarterProduct = z.infer<typeof insertBarterProductSchema>;\n\nexport type BarterSettings = typeof barterSettings.$inferSelect;\nexport const insertBarterSettingsSchema = createInsertSchema(barterSettings).omit({ id: true, updatedAt: true });\nexport type InsertBarterSettings = z.infer<typeof insertBarterSettingsSchema>;\n\nexport type BarterSimulation = typeof barterSimulations.$inferSelect;\nexport const insertBarterSimulationSchema = createInsertSchema(barterSimulations).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertBarterSimulation = z.infer<typeof insertBarterSimulationSchema>;\n\nexport type BarterSimulationItem = typeof barterSimulationItems.$inferSelect;\nexport const insertBarterSimulationItemSchema = createInsertSchema(barterSimulationItems).omit({ id: true });\nexport type InsertBarterSimulationItem = z.infer<typeof insertBarterSimulationItemSchema>;\n\nexport type ActionPlan = typeof actionPlans.$inferSelect;\nexport const insertActionPlanSchema = createInsertSchema(actionPlans).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertActionPlan = z.infer<typeof insertActionPlanSchema>;\n\nexport type ActionPlanItem = typeof actionPlanItems.$inferSelect;\nexport const insertActionPlanItemSchema = createInsertSchema(actionPlanItems).omit({ id: true, createdAt: true });\nexport type InsertActionPlanItem = z.infer<typeof insertActionPlanItemSchema>;\n\nexport type ActionPlanParticipant = typeof actionPlanParticipants.$inferSelect;\nexport const insertActionPlanParticipantSchema = createInsertSchema(actionPlanParticipants).omit({ id: true });\nexport type InsertActionPlanParticipant = z.infer<typeof insertActionPlanParticipantSchema>;\n\n// Inventory Management Tables for Faturista\nexport const uploadSessions = pgTable(\"upload_sessions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sessionName: text(\"session_name\").notNull(),\n  inventoryFileName: text(\"inventory_file_name\"),\n  orderFilesCount: integer(\"order_files_count\").notNull().default(0),\n  status: text(\"status\").notNull().default(\"processing\"), // processing, completed, error\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  completedAt: timestamp(\"completed_at\"),\n});\n\nexport const inventoryItems = pgTable(\"inventory_items\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  productCode: text(\"product_code\").notNull(), // Cód.Int from PDF\n  productName: text(\"product_name\").notNull(), // Mercadería from PDF\n  packageType: text(\"package_type\"), // Embalaje from PDF\n  quantity: decimal(\"quantity\", { precision: 10, scale: 2 }).notNull(),\n  uploadedBy: varchar(\"uploaded_by\").notNull().references(() => users.id),\n  uploadSessionId: varchar(\"upload_session_id\").notNull().references(() => uploadSessions.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n});\n\nexport const pendingOrders = pgTable(\"pending_orders\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  productCode: text(\"product_code\").notNull(), // (Cód) from PDF\n  productName: text(\"product_name\").notNull(),\n  packageType: text(\"package_type\"), // Envase from PDF\n  quantityPending: decimal(\"quantity_pending\", { precision: 10, scale: 2 }).notNull(), // Cant. Falta\n  clientName: text(\"client_name\").notNull(), // Entidad from PDF\n  consultorName: text(\"consultor_name\"), // Comprador/Vendedor from PDF\n  orderCode: text(\"order_code\"), // Cód.Int from PDF\n  uploadedBy: varchar(\"uploaded_by\").notNull().references(() => users.id),\n  uploadSessionId: varchar(\"upload_session_id\").notNull().references(() => uploadSessions.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n});\n\nexport const stockAnalysisResults = pgTable(\"stock_analysis_results\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  productCode: text(\"product_code\").notNull(),\n  productName: text(\"product_name\").notNull(),\n  stockQuantity: decimal(\"stock_quantity\", { precision: 10, scale: 2 }).notNull(),\n  ordersQuantity: decimal(\"orders_quantity\", { precision: 10, scale: 2 }).notNull(),\n  status: text(\"status\").notNull(), // DISPONÍVEL, PARCIAL, INDISPONÍVEL\n  percentage: decimal(\"percentage\", { precision: 5, scale: 2 }),\n  clientsList: jsonb(\"clients_list\").notNull().default(\"[]\"), // array of { clientName, quantity }\n  uploadSessionId: varchar(\"upload_session_id\").notNull().references(() => uploadSessions.id, { onDelete: \"cascade\" }),\n  createdBy: varchar(\"created_by\").notNull().references(() => users.id),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n});\n\n// CRM Tables\nexport const farms = pgTable(\"farms\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  clientId: varchar(\"client_id\").notNull().references(() => masterClients.id),\n  lat: decimal(\"lat\", { precision: 10, scale: 7 }),\n  lng: decimal(\"lng\", { precision: 10, scale: 7 }),\n  address: text(\"address\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n});\n\nexport const fields = pgTable(\"fields\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  farmId: varchar(\"farm_id\").notNull().references(() => farms.id, { onDelete: \"cascade\" }),\n  area: decimal(\"area\", { precision: 10, scale: 2 }), // hectares\n  crop: text(\"crop\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n});\n\nexport const visits = pgTable(\"visits\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  clientId: varchar(\"client_id\").notNull().references(() => masterClients.id),\n  farmId: varchar(\"farm_id\").references(() => farms.id),\n  fieldId: varchar(\"field_id\").references(() => fields.id),\n  scheduledAt: timestamp(\"scheduled_at\"),\n  windowStart: timestamp(\"window_start\"),\n  windowEnd: timestamp(\"window_end\"),\n  status: text(\"status\").notNull().default(\"PLANEJADA\"),\n  assignee: varchar(\"assignee\").references(() => users.id),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\nexport const trips = pgTable(\"trips\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  visitId: varchar(\"visit_id\").references(() => visits.id),\n  startedAt: timestamp(\"started_at\"),\n  endedAt: timestamp(\"ended_at\"),\n  startOdometer: integer(\"start_odometer\"),\n  endOdometer: integer(\"end_odometer\"),\n  distanceKm: decimal(\"distance_km\", { precision: 10, scale: 2 }),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\nexport const telemetryGps = pgTable(\"telemetry_gps\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  tripId: varchar(\"trip_id\").references(() => trips.id),\n  ts: timestamp(\"ts\").notNull(),\n  lat: decimal(\"lat\", { precision: 10, scale: 7 }).notNull(),\n  lng: decimal(\"lng\", { precision: 10, scale: 7 }).notNull(),\n  speedKmh: decimal(\"speed_kmh\", { precision: 5, scale: 2 }),\n  accuracyM: decimal(\"accuracy_m\", { precision: 6, scale: 2 }),\n});\n\nexport const checklists = pgTable(\"checklists\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  visitId: varchar(\"visit_id\").notNull().references(() => visits.id, { onDelete: \"cascade\" }),\n  data: jsonb(\"data\").notNull(), // flexible checklist data\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n});\n\nexport const automations = pgTable(\"automations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  trigger: text(\"trigger\").notNull(), // GEOFENCE_ENTER, GEOFENCE_EXIT, TIME_BASED\n  action: text(\"action\").notNull(), // UPDATE_STATUS, SEND_NOTIFICATION\n  config: jsonb(\"config\").notNull(),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n});\n\nexport const auditLogs = pgTable(\"audit_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  action: text(\"action\").notNull(),\n  entityType: text(\"entity_type\").notNull(),\n  entityId: varchar(\"entity_id\").notNull(),\n  changes: jsonb(\"changes\"),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n});\n\n// Sales Targets - Kanban de Metas\nexport const salesTargets = pgTable(\"sales_targets\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  clientId: varchar(\"client_id\").notNull().references(() => userClientLinks.id, { onDelete: \"cascade\" }),\n  seasonId: varchar(\"season_id\").notNull().references(() => seasons.id),\n  segmento: text(\"segmento\").notNull(), // fertilizantes, sementes, especialidades, agroquimicos, corretivos\n  valorCapturado: decimal(\"valor_capturado\", { precision: 12, scale: 2 }).notNull(),\n  subcategories: jsonb(\"subcategories\"), // para agroquimicos: { \"Tratamento de semente\": 50, \"Dessecação\": 30, ... }\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\n// Products Price Table - Tabela de Preços\nexport const productsPriceTable = pgTable(\"products_price_table\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  mercaderia: text(\"mercaderia\").notNull(), // product name\n  principioAtivo: text(\"principio_ativo\"), // P.A\n  categoria: text(\"categoria\").notNull(), // TS, DESSECAÇÃO, INSETICIDAS, FUNGICIDAS\n  subcategory: text(\"subcategory\"), // manual classification: Fungicidas, Inseticidas, TS, Dessecação\n  dose: text(\"dose\"), // dosage\n  fabricante: text(\"fabricante\"), // manufacturer\n  precoVerde: decimal(\"preco_verde\", { precision: 10, scale: 2 }).notNull(), // green price $/ha or $/L/Ha\n  precoAmarela: decimal(\"preco_amarela\", { precision: 10, scale: 2 }).notNull(), // yellow price\n  precoVermelha: decimal(\"preco_vermelha\", { precision: 10, scale: 2 }).notNull(), // red price\n  unidade: text(\"unidade\").notNull().default(\"$/ha\"), // unit: $/ha, $/L/Ha, etc\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\n// Global Management Applications - Manejo Global (GLOBAL POR SAFRA - não vinculado a usuário)\nexport const globalManagementApplications = pgTable(\"global_management_applications\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  seasonId: varchar(\"season_id\").notNull().references(() => seasons.id),\n  categoria: text(\"categoria\").notNull(), // FUNGICIDAS, INSETICIDAS\n  applicationNumber: integer(\"application_number\").notNull(), // 1, 2, 3, etc\n  productId: varchar(\"product_id\").notNull().references(() => productsPriceTable.id),\n  priceTier: text(\"price_tier\").notNull(), // verde, amarela, vermelha\n  pricePerHa: decimal(\"price_per_ha\", { precision: 10, scale: 2 }).notNull(), // calculated from product + tier\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\n// Client Application Tracking - Rastreamento de Aplicações por Cliente\nexport const clientApplicationTracking = pgTable(\"client_application_tracking\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  clientId: varchar(\"client_id\").notNull().references(() => userClientLinks.id, { onDelete: \"cascade\" }),\n  seasonId: varchar(\"season_id\").notNull().references(() => seasons.id),\n  globalApplicationId: varchar(\"global_application_id\").notNull().references(() => globalManagementApplications.id),\n  categoria: text(\"categoria\").notNull(), // FUNGICIDAS, INSETICIDAS\n  applicationNumber: integer(\"application_number\").notNull(),\n  totalValue: decimal(\"total_value\", { precision: 12, scale: 2 }).notNull(), // price_per_ha × client planting area\n  status: text(\"status\"), // 'ABERTO' | 'FECHADO' | null - explicit status from user selection\n  isLostToCompetitor: boolean(\"is_lost_to_competitor\").notNull().default(false), // DEPRECATED: use status instead\n  soldValue: decimal(\"sold_value\", { precision: 12, scale: 2 }).notNull().default(\"0.00\"), // vendas do Excel\n  createdAt: timestamp(\"created_at\").notNull().default(sql`now()`),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n}, (table) => ({\n  // Unique constraint: um cliente não pode ter múltiplos registros para a mesma aplicação na mesma safra\n  uniqueTracking: unique().on(table.clientId, table.seasonId, table.globalApplicationId),\n}));\n\n// System Settings - Configurações Gerais do Sistema\nexport const systemSettings = pgTable(\"system_settings\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  allowUserRegistration: boolean(\"allow_user_registration\").notNull().default(true),\n  updatedAt: timestamp(\"updated_at\").notNull().default(sql`now()`),\n});\n\n// Insert schemas\nexport const insertInventoryItemSchema = createInsertSchema(inventoryItems).omit({ id: true, createdAt: true });\nexport type InsertInventoryItem = z.infer<typeof insertInventoryItemSchema>;\nexport type InventoryItem = typeof inventoryItems.$inferSelect;\n\nexport const insertPendingOrderSchema = createInsertSchema(pendingOrders).omit({ id: true, createdAt: true });\nexport type InsertPendingOrder = z.infer<typeof insertPendingOrderSchema>;\nexport type PendingOrder = typeof pendingOrders.$inferSelect;\n\nexport const insertStockAnalysisResultSchema = createInsertSchema(stockAnalysisResults).omit({ id: true, createdAt: true });\nexport type InsertStockAnalysisResult = z.infer<typeof insertStockAnalysisResultSchema>;\nexport type StockAnalysisResult = typeof stockAnalysisResults.$inferSelect;\n\nexport const insertUploadSessionSchema = createInsertSchema(uploadSessions).omit({ id: true, createdAt: true, completedAt: true });\nexport type InsertUploadSession = z.infer<typeof insertUploadSessionSchema>;\nexport type UploadSession = typeof uploadSessions.$inferSelect;\n\n// CRM Insert schemas\nexport const insertFarmSchema = createInsertSchema(farms).omit({ id: true, createdAt: true }).extend({\n  clientId: z.string().min(1, \"Cliente é obrigatório\"),\n  lat: z.union([z.string(), z.number()]).optional().transform(val => val ? String(val) : undefined),\n  lng: z.union([z.string(), z.number()]).optional().transform(val => val ? String(val) : undefined),\n});\nexport type InsertFarm = z.infer<typeof insertFarmSchema>;\nexport type Farm = typeof farms.$inferSelect;\n\nexport const insertFieldSchema = createInsertSchema(fields).omit({ id: true, createdAt: true });\nexport type InsertField = z.infer<typeof insertFieldSchema>;\nexport type Field = typeof fields.$inferSelect;\n\nexport const insertVisitSchema = createInsertSchema(visits).omit({ id: true, createdAt: true });\nexport type InsertVisit = z.infer<typeof insertVisitSchema>;\nexport type Visit = typeof visits.$inferSelect;\n\nexport const insertTripSchema = createInsertSchema(trips).omit({ id: true, createdAt: true });\nexport type InsertTrip = z.infer<typeof insertTripSchema>;\nexport type Trip = typeof trips.$inferSelect;\n\nexport const insertTelemetryGpsSchema = createInsertSchema(telemetryGps).omit({ id: true });\nexport type InsertTelemetryGps = z.infer<typeof insertTelemetryGpsSchema>;\nexport type TelemetryGps = typeof telemetryGps.$inferSelect;\n\nexport const insertChecklistSchema = createInsertSchema(checklists).omit({ id: true, createdAt: true });\nexport type InsertChecklist = z.infer<typeof insertChecklistSchema>;\nexport type Checklist = typeof checklists.$inferSelect;\n\nexport const insertAutomationSchema = createInsertSchema(automations).omit({ id: true, createdAt: true });\nexport type InsertAutomation = z.infer<typeof insertAutomationSchema>;\nexport type Automation = typeof automations.$inferSelect;\n\nexport const insertAuditLogSchema = createInsertSchema(auditLogs).omit({ id: true, createdAt: true });\nexport type InsertAuditLog = z.infer<typeof insertAuditLogSchema>;\nexport type AuditLog = typeof auditLogs.$inferSelect;\n\nexport const insertSalesTargetSchema = createInsertSchema(salesTargets).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertSalesTarget = z.infer<typeof insertSalesTargetSchema>;\nexport type SalesTarget = typeof salesTargets.$inferSelect;\n\nexport const insertPasswordResetTokenSchema = createInsertSchema(passwordResetTokens).omit({ id: true, createdAt: true, usedAt: true });\nexport type InsertPasswordResetToken = z.infer<typeof insertPasswordResetTokenSchema>;\nexport type PasswordResetToken = typeof passwordResetTokens.$inferSelect;\n\n// Products Price Table schemas\nexport const insertProductPriceTableSchema = createInsertSchema(productsPriceTable).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertProductPriceTable = z.infer<typeof insertProductPriceTableSchema>;\nexport type ProductPriceTable = typeof productsPriceTable.$inferSelect;\n\n// Global Management Applications schemas\nexport const insertGlobalManagementApplicationSchema = createInsertSchema(globalManagementApplications).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertGlobalManagementApplication = z.infer<typeof insertGlobalManagementApplicationSchema>;\nexport type GlobalManagementApplication = typeof globalManagementApplications.$inferSelect;\n\n// Client Application Tracking schemas\nexport const insertClientApplicationTrackingSchema = createInsertSchema(clientApplicationTracking).omit({ id: true, createdAt: true, updatedAt: true });\nexport type InsertClientApplicationTracking = z.infer<typeof insertClientApplicationTrackingSchema>;\nexport type ClientApplicationTracking = typeof clientApplicationTracking.$inferSelect;\n\n// System Settings schemas\nexport const insertSystemSettingsSchema = createInsertSchema(systemSettings).omit({ id: true, updatedAt: true });\nexport type InsertSystemSettings = z.infer<typeof insertSystemSettingsSchema>;\nexport type SystemSettings = typeof systemSettings.$inferSelect;\n","size_bytes":48451},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","size_bytes":1883},"design_guidelines.md":{"content":"# Design Guidelines: Market Benchmark Configuration Modal\n\n## Design Approach\n**System Selected**: Material Design principles adapted for agricultural enterprise software\n**Rationale**: Data-heavy configuration interface requires structured, efficient patterns. Material's elevation system and form patterns provide clarity for percentage-based inputs while maintaining professional credibility.\n\n## Core Design Elements\n\n### A. Color Palette\n**Dark Mode (Primary)**:\n- Primary Agricultural Green: 140 45% 45% (muted farm green)\n- Success/Confirmation: 140 50% 50% (brighter green for validation)\n- Surface Background: 0 0% 12% (modal base)\n- Input Fields: 0 0% 18% (elevated form fields)\n- Text Primary: 0 0% 95%\n- Text Secondary: 0 0% 65%\n- Border/Dividers: 0 0% 25%\n\n**Light Mode Variants** (if needed):\n- Primary Green: 140 45% 35%\n- Surface: 0 0% 98%\n- Input Fields: 0 0% 100% with subtle border\n\n### B. Typography\n**Font Stack**: Inter or System UI for data clarity\n- Modal Title: 20px, font-semibold\n- Category Labels: 14px, font-medium\n- Input Labels: 13px, font-medium, text-secondary\n- Helper Text: 12px, font-normal, text-secondary\n- Percentage Values: 16px, font-medium (when displayed)\n\n### C. Layout System\n**Spacing Primitives**: Tailwind units of 2, 4, 6, and 8\n- Modal padding: p-6\n- Section spacing: space-y-6\n- Input group spacing: space-y-4\n- Label-to-input gap: gap-2\n- Button spacing: gap-3\n\n**Modal Dimensions**:\n- Max width: max-w-2xl (672px)\n- Min height: Auto-fit content with max-h-[85vh]\n- Overflow: Internal scroll for long category lists\n\n### D. Component Library\n\n**Modal Structure**:\n- Overlay: bg-black/60 backdrop-blur-sm\n- Container: Rounded-xl (rounded-xl) with elevation shadow-2xl\n- Header: Sticky top position with title + close button, pb-4 border-b\n- Body: Scrollable content area with py-6\n- Footer: Sticky bottom with action buttons, pt-4 border-t\n\n**Input Components**:\n- **Percentage Input Fields**: \n  - Input type=\"number\" with % suffix displayed inline\n  - Dark background (bg-surface) with focus ring in primary green\n  - Right-aligned text for numerical consistency\n  - Min/Max validation indicators (0-100%)\n  - Step value: 0.1 for decimal precision\n\n**Category Organization**:\n- Group categories in expandable sections (Accordion pattern)\n- Each category row: Label (left) + Input (right) in 2-column grid\n- Visual hierarchy: Main categories (bold) → Subcategories (indented pl-4)\n\n**Action Buttons**:\n- Primary: \"Salvar Benchmarks\" - filled green button\n- Secondary: \"Cancelar\" - outline button with subtle border\n- Tertiary: \"Restaurar Padrões\" - text button, left-aligned\n- Button size: px-6 py-2.5\n\n### E. Interactive States\n- Input Focus: Ring-2 ring-primary-green with smooth transition\n- Validation States: \n  - Valid: Subtle green checkmark icon (right-side)\n  - Invalid: Red border + error message below\n  - Warning: Amber icon for unusual values (>80% or <5%)\n- Hover States: Subtle background lift on input fields (bg-opacity change)\n- Loading: Skeleton states for category lists\n\n## Special Features\n\n**Smart Defaults**:\n- Pre-filled industry-standard percentages\n- \"Copiar de...\" dropdown to clone from existing categories\n- Bulk edit mode toggle for applying same % to multiple categories\n\n**Data Visualization**:\n- Small inline sparkline/bar indicator showing benchmark range\n- Color-coded percentage ranges (Low: <20%, Medium: 20-50%, High: >50%)\n\n**Accessibility**:\n- Tab navigation flows logically through categories\n- Escape key closes modal with confirmation if changed\n- Clear focus indicators with 2px ring\n- ARIA labels for percentage inputs with category context\n\n## Layout Specifications\n\n**Header Section**:\n- Title + subtitle describing benchmark purpose\n- Quick stats: \"X categorias configuradas\" badge\n- Icon: Chart/benchmark icon in primary green\n\n**Body Grid Pattern**:\n```\n[Category Icon] [Category Name]          [Input Field %]\n                [Subcategory]            [Input Field %]\n                [Subcategory]            [Input Field %]\n```\n- Use grid-cols-[auto_1fr_140px] for alignment\n- Dividers between major category groups\n\n**Footer Actions**:\n- Left: \"Restaurar Padrões\" text button\n- Right: \"Cancelar\" + \"Salvar\" button group\n- Save button disabled until valid changes made\n\n## Micro-Interactions\n- Smooth modal entrance: scale-95 to scale-100 + opacity fade (200ms)\n- Input field expand on focus: subtle scale effect\n- Success state: Brief green flash on save completion\n- Category accordion: Rotate chevron icon with transition\n\nThis modal integrates seamlessly with the existing agricultural management system while providing efficient, professional benchmark configuration capabilities.","size_bytes":4693},"client/src/components/dashboard/commission-table.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Settings } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { Category } from \"@shared/schema\";\n\nexport default function CommissionTable() {\n  const { data: categories, isLoading } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const getBadgeClass = (tier: string) => {\n    switch (tier) {\n      case 'verde': return 'badge-verde';\n      case 'amarela': return 'badge-amarela';\n      case 'vermelha': return 'badge-vermelha';\n      default: return 'badge-verde';\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <Card className=\"shadow-sm\">\n        <CardContent className=\"p-6\">\n          <div className=\"animate-pulse space-y-4\">\n            <div className=\"h-4 bg-gray-200 rounded w-1/4\"></div>\n            <div className=\"space-y-2\">\n              {[...Array(7)].map((_, i) => (\n                <div key={i} className=\"h-12 bg-gray-200 rounded\"></div>\n              ))}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className=\"shadow-sm\" data-testid=\"commission-table\">\n      <CardHeader className=\"flex items-center justify-between\">\n        <CardTitle className=\"text-lg font-bold\">Tabela de Comissões</CardTitle>\n        <Button variant=\"outline\" size=\"sm\">\n          <Settings className=\"h-4 w-4 mr-2\" />\n          Configurar\n        </Button>\n      </CardHeader>\n      <CardContent>\n        <div className=\"overflow-x-auto\">\n          <table className=\"w-full text-sm\">\n            <thead>\n              <tr className=\"border-b border-border\">\n                <th className=\"text-left py-3 px-2 text-xs font-semibold text-muted-foreground uppercase\">Categoria</th>\n                <th className=\"text-center py-3 px-2 text-xs font-semibold text-muted-foreground uppercase\">Verde</th>\n                <th className=\"text-center py-3 px-2 text-xs font-semibold text-muted-foreground uppercase\">Margem</th>\n                <th className=\"text-center py-3 px-2 text-xs font-semibold text-muted-foreground uppercase\">Amarela</th>\n                <th className=\"text-center py-3 px-2 text-xs font-semibold text-muted-foreground uppercase\">Margem</th>\n                <th className=\"text-center py-3 px-2 text-xs font-semibold text-muted-foreground uppercase\">Vermelha</th>\n                <th className=\"text-center py-3 px-2 text-xs font-semibold text-muted-foreground uppercase\">Margem</th>\n              </tr>\n            </thead>\n            <tbody>\n              {categories?.map((category) => (\n                <tr \n                  key={category.id} \n                  className=\"border-b border-border hover:bg-muted/30 transition-colors\"\n                  data-testid={`commission-row-${category.id}`}\n                >\n                  <td className=\"py-3 px-2 font-medium text-foreground\">{category.name}</td>\n                  <td className=\"py-3 px-2 text-center\">\n                    <Badge className=\"badge-verde text-xs font-mono\">\n                      {parseFloat(category.greenCommission).toFixed(2)}%\n                    </Badge>\n                  </td>\n                  <td className=\"py-3 px-2 text-center text-xs text-muted-foreground\">\n                    &gt;{parseFloat(category.greenMarginMin).toFixed(0)}%\n                  </td>\n                  <td className=\"py-3 px-2 text-center\">\n                    <Badge className=\"badge-amarela text-xs font-mono\">\n                      {parseFloat(category.yellowCommission).toFixed(2)}%\n                    </Badge>\n                  </td>\n                  <td className=\"py-3 px-2 text-center text-xs text-muted-foreground\">\n                    {parseFloat(category.yellowMarginMin).toFixed(0)}-{parseFloat(category.yellowMarginMax).toFixed(2)}%\n                  </td>\n                  <td className=\"py-3 px-2 text-center\">\n                    <Badge className=\"badge-vermelha text-xs font-mono\">\n                      {parseFloat(category.redCommission).toFixed(2)}%\n                    </Badge>\n                  </td>\n                  <td className=\"py-3 px-2 text-center text-xs text-muted-foreground\">\n                    {parseFloat(category.redMarginMin).toFixed(0)}-{parseFloat(category.redMarginMax).toFixed(2)}%\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":4570},"client/src/components/modals/edit-sale-modal.tsx":{"content":"import { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useState, useEffect } from \"react\";\nimport { calculateCommission } from \"@/lib/commissions\";\nimport { classifySeason } from \"@/lib/seasons\";\nimport type { Category, Client, Sale, Product } from \"@shared/schema\";\n\ninterface EditSaleModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  sale: Sale | null;\n}\n\nexport default function EditSaleModal({ isOpen, onClose, sale }: EditSaleModalProps) {\n  const { toast } = useToast();\n  const [formData, setFormData] = useState({\n    clientId: \"\",\n    categoryId: \"\",\n    productId: \"\",\n    productName: \"\",\n    totalAmount: \"\",\n    margin: \"\",\n    dueDate: \"\",\n    ivaRate: \"10.00\",\n  });\n  \n  const [commission, setCommission] = useState({\n    tier: \"\",\n    rate: 0,\n    amount: 0,\n    season: \"\",\n  });\n\n  const { data: categories } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const { data: clients } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: products } = useQuery<Product[]>({\n    queryKey: [\"/api/products\"],\n  });\n\n  useEffect(() => {\n    if (sale && isOpen && products) {\n      const product = products?.find(p => p.id === sale.productId);\n      const dueDate = new Date(sale.dueDate);\n      const dueDateString = dueDate.toISOString().split('T')[0];\n      \n      setFormData({\n        clientId: sale.clientId,\n        categoryId: sale.categoryId,\n        productId: sale.productId,\n        productName: product?.name || \"Produto manual\",\n        totalAmount: `${sale.totalAmount}`,\n        margin: `${sale.margin}`,\n        dueDate: dueDateString,\n        ivaRate: `${sale.ivaRate || '10.00'}`,\n      });\n    }\n  }, [sale, isOpen, products]);\n\n  const updateSaleMutation = useMutation({\n    mutationFn: async (saleData: any) => {\n      return apiRequest(\"PATCH\", `/api/sales/${sale?.id}`, saleData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/sales\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/analytics/sales\"] });\n      toast({\n        title: \"Venda atualizada\",\n        description: \"A venda foi atualizada com sucesso.\",\n      });\n      onClose();\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao atualizar a venda. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  useEffect(() => {\n    if (formData.categoryId && formData.margin && formData.totalAmount && formData.dueDate) {\n      const category = categories?.find(c => c.id === formData.categoryId);\n      if (category) {\n        const commissionCalc = calculateCommission(category, parseFloat(formData.margin));\n        const seasonName = classifySeason(new Date(formData.dueDate));\n        const totalAmountNum = parseFloat(formData.totalAmount);\n        const ivaRateNum = parseFloat(formData.ivaRate);\n        const amountBeforeIva = totalAmountNum / (1 + ivaRateNum / 100);\n        const amount = amountBeforeIva * (commissionCalc.rate / 100);\n        \n        setCommission({\n          tier: commissionCalc.tier,\n          rate: commissionCalc.rate,\n          amount,\n          season: seasonName,\n        });\n      }\n    }\n  }, [formData.categoryId, formData.margin, formData.totalAmount, formData.dueDate, formData.ivaRate, categories]);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!formData.clientId || !formData.categoryId || !formData.totalAmount || \n        !formData.margin || !formData.dueDate) {\n      toast({\n        title: \"Campos obrigatórios\",\n        description: \"Preencha todos os campos obrigatórios.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const saleData = {\n      clientId: formData.clientId,\n      categoryId: formData.categoryId,\n      productId: sale!.productId,\n      seasonId: sale!.seasonId,\n      saleDate: sale!.saleDate,\n      totalAmount: formData.totalAmount,\n      margin: formData.margin,\n      dueDate: formData.dueDate,\n      ivaRate: formData.ivaRate,\n      commissionRate: commission.rate.toString(),\n      commissionAmount: commission.amount.toString(),\n      commissionTier: commission.tier,\n    };\n\n    updateSaleMutation.mutate(saleData);\n  };\n\n  const getTierBadgeClass = (tier: string) => {\n    switch (tier) {\n      case 'verde': return 'badge-verde';\n      case 'amarela': return 'badge-amarela';\n      case 'vermelha': return 'badge-vermelha';\n      default: return 'badge-verde';\n    }\n  };\n\n  const getTierColor = (tier: string) => {\n    switch (tier) {\n      case 'verde': return 'text-verde';\n      case 'amarela': return 'text-amarela';\n      case 'vermelha': return 'text-vermelha';\n      default: return 'text-verde';\n    }\n  };\n\n  if (!sale) return null;\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\" data-testid=\"edit-sale-modal\">\n        <DialogHeader>\n          <DialogTitle className=\"text-xl font-bold\">Editar Venda</DialogTitle>\n          <p className=\"text-sm text-muted-foreground\">\n            Atualize os dados da venda com recálculo automático de comissão\n          </p>\n        </DialogHeader>\n\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"client\">Cliente</Label>\n              <Select value={formData.clientId} onValueChange={(value) => \n                setFormData(prev => ({ ...prev, clientId: value }))\n              }>\n                <SelectTrigger data-testid=\"select-client\">\n                  <SelectValue placeholder=\"Selecione o cliente...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {clients?.map((client) => (\n                    <SelectItem key={client.id} value={client.id}>\n                      {client.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label htmlFor=\"product\">Produto</Label>\n              <Input \n                value={formData.productName}\n                readOnly \n                className=\"bg-muted text-muted-foreground cursor-not-allowed\"\n                data-testid=\"input-product-name\"\n              />\n            </div>\n          </div>\n\n          <Card className=\"bg-muted/30\">\n            <CardHeader>\n              <CardTitle className=\"text-sm\">Informações da Venda</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"category\">Categoria</Label>\n                  <Select value={formData.categoryId} onValueChange={(value) => \n                    setFormData(prev => ({ ...prev, categoryId: value }))\n                  }>\n                    <SelectTrigger data-testid=\"select-category\">\n                      <SelectValue placeholder=\"Selecione a categoria...\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {categories?.map((category) => (\n                        <SelectItem key={category.id} value={category.id}>\n                          {category.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div>\n                  <Label htmlFor=\"totalAmount\">Valor Total (USD)</Label>\n                  <Input \n                    type=\"number\" \n                    step=\"0.01\"\n                    placeholder=\"0.00\" \n                    value={formData.totalAmount}\n                    onChange={(e) => setFormData(prev => ({ ...prev, totalAmount: e.target.value }))}\n                    className=\"font-mono\"\n                    data-testid=\"input-total-amount\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"margin\">Margem (%)</Label>\n                  <Input \n                    type=\"number\" \n                    step=\"0.01\"\n                    placeholder=\"0.00\" \n                    value={formData.margin}\n                    onChange={(e) => setFormData(prev => ({ ...prev, margin: e.target.value }))}\n                    className=\"font-mono\"\n                    data-testid=\"input-margin\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"iva\">IVA Paraguai (%)</Label>\n                  <Input \n                    type=\"number\" \n                    step=\"0.01\"\n                    value={formData.ivaRate}\n                    onChange={(e) => setFormData(prev => ({ ...prev, ivaRate: e.target.value }))}\n                    className=\"font-mono\"\n                    data-testid=\"input-iva\"\n                  />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"dueDate\">Data de Vencimento</Label>\n              <Input \n                type=\"date\" \n                value={formData.dueDate}\n                onChange={(e) => setFormData(prev => ({ ...prev, dueDate: e.target.value }))}\n                data-testid=\"input-due-date\"\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"season\">Safra (Auto)</Label>\n              <Input \n                value={commission.season}\n                readOnly \n                className=\"bg-muted text-muted-foreground cursor-not-allowed font-mono\"\n                data-testid=\"input-season\"\n              />\n            </div>\n          </div>\n\n          {commission.tier && (\n            <Card className=\"bg-primary/5\">\n              <CardHeader>\n                <CardTitle className=\"text-sm\">Prévia de Comissão</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Faixa de Comissão</p>\n                    <Badge className={`${getTierBadgeClass(commission.tier)} text-sm font-medium capitalize`}>\n                      {commission.tier}\n                    </Badge>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Taxa de Comissão</p>\n                    <p className=\"text-lg font-bold text-foreground font-mono\">\n                      {commission.rate.toFixed(2)}%\n                    </p>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Valor da Comissão (USD)</p>\n                    <p className={`text-lg font-bold font-mono ${getTierColor(commission.tier)}`}>\n                      ${commission.amount.toFixed(2)}\n                    </p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          <div className=\"flex items-center justify-end gap-3 pt-4\">\n            <Button type=\"button\" variant=\"outline\" onClick={onClose} data-testid=\"button-cancel\">\n              Cancelar\n            </Button>\n            <Button \n              type=\"submit\" \n              disabled={updateSaleMutation.isPending}\n              data-testid=\"button-save\"\n            >\n              {updateSaleMutation.isPending ? \"Salvando...\" : \"Salvar Alterações\"}\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":12229},"client/src/components/modals/import-pdf-modal.tsx":{"content":"import { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { FileText, Upload, Loader2 } from \"lucide-react\";\nimport { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ninterface ImportPDFModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n}\n\nexport default function ImportPDFModal({ isOpen, onClose }: ImportPDFModalProps) {\n  const { toast } = useToast();\n  const [isProcessing, setIsProcessing] = useState(false);\n  const [extractedData, setExtractedData] = useState<any>(null);\n  const [selectedSeasonId, setSelectedSeasonId] = useState<string>(\"\");\n\n  const { data: seasons } = useQuery<{ id: string; name: string }[]>({\n    queryKey: [\"/api/seasons\"],\n  });\n\n  const handleFileSelect = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    if (!selectedSeasonId) {\n      toast({\n        title: \"Safra não selecionada\",\n        description: \"Por favor, selecione uma safra antes de fazer o upload.\",\n        variant: \"destructive\",\n      });\n      event.target.value = '';\n      return;\n    }\n\n    if (file.type !== \"application/pdf\") {\n      toast({\n        title: \"Tipo de arquivo inválido\",\n        description: \"Por favor, selecione um arquivo PDF.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsProcessing(true);\n\n    // Simulate PDF processing\n    setTimeout(() => {\n      setExtractedData({\n        client: \"Agro Santa Rita\",\n        productsFound: 5,\n        totalValue: 48250.00,\n        dueDate: \"30/03/2026\",\n        seasonDetected: \"Soja 25/26\",\n      });\n      setIsProcessing(false);\n    }, 3000);\n  };\n\n  const handleImport = async () => {\n    if (!extractedData) return;\n\n    // Here you would normally send the extracted data to your backend\n    toast({\n      title: \"Dados importados\",\n      description: \"Os dados do PDF foram importados com sucesso.\",\n    });\n    \n    onClose();\n    setExtractedData(null);\n  };\n\n  const handleClose = () => {\n    onClose();\n    setExtractedData(null);\n    setIsProcessing(false);\n    setSelectedSeasonId(\"\");\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={handleClose}>\n      <DialogContent className=\"max-w-2xl\" data-testid=\"import-pdf-modal\">\n        <DialogHeader>\n          <DialogTitle className=\"text-xl font-bold\">Importar PDF de Vendas</DialogTitle>\n          <p className=\"text-sm text-muted-foreground\">\n            Extraia automaticamente dados de cliente, produtos e valores\n          </p>\n        </DialogHeader>\n\n        <div className=\"space-y-6\">\n          {/* Season Selection */}\n          <div className=\"space-y-2\">\n            <label htmlFor=\"season-select-pdf\" className=\"text-sm font-medium text-foreground\">\n              Safra <span className=\"text-red-500\">*</span>\n            </label>\n            <Select value={selectedSeasonId} onValueChange={setSelectedSeasonId}>\n              <SelectTrigger id=\"season-select-pdf\" data-testid=\"select-season-pdf\">\n                <SelectValue placeholder=\"Selecione a safra...\" />\n              </SelectTrigger>\n              <SelectContent>\n                {seasons?.map((season) => (\n                  <SelectItem key={season.id} value={season.id}>\n                    {season.name}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n            <p className=\"text-xs text-muted-foreground\">\n              Todas as vendas extraídas do PDF serão atribuídas à safra selecionada.\n            </p>\n          </div>\n\n          {/* File Upload Area */}\n          <div className=\"border-2 border-dashed border-border rounded-lg p-8 text-center hover:border-primary transition-colors\">\n            <div className=\"flex flex-col items-center gap-3\">\n              <div className=\"w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center\">\n                <FileText className=\"text-primary text-2xl\" size={32} />\n              </div>\n              <div>\n                <p className=\"text-sm font-medium text-foreground mb-1\">\n                  Arraste o PDF aqui ou clique para selecionar\n                </p>\n                <p className=\"text-xs text-muted-foreground\">\n                  Suporta: Relación de Pedidos, Facturas, etc.\n                </p>\n              </div>\n              <div>\n                <input\n                  type=\"file\"\n                  accept=\".pdf\"\n                  onChange={handleFileSelect}\n                  className=\"hidden\"\n                  id=\"pdf-upload\"\n                  data-testid=\"file-input\"\n                />\n                <label htmlFor=\"pdf-upload\">\n                  <Button asChild data-testid=\"button-select-file\">\n                    <span className=\"cursor-pointer\">\n                      <Upload className=\"h-4 w-4 mr-2\" />\n                      Selecionar Arquivo\n                    </span>\n                  </Button>\n                </label>\n              </div>\n            </div>\n          </div>\n\n          {/* Processing Status */}\n          {isProcessing && (\n            <Card className=\"bg-muted\">\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center gap-3\">\n                  <Loader2 className=\"animate-spin text-primary\" size={20} />\n                  <div className=\"flex-1\">\n                    <p className=\"text-sm font-medium text-foreground\">Processando PDF...</p>\n                    <p className=\"text-xs text-muted-foreground\">Extraindo informações de vendas</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Extracted Data Preview */}\n          {extractedData && (\n            <Card data-testid=\"extracted-data\">\n              <CardContent className=\"p-4\">\n                <h3 className=\"text-sm font-semibold text-foreground mb-3\">Dados Extraídos</h3>\n                <div className=\"border border-border rounded-lg p-4 bg-muted/30 space-y-2 text-sm\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Cliente:</span>\n                    <span className=\"font-medium text-foreground\">{extractedData.client}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Produtos encontrados:</span>\n                    <span className=\"font-medium text-foreground\">{extractedData.productsFound} itens</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Valor Total (USD):</span>\n                    <span className=\"font-medium text-foreground font-mono\">\n                      ${extractedData.totalValue.toLocaleString()}\n                    </span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Data Vencimento:</span>\n                    <span className=\"font-medium text-foreground\">{extractedData.dueDate}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-muted-foreground\">Safra Detectada:</span>\n                    <span className=\"font-medium text-foreground font-mono\">{extractedData.seasonDetected}</span>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Actions */}\n          <div className=\"flex items-center justify-end gap-3\">\n            <Button variant=\"outline\" onClick={handleClose} data-testid=\"button-cancel\">\n              Cancelar\n            </Button>\n            <Button \n              onClick={handleImport}\n              disabled={!extractedData}\n              data-testid=\"button-import\"\n            >\n              Importar Dados\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":8297},"client/src/pages/auth-page.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { useLocation, Link } from \"wouter\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Sprout, Zap, BarChart3, TrendingUp } from \"lucide-react\";\n\nexport default function AuthPage() {\n  const [isLogin, setIsLogin] = useState(true);\n  const [username, setUsername] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [name, setName] = useState(\"\");\n  const [role, setRole] = useState(\"consultor\");\n  const { user, loginMutation, registerMutation } = useAuth();\n  const [, setLocation] = useLocation();\n\n  // Query system settings to check if registration is allowed\n  const { data: systemSettings, isLoading: isLoadingSettings } = useQuery<{ allowUserRegistration: boolean }>({\n    queryKey: ['/api/system-settings'],\n  });\n\n  // Only allow registration if explicitly enabled by system settings\n  // Default to false (disabled) until we get a definitive response from the API\n  const isRegistrationAllowed = systemSettings?.allowUserRegistration === true;\n\n  useEffect(() => {\n    if (user) {\n      // Redirecionar baseado no role\n      if (user.role === 'administrador') {\n        setLocation(\"/admin\");\n      } else if (user.role === 'gerente') {\n        setLocation(\"/manager\");\n      } else if (user.role === 'faturista') {\n        setLocation(\"/faturista\");\n      } else {\n        setLocation(\"/dashboard\");\n      }\n    }\n  }, [user, setLocation]);\n\n  // Se o cadastro for desabilitado enquanto o usuário está na tela de cadastro, redirecionar para login\n  useEffect(() => {\n    if (!isLogin && !isRegistrationAllowed) {\n      setIsLogin(true);\n    }\n  }, [isRegistrationAllowed, isLogin]);\n\n  const handleSubmit = (e: React.FormEvent) => {\n    e.preventDefault();\n    if (isLogin) {\n      loginMutation.mutate({ username, password });\n    } else {\n      registerMutation.mutate({ username, password, name, role });\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen grid lg:grid-cols-2\" data-testid=\"auth-page\">\n      {/* Left - Form Section */}\n      <div className=\"flex items-center justify-center p-8 bg-background\">\n        <Card className=\"w-full max-w-md border-0 shadow-2xl\">\n          <CardContent className=\"pt-8 pb-8\">\n            {/* Logo */}\n            <div className=\"flex items-center justify-center mb-8\">\n              <div className=\"w-16 h-16 bg-[#F7D601] rounded-2xl flex items-center justify-center shadow-lg\">\n                <Sprout className=\"text-green-600 text-3xl\" size={36} />\n              </div>\n            </div>\n\n            {/* Title */}\n            <div className=\"text-center mb-8\">\n              <h1 className=\"text-3xl font-bold bg-gradient-to-r from-green-600 to-green-500 bg-clip-text text-transparent mb-2\">\n                Agro Farm Digital\n              </h1>\n              <p className=\"text-muted-foreground\">\n                {isLogin ? \"Bem-vindo de volta\" : \"Comece sua jornada digital\"}\n              </p>\n            </div>\n\n            {/* Form */}\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              {!isLogin && (\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"name\">Nome Completo</Label>\n                  <Input\n                    id=\"name\"\n                    type=\"text\"\n                    value={name}\n                    onChange={(e) => setName(e.target.value)}\n                    placeholder=\"Seu nome\"\n                    required\n                    data-testid=\"input-name\"\n                    className=\"h-12\"\n                  />\n                </div>\n              )}\n              \n              <div className=\"space-y-2\">\n                <Label htmlFor=\"username\">Usuário</Label>\n                <Input\n                  id=\"username\"\n                  type=\"text\"\n                  value={username}\n                  onChange={(e) => setUsername(e.target.value)}\n                  placeholder=\"seu.usuario\"\n                  required\n                  data-testid=\"input-username\"\n                  className=\"h-12\"\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <Label htmlFor=\"password\">Senha</Label>\n                  {isLogin && (\n                    <Link href=\"/forgot-password\">\n                      <a className=\"text-sm text-green-600 hover:text-green-700 transition-colors\" data-testid=\"link-forgot-password\">\n                        Esqueci minha senha\n                      </a>\n                    </Link>\n                  )}\n                </div>\n                <Input\n                  id=\"password\"\n                  type=\"password\"\n                  value={password}\n                  onChange={(e) => setPassword(e.target.value)}\n                  placeholder=\"••••••••\"\n                  required\n                  data-testid=\"input-password\"\n                  className=\"h-12\"\n                />\n              </div>\n\n              {!isLogin && (\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"role\">Função</Label>\n                  <Select value={role} onValueChange={setRole}>\n                    <SelectTrigger className=\"h-12\" data-testid=\"select-role\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"consultor\">Consultor</SelectItem>\n                      <SelectItem value=\"gerente\">Gerentes</SelectItem>\n                      <SelectItem value=\"administrador\">Administradores</SelectItem>\n                      <SelectItem value=\"faturista\">Faturista</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              )}\n\n              <Button\n                type=\"submit\"\n                className=\"w-full h-12 bg-gradient-to-r from-green-600 to-green-500 hover:from-green-700 hover:to-green-600 text-white font-semibold shadow-lg\"\n                disabled={loginMutation.isPending || registerMutation.isPending}\n                data-testid={isLogin ? \"button-login\" : \"button-register\"}\n              >\n                {(loginMutation.isPending || registerMutation.isPending) ? (\n                  <span className=\"flex items-center gap-2\">\n                    <div className=\"animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full\" />\n                    Aguarde...\n                  </span>\n                ) : isLogin ? (\n                  \"Entrar\"\n                ) : (\n                  \"Criar Conta\"\n                )}\n              </Button>\n            </form>\n\n            {/* Toggle */}\n            {isRegistrationAllowed && (\n              <div className=\"mt-6 text-center\">\n                <button\n                  type=\"button\"\n                  onClick={() => setIsLogin(!isLogin)}\n                  className=\"text-sm text-muted-foreground hover:text-green-600 transition-colors\"\n                  data-testid=\"toggle-auth-mode\"\n                >\n                  {isLogin ? (\n                    <>\n                      Não tem uma conta? <span className=\"font-semibold text-green-600\">Cadastre-se</span>\n                    </>\n                  ) : (\n                    <>\n                      Já tem uma conta? <span className=\"font-semibold text-green-600\">Faça login</span>\n                    </>\n                  )}\n                </button>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Right - Hero Section */}\n      <div className=\"hidden lg:flex flex-col items-center justify-center p-12 bg-gradient-to-br from-green-600 via-green-500 to-emerald-500 text-white relative overflow-hidden\">\n        {/* Background Pattern */}\n        <div className=\"absolute inset-0 opacity-10\">\n          <div className=\"absolute top-0 left-0 w-96 h-96 bg-white rounded-full blur-3xl\" />\n          <div className=\"absolute bottom-0 right-0 w-96 h-96 bg-white rounded-full blur-3xl\" />\n        </div>\n\n        {/* Content */}\n        <div className=\"relative z-10 max-w-lg\">\n          <div className=\"mb-8\">\n            <div className=\"inline-flex items-center gap-2 px-4 py-2 bg-white/20 backdrop-blur-sm rounded-full mb-6\">\n              <Zap className=\"w-4 h-4\" />\n              <span className=\"text-sm font-medium\">Digital para o Campo</span>\n            </div>\n            \n            <h2 className=\"text-5xl font-bold mb-4 leading-tight\">\n              Transforme suas vendas agrícolas\n            </h2>\n            <p className=\"text-lg text-green-50 mb-8\">\n              Gerencie comissões, acompanhe metas e analise seu desempenho com tecnologia de ponta desenvolvida para o agronegócio.\n            </p>\n          </div>\n\n          {/* Features */}\n          <div className=\"space-y-4\">\n            <div className=\"flex items-start gap-4 p-4 bg-white/10 backdrop-blur-sm rounded-xl\">\n              <div className=\"w-10 h-10 bg-[#F7D601] rounded-lg flex items-center justify-center flex-shrink-0\">\n                <BarChart3 className=\"w-5 h-5 text-green-600\" />\n              </div>\n              <div>\n                <h3 className=\"font-semibold mb-1\">Análise Inteligente</h3>\n                <p className=\"text-sm text-green-50\">\n                  Dashboard completo com insights sobre suas vendas e comissões\n                </p>\n              </div>\n            </div>\n\n            <div className=\"flex items-start gap-4 p-4 bg-white/10 backdrop-blur-sm rounded-xl\">\n              <div className=\"w-10 h-10 bg-[#F7D601] rounded-lg flex items-center justify-center flex-shrink-0\">\n                <TrendingUp className=\"w-5 h-5 text-green-600\" />\n              </div>\n              <div>\n                <h3 className=\"font-semibold mb-1\">Metas & Performance</h3>\n                <p className=\"text-sm text-green-50\">\n                  Acompanhe metas por safra e categorias de produtos\n                </p>\n              </div>\n            </div>\n\n            <div className=\"flex items-start gap-4 p-4 bg-white/10 backdrop-blur-sm rounded-xl\">\n              <div className=\"w-10 h-10 bg-[#F7D601] rounded-lg flex items-center justify-center flex-shrink-0\">\n                <Sprout className=\"w-5 h-5 text-green-600\" />\n              </div>\n              <div>\n                <h3 className=\"font-semibold mb-1\">Mercado Agrícola</h3>\n                <p className=\"text-sm text-green-50\">\n                  Análise de penetração de mercado e oportunidades comerciais\n                </p>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":11044},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","size_bytes":1858},"server/db.ts":{"content":"import { drizzle } from 'drizzle-orm/neon-serverless';\nimport { Pool, neonConfig } from '@neondatabase/serverless';\nimport ws from 'ws';\nimport * as schema from '@shared/schema';\n\nneonConfig.webSocketConstructor = ws;\n\nif (!process.env.DATABASE_URL) {\n  throw new Error('DATABASE_URL environment variable is not set');\n}\n\nexport const pool = new Pool({ connectionString: process.env.DATABASE_URL });\nexport const db = drizzle(pool, { schema });\n","size_bytes":445},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok && res.status !== 304) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: 5 * 60 * 1000, // 5 minutes instead of Infinity for security\n      gcTime: 10 * 60 * 1000, // 10 minutes (garbage collection time, formerly cacheTime)\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","size_bytes":1546},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","size_bytes":157},"client/src/pages/importar.tsx":{"content":"import Sidebar from \"@/components/layout/sidebar\";\nimport Header from \"@/components/layout/header\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { useState, useCallback } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { FileText, Upload, CheckCircle, XCircle, AlertCircle, Download, RefreshCw } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { useDropzone } from \"react-dropzone\";\n\ninterface ImportedFile {\n  id: string;\n  fileName: string;\n  fileSize: number;\n  uploadDate: Date;\n  status: \"processing\" | \"completed\" | \"error\";\n  extractedData?: {\n    client: string;\n    productsCount: number;\n    totalValue: number;\n    dueDate: string;\n    season: string;\n  };\n  errorMessage?: string;\n}\n\nexport default function Importar() {\n  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);\n  const [uploadingFiles, setUploadingFiles] = useState<File[]>([]);\n  const [importHistory, setImportHistory] = useState<ImportedFile[]>([]);\n  const { toast } = useToast();\n\n  const { data: clients } = useQuery({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: seasons } = useQuery({\n    queryKey: [\"/api/seasons\"],\n  });\n\n  const toggleSidebar = () => {\n    setSidebarCollapsed(!sidebarCollapsed);\n  };\n\n  const onDrop = useCallback((acceptedFiles: File[]) => {\n    const pdfFiles = acceptedFiles.filter(file => file.type === \"application/pdf\");\n    \n    if (pdfFiles.length !== acceptedFiles.length) {\n      toast({\n        title: \"Arquivos rejeitados\",\n        description: \"Apenas arquivos PDF são aceitos.\",\n        variant: \"destructive\",\n      });\n    }\n\n    if (pdfFiles.length === 0) return;\n\n    setUploadingFiles(pdfFiles);\n\n    // Simulate PDF processing\n    pdfFiles.forEach((file, index) => {\n      const importedFile: ImportedFile = {\n        id: `import-${Date.now()}-${index}`,\n        fileName: file.name,\n        fileSize: file.size,\n        uploadDate: new Date(),\n        status: \"processing\",\n      };\n\n      setImportHistory(prev => [importedFile, ...prev]);\n\n      // Simulate processing delay\n      setTimeout(() => {\n        const isSuccess = Math.random() > 0.2; // 80% success rate for demo\n        \n        if (isSuccess) {\n          const extractedData = {\n            client: \"Agro Santa Rita\",\n            productsCount: Math.floor(Math.random() * 10) + 1,\n            totalValue: Math.random() * 100000 + 10000,\n            dueDate: \"30/03/2026\",\n            season: \"Soja 25/26\",\n          };\n\n          setImportHistory(prev => \n            prev.map(item => \n              item.id === importedFile.id \n                ? { ...item, status: \"completed\" as const, extractedData }\n                : item\n            )\n          );\n\n          toast({\n            title: \"PDF processado\",\n            description: `${file.name} foi processado com sucesso.`,\n          });\n        } else {\n          setImportHistory(prev => \n            prev.map(item => \n              item.id === importedFile.id \n                ? { ...item, status: \"error\" as const, errorMessage: \"Erro ao extrair dados do PDF\" }\n                : item\n            )\n          );\n\n          toast({\n            title: \"Erro no processamento\",\n            description: `Falha ao processar ${file.name}.`,\n            variant: \"destructive\",\n          });\n        }\n      }, 2000 + index * 1000);\n    });\n\n    setUploadingFiles([]);\n  }, [toast]);\n\n  const { getRootProps, getInputProps, isDragActive } = useDropzone({\n    onDrop,\n    accept: {\n      'application/pdf': ['.pdf']\n    },\n    multiple: true\n  });\n\n  const getStatusIcon = (status: ImportedFile[\"status\"]) => {\n    switch (status) {\n      case \"processing\":\n        return <RefreshCw className=\"h-4 w-4 text-chart-2 animate-spin\" />;\n      case \"completed\":\n        return <CheckCircle className=\"h-4 w-4 text-verde\" />;\n      case \"error\":\n        return <XCircle className=\"h-4 w-4 text-vermelha\" />;\n    }\n  };\n\n  const getStatusBadge = (status: ImportedFile[\"status\"]) => {\n    switch (status) {\n      case \"processing\":\n        return <Badge className=\"bg-chart-2/10 text-chart-2\">Processando</Badge>;\n      case \"completed\":\n        return <Badge className=\"badge-verde\">Concluído</Badge>;\n      case \"error\":\n        return <Badge className=\"badge-vermelha\">Erro</Badge>;\n    }\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n  };\n\n  const completedImports = importHistory.filter(item => item.status === \"completed\").length;\n  const failedImports = importHistory.filter(item => item.status === \"error\").length;\n  const processingImports = importHistory.filter(item => item.status === \"processing\").length;\n\n  return (\n    <div className=\"flex h-screen overflow-hidden\" data-testid=\"importar-container\">\n      <Sidebar collapsed={sidebarCollapsed} />\n      \n      <main className=\"flex-1 overflow-y-auto\">\n        <Header \n          onToggleSidebar={toggleSidebar}\n          onNewSale={() => {}}\n          title=\"Importação de PDFs\"\n          subtitle=\"Extração automática de dados de vendas\"\n        />\n\n        <div className=\"p-8\">\n          {/* Summary Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8\">\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center\">\n                    <FileText className=\"text-primary\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Total de Importações</p>\n                    <p className=\"text-2xl font-bold\">{importHistory.length}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-verde/10 rounded-lg flex items-center justify-center\">\n                    <CheckCircle className=\"text-verde\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Concluídas</p>\n                    <p className=\"text-2xl font-bold\">{completedImports}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                    <RefreshCw className=\"text-chart-2\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Processando</p>\n                    <p className=\"text-2xl font-bold\">{processingImports}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-vermelha/10 rounded-lg flex items-center justify-center\">\n                    <AlertCircle className=\"text-vermelha\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Com Erro</p>\n                    <p className=\"text-2xl font-bold\">{failedImports}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Upload Area */}\n          <Card className=\"shadow-sm mb-8\">\n            <CardHeader>\n              <CardTitle>Upload de PDFs</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div\n                {...getRootProps()}\n                className={`border-2 border-dashed rounded-lg p-12 text-center transition-colors cursor-pointer ${\n                  isDragActive \n                    ? \"border-primary bg-primary/5\" \n                    : \"border-border hover:border-primary hover:bg-muted/50\"\n                }`}\n                data-testid=\"pdf-upload-zone\"\n              >\n                <input {...getInputProps()} data-testid=\"pdf-file-input\" />\n                <div className=\"flex flex-col items-center gap-4\">\n                  <div className=\"w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center\">\n                    {uploadingFiles.length > 0 ? (\n                      <RefreshCw className=\"text-primary animate-spin\" size={32} />\n                    ) : (\n                      <Upload className=\"text-primary\" size={32} />\n                    )}\n                  </div>\n                  \n                  {uploadingFiles.length > 0 ? (\n                    <div>\n                      <p className=\"text-lg font-semibold text-foreground\">\n                        Enviando {uploadingFiles.length} arquivo(s)...\n                      </p>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Aguarde o processamento\n                      </p>\n                    </div>\n                  ) : isDragActive ? (\n                    <div>\n                      <p className=\"text-lg font-semibold text-foreground\">\n                        Solte os arquivos PDF aqui\n                      </p>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Para começar o processamento\n                      </p>\n                    </div>\n                  ) : (\n                    <div>\n                      <p className=\"text-lg font-semibold text-foreground\">\n                        Arraste PDFs aqui ou clique para selecionar\n                      </p>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Suporta: Relación de Pedidos, Facturas, Notas de Venta\n                      </p>\n                      <p className=\"text-xs text-muted-foreground mt-2\">\n                        Máximo 10MB por arquivo • Apenas arquivos PDF\n                      </p>\n                    </div>\n                  )}\n                  \n                  {uploadingFiles.length === 0 && (\n                    <Button className=\"mt-2\">\n                      <Upload className=\"h-4 w-4 mr-2\" />\n                      Selecionar Arquivos\n                    </Button>\n                  )}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Import History */}\n          <Card className=\"shadow-sm\">\n            <CardHeader className=\"flex flex-row items-center justify-between\">\n              <CardTitle>Histórico de Importações</CardTitle>\n              <Button variant=\"outline\" size=\"sm\" data-testid=\"button-export-history\">\n                <Download className=\"h-4 w-4 mr-2\" />\n                Exportar Histórico\n              </Button>\n            </CardHeader>\n            <CardContent>\n              {importHistory.length === 0 ? (\n                <div className=\"text-center py-12\">\n                  <FileText className=\"h-16 w-16 mx-auto text-muted-foreground mb-4\" />\n                  <p className=\"text-muted-foreground mb-4\">Nenhum arquivo foi importado ainda</p>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Use a área de upload acima para começar a processar PDFs\n                  </p>\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Arquivo</TableHead>\n                        <TableHead>Tamanho</TableHead>\n                        <TableHead>Data</TableHead>\n                        <TableHead>Status</TableHead>\n                        <TableHead>Cliente</TableHead>\n                        <TableHead>Produtos</TableHead>\n                        <TableHead className=\"text-right\">Valor (USD)</TableHead>\n                        <TableHead>Safra</TableHead>\n                        <TableHead className=\"text-center\">Ações</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {importHistory.map((item) => (\n                        <TableRow key={item.id} data-testid={`import-row-${item.id}`}>\n                          <TableCell>\n                            <div className=\"flex items-center gap-2\">\n                              {getStatusIcon(item.status)}\n                              <div>\n                                <p className=\"font-medium truncate max-w-48\" title={item.fileName}>\n                                  {item.fileName}\n                                </p>\n                                {item.errorMessage && (\n                                  <p className=\"text-xs text-vermelha\">{item.errorMessage}</p>\n                                )}\n                              </div>\n                            </div>\n                          </TableCell>\n                          <TableCell className=\"text-sm text-muted-foreground\">\n                            {formatFileSize(item.fileSize)}\n                          </TableCell>\n                          <TableCell className=\"text-sm\">\n                            {format(item.uploadDate, \"dd/MM/yyyy HH:mm\")}\n                          </TableCell>\n                          <TableCell>\n                            {getStatusBadge(item.status)}\n                          </TableCell>\n                          <TableCell>\n                            {item.extractedData?.client || \"-\"}\n                          </TableCell>\n                          <TableCell className=\"text-center\">\n                            {item.extractedData?.productsCount || \"-\"}\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            {item.extractedData?.totalValue \n                              ? `$${item.extractedData.totalValue.toLocaleString()}`\n                              : \"-\"\n                            }\n                          </TableCell>\n                          <TableCell>\n                            {item.extractedData?.season || \"-\"}\n                          </TableCell>\n                          <TableCell className=\"text-center\">\n                            {item.status === \"completed\" && (\n                              <div className=\"flex gap-1 justify-center\">\n                                <Button variant=\"ghost\" size=\"sm\" title=\"Ver detalhes\">\n                                  <FileText className=\"h-4 w-4\" />\n                                </Button>\n                                <Button variant=\"ghost\" size=\"sm\" title=\"Reimportar\">\n                                  <RefreshCw className=\"h-4 w-4\" />\n                                </Button>\n                              </div>\n                            )}\n                            {item.status === \"error\" && (\n                              <Button variant=\"ghost\" size=\"sm\" title=\"Tentar novamente\">\n                                <RefreshCw className=\"h-4 w-4\" />\n                              </Button>\n                            )}\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </main>\n    </div>\n  );\n}\n","size_bytes":16226},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","size_bytes":5742},"client/src/pages/mercado.tsx":{"content":"import { useState, useEffect, Fragment } from \"react\";\nimport Navbar from \"@/components/layout/navbar\";\nimport Header from \"@/components/layout/header\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Download, ChevronDown, ChevronRight, Settings, HelpCircle, Maximize2, X, Plus, Edit2, Check, Target, BarChart3 } from \"lucide-react\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\nimport { getValidCategoriesForSeason, getSeasonTypeFromName } from \"@/lib/seasons\";\nimport jsPDF from \"jspdf\";\nimport autoTable from \"jspdf-autotable\";\n\nconst AGROQUIMICOS_SUBCATEGORIES = ['Tratamento de semente', 'Dessecação', 'Inseticidas', 'Fungicidas'];\n\nexport default function Mercado() {\n  const [expandedClients, setExpandedClients] = useState<Set<string>>(new Set());\n  const [expandedCategories, setExpandedCategories] = useState<Set<string>>(new Set());\n  const [expandedSubcategories, setExpandedSubcategories] = useState<Set<string>>(new Set());\n  const [configClientId, setConfigClientId] = useState<string | null>(null);\n  const [selectedSeasonId, setSelectedSeasonId] = useState<string>(\"\");\n  const [rateValues, setRateValues] = useState<Record<string, string>>({});\n  const [subcategoryValues, setSubcategoryValues] = useState<Record<string, Record<string, string>>>({});\n  const [externalPurchaseValues, setExternalPurchaseValues] = useState<Record<string, string>>({});\n  const [externalSubcategoryValues, setExternalSubcategoryValues] = useState<Record<string, Record<string, string>>>({});\n  const [benchmarkValues, setBenchmarkValues] = useState<Record<string, string>>({});\n  const [isFullscreen, setIsFullscreen] = useState(false);\n  const [editingCell, setEditingCell] = useState<string | null>(null);\n  const [inlineExternalValue, setInlineExternalValue] = useState<string>(\"\");\n  const [inlineExternalCompany, setInlineExternalCompany] = useState<string>(\"\");\n  const [showMatrixDialog, setShowMatrixDialog] = useState(false);\n  const [showComparisonDialog, setShowComparisonDialog] = useState(false);\n  const { toast } = useToast();\n\n  // Query for seasons\n  const { data: seasons } = useQuery<Array<{\n    id: string;\n    name: string;\n    isActive: boolean;\n  }>>({\n    queryKey: [\"/api/seasons\"],\n  });\n\n  // Query for categories\n  const { data: categories } = useQuery<Array<{\n    id: string;\n    name: string;\n  }>>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  // Get active season for queries\n  const activeSeason = seasons?.find(s => s.isActive);\n\n  const { data: marketData, isLoading } = useQuery<{\n    clientAnalysis: Array<{\n      clientId: string;\n      clientName: string;\n      plantingArea: number;\n      totalPotential: number;\n      totalRealized: number;\n      totalPercentage: number;\n      categoryDetails: Record<string, {\n        categoryName: string;\n        potential: number;\n        cvaleAmount: number;\n        externalAmount: number;\n        externalCompany: string | null;\n        totalRealized: number;\n        opportunity: number;\n        isClosed: boolean;\n        percentage: number;\n        hasCustomRate: boolean;\n        subcategories: any;\n      }>;\n    }>;\n    benchmark: Record<string, number>;\n    opportunities: Array<{\n      clientId: string;\n      clientName: string;\n      categoryId: string;\n      categoryName: string;\n      clientPercentage: number;\n      marketPercentage: number;\n      gap: number;\n      potential: number;\n      realized: number;\n    }>;\n  }>({\n    queryKey: [\"/api/market-analysis\", activeSeason?.id],\n    queryFn: async () => {\n      const url = activeSeason?.id ? `/api/market-analysis?seasonId=${activeSeason.id}` : '/api/market-analysis';\n      const res = await fetch(url, { credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to fetch market analysis');\n      return res.json();\n    },\n    enabled: !!activeSeason?.id,\n  });\n\n  // Query for active season benchmarks\n  const { data: activeSeasonBenchmarks } = useQuery<Array<{\n    id: string;\n    categoryId: string;\n    seasonId: string;\n    marketPercentage: string;\n  }>>({\n    queryKey: [`/api/market-benchmarks/${activeSeason?.id}`],\n    enabled: !!activeSeason?.id,\n  });\n\n  const toggleClient = (clientId: string) => {\n    const newExpanded = new Set(expandedClients);\n    if (newExpanded.has(clientId)) {\n      newExpanded.delete(clientId);\n    } else {\n      newExpanded.add(clientId);\n    }\n    setExpandedClients(newExpanded);\n  };\n\n  const toggleCategory = (clientId: string, categoryId: string) => {\n    const key = `${clientId}-${categoryId}`;\n    const newExpanded = new Set(expandedCategories);\n    if (newExpanded.has(key)) {\n      newExpanded.delete(key);\n    } else {\n      newExpanded.add(key);\n    }\n    setExpandedCategories(newExpanded);\n  };\n\n  const toggleSubcategory = (clientId: string, categoryId: string, subcategoryId: string) => {\n    const key = `${clientId}-${categoryId}-${subcategoryId}`;\n    const newExpanded = new Set(expandedSubcategories);\n    if (newExpanded.has(key)) {\n      newExpanded.delete(key);\n    } else {\n      newExpanded.add(key);\n    }\n    setExpandedSubcategories(newExpanded);\n  };\n\n  // Query for client rates when config dialog opens\n  const { data: clientRates } = useQuery<Array<{\n    id: string;\n    clientId: string;\n    categoryId: string;\n    seasonId: string;\n    investmentPerHa: string;\n    subcategories: any;\n  }>>({\n    queryKey: [`/api/clients/${configClientId}/market-rates/${selectedSeasonId}`],\n    enabled: !!configClientId && !!selectedSeasonId,\n  });\n\n  // Query for external purchases when config dialog opens\n  const { data: externalPurchases } = useQuery<Array<{\n    id: string;\n    clientId: string;\n    categoryId: string;\n    seasonId: string;\n    amount: string;\n    subcategories: any;\n  }>>({\n    queryKey: [`/api/clients/${configClientId}/external-purchases/${selectedSeasonId}`],\n    enabled: !!configClientId && !!selectedSeasonId,\n  });\n\n  const saveRateMutation = useMutation({\n    mutationFn: async ({ clientId, categoryId, seasonId, investmentPerHa, subcategories }: { clientId: string; categoryId: string; seasonId: string; investmentPerHa: string; subcategories?: any }) => {\n      return apiRequest(\"POST\", `/api/clients/${clientId}/market-rates`, {\n        categoryId,\n        seasonId,\n        investmentPerHa,\n        subcategories: subcategories || null\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/market-analysis\"] });\n      queryClient.invalidateQueries({ queryKey: [`/api/clients/${configClientId}/market-rates/${selectedSeasonId}`] });\n      toast({\n        title: \"Configuração salva\",\n        description: \"Valores de investimento/ha atualizados com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao salvar configuração. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const saveExternalPurchaseMutation = useMutation({\n    mutationFn: async ({ clientId, categoryId, seasonId, amount, subcategories }: { clientId: string; categoryId: string; seasonId: string; amount: string; subcategories?: any }) => {\n      return apiRequest(\"POST\", `/api/external-purchases`, {\n        clientId,\n        categoryId,\n        seasonId,\n        amount,\n        subcategories: subcategories || null\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/market-analysis\"] });\n      queryClient.invalidateQueries({ queryKey: [`/api/clients/${configClientId}/external-purchases/${selectedSeasonId}`] });\n      toast({\n        title: \"Compra externa salva\",\n        description: \"Valor de compra externa registrado com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao salvar compra externa. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const saveInlineExternalPurchaseMutation = useMutation({\n    mutationFn: async ({ clientId, categoryId, seasonId, amount, company }: { clientId: string; categoryId: string; seasonId: string; amount: string; company?: string }) => {\n      return apiRequest(\"POST\", `/api/external-purchases`, {\n        clientId,\n        categoryId,\n        seasonId,\n        amount,\n        company: company || null,\n        subcategories: null\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/market-analysis\"] });\n      setEditingCell(null);\n      setInlineExternalValue(\"\");\n      setInlineExternalCompany(\"\");\n      toast({\n        title: \"Compra externa salva\",\n        description: \"Valor registrado com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao salvar. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n\n  const saveBenchmarkMutation = useMutation({\n    mutationFn: async ({ categoryId, seasonId, marketPercentage }: { categoryId: string; seasonId: string; marketPercentage: string }) => {\n      return apiRequest(\"POST\", `/api/market-benchmarks`, {\n        categoryId,\n        seasonId,\n        marketPercentage,\n      });\n    },\n    onSuccess: (_, variables) => {\n      queryClient.invalidateQueries({ queryKey: [`/api/market-benchmarks/${variables.seasonId}`] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/market-analysis\"] });\n      setBenchmarkValues({});\n      toast({\n        title: \"Benchmark salvo\",\n        description: \"Valor de benchmark atualizado com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao salvar benchmark. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Load existing subcategories when clientRates changes\n  useEffect(() => {\n    if (clientRates && configClientId) {\n      const subcats: Record<string, Record<string, string>> = {};\n      clientRates.forEach(rate => {\n        if (rate.subcategories) {\n          subcats[rate.categoryId] = rate.subcategories;\n        }\n      });\n      setSubcategoryValues(subcats);\n    }\n  }, [clientRates, configClientId]);\n\n  // Load existing external purchases when externalPurchases changes\n  useEffect(() => {\n    if (externalPurchases && configClientId) {\n      const subcats: Record<string, Record<string, string>> = {};\n      externalPurchases.forEach(purchase => {\n        if (purchase.subcategories) {\n          subcats[purchase.categoryId] = purchase.subcategories;\n        }\n      });\n      setExternalSubcategoryValues(subcats);\n    }\n  }, [externalPurchases, configClientId]);\n\n  const openConfigDialog = (clientId: string) => {\n    setConfigClientId(clientId);\n    setRateValues({});\n    setSubcategoryValues({});\n    setExternalPurchaseValues({});\n    setExternalSubcategoryValues({});\n    // Set active season by default\n    const activeSeason = seasons?.find(s => s.isActive);\n    if (activeSeason) {\n      setSelectedSeasonId(activeSeason.id);\n    }\n  };\n\n  const closeConfigDialog = () => {\n    setConfigClientId(null);\n    setRateValues({});\n    setSubcategoryValues({});\n    setExternalPurchaseValues({});\n    setExternalSubcategoryValues({});\n    setSelectedSeasonId(\"\");\n  };\n\n  const handleSaveRate = (categoryId: string, categoryName: string) => {\n    if (!configClientId || !rateValues[categoryId] || !selectedSeasonId) return;\n    \n    // Check if this is Agroquímicos and has subcategories\n    const isAgroquimicos = categoryName.toLowerCase().includes('agroqu');\n    const subcategories = isAgroquimicos && subcategoryValues[categoryId] \n      ? subcategoryValues[categoryId]\n      : undefined;\n    \n    saveRateMutation.mutate({\n      clientId: configClientId,\n      categoryId,\n      seasonId: selectedSeasonId,\n      investmentPerHa: rateValues[categoryId],\n      subcategories,\n    });\n  };\n\n  const getCurrentValue = (categoryId: string): string => {\n    // Check if user has entered a value\n    if (rateValues[categoryId]) return rateValues[categoryId];\n    \n    // Check if there's an existing client rate\n    const existingRate = clientRates?.find(r => r.categoryId === categoryId);\n    if (existingRate) return existingRate.investmentPerHa;\n    \n    return \"\";\n  };\n\n  const getCurrentExternalPurchaseValue = (categoryId: string): string => {\n    // Check if user has entered a value\n    if (externalPurchaseValues[categoryId]) return externalPurchaseValues[categoryId];\n    \n    // Check if there's an existing external purchase\n    const existingPurchase = externalPurchases?.find(p => p.categoryId === categoryId);\n    if (existingPurchase) return existingPurchase.amount;\n    \n    return \"\";\n  };\n\n  const handleSaveExternalPurchase = (categoryId: string, categoryName: string) => {\n    if (!configClientId || !externalPurchaseValues[categoryId] || !selectedSeasonId) return;\n    \n    // Check if this is Agroquímicos and has subcategories\n    const isAgroquimicos = categoryName.toLowerCase().includes('agroqu');\n    const subcategories = isAgroquimicos && externalSubcategoryValues[categoryId] \n      ? externalSubcategoryValues[categoryId]\n      : undefined;\n    \n    saveExternalPurchaseMutation.mutate({\n      clientId: configClientId,\n      categoryId,\n      seasonId: selectedSeasonId,\n      amount: externalPurchaseValues[categoryId],\n      subcategories,\n    });\n  };\n\n  const handleOpenInlineEdit = async (clientId: string, categoryId: string, currentValue: number) => {\n    setInlineExternalValue(currentValue > 0 ? currentValue.toString() : \"\");\n    \n    // Fetch existing external purchase to get company name\n    if (activeSeason) {\n      try {\n        const response = await fetch(`/api/clients/${clientId}/external-purchases/${activeSeason.id}`);\n        if (response.ok) {\n          const purchases = await response.json();\n          const existingPurchase = purchases.find((p: any) => p.categoryId === categoryId);\n          setInlineExternalCompany(existingPurchase?.company || \"\");\n        } else {\n          setInlineExternalCompany(\"\");\n        }\n      } catch (error) {\n        console.error('Error fetching external purchase:', error);\n        setInlineExternalCompany(\"\");\n      }\n    } else {\n      setInlineExternalCompany(\"\");\n    }\n  };\n\n  const handleSaveInlineExternal = (clientId: string, categoryId: string) => {\n    if (!activeSeason || !inlineExternalValue) return;\n\n    saveInlineExternalPurchaseMutation.mutate({\n      clientId,\n      categoryId,\n      seasonId: activeSeason.id,\n      amount: inlineExternalValue,\n      company: inlineExternalCompany || undefined,\n    });\n  };\n\n\n\n  const exportPDF = () => {\n    if (!marketData) return;\n\n    const doc = new jsPDF();\n    const pageWidth = doc.internal.pageSize.getWidth();\n\n    // Title\n    doc.setFontSize(18);\n    doc.text(\"Análise de Mercado - Agro Farm Digital\", pageWidth / 2, 15, { align: \"center\" });\n    \n    doc.setFontSize(10);\n    doc.text(`Gerado em: ${new Date().toLocaleDateString(\"pt-BR\")}`, pageWidth / 2, 22, { align: \"center\" });\n\n    // Benchmark Section\n    doc.setFontSize(14);\n    doc.text(\"Benchmark Regional\", 14, 35);\n    \n    const benchmarkData = Object.entries(marketData.benchmark).map(([categoryId, percentage]) => {\n      const categoryName = marketData.clientAnalysis[0]?.categoryDetails[categoryId]?.categoryName || categoryId;\n      return [categoryName, `${percentage.toFixed(1)}%`];\n    });\n\n    autoTable(doc, {\n      startY: 40,\n      head: [[\"Segmento\", \"% Mercado\"]],\n      body: benchmarkData,\n      theme: \"striped\",\n      headStyles: { fillColor: [74, 144, 226] },\n    });\n\n    // Client Analysis Section\n    const clientAnalysisY = (doc as any).lastAutoTable.finalY + 15;\n    doc.setFontSize(14);\n    doc.text(\"Análise por Cliente\", 14, clientAnalysisY);\n\n    const clientData = marketData.clientAnalysis.map((client) => [\n      client.clientName,\n      client.plantingArea.toLocaleString(),\n      `$${client.totalPotential.toLocaleString()}`,\n      `$${client.totalRealized.toLocaleString()}`,\n      `${client.totalPercentage.toFixed(1)}%`,\n    ]);\n\n    autoTable(doc, {\n      startY: clientAnalysisY + 5,\n      head: [[\"Cliente\", \"Área (ha)\", \"Potencial\", \"Realizado\", \"% Rodado\"]],\n      body: clientData,\n      theme: \"striped\",\n      headStyles: { fillColor: [74, 144, 226] },\n    });\n\n    // Opportunities Section\n    const opportunitiesY = (doc as any).lastAutoTable.finalY + 15;\n    \n    // Check if we need a new page\n    if (opportunitiesY > 250) {\n      doc.addPage();\n      doc.setFontSize(14);\n      doc.text(\"Oportunidades Comerciais\", 14, 20);\n      \n      const oppData = marketData.opportunities?.slice(0, 15).map((opp) => [\n        opp.clientName,\n        opp.categoryName,\n        `${opp.clientPercentage.toFixed(1)}%`,\n        `${opp.marketPercentage.toFixed(1)}%`,\n        `+${opp.gap.toFixed(1)}%`,\n        `$${opp.potential.toLocaleString()}`,\n      ]);\n\n      autoTable(doc, {\n        startY: 25,\n        head: [[\"Cliente\", \"Segmento\", \"% Cliente\", \"% Mercado\", \"Gap\", \"Potencial\"]],\n        body: oppData,\n        theme: \"striped\",\n        headStyles: { fillColor: [74, 144, 226] },\n      });\n    } else {\n      doc.setFontSize(14);\n      doc.text(\"Oportunidades Comerciais\", 14, opportunitiesY);\n      \n      const oppData = marketData.opportunities?.slice(0, 15).map((opp) => [\n        opp.clientName,\n        opp.categoryName,\n        `${opp.clientPercentage.toFixed(1)}%`,\n        `${opp.marketPercentage.toFixed(1)}%`,\n        `+${opp.gap.toFixed(1)}%`,\n        `$${opp.potential.toLocaleString()}`,\n      ]);\n\n      autoTable(doc, {\n        startY: opportunitiesY + 5,\n        head: [[\"Cliente\", \"Segmento\", \"% Cliente\", \"% Mercado\", \"Gap\", \"Potencial\"]],\n        body: oppData,\n        theme: \"striped\",\n        headStyles: { fillColor: [74, 144, 226] },\n      });\n    }\n\n    // Save the PDF\n    doc.save(`analise-mercado-${new Date().toISOString().split('T')[0]}.pdf`);\n  };\n\n  // Cálculo da Matriz Potencial x Participação\n  const calculateMatrix = () => {\n    if (!marketData?.clientAnalysis) return { clients: [], stats: null };\n    \n    const clients = marketData.clientAnalysis.map(client => {\n      const participation = client.totalPotential > 0 \n        ? (client.totalRealized / client.totalPotential) * 100 \n        : 0;\n      \n      return {\n        id: client.clientId,\n        name: client.clientName,\n        area: client.plantingArea,\n        potential: client.totalPotential,\n        realized: client.totalRealized,\n        participation: participation,\n      };\n    });\n    \n    // Ordenar por potencial (área de plantio como proxy)\n    const sortedByPotential = [...clients].sort((a, b) => b.area - a.area);\n    const top30Index = Math.ceil(clients.length * 0.3);\n    const bottom30Index = Math.floor(clients.length * 0.7);\n    \n    // Classificar cada cliente\n    const classified = clients.map(client => {\n      const potentialIndex = sortedByPotential.findIndex(c => c.id === client.id);\n      const potentialLevel = potentialIndex < top30Index ? 'ALTO' : \n                            potentialIndex >= bottom30Index ? 'BAIXO' : 'MÉDIO';\n      \n      const participationLevel = client.participation >= 50 ? 'ALTA' : \n                                 client.participation < 30 ? 'BAIXA' : 'MÉDIA';\n      \n      // Definir quadrante (baseado nos critérios da literatura)\n      let quadrant = '';\n      let strategy = '';\n      \n      if (potentialLevel === 'ALTO' && participationLevel === 'ALTA') {\n        // Top 30% potencial + ≥50% participação\n        quadrant = 'Estrelas';\n        strategy = 'DEFENDER e CRESCER JUNTO';\n      } else if (potentialLevel === 'ALTO' && (participationLevel === 'BAIXA' || participationLevel === 'MÉDIA')) {\n        // Top 30% potencial + <50% participação\n        quadrant = 'Diamantes Brutos';\n        strategy = 'INVESTIR para CONQUISTAR';\n      } else if ((potentialLevel === 'BAIXO' || potentialLevel === 'MÉDIO') && participationLevel === 'ALTA') {\n        // Não top 30% potencial + ≥50% participação\n        quadrant = 'Vacas Leiteiras';\n        strategy = 'MANTER eficiência';\n      } else {\n        // Não top 30% potencial + <50% participação\n        quadrant = 'Ocasionais';\n        strategy = 'Atendimento BÁSICO';\n      }\n      \n      return {\n        ...client,\n        potentialLevel,\n        participationLevel,\n        quadrant,\n        strategy,\n      };\n    });\n    \n    // Estatísticas por quadrante\n    const stats = {\n      stars: classified.filter(c => c.quadrant === 'Estrelas').length,\n      diamonds: classified.filter(c => c.quadrant === 'Diamantes Brutos').length,\n      cows: classified.filter(c => c.quadrant === 'Vacas Leiteiras').length,\n      ocasionals: classified.filter(c => c.quadrant === 'Ocasionais').length,\n    };\n    \n    return { clients: classified, stats };\n  };\n  \n  const matrixData = calculateMatrix();\n\n  if (isLoading) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-32 w-32 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-screen flex flex-col overflow-hidden\" data-testid=\"mercado-container\">\n      <Header \n        title=\"Análise de Mercado\"\n        subtitle=\"Potencial vs Realizado por Cliente\"\n        onNewSale={() => {}}\n      />\n      <Navbar />\n      \n      <main className=\"flex-1 overflow-y-auto\">\n        \n        {/* Botões de Ação */}\n        {/* <div className=\"px-8 pt-4 flex gap-2\">\n          <Button\n            variant=\"outline\"\n            size=\"sm\"\n            onClick={() => setShowMatrixDialog(true)}\n            className=\"gap-2\"\n            data-testid=\"button-matrix-analysis\"\n          >\n            <Target className=\"h-4 w-4\" />\n            Matriz Potencial x Participação\n          </Button>\n        </div> */}\n\n        <div className=\"p-8 pt-8\">\n          {/* Header with Export Button */}\n          <div className=\"flex justify-between items-center mb-6\">\n            <h2 className=\"text-2xl font-bold\">Análise de Mercado {activeSeason && `- ${activeSeason.name}`}</h2>\n            <div className=\"flex gap-2\">\n              <Button onClick={() => setShowComparisonDialog(true)} variant=\"outline\" data-testid=\"button-comparison-table\">\n                <BarChart3 className=\"mr-2 h-4 w-4\" />\n                Ver Comparativo\n              </Button>\n            </div>\n          </div>\n\n          {/* Client Analysis Table */}\n          <Card className=\"shadow-sm mb-8\" data-testid=\"card-client-analysis\">\n            <CardHeader>\n              <CardTitle>Análise por Cliente</CardTitle>\n              <p className=\"text-sm text-muted-foreground\">Potencial e realização por segmento</p>\n            </CardHeader>\n            <CardContent>\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead className=\"w-12\"></TableHead>\n                    <TableHead>Cliente</TableHead>\n                    <TableHead className=\"text-right\">Área (ha)</TableHead>\n                    <TableHead className=\"text-right\">Potencial (USD)</TableHead>\n                    <TableHead className=\"text-right\">Realizado (USD)</TableHead>\n                    <TableHead className=\"text-right\">% Rodado</TableHead>\n                    <TableHead className=\"text-center w-24\">Ações</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {marketData?.clientAnalysis\n                    .sort((a, b) => a.clientName.localeCompare(b.clientName))\n                    .map((client) => {\n                      const hasNoPlantingArea = !client.plantingArea || client.plantingArea === 0;\n                      return (\n                    <>\n                      <TableRow \n                        key={client.clientId} \n                        className={`hover:bg-muted/50 ${hasNoPlantingArea ? 'bg-orange-50/50' : ''}`}\n                        data-testid={`row-client-${client.clientId}`}\n                      >\n                        <TableCell \n                          className=\"cursor-pointer\"\n                          onClick={() => toggleClient(client.clientId)}\n                        >\n                          {expandedClients.has(client.clientId) ? (\n                            <ChevronDown className=\"h-4 w-4\" />\n                          ) : (\n                            <ChevronRight className=\"h-4 w-4\" />\n                          )}\n                        </TableCell>\n                        <TableCell className=\"font-medium cursor-pointer\" onClick={() => toggleClient(client.clientId)}>\n                          {client.clientName}\n                          {hasNoPlantingArea && (\n                            <span className=\"ml-2 text-xs text-orange-600 font-normal\">⚠️ Sem área</span>\n                          )}\n                        </TableCell>\n                        <TableCell className=\"text-right cursor-pointer\" onClick={() => toggleClient(client.clientId)}>\n                          {hasNoPlantingArea ? (\n                            <span className=\"text-orange-600 font-medium\">-</span>\n                          ) : (\n                            client.plantingArea.toLocaleString()\n                          )}\n                        </TableCell>\n                        <TableCell className=\"text-right cursor-pointer\" onClick={() => toggleClient(client.clientId)}>${client.totalPotential.toLocaleString()}</TableCell>\n                        <TableCell className=\"text-right cursor-pointer\" onClick={() => toggleClient(client.clientId)}>${client.totalRealized.toLocaleString()}</TableCell>\n                        <TableCell className=\"text-right cursor-pointer\" onClick={() => toggleClient(client.clientId)}>\n                          <div className=\"flex items-center justify-end gap-2\">\n                            <span className=\"font-semibold\">{client.totalPercentage.toFixed(1)}%</span>\n                            <Progress \n                              value={Math.min(client.totalPercentage, 100)} \n                              className=\"h-2 w-20\" \n                            />\n                          </div>\n                        </TableCell>\n                        <TableCell className=\"text-center\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={(e) => {\n                              e.stopPropagation();\n                              openConfigDialog(client.clientId);\n                            }}\n                            data-testid={`button-config-${client.clientId}`}\n                          >\n                            <Settings className=\"h-4 w-4\" />\n                          </Button>\n                        </TableCell>\n                      </TableRow>\n                      {expandedClients.has(client.clientId) && (\n                        <TableRow>\n                          <TableCell colSpan={7} className=\"bg-gray-50 p-0\">\n                            <div className=\"py-4 px-6\">\n                              <p className=\"text-sm font-semibold mb-3\">Detalhamento por Segmento:</p>\n                              <Table>\n                                <TableHeader>\n                                  <TableRow>\n                                    <TableHead className=\"w-8\"></TableHead>\n                                    <TableHead>Segmento</TableHead>\n                                    <TableHead className=\"text-right\">Potencial</TableHead>\n                                    <TableHead className=\"text-right\">C.Vale</TableHead>\n                                    <TableHead className=\"text-right\">Outras</TableHead>\n                                    <TableHead className=\"text-right\">Total</TableHead>\n                                    <TableHead className=\"text-right\">Oportunidades</TableHead>\n                                    <TableHead className=\"text-center\">Status</TableHead>\n                                  </TableRow>\n                                </TableHeader>\n                                <TableBody>\n                                  {Object.entries(client.categoryDetails)\n                                    .filter(([_, details]) => details.potential > 0 || details.totalRealized > 0)\n                                    .map(([categoryId, details]) => {\n                                      const isAgroquimicos = details.categoryName.toLowerCase().includes('agroqu');\n                                      const hasSubcategories = Array.isArray(details.subcategories) && details.subcategories.length > 0;\n                                      const categoryKey = `${client.clientId}-${categoryId}`;\n                                      const isCategoryExpanded = expandedCategories.has(categoryKey);\n                                      \n                                      return (\n                                        <>\n                                          <TableRow \n                                            key={categoryId}\n                                            className={hasSubcategories ? 'hover:bg-muted/50 cursor-pointer' : ''}\n                                            onClick={() => {\n                                              if (hasSubcategories) {\n                                                toggleCategory(client.clientId, categoryId);\n                                              }\n                                            }}\n                                          >\n                                            <TableCell className=\"w-8\">\n                                              {hasSubcategories && (\n                                                isCategoryExpanded ? (\n                                                  <ChevronDown className=\"h-4 w-4\" />\n                                                ) : (\n                                                  <ChevronRight className=\"h-4 w-4\" />\n                                                )\n                                              )}\n                                            </TableCell>\n                                            <TableCell className=\"font-medium\">{details.categoryName}</TableCell>\n                                            <TableCell className=\"text-right\">${details.potential.toLocaleString()}</TableCell>\n                                            <TableCell className=\"text-right text-green-700 font-medium\">${details.cvaleAmount.toLocaleString()}</TableCell>\n                                            <TableCell \n                                              className=\"text-right text-orange-600\"\n                                              onClick={(e) => e.stopPropagation()}\n                                            >\n                                              <Popover\n                                                onOpenChange={(open) => {\n                                                  if (open) {\n                                                    handleOpenInlineEdit(client.clientId, categoryId, details.externalAmount);\n                                                  } else {\n                                                    setInlineExternalValue(\"\");\n                                                    setInlineExternalCompany(\"\");\n                                                  }\n                                                }}\n                                              >\n                                                <PopoverTrigger asChild>\n                                                  <button \n                                                    className=\"hover:bg-orange-100 px-2 py-1 rounded transition-colors flex items-center gap-1 w-full justify-end\"\n                                                    data-testid={`button-edit-external-${client.clientId}-${categoryId}`}\n                                                  >\n                                                    <div className=\"flex flex-col items-end\">\n                                                      <span>${details.externalAmount.toLocaleString()}</span>\n                                                      {details.externalCompany && (\n                                                        <span className=\"text-xs text-muted-foreground\">{details.externalCompany}</span>\n                                                      )}\n                                                    </div>\n                                                    <Edit2 className=\"h-3 w-3 opacity-50\" />\n                                                  </button>\n                                                </PopoverTrigger>\n                                                <PopoverContent className=\"w-80\" align=\"end\">\n                                                  <div className=\"space-y-3\">\n                                                    <div className=\"space-y-2\">\n                                                      <Label htmlFor={`inline-value-${client.clientId}-${categoryId}`}>\n                                                        Valor (USD)\n                                                      </Label>\n                                                      <Input\n                                                        id={`inline-value-${client.clientId}-${categoryId}`}\n                                                        type=\"number\"\n                                                        placeholder=\"Ex: 5000\"\n                                                        value={inlineExternalValue}\n                                                        onChange={(e) => setInlineExternalValue(e.target.value)}\n                                                        data-testid={`input-inline-value-${client.clientId}-${categoryId}`}\n                                                      />\n                                                    </div>\n                                                    <div className=\"space-y-2\">\n                                                      <Label htmlFor={`inline-company-${client.clientId}-${categoryId}`}>\n                                                        Empresa (opcional)\n                                                      </Label>\n                                                      <Input\n                                                        id={`inline-company-${client.clientId}-${categoryId}`}\n                                                        type=\"text\"\n                                                        placeholder=\"Ex: Empresa Concorrente\"\n                                                        value={inlineExternalCompany}\n                                                        onChange={(e) => setInlineExternalCompany(e.target.value)}\n                                                        data-testid={`input-inline-company-${client.clientId}-${categoryId}`}\n                                                      />\n                                                    </div>\n                                                    <Button\n                                                      onClick={() => handleSaveInlineExternal(client.clientId, categoryId)}\n                                                      disabled={!inlineExternalValue || saveInlineExternalPurchaseMutation.isPending}\n                                                      className=\"w-full\"\n                                                      data-testid={`button-save-inline-${client.clientId}-${categoryId}`}\n                                                    >\n                                                      <Check className=\"h-4 w-4 mr-2\" />\n                                                      {saveInlineExternalPurchaseMutation.isPending ? \"Salvando...\" : \"Salvar\"}\n                                                    </Button>\n                                                  </div>\n                                                </PopoverContent>\n                                              </Popover>\n                                            </TableCell>\n                                            <TableCell className=\"text-right font-semibold\">${details.totalRealized.toLocaleString()}</TableCell>\n                                            <TableCell className=\"text-right\">\n                                              {details.opportunity > 0 ? (\n                                                <span className=\"text-blue-600 font-medium\">${details.opportunity.toLocaleString()}</span>\n                                              ) : (\n                                                <span className=\"text-gray-400\">-</span>\n                                              )}\n                                            </TableCell>\n                                            <TableCell className=\"text-center\">\n                                              {details.isClosed ? (\n                                                <span className=\"px-2 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded\">FECHADO</span>\n                                              ) : details.percentage >= 50 ? (\n                                                <span className=\"px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-semibold rounded\">EM PROGRESSO</span>\n                                              ) : (\n                                                <span className=\"px-2 py-1 bg-red-100 text-red-700 text-xs font-semibold rounded\">ABERTO</span>\n                                              )}\n                                            </TableCell>\n                                          </TableRow>\n                                          {/* Subcategory rows for Agroquímicos */}\n                                          {isAgroquimicos && hasSubcategories && isCategoryExpanded && Array.isArray(details.subcategories) && (\n                                            <>\n                                              {details.subcategories\n                                                .filter((sub: any) => sub.totalAmount > 0)\n                                                .map((sub: any) => {\n                                                  const subcategoryKey = `${client.clientId}-${categoryId}-${sub.id}`;\n                                                  const isSubcategoryExpanded = expandedSubcategories.has(subcategoryKey);\n                                                  const hasProducts = Array.isArray(sub.products) && sub.products.length > 0;\n                                                  \n                                                  return (\n                                                    <Fragment key={`${client.clientId}-${categoryId}-${sub.id}`}>\n                                                      <TableRow \n                                                        className={`bg-gray-100/50 ${hasProducts ? 'hover:bg-gray-200/50 cursor-pointer' : ''}`}\n                                                        onClick={() => {\n                                                          if (hasProducts) {\n                                                            toggleSubcategory(client.clientId, categoryId, sub.id);\n                                                          }\n                                                        }}\n                                                      >\n                                                        <TableCell className=\"w-8 pl-4\">\n                                                          {hasProducts && (\n                                                            isSubcategoryExpanded ? (\n                                                              <ChevronDown className=\"h-3 w-3\" />\n                                                            ) : (\n                                                              <ChevronRight className=\"h-3 w-3\" />\n                                                            )\n                                                          )}\n                                                        </TableCell>\n                                                        <TableCell className=\"pl-8 text-sm text-gray-600\">↳ {sub.name}</TableCell>\n                                                        <TableCell className=\"text-right text-sm text-gray-600\">-</TableCell>\n                                                        <TableCell className=\"text-right text-sm text-green-700\">${sub.cvaleAmount.toLocaleString()}</TableCell>\n                                                        <TableCell className=\"text-right text-sm text-orange-600\">${sub.externalAmount.toLocaleString()}</TableCell>\n                                                        <TableCell className=\"text-right text-sm text-gray-700 font-medium\">${sub.totalAmount.toLocaleString()}</TableCell>\n                                                        <TableCell className=\"text-right text-sm text-gray-600\">-</TableCell>\n                                                        <TableCell className=\"text-center text-sm text-gray-600\">-</TableCell>\n                                                      </TableRow>\n                                                      \n                                                      {/* Product rows for this subcategory */}\n                                                      {hasProducts && isSubcategoryExpanded && sub.products.map((product: any) => (\n                                                        <TableRow key={`${categoryId}-${sub.id}-${product.productId}`} className=\"bg-gray-50\">\n                                                          <TableCell className=\"w-8\"></TableCell>\n                                                          <TableCell className=\"pl-16 text-xs text-gray-500\">\n                                                            ↳↳ {product.productName}\n                                                          </TableCell>\n                                                          <TableCell className=\"text-right text-xs text-gray-500\">-</TableCell>\n                                                          <TableCell className=\"text-right text-xs text-green-600\">\n                                                            ${product.cvaleAmount.toLocaleString()} ({(product.quantity || 0).toFixed(1)} un)\n                                                          </TableCell>\n                                                          <TableCell className=\"text-right text-xs text-gray-500\">-</TableCell>\n                                                          <TableCell className=\"text-right text-xs text-gray-600\">\n                                                            ${product.cvaleAmount.toLocaleString()}\n                                                          </TableCell>\n                                                          <TableCell className=\"text-right text-xs text-gray-500\">-</TableCell>\n                                                          <TableCell className=\"text-center text-xs text-gray-500\">-</TableCell>\n                                                        </TableRow>\n                                                      ))}\n                                                    </Fragment>\n                                                  );\n                                                })}\n                                            </>\n                                          )}\n                                        </>\n                                      );\n                                    })}\n                                  {/* Totals row */}\n                                  <TableRow className=\"border-t-2 border-gray-300 bg-gray-100 font-bold\">\n                                    <TableCell className=\"w-8\"></TableCell>\n                                    <TableCell className=\"font-bold\">TOTAL CLIENTE</TableCell>\n                                    <TableCell className=\"text-right\">${client.totalPotential.toLocaleString()}</TableCell>\n                                    <TableCell className=\"text-right text-green-700\">\n                                      ${Object.values(client.categoryDetails).reduce((sum, d) => sum + d.cvaleAmount, 0).toLocaleString()}\n                                    </TableCell>\n                                    <TableCell className=\"text-right text-orange-600\">\n                                      ${Object.values(client.categoryDetails).reduce((sum, d) => sum + d.externalAmount, 0).toLocaleString()}\n                                    </TableCell>\n                                    <TableCell className=\"text-right\">${client.totalRealized.toLocaleString()}</TableCell>\n                                    <TableCell className=\"text-right text-blue-600\">\n                                      ${(client.totalPotential - client.totalRealized > 0 ? client.totalPotential - client.totalRealized : 0).toLocaleString()}\n                                    </TableCell>\n                                    <TableCell className=\"text-center\">\n                                      {client.totalPercentage >= 100 ? (\n                                        <span className=\"px-2 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded\">FECHADO</span>\n                                      ) : client.totalPercentage >= 50 ? (\n                                        <span className=\"px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-semibold rounded\">EM PROGRESSO</span>\n                                      ) : (\n                                        <span className=\"px-2 py-1 bg-red-100 text-red-700 text-xs font-semibold rounded\">ABERTO</span>\n                                      )}\n                                    </TableCell>\n                                  </TableRow>\n                                </TableBody>\n                              </Table>\n                            </div>\n                          </TableCell>\n                        </TableRow>\n                      )}\n                    </>\n                      );\n                    })}\n                </TableBody>\n              </Table>\n            </CardContent>\n          </Card>\n        </div>\n      </main>\n\n      {/* Configuration Dialog */}\n      <Dialog open={!!configClientId} onOpenChange={(open) => !open && closeConfigDialog()}>\n        <DialogContent className=\"max-w-2xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Configurar Investimento por Hectare</DialogTitle>\n            <DialogDescription>\n              Configure o valor de investimento esperado (USD) por hectare para cada segmento.\n              Estes valores serão multiplicados pela área de plantio do cliente para calcular o potencial.\n            </DialogDescription>\n          </DialogHeader>\n\n          {/* Warning for clients without planting area */}\n          {configClientId && (() => {\n            const client = marketData?.clientAnalysis.find(c => c.clientId === configClientId);\n            return (!client?.plantingArea || client.plantingArea <= 0) && (\n              <div className=\"mt-4 p-4 bg-orange-50 border border-orange-200 rounded-lg\">\n                <div className=\"flex items-start gap-2\">\n                  <span className=\"text-orange-600 text-lg\">⚠️</span>\n                  <div className=\"flex-1\">\n                    <p className=\"text-sm font-semibold text-orange-900\">Cliente sem área de plantio</p>\n                    <p className=\"text-sm text-orange-700 mt-1\">\n                      Este cliente não possui área de plantio cadastrada. Configure a área na página de Clientes para que os valores de potencial possam ser calculados.\n                    </p>\n                  </div>\n                </div>\n              </div>\n            );\n          })()}\n          \n          {/* Season Selection */}\n          <div className=\"mt-4\">\n            <Label htmlFor=\"season-select\" className=\"text-base font-semibold\">Safra</Label>\n            <Select value={selectedSeasonId} onValueChange={setSelectedSeasonId}>\n              <SelectTrigger id=\"season-select\" data-testid=\"select-season\">\n                <SelectValue placeholder=\"Selecione a safra\" />\n              </SelectTrigger>\n              <SelectContent>\n                {seasons?.map((season) => (\n                  <SelectItem key={season.id} value={season.id} data-testid={`season-option-${season.id}`}>\n                    {season.name} {season.isActive && \"(Ativa)\"}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"space-y-4 mt-4\">\n            {categories?.map((category) => {\n              const categoryId = category.id;\n              const categoryName = category.name;\n              const currentValue = getCurrentValue(categoryId);\n              const isAgroquimicos = categoryName.toLowerCase().includes('agroqu');\n              const agroquimicosSubcategories = ['Tratamento de semente', 'Dessecação', 'Inseticidas', 'Fungicidas'];\n              \n              return (\n                <div key={categoryId} className=\"border rounded-lg p-4 space-y-3\">\n                  <Label htmlFor={`rate-${categoryId}`} className=\"text-base font-semibold\">\n                    {categoryName}\n                  </Label>\n                  <div className=\"flex gap-2\">\n                    <div className=\"flex-1\">\n                      <Input\n                        id={`rate-${categoryId}`}\n                        type=\"number\"\n                        step=\"0.01\"\n                        placeholder=\"Ex: 150.00\"\n                        value={currentValue}\n                        onChange={(e) => setRateValues({ ...rateValues, [categoryId]: e.target.value })}\n                        data-testid={`input-rate-${categoryId}`}\n                      />\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        USD por hectare (total geral)\n                      </p>\n                    </div>\n                    <Button\n                      onClick={() => handleSaveRate(categoryId, categoryName)}\n                      disabled={!rateValues[categoryId] || saveRateMutation.isPending}\n                      data-testid={`button-save-rate-${categoryId}`}\n                    >\n                      Salvar\n                    </Button>\n                  </div>\n                  \n                  {/* Subcategories for Agroquímicos */}\n                  {isAgroquimicos && (\n                    <div className=\"mt-4 pl-4 border-l-2 border-primary/20 space-y-3\">\n                      <p className=\"text-sm font-medium text-muted-foreground\">\n                        Detalhamento por subcategoria (opcional):\n                      </p>\n                      {agroquimicosSubcategories.map((subcat) => (\n                        <div key={subcat} className=\"flex items-center gap-2\">\n                          <Label htmlFor={`subcat-${categoryId}-${subcat}`} className=\"text-sm w-28\">\n                            {subcat}:\n                          </Label>\n                          <Input\n                            id={`subcat-${categoryId}-${subcat}`}\n                            type=\"number\"\n                            step=\"0.01\"\n                            placeholder=\"0.00\"\n                            value={subcategoryValues[categoryId]?.[subcat] || ''}\n                            onChange={(e) => setSubcategoryValues({\n                              ...subcategoryValues,\n                              [categoryId]: {\n                                ...subcategoryValues[categoryId],\n                                [subcat]: e.target.value\n                              }\n                            })}\n                            className=\"flex-1\"\n                            data-testid={`input-subcat-${categoryId}-${subcat}`}\n                          />\n                          <span className=\"text-xs text-muted-foreground w-16\">$/ha</span>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                  \n                  {clientRates?.find(r => r.categoryId === categoryId) && (\n                    <p className=\"text-xs text-green-600\">\n                      ✓ Valor customizado configurado: ${parseFloat(clientRates.find(r => r.categoryId === categoryId)!.investmentPerHa).toFixed(2)}/ha\n                    </p>\n                  )}\n\n                  {/* External Purchases Section */}\n                  <div className=\"mt-4 pt-4 border-t border-gray-200\">\n                    <Label htmlFor={`external-${categoryId}`} className=\"text-sm font-medium text-gray-700\">\n                      Compras Externas (Outras Empresas)\n                    </Label>\n                    <p className=\"text-xs text-muted-foreground mb-2\">\n                      Valor total que o cliente comprou de concorrentes nesta categoria\n                    </p>\n                    <div className=\"flex gap-2\">\n                      <div className=\"flex-1\">\n                        <Input\n                          id={`external-${categoryId}`}\n                          type=\"number\"\n                          step=\"0.01\"\n                          placeholder=\"Ex: 5000.00\"\n                          value={getCurrentExternalPurchaseValue(categoryId)}\n                          onChange={(e) => setExternalPurchaseValues({ ...externalPurchaseValues, [categoryId]: e.target.value })}\n                          data-testid={`input-external-${categoryId}`}\n                        />\n                        <p className=\"text-xs text-muted-foreground mt-1\">\n                          Total USD comprado de concorrentes\n                        </p>\n                      </div>\n                      <Button\n                        onClick={() => handleSaveExternalPurchase(categoryId, categoryName)}\n                        disabled={!externalPurchaseValues[categoryId] || saveExternalPurchaseMutation.isPending}\n                        variant=\"secondary\"\n                        data-testid={`button-save-external-${categoryId}`}\n                      >\n                        Salvar\n                      </Button>\n                    </div>\n\n                    {/* External Subcategories for Agroquímicos */}\n                    {isAgroquimicos && (\n                      <div className=\"mt-3 pl-4 border-l-2 border-orange-200 space-y-2\">\n                        <p className=\"text-xs font-medium text-muted-foreground\">\n                          Detalhamento externo por subcategoria (opcional):\n                        </p>\n                        {agroquimicosSubcategories.map((subcat) => (\n                          <div key={subcat} className=\"flex items-center gap-2\">\n                            <Label htmlFor={`ext-subcat-${categoryId}-${subcat}`} className=\"text-xs w-28\">\n                              {subcat}:\n                            </Label>\n                            <Input\n                              id={`ext-subcat-${categoryId}-${subcat}`}\n                              type=\"number\"\n                              step=\"0.01\"\n                              placeholder=\"0.00\"\n                              value={externalSubcategoryValues[categoryId]?.[subcat] || ''}\n                              onChange={(e) => setExternalSubcategoryValues({\n                                ...externalSubcategoryValues,\n                                [categoryId]: {\n                                  ...externalSubcategoryValues[categoryId],\n                                  [subcat]: e.target.value\n                                }\n                              })}\n                              className=\"flex-1 h-8 text-sm\"\n                              data-testid={`input-ext-subcat-${categoryId}-${subcat}`}\n                            />\n                            <span className=\"text-xs text-muted-foreground w-12\">USD</span>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n\n                    {externalPurchases?.find(p => p.categoryId === categoryId) && (\n                      <p className=\"text-xs text-orange-600 mt-2\">\n                        ✓ Compra externa registrada: ${parseFloat(externalPurchases.find(p => p.categoryId === categoryId)!.amount).toLocaleString()}\n                      </p>\n                    )}\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n\n          <div className=\"mt-6 flex justify-end\">\n            <Button variant=\"outline\" onClick={closeConfigDialog} data-testid=\"button-close-config\">\n              Fechar\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Comparison Table Dialog */}\n      <Dialog open={showComparisonDialog} onOpenChange={setShowComparisonDialog}>\n        <DialogContent className=\"max-w-4xl max-h-[85vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Comparativo C.Vale vs Mercado</DialogTitle>\n            <DialogDescription>\n              Performance por categoria - {activeSeason?.name || 'Safra Ativa'}\n            </DialogDescription>\n          </DialogHeader>\n          \n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Família</TableHead>\n                <TableHead className=\"text-right\">Mercado</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {categories?.map((category) => {\n                const categoryId = category.id;\n                \n                // Get market benchmark percentage\n                const benchmark = activeSeasonBenchmarks?.find(b => b.categoryId === categoryId);\n                const marketPercentage = benchmark \n                  ? parseFloat(benchmark.marketPercentage) \n                  : null;\n                \n                return (\n                  <TableRow key={categoryId} data-testid={`row-comparison-dialog-${categoryId}`}>\n                    <TableCell className=\"font-medium\">{category.name}</TableCell>\n                    <TableCell className=\"text-right\" data-testid={`text-mercado-dialog-${categoryId}`}>\n                      {marketPercentage !== null \n                        ? `${marketPercentage.toFixed(1)}%` \n                        : <span className=\"text-muted-foreground text-xs\">-</span>\n                      }\n                    </TableCell>\n                  </TableRow>\n                );\n              })}\n            </TableBody>\n          </Table>\n\n          <div className=\"mt-6 flex justify-end\">\n            <Button variant=\"outline\" onClick={() => setShowComparisonDialog(false)} data-testid=\"button-close-comparison\">\n              Fechar\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Matriz Potencial x Participação Dialog */}\n      <Dialog open={showMatrixDialog} onOpenChange={setShowMatrixDialog}>\n        <DialogContent className=\"max-w-6xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Matriz Potencial x Participação</DialogTitle>\n            <DialogDescription>\n              Análise estratégica de clientes baseada em potencial de crescimento e participação atual (Share of Wallet)\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-6\">\n            {/* Resumo por Quadrante */}\n            <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-4\">\n              <Card className=\"border-green-200 bg-green-50 dark:bg-green-950/20\">\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm font-medium text-green-900 dark:text-green-100\">🌟 Estrelas</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold text-green-700 dark:text-green-300\">{matrixData.stats?.stars || 0}</div>\n                  <p className=\"text-xs text-green-600 dark:text-green-400 mt-1\">Alto Potencial + Alta Participação</p>\n                </CardContent>\n              </Card>\n\n              <Card className=\"border-blue-200 bg-blue-50 dark:bg-blue-950/20\">\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm font-medium text-blue-900 dark:text-blue-100\">💎 Diamantes Brutos</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold text-blue-700 dark:text-blue-300\">{matrixData.stats?.diamonds || 0}</div>\n                  <p className=\"text-xs text-blue-600 dark:text-blue-400 mt-1\">Alto Potencial + Baixa Participação</p>\n                </CardContent>\n              </Card>\n\n              <Card className=\"border-yellow-200 bg-yellow-50 dark:bg-yellow-950/20\">\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm font-medium text-yellow-900 dark:text-yellow-100\">🔄 Vacas Leiteiras</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold text-yellow-700 dark:text-yellow-300\">{matrixData.stats?.cows || 0}</div>\n                  <p className=\"text-xs text-yellow-600 dark:text-yellow-400 mt-1\">Baixo Potencial + Alta Participação</p>\n                </CardContent>\n              </Card>\n\n              <Card className=\"border-gray-200 bg-gray-50 dark:bg-gray-950/20\">\n                <CardHeader className=\"pb-2\">\n                  <CardTitle className=\"text-sm font-medium text-gray-900 dark:text-gray-100\">📦 Ocasionais</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"text-2xl font-bold text-gray-700 dark:text-gray-300\">{matrixData.stats?.ocasionals || 0}</div>\n                  <p className=\"text-xs text-gray-600 dark:text-gray-400 mt-1\">Baixo Potencial + Baixa Participação</p>\n                </CardContent>\n              </Card>\n            </div>\n\n            {/* Visualização da Matriz */}\n            <Card>\n              <CardHeader>\n                <CardTitle>Mapa Estratégico</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-2 gap-4 min-h-[400px]\">\n                  {/* Quadrante: Diamantes Brutos (top left) */}\n                  <div className=\"border-2 border-blue-300 bg-blue-50 dark:bg-blue-950/20 rounded-lg p-4 flex flex-col\">\n                    <div className=\"font-semibold text-blue-900 dark:text-blue-100 mb-1\">💎 Diamantes Brutos</div>\n                    <div className=\"text-[10px] text-blue-700 dark:text-blue-300 mb-2\">Alto Potencial + Baixa Participação</div>\n                    <div className=\"text-xs font-medium text-blue-800 dark:text-blue-200 mb-3\">INVESTIR para CONQUISTAR</div>\n                    <div className=\"flex-1 overflow-y-auto space-y-1\">\n                      {matrixData.clients.filter(c => c.quadrant === 'Diamantes Brutos').map(client => (\n                        <div key={client.id} className=\"text-xs bg-white dark:bg-gray-800 rounded p-2\">\n                          <div className=\"font-medium\">{client.name}</div>\n                          <div className=\"text-muted-foreground\">{client.participation.toFixed(1)}% participação</div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n\n                  {/* Quadrante: Estrelas (top right) */}\n                  <div className=\"border-2 border-green-300 bg-green-50 dark:bg-green-950/20 rounded-lg p-4 flex flex-col\">\n                    <div className=\"font-semibold text-green-900 dark:text-green-100 mb-1\">🌟 Estrelas</div>\n                    <div className=\"text-[10px] text-green-700 dark:text-green-300 mb-2\">Alto Potencial + Alta Participação</div>\n                    <div className=\"text-xs font-medium text-green-800 dark:text-green-200 mb-3\">DEFENDER e CRESCER JUNTO</div>\n                    <div className=\"flex-1 overflow-y-auto space-y-1\">\n                      {matrixData.clients.filter(c => c.quadrant === 'Estrelas').map(client => (\n                        <div key={client.id} className=\"text-xs bg-white dark:bg-gray-800 rounded p-2\">\n                          <div className=\"font-medium\">{client.name}</div>\n                          <div className=\"text-muted-foreground\">{client.participation.toFixed(1)}% participação</div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n\n                  {/* Quadrante: Ocasionais (bottom left) */}\n                  <div className=\"border-2 border-gray-300 bg-gray-50 dark:bg-gray-950/20 rounded-lg p-4 flex flex-col\">\n                    <div className=\"font-semibold text-gray-900 dark:text-gray-100 mb-1\">📦 Ocasionais</div>\n                    <div className=\"text-[10px] text-gray-700 dark:text-gray-300 mb-2\">Baixo Potencial + Baixa Participação</div>\n                    <div className=\"text-xs font-medium text-gray-800 dark:text-gray-200 mb-3\">Atendimento BÁSICO</div>\n                    <div className=\"flex-1 overflow-y-auto space-y-1\">\n                      {matrixData.clients.filter(c => c.quadrant === 'Ocasionais').map(client => (\n                        <div key={client.id} className=\"text-xs bg-white dark:bg-gray-800 rounded p-2\">\n                          <div className=\"font-medium\">{client.name}</div>\n                          <div className=\"text-muted-foreground\">{client.participation.toFixed(1)}% participação</div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n\n                  {/* Quadrante: Vacas Leiteiras (bottom right) */}\n                  <div className=\"border-2 border-yellow-300 bg-yellow-50 dark:bg-yellow-950/20 rounded-lg p-4 flex flex-col\">\n                    <div className=\"font-semibold text-yellow-900 dark:text-yellow-100 mb-1\">🔄 Vacas Leiteiras</div>\n                    <div className=\"text-[10px] text-yellow-700 dark:text-yellow-300 mb-2\">Baixo Potencial + Alta Participação</div>\n                    <div className=\"text-xs font-medium text-yellow-800 dark:text-yellow-200 mb-3\">MANTER eficiência</div>\n                    <div className=\"flex-1 overflow-y-auto space-y-1\">\n                      {matrixData.clients.filter(c => c.quadrant === 'Vacas Leiteiras').map(client => (\n                        <div key={client.id} className=\"text-xs bg-white dark:bg-gray-800 rounded p-2\">\n                          <div className=\"font-medium\">{client.name}</div>\n                          <div className=\"text-muted-foreground\">{client.participation.toFixed(1)}% participação</div>\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Metodologia */}\n            <Card className=\"bg-muted/50\">\n              <CardHeader>\n                <CardTitle className=\"text-sm\">📚 Metodologia Aplicada (Literatura de Marketing)</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-2 text-xs\">\n                <div>\n                  <span className=\"font-semibold\">Potencial:</span> Baseado em área de plantio. \n                  Top 30% = Alto Potencial, Bottom 30% = Baixo Potencial\n                </div>\n                <div>\n                  <span className=\"font-semibold\">Participação (Share of Wallet):</span> % de vendas realizadas sobre o potencial estimado. \n                  ≥50% = Alta Participação, &lt;30% = Baixa Participação\n                </div>\n                <div className=\"text-muted-foreground pt-2 border-t\">\n                  Referências: Kotler (Marketing Management), Zeithaml & Bitner (Services Marketing), Kaplan & Norton (Balanced Scorecard)\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Fullscreen Dialog */}\n      {isFullscreen && (\n        <div className=\"fixed inset-0 z-50 bg-background\">\n          <div className=\"h-screen flex flex-col\">\n            {/* Header with close button */}\n            <div className=\"bg-card border-b border-border px-8 py-4 flex items-center justify-between\">\n              <div>\n                <h2 className=\"text-xl font-bold text-foreground\">Análise de Mercado</h2>\n                <p className=\"text-sm text-muted-foreground\">Potencial vs Realizado por Cliente</p>\n              </div>\n              <Button\n                variant=\"outline\"\n                size=\"icon\"\n                onClick={() => setIsFullscreen(false)}\n                data-testid=\"button-close-fullscreen-mercado\"\n              >\n                <X className=\"h-5 w-5\" />\n              </Button>\n            </div>\n\n            {/* Content - scrollable */}\n            <div className=\"flex-1 overflow-y-auto p-8\">\n              {/* Header with Export Button */}\n              <div className=\"flex justify-between items-center mb-6\">\n                <h2 className=\"text-2xl font-bold\">Análise de Mercado</h2>\n                <div className=\"flex gap-2\">\n                  <Button onClick={() => setShowComparisonDialog(true)} variant=\"outline\" data-testid=\"button-comparison-table-fullscreen\">\n                    <BarChart3 className=\"mr-2 h-4 w-4\" />\n                    Ver Comparativo\n                  </Button>\n                </div>\n              </div>\n\n              {/* Client Analysis Table */}\n              <Card className=\"shadow-sm mb-8\" data-testid=\"card-client-analysis-fullscreen\">\n                <CardHeader>\n                  <CardTitle>Análise por Cliente</CardTitle>\n                  <p className=\"text-sm text-muted-foreground\">\n                    Potencial e realização por segmento\n                  </p>\n                </CardHeader>\n                <CardContent>\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Família</TableHead>\n                        <TableHead className=\"text-right\">\n                          <div className=\"flex items-center justify-end gap-1\">\n                            <span>C.Vale</span>\n                            <TooltipProvider>\n                              <Tooltip>\n                                <TooltipTrigger asChild>\n                                  <button className=\"inline-flex\" data-testid=\"help-cvale-fullscreen\">\n                                    <HelpCircle className=\"h-3.5 w-3.5 text-muted-foreground hover:text-foreground transition-colors\" />\n                                  </button>\n                                </TooltipTrigger>\n                                <TooltipContent className=\"max-w-xs\">\n                                  <p className=\"font-semibold mb-1\">Nossa participação no potencial dos clientes</p>\n                                  <p className=\"text-sm\">% C.Vale = (Total Vendido ÷ Total Potencial) × 100</p>\n                                  <p className=\"text-xs text-muted-foreground mt-2\">\n                                    Representa quanto capturamos do potencial de compra dos nossos clientes\n                                  </p>\n                                </TooltipContent>\n                              </Tooltip>\n                            </TooltipProvider>\n                          </div>\n                        </TableHead>\n                        <TableHead className=\"text-right\">Mercado</TableHead>\n                        <TableHead className=\"text-right\">% Desvio</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {categories?.map((category) => {\n                        const categoryId = category.id;\n                        \n                        // Calculate C.Vale percentage (total realized / total potential)\n                        let totalPotential = 0;\n                        let totalRealized = 0;\n                        \n                        marketData?.clientAnalysis.forEach(client => {\n                          const categoryDetails = client.categoryDetails[categoryId];\n                          if (categoryDetails) {\n                            totalPotential += categoryDetails.potential;\n                            totalRealized += categoryDetails.totalRealized;\n                          }\n                        });\n                        \n                        const cvalePercentage = totalPotential > 0 \n                          ? (totalRealized / totalPotential) * 100 \n                          : 0;\n                        \n                        // Get market benchmark percentage\n                        const benchmark = activeSeasonBenchmarks?.find(b => b.categoryId === categoryId);\n                        const marketPercentage = benchmark \n                          ? parseFloat(benchmark.marketPercentage) \n                          : null;\n                        \n                        // Calculate deviation\n                        const deviation = marketPercentage !== null \n                          ? cvalePercentage - marketPercentage \n                          : null;\n                        \n                        const deviationColor = deviation !== null\n                          ? deviation >= 0 ? 'text-green-600' : 'text-red-600'\n                          : 'text-muted-foreground';\n                        \n                        return (\n                          <TableRow key={categoryId} data-testid={`row-comparison-${categoryId}-fullscreen`}>\n                            <TableCell className=\"font-medium\">{category.name}</TableCell>\n                            <TableCell className=\"text-right font-semibold\" data-testid={`text-cvale-${categoryId}-fullscreen`}>\n                              {cvalePercentage.toFixed(1)}%\n                            </TableCell>\n                            <TableCell className=\"text-right\" data-testid={`text-mercado-${categoryId}-fullscreen`}>\n                              {marketPercentage !== null \n                                ? `${marketPercentage.toFixed(1)}%` \n                                : <span className=\"text-muted-foreground text-xs\">-</span>\n                              }\n                            </TableCell>\n                            <TableCell className={`text-right font-semibold ${deviationColor}`} data-testid={`text-desvio-${categoryId}-fullscreen`}>\n                              {deviation !== null \n                                ? `${deviation >= 0 ? '+' : ''}${deviation.toFixed(1)}%`\n                                : <span className=\"text-muted-foreground text-xs\">-</span>\n                              }\n                            </TableCell>\n                          </TableRow>\n                        );\n                      })}\n                    </TableBody>\n                  </Table>\n                </CardContent>\n              </Card>\n\n              {/* Client Analysis Table */}\n              <Card className=\"shadow-sm mb-8\" data-testid=\"card-client-analysis-fullscreen\">\n                <CardHeader>\n                  <CardTitle>Análise por Cliente</CardTitle>\n                  <p className=\"text-sm text-muted-foreground\">Potencial e realização por segmento</p>\n                </CardHeader>\n                <CardContent>\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead className=\"w-12\"></TableHead>\n                        <TableHead>Cliente</TableHead>\n                        <TableHead className=\"text-right\">Área (ha)</TableHead>\n                        <TableHead className=\"text-right\">Potencial (USD)</TableHead>\n                        <TableHead className=\"text-right\">Realizado (USD)</TableHead>\n                        <TableHead className=\"text-right\">% Rodado</TableHead>\n                        <TableHead className=\"text-center w-24\">Ações</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {marketData?.clientAnalysis\n                        .sort((a, b) => a.clientName.localeCompare(b.clientName))\n                        .map((client) => {\n                          const hasNoPlantingArea = !client.plantingArea || client.plantingArea === 0;\n                          return (\n                        <>\n                          <TableRow \n                            key={client.clientId} \n                            className={`hover:bg-muted/50 ${hasNoPlantingArea ? 'bg-orange-50/50' : ''}`}\n                            data-testid={`row-client-${client.clientId}-fullscreen`}\n                          >\n                            <TableCell \n                              className=\"cursor-pointer\"\n                              onClick={() => toggleClient(client.clientId)}\n                            >\n                              {expandedClients.has(client.clientId) ? (\n                                <ChevronDown className=\"h-4 w-4\" />\n                              ) : (\n                                <ChevronRight className=\"h-4 w-4\" />\n                              )}\n                            </TableCell>\n                            <TableCell className=\"font-medium cursor-pointer\" onClick={() => toggleClient(client.clientId)}>\n                              {client.clientName}\n                              {hasNoPlantingArea && (\n                                <span className=\"ml-2 text-xs text-orange-600 font-normal\">⚠️ Sem área</span>\n                              )}\n                            </TableCell>\n                            <TableCell className=\"text-right cursor-pointer\" onClick={() => toggleClient(client.clientId)}>\n                              {hasNoPlantingArea ? (\n                                <span className=\"text-orange-600 font-medium\">-</span>\n                              ) : (\n                                client.plantingArea.toLocaleString()\n                              )}\n                            </TableCell>\n                            <TableCell className=\"text-right cursor-pointer\" onClick={() => toggleClient(client.clientId)}>${client.totalPotential.toLocaleString()}</TableCell>\n                            <TableCell className=\"text-right cursor-pointer\" onClick={() => toggleClient(client.clientId)}>${client.totalRealized.toLocaleString()}</TableCell>\n                            <TableCell className=\"text-right cursor-pointer\" onClick={() => toggleClient(client.clientId)}>\n                              <div className=\"flex items-center justify-end gap-2\">\n                                <span className=\"font-semibold\">{client.totalPercentage.toFixed(1)}%</span>\n                                <Progress \n                                  value={Math.min(client.totalPercentage, 100)} \n                                  className=\"h-2 w-20\" \n                                />\n                              </div>\n                            </TableCell>\n                            <TableCell className=\"text-center\">\n                              <Button\n                                variant=\"ghost\"\n                                size=\"icon\"\n                                onClick={(e) => {\n                                  e.stopPropagation();\n                                  openConfigDialog(client.clientId);\n                                }}\n                                data-testid={`button-config-${client.clientId}-fullscreen`}\n                              >\n                                <Settings className=\"h-4 w-4\" />\n                              </Button>\n                            </TableCell>\n                          </TableRow>\n                          {expandedClients.has(client.clientId) && (\n                            <TableRow>\n                              <TableCell colSpan={7} className=\"bg-gray-50 p-0\">\n                                <div className=\"py-4 px-6\">\n                                  <p className=\"text-sm font-semibold mb-3\">Detalhamento por Segmento:</p>\n                                  <Table>\n                                    <TableHeader>\n                                      <TableRow>\n                                        <TableHead className=\"w-8\"></TableHead>\n                                        <TableHead>Segmento</TableHead>\n                                        <TableHead className=\"text-right\">Potencial</TableHead>\n                                        <TableHead className=\"text-right\">C.Vale</TableHead>\n                                        <TableHead className=\"text-right\">Outras</TableHead>\n                                        <TableHead className=\"text-right\">Total</TableHead>\n                                        <TableHead className=\"text-right\">Oportunidades</TableHead>\n                                        <TableHead className=\"text-center\">Status</TableHead>\n                                      </TableRow>\n                                    </TableHeader>\n                                    <TableBody>\n                                      {Object.entries(client.categoryDetails)\n                                        .filter(([_, details]) => details.potential > 0 || details.totalRealized > 0)\n                                        .map(([categoryId, details]) => {\n                                          const isAgroquimicos = details.categoryName.toLowerCase().includes('agroqu');\n                                          const hasSubcategories = Array.isArray(details.subcategories) && details.subcategories.length > 0;\n                                          const categoryKey = `${client.clientId}-${categoryId}`;\n                                          const isCategoryExpanded = expandedCategories.has(categoryKey);\n                                          \n                                          return (\n                                            <>\n                                              <TableRow \n                                                key={categoryId}\n                                                className={hasSubcategories ? 'hover:bg-muted/50 cursor-pointer' : ''}\n                                                onClick={() => {\n                                                  if (hasSubcategories) {\n                                                    toggleCategory(client.clientId, categoryId);\n                                                  }\n                                                }}\n                                              >\n                                                <TableCell className=\"w-8\">\n                                                  {hasSubcategories && (\n                                                    isCategoryExpanded ? (\n                                                      <ChevronDown className=\"h-4 w-4\" />\n                                                    ) : (\n                                                      <ChevronRight className=\"h-4 w-4\" />\n                                                    )\n                                                  )}\n                                                </TableCell>\n                                                <TableCell className=\"font-medium\">{details.categoryName}</TableCell>\n                                                <TableCell className=\"text-right\">${details.potential.toLocaleString()}</TableCell>\n                                                <TableCell className=\"text-right text-green-700 font-medium\">${details.cvaleAmount.toLocaleString()}</TableCell>\n                                                <TableCell \n                                                  className=\"text-right text-orange-600\"\n                                                  onClick={(e) => e.stopPropagation()}\n                                                >\n                                                  <Popover\n                                                    onOpenChange={(open) => {\n                                                      if (open) {\n                                                        handleOpenInlineEdit(client.clientId, categoryId, details.externalAmount);\n                                                      } else {\n                                                        setInlineExternalValue(\"\");\n                                                        setInlineExternalCompany(\"\");\n                                                      }\n                                                    }}\n                                                  >\n                                                    <PopoverTrigger asChild>\n                                                      <button \n                                                        className=\"hover:bg-orange-100 px-2 py-1 rounded transition-colors flex items-center gap-1 w-full justify-end\"\n                                                        data-testid={`button-edit-external-fullscreen-${client.clientId}-${categoryId}`}\n                                                      >\n                                                        <div className=\"flex flex-col items-end\">\n                                                          <span>${details.externalAmount.toLocaleString()}</span>\n                                                          {details.externalCompany && (\n                                                            <span className=\"text-xs text-muted-foreground\">{details.externalCompany}</span>\n                                                          )}\n                                                        </div>\n                                                        <Edit2 className=\"h-3 w-3 opacity-50\" />\n                                                      </button>\n                                                    </PopoverTrigger>\n                                                    <PopoverContent className=\"w-80\" align=\"end\">\n                                                      <div className=\"space-y-3\">\n                                                        <div className=\"space-y-2\">\n                                                          <Label htmlFor={`inline-value-fullscreen-${client.clientId}-${categoryId}`}>\n                                                            Valor (USD)\n                                                          </Label>\n                                                          <Input\n                                                            id={`inline-value-fullscreen-${client.clientId}-${categoryId}`}\n                                                            type=\"number\"\n                                                            placeholder=\"Ex: 5000\"\n                                                            value={inlineExternalValue}\n                                                            onChange={(e) => setInlineExternalValue(e.target.value)}\n                                                            data-testid={`input-inline-value-fullscreen-${client.clientId}-${categoryId}`}\n                                                          />\n                                                        </div>\n                                                        <div className=\"space-y-2\">\n                                                          <Label htmlFor={`inline-company-fullscreen-${client.clientId}-${categoryId}`}>\n                                                            Empresa (opcional)\n                                                          </Label>\n                                                          <Input\n                                                            id={`inline-company-fullscreen-${client.clientId}-${categoryId}`}\n                                                            type=\"text\"\n                                                            placeholder=\"Ex: Empresa Concorrente\"\n                                                            value={inlineExternalCompany}\n                                                            onChange={(e) => setInlineExternalCompany(e.target.value)}\n                                                            data-testid={`input-inline-company-fullscreen-${client.clientId}-${categoryId}`}\n                                                          />\n                                                        </div>\n                                                        <Button\n                                                          onClick={() => handleSaveInlineExternal(client.clientId, categoryId)}\n                                                          disabled={!inlineExternalValue || saveInlineExternalPurchaseMutation.isPending}\n                                                          className=\"w-full\"\n                                                          data-testid={`button-save-inline-fullscreen-${client.clientId}-${categoryId}`}\n                                                        >\n                                                          <Check className=\"h-4 w-4 mr-2\" />\n                                                          {saveInlineExternalPurchaseMutation.isPending ? \"Salvando...\" : \"Salvar\"}\n                                                        </Button>\n                                                      </div>\n                                                    </PopoverContent>\n                                                  </Popover>\n                                                </TableCell>\n                                                <TableCell className=\"text-right font-semibold\">${details.totalRealized.toLocaleString()}</TableCell>\n                                                <TableCell className=\"text-right\">\n                                                  {details.opportunity > 0 ? (\n                                                    <span className=\"text-blue-600 font-medium\">${details.opportunity.toLocaleString()}</span>\n                                                  ) : (\n                                                    <span className=\"text-gray-400\">-</span>\n                                                  )}\n                                                </TableCell>\n                                                <TableCell className=\"text-center\">\n                                                  {details.isClosed ? (\n                                                    <span className=\"px-2 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded\">FECHADO</span>\n                                                  ) : details.percentage >= 50 ? (\n                                                    <span className=\"px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-semibold rounded\">EM PROGRESSO</span>\n                                                  ) : (\n                                                    <span className=\"px-2 py-1 bg-red-100 text-red-700 text-xs font-semibold rounded\">ABERTO</span>\n                                                  )}\n                                                </TableCell>\n                                              </TableRow>\n                                              {/* Subcategory rows for Agroquímicos */}\n                                              {isAgroquimicos && hasSubcategories && isCategoryExpanded && Array.isArray(details.subcategories) && (\n                                                <>\n                                                  {details.subcategories\n                                                    .filter((sub: any) => sub.totalAmount > 0)\n                                                    .map((sub: any) => {\n                                                      const subcategoryKey = `${client.clientId}-${categoryId}-${sub.id}`;\n                                                      const isSubcategoryExpanded = expandedSubcategories.has(subcategoryKey);\n                                                      const hasProducts = Array.isArray(sub.products) && sub.products.length > 0;\n                                                      \n                                                      return (\n                                                        <Fragment key={`${client.clientId}-${categoryId}-${sub.id}`}>\n                                                          <TableRow \n                                                            className={`bg-gray-100/50 ${hasProducts ? 'hover:bg-gray-200/50 cursor-pointer' : ''}`}\n                                                            onClick={() => {\n                                                              if (hasProducts) {\n                                                                toggleSubcategory(client.clientId, categoryId, sub.id);\n                                                              }\n                                                            }}\n                                                          >\n                                                            <TableCell className=\"w-8 pl-4\">\n                                                              {hasProducts && (\n                                                                isSubcategoryExpanded ? (\n                                                                  <ChevronDown className=\"h-3 w-3\" />\n                                                                ) : (\n                                                                  <ChevronRight className=\"h-3 w-3\" />\n                                                                )\n                                                              )}\n                                                            </TableCell>\n                                                            <TableCell className=\"pl-8 text-sm text-gray-600\">↳ {sub.name}</TableCell>\n                                                            <TableCell className=\"text-right text-sm text-gray-600\">-</TableCell>\n                                                            <TableCell className=\"text-right text-sm text-green-700\">${sub.cvaleAmount.toLocaleString()}</TableCell>\n                                                            <TableCell className=\"text-right text-sm text-orange-600\">${sub.externalAmount.toLocaleString()}</TableCell>\n                                                            <TableCell className=\"text-right text-sm text-gray-700 font-medium\">${sub.totalAmount.toLocaleString()}</TableCell>\n                                                            <TableCell className=\"text-right text-sm text-gray-600\">-</TableCell>\n                                                            <TableCell className=\"text-center text-sm text-gray-600\">-</TableCell>\n                                                          </TableRow>\n                                                          \n                                                          {/* Product rows for this subcategory */}\n                                                          {hasProducts && isSubcategoryExpanded && sub.products.map((product: any) => (\n                                                            <TableRow key={`${categoryId}-${sub.id}-${product.productId}`} className=\"bg-gray-50\">\n                                                              <TableCell className=\"w-8\"></TableCell>\n                                                              <TableCell className=\"pl-16 text-xs text-gray-500\">\n                                                                ↳↳ {product.productName}\n                                                              </TableCell>\n                                                              <TableCell className=\"text-right text-xs text-gray-500\">-</TableCell>\n                                                              <TableCell className=\"text-right text-xs text-green-600\">\n                                                                ${product.cvaleAmount.toLocaleString()} ({(product.quantity || 0).toFixed(1)} un)\n                                                              </TableCell>\n                                                              <TableCell className=\"text-right text-xs text-gray-500\">-</TableCell>\n                                                              <TableCell className=\"text-right text-xs text-gray-600\">\n                                                                ${product.cvaleAmount.toLocaleString()}\n                                                              </TableCell>\n                                                              <TableCell className=\"text-right text-xs text-gray-500\">-</TableCell>\n                                                              <TableCell className=\"text-center text-xs text-gray-500\">-</TableCell>\n                                                            </TableRow>\n                                                          ))}\n                                                        </Fragment>\n                                                      );\n                                                    })}\n                                                </>\n                                              )}\n                                            </>\n                                          );\n                                        })}\n                                      {/* Totals row */}\n                                      <TableRow className=\"border-t-2 border-gray-300 bg-gray-100 font-bold\">\n                                        <TableCell className=\"w-8\"></TableCell>\n                                        <TableCell className=\"font-bold\">TOTAL CLIENTE</TableCell>\n                                        <TableCell className=\"text-right\">${client.totalPotential.toLocaleString()}</TableCell>\n                                        <TableCell className=\"text-right text-green-700\">\n                                          ${Object.values(client.categoryDetails).reduce((sum, d) => sum + d.cvaleAmount, 0).toLocaleString()}\n                                        </TableCell>\n                                        <TableCell className=\"text-right text-orange-600\">\n                                          ${Object.values(client.categoryDetails).reduce((sum, d) => sum + d.externalAmount, 0).toLocaleString()}\n                                        </TableCell>\n                                        <TableCell className=\"text-right\">${client.totalRealized.toLocaleString()}</TableCell>\n                                        <TableCell className=\"text-right text-blue-600\">\n                                          ${(client.totalPotential - client.totalRealized > 0 ? client.totalPotential - client.totalRealized : 0).toLocaleString()}\n                                        </TableCell>\n                                        <TableCell className=\"text-center\">\n                                          {client.totalPercentage >= 100 ? (\n                                            <span className=\"px-2 py-1 bg-green-100 text-green-700 text-xs font-semibold rounded\">FECHADO</span>\n                                          ) : client.totalPercentage >= 50 ? (\n                                            <span className=\"px-2 py-1 bg-yellow-100 text-yellow-700 text-xs font-semibold rounded\">EM PROGRESSO</span>\n                                          ) : (\n                                            <span className=\"px-2 py-1 bg-red-100 text-red-700 text-xs font-semibold rounded\">ABERTO</span>\n                                          )}\n                                        </TableCell>\n                                      </TableRow>\n                                    </TableBody>\n                                  </Table>\n                                </div>\n                              </TableCell>\n                            </TableRow>\n                          )}\n                        </>\n                      );\n                    })}\n                    </TableBody>\n                  </Table>\n                </CardContent>\n              </Card>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":101713},"client/src/pages/dashboard.tsx":{"content":"import Navbar from \"@/components/layout/navbar\";\nimport Header from \"@/components/layout/header\";\nimport StatCard from \"@/components/dashboard/stat-card\";\nimport CommissionsChart from \"@/components/dashboard/commissions-chart\";\nimport RecentSales from \"@/components/dashboard/recent-sales\";\nimport OpportunityAlerts from \"@/components/dashboard/opportunity-alerts\";\nimport TopClients from \"@/components/dashboard/top-clients\";\nimport NewSaleModal from \"@/components/modals/new-sale-modal\";\nimport ImportPDFModal from \"@/components/modals/import-pdf-modal\";\nimport { useState, useEffect, useMemo } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { DollarSign, Percent, Target, Users, ChevronDown, MapPin } from \"lucide-react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\n\nexport default function Dashboard() {\n  const [showNewSaleModal, setShowNewSaleModal] = useState(false);\n  const [showImportModal, setShowImportModal] = useState(false);\n  const [selectedSeasonIds, setSelectedSeasonIds] = useState<string[]>([]);\n  const [isPopoverOpen, setIsPopoverOpen] = useState(false);\n\n  const { data: analytics, isLoading: analyticsLoading } = useQuery<{\n    totalSales: number;\n    totalCommissions: number;\n    salesByCategory: { categoryId: string; categoryName: string; total: number; commissions: number }[];\n    topClients: { clientId: string; clientName: string; total: number; percentage: number }[];\n  }>({\n    queryKey: [\"/api/analytics/sales\"],\n  });\n\n  const { data: activeSeason } = useQuery<{ id: string; name: string }>({\n    queryKey: [\"/api/seasons/active\"],\n  });\n\n  const { data: seasons } = useQuery<{ id: string; name: string; type: string; isActive: boolean }[]>({\n    queryKey: [\"/api/seasons\"],\n  });\n\n  const { data: clients } = useQuery<any[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: seasonGoals } = useQuery<any[]>({\n    queryKey: [\"/api/season-goals\"],\n  });\n\n  const { data: sales } = useQuery<any[]>({\n    queryKey: [\"/api/sales\"],\n  });\n\n  const { data: categories } = useQuery<any[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  useEffect(() => {\n    if (activeSeason && selectedSeasonIds.length === 0) {\n      setSelectedSeasonIds([activeSeason.id]);\n    }\n  }, [activeSeason]);\n\n  const openNewSaleModal = () => {\n    setShowNewSaleModal(true);\n  };\n\n  const openImportModal = () => {\n    setShowImportModal(true);\n  };\n\n  const handleSeasonToggle = (seasonId: string) => {\n    setSelectedSeasonIds(prev => \n      prev.includes(seasonId) \n        ? prev.filter(id => id !== seasonId)\n        : [...prev, seasonId]\n    );\n  };\n\n  const handleSelectAll = () => {\n    if (!seasons || seasons.length === 0) return;\n    \n    if (selectedSeasonIds.length === seasons.length) {\n      setSelectedSeasonIds([]);\n    } else {\n      setSelectedSeasonIds(seasons.map(s => s.id));\n    }\n  };\n\n  const selectedSeasons = useMemo(() => {\n    return seasons?.filter(s => selectedSeasonIds.includes(s.id)) || [];\n  }, [seasons, selectedSeasonIds]);\n\n  const buttonText = useMemo(() => {\n    if (selectedSeasonIds.length === 0) return \"Selecione safras\";\n    if (selectedSeasonIds.length === 1) {\n      const season = seasons?.find(s => s.id === selectedSeasonIds[0]);\n      return season?.name || \"1 safra selecionada\";\n    }\n    return `Safras: ${selectedSeasonIds.length} selecionadas`;\n  }, [selectedSeasonIds, seasons]);\n\n  const filteredSales = useMemo(() => {\n    return sales?.filter(s => selectedSeasonIds.includes(s.seasonId)) || [];\n  }, [sales, selectedSeasonIds]);\n\n  const filteredAnalytics = useMemo(() => {\n    const totalSales = filteredSales.reduce((sum, sale) => sum + parseFloat(sale.totalAmount), 0);\n    const totalCommissions = filteredSales.reduce((sum, sale) => sum + parseFloat(sale.commissionAmount), 0);\n\n    const salesByCategory: { [key: string]: { categoryId: string; categoryName: string; total: number; commissions: number } } = {};\n    \n    filteredSales.forEach(sale => {\n      const category = categories?.find(c => c.id === sale.categoryId);\n      if (category) {\n        if (!salesByCategory[sale.categoryId]) {\n          salesByCategory[sale.categoryId] = {\n            categoryId: sale.categoryId,\n            categoryName: category.name,\n            total: 0,\n            commissions: 0\n          };\n        }\n        salesByCategory[sale.categoryId].total += parseFloat(sale.totalAmount);\n        salesByCategory[sale.categoryId].commissions += parseFloat(sale.commissionAmount);\n      }\n    });\n\n    const clientSales: { [key: string]: { clientId: string; clientName: string; total: number } } = {};\n    \n    filteredSales.forEach(sale => {\n      const client = clients?.find(c => c.id === sale.clientId);\n      if (client) {\n        if (!clientSales[sale.clientId]) {\n          clientSales[sale.clientId] = {\n            clientId: sale.clientId,\n            clientName: client.name,\n            total: 0\n          };\n        }\n        clientSales[sale.clientId].total += parseFloat(sale.totalAmount);\n      }\n    });\n\n    const topClients = Object.values(clientSales)\n      .sort((a, b) => b.total - a.total)\n      .slice(0, 5)\n      .map(client => ({\n        ...client,\n        percentage: totalSales > 0 ? (client.total / totalSales) * 100 : 0\n      }));\n\n    return {\n      totalSales,\n      totalCommissions,\n      salesByCategory: Object.values(salesByCategory),\n      topClients\n    };\n  }, [filteredSales, categories, clients]);\n\n  const selectedGoals = useMemo(() => {\n    return seasonGoals?.filter(goal => selectedSeasonIds.includes(goal.seasonId)) || [];\n  }, [seasonGoals, selectedSeasonIds]);\n\n  const aggregatedGoal = useMemo(() => {\n    if (selectedGoals.length === 0) return undefined;\n    \n    if (selectedGoals.length === 1) {\n      return selectedGoals[0];\n    }\n    \n    const aggregated = {\n      id: 'aggregated-goal',\n      seasonId: selectedSeasonIds[0],\n      goalAmount: \"0\",\n      metaAgroquimicos: \"0\",\n      metaEspecialidades: \"0\",\n      metaSementesMilho: \"0\",\n      metaSementesSoja: \"0\",\n      metaSementesTrigo: \"0\",\n      metaSementesDiversas: \"0\",\n      metaFertilizantes: \"0\",\n      metaCorretivos: \"0\",\n      userId: selectedGoals[0].userId\n    };\n    \n    selectedGoals.forEach(goal => {\n      aggregated.goalAmount = (parseFloat(aggregated.goalAmount) + parseFloat(goal.goalAmount || \"0\")).toString();\n      aggregated.metaAgroquimicos = (parseFloat(aggregated.metaAgroquimicos) + parseFloat(goal.metaAgroquimicos || \"0\")).toString();\n      aggregated.metaEspecialidades = (parseFloat(aggregated.metaEspecialidades) + parseFloat(goal.metaEspecialidades || \"0\")).toString();\n      aggregated.metaSementesMilho = (parseFloat(aggregated.metaSementesMilho) + parseFloat(goal.metaSementesMilho || \"0\")).toString();\n      aggregated.metaSementesSoja = (parseFloat(aggregated.metaSementesSoja) + parseFloat(goal.metaSementesSoja || \"0\")).toString();\n      aggregated.metaSementesTrigo = (parseFloat(aggregated.metaSementesTrigo) + parseFloat(goal.metaSementesTrigo || \"0\")).toString();\n      aggregated.metaSementesDiversas = (parseFloat(aggregated.metaSementesDiversas) + parseFloat(goal.metaSementesDiversas || \"0\")).toString();\n      aggregated.metaFertilizantes = (parseFloat(aggregated.metaFertilizantes) + parseFloat(goal.metaFertilizantes || \"0\")).toString();\n      aggregated.metaCorretivos = (parseFloat(aggregated.metaCorretivos) + parseFloat(goal.metaCorretivos || \"0\")).toString();\n    });\n    \n    return aggregated;\n  }, [selectedGoals, selectedSeasonIds]);\n\n  const totalGoal = useMemo(() => {\n    return selectedGoals.reduce((sum, goal) => sum + parseFloat(goal.goalAmount), 0);\n  }, [selectedGoals]);\n\n  const totalRealized = useMemo(() => {\n    return filteredSales.reduce((sum, sale) => sum + parseFloat(sale.totalAmount), 0);\n  }, [filteredSales]);\n\n  const goalAchievement = useMemo(() => {\n    return totalGoal > 0\n      ? Math.min(100, Math.round((totalRealized / totalGoal) * 100))\n      : 0;\n  }, [totalRealized, totalGoal]);\n\n  const totalClients = clients?.length || 0;\n  \n  const commissionPercentage = filteredAnalytics.totalSales > 0\n    ? ((filteredAnalytics.totalCommissions / filteredAnalytics.totalSales) * 100).toFixed(2)\n    : '0.00';\n\n  const seasonsSubtitle = selectedSeasonIds.length > 0 ? \"Safras selecionadas\" : \"Nenhuma safra selecionada\";\n\n  if (analyticsLoading) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-32 w-32 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-screen flex flex-col overflow-hidden\" data-testid=\"dashboard-container\">\n      <Header \n        onNewSale={openNewSaleModal}\n        title=\"Dashboard Principal\"\n        subtitle=\"Visão geral de vendas e comissões\"\n      />\n      <Navbar />\n      \n      <main className=\"flex-1 overflow-y-auto\">\n\n        <div className=\"p-8\">\n          {/* Season Filter */}\n          <div className=\"mb-6\">\n            <Popover open={isPopoverOpen} onOpenChange={setIsPopoverOpen}>\n              <PopoverTrigger asChild>\n                <Button \n                  variant=\"outline\" \n                  className=\"w-auto min-w-[250px] justify-between bg-white dark:bg-gray-800 border-green-200 dark:border-green-800 hover:bg-green-50 dark:hover:bg-green-900/20\"\n                  data-testid=\"button-season-filter\"\n                >\n                  <span className=\"text-green-700 dark:text-green-400 font-medium\">{buttonText}</span>\n                  <ChevronDown className=\"h-4 w-4 ml-2 text-green-600 dark:text-green-500\" />\n                </Button>\n              </PopoverTrigger>\n              <PopoverContent className=\"w-80\" align=\"start\" data-testid=\"popover-season-filter\">\n                <div className=\"space-y-4\">\n                  <div className=\"font-semibold text-sm text-green-700 dark:text-green-400\">\n                    Selecionar Safras\n                  </div>\n                  \n                  <div className=\"flex items-center space-x-2 pb-2 border-b border-green-100 dark:border-green-800\">\n                    <Checkbox \n                      id=\"select-all\"\n                      checked={selectedSeasonIds.length === seasons?.length && seasons?.length > 0}\n                      onCheckedChange={handleSelectAll}\n                      data-testid=\"checkbox-select-all-seasons\"\n                    />\n                    <label\n                      htmlFor=\"select-all\"\n                      className=\"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer\"\n                    >\n                      Selecionar Todas\n                    </label>\n                  </div>\n\n                  <div className=\"space-y-2 max-h-64 overflow-y-auto\">\n                    {seasons?.map((season) => (\n                      <div key={season.id} className=\"flex items-center space-x-2\">\n                        <Checkbox \n                          id={`season-${season.id}`}\n                          checked={selectedSeasonIds.includes(season.id)}\n                          onCheckedChange={() => handleSeasonToggle(season.id)}\n                          data-testid={`checkbox-season-${season.id}`}\n                        />\n                        <label\n                          htmlFor={`season-${season.id}`}\n                          className=\"text-sm leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer flex-1\"\n                        >\n                          {season.name}\n                          {season.isActive && (\n                            <span className=\"ml-2 text-xs text-green-600 dark:text-green-400 font-medium\">\n                              (Ativa)\n                            </span>\n                          )}\n                        </label>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              </PopoverContent>\n            </Popover>\n          </div>\n\n          {/* Stats Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8\">\n            <StatCard\n              title=\"Vendas Totais (USD)\"\n              value={`$${filteredAnalytics.totalSales.toLocaleString()}`}\n              icon={DollarSign}\n              subtitle={seasonsSubtitle}\n            />\n            \n            <StatCard\n              title=\"Comissões Totais (USD)\"\n              value={`$${filteredAnalytics.totalCommissions.toLocaleString()}`}\n              icon={Percent}\n              subtitle={`${commissionPercentage}% do total de vendas`}\n              color=\"secondary\"\n            />\n            \n            <StatCard\n              title=\"Atingimento de Meta\"\n              value={`${goalAchievement}%`}\n              icon={Target}\n              subtitle={totalGoal > 0 ? `Meta: $${totalGoal.toLocaleString()}` : \"Sem meta definida\"}\n              color=\"accent\"\n              showProgress={true}\n              progressValue={goalAchievement}\n            />\n            \n            <StatCard\n              title=\"Clientes Ativos\"\n              value={totalClients.toString()}\n              icon={Users}\n              subtitle=\"Total cadastrado\"\n              color=\"chart-4\"\n            />\n          </div>\n\n          {/* CRM Mobile Card - Temporarily hidden */}\n          {/* <div className=\"mb-8\">\n            <div className=\"bg-gradient-to-br from-green-500 to-green-700 dark:from-green-600 dark:to-green-800 rounded-lg p-6 shadow-lg hover:shadow-xl transition-shadow cursor-pointer\" onClick={() => window.location.href = '/crm'}>\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"bg-white/20 p-3 rounded-lg\">\n                    <MapPin className=\"h-8 w-8 text-white\" />\n                  </div>\n                  <div>\n                    <h3 className=\"text-white text-xl font-bold\">CRM Móvel</h3>\n                    <p className=\"text-white/90 text-sm\">Gestão de visitas e rastreamento GPS</p>\n                  </div>\n                </div>\n                <Button variant=\"secondary\" className=\"bg-white text-green-700 hover:bg-white/90\">\n                  Acessar →\n                </Button>\n              </div>\n            </div>\n          </div> */}\n\n          {/* Charts Row & Top Clients */}\n          <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8\">\n            <div className=\"lg:col-span-2\">\n              <CommissionsChart \n                seasonGoal={aggregatedGoal}\n                salesData={filteredSales}\n                categories={categories || []}\n              />\n            </div>\n            <TopClients clients={filteredAnalytics.topClients} />\n          </div>\n\n          {/* Recent Sales */}\n          <div className=\"mb-8\">\n            <RecentSales />\n          </div>\n\n          {/* Opportunity Alerts */}\n          <div className=\"mb-8\">\n            <OpportunityAlerts />\n          </div>\n        </div>\n      </main>\n\n      {/* Modals */}\n      <NewSaleModal \n        isOpen={showNewSaleModal} \n        onClose={() => setShowNewSaleModal(false)} \n      />\n      <ImportPDFModal \n        isOpen={showImportModal} \n        onClose={() => setShowImportModal(false)} \n      />\n    </div>\n  );\n}\n","size_bytes":15476},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","size_bytes":1977},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","size_bytes":140},"server/storage.ts":{"content":"import { randomUUID } from \"crypto\";\nimport type { \n  User, InsertUser, Category, InsertCategory, Product, InsertProduct,\n  Region, InsertRegion, Client, InsertClient, Season, InsertSeason,\n  SeasonGoal, InsertSeasonGoal, Sale, InsertSale, SeasonParameter,\n  InsertSeasonParameter, SalesHistory, MarketInvestmentRate, ClientMarketRate, InsertClientMarketRate,\n  ClientMarketValue, InsertClientMarketValue,\n  MarketBenchmark, InsertMarketBenchmark, ExternalPurchase, InsertExternalPurchase,\n  ClientFamilyRelation, InsertClientFamilyRelation, AlertSettings, InsertAlertSettings,\n  Alert, InsertAlert, PurchaseHistory, InsertPurchaseHistory, PurchaseHistoryItem, InsertPurchaseHistoryItem,\n  MasterClient, InsertMasterClient, UserClientLink, InsertUserClientLink,\n  BarterProduct, InsertBarterProduct, BarterSettings, InsertBarterSettings,\n  BarterSimulation, InsertBarterSimulation, BarterSimulationItem, InsertBarterSimulationItem,\n  SalesTarget, InsertSalesTarget\n} from \"@shared/schema\";\nimport { db, pool } from './db';\nimport { users, categories, products, regions, clients, seasons, seasonGoals, sales, seasonParameters, marketInvestmentRates, clientMarketRates, clientMarketValues, marketBenchmarks, externalPurchases, clientFamilyRelations, alertSettings, alerts, purchaseHistory, purchaseHistoryItems, masterClients, userClientLinks, barterProducts, barterSettings, barterSimulations, barterSimulationItems, salesTargets, systemSettings } from '@shared/schema';\nimport { eq, and, desc, asc, sql, inArray } from 'drizzle-orm';\nimport session from \"express-session\";\nimport connectPg from \"connect-pg-simple\";\n\nconst PostgresSessionStore = connectPg(session);\n\nexport interface IStorage {\n  sessionStore: session.Store;\n  // Users\n  getUser(id: string): Promise<User | undefined>;\n  getUserByUsername(username: string): Promise<User | undefined>;\n  getAllUsers(): Promise<User[]>;\n  createUser(user: InsertUser): Promise<User>;\n  updateUser(id: string, user: Partial<InsertUser>): Promise<User | undefined>;\n  deleteUser(id: string): Promise<boolean>;\n\n  // Categories\n  getAllCategories(): Promise<Category[]>;\n  getCategory(id: string): Promise<Category | undefined>;\n  createCategory(category: InsertCategory): Promise<Category>;\n  updateCategory(id: string, category: Partial<InsertCategory>): Promise<Category | undefined>;\n\n  // Products\n  getAllProducts(): Promise<Product[]>;\n  getProductsByCategory(categoryId: string): Promise<Product[]>;\n  createProduct(product: InsertProduct): Promise<Product>;\n  updateProduct(id: string, product: Partial<InsertProduct>): Promise<Product | undefined>;\n\n  // Regions\n  getAllRegions(): Promise<Region[]>;\n  createRegion(region: InsertRegion): Promise<Region>;\n\n  // Clients\n  getAllClients(): Promise<Client[]>;\n  getClient(id: string): Promise<Client | undefined>;\n  getTop80_20Clients(): Promise<Client[]>;\n  createClient(client: InsertClient): Promise<Client>;\n  updateClient(id: string, client: Partial<InsertClient>): Promise<Client | undefined>;\n  deleteClient(id: string): Promise<boolean>;\n  getClientsForUser(userId: string, top8020Only?: boolean): Promise<Client[]>;\n\n  // Master Clients\n  getAllMasterClients(): Promise<MasterClient[]>;\n  getMasterClient(id: string): Promise<MasterClient | undefined>;\n  findMasterClientByName(name: string): Promise<MasterClient | undefined>;\n  createMasterClient(client: InsertMasterClient): Promise<MasterClient>;\n  updateMasterClient(id: string, client: Partial<InsertMasterClient>): Promise<MasterClient | undefined>;\n  deleteMasterClient(id: string): Promise<boolean>;\n  mergeMasterClients(sourceId: string, targetId: string): Promise<boolean>;\n\n  // User Client Links\n  getUserClientLinks(userId: string): Promise<UserClientLink[]>;\n  getUserClientLink(userId: string, masterClientId: string): Promise<UserClientLink | undefined>;\n  createUserClientLink(link: InsertUserClientLink): Promise<UserClientLink>;\n  updateUserClientLink(id: string, link: Partial<InsertUserClientLink>): Promise<UserClientLink | undefined>;\n  deleteUserClientLink(id: string): Promise<boolean>;\n\n  // Seasons\n  getAllSeasons(): Promise<Season[]>;\n  getActiveSeason(): Promise<Season | undefined>;\n  createSeason(season: InsertSeason): Promise<Season>;\n\n  // Season Goals\n  getAllSeasonGoals(): Promise<SeasonGoal[]>;\n  getSeasonGoal(seasonId: string, userId: string): Promise<SeasonGoal | undefined>;\n  createSeasonGoal(goal: InsertSeasonGoal): Promise<SeasonGoal>;\n  updateSeasonGoal(id: string, goal: Partial<InsertSeasonGoal>): Promise<SeasonGoal | undefined>;\n\n  // Sales\n  getAllSales(): Promise<Sale[]>;\n  getSale(id: string): Promise<Sale | undefined>;\n  getSalesByClient(clientId: string): Promise<Sale[]>;\n  getSalesBySeason(seasonId: string): Promise<Sale[]>;\n  getSaleByOrderCode(orderCode: string, userId: string): Promise<Sale | undefined>;\n  getExistingOrderCodes(userId: string): Promise<Set<string>>;\n  createSale(sale: InsertSale): Promise<Sale>;\n  updateSale(id: string, sale: Partial<InsertSale>): Promise<Sale | undefined>;\n  \n  // Import Batches\n  getImportBatches(): Promise<Array<{\n    batchId: string;\n    importDate: Date;\n    salesCount: number;\n    totalAmount: number;\n    totalCommissions: number;\n    userId: string;\n  }>>;\n  deleteImportBatch(batchId: string): Promise<void>;\n\n  // Season Parameters\n  getAllSeasonParameters(): Promise<SeasonParameter[]>;\n  createSeasonParameter(parameter: InsertSeasonParameter): Promise<SeasonParameter>;\n\n  // Market Investment Rates\n  getMarketInvestmentRates(): Promise<MarketInvestmentRate[]>;\n  \n  // Client Market Rates\n  getClientMarketRates(clientId: string, userId: string, seasonId: string): Promise<ClientMarketRate[]>;\n  upsertClientMarketRate(rate: InsertClientMarketRate): Promise<ClientMarketRate>;\n  deleteClientMarketRate(clientId: string, categoryId: string, userId: string, seasonId: string): Promise<boolean>;\n\n  // Client Market Values (Mercado)\n  getClientMarketValues(clientId: string, userId: string, seasonId: string): Promise<ClientMarketValue[]>;\n  upsertClientMarketValue(value: InsertClientMarketValue): Promise<ClientMarketValue>;\n  deleteClientMarketValue(clientId: string, categoryId: string, userId: string, seasonId: string): Promise<boolean>;\n\n  // Market Benchmarks\n  getMarketBenchmarks(userId: string, seasonId: string): Promise<MarketBenchmark[]>;\n  upsertMarketBenchmark(benchmark: InsertMarketBenchmark): Promise<MarketBenchmark>;\n  deleteMarketBenchmark(userId: string, categoryId: string, seasonId: string): Promise<boolean>;\n\n  // Market Potential\n  getMarketPotentialByCategory(userId: string, seasonId: string): Promise<Array<{\n    categoryId: string;\n    categoryName: string;\n    marketArea: number;\n    investmentPerHa: number;\n    totalPotential: number;\n  }>>;\n\n  // External Purchases\n  getExternalPurchases(clientId: string, userId: string, seasonId: string): Promise<ExternalPurchase[]>;\n  upsertExternalPurchase(purchase: InsertExternalPurchase): Promise<ExternalPurchase>;\n  deleteExternalPurchase(userId: string, clientId: string, categoryId: string, seasonId: string): Promise<boolean>;\n\n  // Client Family Relations\n  getClientFamilyRelations(clientId: string, userId: string): Promise<string[]>;\n  getBatchClientFamilyRelations(clientIds: string[], userId: string): Promise<Map<string, string[]>>;\n  addClientFamilyRelation(relation: InsertClientFamilyRelation): Promise<ClientFamilyRelation>;\n  removeClientFamilyRelation(clientId: string, relatedClientId: string, userId: string): Promise<boolean>;\n\n  // Alert Settings\n  getAlertSettings(userId: string): Promise<AlertSettings | undefined>;\n  upsertAlertSettings(settings: InsertAlertSettings): Promise<AlertSettings>;\n\n  // Alerts\n  getAlerts(userId: string): Promise<Alert[]>;\n  getUnreadAlertsCount(userId: string): Promise<number>;\n  createAlert(alert: InsertAlert): Promise<Alert>;\n  markAlertAsRead(alertId: string, userId: string): Promise<boolean>;\n  markAllAlertsAsRead(userId: string): Promise<boolean>;\n  deleteAlert(alertId: string, userId: string): Promise<boolean>;\n\n  // Purchase History\n  getPurchaseHistories(userId: string, clientId?: string, seasonId?: string): Promise<PurchaseHistory[]>;\n  getPurchaseHistory(id: string, userId: string): Promise<PurchaseHistory | undefined>;\n  createPurchaseHistory(history: InsertPurchaseHistory): Promise<PurchaseHistory>;\n  deletePurchaseHistory(id: string, userId: string): Promise<boolean>;\n  getPurchaseHistoryItems(purchaseHistoryId: string): Promise<PurchaseHistoryItem[]>;\n  createPurchaseHistoryItem(item: InsertPurchaseHistoryItem): Promise<PurchaseHistoryItem>;\n\n  // Analytics\n  getSalesAnalytics(seasonId?: string, userId?: string): Promise<{\n    totalSales: number;\n    totalCommissions: number;\n    salesByCategory: { categoryId: string; categoryName: string; total: number; commissions: number }[];\n    topClients: { clientId: string; clientName: string; total: number; percentage: number }[];\n  }>;\n\n  getOpportunityAlerts(clientId?: string): Promise<{\n    clientId: string;\n    clientName: string;\n    missingProducts: string[];\n    category: string;\n    region: string;\n    severity: 'high' | 'medium' | 'low';\n  }[]>;\n\n  // Barter Module\n  getAllBarterProducts(): Promise<BarterProduct[]>;\n  createBarterProduct(product: InsertBarterProduct): Promise<BarterProduct>;\n  updateBarterProduct(id: string, product: Partial<InsertBarterProduct>): Promise<BarterProduct | undefined>;\n  deleteBarterProduct(id: string): Promise<boolean>;\n  deleteAllBarterProducts(): Promise<void>;\n  getAllBarterSettings(): Promise<BarterSettings[]>;\n  upsertBarterSetting(key: string, value: string, description?: string): Promise<BarterSettings>;\n  getBarterSimulationsByUser(userId: string): Promise<BarterSimulation[]>;\n  getBarterSimulation(id: string): Promise<BarterSimulation | undefined>;\n  createBarterSimulation(simulation: InsertBarterSimulation, items: InsertBarterSimulationItem[]): Promise<BarterSimulation>;\n  updateBarterSimulation(id: string, simulation: Partial<InsertBarterSimulation>): Promise<BarterSimulation | undefined>;\n  deleteBarterSimulation(id: string): Promise<boolean>;\n\n  // Sales Targets - Kanban de Metas\n  getKanbanData(userId: string, seasonId: string): Promise<any>;\n  getSalesTargets(userId: string, seasonId?: string): Promise<any[]>;\n  createSalesTarget(userId: string, clientId: string, segmento: string, valorCapturado: number, seasonId: string, subcategories?: Record<string, number>): Promise<any>;\n  updateSalesTarget(id: string, valorCapturado: number, subcategories?: Record<string, number>): Promise<any>;\n  deleteSalesTarget(id: string, userId: string): Promise<boolean>;\n\n  // System Settings\n  getSystemSettings(): Promise<{ allowUserRegistration: boolean } | undefined>;\n}\n\nexport class MemStorage implements IStorage {\n  sessionStore: session.Store;\n  private users: Map<string, User> = new Map();\n  private categories: Map<string, Category> = new Map();\n  private products: Map<string, Product> = new Map();\n  private regions: Map<string, Region> = new Map();\n  private clients: Map<string, Client> = new Map();\n  private masterClients: Map<string, MasterClient> = new Map();\n  private userClientLinks: Map<string, UserClientLink> = new Map();\n  private seasons: Map<string, Season> = new Map();\n  private seasonGoals: Map<string, SeasonGoal> = new Map();\n  private sales: Map<string, Sale> = new Map();\n  private seasonParameters: Map<string, SeasonParameter> = new Map();\n  private barterProducts: Map<string, any> = new Map();\n  private barterSettings: Map<string, any> = new Map();\n  private barterSimulations: Map<string, any> = new Map();\n\n  constructor() {\n    this.sessionStore = new session.MemoryStore();\n    this.initializeDefaultData();\n  }\n\n  private initializeDefaultData() {\n    // Initialize categories based on commission table\n    const categoryData = [\n      {\n        id: \"cat-fertilizantes\",\n        name: \"Fertilizantes\",\n        type: \"fertilizantes\",\n        greenCommission: \"0.30\",\n        greenMarginMin: \"7.00\",\n        yellowCommission: \"0.20\",\n        yellowMarginMin: \"6.00\",\n        yellowMarginMax: \"6.99\",\n        redCommission: \"0.18\",\n        redMarginMin: \"4.00\",\n        redMarginMax: \"4.99\",\n        belowListCommission: \"0.15\",\n        defaultIva: \"10.00\",\n      },\n      {\n        id: \"cat-sem-diversas\",\n        name: \"Sementes Diversas\",\n        type: \"sementes\",\n        greenCommission: \"1.00\",\n        greenMarginMin: \"13.00\",\n        yellowCommission: \"0.70\",\n        yellowMarginMin: \"10.00\",\n        yellowMarginMax: \"12.99\",\n        redCommission: \"0.40\",\n        redMarginMin: \"8.00\",\n        redMarginMax: \"9.99\",\n        belowListCommission: \"0.15\",\n        defaultIva: \"10.00\",\n      },\n      {\n        id: \"cat-sem-trigo\",\n        name: \"Sementes Trigo\",\n        type: \"sementes\",\n        greenCommission: \"1.00\",\n        greenMarginMin: \"13.00\",\n        yellowCommission: \"0.70\",\n        yellowMarginMin: \"10.00\",\n        yellowMarginMax: \"12.99\",\n        redCommission: \"0.40\",\n        redMarginMin: \"8.00\",\n        redMarginMax: \"9.99\",\n        belowListCommission: \"0.15\",\n        defaultIva: \"10.00\",\n      },\n      {\n        id: \"cat-sem-milho\",\n        name: \"Sementes Milho\",\n        type: \"sementes\",\n        greenCommission: \"2.50\",\n        greenMarginMin: \"20.00\",\n        yellowCommission: \"2.00\",\n        yellowMarginMin: \"15.00\",\n        yellowMarginMax: \"19.99\",\n        redCommission: \"1.50\",\n        redMarginMin: \"10.00\",\n        redMarginMax: \"14.99\",\n        belowListCommission: \"0.50\",\n        defaultIva: \"10.00\",\n      },\n      {\n        id: \"cat-sem-soja\",\n        name: \"Sementes Soja\",\n        type: \"sementes\",\n        greenCommission: \"2.50\",\n        greenMarginMin: \"20.00\",\n        yellowCommission: \"2.00\",\n        yellowMarginMin: \"15.00\",\n        yellowMarginMax: \"19.99\",\n        redCommission: \"1.50\",\n        redMarginMin: \"10.00\",\n        redMarginMax: \"14.99\",\n        belowListCommission: \"0.50\",\n        defaultIva: \"10.00\",\n      },\n      {\n        id: \"cat-especialidades\",\n        name: \"Especialidades\",\n        type: \"especialidades\",\n        greenCommission: \"4.00\",\n        greenMarginMin: \"25.00\",\n        yellowCommission: \"3.00\",\n        yellowMarginMin: \"20.00\",\n        yellowMarginMax: \"24.99\",\n        redCommission: \"2.00\",\n        redMarginMin: \"15.00\",\n        redMarginMax: \"19.99\",\n        belowListCommission: \"1.00\",\n        defaultIva: \"10.00\",\n      },\n      {\n        id: \"cat-agroquimicos\",\n        name: \"Agroquímicos\",\n        type: \"agroquimicos\",\n        greenCommission: \"1.00\",\n        greenMarginMin: \"13.00\",\n        yellowCommission: \"0.70\",\n        yellowMarginMin: \"10.00\",\n        yellowMarginMax: \"12.99\",\n        redCommission: \"0.40\",\n        redMarginMin: \"7.00\",\n        redMarginMax: \"9.99\",\n        belowListCommission: \"0.15\",\n        defaultIva: \"10.00\",\n      },\n    ];\n\n    categoryData.forEach(cat => {\n      this.categories.set(cat.id, cat as Category);\n    });\n\n    // Initialize regions\n    const regionData = [\n      { id: \"reg-alto-parana\", name: \"Alto Paraná\", country: \"Paraguay\" },\n      { id: \"reg-itapua\", name: \"Itapúa\", country: \"Paraguay\" },\n      { id: \"reg-canindeyu\", name: \"Canindeyú\", country: \"Paraguay\" },\n      { id: \"reg-caaguazu\", name: \"Caaguazú\", country: \"Paraguay\" },\n    ];\n\n    regionData.forEach(region => {\n      this.regions.set(region.id, region as Region);\n    });\n\n    // Initialize season parameters\n    const seasonParamData = [\n      {\n        id: \"sp-soja-verao\",\n        type: \"soja_verao\",\n        dueDateMonth: 3,\n        dueDateDay: 30,\n        labelPattern: \"Soja {year}/{next_year}\",\n      },\n      {\n        id: \"sp-soja-verao-alt\",\n        type: \"soja_verao\",\n        dueDateMonth: 4,\n        dueDateDay: 30,\n        labelPattern: \"Soja {year}/{next_year}\",\n      },\n      {\n        id: \"sp-soja-safrinha\",\n        type: \"soja_safrinha\",\n        dueDateMonth: 6,\n        dueDateDay: 30,\n        labelPattern: \"Soja Safrinha {year}\",\n      },\n      {\n        id: \"sp-milho\",\n        type: \"milho\",\n        dueDateMonth: 8,\n        dueDateDay: 30,\n        labelPattern: \"Milho {year}/{year}\",\n      },\n      {\n        id: \"sp-trigo\",\n        type: \"trigo\",\n        dueDateMonth: 10,\n        dueDateDay: 30,\n        labelPattern: \"Trigo {year}\",\n      },\n    ];\n\n    seasonParamData.forEach(param => {\n      this.seasonParameters.set(param.id, param as SeasonParameter);\n    });\n  }\n\n  // User methods\n  async getUser(id: string): Promise<User | undefined> {\n    return this.users.get(id);\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    return Array.from(this.users.values()).find(user => user.username === username);\n  }\n\n  async createUser(insertUser: InsertUser): Promise<User> {\n    const id = randomUUID();\n    const user: User = { \n      ...insertUser, \n      id,\n      role: insertUser.role ?? \"vendedor\"\n    };\n    this.users.set(id, user);\n    return user;\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    return Array.from(this.users.values());\n  }\n\n  async updateUser(id: string, user: Partial<InsertUser>): Promise<User | undefined> {\n    const existing = this.users.get(id);\n    if (!existing) return undefined;\n    \n    const updated = { ...existing, ...user };\n    this.users.set(id, updated);\n    return updated;\n  }\n\n  async deleteUser(id: string): Promise<boolean> {\n    return this.users.delete(id);\n  }\n\n  // Category methods\n  async getAllCategories(): Promise<Category[]> {\n    return Array.from(this.categories.values());\n  }\n\n  async getCategory(id: string): Promise<Category | undefined> {\n    return this.categories.get(id);\n  }\n\n  async createCategory(category: InsertCategory): Promise<Category> {\n    const id = randomUUID();\n    const newCategory: Category = { \n      ...category, \n      id,\n      defaultIva: category.defaultIva ?? \"10.00\"\n    };\n    this.categories.set(id, newCategory);\n    return newCategory;\n  }\n\n  async updateCategory(id: string, category: Partial<InsertCategory>): Promise<Category | undefined> {\n    const existing = this.categories.get(id);\n    if (!existing) return undefined;\n    \n    const updated = { ...existing, ...category };\n    this.categories.set(id, updated);\n    return updated;\n  }\n\n  // Product methods\n  async getAllProducts(): Promise<Product[]> {\n    return Array.from(this.products.values()).filter(p => p.isActive);\n  }\n\n  async getProductsByCategory(categoryId: string): Promise<Product[]> {\n    return Array.from(this.products.values()).filter(p => p.categoryId === categoryId && p.isActive);\n  }\n\n  async createProduct(product: InsertProduct): Promise<Product> {\n    const id = randomUUID();\n    const newProduct: Product = { \n      ...product, \n      id,\n      subcategoryId: product.subcategoryId ?? null,\n      description: product.description ?? null,\n      marca: product.marca ?? null,\n      packageSize: product.packageSize ?? null,\n      segment: product.segment ?? null,\n      isActive: product.isActive ?? true\n    };\n    this.products.set(id, newProduct);\n    return newProduct;\n  }\n\n  async updateProduct(id: string, product: Partial<InsertProduct>): Promise<Product | undefined> {\n    const existing = this.products.get(id);\n    if (!existing) return undefined;\n    \n    const updated = { ...existing, ...product };\n    this.products.set(id, updated);\n    return updated;\n  }\n\n  // Region methods\n  async getAllRegions(): Promise<Region[]> {\n    return Array.from(this.regions.values());\n  }\n\n  async createRegion(region: InsertRegion): Promise<Region> {\n    const id = randomUUID();\n    const newRegion: Region = { \n      ...region, \n      id,\n      country: region.country ?? \"Paraguay\"\n    };\n    this.regions.set(id, newRegion);\n    return newRegion;\n  }\n\n  // Client methods\n  async getAllClients(): Promise<Client[]> {\n    return Array.from(this.clients.values()).filter(c => c.isActive);\n  }\n\n  async getClient(id: string): Promise<Client | undefined> {\n    return this.clients.get(id);\n  }\n\n  async getTop80_20Clients(): Promise<Client[]> {\n    return Array.from(this.clients.values()).filter(c => c.isTop80_20 && c.isActive);\n  }\n\n  async createClient(client: InsertClient): Promise<Client> {\n    const id = randomUUID();\n    const newClient: Client = { \n      ...client, \n      id,\n      cultures: client.cultures ?? [],\n      plantingProgress: client.plantingProgress ?? \"0.00\",\n      isTop80_20: client.isTop80_20 ?? false,\n      includeInMarketArea: client.includeInMarketArea ?? false,\n      isActive: client.isActive ?? true,\n      userId: client.userId ?? null\n    };\n    this.clients.set(id, newClient);\n    return newClient;\n  }\n\n  async updateClient(id: string, client: Partial<InsertClient>): Promise<Client | undefined> {\n    const existing = this.clients.get(id);\n    if (!existing) return undefined;\n    \n    const updated = { ...existing, ...client };\n    this.clients.set(id, updated);\n    return updated;\n  }\n\n  async deleteClient(id: string): Promise<boolean> {\n    return this.clients.delete(id);\n  }\n\n  async getClientsForUser(userId: string, top8020Only?: boolean): Promise<Client[]> {\n    // Para MemStorage, retornar clientes antigos (tabela clients)\n    const allClients = Array.from(this.clients.values());\n    return allClients.filter(c => \n      c.userId === userId && \n      c.isActive &&\n      (!top8020Only || c.isTop80_20)\n    );\n  }\n\n  // Master Clients (stub methods for MemStorage - not used in production)\n  async getAllMasterClients(): Promise<MasterClient[]> {\n    return Array.from(this.masterClients.values()).filter(c => c.isActive);\n  }\n\n  async getMasterClient(id: string): Promise<MasterClient | undefined> {\n    return this.masterClients.get(id);\n  }\n\n  async findMasterClientByName(name: string): Promise<MasterClient | undefined> {\n    const normalizedSearch = name.toUpperCase().trim().replace(/[.,\\-\\s]/g, '');\n    return Array.from(this.masterClients.values()).find(client => {\n      const normalizedClientName = client.name.toUpperCase().trim().replace(/[.,\\-\\s]/g, '');\n      return normalizedClientName === normalizedSearch && client.isActive;\n    });\n  }\n\n  async createMasterClient(client: InsertMasterClient): Promise<MasterClient> {\n    const id = randomUUID();\n    const now = new Date();\n    const newClient: MasterClient = { \n      ...client, \n      id,\n      regionId: client.regionId ?? null,\n      plantingArea: client.plantingArea ?? null,\n      cultures: client.cultures ?? [],\n      isActive: client.isActive ?? true,\n      createdAt: now,\n      updatedAt: now\n    };\n    this.masterClients.set(id, newClient);\n    return newClient;\n  }\n\n  async updateMasterClient(id: string, client: Partial<InsertMasterClient>): Promise<MasterClient | undefined> {\n    const existing = this.masterClients.get(id);\n    if (!existing) return undefined;\n    \n    const updated = { \n      ...existing, \n      ...client,\n      updatedAt: new Date()\n    };\n    this.masterClients.set(id, updated);\n    return updated;\n  }\n\n  async deleteMasterClient(id: string): Promise<boolean> {\n    return this.masterClients.delete(id);\n  }\n\n  async mergeMasterClients(sourceId: string, targetId: string): Promise<boolean> {\n    Array.from(this.userClientLinks.values()).forEach(link => {\n      if (link.masterClientId === sourceId) {\n        link.masterClientId = targetId;\n      }\n    });\n    this.masterClients.delete(sourceId);\n    return true;\n  }\n\n  // User Client Links (stub methods for MemStorage)\n  async getUserClientLinks(userId: string): Promise<UserClientLink[]> {\n    return Array.from(this.userClientLinks.values()).filter(\n      link => link.userId === userId && link.isActive\n    );\n  }\n\n  async getUserClientLink(userId: string, masterClientId: string): Promise<UserClientLink | undefined> {\n    return Array.from(this.userClientLinks.values()).find(\n      link => link.userId === userId && link.masterClientId === masterClientId\n    );\n  }\n\n  async createUserClientLink(link: InsertUserClientLink): Promise<UserClientLink> {\n    const id = randomUUID();\n    const newLink: UserClientLink = { \n      ...link, \n      id,\n      customName: link.customName ?? null,\n      plantingArea: link.plantingArea ?? null,\n      cultures: link.cultures ?? null,\n      plantingProgress: link.plantingProgress ?? \"0.00\",\n      isTop80_20: link.isTop80_20 ?? false,\n      isActive: link.isActive ?? true,\n      createdAt: new Date()\n    };\n    this.userClientLinks.set(id, newLink);\n    return newLink;\n  }\n\n  async updateUserClientLink(id: string, link: Partial<InsertUserClientLink>): Promise<UserClientLink | undefined> {\n    const existing = this.userClientLinks.get(id);\n    if (!existing) return undefined;\n    \n    const updated = { ...existing, ...link };\n    this.userClientLinks.set(id, updated);\n    return updated;\n  }\n\n  async deleteUserClientLink(id: string): Promise<boolean> {\n    return this.userClientLinks.delete(id);\n  }\n\n  // Season methods\n  async getAllSeasons(): Promise<Season[]> {\n    return Array.from(this.seasons.values()).filter(s => s.isActive);\n  }\n\n  async getActiveSeason(): Promise<Season | undefined> {\n    const now = new Date();\n    return Array.from(this.seasons.values()).find(s => \n      s.isActive && now >= s.startDate && now <= s.endDate\n    );\n  }\n\n  async createSeason(season: InsertSeason): Promise<Season> {\n    const id = randomUUID();\n    const newSeason: Season = { \n      ...season, \n      id,\n      isActive: season.isActive ?? true\n    };\n    this.seasons.set(id, newSeason);\n    return newSeason;\n  }\n\n  // Season Goal methods\n  async getAllSeasonGoals(): Promise<SeasonGoal[]> {\n    return Array.from(this.seasonGoals.values());\n  }\n\n  async getSeasonGoal(seasonId: string, userId: string): Promise<SeasonGoal | undefined> {\n    return Array.from(this.seasonGoals.values()).find(g => \n      g.seasonId === seasonId && g.userId === userId\n    );\n  }\n\n  async createSeasonGoal(goal: InsertSeasonGoal): Promise<SeasonGoal> {\n    const id = randomUUID();\n    const newGoal: SeasonGoal = { \n      ...goal, \n      id,\n      metaAgroquimicos: goal.metaAgroquimicos ?? \"0\",\n      metaEspecialidades: goal.metaEspecialidades ?? \"0\",\n      metaSementesMilho: goal.metaSementesMilho ?? \"0\",\n      metaSementesSoja: goal.metaSementesSoja ?? \"0\",\n      metaSementesTrigo: goal.metaSementesTrigo ?? \"0\",\n      metaSementesDiversas: goal.metaSementesDiversas ?? \"0\",\n      metaFertilizantes: goal.metaFertilizantes ?? \"0\",\n      metaCorretivos: goal.metaCorretivos ?? \"0\"\n    };\n    this.seasonGoals.set(id, newGoal);\n    return newGoal;\n  }\n\n  async updateSeasonGoal(id: string, goal: Partial<InsertSeasonGoal>): Promise<SeasonGoal | undefined> {\n    const existing = this.seasonGoals.get(id);\n    if (!existing) return undefined;\n    \n    const updated = { ...existing, ...goal };\n    this.seasonGoals.set(id, updated);\n    return updated;\n  }\n\n  // Sale methods\n  async getAllSales(): Promise<Sale[]> {\n    return Array.from(this.sales.values());\n  }\n\n  async getSale(id: string): Promise<Sale | undefined> {\n    return this.sales.get(id);\n  }\n\n  async getSalesByClient(clientId: string): Promise<Sale[]> {\n    return Array.from(this.sales.values()).filter(s => s.clientId === clientId);\n  }\n\n  async getSalesBySeason(seasonId: string): Promise<Sale[]> {\n    return Array.from(this.sales.values()).filter(s => s.seasonId === seasonId);\n  }\n\n  async getSaleByOrderCode(orderCode: string, userId: string): Promise<Sale | undefined> {\n    return Array.from(this.sales.values()).find(s => s.orderCode === orderCode && s.userId === userId);\n  }\n\n  async getExistingOrderCodes(userId: string): Promise<Set<string>> {\n    const orderCodes = new Set<string>();\n    for (const sale of Array.from(this.sales.values())) {\n      if (sale.userId === userId && sale.orderCode) {\n        orderCodes.add(sale.orderCode);\n      }\n    }\n    return orderCodes;\n  }\n\n  async createSale(sale: InsertSale): Promise<Sale> {\n    const id = randomUUID();\n    const now = new Date();\n    const newSale: Sale = { \n      ...sale, \n      id, \n      createdAt: now,\n      quantity: sale.quantity ?? null,\n      timacPoints: sale.timacPoints ?? null,\n      isManual: sale.isManual ?? false,\n      pdfFileName: sale.pdfFileName ?? null,\n      importBatchId: sale.importBatchId ?? null,\n      orderCode: sale.orderCode ?? null\n    };\n    this.sales.set(id, newSale);\n    return newSale;\n  }\n\n  async updateSale(id: string, sale: Partial<InsertSale>): Promise<Sale | undefined> {\n    const existing = this.sales.get(id);\n    if (!existing) return undefined;\n    \n    const updated = { ...existing, ...sale };\n    this.sales.set(id, updated);\n    return updated;\n  }\n\n  async getImportBatches(): Promise<Array<{\n    batchId: string;\n    importDate: Date;\n    salesCount: number;\n    totalAmount: number;\n    totalCommissions: number;\n    userId: string;\n  }>> {\n    const batches = new Map<string, {\n      importDate: Date;\n      sales: Sale[];\n      userId: string;\n    }>();\n\n    for (const sale of Array.from(this.sales.values())) {\n      if (sale.importBatchId) {\n        const existing = batches.get(sale.importBatchId);\n        if (existing) {\n          existing.sales.push(sale);\n          if (sale.createdAt < existing.importDate) {\n            existing.importDate = sale.createdAt;\n          }\n        } else {\n          batches.set(sale.importBatchId, {\n            importDate: sale.createdAt,\n            sales: [sale],\n            userId: sale.userId\n          });\n        }\n      }\n    }\n\n    return Array.from(batches.entries())\n      .map(([batchId, data]) => ({\n        batchId,\n        importDate: data.importDate,\n        salesCount: data.sales.length,\n        totalAmount: data.sales.reduce((sum, s) => sum + parseFloat(s.totalAmount), 0),\n        totalCommissions: data.sales.reduce((sum, s) => sum + parseFloat(s.commissionAmount), 0),\n        userId: data.userId\n      }))\n      .sort((a, b) => b.importDate.getTime() - a.importDate.getTime());\n  }\n\n  async deleteImportBatch(batchId: string): Promise<void> {\n    for (const [id, sale] of Array.from(this.sales.entries())) {\n      if (sale.importBatchId === batchId) {\n        this.sales.delete(id);\n      }\n    }\n  }\n\n  // Season Parameter methods\n  async getAllSeasonParameters(): Promise<SeasonParameter[]> {\n    return Array.from(this.seasonParameters.values());\n  }\n\n  async createSeasonParameter(parameter: InsertSeasonParameter): Promise<SeasonParameter> {\n    const id = randomUUID();\n    const newParameter: SeasonParameter = { ...parameter, id };\n    this.seasonParameters.set(id, newParameter);\n    return newParameter;\n  }\n\n  // Market Investment Rates methods\n  async getMarketInvestmentRates(): Promise<MarketInvestmentRate[]> {\n    // MemStorage doesn't have this data, return empty array\n    return [];\n  }\n\n  // Client Market Rates methods\n  async getClientMarketRates(clientId: string, userId: string, seasonId: string): Promise<ClientMarketRate[]> {\n    // MemStorage doesn't support this, return empty array\n    return [];\n  }\n\n  async upsertClientMarketRate(rate: InsertClientMarketRate): Promise<ClientMarketRate> {\n    // MemStorage doesn't support this\n    const id = randomUUID();\n    return { id, ...rate, createdAt: new Date(), updatedAt: new Date() } as ClientMarketRate;\n  }\n\n  async deleteClientMarketRate(clientId: string, categoryId: string, userId: string, seasonId: string): Promise<boolean> {\n    // MemStorage doesn't support this\n    return true;\n  }\n\n  // Client Market Values methods\n  async getClientMarketValues(clientId: string, userId: string, seasonId: string): Promise<ClientMarketValue[]> {\n    // MemStorage doesn't support this, return empty array\n    return [];\n  }\n\n  async upsertClientMarketValue(value: InsertClientMarketValue): Promise<ClientMarketValue> {\n    // MemStorage doesn't support this\n    const id = randomUUID();\n    return { id, ...value, createdAt: new Date(), updatedAt: new Date() } as ClientMarketValue;\n  }\n\n  async deleteClientMarketValue(clientId: string, categoryId: string, userId: string, seasonId: string): Promise<boolean> {\n    // MemStorage doesn't support this\n    return true;\n  }\n\n  // Analytics methods\n  async getSalesAnalytics(seasonId?: string, userId?: string): Promise<{\n    totalSales: number;\n    totalCommissions: number;\n    salesByCategory: { categoryId: string; categoryName: string; total: number; commissions: number }[];\n    topClients: { clientId: string; clientName: string; total: number; percentage: number }[];\n  }> {\n    let sales = Array.from(this.sales.values());\n    if (seasonId) {\n      sales = sales.filter(s => s.seasonId === seasonId);\n    }\n    if (userId) {\n      sales = sales.filter(s => s.userId === userId);\n    }\n\n    const totalSales = sales.reduce((sum, s) => sum + parseFloat(s.totalAmount), 0);\n    const totalCommissions = sales.reduce((sum, s) => sum + parseFloat(s.commissionAmount), 0);\n\n    // Sales by category\n    const categoryMap = new Map<string, { total: number; commissions: number; name: string }>();\n    for (const sale of sales) {\n      const existing = categoryMap.get(sale.categoryId) || { total: 0, commissions: 0, name: \"\" };\n      const category = this.categories.get(sale.categoryId);\n      categoryMap.set(sale.categoryId, {\n        total: existing.total + parseFloat(sale.totalAmount),\n        commissions: existing.commissions + parseFloat(sale.commissionAmount),\n        name: category?.name || \"Unknown\",\n      });\n    }\n\n    const salesByCategory = Array.from(categoryMap.entries()).map(([categoryId, data]) => ({\n      categoryId,\n      categoryName: data.name,\n      total: data.total,\n      commissions: data.commissions,\n    }));\n\n    // Top clients\n    const clientMap = new Map<string, number>();\n    for (const sale of sales) {\n      const existing = clientMap.get(sale.clientId) || 0;\n      clientMap.set(sale.clientId, existing + parseFloat(sale.totalAmount));\n    }\n\n    const topClients = Array.from(clientMap.entries())\n      .map(([clientId, total]) => {\n        const client = this.clients.get(clientId);\n        return {\n          clientId,\n          clientName: client?.name || \"Unknown\",\n          total,\n          percentage: totalSales > 0 ? (total / totalSales) * 100 : 0,\n        };\n      })\n      .sort((a, b) => b.total - a.total);\n\n    return {\n      totalSales,\n      totalCommissions,\n      salesByCategory,\n      topClients,\n    };\n  }\n\n  async getMarketBenchmarks(userId: string, seasonId: string): Promise<MarketBenchmark[]> {\n    return [];\n  }\n\n  async upsertMarketBenchmark(benchmark: InsertMarketBenchmark): Promise<MarketBenchmark> {\n    const id = randomUUID();\n    return { id, ...benchmark, createdAt: new Date(), updatedAt: new Date() } as MarketBenchmark;\n  }\n\n  async deleteMarketBenchmark(userId: string, categoryId: string, seasonId: string): Promise<boolean> {\n    return true;\n  }\n\n  async getMarketPotentialByCategory(userId: string, seasonId: string): Promise<Array<{\n    categoryId: string;\n    categoryName: string;\n    marketArea: number;\n    investmentPerHa: number;\n    totalPotential: number;\n  }>> {\n    return [];\n  }\n\n  async getExternalPurchases(clientId: string, userId: string, seasonId: string): Promise<ExternalPurchase[]> {\n    return [];\n  }\n\n  async upsertExternalPurchase(purchase: InsertExternalPurchase): Promise<ExternalPurchase> {\n    const id = randomUUID();\n    return { id, ...purchase, createdAt: new Date(), updatedAt: new Date() } as ExternalPurchase;\n  }\n\n  async deleteExternalPurchase(userId: string, clientId: string, categoryId: string, seasonId: string): Promise<boolean> {\n    return true;\n  }\n\n  // Client Family Relations\n  async getClientFamilyRelations(clientId: string, userId: string): Promise<string[]> {\n    return [];\n  }\n\n  async addClientFamilyRelation(relation: InsertClientFamilyRelation): Promise<ClientFamilyRelation> {\n    const id = randomUUID();\n    return { id, ...relation, createdAt: new Date() } as ClientFamilyRelation;\n  }\n\n  async removeClientFamilyRelation(clientId: string, relatedClientId: string, userId: string): Promise<boolean> {\n    return true;\n  }\n\n  async getOpportunityAlerts(clientId?: string): Promise<{\n    clientId: string;\n    clientName: string;\n    missingProducts: string[];\n    category: string;\n    region: string;\n    severity: 'high' | 'medium' | 'low';\n  }[]> {\n    // This is a simplified implementation\n    // In reality, this would compare current season vs previous season purchases\n    return [];\n  }\n\n  // Alert Settings\n  async getAlertSettings(userId: string): Promise<AlertSettings | undefined> {\n    throw new Error(\"Not implemented in MemStorage\");\n  }\n\n  async upsertAlertSettings(settings: InsertAlertSettings): Promise<AlertSettings> {\n    throw new Error(\"Not implemented in MemStorage\");\n  }\n\n  // Alerts\n  async getAlerts(userId: string): Promise<Alert[]> {\n    throw new Error(\"Not implemented in MemStorage\");\n  }\n\n  async getUnreadAlertsCount(userId: string): Promise<number> {\n    throw new Error(\"Not implemented in MemStorage\");\n  }\n\n  async createAlert(alert: InsertAlert): Promise<Alert> {\n    throw new Error(\"Not implemented in MemStorage\");\n  }\n\n  async markAlertAsRead(alertId: string, userId: string): Promise<boolean> {\n    throw new Error(\"Not implemented in MemStorage\");\n  }\n\n  async markAllAlertsAsRead(userId: string): Promise<boolean> {\n    throw new Error(\"Not implemented in MemStorage\");\n  }\n\n  async deleteAlert(alertId: string, userId: string): Promise<boolean> {\n    throw new Error(\"Not implemented in MemStorage\");\n  }\n\n  // Purchase History\n  async getPurchaseHistories(userId: string, clientId?: string, seasonId?: string): Promise<PurchaseHistory[]> {\n    throw new Error(\"Not implemented in MemStorage\");\n  }\n\n  async getPurchaseHistory(id: string, userId: string): Promise<PurchaseHistory | undefined> {\n    throw new Error(\"Not implemented in MemStorage\");\n  }\n\n  async createPurchaseHistory(history: InsertPurchaseHistory): Promise<PurchaseHistory> {\n    throw new Error(\"Not implemented in MemStorage\");\n  }\n\n  async deletePurchaseHistory(id: string, userId: string): Promise<boolean> {\n    throw new Error(\"Not implemented in MemStorage\");\n  }\n\n  async getPurchaseHistoryItems(purchaseHistoryId: string): Promise<PurchaseHistoryItem[]> {\n    throw new Error(\"Not implemented in MemStorage\");\n  }\n\n  async createPurchaseHistoryItem(item: InsertPurchaseHistoryItem): Promise<PurchaseHistoryItem> {\n    throw new Error(\"Not implemented in MemStorage\");\n  }\n\n  // Barter Module\n  async getAllBarterProducts(): Promise<BarterProduct[]> {\n    return Array.from(this.barterProducts.values()).filter(p => p.isActive);\n  }\n\n  async createBarterProduct(product: InsertBarterProduct): Promise<BarterProduct> {\n    const id = randomUUID();\n    const now = new Date();\n    const newProduct: BarterProduct = { \n      ...product, \n      id, \n      createdAt: now, \n      updatedAt: now,\n      isActive: product.isActive ?? true\n    };\n    this.barterProducts.set(id, newProduct);\n    return newProduct;\n  }\n\n  async updateBarterProduct(id: string, product: Partial<InsertBarterProduct>): Promise<BarterProduct | undefined> {\n    const existing = this.barterProducts.get(id);\n    if (!existing) return undefined;\n    const updated: BarterProduct = { ...existing, ...product, updatedAt: new Date() };\n    this.barterProducts.set(id, updated);\n    return updated;\n  }\n\n  async deleteBarterProduct(id: string): Promise<boolean> {\n    return this.barterProducts.delete(id);\n  }\n\n  async deleteAllBarterProducts(): Promise<void> {\n    this.barterProducts.clear();\n  }\n\n  async getAllBarterSettings(): Promise<BarterSettings[]> {\n    return Array.from(this.barterSettings.values());\n  }\n\n  async upsertBarterSetting(key: string, value: string, description?: string): Promise<BarterSettings> {\n    const existing = Array.from(this.barterSettings.values()).find(s => s.key === key);\n    const setting: BarterSettings = existing \n      ? { ...existing, value, description: description || existing.description, updatedAt: new Date() }\n      : { id: randomUUID(), key, value, description: description || null, updatedAt: new Date() };\n    \n    if (existing) {\n      this.barterSettings.set(existing.id, setting);\n    } else {\n      this.barterSettings.set(setting.id, setting);\n    }\n    return setting;\n  }\n\n  async getBarterSimulationsByUser(userId: string): Promise<BarterSimulation[]> {\n    return Array.from(this.barterSimulations.values()).filter(s => s.userId === userId);\n  }\n\n  async getBarterSimulation(id: string): Promise<BarterSimulation | undefined> {\n    return this.barterSimulations.get(id);\n  }\n\n  async createBarterSimulation(simulation: InsertBarterSimulation, items: InsertBarterSimulationItem[]): Promise<BarterSimulation> {\n    const id = randomUUID();\n    const now = new Date();\n    const newSimulation: BarterSimulation = { \n      ...simulation, \n      id, \n      createdAt: now, \n      updatedAt: now,\n      status: simulation.status || \"draft\"\n    };\n    this.barterSimulations.set(id, newSimulation);\n    return newSimulation;\n  }\n\n  async updateBarterSimulation(id: string, simulation: Partial<InsertBarterSimulation>): Promise<BarterSimulation | undefined> {\n    const existing = this.barterSimulations.get(id);\n    if (!existing) return undefined;\n    const updated: BarterSimulation = { ...existing, ...simulation, updatedAt: new Date() };\n    this.barterSimulations.set(id, updated);\n    return updated;\n  }\n\n  async deleteBarterSimulation(id: string): Promise<boolean> {\n    return this.barterSimulations.delete(id);\n  }\n\n  // Sales Targets - Stubs for in-memory storage\n  async getKanbanData(userId: string, seasonId: string): Promise<any> {\n    return { clients: [] };\n  }\n\n  async getSalesTargets(userId: string, seasonId?: string): Promise<any[]> {\n    return [];\n  }\n\n  async createSalesTarget(userId: string, clientId: string, segmento: string, valorCapturado: number, seasonId: string, subcategories?: Record<string, number>): Promise<any> {\n    return { id: randomUUID(), userId, clientId, segmento, valorCapturado: valorCapturado.toString(), seasonId, subcategories, createdAt: new Date(), updatedAt: new Date() };\n  }\n\n  async updateSalesTarget(id: string, valorCapturado: number, subcategories?: Record<string, number>): Promise<any> {\n    return { id, valorCapturado: valorCapturado.toString(), subcategories, updatedAt: new Date() };\n  }\n\n  async deleteSalesTarget(id: string, userId: string): Promise<boolean> {\n    return true;\n  }\n\n  async getSystemSettings(): Promise<{ allowUserRegistration: boolean } | undefined> {\n    // MemStorage doesn't persist system settings - always allow registration in memory mode\n    return { allowUserRegistration: true };\n  }\n}\n\nexport class DBStorage implements IStorage {\n  sessionStore: session.Store;\n\n  constructor() {\n    this.sessionStore = new PostgresSessionStore({ \n      pool: pool as any, \n      createTableIfMissing: true \n    });\n  }\n\n  async getUser(id: string): Promise<User | undefined> {\n    const result = await db.select().from(users).where(eq(users.id, id));\n    return result[0];\n  }\n\n  async getUserByUsername(username: string): Promise<User | undefined> {\n    const result = await db.select().from(users).where(eq(users.username, username));\n    return result[0];\n  }\n\n  async createUser(user: InsertUser): Promise<User> {\n    const id = randomUUID();\n    const result = await db.insert(users).values({\n      id,\n      ...user,\n      role: user.role ?? \"vendedor\"\n    }).returning();\n    return result[0];\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    return await db.select().from(users);\n  }\n\n  async updateUser(id: string, user: Partial<InsertUser>): Promise<User | undefined> {\n    const result = await db.update(users)\n      .set(user)\n      .where(eq(users.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async deleteUser(id: string): Promise<boolean> {\n    const result = await db.delete(users)\n      .where(eq(users.id, id))\n      .returning();\n    return result.length > 0;\n  }\n\n  async getAllCategories(): Promise<Category[]> {\n    return await db.select().from(categories);\n  }\n\n  async getCategory(id: string): Promise<Category | undefined> {\n    const result = await db.select().from(categories).where(eq(categories.id, id));\n    return result[0];\n  }\n\n  async createCategory(category: InsertCategory): Promise<Category> {\n    const id = randomUUID();\n    const result = await db.insert(categories).values({\n      id,\n      ...category,\n      defaultIva: category.defaultIva ?? \"10.00\"\n    }).returning();\n    return result[0];\n  }\n\n  async updateCategory(id: string, category: Partial<InsertCategory>): Promise<Category | undefined> {\n    const result = await db.update(categories)\n      .set(category)\n      .where(eq(categories.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async getAllProducts(): Promise<Product[]> {\n    return await db.select().from(products).where(eq(products.isActive, true));\n  }\n\n  async getProductsByCategory(categoryId: string): Promise<Product[]> {\n    return await db.select().from(products).where(\n      and(eq(products.categoryId, categoryId), eq(products.isActive, true))\n    );\n  }\n\n  async createProduct(product: InsertProduct): Promise<Product> {\n    const id = randomUUID();\n    const result = await db.insert(products).values({\n      id,\n      ...product,\n      description: product.description ?? null,\n      isActive: product.isActive ?? true\n    }).returning();\n    return result[0];\n  }\n\n  async updateProduct(id: string, product: Partial<InsertProduct>): Promise<Product | undefined> {\n    const result = await db.update(products)\n      .set(product)\n      .where(eq(products.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async getAllRegions(): Promise<Region[]> {\n    return await db.select().from(regions);\n  }\n\n  async createRegion(region: InsertRegion): Promise<Region> {\n    const id = randomUUID();\n    const result = await db.insert(regions).values({\n      id,\n      ...region,\n      country: region.country ?? \"Paraguay\"\n    }).returning();\n    return result[0];\n  }\n\n  async getAllClients(): Promise<Client[]> {\n    return await db.select().from(clients).where(eq(clients.isActive, true));\n  }\n\n  async getClient(id: string): Promise<Client | undefined> {\n    // Buscar em user_client_links com join para master_clients\n    const links = await db.select({\n      linkId: userClientLinks.id,\n      masterClientId: userClientLinks.masterClientId,\n      customName: userClientLinks.customName,\n      linkPlantingArea: userClientLinks.plantingArea,\n      linkCultures: userClientLinks.cultures,\n      plantingProgress: userClientLinks.plantingProgress,\n      isTop80_20: userClientLinks.isTop80_20,\n      includeInMarketArea: userClientLinks.includeInMarketArea,\n      isActive: userClientLinks.isActive,\n      userId: userClientLinks.userId,\n      masterName: masterClients.name,\n      regionId: masterClients.regionId,\n      masterPlantingArea: masterClients.plantingArea,\n      masterCultures: masterClients.cultures\n    })\n    .from(userClientLinks)\n    .innerJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n    .where(eq(userClientLinks.id, id));\n    \n    if (links.length === 0) return undefined;\n    \n    const link = links[0];\n    return {\n      id: link.linkId,\n      name: link.customName || link.masterName,\n      regionId: link.regionId || '',\n      plantingArea: link.linkPlantingArea || link.masterPlantingArea || '0',\n      cultures: link.linkCultures || link.masterCultures || [],\n      plantingProgress: link.plantingProgress || '0.00',\n      isTop80_20: link.isTop80_20,\n      includeInMarketArea: link.includeInMarketArea,\n      isActive: link.isActive,\n      userId: link.userId\n    };\n  }\n\n  async getTop80_20Clients(): Promise<Client[]> {\n    return await db.select().from(clients).where(\n      and(eq(clients.isTop80_20, true), eq(clients.isActive, true))\n    );\n  }\n\n  async createClient(client: InsertClient): Promise<Client> {\n    // 1. Buscar ou criar master_client\n    let masterClient = await this.findMasterClientByName(client.name);\n    \n    if (!masterClient) {\n      // Criar novo master_client\n      masterClient = await this.createMasterClient({\n        name: client.name,\n        regionId: client.regionId || null,\n        plantingArea: client.plantingArea || null,\n        cultures: client.cultures || [],\n        isActive: true\n      });\n    }\n    \n    // 2. Criar user_client_link\n    const linkId = randomUUID();\n    const newLink = await db.insert(userClientLinks).values({\n      id: linkId,\n      userId: client.userId!,\n      masterClientId: masterClient.id,\n      customName: null, // Usar nome do master_client\n      plantingArea: client.plantingArea || null,\n      cultures: client.cultures || null,\n      plantingProgress: client.plantingProgress ?? \"0.00\",\n      isTop80_20: client.isTop80_20 ?? false,\n      includeInMarketArea: client.includeInMarketArea ?? false,\n      isActive: true\n    }).returning();\n    \n    // 3. Retornar no formato Client\n    return {\n      id: linkId,\n      name: masterClient.name,\n      regionId: masterClient.regionId || '',\n      plantingArea: client.plantingArea || masterClient.plantingArea || '0',\n      cultures: client.cultures || masterClient.cultures || [],\n      plantingProgress: client.plantingProgress ?? '0.00',\n      isTop80_20: client.isTop80_20 ?? false,\n      includeInMarketArea: client.includeInMarketArea ?? false,\n      isActive: true,\n      userId: client.userId!\n    };\n  }\n\n  async updateClient(id: string, client: Partial<InsertClient>): Promise<Client | undefined> {\n    // Atualizar user_client_links\n    const updateData: Partial<typeof userClientLinks.$inferInsert> = {};\n    \n    if (client.name !== undefined) updateData.customName = client.name;\n    if (client.plantingArea !== undefined) updateData.plantingArea = client.plantingArea;\n    if (client.cultures !== undefined) updateData.cultures = client.cultures;\n    if (client.plantingProgress !== undefined) updateData.plantingProgress = client.plantingProgress;\n    if (client.isTop80_20 !== undefined) updateData.isTop80_20 = client.isTop80_20;\n    if (client.includeInMarketArea !== undefined) updateData.includeInMarketArea = client.includeInMarketArea;\n    if (client.isActive !== undefined) updateData.isActive = client.isActive;\n    \n    await db.update(userClientLinks)\n      .set(updateData)\n      .where(eq(userClientLinks.id, id));\n    \n    return await this.getClient(id);\n  }\n\n  async deleteClient(id: string): Promise<boolean> {\n    // Deletar user_client_link\n    const result = await db.delete(userClientLinks)\n      .where(eq(userClientLinks.id, id))\n      .returning();\n    return result.length > 0;\n  }\n\n  async getClientsForUser(userId: string, top8020Only?: boolean): Promise<Client[]> {\n    const links = await db.select({\n      linkId: userClientLinks.id,\n      masterClientId: userClientLinks.masterClientId,\n      customName: userClientLinks.customName,\n      linkPlantingArea: userClientLinks.plantingArea,\n      linkCultures: userClientLinks.cultures,\n      plantingProgress: userClientLinks.plantingProgress,\n      isTop80_20: userClientLinks.isTop80_20,\n      includeInMarketArea: userClientLinks.includeInMarketArea,\n      isActive: userClientLinks.isActive,\n      masterName: masterClients.name,\n      regionId: masterClients.regionId,\n      masterPlantingArea: masterClients.plantingArea,\n      masterCultures: masterClients.cultures\n    })\n    .from(userClientLinks)\n    .innerJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n    .where(\n      and(\n        eq(userClientLinks.userId, userId),\n        eq(userClientLinks.isActive, true),\n        eq(masterClients.isActive, true),\n        top8020Only ? eq(userClientLinks.isTop80_20, true) : sql`true`\n      )\n    );\n\n    // Mapear para formato Client\n    return links.map(link => ({\n      id: link.linkId,\n      name: link.customName || link.masterName,\n      regionId: link.regionId || '',\n      plantingArea: link.linkPlantingArea || link.masterPlantingArea || '0',\n      cultures: link.linkCultures || link.masterCultures || [],\n      plantingProgress: link.plantingProgress || '0.00',\n      isTop80_20: link.isTop80_20,\n      includeInMarketArea: link.includeInMarketArea,\n      isActive: link.isActive,\n      userId: userId\n    }));\n  }\n\n  // Master Clients\n  async getAllMasterClients(): Promise<MasterClient[]> {\n    return await db.select().from(masterClients).where(eq(masterClients.isActive, true)).orderBy(asc(masterClients.name));\n  }\n\n  async getMasterClient(id: string): Promise<MasterClient | undefined> {\n    const result = await db.select().from(masterClients).where(eq(masterClients.id, id));\n    return result[0];\n  }\n\n  async findMasterClientByName(name: string): Promise<MasterClient | undefined> {\n    const normalizedSearch = name.toUpperCase().trim().replace(/[.,\\-\\s]/g, '');\n    const allClients = await db.select().from(masterClients).where(eq(masterClients.isActive, true));\n    \n    return allClients.find(client => {\n      const normalizedClientName = client.name.toUpperCase().trim().replace(/[.,\\-\\s]/g, '');\n      return normalizedClientName === normalizedSearch;\n    });\n  }\n\n  async createMasterClient(client: InsertMasterClient): Promise<MasterClient> {\n    const id = randomUUID();\n    const result = await db.insert(masterClients).values({\n      id,\n      ...client,\n      cultures: client.cultures ?? [],\n      isActive: client.isActive ?? true\n    }).returning();\n    return result[0];\n  }\n\n  async updateMasterClient(id: string, client: Partial<InsertMasterClient>): Promise<MasterClient | undefined> {\n    const result = await db.update(masterClients)\n      .set({\n        ...client,\n        updatedAt: new Date()\n      })\n      .where(eq(masterClients.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async deleteMasterClient(id: string): Promise<boolean> {\n    const result = await db.delete(masterClients)\n      .where(eq(masterClients.id, id))\n      .returning();\n    return result.length > 0;\n  }\n\n  async mergeMasterClients(sourceId: string, targetId: string): Promise<boolean> {\n    await db.update(userClientLinks)\n      .set({ masterClientId: targetId })\n      .where(eq(userClientLinks.masterClientId, sourceId));\n    \n    await db.delete(masterClients).where(eq(masterClients.id, sourceId));\n    return true;\n  }\n\n  // User Client Links\n  async getUserClientLinks(userId: string): Promise<UserClientLink[]> {\n    return await db.select().from(userClientLinks).where(\n      and(eq(userClientLinks.userId, userId), eq(userClientLinks.isActive, true))\n    );\n  }\n\n  async getUserClientLink(userId: string, masterClientId: string): Promise<UserClientLink | undefined> {\n    const result = await db.select().from(userClientLinks).where(\n      and(\n        eq(userClientLinks.userId, userId),\n        eq(userClientLinks.masterClientId, masterClientId)\n      )\n    );\n    return result[0];\n  }\n\n  async createUserClientLink(link: InsertUserClientLink): Promise<UserClientLink> {\n    const id = randomUUID();\n    const result = await db.insert(userClientLinks).values({\n      id,\n      ...link,\n      plantingProgress: link.plantingProgress ?? \"0.00\",\n      isTop80_20: link.isTop80_20 ?? false,\n      isActive: link.isActive ?? true\n    }).returning();\n    return result[0];\n  }\n\n  async updateUserClientLink(id: string, link: Partial<InsertUserClientLink>): Promise<UserClientLink | undefined> {\n    const result = await db.update(userClientLinks)\n      .set(link)\n      .where(eq(userClientLinks.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async deleteUserClientLink(id: string): Promise<boolean> {\n    const result = await db.delete(userClientLinks)\n      .where(eq(userClientLinks.id, id))\n      .returning();\n    return result.length > 0;\n  }\n\n  async getAllSeasons(): Promise<Season[]> {\n    return await db.select().from(seasons).where(eq(seasons.isActive, true));\n  }\n\n  async getActiveSeason(): Promise<Season | undefined> {\n    const now = new Date();\n    const result = await db.select().from(seasons).where(\n      and(\n        eq(seasons.isActive, true),\n        sql`${seasons.startDate} <= ${now}`,\n        sql`${seasons.endDate} >= ${now}`\n      )\n    );\n    return result[0];\n  }\n\n  async createSeason(season: InsertSeason): Promise<Season> {\n    const id = randomUUID();\n    const result = await db.insert(seasons).values({\n      id,\n      ...season,\n      isActive: season.isActive ?? true\n    }).returning();\n    return result[0];\n  }\n\n  async getAllSeasonGoals(): Promise<SeasonGoal[]> {\n    return await db.select().from(seasonGoals);\n  }\n\n  async getSeasonGoal(seasonId: string, userId: string): Promise<SeasonGoal | undefined> {\n    const result = await db.select().from(seasonGoals).where(\n      and(eq(seasonGoals.seasonId, seasonId), eq(seasonGoals.userId, userId))\n    );\n    return result[0];\n  }\n\n  async createSeasonGoal(goal: InsertSeasonGoal): Promise<SeasonGoal> {\n    const id = randomUUID();\n    const result = await db.insert(seasonGoals).values({\n      id,\n      ...goal\n    }).returning();\n    return result[0];\n  }\n\n  async updateSeasonGoal(id: string, goal: Partial<InsertSeasonGoal>): Promise<SeasonGoal | undefined> {\n    const result = await db.update(seasonGoals)\n      .set(goal)\n      .where(eq(seasonGoals.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async deleteSeasonGoal(id: string): Promise<boolean> {\n    const result = await db.delete(seasonGoals)\n      .where(eq(seasonGoals.id, id))\n      .returning();\n    return result.length > 0;\n  }\n\n  async getAllSales(): Promise<Sale[]> {\n    return await db.select().from(sales).orderBy(desc(sales.createdAt));\n  }\n\n  async getSale(id: string): Promise<Sale | undefined> {\n    const result = await db.select().from(sales).where(eq(sales.id, id));\n    return result[0];\n  }\n\n  async getSalesByClient(clientId: string): Promise<Sale[]> {\n    return await db.select().from(sales)\n      .where(eq(sales.clientId, clientId))\n      .orderBy(desc(sales.createdAt));\n  }\n\n  async getSalesBySeason(seasonId: string): Promise<Sale[]> {\n    return await db.select().from(sales)\n      .where(eq(sales.seasonId, seasonId))\n      .orderBy(desc(sales.createdAt));\n  }\n\n  async getSaleByOrderCode(orderCode: string, userId: string): Promise<Sale | undefined> {\n    const result = await db.select().from(sales)\n      .where(and(\n        eq(sales.orderCode, orderCode),\n        eq(sales.userId, userId)\n      ))\n      .limit(1);\n    return result[0];\n  }\n\n  async getExistingOrderCodes(userId: string): Promise<Set<string>> {\n    const result = await db\n      .selectDistinct({ orderCode: sales.orderCode })\n      .from(sales)\n      .where(and(\n        eq(sales.userId, userId),\n        sql`${sales.orderCode} IS NOT NULL`\n      ));\n    \n    return new Set(result.map(r => r.orderCode).filter((code): code is string => code !== null));\n  }\n\n  async createSale(sale: InsertSale): Promise<Sale> {\n    const id = randomUUID();\n    const now = new Date();\n    const result = await db.insert(sales).values({\n      id,\n      ...sale,\n      createdAt: now,\n      isManual: sale.isManual ?? false,\n      pdfFileName: sale.pdfFileName ?? null\n    }).returning();\n    return result[0];\n  }\n\n  async updateSale(id: string, sale: Partial<InsertSale>): Promise<Sale | undefined> {\n    const result = await db.update(sales)\n      .set(sale)\n      .where(eq(sales.id, id))\n      .returning();\n    return result[0];\n  }\n\n  async getImportBatches(): Promise<Array<{\n    batchId: string;\n    importDate: Date;\n    salesCount: number;\n    totalAmount: number;\n    totalCommissions: number;\n    userId: string;\n  }>> {\n    const result = await db\n      .select({\n        batchId: sales.importBatchId,\n        importDate: sql<Date>`MIN(${sales.createdAt})`,\n        salesCount: sql<number>`COUNT(*)::int`,\n        totalAmount: sql<number>`SUM(CAST(${sales.totalAmount} AS NUMERIC))`,\n        totalCommissions: sql<number>`SUM(CAST(${sales.commissionAmount} AS NUMERIC))`,\n        userId: sql<string>`MIN(${sales.userId})`,\n      })\n      .from(sales)\n      .where(sql`${sales.importBatchId} IS NOT NULL`)\n      .groupBy(sales.importBatchId)\n      .orderBy(sql`MIN(${sales.createdAt}) DESC`);\n    \n    return result.map(row => ({\n      batchId: row.batchId!,\n      importDate: row.importDate,\n      salesCount: row.salesCount,\n      totalAmount: Number(row.totalAmount),\n      totalCommissions: Number(row.totalCommissions),\n      userId: row.userId,\n    }));\n  }\n\n  async deleteImportBatch(batchId: string): Promise<void> {\n    await db.delete(sales).where(eq(sales.importBatchId, batchId));\n  }\n\n  async deleteAllSales(): Promise<void> {\n    await db.delete(sales);\n  }\n\n  async getAllSeasonParameters(): Promise<SeasonParameter[]> {\n    return await db.select().from(seasonParameters);\n  }\n\n  async createSeasonParameter(parameter: InsertSeasonParameter): Promise<SeasonParameter> {\n    const id = randomUUID();\n    const result = await db.insert(seasonParameters).values({\n      id,\n      ...parameter\n    }).returning();\n    return result[0];\n  }\n\n  async getMarketInvestmentRates(): Promise<MarketInvestmentRate[]> {\n    return await db.select().from(marketInvestmentRates);\n  }\n\n  async getClientMarketRates(clientId: string, userId: string, seasonId: string): Promise<ClientMarketRate[]> {\n    return await db.select().from(clientMarketRates)\n      .where(and(\n        eq(clientMarketRates.clientId, clientId), \n        eq(clientMarketRates.userId, userId),\n        eq(clientMarketRates.seasonId, seasonId)\n      ));\n  }\n\n  async upsertClientMarketRate(rate: InsertClientMarketRate): Promise<ClientMarketRate> {\n    const existing = await db.select().from(clientMarketRates)\n      .where(and(\n        eq(clientMarketRates.clientId, rate.clientId),\n        eq(clientMarketRates.categoryId, rate.categoryId),\n        eq(clientMarketRates.userId, rate.userId),\n        eq(clientMarketRates.seasonId, rate.seasonId)\n      ))\n      .limit(1);\n\n    if (existing.length > 0) {\n      const updated = await db.update(clientMarketRates)\n        .set({\n          investmentPerHa: rate.investmentPerHa,\n          subcategories: rate.subcategories,\n          updatedAt: sql`now()`\n        })\n        .where(eq(clientMarketRates.id, existing[0].id))\n        .returning();\n      return updated[0];\n    } else {\n      const id = randomUUID();\n      const inserted = await db.insert(clientMarketRates)\n        .values({ id, ...rate })\n        .returning();\n      return inserted[0];\n    }\n  }\n\n  async deleteClientMarketRate(clientId: string, categoryId: string, userId: string, seasonId: string): Promise<boolean> {\n    await db.delete(clientMarketRates)\n      .where(and(\n        eq(clientMarketRates.clientId, clientId),\n        eq(clientMarketRates.categoryId, categoryId),\n        eq(clientMarketRates.userId, userId),\n        eq(clientMarketRates.seasonId, seasonId)\n      ));\n    return true;\n  }\n\n  async getClientMarketValues(clientId: string, userId: string, seasonId: string): Promise<ClientMarketValue[]> {\n    return await db.select().from(clientMarketValues)\n      .where(and(\n        eq(clientMarketValues.clientId, clientId), \n        eq(clientMarketValues.userId, userId),\n        eq(clientMarketValues.seasonId, seasonId)\n      ));\n  }\n\n  async upsertClientMarketValue(value: InsertClientMarketValue): Promise<ClientMarketValue> {\n    const existing = await db.select().from(clientMarketValues)\n      .where(and(\n        eq(clientMarketValues.clientId, value.clientId),\n        eq(clientMarketValues.categoryId, value.categoryId),\n        eq(clientMarketValues.userId, value.userId),\n        eq(clientMarketValues.seasonId, value.seasonId)\n      ))\n      .limit(1);\n\n    if (existing.length > 0) {\n      const updated = await db.update(clientMarketValues)\n        .set({\n          marketValue: value.marketValue,\n          subcategories: value.subcategories,\n          updatedAt: sql`now()`\n        })\n        .where(eq(clientMarketValues.id, existing[0].id))\n        .returning();\n      return updated[0];\n    } else {\n      const id = randomUUID();\n      const inserted = await db.insert(clientMarketValues)\n        .values({ id, ...value })\n        .returning();\n      return inserted[0];\n    }\n  }\n\n  async deleteClientMarketValue(clientId: string, categoryId: string, userId: string, seasonId: string): Promise<boolean> {\n    await db.delete(clientMarketValues)\n      .where(and(\n        eq(clientMarketValues.clientId, clientId),\n        eq(clientMarketValues.categoryId, categoryId),\n        eq(clientMarketValues.userId, userId),\n        eq(clientMarketValues.seasonId, seasonId)\n      ));\n    return true;\n  }\n\n  async getMarketBenchmarks(userId: string, seasonId: string): Promise<MarketBenchmark[]> {\n    return await db.select().from(marketBenchmarks)\n      .where(and(\n        eq(marketBenchmarks.userId, userId),\n        eq(marketBenchmarks.seasonId, seasonId)\n      ));\n  }\n\n  async upsertMarketBenchmark(benchmark: InsertMarketBenchmark): Promise<MarketBenchmark> {\n    const existing = await db.select().from(marketBenchmarks)\n      .where(and(\n        eq(marketBenchmarks.userId, benchmark.userId),\n        eq(marketBenchmarks.categoryId, benchmark.categoryId),\n        eq(marketBenchmarks.seasonId, benchmark.seasonId)\n      ))\n      .limit(1);\n\n    if (existing.length > 0) {\n      const updated = await db.update(marketBenchmarks)\n        .set({\n          marketPercentage: benchmark.marketPercentage,\n          updatedAt: sql`now()`\n        })\n        .where(eq(marketBenchmarks.id, existing[0].id))\n        .returning();\n      return updated[0];\n    } else {\n      const id = randomUUID();\n      const inserted = await db.insert(marketBenchmarks)\n        .values({ id, ...benchmark })\n        .returning();\n      return inserted[0];\n    }\n  }\n\n  async deleteMarketBenchmark(userId: string, categoryId: string, seasonId: string): Promise<boolean> {\n    await db.delete(marketBenchmarks)\n      .where(and(\n        eq(marketBenchmarks.userId, userId),\n        eq(marketBenchmarks.categoryId, categoryId),\n        eq(marketBenchmarks.seasonId, seasonId)\n      ));\n    return true;\n  }\n\n  async getMarketPotentialByCategory(userId: string, seasonId: string): Promise<Array<{\n    categoryId: string;\n    categoryName: string;\n    marketArea: number;\n    investmentPerHa: number;\n    totalPotential: number;\n  }>> {\n    // Get all clients with includeInMarketArea = true for this user\n    const marketClients = await db.select({\n      id: userClientLinks.id,\n      plantingArea: userClientLinks.plantingArea,\n      includeInMarketArea: userClientLinks.includeInMarketArea,\n    })\n    .from(userClientLinks)\n    .where(and(\n      eq(userClientLinks.userId, userId),\n      eq(userClientLinks.includeInMarketArea, true)\n    ));\n\n    // Calculate total market area\n    const totalMarketArea = marketClients.reduce((sum, client) => {\n      return sum + parseFloat(client.plantingArea || '0');\n    }, 0);\n\n    // Get all categories\n    const allCategories = await db.select().from(categories);\n\n    // Get investment rates for this user and season - use DISTINCT ON to get one value per category\n    const rates = await db.select({\n      categoryId: clientMarketRates.categoryId,\n      investmentPerHa: clientMarketRates.investmentPerHa,\n    })\n      .from(clientMarketRates)\n      .where(and(\n        eq(clientMarketRates.userId, userId),\n        eq(clientMarketRates.seasonId, seasonId)\n      ))\n      .orderBy(clientMarketRates.categoryId, sql`${clientMarketRates.updatedAt} DESC`);\n\n    // Use Map to store only the first (most recent) value per category\n    const ratesByCategory = new Map<string, number>();\n    for (const rate of rates) {\n      if (!ratesByCategory.has(rate.categoryId)) {\n        ratesByCategory.set(rate.categoryId, parseFloat(rate.investmentPerHa));\n      }\n    }\n\n    // Build result array\n    const result = allCategories.map(category => {\n      const investmentPerHa = ratesByCategory.get(category.id) || 0;\n\n      return {\n        categoryId: category.id,\n        categoryName: category.name,\n        marketArea: totalMarketArea,\n        investmentPerHa: investmentPerHa,\n        totalPotential: totalMarketArea * investmentPerHa,\n      };\n    });\n\n    return result;\n  }\n\n  // External Purchases\n  async getExternalPurchases(clientId: string, userId: string, seasonId: string): Promise<ExternalPurchase[]> {\n    return await db.select().from(externalPurchases)\n      .where(and(\n        eq(externalPurchases.clientId, clientId),\n        eq(externalPurchases.userId, userId),\n        eq(externalPurchases.seasonId, seasonId)\n      ));\n  }\n\n  async upsertExternalPurchase(purchase: InsertExternalPurchase): Promise<ExternalPurchase> {\n    const existing = await db.select().from(externalPurchases)\n      .where(and(\n        eq(externalPurchases.userId, purchase.userId),\n        eq(externalPurchases.clientId, purchase.clientId),\n        eq(externalPurchases.categoryId, purchase.categoryId),\n        eq(externalPurchases.seasonId, purchase.seasonId)\n      ))\n      .limit(1);\n\n    if (existing.length > 0) {\n      const updated = await db.update(externalPurchases)\n        .set({\n          amount: purchase.amount,\n          subcategories: purchase.subcategories,\n          updatedAt: sql`now()`\n        })\n        .where(eq(externalPurchases.id, existing[0].id))\n        .returning();\n      return updated[0];\n    } else {\n      const id = randomUUID();\n      const inserted = await db.insert(externalPurchases)\n        .values({ id, ...purchase })\n        .returning();\n      return inserted[0];\n    }\n  }\n\n  async deleteExternalPurchase(userId: string, clientId: string, categoryId: string, seasonId: string): Promise<boolean> {\n    await db.delete(externalPurchases)\n      .where(and(\n        eq(externalPurchases.userId, userId),\n        eq(externalPurchases.clientId, clientId),\n        eq(externalPurchases.categoryId, categoryId),\n        eq(externalPurchases.seasonId, seasonId)\n      ));\n    return true;\n  }\n\n  // Client Family Relations\n  async getClientFamilyRelations(clientId: string, userId: string): Promise<string[]> {\n    const relations = await db.select().from(clientFamilyRelations)\n      .where(and(\n        eq(clientFamilyRelations.clientId, clientId),\n        eq(clientFamilyRelations.userId, userId)\n      ));\n    return relations.map(r => r.relatedClientId);\n  }\n\n  async getBatchClientFamilyRelations(clientIds: string[], userId: string): Promise<Map<string, string[]>> {\n    if (clientIds.length === 0) {\n      return new Map();\n    }\n\n    // Fetch all relations for these clients in a single query\n    const relations = await db.select().from(clientFamilyRelations)\n      .where(and(\n        inArray(clientFamilyRelations.clientId, clientIds),\n        eq(clientFamilyRelations.userId, userId)\n      ));\n\n    // Group by clientId\n    const resultMap = new Map<string, string[]>();\n    for (const clientId of clientIds) {\n      resultMap.set(clientId, []);\n    }\n\n    for (const relation of relations) {\n      const existing = resultMap.get(relation.clientId) || [];\n      existing.push(relation.relatedClientId);\n      resultMap.set(relation.clientId, existing);\n    }\n\n    return resultMap;\n  }\n\n  async addClientFamilyRelation(relation: InsertClientFamilyRelation): Promise<ClientFamilyRelation> {\n    const id = randomUUID();\n    const inverseId = randomUUID();\n    \n    // Check if relation already exists to prevent duplicates\n    const existing = await db.select().from(clientFamilyRelations)\n      .where(and(\n        eq(clientFamilyRelations.clientId, relation.clientId),\n        eq(clientFamilyRelations.relatedClientId, relation.relatedClientId),\n        eq(clientFamilyRelations.userId, relation.userId)\n      ))\n      .limit(1);\n    \n    if (existing.length > 0) {\n      return existing[0];\n    }\n    \n    // Add main relation (A → B)\n    const inserted = await db.insert(clientFamilyRelations)\n      .values({ id, ...relation })\n      .returning();\n    \n    // Add inverse relation (B → A)\n    await db.insert(clientFamilyRelations)\n      .values({ \n        id: inverseId,\n        clientId: relation.relatedClientId,\n        relatedClientId: relation.clientId,\n        userId: relation.userId\n      });\n    \n    return inserted[0];\n  }\n\n  async removeClientFamilyRelation(clientId: string, relatedClientId: string, userId: string): Promise<boolean> {\n    // Remove relation A → B\n    await db.delete(clientFamilyRelations)\n      .where(and(\n        eq(clientFamilyRelations.clientId, clientId),\n        eq(clientFamilyRelations.relatedClientId, relatedClientId),\n        eq(clientFamilyRelations.userId, userId)\n      ));\n    \n    // Remove inverse relation B → A\n    await db.delete(clientFamilyRelations)\n      .where(and(\n        eq(clientFamilyRelations.clientId, relatedClientId),\n        eq(clientFamilyRelations.relatedClientId, clientId),\n        eq(clientFamilyRelations.userId, userId)\n      ));\n    \n    return true;\n  }\n\n  async getSalesAnalytics(seasonId?: string, userId?: string): Promise<{\n    totalSales: number;\n    totalCommissions: number;\n    salesByCategory: { categoryId: string; categoryName: string; total: number; commissions: number }[];\n    topClients: { clientId: string; clientName: string; total: number; percentage: number }[];\n  }> {\n    let salesData: Sale[];\n    if (seasonId && userId) {\n      salesData = await db.select().from(sales)\n        .where(and(eq(sales.seasonId, seasonId), eq(sales.userId, userId)));\n    } else if (seasonId) {\n      salesData = await db.select().from(sales).where(eq(sales.seasonId, seasonId));\n    } else if (userId) {\n      salesData = await db.select().from(sales).where(eq(sales.userId, userId));\n    } else {\n      salesData = await db.select().from(sales);\n    }\n\n    const totalSales = salesData.reduce((sum, s) => sum + parseFloat(s.totalAmount), 0);\n    const totalCommissions = salesData.reduce((sum, s) => sum + parseFloat(s.commissionAmount), 0);\n\n    // Batch fetch only the categories needed (no N+1 queries)\n    const categoryIds = [...new Set(salesData.map(s => s.categoryId))];\n    const neededCategories = categoryIds.length > 0 \n      ? await db.select().from(categories).where(inArray(categories.id, categoryIds))\n      : [];\n    const categoryLookup = new Map(neededCategories.map(c => [c.id, c]));\n\n    const categoryMap = new Map<string, { total: number; commissions: number; name: string }>();\n    for (const sale of salesData) {\n      const existing = categoryMap.get(sale.categoryId) || { total: 0, commissions: 0, name: \"\" };\n      const category = categoryLookup.get(sale.categoryId);\n      categoryMap.set(sale.categoryId, {\n        total: existing.total + parseFloat(sale.totalAmount),\n        commissions: existing.commissions + parseFloat(sale.commissionAmount),\n        name: category?.name || \"Unknown\",\n      });\n    }\n\n    const salesByCategory = Array.from(categoryMap.entries()).map(([categoryId, data]) => ({\n      categoryId,\n      categoryName: data.name,\n      total: data.total,\n      commissions: data.commissions,\n    }));\n\n    // Batch fetch only the clients needed (no N+1 queries)\n    const clientMap = new Map<string, number>();\n    for (const sale of salesData) {\n      const existing = clientMap.get(sale.clientId) || 0;\n      clientMap.set(sale.clientId, existing + parseFloat(sale.totalAmount));\n    }\n\n    const clientIds = Array.from(clientMap.keys());\n    const neededClientLinks = clientIds.length > 0 \n      ? await db.select({\n          id: userClientLinks.id,\n          name: sql<string>`COALESCE(${userClientLinks.customName}, ${masterClients.name})`.as('name')\n        })\n        .from(userClientLinks)\n        .leftJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n        .where(inArray(userClientLinks.id, clientIds))\n      : [];\n    const clientLookup = new Map(neededClientLinks.map(c => [c.id, c.name || \"Unknown\"]));\n\n    const topClients = Array.from(clientMap.entries())\n      .map(([clientId, total]) => {\n        const clientName = clientLookup.get(clientId) || \"Unknown\";\n        return {\n          clientId,\n          clientName,\n          total,\n          percentage: totalSales > 0 ? (total / totalSales) * 100 : 0,\n        };\n      })\n      .sort((a, b) => b.total - a.total);\n\n    return {\n      totalSales,\n      totalCommissions,\n      salesByCategory,\n      topClients,\n    };\n  }\n\n  async getOpportunityAlerts(clientId?: string): Promise<{\n    clientId: string;\n    clientName: string;\n    missingProducts: string[];\n    category: string;\n    region: string;\n    severity: 'high' | 'medium' | 'low';\n  }[]> {\n    return [];\n  }\n\n  async getAlertSettings(userId: string): Promise<AlertSettings | undefined> {\n    const result = await db.select().from(alertSettings)\n      .where(eq(alertSettings.userId, userId));\n    return result[0];\n  }\n\n  async upsertAlertSettings(settings: InsertAlertSettings): Promise<AlertSettings> {\n    const existing = await this.getAlertSettings(settings.userId);\n    \n    if (existing) {\n      const updated = await db.update(alertSettings)\n        .set({ ...settings, updatedAt: new Date() })\n        .where(eq(alertSettings.userId, settings.userId))\n        .returning();\n      return updated[0];\n    } else {\n      const id = randomUUID();\n      const inserted = await db.insert(alertSettings)\n        .values({ id, ...settings })\n        .returning();\n      return inserted[0];\n    }\n  }\n\n  async getAlerts(userId: string): Promise<Alert[]> {\n    return await db.select().from(alerts)\n      .where(eq(alerts.userId, userId))\n      .orderBy(desc(alerts.createdAt));\n  }\n\n  async getUnreadAlertsCount(userId: string): Promise<number> {\n    const result = await db.select().from(alerts)\n      .where(and(\n        eq(alerts.userId, userId),\n        eq(alerts.isRead, false)\n      ));\n    return result.length;\n  }\n\n  async createAlert(alert: InsertAlert): Promise<Alert> {\n    const id = randomUUID();\n    const inserted = await db.insert(alerts)\n      .values({ id, ...alert })\n      .returning();\n    return inserted[0];\n  }\n\n  async markAlertAsRead(alertId: string, userId: string): Promise<boolean> {\n    await db.update(alerts)\n      .set({ isRead: true })\n      .where(and(\n        eq(alerts.id, alertId),\n        eq(alerts.userId, userId)\n      ));\n    return true;\n  }\n\n  async markAllAlertsAsRead(userId: string): Promise<boolean> {\n    await db.update(alerts)\n      .set({ isRead: true })\n      .where(eq(alerts.userId, userId));\n    return true;\n  }\n\n  async deleteAlert(alertId: string, userId: string): Promise<boolean> {\n    await db.delete(alerts)\n      .where(and(\n        eq(alerts.id, alertId),\n        eq(alerts.userId, userId)\n      ));\n    return true;\n  }\n\n  // Purchase History\n  async getPurchaseHistories(userId: string, clientId?: string, seasonId?: string): Promise<PurchaseHistory[]> {\n    const conditions = [eq(purchaseHistory.userId, userId)];\n    if (clientId) conditions.push(eq(purchaseHistory.clientId, clientId));\n    if (seasonId) conditions.push(eq(purchaseHistory.seasonId, seasonId));\n    \n    return await db.select().from(purchaseHistory)\n      .where(and(...conditions))\n      .orderBy(desc(purchaseHistory.importDate));\n  }\n\n  async getPurchaseHistory(id: string, userId: string): Promise<PurchaseHistory | undefined> {\n    const result = await db.select().from(purchaseHistory)\n      .where(and(\n        eq(purchaseHistory.id, id),\n        eq(purchaseHistory.userId, userId)\n      ))\n      .limit(1);\n    return result[0];\n  }\n\n  async createPurchaseHistory(history: InsertPurchaseHistory): Promise<PurchaseHistory> {\n    const id = randomUUID();\n    const inserted = await db.insert(purchaseHistory)\n      .values({ id, ...history })\n      .returning();\n    return inserted[0];\n  }\n\n  async deletePurchaseHistory(id: string, userId: string): Promise<boolean> {\n    await db.delete(purchaseHistory)\n      .where(and(\n        eq(purchaseHistory.id, id),\n        eq(purchaseHistory.userId, userId)\n      ));\n    return true;\n  }\n\n  async getPurchaseHistoryItems(purchaseHistoryId: string): Promise<PurchaseHistoryItem[]> {\n    return await db.select().from(purchaseHistoryItems)\n      .where(eq(purchaseHistoryItems.purchaseHistoryId, purchaseHistoryId))\n      .orderBy(purchaseHistoryItems.purchaseDate);\n  }\n\n  async createPurchaseHistoryItem(item: InsertPurchaseHistoryItem): Promise<PurchaseHistoryItem> {\n    const id = randomUUID();\n    const inserted = await db.insert(purchaseHistoryItems)\n      .values({ id, ...item })\n      .returning();\n    return inserted[0];\n  }\n\n  // Barter Module\n  async getAllBarterProducts(): Promise<BarterProduct[]> {\n    return await db.select().from(barterProducts).orderBy(barterProducts.category, barterProducts.name);\n  }\n\n  async createBarterProduct(product: InsertBarterProduct): Promise<BarterProduct> {\n    const id = randomUUID();\n    const inserted = await db.insert(barterProducts)\n      .values({ id, ...product })\n      .returning();\n    return inserted[0];\n  }\n\n  async updateBarterProduct(id: string, product: Partial<InsertBarterProduct>): Promise<BarterProduct | undefined> {\n    const updated = await db.update(barterProducts)\n      .set({ ...product, updatedAt: new Date() })\n      .where(eq(barterProducts.id, id))\n      .returning();\n    return updated[0];\n  }\n\n  async deleteBarterProduct(id: string): Promise<boolean> {\n    await db.delete(barterProducts).where(eq(barterProducts.id, id));\n    return true;\n  }\n\n  async deleteAllBarterProducts(): Promise<void> {\n    await db.delete(barterProducts);\n  }\n\n  async getAllBarterSettings(): Promise<BarterSettings[]> {\n    return await db.select().from(barterSettings);\n  }\n\n  async upsertBarterSetting(key: string, value: string, description?: string): Promise<BarterSettings> {\n    const existing = await db.select().from(barterSettings).where(eq(barterSettings.key, key)).limit(1);\n    \n    if (existing.length > 0) {\n      const updated = await db.update(barterSettings)\n        .set({ value, description, updatedAt: new Date() })\n        .where(eq(barterSettings.key, key))\n        .returning();\n      return updated[0];\n    } else {\n      const id = randomUUID();\n      const inserted = await db.insert(barterSettings)\n        .values({ id, key, value, description })\n        .returning();\n      return inserted[0];\n    }\n  }\n\n  async getBarterSimulationsByUser(userId: string): Promise<BarterSimulation[]> {\n    return await db.select().from(barterSimulations)\n      .where(eq(barterSimulations.userId, userId))\n      .orderBy(desc(barterSimulations.createdAt));\n  }\n\n  async getBarterSimulation(id: string): Promise<BarterSimulation | undefined> {\n    const sim = await db.select().from(barterSimulations)\n      .where(eq(barterSimulations.id, id))\n      .limit(1);\n    \n    if (sim.length === 0) return undefined;\n    \n    return sim[0];\n  }\n\n  async createBarterSimulation(simulation: InsertBarterSimulation, items: InsertBarterSimulationItem[]): Promise<BarterSimulation> {\n    const id = randomUUID();\n    const inserted = await db.insert(barterSimulations)\n      .values({ id, ...simulation })\n      .returning();\n    \n    if (items && items.length > 0) {\n      const itemsToInsert = items.map(item => ({\n        id: randomUUID(),\n        simulationId: id,\n        ...item\n      }));\n      await db.insert(barterSimulationItems).values(itemsToInsert);\n    }\n    \n    return inserted[0];\n  }\n\n  async updateBarterSimulation(id: string, simulation: Partial<InsertBarterSimulation>): Promise<BarterSimulation | undefined> {\n    const updated = await db.update(barterSimulations)\n      .set({ ...simulation, updatedAt: new Date() })\n      .where(eq(barterSimulations.id, id))\n      .returning();\n    \n    if (updated.length === 0) return undefined;\n    return updated[0];\n  }\n\n  async deleteBarterSimulation(id: string): Promise<boolean> {\n    await db.delete(barterSimulations).where(eq(barterSimulations.id, id));\n    return true;\n  }\n\n  // Sales Targets - Kanban de Metas\n  async getKanbanData(userId: string, seasonId: string): Promise<any> {\n    // Buscar taxas de investimento por cliente e categoria do menu Mercado\n    const clientRatesData = await db.execute(sql`\n      SELECT \n        cmr.client_id,\n        c.type as segmento,\n        cmr.investment_per_ha\n      FROM client_market_rates cmr\n      JOIN categories c ON c.id = cmr.category_id\n      WHERE cmr.user_id = ${userId}\n        AND cmr.season_id = ${seasonId}\n    `);\n\n    // Mapear taxas por cliente e segmento\n    const taxasPorClienteSegmento: any = {};\n    for (const rate of clientRatesData.rows as any[]) {\n      if (!taxasPorClienteSegmento[rate.client_id]) {\n        taxasPorClienteSegmento[rate.client_id] = {};\n      }\n      taxasPorClienteSegmento[rate.client_id][rate.segmento] = parseFloat(rate.investment_per_ha) || 0;\n    }\n\n    // Buscar clientes 80-20 do usuário com potenciais e vendas realizadas\n    const clientsData = await db.execute(sql`\n      SELECT \n        ucl.id as client_id,\n        COALESCE(ucl.custom_name, mc.name) as client_name,\n        ucl.planting_area,\n        ucl.is_top80_20\n      FROM user_client_links ucl\n      JOIN master_clients mc ON mc.id = ucl.master_client_id\n      WHERE ucl.user_id = ${userId}\n        AND ucl.is_top80_20 = true\n        AND ucl.is_active = true\n      ORDER BY client_name\n    `);\n\n    // Batch fetch all sales for all clients at once (no N+1 queries)\n    const clientIds = (clientsData.rows as any[]).map((c: any) => String(c.client_id));\n    \n    const allSalesRaw = clientIds.length > 0 ? await db.select({\n      clientId: sales.clientId,\n      segmento: categories.type,\n      totalVendido: sql<number>`COALESCE(SUM(${sales.totalAmount}), 0)`.as('total_vendido')\n    })\n      .from(sales)\n      .innerJoin(products, eq(sales.productId, products.id))\n      .innerJoin(categories, eq(products.categoryId, categories.id))\n      .where(and(\n        inArray(sales.clientId, clientIds),\n        eq(sales.seasonId, seasonId),\n        eq(sales.userId, userId)\n      ))\n      .groupBy(sales.clientId, categories.type) : [];\n\n    const allSalesData = { rows: allSalesRaw.map(r => ({ client_id: r.clientId, segmento: r.segmento, total_vendido: r.totalVendido })) };\n\n    // Map sales by client and segment\n    const vendasPorClienteSegmento: any = {};\n    for (const sale of allSalesData.rows as any[]) {\n      if (!vendasPorClienteSegmento[sale.client_id]) {\n        vendasPorClienteSegmento[sale.client_id] = {};\n      }\n      vendasPorClienteSegmento[sale.client_id][sale.segmento] = parseFloat(sale.total_vendido);\n    }\n\n    // Batch fetch all targets for all clients at once (no N+1 queries)\n    const allTargetsData = clientIds.length > 0 ? await db.select()\n      .from(salesTargets)\n      .where(and(\n        eq(salesTargets.userId, userId),\n        eq(salesTargets.seasonId, seasonId)\n      )) : [];\n\n    // Map targets by client and segment\n    const capturadoPorClienteSegmento: any = {};\n    for (const target of allTargetsData) {\n      if (!capturadoPorClienteSegmento[target.clientId]) {\n        capturadoPorClienteSegmento[target.clientId] = {};\n      }\n      capturadoPorClienteSegmento[target.clientId][target.segmento] = parseFloat(target.valorCapturado);\n    }\n\n    // Para cada cliente, calcular potenciais e realizados por segmento\n    const clients = [];\n    for (const client of clientsData.rows as any[]) {\n      const vendidoPorSegmento = vendasPorClienteSegmento[client.client_id] || {};\n      const capturadoPorSegmento = capturadoPorClienteSegmento[client.client_id] || {};\n\n      // Calcular potenciais usando taxas específicas do cliente do menu Mercado\n      const area = parseFloat(client.planting_area) || 0;\n      const clientRates = taxasPorClienteSegmento[client.client_id] || {};\n      const potenciais = {\n        fertilizantes: area * (clientRates.fertilizantes || 0),\n        agroquimicos: area * (clientRates.agroquimicos || 0),\n        especialidades: area * (clientRates.especialidades || 0),\n        sementes: area * (clientRates.sementes || 0),\n        corretivos: area * (clientRates.corretivos || 0)\n      };\n\n      clients.push({\n        id: client.client_id,\n        name: client.client_name,\n        area: area,\n        segmentos: {\n          fertilizantes: {\n            potencial: potenciais.fertilizantes,\n            realizado: vendidoPorSegmento.fertilizantes || 0,\n            capturado: capturadoPorSegmento.fertilizantes || 0,\n            oportunidade: Math.max(0, potenciais.fertilizantes - (vendidoPorSegmento.fertilizantes || 0))\n          },\n          agroquimicos: {\n            potencial: potenciais.agroquimicos,\n            realizado: vendidoPorSegmento.agroquimicos || 0,\n            capturado: capturadoPorSegmento.agroquimicos || 0,\n            oportunidade: Math.max(0, potenciais.agroquimicos - (vendidoPorSegmento.agroquimicos || 0))\n          },\n          especialidades: {\n            potencial: potenciais.especialidades,\n            realizado: vendidoPorSegmento.especialidades || 0,\n            capturado: capturadoPorSegmento.especialidades || 0,\n            oportunidade: Math.max(0, potenciais.especialidades - (vendidoPorSegmento.especialidades || 0))\n          },\n          sementes: {\n            potencial: potenciais.sementes,\n            realizado: vendidoPorSegmento.sementes || 0,\n            capturado: capturadoPorSegmento.sementes || 0,\n            oportunidade: Math.max(0, potenciais.sementes - (vendidoPorSegmento.sementes || 0))\n          },\n          corretivos: {\n            potencial: potenciais.corretivos,\n            realizado: vendidoPorSegmento.corretivos || 0,\n            capturado: capturadoPorSegmento.corretivos || 0,\n            oportunidade: Math.max(0, potenciais.corretivos - (vendidoPorSegmento.corretivos || 0))\n          }\n        }\n      });\n    }\n\n    return { clients };\n  }\n\n  async getSalesTargets(userId: string, seasonId?: string): Promise<SalesTarget[]> {\n    const conditions = [eq(salesTargets.userId, userId)];\n    \n    if (seasonId) {\n      conditions.push(eq(salesTargets.seasonId, seasonId));\n    }\n    \n    return await db.select()\n      .from(salesTargets)\n      .where(and(...conditions))\n      .orderBy(desc(salesTargets.createdAt));\n  }\n\n  async createSalesTarget(userId: string, clientId: string, segmento: string, valorCapturado: number, seasonId: string, subcategories?: Record<string, number>): Promise<SalesTarget> {\n    const id = randomUUID();\n    const inserted = await db.insert(salesTargets)\n      .values({\n        id,\n        userId,\n        clientId,\n        segmento,\n        seasonId,\n        valorCapturado: valorCapturado.toString(),\n        subcategories: subcategories ? JSON.stringify(subcategories) : null\n      })\n      .returning();\n    return inserted[0];\n  }\n\n  async updateSalesTarget(id: string, valorCapturado: number, subcategories?: Record<string, number>): Promise<SalesTarget> {\n    const updated = await db.update(salesTargets)\n      .set({\n        valorCapturado: valorCapturado.toString(),\n        subcategories: subcategories ? JSON.stringify(subcategories) : null,\n        updatedAt: new Date()\n      })\n      .where(eq(salesTargets.id, id))\n      .returning();\n    \n    if (updated.length === 0) {\n      throw new Error(\"Sales target not found\");\n    }\n    \n    return updated[0];\n  }\n\n  async deleteSalesTarget(id: string, userId: string): Promise<boolean> {\n    await db.delete(salesTargets)\n      .where(and(\n        eq(salesTargets.id, id),\n        eq(salesTargets.userId, userId)\n      ));\n    return true;\n  }\n\n  async getSystemSettings(): Promise<{ allowUserRegistration: boolean } | undefined> {\n    const [settings] = await db.select()\n      .from(systemSettings)\n      .limit(1);\n    \n    return settings ? {\n      allowUserRegistration: settings.allowUserRegistration\n    } : undefined;\n  }\n}\n\nexport const storage = new DBStorage();\n","size_bytes":91778},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","size_bytes":1753},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","size_bytes":1527},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","size_bytes":80},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","size_bytes":1056},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","size_bytes":8605},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","size_bytes":1080},"client/src/components/dashboard/quick-actions.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { PlusCircle, Upload, UserPlus, Download, Lightbulb } from \"lucide-react\";\n\ninterface QuickActionsProps {\n  onNewSale: () => void;\n  onImportPDF: () => void;\n}\n\nexport default function QuickActions({ onNewSale, onImportPDF }: QuickActionsProps) {\n  return (\n    <div className=\"space-y-4\">\n      <Card className=\"shadow-sm\" data-testid=\"quick-actions\">\n        <CardHeader>\n          <CardTitle className=\"text-lg font-bold\">Ações Rápidas</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-3\">\n            <Button \n              onClick={onNewSale}\n              className=\"w-full justify-center gap-2\"\n              data-testid=\"button-new-sale\"\n            >\n              <PlusCircle className=\"h-4 w-4\" />\n              Lançar Venda Manual\n            </Button>\n            \n            <Button \n              variant=\"outline\"\n              onClick={onImportPDF}\n              className=\"w-full justify-center gap-2\"\n              data-testid=\"button-import-pdf\"\n            >\n              <Upload className=\"h-4 w-4\" />\n              Importar PDF\n            </Button>\n            \n            <Button \n              variant=\"outline\"\n              className=\"w-full justify-center gap-2\"\n              data-testid=\"button-new-client\"\n            >\n              <UserPlus className=\"h-4 w-4\" />\n              Novo Cliente\n            </Button>\n            \n            <Button \n              variant=\"outline\"\n              className=\"w-full justify-center gap-2\"\n              data-testid=\"button-export-report\"\n            >\n              <Download className=\"h-4 w-4\" />\n              Exportar Relatório\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card className=\"bg-gradient-to-br from-primary to-secondary text-primary-foreground shadow-sm\">\n        <CardContent className=\"p-6\">\n          <div className=\"flex items-start gap-3 mb-4\">\n            <div className=\"w-10 h-10 bg-white/20 rounded-lg flex items-center justify-center\">\n              <Lightbulb className=\"text-xl\" size={20} />\n            </div>\n            <div>\n              <h4 className=\"font-bold mb-1\">Dica do Dia</h4>\n              <p className=\"text-sm opacity-90\">\n                Revise os alertas de oportunidade para maximizar vendas com clientes existentes.\n              </p>\n            </div>\n          </div>\n          <Button variant=\"link\" className=\"text-primary-foreground p-0 h-auto underline hover:no-underline\">\n            Saiba mais\n          </Button>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":2732},"client/src/components/dashboard/top-clients.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Filter } from \"lucide-react\";\n\ninterface TopClient {\n  clientId: string;\n  clientName: string;\n  total: number;\n  percentage: number;\n}\n\ninterface TopClientsProps {\n  clients: TopClient[];\n}\n\nexport default function TopClients({ clients }: TopClientsProps) {\n  const displayClients = clients.slice(0, 5);\n\n  const getRankColor = (rank: number) => {\n    switch (rank) {\n      case 1: return \"bg-primary/10 text-primary\";\n      case 2: return \"bg-secondary/10 text-secondary\";\n      case 3: return \"bg-accent/10 text-accent\";\n      case 4: return \"bg-chart-4/10 text-chart-4\";\n      case 5: return \"bg-chart-5/10 text-chart-5\";\n      default: return \"bg-muted text-muted-foreground\";\n    }\n  };\n\n  if (displayClients.length === 0) {\n    return (\n      <Card className=\"shadow-sm\" data-testid=\"top-clients\">\n        <CardHeader className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle className=\"text-lg font-bold\">Top Clientes 80/20</CardTitle>\n            <p className=\"text-sm text-muted-foreground\">Principais contribuintes de receita</p>\n          </div>\n          <Button variant=\"ghost\" size=\"sm\">\n            <Filter className=\"h-4 w-4\" />\n          </Button>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-center py-8 text-muted-foreground\">\n            Nenhum cliente com vendas\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className=\"shadow-sm\" data-testid=\"top-clients\">\n      <CardHeader className=\"flex items-center justify-between\">\n        <div>\n          <CardTitle className=\"text-lg font-bold\">Top Clientes 80/20</CardTitle>\n          <p className=\"text-sm text-muted-foreground\">Principais contribuintes de receita</p>\n        </div>\n        <Button variant=\"ghost\" size=\"sm\">\n          <Filter className=\"h-4 w-4\" />\n        </Button>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-3\">\n          {displayClients.map((client, index) => {\n            const rank = index + 1;\n            \n            return (\n              <div \n                key={client.clientId}\n                className=\"flex items-center gap-4 p-3 hover:bg-muted/50 rounded-lg transition-colors\"\n                data-testid={`client-${client.clientId}`}\n              >\n                <div className={`w-10 h-10 rounded-full flex items-center justify-center ${getRankColor(rank)}`}>\n                  <span className=\"text-sm font-bold\">{rank}</span>\n                </div>\n                <div className=\"flex-1\">\n                  <p className=\"text-sm font-semibold text-foreground\">{client.clientName}</p>\n                </div>\n                <div className=\"text-right\">\n                  <p className=\"text-sm font-bold text-foreground font-mono\">\n                    ${client.total.toLocaleString()}\n                  </p>\n                  <p className=\"text-xs text-verde\">{client.percentage.toFixed(1)}% do total</p>\n                </div>\n              </div>\n            );\n          })}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":3211},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","size_bytes":1280},"client/src/pages/vendas.tsx":{"content":"import Navbar from \"@/components/layout/navbar\";\nimport Header from \"@/components/layout/header\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport NewSaleModal from \"@/components/modals/new-sale-modal\";\nimport EditSaleModal from \"@/components/modals/edit-sale-modal\";\nimport { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { Search, Filter, Download, Plus, Calendar, DollarSign, Edit, Award, RefreshCcw, ChevronDown, ChevronRight, Repeat, Maximize2, X } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { Sale, Client, Category, Product } from \"@shared/schema\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\n\nconst MONTHS = [\n  { value: \"1\", label: \"Janeiro\" },\n  { value: \"2\", label: \"Fevereiro\" },\n  { value: \"3\", label: \"Março\" },\n  { value: \"4\", label: \"Abril\" },\n  { value: \"5\", label: \"Maio\" },\n  { value: \"6\", label: \"Junho\" },\n  { value: \"7\", label: \"Julho\" },\n  { value: \"8\", label: \"Agosto\" },\n  { value: \"9\", label: \"Setembro\" },\n  { value: \"10\", label: \"Outubro\" },\n  { value: \"11\", label: \"Novembro\" },\n  { value: \"12\", label: \"Dezembro\" },\n];\n\nexport default function Vendas() {\n  const [showNewSaleModal, setShowNewSaleModal] = useState(false);\n  const [editingSale, setEditingSale] = useState<Sale | null>(null);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [selectedSeason, setSelectedSeason] = useState(\"\");\n  const [selectedCategory, setSelectedCategory] = useState(\"\");\n  const [selectedMarca, setSelectedMarca] = useState(\"\");\n  const [selectedProduct, setSelectedProduct] = useState(\"\");\n  const [selectedMonth, setSelectedMonth] = useState(\"\");\n  const [expandedBarterClients, setExpandedBarterClients] = useState<Set<string>>(new Set());\n  const [showManualCommissionModal, setShowManualCommissionModal] = useState(false);\n  const [selectedBarterClientId, setSelectedBarterClientId] = useState<string | null>(null);\n  const [manualCommissionValue, setManualCommissionValue] = useState(\"\");\n  const [isFullscreen, setIsFullscreen] = useState(false);\n  const { toast } = useToast();\n\n  const { data: user } = useQuery<any>({\n    queryKey: [\"/api/user\"],\n  });\n\n  const { data: sales, isLoading } = useQuery<Sale[]>({\n    queryKey: [\"/api/sales\"],\n  });\n\n  const { data: clients } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: categories } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const { data: products } = useQuery<Product[]>({\n    queryKey: [\"/api/products\"],\n  });\n\n  const { data: seasons } = useQuery<{ id: string; name: string }[]>({\n    queryKey: [\"/api/seasons\"],\n  });\n\n  const { data: timacSettings } = useQuery<any>({\n    queryKey: [\"/api/timac-settings\"],\n  });\n\n  const recalculateSalesMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/sales/recalculate-all\", {});\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/sales\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/analytics/sales\"] });\n      toast({\n        title: \"Vendas recalculadas\",\n        description: `${data.updatedCount} de ${data.totalSales} vendas foram recalculadas com sucesso.`,\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao recalcular vendas. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const manualCommissionMutation = useMutation({\n    mutationFn: async ({ clientId, commissionAmount }: { clientId: string; commissionAmount: number }) => {\n      return apiRequest(\"PATCH\", `/api/sales/barter/${clientId}/manual-commission`, { commissionAmount });\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/sales\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/analytics/sales\"] });\n      toast({\n        title: \"Comissão atualizada\",\n        description: `Comissão manual de $${manualCommissionValue} aplicada a ${data.updatedCount} venda(s) barter.`,\n      });\n      setShowManualCommissionModal(false);\n      setManualCommissionValue(\"\");\n      setSelectedBarterClientId(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao atualizar comissão manual. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Reset product filter when marca changes and selected product is not from the selected marca\n  useEffect(() => {\n    if (selectedMarca && selectedMarca !== \"all\" && selectedProduct && selectedProduct !== \"all\") {\n      const product = products?.find(p => p.id === selectedProduct);\n      if (product && product.marca?.toUpperCase() !== selectedMarca) {\n        setSelectedProduct(\"\");\n      }\n    }\n  }, [selectedMarca, selectedProduct, products]);\n\n  const openNewSaleModal = () => {\n    setShowNewSaleModal(true);\n  };\n\n  const toggleBarterClient = (clientId: string) => {\n    const newExpanded = new Set(expandedBarterClients);\n    if (newExpanded.has(clientId)) {\n      newExpanded.delete(clientId);\n    } else {\n      newExpanded.add(clientId);\n    }\n    setExpandedBarterClients(newExpanded);\n  };\n\n  const openManualCommissionModal = (clientId: string) => {\n    setSelectedBarterClientId(clientId);\n    setShowManualCommissionModal(true);\n  };\n\n  const handleManualCommissionSubmit = () => {\n    if (!selectedBarterClientId) return;\n    \n    // Normalize decimal separator (replace comma with dot for PT-BR users)\n    const normalizedValue = manualCommissionValue.replace(',', '.');\n    const value = parseFloat(normalizedValue);\n    \n    if (isNaN(value) || value < 0) {\n      toast({\n        title: \"Valor inválido\",\n        description: \"Por favor, insira um valor de comissão válido (use . ou , como separador decimal).\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    manualCommissionMutation.mutate({\n      clientId: selectedBarterClientId,\n      commissionAmount: value,\n    });\n  };\n\n  const getTierBadgeClass = (tier: string) => {\n    switch (tier) {\n      case 'verde': \n        return 'bg-green-100 text-green-700 border-green-500 dark:bg-green-950 dark:text-green-400 dark:border-green-600';\n      case 'amarela': \n        return 'bg-yellow-100 text-yellow-700 border-yellow-500 dark:bg-yellow-950 dark:text-yellow-400 dark:border-yellow-600';\n      case 'vermelha': \n        return 'bg-red-100 text-red-700 border-red-500 dark:bg-red-950 dark:text-red-400 dark:border-red-600';\n      case 'abaixo_lista':\n        return 'bg-gray-700 text-gray-100 border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:border-gray-700';\n      case 'barter':\n        return 'bg-blue-100 text-blue-700 border-blue-500 dark:bg-blue-950 dark:text-blue-400 dark:border-blue-600';\n      default: \n        return 'bg-gray-700 text-gray-100 border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:border-gray-700';\n    }\n  };\n\n  const getClientName = (clientId: string) => {\n    return clients?.find(c => c.id === clientId)?.name || \"Cliente não encontrado\";\n  };\n\n  const getCategoryName = (categoryId: string) => {\n    return categories?.find(c => c.id === categoryId)?.name || \"Categoria não encontrada\";\n  };\n\n  const getProductName = (productId: string) => {\n    return products?.find(p => p.id === productId)?.name || \"Produto manual\";\n  };\n\n  const getProductMarca = (productId: string) => {\n    return products?.find(p => p.id === productId)?.marca || null;\n  };\n\n  // Get unique marcas from products (normalized to uppercase for filtering, but preserve original for display)\n  const marcaMap = new Map<string, string>();\n  products?.forEach(p => {\n    if (p.marca && p.marca !== \"\") {\n      const normalized = p.marca.toUpperCase();\n      if (!marcaMap.has(normalized)) {\n        marcaMap.set(normalized, p.marca);\n      }\n    }\n  });\n  \n  const uniqueMarcas = Array.from(marcaMap.entries())\n    .sort((a, b) => a[0].localeCompare(b[0]))\n    .map(([normalized, original]) => ({ value: normalized, label: original }));\n\n  // Filter products based on selected marca\n  const availableProducts = products\n    ?.filter(product => {\n      if (!selectedMarca || selectedMarca === \"all\") return true;\n      return product.marca?.toUpperCase() === selectedMarca;\n    })\n    .slice()\n    .sort((a, b) => a.name.localeCompare(b.name)) || [];\n\n  const filteredSales = sales?.filter(sale => {\n    const clientName = getClientName(sale.clientId).toLowerCase();\n    const productName = getProductName(sale.productId).toLowerCase();\n    const searchMatch = clientName.includes(searchTerm.toLowerCase()) || \n                       productName.includes(searchTerm.toLowerCase());\n    \n    const seasonMatch = !selectedSeason || selectedSeason === \"all\" || sale.seasonId === selectedSeason;\n    const categoryMatch = !selectedCategory || selectedCategory === \"all\" || sale.categoryId === selectedCategory;\n    const marcaMatch = !selectedMarca || selectedMarca === \"all\" || getProductMarca(sale.productId)?.toUpperCase() === selectedMarca;\n    const productMatch = !selectedProduct || selectedProduct === \"all\" || sale.productId === selectedProduct;\n    \n    // Month filter - extract month from sale date\n    const monthMatch = !selectedMonth || selectedMonth === \"all\" || (() => {\n      const saleDate = new Date(sale.saleDate);\n      const saleMonth = saleDate.getMonth() + 1; // getMonth() returns 0-11\n      return saleMonth.toString() === selectedMonth;\n    })();\n\n    return searchMatch && seasonMatch && categoryMatch && marcaMatch && productMatch && monthMatch;\n  }) || [];\n\n  // Separate normal sales from barter sales\n  const normalSales = filteredSales.filter(sale => sale.commissionTier !== 'barter');\n  const barterSales = filteredSales.filter(sale => sale.commissionTier === 'barter');\n\n  // Group barter sales by client\n  const barterByClient = barterSales.reduce((acc, sale) => {\n    if (!acc[sale.clientId]) {\n      acc[sale.clientId] = [];\n    }\n    acc[sale.clientId].push(sale);\n    return acc;\n  }, {} as Record<string, Sale[]>);\n\n  // Create barter client groups with totals\n  const barterClientGroups = Object.entries(barterByClient).map(([clientId, sales]) => {\n    const totalAmount = sales.reduce((sum, sale) => sum + parseFloat(sale.totalAmount), 0);\n    const totalCommission = sales.reduce((sum, sale) => sum + parseFloat(sale.commissionAmount), 0);\n    return {\n      clientId,\n      clientName: getClientName(clientId),\n      sales,\n      totalAmount,\n      totalCommission,\n      salesCount: sales.length,\n    };\n  });\n\n  const totalSales = filteredSales.reduce((sum, sale) => sum + parseFloat(sale.totalAmount), 0);\n  const totalCommissions = filteredSales.reduce((sum, sale) => sum + parseFloat(sale.commissionAmount), 0);\n\n  // Filtrar apenas vendas com pontos Timac\n  const timacSales = filteredSales.filter(sale => sale.timacPoints && parseFloat(sale.timacPoints) > 0);\n  \n  // Calcular total de pontos usando a mesma lógica da tabela\n  const totalTimacPoints = timacSales.reduce((sum, sale) => {\n    const product = products?.find(p => p.id === sale.productId);\n    const packageSize = product?.packageSize ? parseFloat(product.packageSize) : 1;\n    \n    const quantity = sale.quantity ? parseFloat(sale.quantity) : 0;\n    const cantPedido = packageSize > 0 ? quantity / packageSize : 0;\n    const quantidadeTotal = cantPedido * packageSize;\n    \n    // Use timacPoints from product database instead of hardcoded logic\n    const ptsPerUnit = product?.timacPoints ? parseFloat(product.timacPoints) : 0;\n    const totalPontos = ptsPerUnit * quantidadeTotal;\n    \n    return sum + totalPontos;\n  }, 0);\n  \n  // Get value per point based on user type\n  const getTimacValuePerPoint = () => {\n    if (!timacSettings || !user) return 0.76; // fallback\n    \n    const userRole = user.role?.toLowerCase() || 'consultor';\n    \n    if (userRole.includes('consultor')) {\n      return parseFloat(timacSettings.consultorValue || \"0.76\");\n    } else if (userRole.includes('gerente')) {\n      return parseFloat(timacSettings.gerentesValue || \"0.76\");\n    } else if (userRole.includes('faturista')) {\n      return parseFloat(timacSettings.faturistasValue || \"0.76\");\n    }\n    \n    return parseFloat(timacSettings.consultorValue || \"0.76\"); // default to consultor\n  };\n  \n  const timacRewardPerPoint = getTimacValuePerPoint();\n  const totalTimacReward = totalTimacPoints * timacRewardPerPoint;\n\n  if (isLoading) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-32 w-32 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-screen flex flex-col overflow-hidden\" data-testid=\"vendas-container\">\n      <Header \n        onNewSale={openNewSaleModal}\n        title=\"Gestão de Vendas\"\n        subtitle=\"Controle e acompanhamento de todas as vendas\"\n      />\n      <Navbar />\n      \n      <main className=\"flex-1 overflow-y-auto\">\n        <div className=\"p-4 md:p-8 space-y-4 md:space-y-6\">\n          {/* Filters and Actions - First */}\n          <Card className=\"shadow-sm\">\n            <CardHeader>\n              <CardTitle className=\"text-base md:text-lg\">Filtros e Ações</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex flex-col md:flex-row md:flex-wrap gap-3 md:gap-4 md:items-end\">\n                <div className=\"flex-1 md:min-w-64\">\n                  <div className=\"relative\">\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                    <Input\n                      placeholder=\"Buscar por cliente ou produto...\"\n                      value={searchTerm}\n                      onChange={(e) => setSearchTerm(e.target.value)}\n                      className=\"pl-10\"\n                      data-testid=\"search-sales\"\n                    />\n                  </div>\n                </div>\n\n                <Select value={selectedSeason} onValueChange={setSelectedSeason}>\n                  <SelectTrigger className=\"w-full md:w-48\" data-testid=\"filter-season\">\n                    <SelectValue placeholder=\"Filtrar por safra\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todas as safras</SelectItem>\n                    {seasons?.map((season: any) => (\n                      <SelectItem key={season.id} value={season.id}>\n                        {season.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n\n                <Select value={selectedCategory} onValueChange={setSelectedCategory}>\n                  <SelectTrigger className=\"w-full md:w-48\" data-testid=\"filter-category\">\n                    <SelectValue placeholder=\"Filtrar por categoria\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todas as categorias</SelectItem>\n                    {categories?.map((category) => (\n                      <SelectItem key={category.id} value={category.id}>\n                        {category.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n\n                <Select value={selectedMarca} onValueChange={setSelectedMarca}>\n                  <SelectTrigger className=\"w-full md:w-48\" data-testid=\"filter-marca\">\n                    <SelectValue placeholder=\"Filtrar por fabricante\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todos os fabricantes</SelectItem>\n                    {uniqueMarcas?.map((marca) => (\n                      <SelectItem key={marca.value} value={marca.value}>\n                        {marca.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n\n                <Select value={selectedProduct} onValueChange={setSelectedProduct}>\n                  <SelectTrigger className=\"w-full md:w-48\" data-testid=\"filter-product\">\n                    <SelectValue placeholder=\"Filtrar por produto\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todos os produtos</SelectItem>\n                    {availableProducts.map((product) => (\n                      <SelectItem key={product.id} value={product.id}>\n                        {product.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n\n                <Select value={selectedMonth} onValueChange={setSelectedMonth}>\n                  <SelectTrigger className=\"w-full md:w-48\" data-testid=\"filter-month\">\n                    <SelectValue placeholder=\"Filtrar por mês\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todos os meses</SelectItem>\n                    {MONTHS.map((month) => (\n                      <SelectItem key={month.value} value={month.value}>\n                        {month.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n\n                <div className=\"flex gap-2\">\n                  <Button variant=\"outline\" className=\"w-full md:w-auto\" data-testid=\"button-export\">\n                    <Download className=\"h-4 w-4 mr-2\" />\n                    Exportar\n                  </Button>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Tabs for Vendas and Pontos Timac */}\n          <Tabs defaultValue=\"vendas\" className=\"space-y-4 md:space-y-6\">\n            {/* Cards de navegação e resumo - empilhados em mobile */}\n            <div className=\"flex flex-col md:flex-row gap-4 md:gap-6\">\n              {/* Cards de navegação quadrados lado a lado */}\n              <TabsList className=\"grid grid-cols-2 h-auto bg-transparent p-0 gap-3 w-full md:w-auto\">\n                <TabsTrigger \n                  value=\"vendas\" \n                  data-testid=\"tab-vendas\"\n                  className=\"h-auto p-0 bg-transparent border-0 data-[state=active]:bg-transparent\"\n                  asChild\n                >\n                  <Card className=\"shadow-sm cursor-pointer transition-all aspect-square data-[state=active]:ring-2 data-[state=active]:ring-amber-500 data-[state=active]:bg-amber-50 hover:shadow-md w-full md:w-32\">\n                    <CardContent className=\"p-3 md:p-4 h-full flex flex-col items-center justify-center text-center\">\n                      <div className=\"w-8 h-8 md:w-10 md:h-10 bg-amber-500/10 rounded-lg flex items-center justify-center mb-2\">\n                        <DollarSign className=\"text-amber-500\" size={18} />\n                      </div>\n                      <p className=\"text-xs md:text-sm font-semibold\">Vendas</p>\n                    </CardContent>\n                  </Card>\n                </TabsTrigger>\n                \n                <TabsTrigger \n                  value=\"timac\" \n                  data-testid=\"tab-timac\"\n                  className=\"h-auto p-0 bg-transparent border-0 data-[state=active]:bg-transparent\"\n                  asChild\n                >\n                  <Card className=\"shadow-sm cursor-pointer transition-all aspect-square data-[state=active]:ring-2 data-[state=active]:ring-blue-500 data-[state=active]:bg-blue-50 hover:shadow-md w-full md:w-32\">\n                    <CardContent className=\"p-3 md:p-4 h-full flex flex-col items-center justify-center text-center\">\n                      <div className=\"w-8 h-8 md:w-10 md:h-10 bg-blue-500/10 rounded-lg flex items-center justify-center mb-2\">\n                        <Award className=\"text-blue-500\" size={18} />\n                      </div>\n                      <p className=\"text-xs md:text-sm font-semibold\">Pontos Timac</p>\n                    </CardContent>\n                  </Card>\n                </TabsTrigger>\n              </TabsList>\n\n              {/* Cards de resumo - empilhados em mobile, horizontal em desktop */}\n              <div className=\"grid grid-cols-1 md:flex md:gap-4 md:flex-1 gap-3\">\n                <Card className=\"shadow-sm md:flex-1\">\n                  <CardContent className=\"p-3 md:p-4\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center flex-shrink-0\">\n                        <DollarSign className=\"text-primary\" size={20} />\n                      </div>\n                      <div>\n                        <p className=\"text-xs text-muted-foreground\">Total de Vendas</p>\n                        <p className=\"text-lg md:text-xl font-bold font-mono\">${totalSales.toLocaleString()}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"shadow-sm md:flex-1\">\n                  <CardContent className=\"p-3 md:p-4\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"w-10 h-10 bg-verde/10 rounded-lg flex items-center justify-center flex-shrink-0\">\n                        <DollarSign className=\"text-verde\" size={20} />\n                      </div>\n                      <div>\n                        <p className=\"text-xs text-muted-foreground\">Total de Comissões</p>\n                        <p className=\"text-lg md:text-xl font-bold font-mono text-verde\">${totalCommissions.toLocaleString()}</p>\n                        <p className=\"text-[10px] text-muted-foreground\">\n                          {totalSales > 0 ? ((totalCommissions / totalSales) * 100).toFixed(2) : 0}% sobre vendas\n                        </p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"shadow-sm md:flex-1\">\n                  <CardContent className=\"p-3 md:p-4\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className=\"w-10 h-10 bg-chart-2/10 rounded-lg flex items-center justify-center flex-shrink-0\">\n                        <Calendar className=\"text-chart-2\" size={20} />\n                      </div>\n                      <div>\n                        <p className=\"text-xs text-muted-foreground\">Total de Vendas</p>\n                        <p className=\"text-lg md:text-xl font-bold\">{filteredSales.length}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n            </div>\n\n            <TabsContent value=\"vendas\" className=\"space-y-6\">\n          {/* Sales Table */}\n          <Card className=\"shadow-sm\">\n            <CardHeader>\n              <CardTitle>Lista de Vendas</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {filteredSales.length === 0 ? (\n                <div className=\"text-center py-12\">\n                  <p className=\"text-muted-foreground\">Nenhuma venda encontrada</p>\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Data</TableHead>\n                        <TableHead>Cliente</TableHead>\n                        <TableHead>Produto</TableHead>\n                        <TableHead className=\"text-right\">Cant. Produtos</TableHead>\n                        <TableHead>Categoria</TableHead>\n                        <TableHead className=\"text-right\">Valor (USD)</TableHead>\n                        <TableHead className=\"text-right\">Comissão</TableHead>\n                        <TableHead className=\"text-center\">Faixa</TableHead>\n                        <TableHead>Vencimento</TableHead>\n                        <TableHead className=\"text-center\">Ações</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {/* Render barter client groups first */}\n                      {barterClientGroups.map((group) => {\n                        const isExpanded = expandedBarterClients.has(group.clientId);\n                        return (\n                          <>\n                            {/* Barter client summary row */}\n                            <TableRow \n                              key={`barter-${group.clientId}`} \n                              className=\"bg-blue-50 dark:bg-blue-950/30 hover:bg-blue-100 dark:hover:bg-blue-900/40 cursor-pointer\"\n                              onClick={() => toggleBarterClient(group.clientId)}\n                              data-testid={`barter-client-${group.clientId}`}\n                            >\n                              <TableCell>\n                                {isExpanded ? (\n                                  <ChevronDown className=\"h-4 w-4 inline mr-2\" />\n                                ) : (\n                                  <ChevronRight className=\"h-4 w-4 inline mr-2\" />\n                                )}\n                                {group.salesCount} venda(s)\n                              </TableCell>\n                              <TableCell className=\"font-bold flex items-center gap-2\">\n                                {group.clientName}\n                                <Badge className={getTierBadgeClass('barter')}>\n                                  <Repeat className=\"h-3 w-3 mr-1\" />\n                                  BARTER\n                                </Badge>\n                              </TableCell>\n                              <TableCell colSpan={3} className=\"text-muted-foreground italic\">\n                                {group.salesCount} produto(s)\n                              </TableCell>\n                              <TableCell className=\"text-right font-mono font-bold\">\n                                ${group.totalAmount.toLocaleString()}\n                              </TableCell>\n                              <TableCell className=\"text-right font-mono text-verde font-bold\">\n                                ${group.totalCommission.toLocaleString()}\n                              </TableCell>\n                              <TableCell></TableCell>\n                              <TableCell></TableCell>\n                              <TableCell className=\"text-center\">\n                                <Button\n                                  variant=\"outline\"\n                                  size=\"sm\"\n                                  onClick={(e) => {\n                                    e.stopPropagation();\n                                    openManualCommissionModal(group.clientId);\n                                  }}\n                                  data-testid={`button-manual-commission-${group.clientId}`}\n                                >\n                                  <DollarSign className=\"h-4 w-4 mr-1\" />\n                                  Comissão\n                                </Button>\n                              </TableCell>\n                            </TableRow>\n\n                            {/* Expanded product rows */}\n                            {isExpanded && group.sales.map((sale) => (\n                              <TableRow \n                                key={sale.id} \n                                className=\"bg-blue-50/50 dark:bg-blue-950/10\"\n                                data-testid={`barter-sale-${sale.id}`}\n                              >\n                                <TableCell className=\"pl-8\">\n                                  {format(new Date(sale.saleDate), \"dd/MM/yyyy\")}\n                                </TableCell>\n                                <TableCell className=\"text-muted-foreground italic pl-8\">\n                                  → Produto\n                                </TableCell>\n                                <TableCell>\n                                  {getProductName(sale.productId)}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono\">\n                                  {sale.quantity ? parseFloat(sale.quantity).toLocaleString('pt-BR', { maximumFractionDigits: 2 }) : '-'}\n                                </TableCell>\n                                <TableCell>\n                                  {getCategoryName(sale.categoryId)}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono\">\n                                  ${parseFloat(sale.totalAmount).toLocaleString()}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono text-verde\">\n                                  ${parseFloat(sale.commissionAmount).toLocaleString()}\n                                </TableCell>\n                                <TableCell></TableCell>\n                                <TableCell>\n                                  {format(new Date(sale.dueDate), \"dd/MM/yyyy\")}\n                                </TableCell>\n                                <TableCell></TableCell>\n                              </TableRow>\n                            ))}\n                          </>\n                        );\n                      })}\n\n                      {/* Render normal sales */}\n                      {normalSales.map((sale) => (\n                        <TableRow key={sale.id} data-testid={`sale-row-${sale.id}`}>\n                          <TableCell>\n                            {format(new Date(sale.saleDate), \"dd/MM/yyyy\")}\n                          </TableCell>\n                          <TableCell className=\"font-medium\">\n                            {getClientName(sale.clientId)}\n                          </TableCell>\n                          <TableCell>\n                            {getProductName(sale.productId)}\n                            {sale.isManual && (\n                              <Badge variant=\"outline\" className=\"ml-2 text-xs\">\n                                Manual\n                              </Badge>\n                            )}\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\" data-testid={`quantity-${sale.id}`}>\n                            {sale.quantity ? parseFloat(sale.quantity).toLocaleString('pt-BR', { maximumFractionDigits: 2 }) : '-'}\n                          </TableCell>\n                          <TableCell>\n                            {getCategoryName(sale.categoryId)}\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            ${parseFloat(sale.totalAmount).toLocaleString()}\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono text-verde\">\n                            ${parseFloat(sale.commissionAmount).toLocaleString()}\n                          </TableCell>\n                          <TableCell className=\"text-center\">\n                            <Badge className={`${getTierBadgeClass(sale.commissionTier)} capitalize`}>\n                              {sale.commissionTier}\n                            </Badge>\n                          </TableCell>\n                          <TableCell>\n                            {format(new Date(sale.dueDate), \"dd/MM/yyyy\")}\n                          </TableCell>\n                          <TableCell className=\"text-center\">\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => setEditingSale(sale)}\n                              data-testid={`button-edit-sale-${sale.id}`}\n                            >\n                              <Edit className=\"h-4 w-4\" />\n                            </Button>\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n            </TabsContent>\n\n            <TabsContent value=\"timac\" className=\"space-y-6\">\n              {/* Resumo Pontos Timac */}\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n                <Card className=\"shadow-sm\">\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                        <Award className=\"text-chart-2\" size={24} />\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Total de Pontos</p>\n                        <p className=\"text-2xl font-bold font-mono\">{totalTimacPoints.toLocaleString('pt-BR', { maximumFractionDigits: 2 })}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"shadow-sm\">\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"w-12 h-12 bg-verde/10 rounded-lg flex items-center justify-center\">\n                        <DollarSign className=\"text-verde\" size={24} />\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Valor por Ponto</p>\n                        <p className=\"text-2xl font-bold font-mono text-verde\">${timacRewardPerPoint.toFixed(2)} USD</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"shadow-sm\">\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center\">\n                        <DollarSign className=\"text-primary\" size={24} />\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Premiação Total</p>\n                        <p className=\"text-2xl font-bold font-mono\">${totalTimacReward.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} USD</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Tabela Detalhada Pontos Timac */}\n              <Card className=\"shadow-sm\">\n                <CardHeader>\n                  <CardTitle>Análise Detalhada de Pontos Timac</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {timacSales.length === 0 ? (\n                    <div className=\"text-center py-12\">\n                      <Award className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                      <p className=\"text-muted-foreground\">Nenhuma venda com pontos Timac encontrada</p>\n                      <p className=\"text-sm text-muted-foreground mt-2\">\n                        Produtos Timac da categoria Especialidades geram pontos de premiação\n                      </p>\n                    </div>\n                  ) : (\n                    <div className=\"overflow-x-auto\">\n                      <Table>\n                        <TableHeader>\n                          <TableRow>\n                            <TableHead>Cliente</TableHead>\n                            <TableHead>Produto</TableHead>\n                            <TableHead>Marca</TableHead>\n                            <TableHead>Data</TableHead>\n                            <TableHead>Safra</TableHead>\n                            <TableHead className=\"text-right\">Cant. Pedido</TableHead>\n                            <TableHead className=\"text-right\">Package Size</TableHead>\n                            <TableHead className=\"text-right\">Quantidade Total</TableHead>\n                            <TableHead className=\"text-right\">Pts/Unidade</TableHead>\n                            <TableHead className=\"text-right\">Total Pontos</TableHead>\n                          </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                          {timacSales.map((sale) => {\n                            const product = products?.find(p => p.id === sale.productId);\n                            const productName = product?.name || \"Produto manual\";\n                            const marca = product?.marca || \"-\";\n                            const packageSize = product?.packageSize ? parseFloat(product.packageSize) : 1;\n                            \n                            // Calcular Cant. Pedido baseado em quantity e packageSize\n                            const quantity = sale.quantity ? parseFloat(sale.quantity) : 0;\n                            const cantPedido = packageSize > 0 ? quantity / packageSize : 0;\n                            \n                            // Quantidade total = Cant. Pedido × Package Size\n                            const quantidadeTotal = cantPedido * packageSize;\n                            \n                            // Use timacPoints from product database\n                            const ptsPerUnit = product?.timacPoints ? parseFloat(product.timacPoints) : 0;\n                            \n                            // Total de pontos = Pts/Unidade × Quantidade Total\n                            const totalPontos = ptsPerUnit * quantidadeTotal;\n                            \n                            const season = seasons?.find(s => s.id === sale.seasonId);\n                            \n                            return (\n                              <TableRow key={sale.id} data-testid={`timac-sale-${sale.id}`}>\n                                <TableCell className=\"font-medium\">\n                                  {getClientName(sale.clientId)}\n                                </TableCell>\n                                <TableCell>\n                                  {productName}\n                                </TableCell>\n                                <TableCell>\n                                  {marca}\n                                </TableCell>\n                                <TableCell>\n                                  {format(new Date(sale.saleDate), \"dd/MM/yyyy\")}\n                                </TableCell>\n                                <TableCell>\n                                  {season?.name || '-'}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono\">\n                                  {cantPedido.toLocaleString('pt-BR', { maximumFractionDigits: 2 })}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono\">\n                                  {packageSize.toLocaleString('pt-BR', { maximumFractionDigits: 2 })}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono\">\n                                  {quantidadeTotal.toLocaleString('pt-BR', { maximumFractionDigits: 2 })}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono\">\n                                  {ptsPerUnit}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono font-bold text-verde\">\n                                  {totalPontos.toLocaleString('pt-BR', { maximumFractionDigits: 2 })}\n                                </TableCell>\n                              </TableRow>\n                            );\n                          })}\n                        </TableBody>\n                      </Table>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </main>\n\n      <NewSaleModal \n        isOpen={showNewSaleModal} \n        onClose={() => setShowNewSaleModal(false)} \n      />\n      \n      <EditSaleModal \n        isOpen={!!editingSale} \n        onClose={() => setEditingSale(null)} \n        sale={editingSale}\n      />\n\n      {/* Manual Commission Modal */}\n      <Dialog open={showManualCommissionModal} onOpenChange={setShowManualCommissionModal}>\n        <DialogContent data-testid=\"manual-commission-modal\">\n          <DialogHeader>\n            <DialogTitle>Comissão Manual - BARTER</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"client-name\">Cliente</Label>\n              <Input\n                id=\"client-name\"\n                value={selectedBarterClientId ? getClientName(selectedBarterClientId) : ''}\n                disabled\n                className=\"bg-muted\"\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"commission-amount\">Valor da Comissão (USD)</Label>\n              <Input\n                id=\"commission-amount\"\n                type=\"number\"\n                step=\"0.01\"\n                min=\"0\"\n                placeholder=\"0.00\"\n                value={manualCommissionValue}\n                onChange={(e) => setManualCommissionValue(e.target.value)}\n                data-testid=\"input-manual-commission\"\n              />\n              <p className=\"text-xs text-muted-foreground mt-1\">\n                Este valor será aplicado a todas as vendas barter deste cliente\n              </p>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setShowManualCommissionModal(false);\n                setManualCommissionValue(\"\");\n                setSelectedBarterClientId(null);\n              }}\n            >\n              Cancelar\n            </Button>\n            <Button\n              onClick={handleManualCommissionSubmit}\n              disabled={manualCommissionMutation.isPending}\n              data-testid=\"button-submit-manual-commission\"\n            >\n              {manualCommissionMutation.isPending ? \"Salvando...\" : \"Salvar Comissão\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Fullscreen Dialog */}\n      {isFullscreen && (\n        <div className=\"fixed inset-0 z-50 bg-background\">\n          <div className=\"h-screen flex flex-col\">\n            {/* Header with close button */}\n            <div className=\"bg-card border-b border-border px-8 py-4 flex items-center justify-between\">\n              <div>\n                <h2 className=\"text-xl font-bold text-foreground\">Gestão de Vendas</h2>\n                <p className=\"text-sm text-muted-foreground\">Controle e acompanhamento de todas as vendas</p>\n              </div>\n              <div className=\"flex items-center gap-3\">\n                <Button\n                  variant=\"outline\"\n                  size=\"icon\"\n                  onClick={() => setIsFullscreen(false)}\n                  data-testid=\"button-close-fullscreen\"\n                >\n                  <X className=\"h-5 w-5\" />\n                </Button>\n              </div>\n            </div>\n\n            {/* Content - scrollable */}\n            <div className=\"flex-1 overflow-y-auto p-8\">\n              {/* Same Tabs content as main view */}\n              <Tabs defaultValue=\"vendas\" className=\"space-y-6\">\n                {/* Cards de navegação e resumo na mesma linha */}\n                <div className=\"flex gap-6\">\n                  {/* Cards de navegação quadrados lado a lado */}\n                  <TabsList className=\"grid grid-cols-2 h-auto bg-transparent p-0 gap-3\">\n                    <TabsTrigger \n                      value=\"vendas\" \n                      data-testid=\"tab-vendas-fullscreen\"\n                      className=\"h-auto p-0 bg-transparent border-0 data-[state=active]:bg-transparent\"\n                      asChild\n                    >\n                      <Card className=\"shadow-sm cursor-pointer transition-all aspect-square data-[state=active]:ring-2 data-[state=active]:ring-amber-500 data-[state=active]:bg-amber-50 hover:shadow-md w-32\">\n                        <CardContent className=\"p-4 h-full flex flex-col items-center justify-center text-center\">\n                          <div className=\"w-10 h-10 bg-amber-500/10 rounded-lg flex items-center justify-center mb-2\">\n                            <DollarSign className=\"text-amber-500\" size={20} />\n                          </div>\n                          <p className=\"text-sm font-semibold\">Vendas</p>\n                        </CardContent>\n                      </Card>\n                    </TabsTrigger>\n                    \n                    <TabsTrigger \n                      value=\"timac\" \n                      data-testid=\"tab-timac-fullscreen\"\n                      className=\"h-auto p-0 bg-transparent border-0 data-[state=active]:bg-transparent\"\n                      asChild\n                    >\n                      <Card className=\"shadow-sm cursor-pointer transition-all aspect-square data-[state=active]:ring-2 data-[state=active]:ring-blue-500 data-[state=active]:bg-blue-50 hover:shadow-md w-32\">\n                        <CardContent className=\"p-4 h-full flex flex-col items-center justify-center text-center\">\n                          <div className=\"w-10 h-10 bg-blue-500/10 rounded-lg flex items-center justify-center mb-2\">\n                            <Award className=\"text-blue-500\" size={20} />\n                          </div>\n                          <p className=\"text-sm font-semibold\">Pontos Timac</p>\n                        </CardContent>\n                      </Card>\n                    </TabsTrigger>\n                  </TabsList>\n\n                  {/* Cards de resumo compactos */}\n                  <div className=\"flex gap-4 flex-1\">\n                    <Card className=\"shadow-sm flex-1\">\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"w-10 h-10 bg-primary/10 rounded-lg flex items-center justify-center flex-shrink-0\">\n                            <DollarSign className=\"text-primary\" size={20} />\n                          </div>\n                          <div>\n                            <p className=\"text-xs text-muted-foreground\">Total de Vendas</p>\n                            <p className=\"text-xl font-bold font-mono\">${totalSales.toLocaleString()}</p>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n\n                    <Card className=\"shadow-sm flex-1\">\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"w-10 h-10 bg-verde/10 rounded-lg flex items-center justify-center flex-shrink-0\">\n                            <DollarSign className=\"text-verde\" size={20} />\n                          </div>\n                          <div>\n                            <p className=\"text-xs text-muted-foreground\">Total de Comissões</p>\n                            <p className=\"text-xl font-bold font-mono text-verde\">${totalCommissions.toLocaleString()}</p>\n                            <p className=\"text-[10px] text-muted-foreground\">\n                              {totalSales > 0 ? ((totalCommissions / totalSales) * 100).toFixed(2) : 0}% sobre vendas\n                            </p>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n\n                    <Card className=\"shadow-sm flex-1\">\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"w-10 h-10 bg-chart-2/10 rounded-lg flex items-center justify-center flex-shrink-0\">\n                            <Calendar className=\"text-chart-2\" size={20} />\n                          </div>\n                          <div>\n                            <p className=\"text-xs text-muted-foreground\">Total de Vendas</p>\n                            <p className=\"text-xl font-bold\">{filteredSales.length}</p>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  </div>\n                </div>\n\n                <TabsContent value=\"vendas\" className=\"space-y-6\">\n              {/* Filters and Actions */}\n              <Card className=\"shadow-sm\">\n                <CardHeader>\n                  <CardTitle>Filtros e Ações</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"flex flex-wrap gap-4 items-end\">\n                <div className=\"flex-1 min-w-64\">\n                  <div className=\"relative\">\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                    <Input\n                      placeholder=\"Buscar por cliente ou produto...\"\n                      value={searchTerm}\n                      onChange={(e) => setSearchTerm(e.target.value)}\n                      className=\"pl-10\"\n                      data-testid=\"search-sales-fullscreen\"\n                    />\n                  </div>\n                </div>\n\n                <Select value={selectedSeason} onValueChange={setSelectedSeason}>\n                  <SelectTrigger className=\"w-48\" data-testid=\"filter-season-fullscreen\">\n                    <SelectValue placeholder=\"Filtrar por safra\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todas as safras</SelectItem>\n                    {seasons?.map((season: any) => (\n                      <SelectItem key={season.id} value={season.id}>\n                        {season.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n\n                <Select value={selectedCategory} onValueChange={setSelectedCategory}>\n                  <SelectTrigger className=\"w-48\" data-testid=\"filter-category-fullscreen\">\n                    <SelectValue placeholder=\"Filtrar por categoria\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todas as categorias</SelectItem>\n                    {categories?.map((category) => (\n                      <SelectItem key={category.id} value={category.id}>\n                        {category.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n\n                <Select value={selectedMarca} onValueChange={setSelectedMarca}>\n                  <SelectTrigger className=\"w-48\" data-testid=\"filter-marca-fullscreen\">\n                    <SelectValue placeholder=\"Filtrar por fabricante\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todos os fabricantes</SelectItem>\n                    {uniqueMarcas?.map((marca) => (\n                      <SelectItem key={marca.value} value={marca.value}>\n                        {marca.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n\n                <Select value={selectedProduct} onValueChange={setSelectedProduct}>\n                  <SelectTrigger className=\"w-48\" data-testid=\"filter-product-fullscreen\">\n                    <SelectValue placeholder=\"Filtrar por produto\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todos os produtos</SelectItem>\n                    {availableProducts.map((product) => (\n                      <SelectItem key={product.id} value={product.id}>\n                        {product.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n\n                <Select value={selectedMonth} onValueChange={setSelectedMonth}>\n                  <SelectTrigger className=\"w-48\" data-testid=\"filter-month-fullscreen\">\n                    <SelectValue placeholder=\"Filtrar por mês\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todos os meses</SelectItem>\n                    {MONTHS.map((month) => (\n                      <SelectItem key={month.value} value={month.value}>\n                        {month.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n\n                <div className=\"flex gap-2\">\n                  <Button variant=\"outline\" data-testid=\"button-export-fullscreen\">\n                    <Download className=\"h-4 w-4 mr-2\" />\n                    Exportar\n                  </Button>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Sales Table */}\n          <Card className=\"shadow-sm\">\n            <CardHeader>\n              <CardTitle>Lista de Vendas</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {filteredSales.length === 0 ? (\n                <div className=\"text-center py-12\">\n                  <p className=\"text-muted-foreground\">Nenhuma venda encontrada</p>\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Data</TableHead>\n                        <TableHead>Cliente</TableHead>\n                        <TableHead>Produto</TableHead>\n                        <TableHead className=\"text-right\">Cant. Produtos</TableHead>\n                        <TableHead>Categoria</TableHead>\n                        <TableHead className=\"text-right\">Valor (USD)</TableHead>\n                        <TableHead className=\"text-right\">Comissão</TableHead>\n                        <TableHead className=\"text-center\">Faixa</TableHead>\n                        <TableHead>Vencimento</TableHead>\n                        <TableHead className=\"text-center\">Ações</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {/* Render barter client groups first */}\n                      {barterClientGroups.map((group) => {\n                        const isExpanded = expandedBarterClients.has(group.clientId);\n                        return (\n                          <>\n                            {/* Barter client summary row */}\n                            <TableRow \n                              key={`barter-${group.clientId}`} \n                              className=\"bg-blue-50 dark:bg-blue-950/30 hover:bg-blue-100 dark:hover:bg-blue-900/40 cursor-pointer\"\n                              onClick={() => toggleBarterClient(group.clientId)}\n                              data-testid={`barter-client-${group.clientId}-fullscreen`}\n                            >\n                              <TableCell>\n                                {isExpanded ? (\n                                  <ChevronDown className=\"h-4 w-4 inline mr-2\" />\n                                ) : (\n                                  <ChevronRight className=\"h-4 w-4 inline mr-2\" />\n                                )}\n                                {group.salesCount} venda(s)\n                              </TableCell>\n                              <TableCell className=\"font-bold flex items-center gap-2\">\n                                {group.clientName}\n                                <Badge className={getTierBadgeClass('barter')}>\n                                  <Repeat className=\"h-3 w-3 mr-1\" />\n                                  BARTER\n                                </Badge>\n                              </TableCell>\n                              <TableCell colSpan={3} className=\"text-muted-foreground italic\">\n                                {group.salesCount} produto(s)\n                              </TableCell>\n                              <TableCell className=\"text-right font-mono font-bold\">\n                                ${group.totalAmount.toLocaleString()}\n                              </TableCell>\n                              <TableCell className=\"text-right font-mono text-verde font-bold\">\n                                ${group.totalCommission.toLocaleString()}\n                              </TableCell>\n                              <TableCell></TableCell>\n                              <TableCell></TableCell>\n                              <TableCell className=\"text-center\">\n                                <Button\n                                  variant=\"outline\"\n                                  size=\"sm\"\n                                  onClick={(e) => {\n                                    e.stopPropagation();\n                                    openManualCommissionModal(group.clientId);\n                                  }}\n                                  data-testid={`button-manual-commission-${group.clientId}-fullscreen`}\n                                >\n                                  <DollarSign className=\"h-4 w-4 mr-1\" />\n                                  Comissão\n                                </Button>\n                              </TableCell>\n                            </TableRow>\n\n                            {/* Expanded product rows */}\n                            {isExpanded && group.sales.map((sale) => (\n                              <TableRow \n                                key={sale.id} \n                                className=\"bg-blue-50/50 dark:bg-blue-950/10\"\n                                data-testid={`barter-sale-${sale.id}-fullscreen`}\n                              >\n                                <TableCell className=\"pl-8\">\n                                  {format(new Date(sale.saleDate), \"dd/MM/yyyy\")}\n                                </TableCell>\n                                <TableCell className=\"text-muted-foreground italic pl-8\">\n                                  → Produto\n                                </TableCell>\n                                <TableCell>\n                                  {getProductName(sale.productId)}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono\">\n                                  {sale.quantity ? parseFloat(sale.quantity).toLocaleString('pt-BR', { maximumFractionDigits: 2 }) : '-'}\n                                </TableCell>\n                                <TableCell>\n                                  {getCategoryName(sale.categoryId)}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono\">\n                                  ${parseFloat(sale.totalAmount).toLocaleString()}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono text-verde\">\n                                  ${parseFloat(sale.commissionAmount).toLocaleString()}\n                                </TableCell>\n                                <TableCell></TableCell>\n                                <TableCell>\n                                  {format(new Date(sale.dueDate), \"dd/MM/yyyy\")}\n                                </TableCell>\n                                <TableCell></TableCell>\n                              </TableRow>\n                            ))}\n                          </>\n                        );\n                      })}\n\n                      {/* Render normal sales */}\n                      {normalSales.map((sale) => (\n                        <TableRow key={sale.id} data-testid={`sale-row-${sale.id}-fullscreen`}>\n                          <TableCell>\n                            {format(new Date(sale.saleDate), \"dd/MM/yyyy\")}\n                          </TableCell>\n                          <TableCell className=\"font-medium\">\n                            {getClientName(sale.clientId)}\n                          </TableCell>\n                          <TableCell>\n                            {getProductName(sale.productId)}\n                            {sale.isManual && (\n                              <Badge variant=\"outline\" className=\"ml-2 text-xs\">\n                                Manual\n                              </Badge>\n                            )}\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\" data-testid={`quantity-${sale.id}-fullscreen`}>\n                            {sale.quantity ? parseFloat(sale.quantity).toLocaleString('pt-BR', { maximumFractionDigits: 2 }) : '-'}\n                          </TableCell>\n                          <TableCell>\n                            {getCategoryName(sale.categoryId)}\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            ${parseFloat(sale.totalAmount).toLocaleString()}\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono text-verde\">\n                            ${parseFloat(sale.commissionAmount).toLocaleString()}\n                          </TableCell>\n                          <TableCell className=\"text-center\">\n                            <Badge className={`${getTierBadgeClass(sale.commissionTier)} capitalize`}>\n                              {sale.commissionTier}\n                            </Badge>\n                          </TableCell>\n                          <TableCell>\n                            {format(new Date(sale.dueDate), \"dd/MM/yyyy\")}\n                          </TableCell>\n                          <TableCell className=\"text-center\">\n                            <Button\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => setEditingSale(sale)}\n                              data-testid={`button-edit-sale-${sale.id}-fullscreen`}\n                            >\n                              <Edit className=\"h-4 w-4\" />\n                            </Button>\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n            </TabsContent>\n\n            <TabsContent value=\"timac\" className=\"space-y-6\">\n              {/* Resumo Pontos Timac */}\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n                <Card className=\"shadow-sm\">\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                        <Award className=\"text-chart-2\" size={24} />\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Total de Pontos</p>\n                        <p className=\"text-2xl font-bold font-mono\">{totalTimacPoints.toLocaleString('pt-BR', { maximumFractionDigits: 2 })}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"shadow-sm\">\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"w-12 h-12 bg-verde/10 rounded-lg flex items-center justify-center\">\n                        <DollarSign className=\"text-verde\" size={24} />\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Valor por Ponto</p>\n                        <p className=\"text-2xl font-bold font-mono text-verde\">${timacRewardPerPoint.toFixed(2)} USD</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"shadow-sm\">\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center\">\n                        <DollarSign className=\"text-primary\" size={24} />\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Premiação Total</p>\n                        <p className=\"text-2xl font-bold font-mono\">${totalTimacReward.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} USD</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Tabela Detalhada Pontos Timac */}\n              <Card className=\"shadow-sm\">\n                <CardHeader>\n                  <CardTitle>Análise Detalhada de Pontos Timac</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {timacSales.length === 0 ? (\n                    <div className=\"text-center py-12\">\n                      <Award className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\n                      <p className=\"text-muted-foreground\">Nenhuma venda com pontos Timac encontrada</p>\n                      <p className=\"text-sm text-muted-foreground mt-2\">\n                        Produtos Timac da categoria Especialidades geram pontos de premiação\n                      </p>\n                    </div>\n                  ) : (\n                    <div className=\"overflow-x-auto\">\n                      <Table>\n                        <TableHeader>\n                          <TableRow>\n                            <TableHead>Cliente</TableHead>\n                            <TableHead>Produto</TableHead>\n                            <TableHead>Marca</TableHead>\n                            <TableHead>Data</TableHead>\n                            <TableHead>Safra</TableHead>\n                            <TableHead className=\"text-right\">Cant. Pedido</TableHead>\n                            <TableHead className=\"text-right\">Package Size</TableHead>\n                            <TableHead className=\"text-right\">Quantidade Total</TableHead>\n                            <TableHead className=\"text-right\">Pts/Unidade</TableHead>\n                            <TableHead className=\"text-right\">Total Pontos</TableHead>\n                          </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                          {timacSales.map((sale) => {\n                            const product = products?.find(p => p.id === sale.productId);\n                            const productName = product?.name || \"Produto manual\";\n                            const marca = product?.marca || \"-\";\n                            const packageSize = product?.packageSize ? parseFloat(product.packageSize) : 1;\n                            \n                            // Calcular Cant. Pedido baseado em quantity e packageSize\n                            const quantity = sale.quantity ? parseFloat(sale.quantity) : 0;\n                            const cantPedido = packageSize > 0 ? quantity / packageSize : 0;\n                            \n                            // Quantidade total = Cant. Pedido × Package Size\n                            const quantidadeTotal = cantPedido * packageSize;\n                            \n                            // Use timacPoints from product database\n                            const ptsPerUnit = product?.timacPoints ? parseFloat(product.timacPoints) : 0;\n                            \n                            // Total de pontos = Pts/Unidade × Quantidade Total\n                            const totalPontos = ptsPerUnit * quantidadeTotal;\n                            \n                            const season = seasons?.find(s => s.id === sale.seasonId);\n                            \n                            return (\n                              <TableRow key={sale.id} data-testid={`timac-sale-${sale.id}-fullscreen`}>\n                                <TableCell className=\"font-medium\">\n                                  {getClientName(sale.clientId)}\n                                </TableCell>\n                                <TableCell>\n                                  {productName}\n                                </TableCell>\n                                <TableCell>\n                                  {marca}\n                                </TableCell>\n                                <TableCell>\n                                  {format(new Date(sale.saleDate), \"dd/MM/yyyy\")}\n                                </TableCell>\n                                <TableCell>\n                                  {season?.name || '-'}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono\">\n                                  {cantPedido.toLocaleString('pt-BR', { maximumFractionDigits: 2 })}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono\">\n                                  {packageSize.toLocaleString('pt-BR', { maximumFractionDigits: 2 })}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono\">\n                                  {quantidadeTotal.toLocaleString('pt-BR', { maximumFractionDigits: 2 })}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono\">\n                                  {ptsPerUnit}\n                                </TableCell>\n                                <TableCell className=\"text-right font-mono font-bold text-verde\">\n                                  {totalPontos.toLocaleString('pt-BR', { maximumFractionDigits: 2 })}\n                                </TableCell>\n                              </TableRow>\n                            );\n                          })}\n                        </TableBody>\n                      </Table>\n                    </div>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n              </Tabs>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":71825},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","size_bytes":4281},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","size_bytes":756},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","size_bytes":2765},"server/product-classifier.ts":{"content":"export interface ProductClassification {\n  subcategoryId: string;\n  confidence: 'high' | 'medium' | 'low';\n}\n\nconst CLASSIFICATION_MAP = {\n  'sub-tratamento-sementes': {\n    exactMatches: [\n      'RIZOSPIRILUM',\n      'VITAGROW TS',\n      'RIZOLIQ TOP',\n      'DERMACOR',\n      'CLORANTE 62',\n      'HURACAN',\n      'MAXIN RFC',\n      'CROPSTAR',\n      'RANCONA',\n      'EVERGOL',\n      'RIZODERMA MAX',\n    ],\n    keywords: [\n      'AZOSPIRILLUM',\n      'BIOESTIMULANTE',\n      'BRADIRIZOBIUM',\n      'RIZODERMA',\n      'RIZOLIQ',\n      'RIZOSPIRILUM',\n      'VITAGROW',\n      'TRICODERMA',\n      'TS ',\n      ' TS',\n    ],\n    activeIngredients: [\n      'CLORANTRANILIPROLI 62',\n      'FIPRONIL 25',\n      'FLUDIOXINIL',\n      'METALAXIL',\n      'IPCONAZOLE',\n      'PENFLUFEN',\n    ]\n  },\n  'sub-dessecacao': {\n    exactMatches: [\n      '2,4 D',\n      'CLETODIN',\n      'CLOMAZERB',\n      'CONFIRM',\n      'APRESA',\n      'FLUMITOP',\n      'FOMEFLAG',\n      'GLIFOSATO',\n      'TECNUP',\n      'GLUFOSINATO',\n      'GLUFOSEC',\n      'PIXXARO',\n      'TEXARO',\n      'VERDICT ULTRA',\n      'ZETAPIR',\n      'PARAQUAT',\n      'SAFLUNEX',\n      'STRIM',\n      'SUNZONE',\n      'TRICLON',\n    ],\n    keywords: [\n      'GLIFOSATO',\n      'GLUFOSINATO',\n      'PARAQUAT',\n      'CLOMAZONE',\n      'FLUMIOXAZIN',\n      'DICLOSULAN',\n      'HALOXIFOP',\n      'HALAUXIFENO',\n      'IMAZETAPIR',\n      'SAFLUFENACIL',\n      'SULFENTRAZONE',\n      'TRICLOPIR',\n      'FOMESAFEN',\n      'CLETODIM',\n      'S-METALACLORO',\n      '2,4D',\n      '2,4 D',\n    ],\n    activeIngredients: []\n  },\n  'sub-inseticidas': {\n    exactMatches: [\n      'LASCAR',\n      'PERITO ULTRA',\n      'ABAMEC',\n      'BATTUS GOLD',\n      'ACEGOAL',\n      'AGUILA',\n      'MONITOR',\n      'BULLDOCK',\n      'TOXATRIM',\n      'FENTHRIN',\n      'GALIL',\n      'AMPLIGO',\n      'CLORANTE WG',\n      'OVERTOP',\n      'CLORPIRIFOS',\n      'OBERON',\n      'CRICKET',\n      'FULMINANTE',\n      'BELT',\n      'CAYENNE',\n      'LOYER',\n      'CORAZA',\n      'POINT 5',\n      'METOMYL',\n      'INTREPID',\n      'PIRY PANDA',\n      'EXALT',\n      'QUINTAL XTRA',\n      'EXPEDITION',\n      'SOYGUARD',\n      'THIODICARB',\n      'ONLY',\n      'THIAMEXPLANT',\n      'ALSYSTIN',\n    ],\n    keywords: [\n      'ACEFATO',\n      'ABAMECTINA',\n      'ACETAMIPRID',\n      'BETACIFLUTRINA',\n      'BIFENTRIN',\n      'CLORANTRANILIPROLI 80',\n      'CLORFENAPIR',\n      'CLORPIRIFOS',\n      'ESPIROMESIFENO',\n      'ETIPROLE',\n      'FIPRONIL 80',\n      'FLUBENDIAMIDA',\n      'IMIDACLOPRID',\n      'LAMBDA',\n      'LAMBDACIALOTRINA',\n      'LUFENURON',\n      'METOMIL',\n      'METOXIFENOCIDE',\n      'PIRIPROXIFEN',\n      'SPINETORAN',\n      'SULFOXAFLOR',\n      'TEFLUBENZURON',\n      'THIODICARB',\n      'TIAMETOXAN',\n      'TRIFLUMURON',\n      'DINOTEFURAN',\n    ],\n    activeIngredients: []\n  },\n  'sub-fungicidas': {\n    exactMatches: [\n      'VESSARYA',\n      'CLOROTALONIL',\n      'ARMERO',\n      'MURALLA',\n      'VIOVAN',\n      'APROACH',\n      'AZIMUT',\n      'DANKE',\n      'ZAFIRO',\n      'WETTER',\n      'CRIPTON',\n      'NATIVO',\n    ],\n    keywords: [\n      'BENZOVINDIFLUPIR',\n      'CLOROTALONIL',\n      'MANCOZEB',\n      'PICOXISTROBIN',\n      'PROTHIOCONAZOLE',\n      'PROTIO',\n      'CIPROCONAZOLE',\n      'TEBUCONAZOLE',\n      'TEBUCO',\n      'AZOXISTROBINA',\n      'AZOXIS',\n      'DIFENOCONAZOLE',\n      'DIFENO',\n      'TRIFLOXISTROBIN',\n      'BIXAFEN',\n    ],\n    activeIngredients: []\n  }\n};\n\nfunction normalizeProductName(name: string): string {\n  return name\n    .toUpperCase()\n    .trim()\n    .replace(/[^\\w\\s]/g, ' ')\n    .replace(/\\s+/g, ' ')\n    .trim();\n}\n\nexport function detectSubcategory(productName: string): ProductClassification | null {\n  if (!productName) return null;\n\n  const normalizedName = normalizeProductName(productName);\n\n  for (const [subcategoryId, config] of Object.entries(CLASSIFICATION_MAP)) {\n    for (const exactMatch of config.exactMatches) {\n      const normalizedMatch = normalizeProductName(exactMatch);\n      if (normalizedName.includes(normalizedMatch)) {\n        return { subcategoryId, confidence: 'high' };\n      }\n    }\n\n    for (const keyword of config.keywords) {\n      const normalizedKeyword = normalizeProductName(keyword);\n      if (normalizedName.includes(normalizedKeyword)) {\n        return { subcategoryId, confidence: 'medium' };\n      }\n    }\n\n    for (const ingredient of config.activeIngredients) {\n      const normalizedIngredient = normalizeProductName(ingredient);\n      if (normalizedName.includes(normalizedIngredient)) {\n        return { subcategoryId, confidence: 'low' };\n      }\n    }\n  }\n\n  return null;\n}\n\nexport function classifyProductsBatch(products: Array<{ id: string; name: string; categoryId: string }>): Array<{ id: string; subcategoryId: string; confidence: string }> {\n  const results: Array<{ id: string; subcategoryId: string; confidence: string }> = [];\n\n  for (const product of products) {\n    if (product.categoryId !== 'cat-agroquimicos') {\n      continue;\n    }\n\n    const classification = detectSubcategory(product.name);\n    if (classification) {\n      results.push({\n        id: product.id,\n        subcategoryId: classification.subcategoryId,\n        confidence: classification.confidence\n      });\n    }\n  }\n\n  return results;\n}\n","size_bytes":5286},"client/src/components/modals/new-sale-modal.tsx":{"content":"import { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { useState, useEffect } from \"react\";\nimport { calculateCommission } from \"@/lib/commissions\";\nimport { classifySeason } from \"@/lib/seasons\";\nimport type { Category, Client } from \"@shared/schema\";\n\ninterface NewSaleModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n}\n\nexport default function NewSaleModal({ isOpen, onClose }: NewSaleModalProps) {\n  const { toast } = useToast();\n  const [formData, setFormData] = useState({\n    clientId: \"\",\n    categoryId: \"\",\n    productName: \"\",\n    totalAmount: \"\",\n    margin: \"\",\n    dueDate: \"\",\n    ivaRate: \"10.00\",\n  });\n  \n  const [commission, setCommission] = useState({\n    tier: \"\",\n    rate: 0,\n    amount: 0,\n    season: \"\",\n  });\n\n  const { data: categories } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const { data: clients } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const createSaleMutation = useMutation({\n    mutationFn: async (saleData: any) => {\n      return apiRequest(\"POST\", \"/api/sales\", saleData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/sales\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/analytics/sales\"] });\n      toast({\n        title: \"Venda cadastrada\",\n        description: \"A venda foi cadastrada com sucesso.\",\n      });\n      onClose();\n      resetForm();\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao cadastrar a venda. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      clientId: \"\",\n      categoryId: \"\",\n      productName: \"\",\n      totalAmount: \"\",\n      margin: \"\",\n      dueDate: \"\",\n      ivaRate: \"10.00\",\n    });\n    setCommission({\n      tier: \"\",\n      rate: 0,\n      amount: 0,\n      season: \"\",\n    });\n  };\n\n  useEffect(() => {\n    if (formData.categoryId && formData.margin && formData.totalAmount && formData.dueDate) {\n      const category = categories?.find(c => c.id === formData.categoryId);\n      if (category) {\n        const commissionCalc = calculateCommission(category, parseFloat(formData.margin));\n        const seasonName = classifySeason(new Date(formData.dueDate));\n        const amount = parseFloat(formData.totalAmount) * (commissionCalc.rate / 100);\n        \n        setCommission({\n          tier: commissionCalc.tier,\n          rate: commissionCalc.rate,\n          amount,\n          season: seasonName,\n        });\n      }\n    }\n  }, [formData.categoryId, formData.margin, formData.totalAmount, formData.dueDate, categories]);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!formData.clientId || !formData.categoryId || !formData.productName || \n        !formData.totalAmount || !formData.margin || !formData.dueDate) {\n      toast({\n        title: \"Campos obrigatórios\",\n        description: \"Preencha todos os campos obrigatórios.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const saleData = {\n      clientId: formData.clientId,\n      productId: \"manual-product\", // For manual entries, we use a placeholder\n      categoryId: formData.categoryId,\n      seasonId: \"season-placeholder\", // This would be determined by the season classification\n      userId: \"user-placeholder\", // This would come from authentication\n      saleDate: new Date(),\n      dueDate: new Date(formData.dueDate),\n      totalAmount: formData.totalAmount,\n      margin: formData.margin,\n      ivaRate: formData.ivaRate,\n      commissionRate: commission.rate.toString(),\n      commissionAmount: commission.amount.toString(),\n      commissionTier: commission.tier,\n      isManual: true,\n    };\n\n    createSaleMutation.mutate(saleData);\n  };\n\n  const getTierBadgeClass = (tier: string) => {\n    switch (tier) {\n      case 'verde': return 'badge-verde';\n      case 'amarela': return 'badge-amarela';\n      case 'vermelha': return 'badge-vermelha';\n      default: return 'badge-verde';\n    }\n  };\n\n  const getTierColor = (tier: string) => {\n    switch (tier) {\n      case 'verde': return 'text-verde';\n      case 'amarela': return 'text-amarela';\n      case 'vermelha': return 'text-vermelha';\n      default: return 'text-verde';\n    }\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\" data-testid=\"new-sale-modal\">\n        <DialogHeader>\n          <DialogTitle className=\"text-xl font-bold\">Nova Venda Manual</DialogTitle>\n          <p className=\"text-sm text-muted-foreground\">\n            Registre uma venda casual com cálculo automático de comissão\n          </p>\n        </DialogHeader>\n\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\n          {/* Client & Date Section */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div>\n              <Label htmlFor=\"client\">Cliente</Label>\n              <Select value={formData.clientId} onValueChange={(value) => \n                setFormData(prev => ({ ...prev, clientId: value }))\n              }>\n                <SelectTrigger data-testid=\"select-client\">\n                  <SelectValue placeholder=\"Selecione o cliente...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {clients?.map((client) => (\n                    <SelectItem key={client.id} value={client.id}>\n                      {client.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label htmlFor=\"saleDate\">Data da Venda</Label>\n              <Input \n                type=\"date\" \n                defaultValue={new Date().toISOString().split('T')[0]}\n                data-testid=\"input-sale-date\"\n              />\n            </div>\n          </div>\n\n          {/* Product Section */}\n          <Card className=\"bg-muted/30\">\n            <CardHeader>\n              <CardTitle className=\"text-sm\">Informações do Produto</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"category\">Categoria</Label>\n                  <Select value={formData.categoryId} onValueChange={(value) => \n                    setFormData(prev => ({ ...prev, categoryId: value }))\n                  }>\n                    <SelectTrigger data-testid=\"select-category\">\n                      <SelectValue placeholder=\"Selecione a categoria...\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {categories?.map((category) => (\n                        <SelectItem key={category.id} value={category.id}>\n                          {category.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div>\n                  <Label htmlFor=\"product\">Produto</Label>\n                  <Input \n                    placeholder=\"Nome do produto\" \n                    value={formData.productName}\n                    onChange={(e) => setFormData(prev => ({ ...prev, productName: e.target.value }))}\n                    data-testid=\"input-product-name\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"totalAmount\">Valor Total (USD)</Label>\n                  <Input \n                    type=\"number\" \n                    step=\"0.01\"\n                    placeholder=\"0.00\" \n                    value={formData.totalAmount}\n                    onChange={(e) => setFormData(prev => ({ ...prev, totalAmount: e.target.value }))}\n                    className=\"font-mono\"\n                    data-testid=\"input-total-amount\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"margin\">Margem (%)</Label>\n                  <Input \n                    type=\"number\" \n                    step=\"0.01\"\n                    placeholder=\"0.00\" \n                    value={formData.margin}\n                    onChange={(e) => setFormData(prev => ({ ...prev, margin: e.target.value }))}\n                    className=\"font-mono\"\n                    data-testid=\"input-margin\"\n                  />\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* IVA & Season Section */}\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div>\n              <Label htmlFor=\"iva\">IVA Paraguai (%)</Label>\n              <Input \n                type=\"number\" \n                step=\"0.01\"\n                value={formData.ivaRate}\n                onChange={(e) => setFormData(prev => ({ ...prev, ivaRate: e.target.value }))}\n                className=\"font-mono\"\n                data-testid=\"input-iva\"\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"dueDate\">Data de Vencimento</Label>\n              <Input \n                type=\"date\" \n                value={formData.dueDate}\n                onChange={(e) => setFormData(prev => ({ ...prev, dueDate: e.target.value }))}\n                data-testid=\"input-due-date\"\n              />\n            </div>\n            <div>\n              <Label htmlFor=\"season\">Safra (Auto)</Label>\n              <Input \n                value={commission.season}\n                readOnly \n                className=\"bg-muted text-muted-foreground cursor-not-allowed font-mono\"\n                data-testid=\"input-season\"\n              />\n            </div>\n          </div>\n\n          {/* Commission Preview */}\n          {commission.tier && (\n            <Card className=\"bg-primary/5\">\n              <CardHeader>\n                <CardTitle className=\"text-sm\">Prévia de Comissão</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Faixa de Comissão</p>\n                    <Badge className={`${getTierBadgeClass(commission.tier)} text-sm font-medium capitalize`}>\n                      {commission.tier}\n                    </Badge>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Taxa de Comissão</p>\n                    <p className=\"text-lg font-bold text-foreground font-mono\">\n                      {commission.rate.toFixed(2)}%\n                    </p>\n                  </div>\n                  <div>\n                    <p className=\"text-xs text-muted-foreground mb-1\">Valor da Comissão (USD)</p>\n                    <p className={`text-lg font-bold font-mono ${getTierColor(commission.tier)}`}>\n                      ${commission.amount.toFixed(2)}\n                    </p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          )}\n\n          {/* Actions */}\n          <div className=\"flex items-center justify-end gap-3 pt-4\">\n            <Button type=\"button\" variant=\"outline\" onClick={onClose} data-testid=\"button-cancel\">\n              Cancelar\n            </Button>\n            <Button \n              type=\"submit\" \n              disabled={createSaleMutation.isPending}\n              data-testid=\"button-save\"\n            >\n              {createSaleMutation.isPending ? \"Salvando...\" : \"Salvar Venda\"}\n            </Button>\n          </div>\n        </form>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":12251},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","size_bytes":1642},"client/src/components/layout/header.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Search, Bell, Plus, Sprout, LogOut } from \"lucide-react\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { useLocation } from \"wouter\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\ninterface HeaderProps {\n  onNewSale?: () => void;\n  title?: string;\n  subtitle?: string;\n  showNewSaleButton?: boolean;\n}\n\nexport default function Header({ onNewSale, title, subtitle, showNewSaleButton = true }: HeaderProps) {\n  const { user, logoutMutation } = useAuth();\n  const [, setLocation] = useLocation();\n\n  const handleLogout = () => {\n    logoutMutation.mutate(undefined, {\n      onSuccess: () => {\n        setLocation(\"/auth\");\n      }\n    });\n  };\n\n  const getInitials = (name: string) => {\n    return name\n      .split(' ')\n      .map(word => word[0])\n      .join('')\n      .toUpperCase()\n      .slice(0, 2);\n  };\n\n  const getRoleLabel = (role: string) => {\n    const roleMap: Record<string, string> = {\n      consultor: 'Consultor',\n      gerente: 'Gerente',\n      administrador: 'Administrador',\n      faturista: 'Faturista',\n    };\n    return roleMap[role] || role;\n  };\n\n  return (\n    <header className=\"bg-primary border-b border-primary-foreground/10 sticky top-0 z-20\">\n      <div className=\"px-8 py-4 flex items-center justify-between\">\n        <div className=\"flex items-center gap-4\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"w-10 h-10 bg-[#F7D601] rounded-lg flex items-center justify-center\">\n              <Sprout className=\"text-primary text-xl\" />\n            </div>\n            <div>\n              <h1 className=\"text-lg font-bold text-primary-foreground\">Agro Farm Digital</h1>\n              <p className=\"text-xs text-primary-foreground/80\">Gestão de Comissões</p>\n            </div>\n          </div>\n        </div>\n        \n        <div className=\"flex items-center gap-4\">\n          <div className=\"flex items-center gap-3\">\n            <div className=\"w-9 h-9 bg-[#F7D601] rounded-full flex items-center justify-center\">\n              <span className=\"text-primary font-semibold text-sm\">\n                {user ? getInitials(user.name) : 'U'}\n              </span>\n            </div>\n            <div>\n              <p className=\"text-sm font-medium text-primary-foreground\">{user?.name || 'Usuário'}</p>\n              <p className=\"text-xs text-primary-foreground/80\">{user ? getRoleLabel(user.role) : ''}</p>\n            </div>\n          </div>\n\n          <Button\n            onClick={handleLogout}\n            variant=\"ghost\"\n            size=\"sm\"\n            className=\"text-white hover:text-white hover:bg-white/20\"\n            data-testid=\"button-logout\"\n          >\n            <LogOut size={18} />\n          </Button>\n        </div>\n      </div>\n    </header>\n  );\n}\n","size_bytes":2847},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","size_bytes":772},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage } from \"./storage\";\nimport { insertSaleSchema, insertClientSchema, insertCategorySchema, insertProductSchema, insertSeasonGoalSchema, insertSeasonSchema, insertExternalPurchaseSchema, insertClientFamilyRelationSchema, insertAlertSettingsSchema, insertAlertSchema, insertPurchaseHistorySchema, insertPurchaseHistoryItemSchema, insertFarmSchema, insertFieldSchema, subcategories, clients, sales, seasons, seasonGoals, categories, products, clientMarketRates, externalPurchases, purchaseHistory, marketBenchmarks, userClientLinks, masterClients, salesHistory, clientFamilyRelations, purchaseHistoryItems, barterSimulations, barterSimulationItems, farms, fields, passwordResetTokens, users, productsPriceTable, globalManagementApplications, clientApplicationTracking, insertClientApplicationTrackingSchema, systemSettings } from \"@shared/schema\";\nimport { visits } from \"@shared/schema.crm\";\nimport { z } from \"zod\";\nimport multer from \"multer\";\nimport { importExcelFile, importClientsFromExcel } from \"./import-excel\";\nimport { setupAuth, requireAuth, requireSuperAdmin, requireManager } from \"./auth\";\nimport { db } from \"./db\";\nimport { eq, sql, and, gt, desc, inArray } from \"drizzle-orm\";\nimport { parseCVALEPDF } from \"./parse-cvale-pdf\";\nimport { emailService } from \"./email\";\nimport { scrypt, randomBytes } from \"crypto\";\nimport { promisify } from \"util\";\n\nconst scryptAsync = promisify(scrypt);\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Blueprint: javascript_auth_all_persistance - Setup auth routes\n  setupAuth(app);\n  \n  // Add no-cache headers to all API routes to prevent cross-user data leakage\n  app.use('/api/*', (req, res, next) => {\n    res.set({\n      'Cache-Control': 'no-store, no-cache, must-revalidate, private',\n      'Pragma': 'no-cache',\n      'Expires': '0'\n    });\n    next();\n  });\n  \n  // Configure multer for file uploads\n  const upload = multer({ storage: multer.memoryStorage() });\n  \n  // Categories\n  app.get(\"/api/categories\", requireAuth, async (req, res) => {\n    try {\n      const categories = await storage.getAllCategories();\n      res.json(categories);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch categories\" });\n    }\n  });\n\n  app.post(\"/api/categories\", requireSuperAdmin, async (req, res) => {\n    try {\n      const category = insertCategorySchema.parse(req.body);\n      const newCategory = await storage.createCategory(category);\n      res.status(201).json(newCategory);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid category data\" });\n    }\n  });\n\n  // Subcategories\n  app.get(\"/api/subcategories\", requireAuth, async (req, res) => {\n    try {\n      const { categoryId } = req.query;\n      \n      if (categoryId) {\n        const subs = await db.select()\n          .from(subcategories)\n          .where(eq(subcategories.categoryId, categoryId as string))\n          .orderBy(subcategories.displayOrder);\n        return res.json(subs);\n      }\n      \n      const allSubs = await db.select()\n        .from(subcategories)\n        .orderBy(subcategories.categoryId, subcategories.displayOrder);\n      res.json(allSubs);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch subcategories\" });\n    }\n  });\n\n  // Products\n  app.get(\"/api/products\", async (req, res) => {\n    try {\n      const { categoryId } = req.query;\n      const products = categoryId \n        ? await storage.getProductsByCategory(categoryId as string)\n        : await storage.getAllProducts();\n      res.json(products);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch products\" });\n    }\n  });\n\n  app.post(\"/api/products\", requireSuperAdmin, async (req, res) => {\n    try {\n      const product = insertProductSchema.parse(req.body);\n      const newProduct = await storage.createProduct(product);\n      res.status(201).json(newProduct);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid product data\" });\n    }\n  });\n\n  app.patch(\"/api/products/:id\", requireSuperAdmin, async (req, res) => {\n    try {\n      const existingProduct = await storage.getAllProducts().then(products => \n        products.find(p => p.id === req.params.id)\n      );\n      \n      if (!existingProduct) {\n        return res.status(404).json({ error: \"Product not found\" });\n      }\n\n      const categories = await storage.getAllCategories();\n      const currentCategory = categories.find(c => c.id === existingProduct.categoryId);\n      const targetCategoryId = req.body.categoryId || existingProduct.categoryId;\n      const targetCategory = categories.find(c => c.id === targetCategoryId);\n      \n      const updateData = { ...req.body };\n      \n      const isCurrentlyAgro = currentCategory?.type === 'agroquimicos';\n      const willBeAgro = targetCategory?.type === 'agroquimicos';\n      \n      if (isCurrentlyAgro && existingProduct.segment) {\n        if ('segment' in req.body && !req.body.segment) {\n          return res.status(400).json({ error: \"Cannot clear segment for existing agrochemical products\" });\n        }\n        if (!('segment' in req.body)) {\n          updateData.segment = existingProduct.segment;\n        }\n      }\n      \n      if (willBeAgro) {\n        const finalSegment = 'segment' in updateData ? updateData.segment : existingProduct.segment;\n        if (!finalSegment) {\n          return res.status(400).json({ error: \"Segment is required for agrochemical products\" });\n        }\n      }\n\n      const updated = await storage.updateProduct(req.params.id, updateData);\n      if (!updated) {\n        return res.status(404).json({ error: \"Product not found\" });\n      }\n      res.json(updated);\n    } catch (error) {\n      res.status(400).json({ error: \"Failed to update product\" });\n    }\n  });\n\n  app.post(\"/api/products/auto-populate-segments\", requireSuperAdmin, async (req, res) => {\n    try {\n      const detectAgrochemicalSegment = (productName: string): string => {\n        const name = productName.toLowerCase();\n        \n        if (name.includes('tratamento') || name.includes('seed treatment') || name.startsWith('ts ') ||\n            name.includes(' ts ') || name.endsWith(' ts') || /\\bts\\b/.test(name) ||\n            name.includes('fipronil') || name.includes('tiabendazol')) {\n          return 'ts';\n        }\n        \n        if (name.includes('fungicida') || name.includes('azoxistrobina') || name.includes('tebuconazol') || \n            name.includes('trifloxistrobina') || name.includes('piraclostrobina') || name.includes('protioconazol') ||\n            name.includes('mancozeb') || name.includes('fluxapiroxade') || name.includes('carbendazim')) {\n          return 'fungicida';\n        }\n        \n        if (name.includes('inseticida') || name.includes('imidacloprid') || name.includes('lambda') || \n            name.includes('cipermetrina') || name.includes('clorantraniliprole') || name.includes('tiametoxam') ||\n            name.includes('metoxifenozida') || name.includes('ciantraniliprole')) {\n          return 'inseticida';\n        }\n        \n        if (name.includes('herbicida') || name.includes('glifosato') || name.includes('paraquat') || \n            name.includes('atrazina') || name.includes('2,4-d') || name.includes('dicamba') ||\n            name.includes('imazetapir') || name.includes('haloxifop') || name.includes('glufosinato') ||\n            name.includes('fluroxipir') || name.includes('imazapir')) {\n          return 'herbicida';\n        }\n        \n        return 'outros';\n      };\n\n      const allProducts = await storage.getAllProducts();\n      const categories = await storage.getAllCategories();\n      const agrochemicalCategory = categories.find(c => c.type === 'agroquimicos');\n\n      if (!agrochemicalCategory) {\n        return res.status(404).json({ error: \"Agrochemical category not found\" });\n      }\n\n      let updatedCount = 0;\n      for (const product of allProducts) {\n        if (product.categoryId === agrochemicalCategory.id && !product.segment) {\n          const segment = detectAgrochemicalSegment(product.name);\n          await storage.updateProduct(product.id, { segment });\n          updatedCount++;\n        }\n      }\n\n      res.json({ message: `Auto-populated segments for ${updatedCount} products` });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to auto-populate segments\" });\n    }\n  });\n\n  app.post(\"/api/products/process-soja-spreadsheet\", requireSuperAdmin, async (req, res) => {\n    try {\n      const allProducts = await storage.getAllProducts();\n      const categories = await storage.getAllCategories();\n      const agrochemicalCategory = categories.find(c => c.type === 'agroquimicos');\n\n      if (!agrochemicalCategory) {\n        return res.status(404).json({ error: \"Agrochemical category not found\" });\n      }\n\n      const spreadsheetData = {\n        'subcat-ts': ['RIZOSPIRILUM', 'VITAGROW TS', 'RIZOLIQ TOP', 'DERMACOR', 'CLORANTE 62', 'HURACAN', 'MAXIN RFC', 'CROPSTAR', 'RANCONA', 'EVERGOL', 'RIZODERMA MAX'],\n        'subcat-dessecacao': ['2,4 D AMINA', '2,4 D Amina', 'CLETODIN 24%', 'CLOMAZERB 48', 'CONFIRM', 'APRESA', 'FLUMITOP', 'FOMEFLAG', 'GLIFOSATO 60,8%', 'GLIFOSATO 60.8%', 'TECNUP PREMIUM 2', 'TECNUP XTRA', 'GLUFOSINATO 40', 'GLUFOSEC P40', 'PIXXARO', 'TEXARO', 'VERDICT ULTRA', 'ZETAPIR', 'PARAQUAT 24%', 'SAFLUNEX', 'STRIM', 'SUNZONE XTRA', 'TRICLON'],\n        'subcat-inseticidas': ['LASCAR', 'PERITO ULTRA', 'ABAMEC 8,4', 'ABAMEC 8.4', 'BATTUS GOLD', 'ACEGOAL XTRA', 'AGUILA', 'MONITOR 30%', 'BULLDOCK', 'TOXATRIM', 'FENTHRIN 40', 'GALIL', 'AMPLIGO', 'CLORANTE WG', 'OVERTOP', 'CLORPIRIFOS NORTOX', 'OBERON', 'CRICKET WG', 'FULMINANTE 80WG', 'BELT', 'CAYENNE', 'LOYER', 'CORAZA', 'POINT 5', 'METOMYL 90%', 'INTREPID', 'PIRY PANDA', 'EXALT', 'QUINTAL XTRA', 'EXPEDITION', 'SOYGUARD', 'THIODICARB 80 WP', 'ONLY 60', 'THIAMEXPLANT', 'ONLY 75', 'ALSYSTIN'],\n        'subcat-fungicidas': ['VESSARYA', 'CLOROTALONIL 72%', 'ARMERO', 'MURALLA', 'VIOVAN', 'APROACH PRIMA', 'APROACH POWER', 'AZIMUT', 'DANKE', 'ZAFIRO 43', 'WETTER', 'CRIPTON XPRO SC', 'CRIPTON XPRO', 'NATIVO', 'CRIPTON SC']\n      };\n\n      const segmentMap: Record<string, string> = {\n        'subcat-ts': 'ts',\n        'subcat-dessecacao': 'herbicida',\n        'subcat-inseticidas': 'inseticida',\n        'subcat-fungicidas': 'fungicida'\n      };\n\n      const normalizeProductName = (name: string): string => {\n        return name\n          .toUpperCase()\n          .normalize('NFD')\n          .replace(/[\\u0300-\\u036f]/g, '')\n          .replace(/[^A-Z0-9]/g, '')\n          .trim();\n      };\n\n      const results = {\n        updated: [] as Array<{ id: string; name: string; subcategory: string; segment: string }>,\n        notFound: [] as Array<{ name: string; subcategory: string }>\n      };\n\n      for (const [subcategoryId, productNames] of Object.entries(spreadsheetData)) {\n        const segment = segmentMap[subcategoryId];\n        \n        for (const spreadsheetName of productNames) {\n          const normalizedSpreadsheetName = normalizeProductName(spreadsheetName);\n          \n          const matchedProduct = allProducts.find(p => {\n            if (p.categoryId !== agrochemicalCategory.id) return false;\n            const normalizedDbName = normalizeProductName(p.name);\n            return normalizedDbName.includes(normalizedSpreadsheetName) || \n                   normalizedSpreadsheetName.includes(normalizedDbName);\n          });\n\n          if (matchedProduct) {\n            await storage.updateProduct(matchedProduct.id, {\n              subcategoryId,\n              segment\n            });\n            results.updated.push({\n              id: matchedProduct.id,\n              name: matchedProduct.name,\n              subcategory: subcategoryId,\n              segment\n            });\n          } else {\n            results.notFound.push({\n              name: spreadsheetName,\n              subcategory: subcategoryId\n            });\n          }\n        }\n      }\n\n      res.json({\n        success: true,\n        totalProcessed: results.updated.length + results.notFound.length,\n        updated: results.updated.length,\n        notFound: results.notFound.length,\n        details: results\n      });\n    } catch (error) {\n      console.error(\"Error processing SOJA spreadsheet:\", error);\n      res.status(500).json({ error: \"Failed to process spreadsheet\" });\n    }\n  });\n\n  // Regions\n  app.get(\"/api/regions\", async (req, res) => {\n    try {\n      const regions = await storage.getAllRegions();\n      res.json(regions);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch regions\" });\n    }\n  });\n\n  // Clients\n  app.get(\"/api/clients\", requireAuth, async (req, res) => {\n    try {\n      const { top8020 } = req.query;\n      // Todos os usuários veem apenas seus próprios clientes via user_client_links\n      const clients = await storage.getClientsForUser(req.user!.id, top8020 === \"true\");\n      res.json(clients);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch clients\" });\n    }\n  });\n\n  app.post(\"/api/clients\", requireAuth, async (req, res) => {\n    try {\n      const clientData = insertClientSchema.parse(req.body);\n      // Forçar userId do usuário autenticado\n      const client = { ...clientData, userId: req.user!.id };\n      const newClient = await storage.createClient(client);\n      res.status(201).json(newClient);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid client data\" });\n    }\n  });\n\n  app.patch(\"/api/clients/:id\", requireAuth, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const userId = req.user!.id;\n      \n      // Verificar se o cliente pertence ao usuário\n      const existingClient = await storage.getClient(id);\n      if (!existingClient) {\n        return res.status(404).json({ error: \"Client not found\" });\n      }\n      \n      if (existingClient.userId !== userId) {\n        return res.status(403).json({ error: \"Não autorizado a editar este cliente\" });\n      }\n      \n      const updates = req.body;\n      const updatedClient = await storage.updateClient(id, updates);\n      \n      // Se acabou de marcar como 80/20, aplicar potenciais gerais automaticamente\n      if (updates.isTop80_20 === true && !existingClient.isTop80_20) {\n        const { seasons, userClientLinks, clientMarketRates } = await import(\"@shared/schema\");\n        const { inArray, ne } = await import(\"drizzle-orm\");\n        \n        // Buscar safra ativa\n        const activeSeasons = await db.select()\n          .from(seasons)\n          .where(eq(seasons.isActive, true))\n          .limit(1);\n        \n        if (activeSeasons.length > 0) {\n          const activeSeason = activeSeasons[0];\n          \n          // Buscar outros clientes 80/20 do mesmo usuário (excluindo o cliente atual)\n          const otherTop8020Clients = await db.select()\n            .from(userClientLinks)\n            .where(and(\n              eq(userClientLinks.userId, userId),\n              eq(userClientLinks.isTop80_20, true),\n              eq(userClientLinks.isActive, true),\n              ne(userClientLinks.id, id) // Excluir o cliente atual\n            ));\n          \n          if (otherTop8020Clients.length > 0) {\n            const otherClientIds = otherTop8020Clients.map(c => c.id);\n            \n            // Buscar potenciais gerais existentes de outros clientes 80/20 nesta safra\n            const existingRates = await db.select()\n              .from(clientMarketRates)\n              .where(and(\n                eq(clientMarketRates.userId, userId),\n                inArray(clientMarketRates.clientId, otherClientIds),\n                eq(clientMarketRates.seasonId, activeSeason.id)\n              ));\n            \n            if (existingRates.length > 0) {\n              // Agrupar por categoryId e pegar o valor mais comum (moda)\n              const ratesByCategory = new Map<string, string[]>();\n              existingRates.forEach(rate => {\n                if (!ratesByCategory.has(rate.categoryId)) {\n                  ratesByCategory.set(rate.categoryId, []);\n                }\n                ratesByCategory.get(rate.categoryId)!.push(rate.investmentPerHa);\n              });\n              \n              // Para cada categoria, copiar o potencial geral para o novo cliente 80/20\n              for (const [categoryId, investmentValues] of Array.from(ratesByCategory.entries())) {\n                // Usar o valor mais frequente (ou o primeiro se houver empate)\n                const investmentPerHa = investmentValues[0];\n                \n                // Verificar se já existe rate para este cliente/categoria/safra\n                const existing = await db.select()\n                  .from(clientMarketRates)\n                  .where(and(\n                    eq(clientMarketRates.userId, userId),\n                    eq(clientMarketRates.clientId, id),\n                    eq(clientMarketRates.categoryId, categoryId),\n                    eq(clientMarketRates.seasonId, activeSeason.id)\n                  ))\n                  .limit(1);\n                \n                if (existing.length === 0) {\n                  // Criar novo potencial para este cliente\n                  await db.insert(clientMarketRates).values({\n                    userId,\n                    clientId: id,\n                    categoryId,\n                    seasonId: activeSeason.id,\n                    investmentPerHa\n                  });\n                }\n              }\n            }\n          }\n        }\n      }\n      \n      res.json(updatedClient);\n    } catch (error) {\n      console.error(\"Error updating client:\", error);\n      res.status(400).json({ error: \"Invalid update data\" });\n    }\n  });\n\n  app.delete(\"/api/clients/:id\", requireAuth, async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      // Verificar se o cliente pertence ao usuário\n      const existingClient = await storage.getClient(id);\n      if (!existingClient) {\n        return res.status(404).json({ error: \"Client not found\" });\n      }\n      \n      if (existingClient.userId !== req.user!.id) {\n        return res.status(403).json({ error: \"Não autorizado a deletar este cliente\" });\n      }\n      \n      const deleted = await storage.deleteClient(id);\n      \n      res.json({ success: true, message: \"Client deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete client\" });\n    }\n  });\n\n  // Import clients from Excel\n  const clientUpload = multer({ storage: multer.memoryStorage() });\n  \n  app.post(\"/api/clients/import\", requireAuth, clientUpload.single('file'), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ error: \"No file uploaded\" });\n      }\n\n      const vendedorId = req.body.vendedorId || req.user!.id;\n      const result = await importClientsFromExcel(req.file.buffer, vendedorId);\n      \n      if (!result.success && result.errors.length > 0) {\n        return res.status(400).json({ \n          message: result.errors[0],\n          created: result.created,\n          updated: result.updated,\n          errors: result.errors \n        });\n      }\n\n      res.json({\n        success: result.success,\n        created: result.created,\n        updated: result.updated,\n        message: `Importação concluída: ${result.created} clientes criados, ${result.updated} atualizados`\n      });\n    } catch (error) {\n      console.error(\"Error importing clients:\", error);\n      res.status(500).json({ error: \"Failed to import clients\" });\n    }\n  });\n\n  // Client Family Relations\n  app.get(\"/api/clients/:id/family\", requireAuth, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const relatedClientIds = await storage.getClientFamilyRelations(id, req.user!.id);\n      res.json(relatedClientIds);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch family relations\" });\n    }\n  });\n\n  // Batch endpoint for family relations\n  app.post(\"/api/clients/family/batch\", requireAuth, async (req, res) => {\n    try {\n      const { clientIds } = req.body;\n      if (!Array.isArray(clientIds)) {\n        return res.status(400).json({ error: \"clientIds must be an array\" });\n      }\n      \n      const relationsMap = await storage.getBatchClientFamilyRelations(clientIds, req.user!.id);\n      \n      // Convert Map to object for JSON serialization\n      const result: Record<string, string[]> = {};\n      relationsMap.forEach((value, key) => {\n        result[key] = value;\n      });\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching batch family relations:\", error);\n      res.status(500).json({ error: \"Failed to fetch batch family relations\" });\n    }\n  });\n\n  app.post(\"/api/clients/:id/family\", requireAuth, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { relatedClientId } = req.body;\n      \n      const relation = insertClientFamilyRelationSchema.parse({\n        clientId: id,\n        relatedClientId,\n        userId: req.user!.id\n      });\n      \n      const newRelation = await storage.addClientFamilyRelation(relation);\n      res.status(201).json(newRelation);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid family relation data\" });\n    }\n  });\n\n  app.delete(\"/api/clients/:id/family/:relatedId\", requireAuth, async (req, res) => {\n    try {\n      const { id, relatedId } = req.params;\n      const deleted = await storage.removeClientFamilyRelation(id, relatedId, req.user!.id);\n      \n      if (!deleted) {\n        return res.status(404).json({ error: \"Family relation not found\" });\n      }\n      \n      res.json({ success: true, message: \"Family relation removed successfully\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to remove family relation\" });\n    }\n  });\n\n  // Seasons\n  app.get(\"/api/seasons\", async (req, res) => {\n    try {\n      const seasons = await storage.getAllSeasons();\n      res.json(seasons);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch seasons\" });\n    }\n  });\n\n  app.get(\"/api/seasons/active\", async (req, res) => {\n    try {\n      const activeSeason = await storage.getActiveSeason();\n      res.json(activeSeason);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch active season\" });\n    }\n  });\n\n  app.post(\"/api/seasons\", async (req, res) => {\n    try {\n      console.log(\"[DEBUG] POST /api/seasons - Request body:\", JSON.stringify(req.body, null, 2));\n      \n      // Coerce date strings to Date objects\n      const bodyWithDates = {\n        ...req.body,\n        startDate: new Date(req.body.startDate),\n        endDate: new Date(req.body.endDate),\n      };\n      \n      const season = insertSeasonSchema.parse(bodyWithDates);\n      const newSeason = await storage.createSeason(season);\n      res.status(201).json(newSeason);\n    } catch (error) {\n      console.log(\"[DEBUG] POST /api/seasons - Validation error:\", error);\n      res.status(400).json({ error: \"Invalid season data\", details: error instanceof Error ? error.message : String(error) });\n    }\n  });\n\n  // Season Goals\n  app.get(\"/api/season-goals\", requireAuth, async (req, res) => {\n    try {\n      const allGoals = await storage.getAllSeasonGoals();\n      // Cada usuário vê apenas suas próprias metas\n      const userGoals = allGoals.filter(goal => goal.userId === req.user!.id);\n      res.json(userGoals);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch season goals\" });\n    }\n  });\n\n  app.get(\"/api/season-goals/:seasonId\", requireAuth, async (req, res) => {\n    try {\n      const { seasonId } = req.params;\n      // Always use authenticated user's ID, never accept userId from params\n      const goal = await storage.getSeasonGoal(seasonId, req.user!.id);\n      res.json(goal);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch season goal\" });\n    }\n  });\n\n  app.post(\"/api/season-goals\", requireAuth, async (req, res) => {\n    try {\n      const goalData = insertSeasonGoalSchema.parse(req.body);\n      // Override userId with authenticated user's ID for security\n      const goal = { ...goalData, userId: req.user!.id };\n      const newGoal = await storage.createSeasonGoal(goal);\n      res.status(201).json(newGoal);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid goal data\" });\n    }\n  });\n\n  app.patch(\"/api/season-goals/:id\", requireAuth, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { userId: _, ...updates } = req.body;\n      \n      // Verify the goal belongs to the authenticated user\n      const allGoals = await storage.getAllSeasonGoals();\n      const existingGoal = allGoals.find(g => g.id === id);\n      \n      if (!existingGoal) {\n        return res.status(404).json({ error: \"Season goal not found\" });\n      }\n      \n      if (existingGoal.userId !== req.user!.id) {\n        return res.status(403).json({ error: \"Not authorized to update this goal\" });\n      }\n      \n      const updatedGoal = await storage.updateSeasonGoal(id, updates);\n      res.json(updatedGoal);\n    } catch (error) {\n      res.status(400).json({ error: \"Failed to update season goal\" });\n    }\n  });\n\n  app.delete(\"/api/season-goals/:id\", requireAuth, async (req, res) => {\n    try {\n      const { id } = req.params;\n      \n      // Verify the goal belongs to the authenticated user\n      const allGoals = await storage.getAllSeasonGoals();\n      const existingGoal = allGoals.find(g => g.id === id);\n      \n      if (!existingGoal) {\n        return res.status(404).json({ error: \"Season goal not found\" });\n      }\n      \n      if (existingGoal.userId !== req.user!.id) {\n        return res.status(403).json({ error: \"Not authorized to delete this goal\" });\n      }\n      \n      const deleted = await storage.deleteSeasonGoal(id);\n      if (deleted) {\n        res.json({ success: true });\n      } else {\n        res.status(404).json({ error: \"Season goal not found\" });\n      }\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete season goal\" });\n    }\n  });\n\n  // Sales\n  app.get(\"/api/sales\", requireAuth, async (req, res) => {\n    try {\n      const { clientId, seasonId } = req.query;\n      let sales;\n      \n      if (clientId) {\n        sales = await storage.getSalesByClient(clientId as string);\n      } else if (seasonId) {\n        sales = await storage.getSalesBySeason(seasonId as string);\n      } else {\n        sales = await storage.getAllSales();\n      }\n      \n      // Cada usuário vê apenas suas próprias vendas\n      sales = sales.filter(sale => sale.userId === req.user!.id);\n      \n      res.json(sales);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch sales\" });\n    }\n  });\n\n  app.post(\"/api/sales\", requireAuth, async (req, res) => {\n    try {\n      const saleData = insertSaleSchema.parse(req.body);\n      // Override userId with authenticated user's ID for security\n      const sale = { ...saleData, userId: req.user!.id };\n      const newSale = await storage.createSale(sale);\n      res.status(201).json(newSale);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid sale data\" });\n    }\n  });\n\n  app.patch(\"/api/sales/:id\", requireAuth, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { userId: _, ...updates } = req.body; // Remove userId from updates to prevent ownership change\n      \n      // First verify the sale belongs to the authenticated user\n      const existingSale = await storage.getSale(id);\n      if (!existingSale) {\n        return res.status(404).json({ error: \"Sale not found\" });\n      }\n      if (existingSale.userId !== req.user!.id) {\n        return res.status(403).json({ error: \"Forbidden: Cannot edit another user's sale\" });\n      }\n      \n      // Convert date strings to Date objects\n      const processedUpdates: any = { ...updates };\n      \n      // Convert all timestamp fields\n      if (processedUpdates.dueDate) {\n        processedUpdates.dueDate = new Date(processedUpdates.dueDate);\n      }\n      if (processedUpdates.saleDate) {\n        processedUpdates.saleDate = new Date(processedUpdates.saleDate);\n      }\n      \n      const updatedSale = await storage.updateSale(id, processedUpdates);\n      res.json(updatedSale);\n    } catch (error) {\n      console.error(\"Error updating sale:\", error);\n      res.status(400).json({ error: error instanceof Error ? error.message : \"Invalid update data\" });\n    }\n  });\n\n  app.patch(\"/api/sales/barter/:clientId/manual-commission\", requireAuth, async (req, res) => {\n    try {\n      const { clientId } = req.params;\n      \n      // Validate commission amount with Zod\n      const commissionSchema = z.object({\n        commissionAmount: z.number().min(0, \"Commission amount must be >= 0\")\n      });\n      \n      const validationResult = commissionSchema.safeParse(req.body);\n      if (!validationResult.success) {\n        return res.status(400).json({ error: \"Invalid commission amount. Must be a number >= 0\" });\n      }\n      \n      const { commissionAmount } = validationResult.data;\n      \n      // Verify client belongs to user (unless admin)\n      const client = await storage.getClient(clientId);\n      if (!client) {\n        return res.status(404).json({ error: \"Client not found\" });\n      }\n      \n      if (client.userId !== req.user!.id) {\n        return res.status(403).json({ error: \"Forbidden: Cannot edit another user's client sales\" });\n      }\n      \n      // Get barter sales for this client\n      const allSales = await storage.getAllSales();\n      const barterSales = allSales.filter(\n        sale => sale.clientId === clientId && \n                sale.commissionTier === 'barter' && \n                sale.userId === req.user!.id\n      );\n      \n      if (barterSales.length === 0) {\n        return res.status(404).json({ error: \"No barter sales found for this client\" });\n      }\n      \n      // Apply total commission to first product, zero to others\n      const updatedSales = [];\n      for (let i = 0; i < barterSales.length; i++) {\n        const sale = barterSales[i];\n        const updated = await storage.updateSale(sale.id, {\n          commissionAmount: i === 0 ? commissionAmount.toString() : \"0\",\n          isManual: true,\n        });\n        if (updated) {\n          updatedSales.push(updated);\n        }\n      }\n      \n      res.json({ \n        success: true, \n        updatedCount: updatedSales.length,\n        sales: updatedSales \n      });\n    } catch (error) {\n      console.error(\"Error updating barter commission:\", error);\n      res.status(500).json({ error: \"Failed to update barter commission\" });\n    }\n  });\n\n  app.post(\"/api/sales/recalculate-all\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      \n      // Fetch all required data\n      const [sales, categories, products] = await Promise.all([\n        storage.getAllSales(),\n        storage.getAllCategories(),\n        storage.getAllProducts(),\n      ]);\n      \n      // Filter sales by user\n      const userSales = sales.filter(sale => sale.userId === userId);\n      \n      // Create lookup maps\n      const categoryMap = new Map(categories.map(c => [c.id, c]));\n      const productMap = new Map(products.map(p => [p.id, p]));\n      \n      let updatedCount = 0;\n      const errors: string[] = [];\n      \n      for (const sale of userSales) {\n        try {\n          const category = categoryMap.get(sale.categoryId);\n          const product = productMap.get(sale.productId);\n          \n          if (!category) {\n            errors.push(`Sale ${sale.id}: Category not found`);\n            continue;\n          }\n          \n          const margin = parseFloat(sale.margin.toString());\n          const totalAmount = parseFloat(sale.totalAmount.toString());\n          const ivaRate = parseFloat(sale.ivaRate.toString());\n          \n          // 1. Recalculate commission\n          const greenMarginMin = parseFloat(category.greenMarginMin);\n          const yellowMarginMin = parseFloat(category.yellowMarginMin);\n          const yellowMarginMax = parseFloat(category.yellowMarginMax);\n          const redMarginMin = parseFloat(category.redMarginMin);\n          const redMarginMax = parseFloat(category.redMarginMax);\n          \n          let commissionTier: string;\n          let commissionRate: number;\n          \n          if (margin >= greenMarginMin) {\n            commissionTier = \"verde\";\n            commissionRate = parseFloat(category.greenCommission);\n          } else if (margin >= yellowMarginMin && margin <= yellowMarginMax) {\n            commissionTier = \"amarela\";\n            commissionRate = parseFloat(category.yellowCommission);\n          } else if (margin >= redMarginMin && margin <= redMarginMax) {\n            commissionTier = \"vermelha\";\n            commissionRate = parseFloat(category.redCommission);\n          } else {\n            commissionTier = \"abaixo_lista\";\n            commissionRate = parseFloat(category.belowListCommission);\n          }\n          \n          const amountBeforeIva = totalAmount / (1 + ivaRate / 100);\n          const commissionAmount = amountBeforeIva * (commissionRate / 100);\n          \n          // 2. Recalculate Timac points\n          let timacPoints = null;\n          if (product && category.id === 'cat-especialidades') {\n            const normalizedMarca = product.marca\n              ?.normalize('NFD')\n              .replace(/[\\u0300-\\u036f]/g, '')\n              .toUpperCase()\n              .replace(/\\s+/g, '') || '';\n            \n            if (normalizedMarca.startsWith('TIMAC')) {\n              const quantity = sale.quantity ? parseFloat(sale.quantity.toString()) : 0;\n              const normalizedProductName = product.name\n                ?.normalize('NFD')\n                .replace(/[\\u0300-\\u036f]/g, '')\n                .toUpperCase() || '';\n              \n              const pointsPerUnit = normalizedProductName.includes('FERTIACTYL') && \n                                   normalizedProductName.includes('LEGUMINOSAS') ? 3 : 1;\n              \n              timacPoints = quantity * pointsPerUnit;\n            }\n          }\n          \n          // Update sale\n          await storage.updateSale(sale.id, {\n            commissionTier,\n            commissionRate: commissionRate.toString(),\n            commissionAmount: commissionAmount.toString(),\n            timacPoints: timacPoints !== null ? timacPoints.toString() : null,\n          });\n          \n          updatedCount++;\n        } catch (error) {\n          errors.push(`Sale ${sale.id}: ${error instanceof Error ? error.message : 'Unknown error'}`);\n        }\n      }\n      \n      res.json({\n        success: true,\n        totalSales: userSales.length,\n        updatedCount,\n        errors: errors.length > 0 ? errors : undefined,\n      });\n    } catch (error) {\n      console.error(\"Error recalculating sales:\", error);\n      res.status(500).json({ \n        success: false,\n        error: error instanceof Error ? error.message : \"Failed to recalculate sales\" \n      });\n    }\n  });\n\n  // Analytics\n  app.get(\"/api/analytics/sales\", requireAuth, async (req, res) => {\n    try {\n      const { seasonId } = req.query;\n      // Cada usuário vê apenas suas próprias analytics\n      const analytics = await storage.getSalesAnalytics(seasonId as string, req.user!.id);\n      res.json(analytics);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch sales analytics\" });\n    }\n  });\n\n  app.get(\"/api/analytics/opportunities\", async (req, res) => {\n    try {\n      const { clientId } = req.query;\n      const opportunities = await storage.getOpportunityAlerts(clientId as string);\n      res.json(opportunities);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch opportunity alerts\" });\n    }\n  });\n\n  // Season Parameters\n  app.get(\"/api/season-parameters\", async (req, res) => {\n    try {\n      const parameters = await storage.getAllSeasonParameters();\n      res.json(parameters);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch season parameters\" });\n    }\n  });\n\n  // Excel Import\n  app.post(\"/api/sales/import-excel\", requireAuth, upload.single(\"file\"), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ \n          success: false,\n          message: \"Nenhum arquivo foi enviado\" \n        });\n      }\n\n      const seasonId = req.body.seasonId;\n      if (!seasonId) {\n        return res.status(400).json({\n          success: false,\n          message: \"Safra não selecionada. Por favor, selecione uma safra.\"\n        });\n      }\n\n      const result = await importExcelFile(req.file.buffer, seasonId, req.user!.id);\n      \n      console.log('Import result:', JSON.stringify(result, null, 2));\n      \n      if (result.success) {\n        res.json({\n          success: true,\n          message: `Importação concluída com sucesso! ${result.importedSales} vendas importadas.`,\n          importedSales: result.importedSales,\n          createdClients: result.createdClients,\n          createdProducts: result.createdProducts,\n        });\n      } else {\n        const errorMessage = result.errors.length > 0 \n          ? result.errors.join('; ') \n          : 'Nenhuma venda foi importada. Verifique o formato do arquivo.';\n        \n        res.status(400).json({\n          success: false,\n          message: errorMessage,\n          totalRows: result.totalRows,\n          importedSales: result.importedSales,\n          errors: result.errors,\n        });\n      }\n    } catch (error) {\n      console.error('Import error:', error);\n      res.status(500).json({ \n        success: false,\n        message: error instanceof Error ? error.message : \"Erro desconhecido ao importar arquivo\",\n      });\n    }\n  });\n\n  // Import Batches Management\n  app.get(\"/api/sales/import-batches\", requireAuth, async (req, res) => {\n    try {\n      const allBatches = await storage.getImportBatches();\n      // Filter batches by authenticated user\n      const userBatches = allBatches.filter(batch => batch.userId === req.user!.id);\n      res.json(userBatches);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch import batches\" });\n    }\n  });\n\n  app.delete(\"/api/sales/import-batches/:batchId\", requireAuth, async (req, res) => {\n    try {\n      const { batchId } = req.params;\n      await storage.deleteImportBatch(batchId);\n      res.json({ success: true, message: \"Lote deletado com sucesso\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete import batch\" });\n    }\n  });\n\n  // Temporary admin route to delete all sales\n  app.delete(\"/api/admin/reset-sales\", requireSuperAdmin, async (req, res) => {\n    try {\n      await storage.deleteAllSales();\n      res.json({ success: true, message: \"Todas as vendas foram deletadas\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete sales\" });\n    }\n  });\n\n  // Client Market Rates (Investment per Ha configuration)\n  app.get(\"/api/clients/:clientId/market-rates/:seasonId\", requireAuth, async (req, res) => {\n    try {\n      const { clientId, seasonId } = req.params;\n      const rates = await storage.getClientMarketRates(clientId, req.user!.id, seasonId);\n      res.json(rates);\n    } catch (error) {\n      console.error('Error fetching client market rates:', error);\n      res.status(500).json({ error: \"Failed to fetch client market rates\" });\n    }\n  });\n\n  // Manager endpoint to get current market rates for a season\n  app.get(\"/api/clients/manager-team/market-rates/:seasonId\", requireManager, async (req, res) => {\n    try {\n      const { seasonId } = req.params;\n      \n      // Get all consultants in this manager's team\n      const teamConsultants = await db.select()\n        .from(users)\n        .where(eq(users.managerId, req.user!.id));\n      \n      const consultantIds = teamConsultants.map(c => c.id);\n      \n      if (consultantIds.length === 0) {\n        return res.json([]);\n      }\n      \n      // Get one client from the team to fetch the rates (they should all have the same values)\n      const firstClient = await db.select()\n        .from(userClientLinks)\n        .where(and(\n          inArray(userClientLinks.userId, consultantIds),\n          eq(userClientLinks.includeInMarketArea, true)\n        ))\n        .limit(1);\n      \n      if (firstClient.length === 0) {\n        return res.json([]);\n      }\n      \n      // Query database directly for market rates for this client and season\n      // Don't filter by userId as all team clients should have the same configuration\n      const rates = await db.select()\n        .from(clientMarketRates)\n        .where(and(\n          eq(clientMarketRates.clientId, firstClient[0].id),\n          eq(clientMarketRates.seasonId, seasonId)\n        ));\n      \n      res.json(rates);\n    } catch (error) {\n      console.error('Error fetching team market rates:', error);\n      res.status(500).json({ error: \"Failed to fetch team market rates\" });\n    }\n  });\n\n  // Manager-specific endpoint to apply market rates to entire team\n  app.post(\"/api/clients/manager-team/market-rates\", requireManager, async (req, res) => {\n    try {\n      const { allRates } = req.body;\n      \n      console.log('POST /api/clients/manager-team/market-rates');\n      console.log('Manager ID:', req.user!.id);\n      console.log('Received allRates:', JSON.stringify(allRates, null, 2));\n      \n      // Get all consultants in this manager's team\n      const teamConsultants = await db.select()\n        .from(users)\n        .where(eq(users.managerId, req.user!.id));\n      \n      console.log('Team consultants found:', teamConsultants.length);\n      \n      const consultantIds = teamConsultants.map(c => c.id);\n      \n      // If no team members found, just return empty\n      if (consultantIds.length === 0) {\n        console.log('No consultants in team, returning 0');\n        return res.json({ success: true, message: \"Nenhum consultor na equipe\", count: 0, categoryCount: 0 });\n      }\n      \n      // Get all clients for these consultants (only those included in market area)\n      const teamClients = await db.select()\n        .from(userClientLinks)\n        .where(and(\n          inArray(userClientLinks.userId, consultantIds),\n          eq(userClientLinks.includeInMarketArea, true)\n        ));\n      \n      console.log('Team clients with badge amarelo found:', teamClients.length);\n      \n      if (teamClients.length === 0) {\n        console.log('No clients with yellow badge, returning 0');\n        return res.json({ success: true, message: \"Nenhum cliente com badge amarelo na equipe\", count: 0, categoryCount: 0 });\n      }\n      \n      // Process all categories from allRates array\n      let totalRatesCreated = 0;\n      \n      if (allRates && Array.isArray(allRates) && allRates.length > 0) {\n        // Process each category\n        for (const rateConfig of allRates) {\n          const { categoryId, seasonId, investmentPerHa, subcategories } = rateConfig;\n          \n          // Apply this category's rate to all team clients\n          for (const client of teamClients) {\n            await storage.upsertClientMarketRate({\n              clientId: client.id,\n              categoryId,\n              userId: client.userId,\n              seasonId,\n              investmentPerHa,\n              subcategories: subcategories || null\n            });\n            totalRatesCreated++;\n          }\n        }\n      }\n      \n      const clientCount = teamClients.length;\n      const categoryCount = allRates?.length || 0;\n      \n      res.json({ \n        success: true, \n        count: clientCount,\n        categoryCount: categoryCount,\n        totalRates: totalRatesCreated,\n        message: `Potencial de ${categoryCount} categoria(s) aplicado a ${clientCount} cliente(s)`\n      });\n    } catch (error) {\n      console.error('Error upserting client market rate:', error);\n      res.status(500).json({ error: \"Failed to save client market rate\" });\n    }\n  });\n\n  app.post(\"/api/clients/:clientId/market-rates\", requireAuth, async (req, res) => {\n    try {\n      // Only managers can configure market rates (will be replicated to team)\n      if (req.user!.role !== 'gerente') {\n        return res.status(403).json({ error: \"Apenas gerentes podem configurar potencial de mercado\" });\n      }\n\n      const { categoryId, seasonId, investmentPerHa, subcategories } = req.body;\n      \n      // Get all consultants in this manager's team\n      const teamConsultants = await db.select()\n        .from(users)\n        .where(eq(users.managerId, req.user!.id));\n      \n      const consultantIds = teamConsultants.map(c => c.id);\n      \n      // If no team members found, just return empty\n      if (consultantIds.length === 0) {\n        return res.json({ success: true, message: \"Nenhum consultor na equipe\" });\n      }\n      \n      // Get all clients for these consultants (only those included in market area)\n      const teamClients = await db.select()\n        .from(userClientLinks)\n        .where(and(\n          inArray(userClientLinks.userId, consultantIds),\n          eq(userClientLinks.includeInMarketArea, true)\n        ));\n      \n      // Create/update market rates for ALL clients in the team\n      const rates = [];\n      for (const client of teamClients) {\n        const rate = await storage.upsertClientMarketRate({\n          clientId: client.id,\n          categoryId,\n          userId: client.userId, // Use the consultant's userId, not the manager's\n          seasonId,\n          investmentPerHa,\n          subcategories: subcategories || null\n        });\n        rates.push(rate);\n      }\n      \n      res.json({ success: true, count: rates.length, message: `Configuração aplicada a ${rates.length} cliente(s)` });\n    } catch (error) {\n      console.error('Error upserting client market rate:', error);\n      res.status(500).json({ error: \"Failed to save client market rate\" });\n    }\n  });\n\n  app.delete(\"/api/clients/:clientId/market-rates/:categoryId/:seasonId\", requireAuth, async (req, res) => {\n    try {\n      const { clientId, categoryId, seasonId } = req.params;\n      await storage.deleteClientMarketRate(clientId, categoryId, req.user!.id, seasonId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error('Error deleting client market rate:', error);\n      res.status(500).json({ error: \"Failed to delete client market rate\" });\n    }\n  });\n\n  // Market Benchmarks\n  app.get(\"/api/market-benchmarks/:seasonId\", requireAuth, async (req, res) => {\n    try {\n      const { seasonId } = req.params;\n      const benchmarks = await storage.getMarketBenchmarks(req.user!.id, seasonId);\n      res.json(benchmarks);\n    } catch (error) {\n      console.error('Error fetching market benchmarks:', error);\n      res.status(500).json({ error: \"Failed to fetch market benchmarks\" });\n    }\n  });\n\n  app.post(\"/api/market-benchmarks\", requireAuth, async (req, res) => {\n    try {\n      const { categoryId, seasonId, marketPercentage } = req.body;\n      \n      const benchmark = await storage.upsertMarketBenchmark({\n        userId: req.user!.id,\n        categoryId,\n        seasonId,\n        marketPercentage\n      });\n      \n      res.json(benchmark);\n    } catch (error) {\n      console.error('Error upserting market benchmark:', error);\n      res.status(500).json({ error: \"Failed to save market benchmark\" });\n    }\n  });\n\n  app.delete(\"/api/market-benchmarks/:categoryId/:seasonId\", requireAuth, async (req, res) => {\n    try {\n      const { categoryId, seasonId } = req.params;\n      await storage.deleteMarketBenchmark(req.user!.id, categoryId, seasonId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error('Error deleting market benchmark:', error);\n      res.status(500).json({ error: \"Failed to delete market benchmark\" });\n    }\n  });\n\n  app.get(\"/api/market-potential\", requireAuth, async (req, res) => {\n    try {\n      const { seasonId } = req.query;\n      \n      if (!seasonId || typeof seasonId !== 'string') {\n        return res.status(400).json({ error: \"Season ID is required\" });\n      }\n\n      const potentials = await storage.getMarketPotentialByCategory(req.user!.id, seasonId);\n      res.json(potentials);\n    } catch (error) {\n      console.error('Error getting market potential:', error);\n      res.status(500).json({ error: \"Failed to get market potential\" });\n    }\n  });\n\n  // External Purchases\n  app.get(\"/api/clients/:clientId/external-purchases/:seasonId\", requireAuth, async (req, res) => {\n    try {\n      const { clientId, seasonId } = req.params;\n      const purchases = await storage.getExternalPurchases(clientId, req.user!.id, seasonId);\n      res.json(purchases);\n    } catch (error) {\n      console.error('Error fetching external purchases:', error);\n      res.status(500).json({ error: \"Failed to fetch external purchases\" });\n    }\n  });\n\n  app.post(\"/api/external-purchases\", requireAuth, async (req, res) => {\n    try {\n      const purchaseData = insertExternalPurchaseSchema.parse({\n        ...req.body,\n        userId: req.user!.id\n      });\n      const purchase = await storage.upsertExternalPurchase(purchaseData);\n      res.json(purchase);\n    } catch (error) {\n      console.error('Error upserting external purchase:', error);\n      res.status(500).json({ error: \"Failed to save external purchase\" });\n    }\n  });\n\n  app.delete(\"/api/external-purchases\", requireAuth, async (req, res) => {\n    try {\n      const { clientId, categoryId, seasonId } = req.body;\n      await storage.deleteExternalPurchase(req.user!.id, clientId, categoryId, seasonId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error('Error deleting external purchase:', error);\n      res.status(500).json({ error: \"Failed to delete external purchase\" });\n    }\n  });\n\n  // Market Analysis\n  app.get(\"/api/market-analysis\", requireAuth, async (req, res) => {\n    try {\n      const rates = await storage.getMarketInvestmentRates();\n      const allSales = await storage.getAllSales();\n      const categories = await storage.getAllCategories();\n      const activeSeason = await storage.getActiveSeason();\n      const products = await storage.getAllProducts();\n\n      // Use provided seasonId or fallback to active season\n      const seasonId = (req.query.seasonId as string) || activeSeason?.id || '';\n\n      // Filter sales by authenticated user AND selected season\n      const sales = allSales.filter(s => s.userId === req.user!.id && s.seasonId === seasonId);\n      \n      // Create product-to-subcategory map\n      const productSubcategoryMap = new Map(\n        products\n          .filter(p => p.subcategoryId)\n          .map(p => [p.id, p.subcategoryId!])\n      );\n\n      // Get only top 80/20 clients for this user from user_client_links\n      const top8020Clients = await storage.getClientsForUser(req.user!.id, true);\n\n      // Fetch all family relations for top 80/20 clients\n      const allFamilyRelations = await Promise.all(\n        top8020Clients.map(c => storage.getClientFamilyRelations(c.id, req.user!.id))\n      );\n\n      // Build family groups using union-find approach\n      const clientToGroup = new Map<string, Set<string>>();\n      \n      top8020Clients.forEach((client, idx) => {\n        const relatedIds = allFamilyRelations[idx];\n        \n        if (relatedIds.length === 0) {\n          // Client has no family relations, create solo group\n          clientToGroup.set(client.id, new Set([client.id]));\n        } else {\n          // Find existing group or create new one\n          let existingGroup: Set<string> | null = null;\n          \n          // Check if client or any related client already in a group\n          for (const relatedId of [client.id, ...relatedIds]) {\n            if (clientToGroup.has(relatedId)) {\n              existingGroup = clientToGroup.get(relatedId)!;\n              break;\n            }\n          }\n          \n          if (!existingGroup) {\n            existingGroup = new Set();\n          }\n          \n          // Add all members to the group\n          existingGroup.add(client.id);\n          relatedIds.forEach(id => existingGroup!.add(id));\n          \n          // Update all members to point to this group\n          existingGroup.forEach(id => clientToGroup.set(id, existingGroup!));\n        }\n      });\n\n      // For each family group, determine the client with max planting area\n      const effectivePlantingArea = new Map<string, number>();\n      const processedGroups = new Set<Set<string>>();\n      \n      top8020Clients.forEach(client => {\n        const group = clientToGroup.get(client.id);\n        if (!group || processedGroups.has(group)) return;\n        \n        processedGroups.add(group);\n        \n        // Find client with max planting area in this group\n        let maxArea = 0;\n        let maxAreaClientId = client.id;\n        \n        group.forEach(clientId => {\n          const groupClient = top8020Clients.find(c => c.id === clientId);\n          if (groupClient) {\n            const area = parseFloat(groupClient.plantingArea);\n            if (area > maxArea) {\n              maxArea = area;\n              maxAreaClientId = clientId;\n            }\n          }\n        });\n        \n        // Set effective area: max area for representative client, 0 for others\n        group.forEach(clientId => {\n          effectivePlantingArea.set(\n            clientId, \n            clientId === maxAreaClientId ? maxArea : 0\n          );\n        });\n      });\n\n      // Create category map for easy lookup\n      const categoryMap = new Map(categories.map(c => [c.id, c]));\n      const rateMap = new Map(rates.map(r => [r.categoryId, r]));\n\n      // Fetch all client market rates for this user and active season\n      const allClientRates = await Promise.all(\n        top8020Clients.map(c => storage.getClientMarketRates(c.id, req.user!.id, seasonId))\n      );\n      const clientRatesMap = new Map(\n        allClientRates.flatMap((rates, idx) => \n          rates.map(r => [`${top8020Clients[idx].id}-${r.categoryId}`, r])\n        )\n      );\n\n      // Fetch all external purchases for this user and active season\n      const allExternalPurchases = await Promise.all(\n        top8020Clients.map(c => storage.getExternalPurchases(c.id, req.user!.id, seasonId))\n      );\n      const externalPurchasesMap = new Map(\n        allExternalPurchases.flatMap((purchases, idx) => \n          purchases.map(p => [`${top8020Clients[idx].id}-${p.categoryId}`, p])\n        )\n      );\n\n      const clientAnalysis = top8020Clients.map(client => {\n        const clientSales = sales.filter(s => s.clientId === client.id);\n        \n        // Calculate sales by category\n        const salesByCategory = clientSales.reduce((acc, sale) => {\n          const amount = parseFloat(sale.totalAmount);\n          acc[sale.categoryId] = (acc[sale.categoryId] || 0) + amount;\n          return acc;\n        }, {} as Record<string, number>);\n        \n        // Calculate sales by category and subcategory (for Agroquímicos)\n        const salesBySubcategory = clientSales.reduce((acc, sale) => {\n          const subcategoryId = productSubcategoryMap.get(sale.productId);\n          if (subcategoryId) {\n            const key = `${sale.categoryId}-${subcategoryId}`;\n            const amount = parseFloat(sale.totalAmount);\n            acc[key] = (acc[key] || 0) + amount;\n          }\n          return acc;\n        }, {} as Record<string, number>);\n\n        // Calculate potential and % for each category\n        const categoryDetails: Record<string, any> = {};\n        let totalPotential = 0;\n        let totalRealized = 0;\n\n        // Iterate over all categories instead of just market investment rates\n        categories.forEach(category => {\n          // Check if there's a custom rate for this client and category\n          const customRate = clientRatesMap.get(`${client.id}-${category.id}`);\n          const defaultRate = rateMap.get(category.id);\n          \n          // Use custom rate if available, otherwise use default rate\n          let investmentPerHa = 0;\n          if (customRate) {\n            investmentPerHa = parseFloat(customRate.investmentPerHa);\n          } else if (defaultRate) {\n            investmentPerHa = parseFloat(defaultRate.investmentPerHa);\n          }\n\n          // Use effective planting area (accounting for family groups)\n          const plantingAreaForCalc = effectivePlantingArea.get(client.id) ?? parseFloat(client.plantingArea);\n          const potential = plantingAreaForCalc * investmentPerHa;\n          const cvaleAmount = salesByCategory[category.id] || 0;\n          \n          // Get external purchases for this client and category\n          const externalPurchase = externalPurchasesMap.get(`${client.id}-${category.id}`);\n          const externalAmount = externalPurchase ? parseFloat(externalPurchase.amount) : 0;\n          \n          const categoryTotalRealized = cvaleAmount + externalAmount;\n          const percentage = potential > 0 ? (categoryTotalRealized / potential) * 100 : 0;\n          const opportunity = potential - categoryTotalRealized;\n          const isClosed = percentage >= 100;\n\n          totalPotential += potential;\n          totalRealized += categoryTotalRealized;\n\n          // Build detailed subcategory breakdown for Agroquímicos\n          let subcategoryDetails = null;\n          if (category.id === 'cat-agroquimicos') {\n            // Fetch subcategories for this category\n            const agroquimicosSubcategories = [\n              { id: 'sub-tratamento-sementes', name: 'Tratamento de semente' },\n              { id: 'sub-dessecacao', name: 'Dessecação' },\n              { id: 'sub-inseticidas', name: 'Inseticidas' },\n              { id: 'sub-fungicidas', name: 'Fungicidas' }\n            ];\n            \n            const externalSubcategories = (externalPurchase?.subcategories as Record<string, number>) || {};\n            \n            subcategoryDetails = agroquimicosSubcategories.map(subcat => {\n              const cvaleSubAmount = salesBySubcategory[`${category.id}-${subcat.id}`] || 0;\n              const externalSubAmount = externalSubcategories[subcat.id] || 0;\n              const totalSubAmount = cvaleSubAmount + externalSubAmount;\n              \n              // Get products sold in this subcategory for this client\n              const subcategorySales = clientSales.filter(sale => {\n                const productSubcategoryId = productSubcategoryMap.get(sale.productId);\n                return sale.categoryId === category.id && productSubcategoryId === subcat.id;\n              });\n              \n              // Group by product\n              const productDetails = subcategorySales.reduce((acc, sale) => {\n                const product = products.find(p => p.id === sale.productId);\n                if (!product) return acc;\n                \n                if (!acc[product.id]) {\n                  acc[product.id] = {\n                    productId: product.id,\n                    productName: product.name,\n                    quantity: 0,\n                    cvaleAmount: 0\n                  };\n                }\n                \n                acc[product.id].quantity += sale.quantity ? parseFloat(sale.quantity) : 0;\n                acc[product.id].cvaleAmount += parseFloat(sale.totalAmount);\n                \n                return acc;\n              }, {} as Record<string, { productId: string; productName: string; quantity: number; cvaleAmount: number }>);\n              \n              return {\n                id: subcat.id,\n                name: subcat.name,\n                cvaleAmount: cvaleSubAmount,\n                externalAmount: externalSubAmount,\n                totalAmount: totalSubAmount,\n                products: Object.values(productDetails)\n              };\n            });\n          }\n\n          categoryDetails[category.id] = {\n            categoryName: category.name,\n            potential,\n            cvaleAmount,\n            externalAmount,\n            externalCompany: externalPurchase?.company || null,\n            totalRealized: categoryTotalRealized,\n            opportunity: opportunity > 0 ? opportunity : 0,\n            isClosed,\n            percentage,\n            hasCustomRate: !!customRate,\n            subcategories: subcategoryDetails\n          };\n        });\n\n        const totalPercentage = totalPotential > 0 ? (totalRealized / totalPotential) * 100 : 0;\n\n        return {\n          clientId: client.id,\n          clientName: client.name,\n          plantingArea: parseFloat(client.plantingArea),\n          totalPotential,\n          totalRealized,\n          totalPercentage,\n          categoryDetails\n        };\n      });\n\n      // Calculate regional benchmark (average % by category)\n      const benchmark: Record<string, number> = {};\n      categories.forEach(category => {\n        const percentages = clientAnalysis\n          .map(c => c.categoryDetails[category.id]?.percentage || 0)\n          .filter(p => p > 0);\n        \n        const average = percentages.length > 0 \n          ? percentages.reduce((sum, p) => sum + p, 0) / percentages.length \n          : 0;\n\n        benchmark[category.id] = average;\n      });\n\n      // Calculate opportunities (gaps)\n      const opportunities = clientAnalysis.flatMap(client => \n        Object.entries(client.categoryDetails).map(([categoryId, details]) => ({\n          clientId: client.clientId,\n          clientName: client.clientName,\n          categoryId,\n          categoryName: details.categoryName,\n          clientPercentage: details.percentage,\n          marketPercentage: benchmark[categoryId] || 0,\n          gap: (benchmark[categoryId] || 0) - details.percentage,\n          potential: details.potential,\n          realized: details.realized\n        }))\n      ).filter(opp => opp.gap > 5); // Only show significant gaps\n\n      res.json({\n        clientAnalysis,\n        benchmark,\n        opportunities: opportunities.sort((a, b) => b.gap - a.gap) // Sort by biggest gaps first\n      });\n    } catch (error) {\n      console.error('Market analysis error:', error);\n      res.status(500).json({ error: \"Failed to generate market analysis\" });\n    }\n  });\n\n  // Timac Points Reward\n  app.get(\"/api/timac-points\", requireAuth, async (req, res) => {\n    try {\n      const { seasonId } = req.query;\n      \n      // Buscar todas as vendas do usuário autenticado com pontos Timac\n      const allSales = await storage.getAllSales();\n      let sales = allSales.filter(s => s.userId === req.user!.id);\n      \n      // Filtrar por season se fornecido\n      if (seasonId) {\n        sales = sales.filter(s => s.seasonId === seasonId);\n      }\n      \n      // Somar pontos Timac\n      const totalPoints = sales.reduce((sum, sale) => {\n        if (sale.timacPoints) {\n          return sum + parseFloat(sale.timacPoints);\n        }\n        return sum;\n      }, 0);\n      \n      // Calcular premiação: total pontos × $0.76 USD\n      const rewardPerPoint = 0.76;\n      const totalReward = totalPoints * rewardPerPoint;\n      \n      res.json({\n        totalPoints: totalPoints.toFixed(2),\n        rewardPerPoint: rewardPerPoint.toFixed(2),\n        totalReward: totalReward.toFixed(2),\n        currency: 'USD'\n      });\n    } catch (error) {\n      console.error('Timac points error:', error);\n      res.status(500).json({ error: \"Failed to calculate Timac points\" });\n    }\n  });\n\n  // Alert Settings\n  app.get(\"/api/alert-settings\", requireAuth, async (req, res) => {\n    try {\n      const settings = await storage.getAlertSettings(req.user!.id);\n      \n      if (!settings) {\n        const defaults = {\n          userId: req.user!.id,\n          emailEnabled: false,\n          notificationsEnabled: true,\n          goalAlerts: true,\n          opportunityAlerts: true,\n          seasonDeadlineAlerts: true,\n          goalThresholdPercent: \"80.00\",\n          email: null\n        };\n        return res.json(defaults);\n      }\n      \n      res.json(settings);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch alert settings\" });\n    }\n  });\n\n  app.put(\"/api/alert-settings\", requireAuth, async (req, res) => {\n    try {\n      const settingsData = insertAlertSettingsSchema.parse(req.body);\n      const settings = await storage.upsertAlertSettings({ ...settingsData, userId: req.user!.id });\n      res.json(settings);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid alert settings data\" });\n    }\n  });\n\n  // Alerts\n  app.get(\"/api/alerts\", requireAuth, async (req, res) => {\n    try {\n      const alerts = await storage.getAlerts(req.user!.id);\n      res.json(alerts);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch alerts\" });\n    }\n  });\n\n  app.get(\"/api/alerts/unread-count\", requireAuth, async (req, res) => {\n    try {\n      const count = await storage.getUnreadAlertsCount(req.user!.id);\n      res.json({ count });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch unread count\" });\n    }\n  });\n\n  app.post(\"/api/alerts/:id/mark-read\", requireAuth, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const success = await storage.markAlertAsRead(id, req.user!.id);\n      \n      if (!success) {\n        return res.status(404).json({ error: \"Alert not found\" });\n      }\n      \n      res.json({ success: true, message: \"Alert marked as read\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to mark alert as read\" });\n    }\n  });\n\n  app.post(\"/api/alerts/mark-all-read\", requireAuth, async (req, res) => {\n    try {\n      const success = await storage.markAllAlertsAsRead(req.user!.id);\n      res.json({ success, message: \"All alerts marked as read\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to mark all alerts as read\" });\n    }\n  });\n\n  app.delete(\"/api/alerts/:id\", requireAuth, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const success = await storage.deleteAlert(id, req.user!.id);\n      \n      if (!success) {\n        return res.status(404).json({ error: \"Alert not found\" });\n      }\n      \n      res.json({ success: true, message: \"Alert deleted successfully\" });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete alert\" });\n    }\n  });\n\n  app.post(\"/api/alerts/check\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      let alertsCreated = 0;\n      \n      const activeSeason = await storage.getActiveSeason();\n      if (!activeSeason) {\n        return res.json({ alertsCreated: 0, message: \"No active season found\" });\n      }\n\n      const settings = await storage.getAlertSettings(userId);\n      const threshold = settings?.goalThresholdPercent ? parseFloat(settings.goalThresholdPercent) : 80;\n      \n      const existingAlerts = await storage.getAlerts(userId);\n      const recentAlertCutoff = new Date(Date.now() - 24 * 60 * 60 * 1000);\n\n      const hasRecentAlert = (type: string, relatedId?: string) => {\n        return existingAlerts.some(alert => \n          alert.type === type && \n          alert.relatedId === relatedId &&\n          new Date(alert.createdAt) > recentAlertCutoff\n        );\n      };\n\n      if (settings?.goalAlerts !== false) {\n        const goal = await storage.getSeasonGoal(activeSeason.id, userId);\n        \n        if (goal) {\n          const allSales = await storage.getAllSales();\n          const seasonSales = allSales.filter(s => \n            s.userId === userId && s.seasonId === activeSeason.id\n          );\n          \n          const totalSales = seasonSales.reduce((sum, sale) => \n            sum + parseFloat(sale.totalAmount), 0\n          );\n          \n          const goalAmount = parseFloat(goal.goalAmount);\n          const progress = goalAmount > 0 ? (totalSales / goalAmount) * 100 : 0;\n          \n          if (progress >= threshold && progress < 100 && !hasRecentAlert(\"meta\", activeSeason.id)) {\n            await storage.createAlert({\n              userId,\n              type: \"meta\",\n              title: \"Meta próxima de ser atingida\",\n              message: `Você atingiu ${progress.toFixed(1)}% da meta para ${activeSeason.name}. Faltam USD ${(goalAmount - totalSales).toFixed(2)} para completar!`,\n              severity: progress >= 90 ? \"warning\" : \"info\",\n              relatedId: activeSeason.id,\n              relatedType: \"season\",\n              isRead: false\n            });\n            alertsCreated++;\n          }\n        }\n      }\n\n      if (settings?.opportunityAlerts !== false) {\n        const topClients = await storage.getTop80_20Clients();\n        const allSales = await storage.getAllSales();\n        const seasonSales = allSales.filter(s => \n          s.userId === userId && s.seasonId === activeSeason.id\n        );\n        \n        const clientsWithSales = new Set(seasonSales.map(s => s.clientId));\n        const clientsWithoutSales = topClients.filter(c => !clientsWithSales.has(c.id));\n        \n        for (const client of clientsWithoutSales) {\n          if (!hasRecentAlert(\"oportunidade\", client.id)) {\n            await storage.createAlert({\n              userId,\n              type: \"oportunidade\",\n              title: \"Cliente top sem compras\",\n              message: `O cliente ${client.name} está no grupo top 80/20 mas ainda não fez compras na safra ${activeSeason.name}.`,\n              severity: \"warning\",\n              relatedId: client.id,\n              relatedType: \"client\",\n              isRead: false\n            });\n            alertsCreated++;\n          }\n        }\n      }\n\n      if (settings?.seasonDeadlineAlerts !== false) {\n        const now = new Date();\n        const endDate = new Date(activeSeason.endDate);\n        const daysUntilEnd = Math.ceil((endDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));\n        \n        if (daysUntilEnd <= 30 && daysUntilEnd > 0 && !hasRecentAlert(\"prazo_safra\", activeSeason.id)) {\n          await storage.createAlert({\n            userId,\n            type: \"prazo_safra\",\n            title: \"Safra próxima do fim\",\n            message: `A safra ${activeSeason.name} termina em ${daysUntilEnd} dias. Finalize suas vendas e metas!`,\n            severity: daysUntilEnd <= 7 ? \"urgent\" : \"warning\",\n            relatedId: activeSeason.id,\n            relatedType: \"season\",\n            isRead: false\n          });\n          alertsCreated++;\n        }\n      }\n\n      res.json({ \n        alertsCreated, \n        message: alertsCreated > 0 \n          ? `${alertsCreated} novo(s) alerta(s) criado(s)` \n          : \"Nenhum novo alerta\" \n      });\n    } catch (error) {\n      console.error('Alert check error:', error);\n      res.status(500).json({ error: \"Failed to check alerts\" });\n    }\n  });\n\n  // Purchase History\n  app.post(\"/api/purchase-history/parse-pdf\", requireAuth, upload.single(\"file\"), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ error: \"No file uploaded\" });\n      }\n\n      const parsed = await parseCVALEPDF(req.file.buffer);\n      const vendedorId = req.body.vendedorId || req.user!.id;\n      \n      // Buscar clientes do usuário via user_client_links\n      const userClients = await storage.getClientsForUser(vendedorId, false);\n      \n      console.log(`[PDF Import] Looking for client: \"${parsed.clientName}\"`);\n      console.log(`[PDF Import] Available clients (${userClients.length}):`, userClients.map(c => c.name).join(', '));\n      \n      const matchedClient = userClients.find(c => \n        parsed.clientName && (\n          c.name.toUpperCase().includes(parsed.clientName.toUpperCase()) ||\n          parsed.clientName.toUpperCase().includes(c.name.toUpperCase())\n        )\n      );\n      \n      if (!matchedClient) {\n        console.log(`[PDF Import] No match found for \"${parsed.clientName}\"`);\n        return res.status(400).json({ \n          error: \"Cliente não encontrado no sistema\", \n          clientName: parsed.clientName,\n          suggestion: \"Cadastre o cliente antes de importar o histórico\"\n        });\n      }\n      \n      console.log(`[PDF Import] Matched client: ${matchedClient.name}`);\n      \n      const allSeasons = await storage.getAllSeasons();\n      const matchedSeason = allSeasons.find(s => \n        parsed.seasonName.includes(s.name) || \n        s.name.includes(parsed.seasonName.split(' ')[1] || '')\n      );\n      \n      const allProducts = await storage.getAllProducts();\n      const allCategories = await storage.getAllCategories();\n      const categoryIds = new Set(allCategories.map(c => c.id));\n      \n      let outrosCategory = allCategories.find(c => c.name === 'Outros');\n      if (!outrosCategory) {\n        outrosCategory = await storage.createCategory({\n          name: 'Outros',\n          type: 'outros',\n          greenCommission: '0.000',\n          greenMarginMin: '0.00',\n          yellowCommission: '0.000',\n          yellowMarginMin: '0.00',\n          yellowMarginMax: '0.00',\n          redCommission: '0.000',\n          redMarginMin: '0.00',\n          redMarginMax: '0.00',\n          belowListCommission: '0.000',\n          defaultIva: '10.00'\n        });\n      }\n      \n      const autoCreatedProducts: Array<{\n        productName: string;\n        productCode: string;\n        categoryId: string;\n        hasCategory: true;\n      }> = [];\n      \n      const uncategorizedProducts: Array<{\n        productName: string;\n        productCode: string;\n        categoryId: string;\n        hasCategory: false;\n      }> = [];\n      \n      for (const item of parsed.items) {\n        const existingProduct = allProducts.find(p => \n          p.name.toUpperCase().includes(item.productName.toUpperCase()) ||\n          item.productName.toUpperCase().includes(p.name.toUpperCase())\n        );\n        \n        if (!existingProduct) {\n          const { detectCategoryFromProductName } = await import('./parse-cvale-pdf');\n          const detectedCategoryId = detectCategoryFromProductName(item.productName);\n          \n          if (detectedCategoryId && categoryIds.has(detectedCategoryId)) {\n            const newProduct = await storage.createProduct({\n              name: item.productName,\n              categoryId: detectedCategoryId\n            });\n            \n            autoCreatedProducts.push({\n              productName: newProduct.name,\n              productCode: item.productCode,\n              categoryId: detectedCategoryId,\n              hasCategory: true\n            });\n            \n            allProducts.push(newProduct);\n          } else {\n            const newProduct = await storage.createProduct({\n              name: item.productName,\n              categoryId: outrosCategory.id\n            });\n            \n            uncategorizedProducts.push({\n              productName: newProduct.name,\n              productCode: item.productCode,\n              categoryId: outrosCategory.id,\n              hasCategory: false\n            });\n            \n            allProducts.push(newProduct);\n          }\n        }\n      }\n      \n      res.json({\n        clientId: matchedClient.id,\n        clientName: matchedClient.name,\n        seasonId: matchedSeason?.id || null,\n        seasonName: parsed.seasonName,\n        totalAmount: parsed.totalAmount,\n        itemsCount: parsed.items.length,\n        items: parsed.items,\n        fileName: req.file.originalname,\n        autoCreatedProducts,\n        uncategorizedProducts\n      });\n    } catch (error) {\n      console.error(\"PDF parse error:\", error);\n      res.status(500).json({ error: \"Failed to parse PDF\" });\n    }\n  });\n\n  app.post(\"/api/purchase-history\", requireAuth, async (req, res) => {\n    try {\n      const vendedorId = req.body.vendedorId || req.user!.id;\n      const { items, ...historyData } = req.body;\n      \n      const validatedHistory = insertPurchaseHistorySchema.parse({\n        ...historyData,\n        userId: vendedorId\n      });\n      \n      const history = await storage.createPurchaseHistory(validatedHistory);\n      \n      for (const item of items) {\n        const validatedItem = insertPurchaseHistoryItemSchema.parse({\n          ...item,\n          purchaseHistoryId: history.id,\n          purchaseDate: new Date(item.purchaseDate)\n        });\n        \n        await storage.createPurchaseHistoryItem(validatedItem);\n      }\n      \n      res.status(201).json(history);\n    } catch (error) {\n      console.error(\"Error creating purchase history:\", error);\n      res.status(400).json({ error: \"Failed to create purchase history\" });\n    }\n  });\n\n  app.get(\"/api/purchase-history\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const { clientId, seasonId } = req.query;\n      \n      const histories = await storage.getPurchaseHistories(\n        userId,\n        clientId as string | undefined,\n        seasonId as string | undefined\n      );\n      \n      res.json(histories);\n    } catch (error) {\n      console.error(\"Error fetching purchase histories:\", error);\n      res.status(500).json({ error: \"Failed to fetch purchase histories\" });\n    }\n  });\n\n  app.get(\"/api/clients/:clientId/purchase-history\", requireAuth, async (req, res) => {\n    try {\n      const { clientId } = req.params;\n      const userId = req.user!.id;\n      \n      const histories = await storage.getPurchaseHistories(userId, clientId, undefined);\n      res.json(histories);\n    } catch (error) {\n      console.error(\"Error fetching client purchase histories:\", error);\n      res.status(500).json({ error: \"Failed to fetch purchase histories\" });\n    }\n  });\n\n  app.get(\"/api/purchase-history/:id/items\", requireAuth, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const userId = req.user!.id;\n      \n      const history = await storage.getPurchaseHistory(id, userId);\n      if (!history) {\n        return res.status(404).json({ error: \"Purchase history not found\" });\n      }\n      \n      const items = await storage.getPurchaseHistoryItems(id);\n      res.json(items);\n    } catch (error) {\n      console.error(\"Error fetching purchase history items:\", error);\n      res.status(500).json({ error: \"Failed to fetch items\" });\n    }\n  });\n\n  app.get(\"/api/purchase-history/:id/opportunities\", requireAuth, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { seasonId } = req.query;\n      const userId = req.user!.id;\n      \n      const history = await storage.getPurchaseHistory(id, userId);\n      if (!history) {\n        return res.status(404).json({ error: \"Purchase history not found\" });\n      }\n      \n      const historyItems = await storage.getPurchaseHistoryItems(id);\n      \n      const allSales = await storage.getAllSales();\n      const clientSales = allSales.filter(s => s.userId === userId && s.clientId === history.clientId);\n      \n      const comparisonSeasonId = seasonId as string || history.seasonId;\n      const currentSeasonSales = comparisonSeasonId\n        ? clientSales.filter(s => s.seasonId === comparisonSeasonId)\n        : clientSales;\n      \n      const allProducts = await storage.getAllProducts();\n      const allCategories = await storage.getAllCategories();\n      const productMap = new Map(allProducts.map(p => [p.id, p]));\n      const categoryMap = new Map(allCategories.map(c => [c.id, c]));\n      \n      const outrosCategory = allCategories.find(c => c.name === 'Outros');\n      const outrosCategoryId = outrosCategory?.id || 'uncategorized';\n      \n      const findProductAndCategory = (historyItemName: string) => {\n        const matchedProduct = allProducts.find(p => \n          p.name.toUpperCase() === historyItemName.toUpperCase() ||\n          p.name.toUpperCase().includes(historyItemName.toUpperCase()) ||\n          historyItemName.toUpperCase().includes(p.name.toUpperCase())\n        );\n        return {\n          categoryId: matchedProduct ? matchedProduct.categoryId : outrosCategoryId,\n          segment: matchedProduct?.segment || null,\n          subcategoryId: matchedProduct?.subcategoryId || null\n        };\n      };\n      \n      const groupedByCategory: Record<string, {\n        categoryId: string;\n        categoryName: string;\n        historicalProducts: any[];\n        currentSeasonProducts: any[];\n      }> = {};\n      \n      historyItems.forEach(item => {\n        const { categoryId, segment, subcategoryId } = findProductAndCategory(item.productName);\n        const categoryName = categoryMap.get(categoryId)?.name || 'Não Categorizado';\n        \n        if (!groupedByCategory[categoryId]) {\n          groupedByCategory[categoryId] = {\n            categoryId,\n            categoryName,\n            historicalProducts: [],\n            currentSeasonProducts: []\n          };\n        }\n        \n        groupedByCategory[categoryId].historicalProducts.push({\n          productCode: item.productCode,\n          productName: item.productName,\n          packageType: item.packageType,\n          quantity: parseFloat(item.quantity.toString()),\n          unitPrice: parseFloat(item.unitPrice.toString()),\n          totalPrice: parseFloat(item.totalPrice.toString()),\n          purchaseDate: item.purchaseDate,\n          segment: segment,\n          subcategoryId: subcategoryId\n        });\n      });\n      \n      currentSeasonSales.forEach(sale => {\n        const product = productMap.get(sale.productId);\n        if (!product) return;\n        \n        const categoryId = product.categoryId;\n        const categoryName = categoryMap.get(categoryId)?.name || 'Não Categorizado';\n        \n        if (!groupedByCategory[categoryId]) {\n          groupedByCategory[categoryId] = {\n            categoryId,\n            categoryName,\n            historicalProducts: [],\n            currentSeasonProducts: []\n          };\n        }\n        \n        const quantity = sale.quantity ? parseFloat(sale.quantity.toString()) : 0;\n        const totalAmount = parseFloat(sale.totalAmount.toString());\n        const unitPrice = quantity > 0 ? totalAmount / quantity : totalAmount;\n        \n        groupedByCategory[categoryId].currentSeasonProducts.push({\n          productId: product.id,\n          productName: product.name,\n          quantity,\n          unitPrice,\n          totalPrice: totalAmount,\n          saleDate: sale.saleDate,\n          segment: product.segment || null,\n          subcategoryId: product.subcategoryId || null\n        });\n      });\n      \n      const categoriesData = Object.values(groupedByCategory).sort((a, b) => \n        a.categoryName.localeCompare(b.categoryName)\n      );\n      \n      const monthlyTimeline = Array.from({ length: 12 }, (_, i) => {\n        const month = i + 1;\n        const monthItems = historyItems.filter(item => \n          new Date(item.purchaseDate).getMonth() === i\n        );\n        \n        return {\n          month,\n          monthName: new Date(2000, i, 1).toLocaleDateString('pt-BR', { month: 'short' }),\n          hasPurchases: monthItems.length > 0,\n          itemCount: monthItems.length,\n          totalValue: monthItems.reduce((sum, item) => \n            sum + parseFloat(item.totalPrice.toString()), 0\n          ),\n          isCurrentMonth: new Date().getMonth() === i\n        };\n      });\n      \n      const currentSeasonMonthlyTimeline = Array.from({ length: 12 }, (_, i) => {\n        const month = i + 1;\n        const monthSales = currentSeasonSales.filter(sale => \n          new Date(sale.saleDate).getMonth() === i\n        );\n        \n        return {\n          month,\n          monthName: new Date(2000, i, 1).toLocaleDateString('pt-BR', { month: 'short' }),\n          hasPurchases: monthSales.length > 0,\n          itemCount: monthSales.length,\n          totalValue: monthSales.reduce((sum, sale) => \n            sum + parseFloat(sale.totalAmount.toString()), 0\n          ),\n          isCurrentMonth: new Date().getMonth() === i\n        };\n      });\n      \n      const totalSoldProducts = currentSeasonSales.length;\n      const totalHistoricalProducts = historyItems.length;\n      \n      const summary = {\n        totalHistoricalProducts,\n        totalSoldThisSeason: totalSoldProducts,\n        conversionRate: totalHistoricalProducts > 0 \n          ? ((totalSoldProducts / totalHistoricalProducts) * 100).toFixed(1)\n          : '0'\n      };\n      \n      let comparisonSeasonName = 'Safra Atual';\n      if (comparisonSeasonId) {\n        const allSeasons = await storage.getAllSeasons();\n        const comparisonSeason = allSeasons.find(s => s.id === comparisonSeasonId);\n        if (comparisonSeason) {\n          comparisonSeasonName = comparisonSeason.name;\n        }\n      }\n      \n      res.json({\n        clientId: history.clientId,\n        seasonName: comparisonSeasonName,\n        historicalSeasonName: history.seasonName,\n        categoriesData,\n        monthlyTimeline,\n        currentSeasonMonthlyTimeline,\n        summary\n      });\n    } catch (error) {\n      console.error(\"Error fetching opportunities:\", error);\n      res.status(500).json({ error: \"Failed to fetch opportunities\" });\n    }\n  });\n\n  app.delete(\"/api/purchase-history/:id\", requireAuth, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const userId = req.user!.id;\n      \n      const success = await storage.deletePurchaseHistory(id, userId);\n      if (!success) {\n        return res.status(404).json({ error: \"Purchase history not found\" });\n      }\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting purchase history:\", error);\n      res.status(500).json({ error: \"Failed to delete purchase history\" });\n    }\n  });\n\n  // Admin routes\n  app.get(\"/api/admin/users\", requireSuperAdmin, async (req, res) => {\n    try {\n      const users = await storage.getAllUsers();\n      res.json(users.map(u => ({ ...u, password: undefined })));\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch users\" });\n    }\n  });\n\n  app.get(\"/api/admin/vendedores\", requireSuperAdmin, async (req, res) => {\n    try {\n      const users = await storage.getAllUsers();\n      const vendedores = users.filter(u => u.role !== 'administrador');\n      res.json(vendedores.map(u => ({ \n        id: u.id, \n        username: u.username, \n        name: u.name,\n        role: u.role \n      })));\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch vendedores\" });\n    }\n  });\n\n  app.get(\"/api/admin/user-client-links\", requireSuperAdmin, async (req, res) => {\n    try {\n      const links = await db\n        .select({\n          id: userClientLinks.id,\n          userId: userClientLinks.userId,\n          masterClientId: userClientLinks.masterClientId,\n          customName: userClientLinks.customName,\n          isTop80_20: userClientLinks.isTop80_20,\n          masterClient: {\n            id: masterClients.id,\n            name: masterClients.name,\n            regionId: masterClients.regionId,\n            plantingArea: masterClients.plantingArea,\n          }\n        })\n        .from(userClientLinks)\n        .leftJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id));\n      \n      res.json(links);\n    } catch (error) {\n      console.error(\"Error fetching user client links:\", error);\n      res.status(500).json({ error: \"Failed to fetch user client links\" });\n    }\n  });\n\n  app.delete(\"/api/admin/user-client-links/user/:userId\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { userId } = req.params;\n      \n      // Deletar todos os user_client_links do usuário\n      await db.delete(userClientLinks)\n        .where(eq(userClientLinks.userId, userId));\n      \n      res.json({ success: true, message: \"Clientes do consultor excluídos com sucesso\" });\n    } catch (error) {\n      console.error(\"Error deleting user client links:\", error);\n      res.status(500).json({ error: \"Failed to delete user client links\" });\n    }\n  });\n\n  app.patch(\"/api/admin/users/:id\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { role, name, managerId } = req.body;\n      const updated = await storage.updateUser(req.params.id, { role, name, managerId });\n      if (!updated) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      res.json({ ...updated, password: undefined });\n    } catch (error) {\n      res.status(400).json({ error: \"Failed to update user\" });\n    }\n  });\n\n  app.get(\"/api/admin/users/:id/data-check\", requireSuperAdmin, async (req, res) => {\n    try {\n      const userId = req.params.id;\n      \n      const clientsCount = await db.select({ count: sql<number>`count(*)` })\n        .from(clients)\n        .where(eq(clients.userId, userId));\n      \n      const salesCount = await db.select({ count: sql<number>`count(*)` })\n        .from(sales)\n        .where(eq(sales.userId, userId));\n      \n      const goalsCount = await db.select({ count: sql<number>`count(*)` })\n        .from(seasonGoals)\n        .where(eq(seasonGoals.userId, userId));\n      \n      const marketRatesCount = await db.select({ count: sql<number>`count(*)` })\n        .from(clientMarketRates)\n        .where(eq(clientMarketRates.userId, userId));\n      \n      const externalPurchasesCount = await db.select({ count: sql<number>`count(*)` })\n        .from(externalPurchases)\n        .where(eq(externalPurchases.userId, userId));\n      \n      const purchaseHistoryCount = await db.select({ count: sql<number>`count(*)` })\n        .from(purchaseHistory)\n        .where(eq(purchaseHistory.userId, userId));\n      \n      const marketBenchmarksCount = await db.select({ count: sql<number>`count(*)` })\n        .from(marketBenchmarks)\n        .where(eq(marketBenchmarks.userId, userId));\n\n      res.json({\n        hasData: (\n          Number(clientsCount[0]?.count || 0) > 0 ||\n          Number(salesCount[0]?.count || 0) > 0 ||\n          Number(goalsCount[0]?.count || 0) > 0 ||\n          Number(marketRatesCount[0]?.count || 0) > 0 ||\n          Number(externalPurchasesCount[0]?.count || 0) > 0 ||\n          Number(purchaseHistoryCount[0]?.count || 0) > 0 ||\n          Number(marketBenchmarksCount[0]?.count || 0) > 0\n        ),\n        data: {\n          clients: Number(clientsCount[0]?.count || 0),\n          sales: Number(salesCount[0]?.count || 0),\n          goals: Number(goalsCount[0]?.count || 0),\n          marketRates: Number(marketRatesCount[0]?.count || 0),\n          externalPurchases: Number(externalPurchasesCount[0]?.count || 0),\n          purchaseHistory: Number(purchaseHistoryCount[0]?.count || 0),\n          marketBenchmarks: Number(marketBenchmarksCount[0]?.count || 0)\n        }\n      });\n    } catch (error) {\n      console.error(\"Error checking user data:\", error);\n      res.status(500).json({ error: \"Failed to check user data\" });\n    }\n  });\n\n  app.delete(\"/api/admin/users/:id\", requireSuperAdmin, async (req, res) => {\n    try {\n      const userId = req.params.id;\n      const confirmed = req.query.confirmed === 'true';\n      \n      if (!confirmed) {\n        return res.status(400).json({ error: \"Deletion must be confirmed\" });\n      }\n\n      // Delete in cascade order (children first, then parent)\n      await db.delete(purchaseHistory).where(eq(purchaseHistory.userId, userId));\n      await db.delete(externalPurchases).where(eq(externalPurchases.userId, userId));\n      await db.delete(marketBenchmarks).where(eq(marketBenchmarks.userId, userId));\n      await db.delete(clientMarketRates).where(eq(clientMarketRates.userId, userId));\n      await db.delete(seasonGoals).where(eq(seasonGoals.userId, userId));\n      await db.delete(sales).where(eq(sales.userId, userId));\n      await db.delete(clients).where(eq(clients.userId, userId));\n      \n      const success = await storage.deleteUser(userId);\n      if (!success) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting user:\", error);\n      res.status(400).json({ error: \"Failed to delete user\" });\n    }\n  });\n\n  app.post(\"/api/admin/categories\", requireSuperAdmin, async (req, res) => {\n    try {\n      const category = insertCategorySchema.parse(req.body);\n      const newCategory = await storage.createCategory(category);\n      res.status(201).json(newCategory);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid category data\" });\n    }\n  });\n\n  app.patch(\"/api/admin/categories/:id\", requireSuperAdmin, async (req, res) => {\n    try {\n      const updated = await storage.updateCategory(req.params.id, req.body);\n      if (!updated) {\n        return res.status(404).json({ error: \"Category not found\" });\n      }\n      res.json(updated);\n    } catch (error) {\n      res.status(400).json({ error: \"Failed to update category\" });\n    }\n  });\n\n  app.post(\"/api/admin/subcategories\", requireSuperAdmin, async (req, res) => {\n    try {\n      const newSub = await db.insert(subcategories).values(req.body).returning();\n      res.status(201).json(newSub[0]);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid subcategory data\" });\n    }\n  });\n\n  app.patch(\"/api/admin/subcategories/:id\", requireSuperAdmin, async (req, res) => {\n    try {\n      const updated = await db.update(subcategories)\n        .set(req.body)\n        .where(eq(subcategories.id, req.params.id))\n        .returning();\n      \n      if (!updated.length) {\n        return res.status(404).json({ error: \"Subcategory not found\" });\n      }\n      res.json(updated[0]);\n    } catch (error) {\n      res.status(400).json({ error: \"Failed to update subcategory\" });\n    }\n  });\n\n  app.post(\"/api/admin/products\", requireSuperAdmin, async (req, res) => {\n    try {\n      const product = insertProductSchema.parse(req.body);\n      const newProduct = await storage.createProduct(product);\n      res.status(201).json(newProduct);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid product data\" });\n    }\n  });\n\n  app.patch(\"/api/admin/products/:id\", requireSuperAdmin, async (req, res) => {\n    try {\n      const updated = await storage.updateProduct(req.params.id, req.body);\n      if (!updated) {\n        return res.status(404).json({ error: \"Product not found\" });\n      }\n      res.json(updated);\n    } catch (error) {\n      res.status(400).json({ error: \"Failed to update product\" });\n    }\n  });\n\n  app.post(\"/api/admin/products/auto-classify\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { classifyProductsBatch } = await import(\"./product-classifier\");\n      \n      const products = await storage.getAllProducts();\n      const agroquimicosProducts = products.filter(p => p.categoryId === 'cat-agroquimicos' && !p.subcategoryId);\n      \n      const classifications = classifyProductsBatch(agroquimicosProducts);\n      \n      let updatedCount = 0;\n      for (const classification of classifications) {\n        const updated = await storage.updateProduct(classification.id, {\n          subcategoryId: classification.subcategoryId\n        });\n        if (updated) {\n          updatedCount++;\n        }\n      }\n      \n      res.json({\n        success: true,\n        totalProducts: agroquimicosProducts.length,\n        classified: updatedCount,\n        details: classifications\n      });\n    } catch (error) {\n      console.error(\"Error auto-classifying products:\", error);\n      res.status(500).json({ error: \"Failed to auto-classify products\" });\n    }\n  });\n\n  app.post(\"/api/admin/sales/sync-categories\", requireSuperAdmin, async (req, res) => {\n    try {\n      // Get all sales and products\n      const allSales = await storage.getAllSales();\n      const products = await storage.getAllProducts();\n      \n      // Create a map of productId -> current categoryId\n      const productCategoryMap = new Map(\n        products.map(p => [p.id, p.categoryId])\n      );\n      \n      let updatedCount = 0;\n      let notFoundCount = 0;\n      \n      // Update each sale's category to match current product category\n      for (const sale of allSales) {\n        const currentCategory = productCategoryMap.get(sale.productId);\n        \n        if (!currentCategory) {\n          notFoundCount++;\n          continue;\n        }\n        \n        if (sale.categoryId !== currentCategory) {\n          await db.update(sales)\n            .set({ categoryId: currentCategory })\n            .where(eq(sales.id, sale.id));\n          updatedCount++;\n        }\n      }\n      \n      res.json({\n        success: true,\n        totalSales: allSales.length,\n        updated: updatedCount,\n        productsNotFound: notFoundCount,\n        message: `${updatedCount} vendas atualizadas com as categorias atuais dos produtos`\n      });\n    } catch (error) {\n      console.error(\"Error syncing sale categories:\", error);\n      res.status(500).json({ error: \"Failed to sync sale categories\" });\n    }\n  });\n\n  // Timac Settings - Public endpoint for all authenticated users\n  app.get(\"/api/timac-settings\", requireAuth, async (req, res) => {\n    try {\n      const { timacSettings } = await import(\"@shared/schema\");\n      const settings = await db.select().from(timacSettings).limit(1);\n      \n      // If no settings exist, return defaults\n      if (!settings.length) {\n        return res.json({\n          consultorValue: \"0.76\",\n          gerentesValue: \"0.76\",\n          faturistasValue: \"0.76\"\n        });\n      }\n      \n      res.json(settings[0]);\n    } catch (error) {\n      console.error(\"Error fetching Timac settings:\", error);\n      res.status(500).json({ error: \"Failed to fetch Timac settings\" });\n    }\n  });\n\n  // Timac Settings Management (Super Admin only)\n  app.get(\"/api/admin/timac-settings\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { timacSettings } = await import(\"@shared/schema\");\n      const settings = await db.select().from(timacSettings).limit(1);\n      \n      // If no settings exist, return defaults\n      if (!settings.length) {\n        return res.json({\n          consultorValue: \"0.76\",\n          gerentesValue: \"0.76\",\n          faturistasValue: \"0.76\"\n        });\n      }\n      \n      res.json(settings[0]);\n    } catch (error) {\n      console.error(\"Error fetching Timac settings:\", error);\n      res.status(500).json({ error: \"Failed to fetch Timac settings\" });\n    }\n  });\n\n  app.put(\"/api/admin/timac-settings\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { timacSettings, insertTimacSettingsSchema } = await import(\"@shared/schema\");\n      \n      // Validate request body\n      const data = insertTimacSettingsSchema.parse({\n        consultorValue: String(req.body.consultorValue),\n        gerentesValue: String(req.body.gerentesValue),\n        faturistasValue: String(req.body.faturistasValue)\n      });\n      \n      // Check if settings exist\n      const existing = await db.select().from(timacSettings).limit(1);\n      \n      if (existing.length) {\n        // Update existing\n        const updated = await db.update(timacSettings)\n          .set({\n            consultorValue: data.consultorValue,\n            gerentesValue: data.gerentesValue,\n            faturistasValue: data.faturistasValue,\n            updatedAt: new Date()\n          })\n          .where(eq(timacSettings.id, existing[0].id))\n          .returning();\n        res.json(updated[0]);\n      } else {\n        // Insert new\n        const created = await db.insert(timacSettings)\n          .values(data)\n          .returning();\n        res.json(created[0]);\n      }\n    } catch (error) {\n      console.error(\"Error updating Timac settings:\", error);\n      res.status(500).json({ error: \"Failed to update Timac settings\" });\n    }\n  });\n\n  app.patch(\"/api/admin/products/:id/timac-points\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { products } = await import(\"@shared/schema\");\n      const { timacPoints } = req.body;\n      \n      // Convert to string for decimal field\n      const pointsValue = String(timacPoints || \"0\");\n      \n      const updated = await db.update(products)\n        .set({ timacPoints: pointsValue })\n        .where(eq(products.id, req.params.id))\n        .returning();\n      \n      if (!updated.length) {\n        return res.status(404).json({ error: \"Product not found\" });\n      }\n      \n      res.json(updated[0]);\n    } catch (error) {\n      console.error(\"Error updating product Timac points:\", error);\n      res.status(500).json({ error: \"Failed to update product Timac points\" });\n    }\n  });\n\n  // Master Clients Management (Super Admin only)\n  app.get(\"/api/admin/master-clients\", requireSuperAdmin, async (req, res) => {\n    try {\n      const clients = await storage.getAllMasterClients();\n      res.json(clients);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch master clients\" });\n    }\n  });\n\n  app.get(\"/api/admin/master-clients/:id\", requireSuperAdmin, async (req, res) => {\n    try {\n      const client = await storage.getMasterClient(req.params.id);\n      if (!client) {\n        return res.status(404).json({ error: \"Master client not found\" });\n      }\n      res.json(client);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch master client\" });\n    }\n  });\n\n  app.post(\"/api/admin/master-clients\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { insertMasterClientSchema } = await import(\"@shared/schema\");\n      const clientData = insertMasterClientSchema.parse(req.body);\n      const newClient = await storage.createMasterClient(clientData);\n      res.status(201).json(newClient);\n    } catch (error) {\n      res.status(400).json({ error: \"Invalid master client data\" });\n    }\n  });\n\n  // Specific routes MUST come before parameterized routes to avoid conflicts\n  app.post(\"/api/admin/master-clients/merge\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { sourceId, targetId } = req.body;\n      if (!sourceId || !targetId) {\n        return res.status(400).json({ error: \"sourceId and targetId are required\" });\n      }\n      await storage.mergeMasterClients(sourceId, targetId);\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to merge master clients\" });\n    }\n  });\n\n  app.delete(\"/api/admin/master-clients/delete-all\", requireSuperAdmin, async (req, res) => {\n    try {\n      // Execute in transaction to ensure atomicity\n      await db.transaction(async (tx) => {\n        // 1. Delete deepest level dependencies first\n        await tx.delete(barterSimulationItems); // references barter_simulations\n        await tx.delete(purchaseHistoryItems); // references purchase_history\n        \n        // 2. Delete barter simulations (references user_client_links)\n        await tx.delete(barterSimulations);\n        \n        // 3. Delete all data that references user_client_links\n        await tx.delete(sales);\n        await tx.delete(seasonGoals);\n        await tx.delete(clientMarketRates);\n        await tx.delete(externalPurchases);\n        await tx.delete(purchaseHistory);\n        await tx.delete(marketBenchmarks);\n        await tx.delete(salesHistory);\n        await tx.delete(clientFamilyRelations);\n        \n        // 4. Delete all user client links (references master_clients)\n        await tx.delete(userClientLinks);\n        \n        // 5. Finally, delete all master clients\n        await tx.delete(masterClients);\n      });\n      \n      res.json({ \n        success: true, \n        message: \"Todos os clientes master e dados relacionados foram excluídos com sucesso\" \n      });\n    } catch (error) {\n      console.error('Delete all clients error:', error);\n      res.status(500).json({ error: \"Failed to delete all clients\" });\n    }\n  });\n\n  // Parameterized routes MUST come after specific routes\n  app.patch(\"/api/admin/master-clients/:id\", requireSuperAdmin, async (req, res) => {\n    try {\n      const updated = await storage.updateMasterClient(req.params.id, req.body);\n      if (!updated) {\n        return res.status(404).json({ error: \"Master client not found\" });\n      }\n      res.json(updated);\n    } catch (error) {\n      res.status(400).json({ error: \"Failed to update master client\" });\n    }\n  });\n\n  app.delete(\"/api/admin/master-clients/:id\", requireSuperAdmin, async (req, res) => {\n    try {\n      const deleted = await storage.deleteMasterClient(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Master client not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete master client\" });\n    }\n  });\n\n  app.post(\"/api/admin/migrate-clients\", requireSuperAdmin, async (req, res) => {\n    try {\n      const oldClients = await storage.getAllClients();\n      const normalizeClientName = (name: string) => {\n        return name.toUpperCase().trim().replace(/[.,\\-\\s]/g, '');\n      };\n\n      const clientsByName = new Map<string, any[]>();\n      for (const client of oldClients) {\n        const normalized = normalizeClientName(client.name);\n        if (!clientsByName.has(normalized)) {\n          clientsByName.set(normalized, []);\n        }\n        clientsByName.get(normalized)!.push(client);\n      }\n\n      let masterClientsCreated = 0;\n      let linksCreated = 0;\n\n      for (const [normalizedName, clientGroup] of Array.from(clientsByName.entries())) {\n        const firstClient = clientGroup[0];\n        \n        let masterClient = await storage.findMasterClientByName(firstClient.name);\n        if (!masterClient) {\n          masterClient = await storage.createMasterClient({\n            name: firstClient.name,\n            regionId: firstClient.regionId,\n            plantingArea: firstClient.plantingArea,\n            cultures: firstClient.cultures || [],\n            isActive: true\n          });\n          masterClientsCreated++;\n        }\n\n        for (const client of clientGroup) {\n          if (!client.userId) continue;\n\n          const existingLink = await storage.getUserClientLink(client.userId, masterClient.id);\n          if (!existingLink) {\n            await storage.createUserClientLink({\n              userId: client.userId,\n              masterClientId: masterClient.id,\n              customName: null,\n              plantingArea: client.plantingArea !== firstClient.plantingArea ? client.plantingArea : null,\n              cultures: null,\n              plantingProgress: client.plantingProgress || \"0.00\",\n              isTop80_20: client.isTop80_20,\n              isActive: client.isActive\n            });\n            linksCreated++;\n          }\n        }\n      }\n\n      res.json({\n        success: true,\n        masterClientsCreated,\n        linksCreated,\n        totalOldClients: oldClients.length\n      });\n    } catch (error) {\n      console.error('Migration error:', error);\n      res.status(500).json({ error: \"Failed to migrate clients\" });\n    }\n  });\n\n  app.post(\"/api/admin/transfer-clients\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { fromUserId, toUserId } = req.body;\n      \n      if (!fromUserId || !toUserId) {\n        return res.status(400).json({ error: \"fromUserId and toUserId are required\" });\n      }\n\n      if (fromUserId === toUserId) {\n        return res.status(400).json({ error: \"Cannot transfer to the same user\" });\n      }\n\n      // Validate that both users exist and toUserId is not admin\n      const fromUser = await storage.getUser(fromUserId);\n      const toUser = await storage.getUser(toUserId);\n\n      if (!fromUser || !toUser) {\n        return res.status(404).json({ error: \"User not found\" });\n      }\n\n      if (toUser.role === 'administrador') {\n        return res.status(400).json({ error: \"Cannot transfer clients to administrator\" });\n      }\n\n      // Get all links from source user\n      const sourceLinks = await db.select()\n        .from(userClientLinks)\n        .where(eq(userClientLinks.userId, fromUserId));\n\n      // Get existing links from target user to check for duplicates\n      const targetLinks = await db.select()\n        .from(userClientLinks)\n        .where(eq(userClientLinks.userId, toUserId));\n\n      const targetMasterClientIds = new Set(targetLinks.map(l => l.masterClientId));\n      \n      let transferred = 0;\n      let skipped = 0;\n\n      for (const link of sourceLinks) {\n        if (targetMasterClientIds.has(link.masterClientId)) {\n          // Target already has this master client, delete source link\n          await db.delete(userClientLinks)\n            .where(eq(userClientLinks.id, link.id));\n          skipped++;\n        } else {\n          // Transfer the link\n          await db.update(userClientLinks)\n            .set({ userId: toUserId })\n            .where(eq(userClientLinks.id, link.id));\n          transferred++;\n        }\n      }\n\n      res.json({\n        success: true,\n        transferred,\n        skipped,\n        message: `${transferred} clientes transferidos, ${skipped} duplicados removidos`\n      });\n    } catch (error) {\n      console.error('Transfer error:', error);\n      res.status(500).json({ error: \"Failed to transfer clients\" });\n    }\n  });\n\n  // PRICE TABLE ROUTES (for product management)\n  \n  app.get(\"/api/admin/price-table\", requireSuperAdmin, async (req, res) => {\n    try {\n      const products = await db.select()\n        .from(productsPriceTable)\n        .where(eq(productsPriceTable.isActive, true))\n        .orderBy(productsPriceTable.categoria, productsPriceTable.mercaderia);\n      res.json(products);\n    } catch (error) {\n      console.error('Get price table error:', error);\n      res.status(500).json({ error: \"Failed to get price table products\" });\n    }\n  });\n\n  app.post(\"/api/admin/price-table\", requireSuperAdmin, async (req, res) => {\n    try {\n      const productData = {\n        mercaderia: req.body.mercaderia,\n        principioAtivo: req.body.principioAtivo || null,\n        categoria: req.body.categoria,\n        subcategory: req.body.subcategory || null,\n        dose: req.body.dose || null,\n        fabricante: req.body.fabricante || null,\n        precoVerde: req.body.precoVerde,\n        precoAmarela: req.body.precoAmarela,\n        precoVermelha: req.body.precoVermelha,\n        unidade: req.body.unidade || \"$/ha\",\n        isActive: true\n      };\n\n      const [newProduct] = await db.insert(productsPriceTable)\n        .values(productData)\n        .returning();\n      \n      res.json(newProduct);\n    } catch (error) {\n      console.error('Create price table product error:', error);\n      res.status(500).json({ error: \"Failed to create price table product\" });\n    }\n  });\n\n  app.patch(\"/api/admin/price-table/:id\", requireSuperAdmin, async (req, res) => {\n    try {\n      const updateData = {\n        mercaderia: req.body.mercaderia,\n        principioAtivo: req.body.principioAtivo || null,\n        categoria: req.body.categoria,\n        subcategory: req.body.subcategory || null,\n        dose: req.body.dose || null,\n        fabricante: req.body.fabricante || null,\n        precoVerde: req.body.precoVerde,\n        precoAmarela: req.body.precoAmarela,\n        precoVermelha: req.body.precoVermelha,\n        unidade: req.body.unidade || \"$/ha\",\n        updatedAt: sql`now()`\n      };\n\n      const [updated] = await db.update(productsPriceTable)\n        .set(updateData)\n        .where(eq(productsPriceTable.id, req.params.id))\n        .returning();\n\n      if (!updated) {\n        return res.status(404).json({ error: \"Product not found\" });\n      }\n\n      res.json(updated);\n    } catch (error) {\n      console.error('Update price table product error:', error);\n      res.status(500).json({ error: \"Failed to update price table product\" });\n    }\n  });\n\n  app.delete(\"/api/admin/price-table/:id\", requireSuperAdmin, async (req, res) => {\n    try {\n      // Soft delete - just mark as inactive\n      const [deleted] = await db.update(productsPriceTable)\n        .set({ isActive: false, updatedAt: sql`now()` })\n        .where(eq(productsPriceTable.id, req.params.id))\n        .returning();\n\n      if (!deleted) {\n        return res.status(404).json({ error: \"Product not found\" });\n      }\n\n      res.json({ success: true });\n    } catch (error) {\n      console.error('Delete price table product error:', error);\n      res.status(500).json({ error: \"Failed to delete price table product\" });\n    }\n  });\n\n  app.post(\"/api/admin/price-table/import\", requireSuperAdmin, upload.single('file'), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ error: \"Nenhum arquivo enviado\" });\n      }\n\n      const XLSX = await import('xlsx');\n      const workbook = XLSX.read(req.file.buffer, { type: 'buffer' });\n      const sheetName = workbook.SheetNames[0];\n      const worksheet = workbook.Sheets[sheetName];\n      const data = XLSX.utils.sheet_to_json(worksheet);\n\n      console.log('Importando planilha com', data.length, 'linhas');\n      console.log('Primeira linha:', data[0]);\n\n      let imported = 0;\n      let errors: string[] = [];\n\n      for (let i = 0; i < data.length; i++) {\n        const row = data[i] as any;\n        try {\n          // Map Excel columns to database fields\n          const productData = {\n            mercaderia: (row['Mercadería'] || row['MERCADERIA'] || row['Mercaderia'] || row['mercaderia'] || '').toString().trim(),\n            principioAtivo: (row['P.A.'] || row['P.A'] || row['PA'] || row['Principio Ativo'] || row['principio_ativo'] || '').toString().trim(),\n            categoria: ((row['CATEGORIA'] || row['Categoria'] || row['categoria'] || 'FUNGICIDAS').toString().trim()).toUpperCase(),\n            dose: (row['Dose'] || row['DOSE'] || row['dose'] || '').toString().trim(),\n            fabricante: (row['Fabricante'] || row['FABRICANTE'] || row['fabricante'] || '').toString().trim(),\n            precoVerde: (row['Verde'] || row['VERDE'] || row['verde'] || row['Preco Verde'] || '0').toString().trim(),\n            precoAmarela: (row['Amarela'] || row['AMARELA'] || row['amarela'] || row['Preco Amarela'] || '0').toString().trim(),\n            precoVermelha: (row['Vermelha'] || row['VERMELHA'] || row['vermelha'] || row['Preco Vermelha'] || '0').toString().trim(),\n            unidade: (row['UNIDADE'] || row['Unidade'] || row['unidade'] || '$/ha').toString().trim()\n          };\n\n          if (!productData.mercaderia || productData.mercaderia.trim() === '') {\n            errors.push(`Linha ${i + 1}: Mercaderia vazia ou não encontrada. Colunas disponíveis: ${Object.keys(row).join(', ')}`);\n            continue;\n          }\n\n          console.log(`Importando linha ${i + 1}:`, productData.mercaderia);\n          await db.insert(productsPriceTable).values(productData);\n          imported++;\n        } catch (error: any) {\n          console.error(`Erro na linha ${i + 1}:`, error);\n          errors.push(`Linha ${i + 1} (${row['MERCADERIA'] || row['Mercaderia'] || 'sem nome'}): ${error.message}`);\n        }\n      }\n\n      console.log(`Importação finalizada: ${imported} produtos de ${data.length} linhas`);\n      if (errors.length > 0) {\n        console.log('Erros:', errors.slice(0, 5));\n      }\n\n      res.json({\n        success: true,\n        imported,\n        totalRows: data.length,\n        errors: errors.length > 0 ? errors.slice(0, 10) : undefined\n      });\n    } catch (error) {\n      console.error('Import price table error:', error);\n      res.status(500).json({ error: \"Falha ao importar planilha\" });\n    }\n  });\n\n  // Migration endpoint to fix categoria in client_application_tracking\n  app.post(\"/api/admin/migrate-application-categories\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { clientApplicationTracking } = await import(\"@shared/schema\");\n      \n      // Map subcategories to main categories (include all variations with/without accents)\n      const subcategoryVariations = [\n        'FUNGICIDAS',\n        'INSETICIDAS',\n        'TRATAMENTO_SEMENTE',\n        'TRATAMENTO DE SEMENTE',\n        'DESSECACAO',\n        'DESSECAÇÃO'\n      ];\n      \n      let updated = 0;\n      \n      // Update each subcategory variation\n      for (const subcategory of subcategoryVariations) {\n        const result = await db.update(clientApplicationTracking)\n          .set({ categoria: 'Agroquímicos' })\n          .where(eq(clientApplicationTracking.categoria, subcategory));\n        \n        console.log(`Migrated ${subcategory} -> Agroquímicos`);\n        updated++;\n      }\n      \n      res.json({ \n        success: true, \n        message: `Migração concluída. ${updated} tipos de subcategorias processadas.`,\n        subcategories: subcategoryVariations\n      });\n    } catch (error) {\n      console.error('Migration error:', error);\n      res.status(500).json({ error: \"Falha na migração de categorias\" });\n    }\n  });\n\n  // SYSTEM SETTINGS - Configurações gerais do sistema (somente super admin)\n  \n  app.get(\"/api/admin/system-settings\", requireSuperAdmin, async (req, res) => {\n    try {\n      const [settings] = await db.select()\n        .from(systemSettings)\n        .limit(1);\n      \n      // Se não existir, criar com valores padrão\n      if (!settings) {\n        const [newSettings] = await db.insert(systemSettings)\n          .values({ allowUserRegistration: true })\n          .returning();\n        return res.json(newSettings);\n      }\n      \n      res.json(settings);\n    } catch (error) {\n      console.error('Get system settings error:', error);\n      res.status(500).json({ error: \"Failed to get system settings\" });\n    }\n  });\n\n  app.patch(\"/api/admin/system-settings\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { allowUserRegistration } = req.body;\n      \n      if (typeof allowUserRegistration !== 'boolean') {\n        return res.status(400).json({ error: \"allowUserRegistration must be a boolean\" });\n      }\n      \n      // Pegar o primeiro registro ou criar se não existir\n      const [existingSettings] = await db.select()\n        .from(systemSettings)\n        .limit(1);\n      \n      if (!existingSettings) {\n        // Criar novo registro\n        const [newSettings] = await db.insert(systemSettings)\n          .values({ allowUserRegistration })\n          .returning();\n        return res.json(newSettings);\n      }\n      \n      // Atualizar registro existente\n      const [updated] = await db.update(systemSettings)\n        .set({ allowUserRegistration, updatedAt: sql`now()` })\n        .where(eq(systemSettings.id, existingSettings.id))\n        .returning();\n      \n      res.json(updated);\n    } catch (error) {\n      console.error('Update system settings error:', error);\n      res.status(500).json({ error: \"Failed to update system settings\" });\n    }\n  });\n\n  // PUBLIC API - Check if user registration is allowed (for login page)\n  app.get(\"/api/system-settings\", async (req, res) => {\n    try {\n      const [settings] = await db.select({\n        allowUserRegistration: systemSettings.allowUserRegistration\n      })\n        .from(systemSettings)\n        .limit(1);\n      \n      // Se não existir configuração, retornar padrão (permitir cadastro)\n      res.json({\n        allowUserRegistration: settings?.allowUserRegistration ?? true\n      });\n    } catch (error) {\n      console.error('Get system settings error:', error);\n      // Em caso de erro, permitir cadastro por padrão\n      res.json({\n        allowUserRegistration: true\n      });\n    }\n  });\n\n  // PRICE TABLE PRODUCTS FOR CONSULTANTS (read-only access to products)\n  \n  app.get(\"/api/price-table-products\", requireAuth, async (req, res) => {\n    try {\n      const { categoria } = req.query;\n      \n      const whereConditions = [eq(productsPriceTable.isActive, true)];\n      if (categoria) {\n        whereConditions.push(eq(productsPriceTable.categoria, categoria as string));\n      }\n      \n      const products = await db.select()\n        .from(productsPriceTable)\n        .where(and(...whereConditions))\n        .orderBy(productsPriceTable.mercaderia);\n      \n      res.json(products);\n    } catch (error) {\n      console.error('Get price table products error:', error);\n      res.status(500).json({ error: \"Failed to get products\" });\n    }\n  });\n\n  // GLOBAL MANAGEMENT APPLICATIONS ROUTES (Consultant's crop management plan)\n  \n  app.get(\"/api/global-management\", requireAuth, async (req, res) => {\n    try {\n      const seasonId = req.query.seasonId as string | undefined;\n      \n      if (!seasonId) {\n        return res.status(400).json({ error: \"Season ID is required\" });\n      }\n      \n      // GLOBAL applications - fetch ALL for the season (not filtered by user)\n      const applications = await db.select()\n        .from(globalManagementApplications)\n        .leftJoin(productsPriceTable, eq(globalManagementApplications.productId, productsPriceTable.id))\n        .where(eq(globalManagementApplications.seasonId, seasonId))\n        .orderBy(globalManagementApplications.categoria, globalManagementApplications.applicationNumber);\n      \n      // Transform to include product details\n      const result = applications.map(app => ({\n        ...app.global_management_applications,\n        product: app.products_price_table\n      }));\n      \n      res.json(result);\n    } catch (error) {\n      console.error('Get global management error:', error);\n      res.status(500).json({ error: \"Failed to get global management applications\" });\n    }\n  });\n\n  app.post(\"/api/global-management\", requireAuth, async (req, res) => {\n    try {\n      // Only managers can configure global management\n      if (req.user!.role !== 'gerente') {\n        return res.status(403).json({ error: \"Apenas gerentes podem configurar manejo global\" });\n      }\n\n      const { categoria, applicationNumber, productId, priceTier, seasonId } = req.body;\n      \n      if (!seasonId) {\n        return res.status(400).json({ error: \"Season ID is required\" });\n      }\n      \n      // Get product to extract price\n      const [product] = await db.select()\n        .from(productsPriceTable)\n        .where(eq(productsPriceTable.id, productId))\n        .limit(1);\n      \n      if (!product) {\n        return res.status(404).json({ error: \"Product not found\" });\n      }\n      \n      // Get price based on tier and calculate cost per hectare (price × dose)\n      let basePrice = \"0.00\";\n      if (priceTier === \"verde\") basePrice = product.precoVerde;\n      else if (priceTier === \"amarela\") basePrice = product.precoAmarela;\n      else if (priceTier === \"vermelha\") basePrice = product.precoVermelha;\n      \n      // Extract numeric dose from text (handles \"2ml/Kg\", \"0,5ml/Kg\", etc.)\n      let dose = 1;\n      if (product.dose) {\n        const doseStr = product.dose.toString().replace(',', '.'); // Replace comma with dot\n        const doseMatch = doseStr.match(/[\\d.]+/); // Extract first number\n        if (doseMatch) {\n          dose = parseFloat(doseMatch[0]);\n        }\n      }\n      \n      const pricePerHa = (parseFloat(basePrice) * dose).toFixed(2);\n      \n      // GLOBAL application - shared across all consultants in the team\n      const [newApp] = await db.insert(globalManagementApplications)\n        .values({\n          seasonId,\n          categoria,\n          applicationNumber,\n          productId,\n          priceTier,\n          pricePerHa\n        })\n        .returning();\n      \n      res.json(newApp);\n    } catch (error) {\n      console.error('Create global management error:', error);\n      res.status(500).json({ error: \"Failed to create global management application\" });\n    }\n  });\n\n  app.delete(\"/api/global-management/:id\", requireAuth, async (req, res) => {\n    try {\n      // Only managers can delete global management applications\n      if (req.user!.role !== 'gerente') {\n        return res.status(403).json({ error: \"Apenas gerentes podem excluir aplicações de manejo\" });\n      }\n\n      const [deleted] = await db.delete(globalManagementApplications)\n        .where(eq(globalManagementApplications.id, req.params.id))\n        .returning();\n      \n      if (!deleted) {\n        return res.status(404).json({ error: \"Application not found\" });\n      }\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error('Delete global management error:', error);\n      res.status(500).json({ error: \"Failed to delete global management application\" });\n    }\n  });\n\n  // CLIENT APPLICATION TRACKING ROUTES (Tracking applications per client)\n  app.get(\"/api/client-application-tracking/:clientId/:seasonId\", requireAuth, async (req, res) => {\n    try {\n      const userId = (req.user as any).id;\n      const { clientId, seasonId } = req.params;\n      \n      const trackingRecords = await db.select()\n        .from(clientApplicationTracking)\n        .leftJoin(globalManagementApplications, eq(clientApplicationTracking.globalApplicationId, globalManagementApplications.id))\n        .leftJoin(productsPriceTable, eq(globalManagementApplications.productId, productsPriceTable.id))\n        .where(\n          and(\n            eq(clientApplicationTracking.userId, userId),\n            eq(clientApplicationTracking.clientId, clientId),\n            eq(clientApplicationTracking.seasonId, seasonId)\n          )\n        )\n        .orderBy(clientApplicationTracking.categoria, clientApplicationTracking.applicationNumber);\n      \n      const result = trackingRecords.map(record => ({\n        ...record.client_application_tracking,\n        globalApplication: record.global_management_applications,\n        product: record.products_price_table\n      }));\n      \n      res.json(result);\n    } catch (error) {\n      console.error('Get client application tracking error:', error);\n      res.status(500).json({ error: \"Failed to get client application tracking\" });\n    }\n  });\n\n  app.post(\"/api/client-application-tracking\", requireAuth, async (req, res) => {\n    try {\n      const userId = (req.user as any).id;\n      const trackingData = insertClientApplicationTrackingSchema.parse({\n        ...req.body,\n        userId\n      });\n      \n      // UPSERT: Insert ou Update se já existir (baseado na unique constraint)\n      const [newTracking] = await db.insert(clientApplicationTracking)\n        .values(trackingData)\n        .onConflictDoUpdate({\n          target: [\n            clientApplicationTracking.clientId,\n            clientApplicationTracking.seasonId,\n            clientApplicationTracking.globalApplicationId\n          ],\n          set: {\n            status: trackingData.status,\n            isLostToCompetitor: trackingData.isLostToCompetitor,\n            soldValue: trackingData.soldValue,\n            totalValue: trackingData.totalValue,\n            updatedAt: new Date()\n          }\n        })\n        .returning();\n      \n      res.status(201).json(newTracking);\n    } catch (error) {\n      console.error('Create client application tracking error:', error);\n      res.status(500).json({ error: \"Failed to create client application tracking\" });\n    }\n  });\n\n  app.patch(\"/api/client-application-tracking/:id\", requireAuth, async (req, res) => {\n    try {\n      const userId = (req.user as any).id;\n      const { status, isLostToCompetitor, soldValue } = req.body;\n      \n      const [updated] = await db.update(clientApplicationTracking)\n        .set({\n          status: status !== undefined ? status : undefined,\n          isLostToCompetitor: isLostToCompetitor !== undefined ? isLostToCompetitor : undefined,\n          soldValue: soldValue !== undefined ? String(soldValue) : undefined,\n          updatedAt: new Date()\n        })\n        .where(\n          and(\n            eq(clientApplicationTracking.id, req.params.id),\n            eq(clientApplicationTracking.userId, userId)\n          )\n        )\n        .returning();\n      \n      if (!updated) {\n        return res.status(404).json({ error: \"Tracking record not found or unauthorized\" });\n      }\n      \n      res.json(updated);\n    } catch (error) {\n      console.error('Update client application tracking error:', error);\n      res.status(500).json({ error: \"Failed to update client application tracking\" });\n    }\n  });\n\n  // BARTER MODULE ROUTES\n  \n  // Barter Products (Super Admin only)\n  app.get(\"/api/admin/barter/products\", requireSuperAdmin, async (req, res) => {\n    try {\n      const products = await storage.getAllBarterProducts();\n      res.json(products);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch barter products\" });\n    }\n  });\n\n  app.post(\"/api/admin/barter/products\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { insertBarterProductSchema } = await import(\"@shared/schema\");\n      const productData = insertBarterProductSchema.parse(req.body);\n      const newProduct = await storage.createBarterProduct(productData);\n      res.status(201).json(newProduct);\n    } catch (error) {\n      console.error(\"Error creating barter product:\", error);\n      res.status(400).json({ error: \"Invalid barter product data\" });\n    }\n  });\n\n  app.patch(\"/api/admin/barter/products/:id\", requireSuperAdmin, async (req, res) => {\n    try {\n      console.log(\"Updating barter product:\", req.params.id, \"with data:\", req.body);\n      \n      // Convert number fields to strings for decimal type validation\n      const updateData = { ...req.body };\n      if (updateData.priceUsd !== undefined && updateData.priceUsd !== null) {\n        updateData.priceUsd = String(updateData.priceUsd);\n      }\n      if (updateData.priceVerde !== undefined && updateData.priceVerde !== null) {\n        updateData.priceVerde = String(updateData.priceVerde);\n      }\n      if (updateData.priceAmarela !== undefined && updateData.priceAmarela !== null) {\n        updateData.priceAmarela = String(updateData.priceAmarela);\n      }\n      if (updateData.priceVermelha !== undefined && updateData.priceVermelha !== null) {\n        updateData.priceVermelha = String(updateData.priceVermelha);\n      }\n\n      const updated = await storage.updateBarterProduct(req.params.id, updateData);\n      if (!updated) {\n        return res.status(404).json({ error: \"Barter product not found\" });\n      }\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating barter product:\", error);\n      res.status(400).json({ error: \"Failed to update barter product\" });\n    }\n  });\n\n  app.delete(\"/api/admin/barter/products/:id\", requireSuperAdmin, async (req, res) => {\n    try {\n      const deleted = await storage.deleteBarterProduct(req.params.id);\n      if (!deleted) {\n        return res.status(404).json({ error: \"Barter product not found\" });\n      }\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete barter product\" });\n    }\n  });\n\n  app.delete(\"/api/admin/barter/products\", requireSuperAdmin, async (req, res) => {\n    try {\n      await storage.deleteAllBarterProducts();\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting all barter products:\", error);\n      res.status(500).json({ error: \"Failed to delete all barter products\" });\n    }\n  });\n\n  // Bulk import barter products from Excel/PDF\n  app.post(\"/api/admin/barter/products/bulk-import\", requireSuperAdmin, upload.single('file'), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ error: \"No file uploaded\" });\n      }\n\n      const { parsePdfBarterProducts, parseExcelBarterProducts } = await import(\"./parse-barter-products\");\n      const { insertBarterProductSchema } = await import(\"@shared/schema\");\n\n      let parsedProducts;\n      const fileExtension = req.file.originalname.split('.').pop()?.toLowerCase();\n\n      if (fileExtension === 'pdf') {\n        parsedProducts = await parsePdfBarterProducts(req.file.buffer);\n      } else if (['xlsx', 'xls'].includes(fileExtension || '')) {\n        parsedProducts = await parseExcelBarterProducts(req.file.buffer);\n      } else {\n        return res.status(400).json({ error: \"Unsupported file format. Use PDF or Excel.\" });\n      }\n\n      // Preview mode - just return parsed products without saving\n      if (req.body.preview === 'true') {\n        return res.json({ products: parsedProducts, count: parsedProducts.length });\n      }\n\n      // Import mode - validate and save products\n      const created = [];\n      const errors = [];\n      const seasonId = req.body.seasonId || undefined;\n\n      for (const product of parsedProducts) {\n        try {\n          // Keep prices as strings for decimal type\n          const priceVerde = product.priceVerde || '0';\n          const priceAmarela = product.priceAmarela || '0';\n          const priceVermelha = product.priceVermelha || '0';\n\n          const productData = {\n            name: product.name,\n            category: product.category,\n            principioAtivo: product.principioAtivo,\n            dosePerHa: product.dosePerHa,\n            fabricante: product.fabricante,\n            unit: product.unit,\n            priceUsd: parseFloat(priceVerde) > 0 ? priceVerde : (parseFloat(priceAmarela) > 0 ? priceAmarela : priceVermelha),\n            priceVerde: parseFloat(priceVerde) > 0 ? priceVerde : undefined,\n            priceAmarela: parseFloat(priceAmarela) > 0 ? priceAmarela : undefined,\n            priceVermelha: parseFloat(priceVermelha) > 0 ? priceVermelha : undefined,\n            seasonId: seasonId,\n            isActive: true,\n          };\n\n          const validated = insertBarterProductSchema.parse(productData);\n          const newProduct = await storage.createBarterProduct(validated);\n          created.push(newProduct);\n        } catch (err: any) {\n          const errorMsg = err?.issues ? JSON.stringify(err.issues) : String(err);\n          errors.push({ product: product.name, error: errorMsg });\n        }\n      }\n\n      const result = {\n        success: true,\n        created: created.length,\n        errors: errors.length,\n        errorDetails: errors,\n      };\n      \n      console.log(`Bulk import result: ${created.length} created, ${errors.length} errors`);\n      if (errors.length > 0) {\n        console.log('First 5 errors:', errors.slice(0, 5));\n      }\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"Bulk import error:\", error);\n      res.status(500).json({ error: \"Failed to import products\" });\n    }\n  });\n\n  // Barter Settings (Super Admin only)\n  app.get(\"/api/admin/barter/settings\", requireSuperAdmin, async (req, res) => {\n    try {\n      const settings = await storage.getAllBarterSettings();\n      res.json(settings);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch barter settings\" });\n    }\n  });\n\n  app.put(\"/api/admin/barter/settings/:key\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { value, description } = req.body;\n      if (!value) {\n        return res.status(400).json({ error: \"Value is required\" });\n      }\n      const setting = await storage.upsertBarterSetting(req.params.key, value, description);\n      res.json(setting);\n    } catch (error) {\n      res.status(400).json({ error: \"Failed to update barter setting\" });\n    }\n  });\n\n  // Barter Simulations (All authenticated users)\n  app.get(\"/api/barter/simulations\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const simulations = await storage.getBarterSimulationsByUser(userId);\n      res.json(simulations);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch simulations\" });\n    }\n  });\n\n  app.get(\"/api/barter/simulations/:id\", requireAuth, async (req, res) => {\n    try {\n      const simulation = await storage.getBarterSimulation(req.params.id);\n      if (!simulation) {\n        return res.status(404).json({ error: \"Simulation not found\" });\n      }\n      if (simulation.userId !== req.user!.id) {\n        return res.status(403).json({ error: \"Forbidden\" });\n      }\n      res.json(simulation);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch simulation\" });\n    }\n  });\n\n  app.post(\"/api/barter/simulations\", requireAuth, async (req, res) => {\n    try {\n      const { insertBarterSimulationSchema } = await import(\"@shared/schema\");\n      const simulationData = {\n        ...req.body,\n        userId: req.user!.id,\n        areaHa: typeof req.body.areaHa === 'number' ? req.body.areaHa.toString() : req.body.areaHa,\n        totalUsd: typeof req.body.totalUsd === 'number' ? req.body.totalUsd.toString() : req.body.totalUsd,\n        sackPriceUsd: typeof req.body.sackPriceUsd === 'number' ? req.body.sackPriceUsd.toString() : req.body.sackPriceUsd,\n        bufferPercentage: typeof req.body.bufferPercentage === 'number' ? req.body.bufferPercentage.toString() : req.body.bufferPercentage,\n        grainQuantityKg: typeof req.body.grainQuantityKg === 'number' ? req.body.grainQuantityKg.toString() : req.body.grainQuantityKg,\n        grainQuantitySacks: typeof req.body.grainQuantitySacks === 'number' ? req.body.grainQuantitySacks.toString() : req.body.grainQuantitySacks,\n      };\n      const validatedData = insertBarterSimulationSchema.parse(simulationData);\n      \n      // Convert numeric fields to strings in items\n      const items = (req.body.items || []).map((item: any) => ({\n        ...item,\n        quantity: typeof item.quantity === 'number' ? item.quantity.toString() : item.quantity,\n        priceUsd: typeof item.priceUsd === 'number' ? item.priceUsd.toString() : item.priceUsd,\n        totalUsd: typeof item.totalUsd === 'number' ? item.totalUsd.toString() : item.totalUsd,\n      }));\n      \n      const newSimulation = await storage.createBarterSimulation(validatedData, items);\n      res.status(201).json(newSimulation);\n    } catch (error) {\n      console.error(\"Error creating simulation:\", error);\n      res.status(400).json({ error: \"Invalid simulation data\" });\n    }\n  });\n\n  app.patch(\"/api/barter/simulations/:id\", requireAuth, async (req, res) => {\n    try {\n      const simulation = await storage.getBarterSimulation(req.params.id);\n      if (!simulation) {\n        return res.status(404).json({ error: \"Simulation not found\" });\n      }\n      if (simulation.userId !== req.user!.id) {\n        return res.status(403).json({ error: \"Forbidden\" });\n      }\n      const updated = await storage.updateBarterSimulation(req.params.id, req.body);\n      res.json(updated);\n    } catch (error) {\n      res.status(400).json({ error: \"Failed to update simulation\" });\n    }\n  });\n\n  app.delete(\"/api/barter/simulations/:id\", requireAuth, async (req, res) => {\n    try {\n      const simulation = await storage.getBarterSimulation(req.params.id);\n      if (!simulation) {\n        return res.status(404).json({ error: \"Simulation not found\" });\n      }\n      if (simulation.userId !== req.user!.id) {\n        return res.status(403).json({ error: \"Forbidden\" });\n      }\n      await storage.deleteBarterSimulation(req.params.id);\n      res.json({ success: true });\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to delete simulation\" });\n    }\n  });\n\n  app.get(\"/api/barter/products\", requireAuth, async (req, res) => {\n    try {\n      const products = await storage.getAllBarterProducts();\n      const activeProducts = products.filter(p => p.isActive);\n      res.json(activeProducts);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch barter products\" });\n    }\n  });\n\n  app.get(\"/api/barter/settings\", requireAuth, async (req, res) => {\n    try {\n      const settings = await storage.getAllBarterSettings();\n      res.json(settings);\n    } catch (error) {\n      res.status(500).json({ error: \"Failed to fetch barter settings\" });\n    }\n  });\n\n  // ========== KANBAN DE METAS ROUTES ==========\n  \n  // Get Kanban data (clients with potentials, sales, opportunities)\n  app.get(\"/api/kanban-metas\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const seasonId = req.query.seasonId as string;\n      \n      if (!seasonId) {\n        return res.status(400).json({ error: \"seasonId is required\" });\n      }\n      \n      const data = await storage.getKanbanData(userId, seasonId);\n      res.json(data);\n    } catch (error) {\n      console.error(\"Error fetching kanban data:\", error);\n      res.status(500).json({ error: \"Failed to fetch kanban data\" });\n    }\n  });\n\n  // Get category cards for Market Opportunity page\n  app.get(\"/api/market-opportunity/category-cards/:seasonId\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const { seasonId } = req.params;\n      \n      // Get all categories\n      const allCategories = await db.select().from(categories);\n      \n      // Get user's clients with badge amarelo (includeInMarketArea) - for potential calculation\n      const clientsAmarelo = await db.select({\n        id: userClientLinks.id,\n        userArea: userClientLinks.plantingArea,\n        masterArea: masterClients.plantingArea\n      })\n        .from(userClientLinks)\n        .innerJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n        .where(and(\n          eq(userClientLinks.userId, userId),\n          eq(userClientLinks.includeInMarketArea, true)\n        ));\n      \n      const clientAmareloIds = clientsAmarelo.map(c => c.id);\n      \n      // Get client market rates for potential calculation (badge amarelo only)\n      const marketRates = clientAmareloIds.length > 0 \n        ? await db.select()\n            .from(clientMarketRates)\n            .where(and(\n              eq(clientMarketRates.userId, userId),\n              eq(clientMarketRates.seasonId, seasonId),\n              inArray(clientMarketRates.clientId, clientAmareloIds)\n            ))\n        : [];\n      \n      // Get ALL sales (C.Vale) for this user, regardless of badge\n      const salesData = await db.select({\n          categoryId: sales.categoryId,\n          totalAmount: sales.totalAmount\n        })\n        .from(sales)\n        .where(and(\n          eq(sales.userId, userId),\n          eq(sales.seasonId, seasonId)\n        ));\n      \n      console.log(`[MARKET-CARDS] User ${userId}: Found ${salesData.length} total sales`);\n      \n      // Get ALL FECHADO applications for this user, regardless of badge\n      const fechadoApps = await db.select({\n          categoria: clientApplicationTracking.categoria,\n          totalValue: clientApplicationTracking.totalValue\n        })\n        .from(clientApplicationTracking)\n        .where(and(\n          eq(clientApplicationTracking.userId, userId),\n          eq(clientApplicationTracking.seasonId, seasonId),\n          eq(clientApplicationTracking.status, 'FECHADO')\n        ));\n      \n      console.log(`[MARKET-CARDS] User ${userId}: Found ${fechadoApps.length} FECHADO applications`);\n      \n      // Helper to normalize category names (Agroquímicos subcategories)\n      const normalizeCategoryName = (name: string): string => {\n        const agroquimicoVariants = ['FUNGICIDAS', 'INSETICIDAS', 'DESSECAÇÃO', 'TRATAMENTO DE SEMENTE', 'TS'];\n        if (agroquimicoVariants.includes(name.toUpperCase())) {\n          return 'Agroquímicos';\n        }\n        return name;\n      };\n      \n      // Calculate data per category\n      const categoryData = new Map<string, {\n        categoryId: string;\n        categoryName: string;\n        categoryType: string;\n        potentialUsd: number;\n        potentialHa: number;\n        cvaleUsd: number;\n        fechadoUsd: number;\n      }>();\n      \n      // Initialize all categories\n      allCategories.forEach(cat => {\n        categoryData.set(cat.id, {\n          categoryId: cat.id,\n          categoryName: cat.name,\n          categoryType: cat.type,\n          potentialUsd: 0,\n          potentialHa: 0,\n          cvaleUsd: 0,\n          fechadoUsd: 0\n        });\n      });\n      \n      // Calculate potential from market rates (badge amarelo)\n      marketRates.forEach(rate => {\n        const client = clientsAmarelo.find(c => c.id === rate.clientId);\n        if (!client) return;\n        \n        const area = parseFloat(client.userArea || client.masterArea || '0');\n        const investmentPerHa = parseFloat(rate.investmentPerHa || '0');\n        const potentialValue = area * investmentPerHa;\n        \n        const catData = categoryData.get(rate.categoryId);\n        if (catData) {\n          catData.potentialUsd += potentialValue;\n          catData.potentialHa += area;\n        }\n      });\n      \n      // Calculate C.Vale from sales (badge verde)\n      salesData.forEach(sale => {\n        const catData = categoryData.get(sale.categoryId);\n        if (catData) {\n          catData.cvaleUsd += parseFloat(sale.totalAmount || '0');\n        }\n      });\n      \n      console.log('[MARKET-CARDS] Sales aggregation by category:', \n        Array.from(categoryData.values())\n          .filter(c => c.cvaleUsd > 0)\n          .map(c => `${c.categoryName}: $${c.cvaleUsd.toFixed(2)}`)\n      );\n      \n      // Calculate FECHADO from applications (badge verde)\n      fechadoApps.forEach(app => {\n        // Map application categoria to category\n        const normalizedName = normalizeCategoryName(app.categoria);\n        const category = allCategories.find(c => c.name === normalizedName || c.type === normalizedName.toLowerCase());\n        \n        if (category) {\n          const catData = categoryData.get(category.id);\n          if (catData) {\n            catData.fechadoUsd += parseFloat(app.totalValue || '0');\n          }\n        }\n      });\n      \n      // Build response with penetration calculation\n      const cards = Array.from(categoryData.values())\n        .filter(cat => cat.potentialUsd > 0 || cat.cvaleUsd > 0 || cat.fechadoUsd > 0)\n        .map(cat => {\n          const totalCapturedUsd = cat.cvaleUsd + cat.fechadoUsd;\n          const penetrationPercent = cat.potentialUsd > 0 \n            ? (totalCapturedUsd / cat.potentialUsd) * 100 \n            : 0;\n          \n          return {\n            categoryId: cat.categoryId,\n            categoryName: cat.categoryName,\n            categoryType: cat.categoryType,\n            potentialUsd: cat.potentialUsd,\n            potentialHa: cat.potentialHa,\n            cvaleUsd: cat.cvaleUsd,\n            fechadoUsd: cat.fechadoUsd,\n            totalCapturedUsd,\n            penetrationPercent: Math.min(penetrationPercent, 100)\n          };\n        });\n      \n      res.json({ cards });\n    } catch (error) {\n      console.error(\"Error fetching market opportunity category cards:\", error);\n      res.status(500).json({ error: \"Failed to fetch category cards\" });\n    }\n  });\n\n  // Update client potential for a specific category\n  app.patch(\"/api/kanban/client-potential/:clientId\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const { clientId } = req.params;\n      const { segmento, investmentPerHa, seasonId } = req.body;\n      \n      if (!segmento || investmentPerHa === undefined || !seasonId) {\n        return res.status(400).json({ error: \"segmento, investmentPerHa, and seasonId are required\" });\n      }\n\n      // Verificar se o cliente pertence ao usuário\n      const [clientLink] = await db.select()\n        .from(userClientLinks)\n        .where(and(\n          eq(userClientLinks.id, clientId),\n          eq(userClientLinks.userId, userId)\n        ))\n        .limit(1);\n\n      if (!clientLink) {\n        return res.status(403).json({ error: \"Access denied: client does not belong to user\" });\n      }\n\n      // Buscar a categoria correspondente ao segmento\n      const categoryData = await db.execute(sql`\n        SELECT id FROM categories WHERE type = ${segmento} LIMIT 1\n      `);\n\n      if (categoryData.rows.length === 0) {\n        return res.status(404).json({ error: \"Category not found for segment\" });\n      }\n\n      const categoryId = (categoryData.rows[0] as any).id;\n\n      // Verificar se já existe um registro de taxa para este cliente/categoria/safra\n      const existingRate = await db.select()\n        .from(clientMarketRates)\n        .where(and(\n          eq(clientMarketRates.userId, userId),\n          eq(clientMarketRates.clientId, clientId),\n          eq(clientMarketRates.categoryId, categoryId),\n          eq(clientMarketRates.seasonId, seasonId)\n        ))\n        .limit(1);\n\n      if (existingRate.length > 0) {\n        // Atualizar registro existente\n        const [updated] = await db.update(clientMarketRates)\n          .set({\n            investmentPerHa: investmentPerHa.toString(),\n            updatedAt: new Date()\n          })\n          .where(eq(clientMarketRates.id, existingRate[0].id))\n          .returning();\n        \n        res.json(updated);\n      } else {\n        // Criar novo registro\n        const [created] = await db.insert(clientMarketRates)\n          .values({\n            userId,\n            clientId,\n            categoryId,\n            seasonId,\n            investmentPerHa: investmentPerHa.toString()\n          })\n          .returning();\n        \n        res.json(created);\n      }\n    } catch (error) {\n      console.error(\"Error updating client potential:\", error);\n      res.status(500).json({ error: \"Failed to update client potential\" });\n    }\n  });\n\n  // Get consolidated client market data for Market Management Panel\n  app.get(\"/api/client-market-panel/:clientId/:seasonId\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const { clientId, seasonId } = req.params;\n\n      // Verify client belongs to user and get client data\n      const clientData = await db.select({\n        masterClientName: masterClients.name,\n        masterClientArea: masterClients.plantingArea,\n        userClientArea: userClientLinks.plantingArea,\n        masterClientCreditLine: masterClients.creditLine,\n        userClientLinkId: userClientLinks.id\n      })\n        .from(userClientLinks)\n        .innerJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n        .where(and(\n          eq(userClientLinks.id, clientId),\n          eq(userClientLinks.userId, userId)\n        ))\n        .limit(1);\n\n      if (clientData.length === 0) {\n        return res.status(403).json({ error: \"Access denied: client does not belong to user\" });\n      }\n\n      const client = clientData[0];\n\n      // Get current and previous season\n      const currentSeason = await db.select().from(seasons).where(eq(seasons.id, seasonId)).limit(1);\n      if (currentSeason.length === 0) {\n        return res.status(404).json({ error: \"Season not found\" });\n      }\n\n      // Get previous season (simple approach: get the season before the current one)\n      const previousSeason = await db.select()\n        .from(seasons)\n        .where(sql`${seasons.name} < ${currentSeason[0].name}`)\n        .orderBy(desc(seasons.name))\n        .limit(1);\n\n      // Get sales for current season\n      const currentSeasonSales = await db.select()\n        .from(sales)\n        .where(and(\n          eq(sales.clientId, clientId),\n          eq(sales.seasonId, seasonId),\n          eq(sales.userId, userId)\n        ));\n\n      const currentSeasonTotal = currentSeasonSales.reduce((sum, sale) => sum + parseFloat(sale.totalAmount || '0'), 0);\n\n      // Get sales for previous season\n      let previousSeasonTotal = 0;\n      if (previousSeason.length > 0) {\n        const previousSeasonSales = await db.select()\n          .from(sales)\n          .where(and(\n            eq(sales.clientId, clientId),\n            eq(sales.seasonId, previousSeason[0].id),\n            eq(sales.userId, userId)\n          ));\n        previousSeasonTotal = previousSeasonSales.reduce((sum, sale) => sum + parseFloat(sale.totalAmount || '0'), 0);\n      }\n\n      // Get potential (clientMarketRates)\n      const potentials = await storage.getClientMarketRates(clientId, userId, seasonId);\n\n      // Get market values (clientMarketValues)\n      const marketValues = await storage.getClientMarketValues(clientId, userId, seasonId);\n\n      // Get C.Vale (vendas reais) by category\n      const categoriesList = await db.select().from(categories);\n      const productsList = await db.select().from(products);\n      const productToCategory = new Map<string, string>();\n      const productToName = new Map<string, string>();\n      productsList.forEach(prod => {\n        productToCategory.set(prod.id, prod.categoryId);\n        productToName.set(prod.id, prod.name);\n      });\n\n      // Import product classifier for subcategory detection\n      const { detectSubcategory } = await import(\"./product-classifier\");\n      \n      // Map subcategory IDs to friendly names\n      const subcategoryNames: Record<string, string> = {\n        'sub-tratamento-sementes': 'Tratamento de semente',\n        'sub-dessecacao': 'Dessecação',\n        'sub-inseticidas': 'Inseticidas',\n        'sub-fungicidas': 'Fungicidas'\n      };\n\n      const cValeByCategoryId: Record<string, { total: number; subcategories?: Record<string, number> }> = {};\n      currentSeasonSales.forEach(sale => {\n        const categoryId = productToCategory.get(sale.productId);\n        const productName = productToName.get(sale.productId);\n        const saleAmount = parseFloat(sale.totalAmount || '0');\n        \n        if (categoryId) {\n          if (!cValeByCategoryId[categoryId]) {\n            cValeByCategoryId[categoryId] = { total: 0, subcategories: {} };\n          }\n          cValeByCategoryId[categoryId].total += saleAmount;\n          \n          // For Agroquímicos, also classify by subcategory\n          if (categoryId === 'cat-agroquimicos' && productName) {\n            const classification = detectSubcategory(productName);\n            if (classification) {\n              const subcategoryName = subcategoryNames[classification.subcategoryId];\n              if (subcategoryName) {\n                if (!cValeByCategoryId[categoryId].subcategories) {\n                  cValeByCategoryId[categoryId].subcategories = {};\n                }\n                cValeByCategoryId[categoryId].subcategories[subcategoryName] = \n                  (cValeByCategoryId[categoryId].subcategories[subcategoryName] || 0) + saleAmount;\n              }\n            }\n          }\n        }\n      });\n\n      // Get applications from Global Management\n      // CRITICAL: Fetch ALL global applications for the season, then LEFT JOIN with client tracking\n      const { clientApplicationTracking, globalManagementApplications, productsPriceTable } = await import(\"@shared/schema\");\n      \n      const applications = await db.select({\n        globalAppId: globalManagementApplications.id,\n        categoria: globalManagementApplications.categoria,\n        applicationNumber: globalManagementApplications.applicationNumber,\n        productName: productsPriceTable.mercaderia,\n        pricePerHa: globalManagementApplications.pricePerHa,\n        trackingId: clientApplicationTracking.id,\n        trackingStatus: clientApplicationTracking.status,\n        trackingTotalValue: clientApplicationTracking.totalValue\n      })\n        .from(globalManagementApplications)\n        .innerJoin(productsPriceTable, eq(globalManagementApplications.productId, productsPriceTable.id))\n        .leftJoin(clientApplicationTracking, and(\n          eq(clientApplicationTracking.globalApplicationId, globalManagementApplications.id),\n          eq(clientApplicationTracking.clientId, clientId),\n          eq(clientApplicationTracking.seasonId, seasonId)\n        ))\n        .where(eq(globalManagementApplications.seasonId, seasonId))\n        .orderBy(globalManagementApplications.categoria, globalManagementApplications.applicationNumber);\n\n      // GROUP products by categoria + applicationNumber (one application can have multiple products)\n      const applicationsGrouped = new Map<string, {\n        categoria: string;\n        applicationNumber: number;\n        products: Array<{\n          globalApplicationId: string;\n          productName: string;\n          pricePerHa: number;\n          totalValue: number;\n          trackingId: string | null;\n        }>;\n        status: string | null;\n      }>();\n\n      applications.forEach(app => {\n        const key = `${app.categoria}-${app.applicationNumber}`;\n        const clientArea = parseFloat(client.userClientArea || client.masterClientArea || '0');\n        const pricePerHa = parseFloat(app.pricePerHa || '0');\n        const totalValue = app.trackingTotalValue ? parseFloat(app.trackingTotalValue) : (pricePerHa * clientArea);\n\n        if (!applicationsGrouped.has(key)) {\n          applicationsGrouped.set(key, {\n            categoria: app.categoria,\n            applicationNumber: app.applicationNumber,\n            products: [],\n            status: app.trackingStatus || null\n          });\n        }\n\n        const group = applicationsGrouped.get(key)!;\n        group.products.push({\n          globalApplicationId: app.globalAppId,\n          productName: app.productName,\n          pricePerHa,\n          totalValue,\n          trackingId: app.trackingId || null\n        });\n      });\n\n      const applicationsData = Array.from(applicationsGrouped.values()).map(group => ({\n        categoria: group.categoria,\n        applicationNumber: group.applicationNumber,\n        products: group.products,\n        totalValue: group.products.reduce((sum, p) => sum + p.totalValue, 0),\n        status: group.status\n      }));\n\n      res.json({\n        season: {\n          id: currentSeason[0].id,\n          name: currentSeason[0].name\n        },\n        client: {\n          id: clientId,\n          name: client.masterClientName,\n          area: parseFloat(client.userClientArea || client.masterClientArea || '0'),\n          creditLine: client.masterClientCreditLine ? parseFloat(client.masterClientCreditLine) : null\n        },\n        sales: {\n          currentSeason: currentSeasonTotal,\n          previousSeason: previousSeasonTotal\n        },\n        potentials: potentials.map(p => ({\n          categoryId: p.categoryId,\n          investmentPerHa: parseFloat(p.investmentPerHa || '0'),\n          subcategories: p.subcategories\n        })),\n        cVale: Object.entries(cValeByCategoryId).map(([categoryId, data]) => ({\n          categoryId,\n          value: data.total,\n          subcategories: data.subcategories\n        })),\n        marketValues: marketValues.map(m => ({\n          categoryId: m.categoryId,\n          marketValue: parseFloat(m.marketValue || '0'),\n          subcategories: m.subcategories\n        })),\n        applications: applicationsData,\n        categories: categoriesList.map(cat => ({\n          id: cat.id,\n          name: cat.name,\n          type: cat.type\n        }))\n      });\n    } catch (error) {\n      console.error(\"Error fetching client market panel data:\", error);\n      res.status(500).json({ error: \"Failed to fetch client market panel data\" });\n    }\n  });\n\n  // PATCH endpoint to update market values and credit line\n  app.patch(\"/api/client-market-panel/:clientId\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const { clientId } = req.params;\n      const { creditLine, marketValues, applicationStatuses, seasonId } = req.body;\n      \n      console.log(\"PATCH /api/client-market-panel\", { clientId, userId, creditLine, seasonId });\n\n      // Verify client belongs to user and get masterClientId + area\n      const clientData = await db.select({\n        masterClientId: userClientLinks.masterClientId,\n        masterClientArea: masterClients.plantingArea,\n        userClientArea: userClientLinks.plantingArea\n      })\n        .from(userClientLinks)\n        .innerJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n        .where(and(\n          eq(userClientLinks.id, clientId),\n          eq(userClientLinks.userId, userId)\n        ))\n        .limit(1);\n\n      if (clientData.length === 0) {\n        console.log(\"Client not found or access denied\", { clientId, userId });\n        return res.status(403).json({ error: \"Access denied: client does not belong to user\" });\n      }\n\n      const { masterClientId, masterClientArea, userClientArea } = clientData[0];\n      console.log(\"Found masterClientId:\", masterClientId);\n\n      // Update credit line on master client\n      if (creditLine !== undefined) {\n        console.log(\"Updating credit line to:\", creditLine);\n        await db.update(masterClients)\n          .set({ creditLine: creditLine.toString() })\n          .where(eq(masterClients.id, masterClientId));\n        console.log(\"Credit line updated successfully\");\n      }\n\n      // Update market values\n      if (marketValues && Array.isArray(marketValues)) {\n        for (const mv of marketValues) {\n          await storage.upsertClientMarketValue({\n            clientId,\n            categoryId: mv.categoryId,\n            userId,\n            seasonId,\n            marketValue: mv.marketValue.toString(),\n            subcategories: mv.subcategories\n          });\n        }\n      }\n\n      // Update application statuses\n      // Now using categoria-applicationNumber key (e.g., \"FUNGICIDAS-2\")\n      if (applicationStatuses && Array.isArray(applicationStatuses)) {\n        const { clientApplicationTracking, globalManagementApplications } = await import(\"@shared/schema\");\n        \n        for (const appStatus of applicationStatuses) {\n          // Parse the key \"FUNGICIDAS-2\" -> categoria: FUNGICIDAS, applicationNumber: 2\n          const [categoria, appNumStr] = appStatus.id.split('-');\n          const applicationNumber = parseInt(appNumStr, 10);\n          \n          // Get all global applications for this categoria + applicationNumber\n          const globalApps = await db.select()\n            .from(globalManagementApplications)\n            .where(and(\n              eq(globalManagementApplications.seasonId, seasonId),\n              eq(globalManagementApplications.categoria, categoria),\n              eq(globalManagementApplications.applicationNumber, applicationNumber)\n            ));\n          \n          // Update or create tracking for each global application\n          for (const globalApp of globalApps) {\n            // Check if tracking exists\n            const existing = await db.select()\n              .from(clientApplicationTracking)\n              .where(and(\n                eq(clientApplicationTracking.clientId, clientId),\n                eq(clientApplicationTracking.globalApplicationId, globalApp.id)\n              ))\n              .limit(1);\n            \n            if (existing.length > 0) {\n              // Update existing\n              await db.update(clientApplicationTracking)\n                .set({ status: appStatus.status })\n                .where(eq(clientApplicationTracking.id, existing[0].id));\n            } else {\n              // Create new tracking\n              const clientArea = parseFloat(userClientArea || masterClientArea || '0');\n              const pricePerHa = parseFloat(globalApp.pricePerHa || '0');\n              const totalValue = pricePerHa * clientArea;\n              \n              // Map subcategory to main category\n              const subcategoryToCategory: Record<string, string> = {\n                'FUNGICIDAS': 'Agroquímicos',\n                'INSETICIDAS': 'Agroquímicos',\n                'TRATAMENTO_SEMENTE': 'Agroquímicos',\n                'TRATAMENTO DE SEMENTE': 'Agroquímicos',\n                'DESSECACAO': 'Agroquímicos',\n                'DESSECAÇÃO': 'Agroquímicos',\n              };\n              const mainCategoria = subcategoryToCategory[globalApp.categoria.toUpperCase()] || globalApp.categoria;\n              \n              await db.insert(clientApplicationTracking)\n                .values({\n                  userId,\n                  clientId,\n                  seasonId,\n                  globalApplicationId: globalApp.id,\n                  categoria: mainCategoria,\n                  applicationNumber: globalApp.applicationNumber,\n                  totalValue: totalValue.toString(),\n                  status: appStatus.status\n                });\n            }\n          }\n        }\n      }\n\n      console.log(\"PATCH completed successfully\");\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error updating client market panel data:\", error);\n      res.status(500).json({ error: \"Failed to update client market panel data\", details: (error as Error).message });\n    }\n  });\n\n  // Get sales targets for user\n  app.get(\"/api/sales-targets\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const seasonId = req.query.seasonId as string | undefined;\n      const targets = await storage.getSalesTargets(userId, seasonId);\n      res.json(targets);\n    } catch (error) {\n      console.error(\"Error fetching sales targets:\", error);\n      res.status(500).json({ error: \"Failed to fetch sales targets\" });\n    }\n  });\n\n  // Create a new sales target (capture opportunity)\n  app.post(\"/api/sales-targets\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const { clientId, segmento, valorCapturado, seasonId, subcategories } = req.body;\n      \n      if (!clientId || !segmento || typeof valorCapturado !== 'number' || !seasonId) {\n        return res.status(400).json({ error: \"clientId, segmento, valorCapturado, and seasonId are required\" });\n      }\n      \n      const target = await storage.createSalesTarget(userId, clientId, segmento, valorCapturado, seasonId, subcategories);\n      res.status(201).json(target);\n    } catch (error) {\n      console.error(\"Error creating sales target:\", error);\n      res.status(500).json({ error: \"Failed to create sales target\" });\n    }\n  });\n\n  // Create multiple sales targets in batch (for multi-segment capture)\n  app.post(\"/api/sales-targets/batch\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const { targets, seasonId } = req.body;\n      \n      if (!Array.isArray(targets) || targets.length === 0 || !seasonId) {\n        return res.status(400).json({ error: \"targets array and seasonId are required\" });\n      }\n\n      // Validate each target\n      for (const target of targets) {\n        if (!target.clientId || !target.segmento || typeof target.valorCapturado !== 'number') {\n          return res.status(400).json({ error: \"Each target must have clientId, segmento, and valorCapturado\" });\n        }\n      }\n\n      // Create all targets in a transaction-like manner\n      const createdTargets = [];\n      for (const target of targets) {\n        const created = await storage.createSalesTarget(\n          userId,\n          target.clientId,\n          target.segmento,\n          target.valorCapturado,\n          seasonId,\n          target.subcategories\n        );\n        createdTargets.push(created);\n      }\n\n      res.status(201).json({ success: true, targets: createdTargets });\n    } catch (error) {\n      console.error(\"Error creating batch sales targets:\", error);\n      res.status(500).json({ error: \"Failed to create batch sales targets\" });\n    }\n  });\n\n  // Update sales target\n  app.patch(\"/api/sales-targets/:id\", requireAuth, async (req, res) => {\n    try {\n      const { id } = req.params;\n      const { valorCapturado, subcategories } = req.body;\n      \n      if (typeof valorCapturado !== 'number') {\n        return res.status(400).json({ error: \"valorCapturado is required\" });\n      }\n      \n      const updated = await storage.updateSalesTarget(id, valorCapturado, subcategories);\n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating sales target:\", error);\n      res.status(500).json({ error: \"Failed to update sales target\" });\n    }\n  });\n\n  // Delete sales target (uncapture)\n  app.delete(\"/api/sales-targets/:id\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const { id } = req.params;\n      const { salesTargets } = await import(\"@shared/schema\");\n      \n      // Primeiro, buscar o target para pegar clientId e seasonId\n      const [target] = await db.select()\n        .from(salesTargets)\n        .where(\n          and(\n            eq(salesTargets.id, id),\n            eq(salesTargets.userId, userId)\n          )\n        )\n        .limit(1);\n      \n      if (!target) {\n        return res.status(404).json({ error: \"Sales target not found\" });\n      }\n      \n      // Deletar tracking records associados a este cliente + temporada\n      // Apenas para agroquímicos (que têm tracking de aplicações)\n      if (target.segmento === 'agroquimicos') {\n        console.log('[DELETE TARGET] Deletando tracking records para:', {\n          clientId: target.clientId,\n          seasonId: target.seasonId,\n          userId,\n          segmento: target.segmento\n        });\n        \n        const result = await db.delete(clientApplicationTracking)\n          .where(\n            and(\n              eq(clientApplicationTracking.clientId, target.clientId),\n              eq(clientApplicationTracking.seasonId, target.seasonId),\n              eq(clientApplicationTracking.userId, userId)\n            )\n          );\n        \n        console.log('[DELETE TARGET] Tracking records deletados:', result);\n      }\n      \n      // Deletar o target\n      await storage.deleteSalesTarget(id, userId);\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting sales target:\", error);\n      res.status(500).json({ error: \"Failed to delete sales target\" });\n    }\n  });\n\n  // Get automatic market percentage calculation for each segment\n  app.get(\"/api/market-percentage/:seasonId\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const { seasonId } = req.params;\n      const { categories, products, clientApplicationTracking, globalManagementApplications, productsPriceTable, userClientLinks, masterClients } = await import(\"@shared/schema\");\n      const { inArray } = await import(\"drizzle-orm\");\n      \n      // Get categories to map categoryId -> segmento\n      const categoriesList = await db.select().from(categories);\n      const categoryToSegment = new Map<string, string>();\n      categoriesList.forEach(cat => {\n        categoryToSegment.set(cat.id, cat.type);\n      });\n      \n      // Get market clients (includeInMarketArea=true) to filter sales\n      const marketClientIds = await db.select({ id: userClientLinks.id })\n        .from(userClientLinks)\n        .where(and(\n          eq(userClientLinks.userId, userId),\n          eq(userClientLinks.includeInMarketArea, true)\n        ));\n      \n      const marketClientIdList = marketClientIds.map(c => c.id);\n      \n      // Get sales ONLY from market clients\n      const userSales = marketClientIdList.length > 0 \n        ? await db.select()\n            .from(sales)\n            .where(and(\n              eq(sales.userId, userId),\n              eq(sales.seasonId, seasonId),\n              inArray(sales.clientId, marketClientIdList)\n            ))\n        : [];\n      \n      // Get all products to map productId -> categoryId\n      const productsList = await db.select().from(products);\n      const productToCategory = new Map<string, string>();\n      productsList.forEach(prod => {\n        productToCategory.set(prod.id, prod.categoryId);\n      });\n      \n      // Aggregate sales by segment\n      const salesBySegment: Record<string, number> = {\n        fertilizantes: 0,\n        agroquimicos: 0,\n        especialidades: 0,\n        sementes_soja: 0,\n        corretivos: 0\n      };\n      \n      userSales.forEach(sale => {\n        const categoryId = productToCategory.get(sale.productId);\n        if (categoryId) {\n          const segmento = categoryToSegment.get(categoryId);\n          if (segmento && salesBySegment.hasOwnProperty(segmento)) {\n            salesBySegment[segmento] += parseFloat(sale.totalAmount || '0');\n          }\n        }\n      });\n      \n      // Get FECHADAS applications (lost opportunities) for this user in this season\n      const fechadasApplications = await db.select()\n        .from(clientApplicationTracking)\n        .leftJoin(globalManagementApplications, eq(clientApplicationTracking.globalApplicationId, globalManagementApplications.id))\n        .leftJoin(productsPriceTable, eq(globalManagementApplications.productId, productsPriceTable.id))\n        .leftJoin(userClientLinks, eq(clientApplicationTracking.clientId, userClientLinks.id))\n        .leftJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n        .where(and(\n          eq(clientApplicationTracking.userId, userId),\n          eq(clientApplicationTracking.seasonId, seasonId),\n          eq(clientApplicationTracking.status, 'FECHADO')\n        ));\n      \n      // Aggregate FECHADAS by segment (only agroquímicos)\n      const fechadasBySegment: Record<string, number> = {\n        fertilizantes: 0,\n        agroquimicos: 0,\n        especialidades: 0,\n        sementes_soja: 0,\n        corretivos: 0\n      };\n      \n      fechadasApplications.forEach(app => {\n        if (!app.client_application_tracking || !app.global_management_applications) return;\n        \n        const pricePerHa = parseFloat(app.global_management_applications.pricePerHa || '0');\n        const plantingArea = app.master_clients ? parseFloat(app.master_clients.plantingArea || '0') : 0;\n        const totalValue = pricePerHa * plantingArea;\n        \n        // All fechadas applications are agroquímicos\n        fechadasBySegment.agroquimicos += totalValue;\n      });\n      \n      // Get ALL client market rates for this user in this season (including all categories)\n      // This gives us the TOTAL configured potential per segment\n      // Only include clients marked as includeInMarketArea\n      const allClientRates = await db.select()\n        .from(clientMarketRates)\n        .innerJoin(userClientLinks, eq(clientMarketRates.clientId, userClientLinks.id))\n        .innerJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n        .where(and(\n          eq(userClientLinks.userId, userId),\n          eq(clientMarketRates.seasonId, seasonId),\n          eq(userClientLinks.includeInMarketArea, true)\n        ));\n      \n      // Aggregate potential by segment\n      // Potential = plantingArea * investmentPerHa for each client/category combination\n      const potentialBySegment: Record<string, number> = {\n        fertilizantes: 0,\n        agroquimicos: 0,\n        especialidades: 0,\n        sementes_soja: 0,\n        corretivos: 0\n      };\n      \n      allClientRates.forEach(rate => {\n        const marketRate = rate.client_market_rates;\n        const client = rate.master_clients;\n        const categoryId = marketRate.categoryId;\n        const segmento = categoryToSegment.get(categoryId);\n        \n        if (segmento && potentialBySegment.hasOwnProperty(segmento)) {\n          // Potential = plantingArea * investmentPerHa\n          const plantingArea = parseFloat(client.plantingArea || '0');\n          const investmentPerHa = parseFloat(marketRate.investmentPerHa || '0');\n          const clientPotential = plantingArea * investmentPerHa;\n          potentialBySegment[segmento] += clientPotential;\n        }\n      });\n      \n      // Calculate percentage for each segment: (sales + fechadas) / potential * 100\n      const percentageBySegment: Record<string, number> = {};\n      \n      Object.keys(salesBySegment).forEach(segmento => {\n        const totalRealized = salesBySegment[segmento] + fechadasBySegment[segmento];\n        const potential = potentialBySegment[segmento];\n        \n        if (potential > 0) {\n          percentageBySegment[segmento] = (totalRealized / potential) * 100;\n        } else {\n          percentageBySegment[segmento] = 0;\n        }\n      });\n      \n      res.json(percentageBySegment);\n    } catch (error) {\n      console.error('Get market percentage error:', error);\n      res.status(500).json({ error: \"Failed to calculate market percentage\" });\n    }\n  });\n\n  // Get client sales history by category (for showing in capture modal)\n  app.get(\"/api/client-sales-history/:clientId/:categoryId\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const { clientId, categoryId } = req.params;\n      const currentSeasonId = req.query.seasonId as string;\n      const { sales: salesTable, products, seasons, categories: categoriesTable } = await import(\"@shared/schema\");\n      const { and, desc, inArray, lt } = await import(\"drizzle-orm\");\n      \n      if (!currentSeasonId) {\n        return res.status(400).json({ error: \"seasonId is required\" });\n      }\n      \n      // Get all products for this category\n      const categoryProducts = await db\n        .select({ id: products.id })\n        .from(products)\n        .where(eq(products.categoryId, categoryId));\n      \n      const productIds = categoryProducts.map(p => p.id);\n      \n      if (productIds.length === 0) {\n        return res.json({ totalSales: 0, lastSeasonName: null, lastSeasonSales: 0 });\n      }\n      \n      // Get current season to find its type\n      const currentSeasonResult = await db\n        .select()\n        .from(seasons)\n        .where(eq(seasons.id, currentSeasonId))\n        .limit(1);\n      \n      if (currentSeasonResult.length === 0) {\n        return res.json({ totalSales: 0, lastSeasonName: null, lastSeasonSales: 0 });\n      }\n      \n      const currentSeason = currentSeasonResult[0];\n      \n      // Get all seasons of the same type with year less than current\n      const previousSeasons = await db\n        .select()\n        .from(seasons)\n        .where(and(\n          eq(seasons.type, currentSeason.type),\n          lt(seasons.year, currentSeason.year)\n        ))\n        .orderBy(desc(seasons.year))\n        .limit(1);\n      \n      if (previousSeasons.length === 0) {\n        return res.json({ totalSales: 0, lastSeasonName: null, lastSeasonSales: 0 });\n      }\n      \n      const lastSeason = previousSeasons[0];\n      \n      // Get sales for this client in this category in the last season\n      const clientSales = await db\n        .select()\n        .from(salesTable)\n        .where(and(\n          eq(salesTable.userId, userId),\n          eq(salesTable.clientId, clientId),\n          eq(salesTable.seasonId, lastSeason.id),\n          inArray(salesTable.productId, productIds)\n        ));\n      \n      // Calculate total\n      const lastSeasonSales = clientSales.reduce((sum, sale) => {\n        return sum + parseFloat(sale.totalAmount || '0');\n      }, 0);\n      \n      res.json({\n        totalSales: lastSeasonSales,\n        lastSeasonName: lastSeason.name,\n        lastSeasonSales: lastSeasonSales\n      });\n    } catch (error) {\n      console.error(\"Error fetching client sales history:\", error);\n      res.status(500).json({ error: \"Failed to fetch sales history\" });\n    }\n  });\n\n  // Get detailed product sales history (for modal)\n  app.get(\"/api/client-sales-history-details/:clientId/:categoryId\", requireAuth, async (req, res) => {\n    try {\n      const userId = req.user!.id;\n      const { clientId, categoryId } = req.params;\n      const currentSeasonId = req.query.seasonId as string;\n      const { sales: salesTable, products, seasons } = await import(\"@shared/schema\");\n      const { and, desc, inArray, lt } = await import(\"drizzle-orm\");\n      \n      if (!currentSeasonId) {\n        return res.status(400).json({ error: \"seasonId is required\" });\n      }\n      \n      // Get all products for this category\n      const categoryProducts = await db\n        .select({ id: products.id })\n        .from(products)\n        .where(eq(products.categoryId, categoryId));\n      \n      const productIds = categoryProducts.map(p => p.id);\n      \n      if (productIds.length === 0) {\n        return res.json({ sales: [], lastSeasonName: null });\n      }\n      \n      // Get current season to find its type\n      const currentSeasonResult = await db\n        .select()\n        .from(seasons)\n        .where(eq(seasons.id, currentSeasonId))\n        .limit(1);\n      \n      if (currentSeasonResult.length === 0) {\n        return res.json({ sales: [], lastSeasonName: null });\n      }\n      \n      const currentSeason = currentSeasonResult[0];\n      \n      // Get all seasons of the same type with year less than current\n      const previousSeasons = await db\n        .select()\n        .from(seasons)\n        .where(and(\n          eq(seasons.type, currentSeason.type),\n          lt(seasons.year, currentSeason.year)\n        ))\n        .orderBy(desc(seasons.year))\n        .limit(1);\n      \n      if (previousSeasons.length === 0) {\n        return res.json({ sales: [], lastSeasonName: null });\n      }\n      \n      const lastSeason = previousSeasons[0];\n      \n      // Get sales with product details\n      const clientSales = await db\n        .select({\n          saleId: salesTable.id,\n          productName: products.name,\n          quantity: salesTable.quantity,\n          totalAmount: salesTable.totalAmount,\n        })\n        .from(salesTable)\n        .innerJoin(products, eq(salesTable.productId, products.id))\n        .where(and(\n          eq(salesTable.userId, userId),\n          eq(salesTable.clientId, clientId),\n          eq(salesTable.seasonId, lastSeason.id),\n          inArray(salesTable.productId, productIds)\n        ));\n      \n      res.json({\n        sales: clientSales,\n        lastSeasonName: lastSeason.name\n      });\n    } catch (error) {\n      console.error(\"Error fetching client sales history details:\", error);\n      res.status(500).json({ error: \"Failed to fetch sales history details\" });\n    }\n  });\n\n  // ========== PASSWORD RESET ROUTES ==========\n\n  // Request password reset\n  app.post(\"/api/forgot-password\", async (req, res) => {\n    try {\n      const { username } = req.body;\n\n      if (!username) {\n        return res.status(400).json({ error: \"Username is required\" });\n      }\n\n      // Find user by username\n      const user = await db.select().from(users).where(eq(users.username, username)).limit(1);\n      \n      if (!user || user.length === 0) {\n        // Don't reveal if user exists or not for security\n        return res.json({ message: \"If the username exists, a password reset email has been sent.\" });\n      }\n\n      const foundUser = user[0];\n\n      // Generate reset token\n      const resetToken = randomBytes(32).toString('hex');\n      const expiresAt = new Date(Date.now() + 60 * 60 * 1000); // 1 hour from now\n\n      // Save token to database\n      await db.insert(passwordResetTokens).values({\n        userId: foundUser.id,\n        token: resetToken,\n        expiresAt,\n      });\n\n      // Send email (if configured)\n      if (emailService.isConfigured()) {\n        const emailSent = await emailService.sendPasswordResetEmail(\n          username, // Using username as email for now\n          resetToken,\n          foundUser.name\n        );\n\n        if (!emailSent) {\n          console.error(\"Failed to send password reset email\");\n        }\n      } else {\n        console.log(`Password reset token for ${username}: ${resetToken}`);\n        console.log(`Reset URL: ${process.env.REPLIT_DEV_DOMAIN || 'http://localhost:5000'}/reset-password/${resetToken}`);\n      }\n\n      res.json({ message: \"If the username exists, a password reset email has been sent.\" });\n    } catch (error) {\n      console.error(\"Error requesting password reset:\", error);\n      res.status(500).json({ error: \"Failed to process password reset request\" });\n    }\n  });\n\n  // Reset password with token\n  app.post(\"/api/reset-password\", async (req, res) => {\n    try {\n      const { token, newPassword } = req.body;\n\n      if (!token || !newPassword) {\n        return res.status(400).json({ error: \"Token and new password are required\" });\n      }\n\n      if (newPassword.length < 6) {\n        return res.status(400).json({ error: \"Password must be at least 6 characters\" });\n      }\n\n      // Find valid token\n      const { isNull } = await import(\"drizzle-orm\");\n      const resetTokens = await db\n        .select()\n        .from(passwordResetTokens)\n        .where(\n          and(\n            eq(passwordResetTokens.token, token),\n            gt(passwordResetTokens.expiresAt, new Date()),\n            isNull(passwordResetTokens.usedAt)\n          )\n        )\n        .limit(1);\n\n      if (!resetTokens || resetTokens.length === 0) {\n        return res.status(400).json({ error: \"Invalid or expired reset token\" });\n      }\n\n      const resetToken = resetTokens[0];\n\n      // Hash new password\n      const salt = randomBytes(16).toString(\"hex\");\n      const buf = (await scryptAsync(newPassword, salt, 64)) as Buffer;\n      const hashedPassword = `${buf.toString(\"hex\")}.${salt}`;\n\n      // Update user password\n      await db\n        .update(users)\n        .set({ password: hashedPassword })\n        .where(eq(users.id, resetToken.userId));\n\n      // Mark token as used\n      await db\n        .update(passwordResetTokens)\n        .set({ usedAt: new Date() })\n        .where(eq(passwordResetTokens.id, resetToken.id));\n\n      res.json({ message: \"Password has been reset successfully\" });\n    } catch (error) {\n      console.error(\"Error resetting password:\", error);\n      res.status(500).json({ error: \"Failed to reset password\" });\n    }\n  });\n\n  // ========== ADMIN DASHBOARD ROUTES ==========\n  \n  // Get regional sales analysis for admin dashboard\n  app.get(\"/api/admin/regional-sales\", requireSuperAdmin, async (req, res) => {\n    try {\n      const { sales, userClientLinks, masterClients, products, regions } = await import(\"@shared/schema\");\n      const { inArray, sql } = await import(\"drizzle-orm\");\n      \n      // Get all sales with client and product details\n      const allSales = await db\n        .select({\n          saleId: sales.id,\n          totalAmount: sales.totalAmount,\n          quantity: sales.quantity,\n          saleDate: sales.saleDate,\n          clientId: sales.clientId,\n          productId: sales.productId,\n          productName: products.name,\n          productBrand: products.marca,\n          categoryId: products.categoryId,\n          clientName: masterClients.name,\n          regionId: masterClients.regionId,\n        })\n        .from(sales)\n        .leftJoin(userClientLinks, eq(sales.clientId, userClientLinks.id))\n        .leftJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n        .leftJoin(products, eq(sales.productId, products.id));\n      \n      // Get all regions\n      const allRegions = await db.select().from(regions);\n      \n      // Aggregate data by region\n      const regionalData: Record<string, {\n        regionName: string;\n        totalSales: number;\n        totalVolume: number;\n        salesCount: number;\n        products: Record<string, {\n          productName: string;\n          brand: string;\n          volume: number;\n          sales: number;\n          category: string;\n        }>;\n      }> = {};\n      \n      // Initialize regions\n      allRegions.forEach(region => {\n        regionalData[region.id] = {\n          regionName: region.name,\n          totalSales: 0,\n          totalVolume: 0,\n          salesCount: 0,\n          products: {},\n        };\n      });\n      \n      // Aggregate sales data\n      allSales.forEach(sale => {\n        const regionId = sale.regionId || 'unknown';\n        \n        // Initialize region if not exists\n        if (!regionalData[regionId]) {\n          regionalData[regionId] = {\n            regionName: 'Região Desconhecida',\n            totalSales: 0,\n            totalVolume: 0,\n            salesCount: 0,\n            products: {},\n          };\n        }\n        \n        const amount = parseFloat(sale.totalAmount || \"0\");\n        const volume = parseFloat(sale.quantity || \"0\");\n        \n        regionalData[regionId].totalSales += amount;\n        regionalData[regionId].totalVolume += volume;\n        regionalData[regionId].salesCount++;\n        \n        // Aggregate by product\n        if (sale.productId && sale.productName) {\n          const productKey = `${sale.productId}-${sale.productBrand || 'no-brand'}`;\n          \n          if (!regionalData[regionId].products[productKey]) {\n            regionalData[regionId].products[productKey] = {\n              productName: sale.productName,\n              brand: sale.productBrand || 'N/A',\n              volume: 0,\n              sales: 0,\n              category: sale.categoryId || 'N/A',\n            };\n          }\n          \n          regionalData[regionId].products[productKey].volume += volume;\n          regionalData[regionId].products[productKey].sales += amount;\n        }\n      });\n      \n      // Convert to array and sort products\n      const result = Object.entries(regionalData).map(([regionId, data]) => ({\n        regionId,\n        regionName: data.regionName,\n        totalSales: data.totalSales,\n        totalVolume: data.totalVolume,\n        salesCount: data.salesCount,\n        topProducts: Object.values(data.products)\n          .sort((a, b) => b.sales - a.sales)\n          .slice(0, 5),\n      })).sort((a, b) => b.totalSales - a.totalSales);\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching regional sales:\", error);\n      res.status(500).json({ error: \"Failed to fetch regional sales data\" });\n    }\n  });\n  \n  // ========== MANAGER ROUTES ==========\n  \n  // Get team aggregated data for dashboard\n  app.get(\"/api/manager/team-data\", requireManager, async (req, res) => {\n    try {\n      const { users, sales, products } = await import(\"@shared/schema\");\n      const { inArray } = await import(\"drizzle-orm\");\n      const managerId = req.user!.id;\n      \n      // Get team member IDs\n      const teamMembers = await db\n        .select({\n          id: users.id,\n          name: users.name,\n        })\n        .from(users)\n        .where(eq(users.managerId, managerId));\n      \n      const teamIds = teamMembers.map(m => m.id);\n      \n      if (teamIds.length === 0) {\n        return res.json({\n          totalSales: 0,\n          salesByCategory: {},\n          salesBySeason: {},\n          clientSales: {},\n          totalTimacPoints: 0,\n          teamMembers: [],\n        });\n      }\n      \n      // Get all sales from team with products\n      const teamSales = await db\n        .select({\n          sale: sales,\n          product: products,\n        })\n        .from(sales)\n        .leftJoin(products, eq(sales.productId, products.id))\n        .where(inArray(sales.userId, teamIds));\n      \n      // Calculate aggregations\n      let totalSales = 0;\n      const salesByCategory: Record<string, number> = {};\n      const salesBySeason: Record<string, number> = {};\n      const clientSales: Record<string, number> = {};\n      const memberSales: Record<string, { totalSales: number; timacPoints: number }> = {};\n      let totalTimacPoints = 0;\n      \n      // Initialize member sales\n      teamMembers.forEach(member => {\n        memberSales[member.id] = { totalSales: 0, timacPoints: 0 };\n      });\n      \n      // Get unique client IDs from sales\n      const clientIds = Array.from(new Set(teamSales.map(s => s.sale.clientId).filter(Boolean)));\n      \n      // Fetch client details\n      const { userClientLinks, masterClients } = await import(\"@shared/schema\");\n      const clientDetails = await db\n        .select({\n          linkId: userClientLinks.id,\n          clientName: masterClients.name,\n        })\n        .from(userClientLinks)\n        .innerJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n        .where(inArray(userClientLinks.id, clientIds as string[]));\n      \n      const clientNameMap = new Map(\n        clientDetails.map(c => [c.linkId, c.clientName])\n      );\n      \n      teamSales.forEach(({ sale, product }) => {\n        const value = parseFloat(sale.totalAmount || \"0\");\n        \n        // Total sales\n        totalSales += value;\n        \n        // Sales by category\n        if (sale.categoryId) {\n          salesByCategory[sale.categoryId] = (salesByCategory[sale.categoryId] || 0) + value;\n        }\n        \n        // Sales by season\n        if (sale.seasonId) {\n          salesBySeason[sale.seasonId] = (salesBySeason[sale.seasonId] || 0) + value;\n        }\n        \n        // Sales by client (use client name instead of ID)\n        if (sale.clientId) {\n          const clientName = clientNameMap.get(sale.clientId) || sale.clientId;\n          clientSales[clientName] = (clientSales[clientName] || 0) + value;\n        }\n        \n        // Member sales\n        if (memberSales[sale.userId]) {\n          memberSales[sale.userId].totalSales += value;\n        }\n        \n        // Timac points calculation\n        if (product && product.marca?.toLowerCase().includes('timac') && sale.categoryId === 'cat-especialidades') {\n          const quantity = parseFloat(sale.quantity || \"0\");\n          const packageSize = parseFloat(product.packageSize || \"1\");\n          const timacPoints = parseFloat(product.timacPoints || \"0\");\n          \n          const cantPedido = packageSize > 0 ? quantity / packageSize : 0;\n          const quantidadeTotal = cantPedido * packageSize;\n          const points = timacPoints * quantidadeTotal;\n          \n          totalTimacPoints += points;\n          \n          if (memberSales[sale.userId]) {\n            memberSales[sale.userId].timacPoints += points;\n          }\n        }\n      });\n      \n      // Build team members array with their data\n      const teamMembersData = teamMembers.map(member => ({\n        id: member.id,\n        name: member.name,\n        totalSales: memberSales[member.id].totalSales,\n        timacPoints: memberSales[member.id].timacPoints,\n      }));\n      \n      // Get Timac settings for gerentes value\n      const { timacSettings } = await import(\"@shared/schema\");\n      const timacConfig = await db.select().from(timacSettings).limit(1);\n      const gerentesValue = timacConfig[0]?.gerentesValue || \"0.76\";\n      \n      res.json({\n        totalSales,\n        salesByCategory,\n        salesBySeason,\n        clientSales,\n        totalTimacPoints,\n        gerentesValue,\n        teamMembers: teamMembersData,\n      });\n    } catch (error) {\n      console.error(\"Error fetching team data:\", error);\n      res.status(500).json({ error: \"Failed to fetch team data\" });\n    }\n  });\n  \n  // Get team consultors\n  app.get(\"/api/manager/team\", requireManager, async (req, res) => {\n    try {\n      const { users } = await import(\"@shared/schema\");\n      const managerId = req.user!.id;\n      \n      const teamMembers = await db\n        .select({\n          id: users.id,\n          name: users.name,\n          username: users.username,\n          role: users.role,\n        })\n        .from(users)\n        .where(eq(users.managerId, managerId));\n      \n      res.json(teamMembers);\n    } catch (error) {\n      console.error(\"Error fetching team:\", error);\n      res.status(500).json({ error: \"Failed to fetch team members\" });\n    }\n  });\n\n  // Get team consolidated sales (without commissions)\n  app.get(\"/api/manager/team-sales\", requireManager, async (req, res) => {\n    try {\n      const { users, sales } = await import(\"@shared/schema\");\n      const { inArray } = await import(\"drizzle-orm\");\n      const managerId = req.user!.id;\n      \n      // Get team member IDs\n      const teamMembers = await db\n        .select({ id: users.id })\n        .from(users)\n        .where(eq(users.managerId, managerId));\n      \n      const teamIds = teamMembers.map(m => m.id);\n      \n      if (teamIds.length === 0) {\n        return res.json({\n          totalSales: 0,\n          salesByCategory: {},\n          salesBySeason: {},\n          topClients: [],\n        });\n      }\n      \n      // Get all sales from team\n      const teamSales = await db\n        .select()\n        .from(sales)\n        .where(inArray(sales.userId, teamIds));\n      \n      // Calculate aggregations\n      const totalSales = teamSales.reduce((sum, sale) => sum + parseFloat(sale.totalAmount || \"0\"), 0);\n      \n      const salesByCategory: Record<string, number> = {};\n      const salesBySeason: Record<string, number> = {};\n      const clientSales: Record<string, number> = {};\n      \n      // Get unique client IDs from sales\n      const clientIds = Array.from(new Set(teamSales.map(s => s.clientId).filter(Boolean)));\n      \n      // Fetch client details\n      const { userClientLinks, masterClients } = await import(\"@shared/schema\");\n      const clientDetails = await db\n        .select({\n          linkId: userClientLinks.id,\n          clientName: masterClients.name,\n        })\n        .from(userClientLinks)\n        .innerJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n        .where(inArray(userClientLinks.id, clientIds as string[]));\n      \n      const clientNameMap = new Map(\n        clientDetails.map(c => [c.linkId, c.clientName])\n      );\n      \n      teamSales.forEach(sale => {\n        const value = parseFloat(sale.totalAmount || \"0\");\n        \n        if (sale.categoryId) {\n          salesByCategory[sale.categoryId] = (salesByCategory[sale.categoryId] || 0) + value;\n        }\n        if (sale.seasonId) {\n          salesBySeason[sale.seasonId] = (salesBySeason[sale.seasonId] || 0) + value;\n        }\n        if (sale.clientId) {\n          const clientName = clientNameMap.get(sale.clientId) || sale.clientId;\n          clientSales[clientName] = (clientSales[clientName] || 0) + value;\n        }\n      });\n      \n      // Top 5 clients\n      const topClients = Object.entries(clientSales)\n        .map(([clientId, value]) => ({ clientId, value }))\n        .sort((a, b) => b.value - a.value)\n        .slice(0, 5);\n      \n      res.json({\n        totalSales,\n        salesByCategory,\n        salesBySeason,\n        topClients,\n      });\n    } catch (error) {\n      console.error(\"Error fetching team sales:\", error);\n      res.status(500).json({ error: \"Failed to fetch team sales\" });\n    }\n  });\n\n  // Get team Timac points\n  app.get(\"/api/manager/team-timac-points\", requireManager, async (req, res) => {\n    try {\n      const { users, sales, products } = await import(\"@shared/schema\");\n      const { inArray } = await import(\"drizzle-orm\");\n      const managerId = req.user!.id;\n      \n      // Get team member IDs\n      const teamMembers = await db\n        .select({ id: users.id })\n        .from(users)\n        .where(eq(users.managerId, managerId));\n      \n      const teamIds = teamMembers.map(m => m.id);\n      \n      if (teamIds.length === 0) {\n        return res.json({ totalPoints: 0, pointsByConsultor: [] });\n      }\n      \n      // Get all Timac sales (marca = Timac AND categoria = Especialidades)\n      const teamSales = await db\n        .select({\n          sale: sales,\n          product: products,\n        })\n        .from(sales)\n        .leftJoin(products, eq(sales.productId, products.id))\n        .where(inArray(sales.userId, teamIds));\n      \n      let totalPoints = 0;\n      const pointsByConsultor: Record<string, { consultorId: string; points: number }> = {};\n      \n      teamSales.forEach(({ sale, product }) => {\n        if (product && product.marca?.toLowerCase().includes('timac') && sale.categoryId === 'cat-especialidades') {\n          const quantity = parseFloat(sale.quantity || \"0\");\n          const packageSize = parseFloat(product.packageSize || \"1\");\n          const timacPoints = parseFloat(product.timacPoints || \"0\");\n          \n          const cantPedido = packageSize > 0 ? quantity / packageSize : 0;\n          const quantidadeTotal = cantPedido * packageSize;\n          const points = timacPoints * quantidadeTotal;\n          \n          totalPoints += points;\n          \n          if (!pointsByConsultor[sale.userId]) {\n            pointsByConsultor[sale.userId] = { consultorId: sale.userId, points: 0 };\n          }\n          pointsByConsultor[sale.userId].points += points;\n        }\n      });\n      \n      res.json({\n        totalPoints,\n        pointsByConsultor: Object.values(pointsByConsultor),\n      });\n    } catch (error) {\n      console.error(\"Error fetching team Timac points:\", error);\n      res.status(500).json({ error: \"Failed to fetch team Timac points\" });\n    }\n  });\n\n  // Get team season goals aggregated\n  app.get(\"/api/manager/team-goals\", requireManager, async (req, res) => {\n    try {\n      const { users, seasonGoals } = await import(\"@shared/schema\");\n      const { inArray, sql } = await import(\"drizzle-orm\");\n      const managerId = req.user!.id;\n      \n      // Get team member IDs\n      const teamMembers = await db\n        .select({ id: users.id })\n        .from(users)\n        .where(eq(users.managerId, managerId));\n      \n      const teamIds = teamMembers.map(m => m.id);\n      \n      if (teamIds.length === 0) {\n        return res.json([]);\n      }\n      \n      // Get aggregated goals by season\n      const goals = await db\n        .select({\n          seasonId: seasonGoals.seasonId,\n          totalGoal: sql<number>`SUM(CAST(${seasonGoals.goalAmount} AS NUMERIC))`,\n        })\n        .from(seasonGoals)\n        .where(inArray(seasonGoals.userId, teamIds))\n        .groupBy(seasonGoals.seasonId);\n      \n      res.json(goals);\n    } catch (error) {\n      console.error(\"Error fetching team goals:\", error);\n      res.status(500).json({ error: \"Failed to fetch team goals\" });\n    }\n  });\n\n  // Get team sales evolution (monthly aggregation by category)\n  app.get(\"/api/manager/team-sales-evolution\", requireManager, async (req, res) => {\n    try {\n      const { users, sales, products, categories } = await import(\"@shared/schema\");\n      const { inArray, sql } = await import(\"drizzle-orm\");\n      const managerId = req.user!.id;\n      \n      // Get team member IDs\n      const teamMembers = await db\n        .select({ id: users.id })\n        .from(users)\n        .where(eq(users.managerId, managerId));\n      \n      const teamIds = teamMembers.map(m => m.id);\n      \n      if (teamIds.length === 0) {\n        return res.json([]);\n      }\n      \n      // Get sales grouped by month and category\n      const monthlySalesByCategory = await db\n        .select({\n          month: sql<string>`TO_CHAR(${sales.saleDate}, 'YYYY-MM')`,\n          category: categories.name,\n          totalAmount: sql<number>`SUM(CAST(${sales.totalAmount} AS NUMERIC))`,\n        })\n        .from(sales)\n        .leftJoin(products, eq(sales.productId, products.id))\n        .leftJoin(categories, eq(products.categoryId, categories.id))\n        .where(inArray(sales.userId, teamIds))\n        .groupBy(sql`TO_CHAR(${sales.saleDate}, 'YYYY-MM')`, categories.name)\n        .orderBy(sql`TO_CHAR(${sales.saleDate}, 'YYYY-MM')`);\n      \n      res.json(monthlySalesByCategory);\n    } catch (error) {\n      console.error(\"Error fetching team sales evolution:\", error);\n      res.status(500).json({ error: \"Failed to fetch team sales evolution\" });\n    }\n  });\n\n  // Get team market benchmarks for multiple seasons (average of consultors' manually entered percentages)\n  app.get(\"/api/manager/team-market-benchmarks-multi\", requireManager, async (req, res) => {\n    try {\n      const { marketBenchmarks, users } = await import(\"@shared/schema\");\n      const { inArray: inArrayOp, and } = await import(\"drizzle-orm\");\n      const managerId = req.user!.id;\n      const seasonIds = (req.query.seasonIds as string)?.split(',').filter(Boolean) || [];\n      \n      if (seasonIds.length === 0) {\n        return res.json({});\n      }\n      \n      // Get team member IDs\n      const teamMembers = await db\n        .select({ id: users.id })\n        .from(users)\n        .where(eq(users.managerId, managerId));\n      \n      const teamIds = teamMembers.map(m => m.id);\n      \n      if (teamIds.length === 0) {\n        return res.json({});\n      }\n      \n      // Get categories to map categoryId to name\n      const categories = await storage.getAllCategories();\n      const categoryMap = new Map(categories.map(c => [c.id, c.name]));\n      \n      // Get benchmarks for team members and requested seasons\n      const benchmarks = await db\n        .select()\n        .from(marketBenchmarks)\n        .where(and(\n          inArrayOp(marketBenchmarks.userId, teamIds),\n          inArrayOp(marketBenchmarks.seasonId, seasonIds)\n        ));\n      \n      // Group by season and calculate average per category\n      const result: Record<string, Record<string, number>> = {};\n      \n      seasonIds.forEach(seasonId => {\n        const seasonBenchmarks = benchmarks.filter(b => b.seasonId === seasonId);\n        \n        // Group by category and collect all percentages\n        const categoryPercentages: Record<string, number[]> = {};\n        \n        seasonBenchmarks.forEach(benchmark => {\n          const categoryName = categoryMap.get(benchmark.categoryId);\n          if (categoryName) {\n            if (!categoryPercentages[categoryName]) {\n              categoryPercentages[categoryName] = [];\n            }\n            categoryPercentages[categoryName].push(parseFloat(benchmark.marketPercentage));\n          }\n        });\n        \n        // Calculate average for each category\n        const categoryAverages: Record<string, number> = {};\n        Object.entries(categoryPercentages).forEach(([categoryName, percentages]) => {\n          if (percentages.length > 0) {\n            const average = percentages.reduce((sum, val) => sum + val, 0) / percentages.length;\n            categoryAverages[categoryName] = average;\n          }\n        });\n        \n        result[seasonId] = categoryAverages;\n      });\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching multi-season team market benchmarks:\", error);\n      res.status(500).json({ error: \"Failed to fetch team market benchmarks\" });\n    }\n  });\n\n  // Get team market benchmarks\n  app.get(\"/api/manager/team-market-benchmarks/:seasonId\", requireManager, async (req, res) => {\n    try {\n      const { users, marketBenchmarks } = await import(\"@shared/schema\");\n      const { inArray } = await import(\"drizzle-orm\");\n      const { seasonId } = req.params;\n      const managerId = req.user!.id;\n      \n      // Get team member IDs\n      const teamMembers = await db\n        .select({ id: users.id })\n        .from(users)\n        .where(eq(users.managerId, managerId));\n      \n      const teamIds = teamMembers.map(m => m.id);\n      \n      if (teamIds.length === 0) {\n        return res.json([]);\n      }\n      \n      // Get any team member's benchmarks (they should all be the same for the organization)\n      // Or we could aggregate/average them\n      const benchmarks = await db\n        .select()\n        .from(marketBenchmarks)\n        .where(eq(marketBenchmarks.seasonId, seasonId))\n        .limit(10); // Get first set of benchmarks for this season\n      \n      res.json(benchmarks);\n    } catch (error) {\n      console.error(\"Error fetching team market benchmarks:\", error);\n      res.status(500).json({ error: \"Failed to fetch team market benchmarks\" });\n    }\n  });\n\n  // Get team market analysis for multiple seasons\n  app.get(\"/api/manager/team-market-analysis-multi\", requireManager, async (req, res) => {\n    try {\n      const { users, externalPurchases, sales: salesTable } = await import(\"@shared/schema\");\n      const { inArray, and } = await import(\"drizzle-orm\");\n      const managerId = req.user!.id;\n      const seasonIds = (req.query.seasonIds as string)?.split(',').filter(Boolean) || [];\n      \n      if (seasonIds.length === 0) {\n        return res.json({});\n      }\n      \n      // Get team member IDs\n      const teamMembers = await db\n        .select({ id: users.id })\n        .from(users)\n        .where(eq(users.managerId, managerId));\n      \n      const teamIds = teamMembers.map(m => m.id);\n      \n      if (teamIds.length === 0) {\n        return res.json({});\n      }\n      \n      const categories = await storage.getAllCategories();\n      const products = await storage.getAllProducts();\n      \n      // Create product-to-category map\n      const productCategoryMap = new Map<string, string>();\n      products.forEach(p => {\n        if (p.categoryId) {\n          productCategoryMap.set(p.id, p.categoryId);\n        }\n      });\n      \n      // Result structure: { seasonId: { categoryName: percentage } }\n      const result: Record<string, Record<string, number>> = {};\n      \n      for (const seasonId of seasonIds) {\n        const categoryDataById: Record<string, {\n          categoryName: string;\n          cvaleAmount: number;\n          totalAmount: number;\n        }> = {};\n        \n        // Initialize categories\n        categories.forEach(cat => {\n          categoryDataById[cat.id] = {\n            categoryName: cat.name,\n            cvaleAmount: 0,\n            totalAmount: 0,\n          };\n        });\n        \n        // Get team sales for this season\n        const teamSeasonSales = await db\n          .select()\n          .from(salesTable)\n          .where(and(\n            inArray(salesTable.userId, teamIds),\n            eq(salesTable.seasonId, seasonId)\n          ));\n        \n        // Get external purchases for this season\n        const teamExternalPurchases = await db\n          .select()\n          .from(externalPurchases)\n          .where(and(\n            inArray(externalPurchases.userId, teamIds),\n            eq(externalPurchases.seasonId, seasonId)\n          ));\n        \n        // Aggregate C.Vale sales\n        teamSeasonSales.forEach(sale => {\n          const categoryId = productCategoryMap.get(sale.productId);\n          if (categoryId && categoryDataById[categoryId]) {\n            const amount = parseFloat(sale.totalAmount || '0');\n            categoryDataById[categoryId].cvaleAmount += amount;\n            categoryDataById[categoryId].totalAmount += amount;\n          }\n        });\n        \n        // Add external purchases\n        teamExternalPurchases.forEach(purchase => {\n          const categoryId = purchase.categoryId;\n          if (categoryId && categoryDataById[categoryId]) {\n            const amount = parseFloat(purchase.amount || '0');\n            categoryDataById[categoryId].totalAmount += amount;\n          }\n        });\n        \n        // Transform to category name -> percentage\n        const categoryPercentages: Record<string, number> = {};\n        Object.values(categoryDataById).forEach(cat => {\n          const percentage = cat.totalAmount > 0 ? (cat.cvaleAmount / cat.totalAmount) * 100 : 0;\n          categoryPercentages[cat.categoryName] = percentage;\n        });\n        \n        result[seasonId] = categoryPercentages;\n      }\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching multi-season team market analysis:\", error);\n      res.status(500).json({ error: \"Failed to fetch market analysis\" });\n    }\n  });\n\n  // Get team sales vs goals for multiple seasons (percentage achievement)\n  app.get(\"/api/manager/team-sales-vs-goals-multi\", requireManager, async (req, res) => {\n    try {\n      const { users, seasonGoals } = await import(\"@shared/schema\");\n      const { inArray, and } = await import(\"drizzle-orm\");\n      const managerId = req.user!.id;\n      const seasonIds = (req.query.seasonIds as string)?.split(',').filter(Boolean) || [];\n      \n      if (seasonIds.length === 0) {\n        return res.json({});\n      }\n      \n      // Get team member IDs\n      const teamMembers = await db\n        .select({ id: users.id })\n        .from(users)\n        .where(eq(users.managerId, managerId));\n      \n      const teamIds = teamMembers.map(m => m.id);\n      \n      if (teamIds.length === 0) {\n        return res.json({});\n      }\n      \n      // Get all necessary data\n      const allSales = await storage.getAllSales();\n      const categories = await storage.getAllCategories();\n      const products = await storage.getAllProducts();\n      \n      // Get manager's goals for all requested seasons\n      const managerGoals = await db\n        .select()\n        .from(seasonGoals)\n        .where(and(\n          eq(seasonGoals.userId, managerId),\n          inArray(seasonGoals.seasonId, seasonIds)\n        ));\n      \n      // Create maps\n      const productCategoryMap = new Map<string, string>();\n      products.forEach(p => {\n        if (p.categoryId) {\n          productCategoryMap.set(p.id, p.categoryId);\n        }\n      });\n      \n      const categoryNameMap = new Map<string, string>();\n      categories.forEach(cat => {\n        categoryNameMap.set(cat.id, cat.name);\n      });\n      \n      // Category name to meta field mapping\n      const categoryMetaFieldMap: Record<string, string> = {\n        'Agroquímicos': 'metaAgroquimicos',\n        'Especialidades': 'metaEspecialidades',\n        'Fertilizantes': 'metaFertilizantes',\n        'Corretivos': 'metaCorretivos',\n        'Sementes Soja': 'metaSementesSoja',\n        'Sementes Milho': 'metaSementesMilho',\n        'Sementes Trigo': 'metaSementesTrigo',\n        'Sementes Diversas': 'metaSementesDiversas',\n      };\n      \n      const result: Record<string, Record<string, number>> = {};\n      \n      // Process each season\n      for (const seasonId of seasonIds) {\n        // Find manager's goal for this season\n        const seasonGoal = managerGoals.find(g => g.seasonId === seasonId);\n        \n        if (!seasonGoal) {\n          result[seasonId] = {};\n          continue;\n        }\n        \n        // Get team sales for this season\n        const seasonSales = allSales.filter(s => \n          teamIds.includes(s.userId) && s.seasonId === seasonId\n        );\n        \n        // Aggregate sales by category\n        const categorySales: Record<string, number> = {};\n        seasonSales.forEach(sale => {\n          const categoryId = productCategoryMap.get(sale.productId);\n          if (categoryId) {\n            const categoryName = categoryNameMap.get(categoryId);\n            if (categoryName) {\n              if (!categorySales[categoryName]) {\n                categorySales[categoryName] = 0;\n              }\n              categorySales[categoryName] += parseFloat(sale.totalAmount || '0');\n            }\n          }\n        });\n        \n        // Calculate percentages (sales / goal * 100)\n        const categoryPercentages: Record<string, number> = {};\n        Object.entries(categoryMetaFieldMap).forEach(([categoryName, metaField]) => {\n          const salesAmount = categorySales[categoryName] || 0;\n          const goalAmount = parseFloat((seasonGoal as any)[metaField] || '0');\n          \n          const percentage = goalAmount > 0 ? (salesAmount / goalAmount) * 100 : 0;\n          categoryPercentages[categoryName] = percentage;\n        });\n        \n        result[seasonId] = categoryPercentages;\n      }\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching team sales vs goals:\", error);\n      res.status(500).json({ error: \"Failed to fetch team sales vs goals\" });\n    }\n  });\n\n  // Get team market percentages for multiple seasons (marketPercentage column)\n  app.get(\"/api/manager/team-market-percentages-multi\", requireManager, async (req, res) => {\n    try {\n      const { users, clientMarketRates, userClientLinks, masterClients, clientApplicationTracking, globalManagementApplications, productsPriceTable } = await import(\"@shared/schema\");\n      const { inArray, and } = await import(\"drizzle-orm\");\n      const managerId = req.user!.id;\n      const seasonIds = (req.query.seasonIds as string)?.split(',').filter(Boolean) || [];\n      \n      if (seasonIds.length === 0) {\n        return res.json({});\n      }\n      \n      // Get team member IDs\n      const teamMembers = await db\n        .select({ id: users.id })\n        .from(users)\n        .where(eq(users.managerId, managerId));\n      \n      const teamIds = teamMembers.map(m => m.id);\n      \n      if (teamIds.length === 0) {\n        return res.json({});\n      }\n      \n      const categories = await storage.getAllCategories();\n      const products = await storage.getAllProducts();\n      const allSales = await storage.getAllSales();\n      \n      // Create product-to-category map\n      const productCategoryMap = new Map<string, string>();\n      products.forEach(p => {\n        if (p.categoryId) {\n          productCategoryMap.set(p.id, p.categoryId);\n        }\n      });\n      \n      // Create category name map\n      const categoryNameMap = new Map<string, string>();\n      categories.forEach(cat => {\n        categoryNameMap.set(cat.id, cat.name);\n      });\n      \n      // Result structure: { seasonId: { categoryName: marketPercentage } }\n      const result: Record<string, Record<string, number>> = {};\n      \n      for (const seasonId of seasonIds) {\n        // Get market clients for the team (includeInMarketArea=true)\n        const teamMarketClients = await db.select({ id: userClientLinks.id })\n          .from(userClientLinks)\n          .where(and(\n            inArray(userClientLinks.userId, teamIds),\n            eq(userClientLinks.includeInMarketArea, true)\n          ));\n        \n        const teamMarketClientIds = teamMarketClients.map(c => c.id);\n        \n        // Get team sales ONLY from market clients\n        const teamSales = allSales.filter(s => \n          teamIds.includes(s.userId) && \n          s.seasonId === seasonId &&\n          teamMarketClientIds.includes(s.clientId)\n        );\n        \n        // Aggregate sales by category\n        const salesByCategory: Record<string, number> = {};\n        categories.forEach(cat => {\n          salesByCategory[cat.id] = 0;\n        });\n        \n        teamSales.forEach(sale => {\n          const categoryId = productCategoryMap.get(sale.productId);\n          if (categoryId) {\n            salesByCategory[categoryId] += parseFloat(sale.totalAmount || '0');\n          }\n        });\n        \n        // Get all client market rates for the team in this season\n        // Only include clients marked as includeInMarketArea\n        const teamMarketRates = await db.select()\n          .from(clientMarketRates)\n          .innerJoin(userClientLinks, eq(clientMarketRates.clientId, userClientLinks.id))\n          .innerJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n          .where(and(\n            inArray(userClientLinks.userId, teamIds),\n            eq(clientMarketRates.seasonId, seasonId),\n            eq(userClientLinks.includeInMarketArea, true)\n          ));\n        \n        // Calculate total potential by category\n        const potentialByCategory: Record<string, number> = {};\n        categories.forEach(cat => {\n          potentialByCategory[cat.id] = 0;\n        });\n        \n        teamMarketRates.forEach(rate => {\n          const categoryId = rate.client_market_rates.categoryId;\n          const plantingArea = parseFloat(rate.master_clients.plantingArea || '0');\n          const investmentPerHa = parseFloat(rate.client_market_rates.investmentPerHa || '0');\n          const potential = plantingArea * investmentPerHa;\n          \n          if (potentialByCategory.hasOwnProperty(categoryId)) {\n            potentialByCategory[categoryId] += potential;\n          }\n        });\n        \n        // Get FECHADO values from client_application_tracking\n        // These are applications marked as \"lost to competitor\" in the Market Management Panel\n        // All applications are under Agroquímicos category\n        const agroquimicosCategory = categories.find(c => c.type === 'agroquimicos');\n        const agroquimicosCategoryId = agroquimicosCategory?.id || '';\n        \n        const teamApplicationTrackingRaw = await db.select({\n          clientId: clientApplicationTracking.clientId,\n          productId: globalManagementApplications.productId,\n          plantingArea: masterClients.plantingArea\n        })\n          .from(clientApplicationTracking)\n          .innerJoin(globalManagementApplications, eq(clientApplicationTracking.globalApplicationId, globalManagementApplications.id))\n          .innerJoin(userClientLinks, eq(clientApplicationTracking.clientId, userClientLinks.id))\n          .innerJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n          .where(and(\n            inArray(userClientLinks.userId, teamIds),\n            eq(globalManagementApplications.seasonId, seasonId),\n            eq(userClientLinks.includeInMarketArea, true),\n            eq(clientApplicationTracking.status, 'FECHADO')\n          ));\n        \n        // Get product prices for FECHADO applications\n        const productIds = Array.from(new Set(teamApplicationTrackingRaw.map(t => t.productId)));\n        const productPrices = productIds.length > 0 ? await db.select({\n          id: productsPriceTable.id,\n          precoVerde: productsPriceTable.precoVerde\n        })\n          .from(productsPriceTable)\n          .where(inArray(productsPriceTable.id, productIds)) : [];\n        \n        const productPriceMap = new Map(productPrices.map(p => [p.id, parseFloat(p.precoVerde || '0')]));\n        \n        // Calculate total FECHADO value for Agroquímicos\n        let totalFechadoAgroquimicos = 0;\n        teamApplicationTrackingRaw.forEach(tracking => {\n          const pricePerHa = productPriceMap.get(tracking.productId) || 0;\n          const area = parseFloat(tracking.plantingArea || '0');\n          totalFechadoAgroquimicos += pricePerHa * area;\n        });\n        \n        // Aggregate FECHADO values by category\n        const fechadoByCategory: Record<string, number> = {};\n        categories.forEach(cat => {\n          fechadoByCategory[cat.id] = 0;\n        });\n        \n        if (agroquimicosCategoryId) {\n          fechadoByCategory[agroquimicosCategoryId] = totalFechadoAgroquimicos;\n        }\n        \n        // Calculate Mercado automatically: Mercado = Potencial - C.Vale - FECHADO\n        const marketValuesByCategory: Record<string, number> = {};\n        categories.forEach(cat => {\n          const potential = potentialByCategory[cat.id] || 0;\n          const sales = salesByCategory[cat.id] || 0;\n          const fechado = fechadoByCategory[cat.id] || 0;\n          \n          // Mercado = Potential - Sales - Closed Applications\n          const mercado = Math.max(0, potential - sales - fechado);\n          marketValuesByCategory[cat.id] = mercado;\n        });\n        \n        // Calculate market penetration: (C.Vale + Mercado) / potential * 100\n        // Mercado = values from clientMarketValues (column Mercado in modal)\n        // Ensure we include all major categories even if they have no data\n        const categoryPercentages: Record<string, number> = {};\n        \n        // Define standard category names to ensure consistency with sales-vs-goals endpoint\n        const standardCategories = [\n          'Agroquímicos',\n          'Especialidades', \n          'Fertilizantes',\n          'Corretivos',\n          'Sementes Soja',\n          'Sementes Milho',\n          'Sementes Trigo',\n          'Sementes Diversas'\n        ];\n        \n        // Initialize all standard categories with 0\n        standardCategories.forEach(catName => {\n          categoryPercentages[catName] = 0;\n        });\n        \n        // Calculate and populate actual values\n        categories.forEach(cat => {\n          const potential = potentialByCategory[cat.id] || 0;\n          const sales = salesByCategory[cat.id] || 0;\n          const mercado = marketValuesByCategory[cat.id] || 0;\n          const totalWorked = sales + mercado; // C.Vale + Mercado\n          \n          const marketPercentage = potential > 0 ? (totalWorked / potential) * 100 : 0;\n          const categoryName = categoryNameMap.get(cat.id);\n          if (categoryName) {\n            categoryPercentages[categoryName] = marketPercentage;\n          }\n        });\n        \n        result[seasonId] = categoryPercentages;\n      }\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"Error fetching team market percentages:\", error);\n      res.status(500).json({ error: \"Failed to fetch team market percentages\" });\n    }\n  });\n\n  // Get team market analysis consolidated\n  app.get(\"/api/manager/team-market-analysis\", requireManager, async (req, res) => {\n    try {\n      const { users, externalPurchases, seasonGoals, clientMarketRates, userClientLinks, masterClients, clientApplicationTracking, globalManagementApplications, productsPriceTable } = await import(\"@shared/schema\");\n      const { inArray, and } = await import(\"drizzle-orm\");\n      const managerId = req.user!.id;\n      const seasonId = req.query.seasonId as string | undefined;\n      \n      // Get team member IDs\n      const teamMembers = await db\n        .select({ id: users.id })\n        .from(users)\n        .where(eq(users.managerId, managerId));\n      \n      const teamIds = teamMembers.map(m => m.id);\n      \n      if (teamIds.length === 0) {\n        return res.json({\n          consolidatedByCategory: {},\n        });\n      }\n      \n      // Get sales and categories\n      const allSales = await storage.getAllSales();\n      const categories = await storage.getAllCategories();\n      const products = await storage.getAllProducts();\n      \n      // Get manager's goals for the season (if seasonId provided)\n      let managerGoals: any = null;\n      if (seasonId) {\n        const goals = await db.select()\n          .from(seasonGoals)\n          .where(and(\n            eq(seasonGoals.userId, managerId),\n            eq(seasonGoals.seasonId, seasonId)\n          ))\n          .limit(1);\n        managerGoals = goals[0] || null;\n      }\n      \n      // Create product-to-category map (always use categoryId for aggregation)\n      const productCategoryMap = new Map<string, string>();\n      products.forEach(p => {\n        if (p.categoryId) {\n          productCategoryMap.set(p.id, p.categoryId);\n        }\n      });\n      \n      // Create category type map (categoryId -> type for segment mapping)\n      const categoryToType = new Map<string, string>();\n      categories.forEach(cat => {\n        categoryToType.set(cat.id, cat.type);\n      });\n      \n      // Aggregate sales by category for the team\n      const consolidatedByCategory: Record<string, {\n        categoryName: string;\n        cvaleAmount: number;\n        totalAmount: number;\n        percentage: number;\n        marketPercentage: number;\n      }> = {};\n      \n      // Initialize categories\n      categories.forEach(cat => {\n        consolidatedByCategory[cat.id] = {\n          categoryName: cat.name,\n          cvaleAmount: 0,\n          totalAmount: 0,\n          percentage: 0,\n          marketPercentage: 0,\n        };\n      });\n      \n      // Aggregate C.Vale sales (all sales in sales table are C.Vale)\n      const teamSales = seasonId \n        ? allSales.filter(s => teamIds.includes(s.userId) && s.seasonId === seasonId)\n        : allSales.filter(s => teamIds.includes(s.userId));\n      \n      teamSales.forEach(sale => {\n        const categoryId = productCategoryMap.get(sale.productId);\n        if (categoryId && consolidatedByCategory[categoryId]) {\n          const amount = parseFloat(sale.totalAmount || '0');\n          consolidatedByCategory[categoryId].cvaleAmount += amount;\n        }\n      });\n      \n      // Calculate C.Vale percentage: (vendas equipe / meta do gestor) * 100\n      if (managerGoals) {\n        const categoryMetaFieldMap: Record<string, string> = {\n          'Agroquímicos': 'metaAgroquimicos',\n          'Especialidades': 'metaEspecialidades',\n          'Fertilizantes': 'metaFertilizantes',\n          'Corretivos': 'metaCorretivos',\n          'Sementes Soja': 'metaSementesSoja',\n        };\n        \n        Object.keys(consolidatedByCategory).forEach(catId => {\n          const cat = consolidatedByCategory[catId];\n          const metaField = categoryMetaFieldMap[cat.categoryName];\n          if (metaField) {\n            const goalAmount = parseFloat((managerGoals as any)[metaField] || '0');\n            cat.percentage = goalAmount > 0 ? (cat.cvaleAmount / goalAmount) * 100 : 0;\n          }\n        });\n      }\n      \n      // Calculate Market percentage: (vendas + aplicações FECHADAS) / potencial total * 100\n      if (seasonId) {\n        // Get all client market rates for the team in this season\n        // Only include clients marked as includeInMarketArea\n        const teamMarketRates = await db.select()\n          .from(clientMarketRates)\n          .innerJoin(userClientLinks, eq(clientMarketRates.clientId, userClientLinks.id))\n          .innerJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n          .where(and(\n            inArray(userClientLinks.userId, teamIds),\n            eq(clientMarketRates.seasonId, seasonId),\n            eq(userClientLinks.includeInMarketArea, true)\n          ));\n        \n        // Calculate total potential by category\n        const potentialByCategory: Record<string, number> = {};\n        categories.forEach(cat => {\n          potentialByCategory[cat.id] = 0;\n        });\n        \n        teamMarketRates.forEach(rate => {\n          const categoryId = rate.client_market_rates.categoryId;\n          const plantingArea = parseFloat(rate.master_clients.plantingArea || '0');\n          const investmentPerHa = parseFloat(rate.client_market_rates.investmentPerHa || '0');\n          const potential = plantingArea * investmentPerHa;\n          \n          if (potentialByCategory.hasOwnProperty(categoryId)) {\n            potentialByCategory[categoryId] += potential;\n          }\n        });\n        \n        // Get all FECHADAS applications for the team in this season\n        const fechadasApplications = await db.select()\n          .from(clientApplicationTracking)\n          .leftJoin(globalManagementApplications, eq(clientApplicationTracking.globalApplicationId, globalManagementApplications.id))\n          .leftJoin(productsPriceTable, eq(globalManagementApplications.productId, productsPriceTable.id))\n          .leftJoin(userClientLinks, eq(clientApplicationTracking.clientId, userClientLinks.id))\n          .leftJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n          .where(and(\n            inArray(clientApplicationTracking.userId, teamIds),\n            eq(clientApplicationTracking.seasonId, seasonId),\n            eq(clientApplicationTracking.status, 'FECHADO')\n          ));\n        \n        // Aggregate FECHADAS by category\n        const fechadasByCategory: Record<string, number> = {};\n        categories.forEach(cat => {\n          fechadasByCategory[cat.id] = 0;\n        });\n        \n        fechadasApplications.forEach(app => {\n          if (!app.client_application_tracking || !app.global_management_applications) return;\n          \n          const pricePerHa = parseFloat(app.global_management_applications.pricePerHa || '0');\n          const plantingArea = app.master_clients ? parseFloat(app.master_clients.plantingArea || '0') : 0;\n          const totalValue = pricePerHa * plantingArea;\n          \n          // All fechadas applications are agroquímicos - find the agroquímicos category\n          const agroquimicosCategory = categories.find(cat => cat.type === 'agroquimicos');\n          if (agroquimicosCategory) {\n            if (!fechadasByCategory[agroquimicosCategory.id]) fechadasByCategory[agroquimicosCategory.id] = 0;\n            fechadasByCategory[agroquimicosCategory.id] += totalValue;\n          }\n        });\n        \n        // Calculate market percentage: (sales + fechadas) / potential * 100\n        Object.keys(consolidatedByCategory).forEach(catId => {\n          const cat = consolidatedByCategory[catId];\n          const potential = potentialByCategory[catId] || 0;\n          const sales = cat.cvaleAmount;\n          const fechadas = fechadasByCategory[catId] || 0;\n          const totalRealized = sales + fechadas;\n          \n          cat.marketPercentage = potential > 0 ? (totalRealized / potential) * 100 : 0;\n        });\n      }\n      \n      res.json({\n        consolidatedByCategory,\n      });\n    } catch (error) {\n      console.error(\"Error fetching team market analysis:\", error);\n      res.status(500).json({ error: \"Failed to fetch team market analysis\" });\n    }\n  });\n\n  // Get team captured totals (ONLY from ABERTO applications - new model)\n  // Does NOT include sales_targets (old Kanban model)\n  app.get(\"/api/manager/team-captured-totals\", requireManager, async (req, res) => {\n    try {\n      const { users, seasons, clientApplicationTracking, globalManagementApplications, userClientLinks, masterClients } = await import(\"@shared/schema\");\n      const { inArray, and, sql: sqlFn } = await import(\"drizzle-orm\");\n      const managerId = req.user!.id;\n      \n      // Get team member IDs\n      const teamMembers = await db\n        .select({ id: users.id })\n        .from(users)\n        .where(eq(users.managerId, managerId));\n      \n      const teamIds = teamMembers.map(m => m.id);\n      \n      if (teamIds.length === 0) {\n        return res.json({ totalsBySeason: {} });\n      }\n      \n      // Get all ABERTO applications (opportunities) for the team\n      // Only include clients marked as 80-20 (isTop80_20 = true)\n      const abertoApplications = await db\n        .select({\n          seasonId: clientApplicationTracking.seasonId,\n          seasonName: sqlFn`COALESCE(${seasons.name}, 'Safra sem nome')`.as('season_name'),\n          categoria: clientApplicationTracking.categoria,\n          subcategoria: globalManagementApplications.categoria,\n          applicationNumber: clientApplicationTracking.applicationNumber,\n          pricePerHa: globalManagementApplications.pricePerHa,\n          plantingArea: masterClients.plantingArea,\n        })\n        .from(clientApplicationTracking)\n        .leftJoin(seasons, eq(clientApplicationTracking.seasonId, seasons.id))\n        .leftJoin(globalManagementApplications, eq(clientApplicationTracking.globalApplicationId, globalManagementApplications.id))\n        .leftJoin(userClientLinks, eq(clientApplicationTracking.clientId, userClientLinks.id))\n        .leftJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n        .where(and(\n          inArray(clientApplicationTracking.userId, teamIds),\n          eq(clientApplicationTracking.status, 'ABERTO'),\n          eq(userClientLinks.isTop80_20, true)\n        ));\n      \n      // Map segment to category name\n      const segmentToCategoryName: Record<string, string> = {\n        'fertilizantes': 'Fertilizantes',\n        'agroquimicos': 'Agroquímicos',\n        'especialidades': 'Especialidades',\n        'sementes': 'Sementes',\n        'corretivos': 'Corretivos',\n      };\n      \n      // Map categoria to subcategory name\n      const categoriaToSubcategoryName: Record<string, string> = {\n        'FUNGICIDAS': 'Fungicidas',\n        'INSETICIDAS': 'Inseticidas',\n        'TRATAMENTO_SEMENTE': 'Tratamento de semente',\n        'DESSECACAO': 'Dessecação',\n      };\n      \n      // Aggregate by season, then by category\n      const totalsBySeason: Record<string, {\n        seasonName: string;\n        seasonTotal: number;\n        categories: Record<string, {\n          categoryName: string;\n          total: number;\n          subcategories?: Record<string, number>;\n        }>;\n      }> = {};\n      \n      // Process ABERTO applications (open opportunities)\n      abertoApplications.forEach(app => {\n        if (!app.pricePerHa || !app.plantingArea) return;\n        \n        const seasonId = app.seasonId;\n        const seasonName = String(app.seasonName || 'Safra sem nome');\n        \n        // Map category name to segmento (reverse lookup)\n        const categoryNameToSegment: Record<string, string> = {\n          'Fertilizantes': 'fertilizantes',\n          'Agroquímicos': 'agroquimicos',\n          'Especialidades': 'especialidades',\n          'Sementes': 'sementes',\n          'Corretivos': 'corretivos',\n        };\n        \n        const segmento = categoryNameToSegment[app.categoria] || app.categoria.toLowerCase();\n        const categoryName = app.categoria;\n        const pricePerHa = parseFloat(app.pricePerHa || '0');\n        const plantingArea = parseFloat(app.plantingArea || '0');\n        const valor = pricePerHa * plantingArea;\n        \n        // Initialize season if not exists\n        if (!totalsBySeason[seasonId]) {\n          totalsBySeason[seasonId] = {\n            seasonName,\n            seasonTotal: 0,\n            categories: {},\n          };\n        }\n        \n        // Add to season total\n        totalsBySeason[seasonId].seasonTotal += valor;\n        \n        // Initialize category if not exists\n        if (!totalsBySeason[seasonId].categories[segmento]) {\n          totalsBySeason[seasonId].categories[segmento] = {\n            categoryName,\n            total: 0,\n          };\n        }\n        \n        // Add to category total\n        totalsBySeason[seasonId].categories[segmento].total += valor;\n        \n        // Add to subcategory only for agroquimicos\n        if (segmento === 'agroquimicos' && app.subcategoria) {\n          const subcatName = categoriaToSubcategoryName[app.subcategoria] || app.subcategoria;\n          if (!totalsBySeason[seasonId].categories[segmento].subcategories) {\n            totalsBySeason[seasonId].categories[segmento].subcategories = {};\n          }\n          const subcat = totalsBySeason[seasonId].categories[segmento].subcategories!;\n          if (!subcat[subcatName]) {\n            subcat[subcatName] = 0;\n          }\n          subcat[subcatName] += valor;\n        }\n      });\n      \n      res.json({ totalsBySeason });\n    } catch (error) {\n      console.error(\"Error fetching team captured totals:\", error);\n      res.status(500).json({ error: \"Failed to fetch team captured totals\" });\n    }\n  });\n\n  // Get team captured targets by category (with client details)\n  // IMPORTANT: Only shows clients with isTop80_20 = true (green badge)\n  // Uses ONLY ABERTO applications (new model), NOT sales_targets (old Kanban)\n  app.get(\"/api/manager/team-captured-by-category/:segmento\", requireManager, async (req, res) => {\n    try {\n      const { users, userClientLinks, masterClients, clientApplicationTracking, globalManagementApplications } = await import(\"@shared/schema\");\n      const { inArray } = await import(\"drizzle-orm\");\n      const managerId = req.user!.id;\n      const { segmento } = req.params;\n      const seasonId = req.query.seasonId as string;\n      \n      if (!seasonId) {\n        return res.status(400).json({ error: \"seasonId is required\" });\n      }\n      \n      // Get team member IDs\n      const teamMembers = await db\n        .select({ id: users.id, username: users.username })\n        .from(users)\n        .where(eq(users.managerId, managerId));\n      \n      const teamIds = teamMembers.map(m => m.id);\n      \n      if (teamIds.length === 0) {\n        return res.json({ clientTargets: [] });\n      }\n      \n      // Map segment to category name for applications\n      const segmentToCategoryName: Record<string, string> = {\n        'fertilizantes': 'Fertilizantes',\n        'agroquimicos': 'Agroquímicos',\n        'especialidades': 'Especialidades',\n        'sementes': 'Sementes',\n      };\n      const categoryName = segmentToCategoryName[segmento.toLowerCase()];\n      \n      // Get ABERTO applications for this category AND season (only 80-20 clients)\n      let abertoApplications: Array<{\n        clientId: string;\n        userId: string;\n        pricePerHa: string | null;\n        plantingArea: string | null;\n        applicationNumber: number;\n        applicationSubcategory: string | null;\n      }> = [];\n      \n      if (categoryName) {\n        abertoApplications = await db\n          .select({\n            clientId: clientApplicationTracking.clientId,\n            userId: clientApplicationTracking.userId,\n            pricePerHa: globalManagementApplications.pricePerHa,\n            plantingArea: masterClients.plantingArea,\n            applicationNumber: clientApplicationTracking.applicationNumber,\n            applicationSubcategory: globalManagementApplications.categoria,\n          })\n          .from(clientApplicationTracking)\n          .leftJoin(globalManagementApplications, eq(clientApplicationTracking.globalApplicationId, globalManagementApplications.id))\n          .leftJoin(userClientLinks, eq(clientApplicationTracking.clientId, userClientLinks.id))\n          .leftJoin(masterClients, eq(userClientLinks.masterClientId, masterClients.id))\n          .where(and(\n            inArray(clientApplicationTracking.userId, teamIds),\n            eq(clientApplicationTracking.status, 'ABERTO'),\n            eq(clientApplicationTracking.categoria, categoryName),\n            eq(clientApplicationTracking.seasonId, seasonId),\n            eq(userClientLinks.isTop80_20, true)\n          ));\n      }\n      \n      // Aggregate by client\n      const clientMap = new Map<string, {\n        clientId: string;\n        userId: string;\n        valorCapturado: number;\n        subcategories: Record<string, number> | null;\n      }>();\n      \n      // Process ABERTO applications\n      abertoApplications.forEach(app => {\n        const pricePerHa = parseFloat(app.pricePerHa || '0');\n        const plantingArea = parseFloat(app.plantingArea || '0');\n        const totalValue = pricePerHa * plantingArea;\n        \n        if (!clientMap.has(app.clientId)) {\n          clientMap.set(app.clientId, {\n            clientId: app.clientId,\n            userId: app.userId,\n            valorCapturado: totalValue,\n            subcategories: null,\n          });\n        } else {\n          const existing = clientMap.get(app.clientId)!;\n          existing.valorCapturado += totalValue;\n        }\n        \n        // Handle subcategories for agroquimicos\n        if (segmento.toLowerCase() === 'agroquimicos' && app.applicationSubcategory) {\n          const existing = clientMap.get(app.clientId)!;\n          if (!existing.subcategories) {\n            existing.subcategories = {};\n          }\n          if (!existing.subcategories[app.applicationSubcategory]) {\n            existing.subcategories[app.applicationSubcategory] = 0;\n          }\n          existing.subcategories[app.applicationSubcategory] += totalValue;\n        }\n      });\n      \n      // Get client details for all unique clients\n      const uniqueClientIds = Array.from(clientMap.keys());\n      if (uniqueClientIds.length === 0) {\n        return res.json({ clientTargets: [] });\n      }\n      \n      const userClientLinksData = await db\n        .select()\n        .from(userClientLinks)\n        .where(inArray(userClientLinks.id, uniqueClientIds));\n      \n      const masterClientIds = userClientLinksData.map(link => link.masterClientId);\n      const masterClientsData = await db\n        .select()\n        .from(masterClients)\n        .where(inArray(masterClients.id, masterClientIds));\n      \n      // Build response with client details\n      const clientTargets = Array.from(clientMap.values()).map(clientData => {\n        const userClientLink = userClientLinksData.find(link => link.id === clientData.clientId);\n        const masterClient = masterClientsData.find(mc => mc.id === userClientLink?.masterClientId);\n        const consultor = teamMembers.find(m => m.id === clientData.userId);\n        \n        return {\n          clientId: clientData.clientId,\n          clientName: masterClient?.name || 'Cliente Desconhecido',\n          consultorName: consultor?.username || 'Desconhecido',\n          valorCapturado: clientData.valorCapturado,\n          subcategories: clientData.subcategories,\n        };\n      });\n      \n      // Sort by value descending\n      clientTargets.sort((a, b) => b.valorCapturado - a.valorCapturado);\n      \n      res.json({ clientTargets });\n    } catch (error) {\n      console.error(\"Error fetching team captured by category:\", error);\n      res.status(500).json({ error: \"Failed to fetch team captured by category\" });\n    }\n  });\n\n  // Action Plans CRUD\n  app.get(\"/api/manager/action-plans\", requireManager, async (req, res) => {\n    try {\n      const { actionPlans } = await import(\"@shared/schema\");\n      const managerId = req.user!.id;\n      \n      const plans = await db\n        .select()\n        .from(actionPlans)\n        .where(eq(actionPlans.managerId, managerId));\n      \n      res.json(plans);\n    } catch (error) {\n      console.error(\"Error fetching action plans:\", error);\n      res.status(500).json({ error: \"Failed to fetch action plans\" });\n    }\n  });\n\n  app.post(\"/api/manager/action-plans\", requireManager, async (req, res) => {\n    try {\n      const { actionPlans, seasons } = await import(\"@shared/schema\");\n      const { title, meetingDate, strengths, challenges, opportunities, nextMeetingDate } = req.body;\n      \n      // Get active season\n      const [activeSeason] = await db\n        .select()\n        .from(seasons)\n        .where(eq(seasons.isActive, true))\n        .limit(1);\n      \n      if (!activeSeason) {\n        return res.status(400).json({ error: \"No active season found\" });\n      }\n      \n      const [plan] = await db.insert(actionPlans).values({\n        title,\n        managerId: req.user!.id,\n        seasonId: activeSeason.id,\n        meetingDate: new Date(meetingDate),\n        targetAmount: \"0\",\n        currentAmount: \"0\",\n        status: \"planejado\",\n        strengths: strengths || null,\n        challenges: challenges || null,\n        opportunities: opportunities || null,\n        nextMeetingDate: nextMeetingDate ? new Date(nextMeetingDate) : null,\n      }).returning();\n      \n      res.json(plan);\n    } catch (error) {\n      console.error(\"Error creating action plan:\", error);\n      res.status(400).json({ error: \"Failed to create action plan\" });\n    }\n  });\n\n  app.get(\"/api/manager/action-plans/:id\", requireManager, async (req, res) => {\n    try {\n      const { actionPlans, actionPlanItems, actionPlanParticipants } = await import(\"@shared/schema\");\n      const planId = req.params.id;\n      \n      const [plan] = await db\n        .select()\n        .from(actionPlans)\n        .where(eq(actionPlans.id, planId));\n      \n      if (!plan) {\n        return res.status(404).json({ error: \"Action plan not found\" });\n      }\n      \n      if (plan.managerId !== req.user!.id) {\n        return res.status(403).json({ error: \"Forbidden\" });\n      }\n      \n      const items = await db\n        .select()\n        .from(actionPlanItems)\n        .where(eq(actionPlanItems.planId, planId));\n      \n      const participants = await db\n        .select()\n        .from(actionPlanParticipants)\n        .where(eq(actionPlanParticipants.planId, planId));\n      \n      res.json({ ...plan, items, participants });\n    } catch (error) {\n      console.error(\"Error fetching action plan:\", error);\n      res.status(500).json({ error: \"Failed to fetch action plan\" });\n    }\n  });\n\n  app.patch(\"/api/manager/action-plans/:id\", requireManager, async (req, res) => {\n    try {\n      const { actionPlans } = await import(\"@shared/schema\");\n      const planId = req.params.id;\n      \n      const [existing] = await db\n        .select()\n        .from(actionPlans)\n        .where(eq(actionPlans.id, planId));\n      \n      if (!existing || existing.managerId !== req.user!.id) {\n        return res.status(404).json({ error: \"Action plan not found\" });\n      }\n      \n      const [updated] = await db\n        .update(actionPlans)\n        .set({ ...req.body, updatedAt: sql`now()` })\n        .where(eq(actionPlans.id, planId))\n        .returning();\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating action plan:\", error);\n      res.status(400).json({ error: \"Failed to update action plan\" });\n    }\n  });\n\n  app.delete(\"/api/manager/action-plans/:id\", requireManager, async (req, res) => {\n    try {\n      const { actionPlans } = await import(\"@shared/schema\");\n      const planId = req.params.id;\n      \n      const [existing] = await db\n        .select()\n        .from(actionPlans)\n        .where(eq(actionPlans.id, planId));\n      \n      if (!existing || existing.managerId !== req.user!.id) {\n        return res.status(404).json({ error: \"Action plan not found\" });\n      }\n      \n      await db.delete(actionPlans).where(eq(actionPlans.id, planId));\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting action plan:\", error);\n      res.status(500).json({ error: \"Failed to delete action plan\" });\n    }\n  });\n\n  // Action Plan Items CRUD\n  app.post(\"/api/manager/action-plans/:planId/items\", requireManager, async (req, res) => {\n    try {\n      const { actionPlans, actionPlanItems, insertActionPlanItemSchema } = await import(\"@shared/schema\");\n      const planId = req.params.planId;\n      \n      const [plan] = await db\n        .select()\n        .from(actionPlans)\n        .where(eq(actionPlans.id, planId));\n      \n      if (!plan || plan.managerId !== req.user!.id) {\n        return res.status(404).json({ error: \"Action plan not found\" });\n      }\n      \n      const data = insertActionPlanItemSchema.parse(req.body);\n      \n      const [item] = await db.insert(actionPlanItems).values({\n        ...data,\n        planId,\n      }).returning();\n      \n      res.json(item);\n    } catch (error) {\n      console.error(\"Error creating action plan item:\", error);\n      res.status(400).json({ error: \"Failed to create action plan item\" });\n    }\n  });\n\n  app.patch(\"/api/manager/action-plan-items/:id\", requireManager, async (req, res) => {\n    try {\n      const { actionPlanItems, actionPlans } = await import(\"@shared/schema\");\n      const itemId = req.params.id;\n      \n      const [item] = await db\n        .select()\n        .from(actionPlanItems)\n        .where(eq(actionPlanItems.id, itemId));\n      \n      if (!item) {\n        return res.status(404).json({ error: \"Action plan item not found\" });\n      }\n      \n      const [plan] = await db\n        .select()\n        .from(actionPlans)\n        .where(eq(actionPlans.id, item.planId));\n      \n      if (!plan || plan.managerId !== req.user!.id) {\n        return res.status(403).json({ error: \"Forbidden\" });\n      }\n      \n      const [updated] = await db\n        .update(actionPlanItems)\n        .set(req.body)\n        .where(eq(actionPlanItems.id, itemId))\n        .returning();\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating action plan item:\", error);\n      res.status(400).json({ error: \"Failed to update action plan item\" });\n    }\n  });\n\n  app.delete(\"/api/manager/action-plan-items/:id\", requireManager, async (req, res) => {\n    try {\n      const { actionPlanItems, actionPlans } = await import(\"@shared/schema\");\n      const itemId = req.params.id;\n      \n      const [item] = await db\n        .select()\n        .from(actionPlanItems)\n        .where(eq(actionPlanItems.id, itemId));\n      \n      if (!item) {\n        return res.status(404).json({ error: \"Action plan item not found\" });\n      }\n      \n      const [plan] = await db\n        .select()\n        .from(actionPlans)\n        .where(eq(actionPlans.id, item.planId));\n      \n      if (!plan || plan.managerId !== req.user!.id) {\n        return res.status(403).json({ error: \"Forbidden\" });\n      }\n      \n      await db.delete(actionPlanItems).where(eq(actionPlanItems.id, itemId));\n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting action plan item:\", error);\n      res.status(500).json({ error: \"Failed to delete action plan item\" });\n    }\n  });\n\n  // Consultor endpoints - view assigned actions\n  app.get(\"/api/consultor/my-actions\", requireAuth, async (req, res) => {\n    try {\n      const { actionPlanItems } = await import(\"@shared/schema\");\n      const userId = req.user!.id;\n      \n      const actions = await db\n        .select()\n        .from(actionPlanItems)\n        .where(eq(actionPlanItems.consultorId, userId));\n      \n      res.json(actions);\n    } catch (error) {\n      console.error(\"Error fetching consultor actions:\", error);\n      res.status(500).json({ error: \"Failed to fetch actions\" });\n    }\n  });\n\n  app.patch(\"/api/consultor/actions/:id\", requireAuth, async (req, res) => {\n    try {\n      const { actionPlanItems } = await import(\"@shared/schema\");\n      const actionId = req.params.id;\n      const userId = req.user!.id;\n      \n      const [action] = await db\n        .select()\n        .from(actionPlanItems)\n        .where(eq(actionPlanItems.id, actionId));\n      \n      if (!action || action.consultorId !== userId) {\n        return res.status(404).json({ error: \"Action not found\" });\n      }\n      \n      const [updated] = await db\n        .update(actionPlanItems)\n        .set(req.body)\n        .where(eq(actionPlanItems.id, actionId))\n        .returning();\n      \n      res.json(updated);\n    } catch (error) {\n      console.error(\"Error updating action:\", error);\n      res.status(400).json({ error: \"Failed to update action\" });\n    }\n  });\n\n  // Commodity price endpoint - Soybean price from Twelve Data\n  app.get(\"/api/commodity/soybean\", requireAuth, async (req, res) => {\n    try {\n      const apiKey = process.env.TWELVE_DATA_API_KEY;\n      \n      if (!apiKey) {\n        return res.status(500).json({ error: \"API key not configured\" });\n      }\n\n      // Try soybean futures symbol ZS (CBOT)\n      const response = await fetch(`https://api.twelvedata.com/price?symbol=ZS&apikey=${apiKey}`);\n\n      if (!response.ok) {\n        throw new Error(`Twelve Data API returned ${response.status}`);\n      }\n\n      const data = await response.json();\n      \n      // Check if we got a valid price\n      if (data.price) {\n        res.json({ \n          price: parseFloat(data.price),\n          name: 'Soybean Futures',\n          unit: 'per bushel'\n        });\n      } else if (data.status === 'error') {\n        throw new Error(data.message || 'API error');\n      } else {\n        throw new Error('Invalid response format from API');\n      }\n    } catch (error) {\n      console.error(\"Error fetching soybean price:\", error);\n      res.status(500).json({ error: \"Failed to fetch commodity price\" });\n    }\n  });\n\n  // Faturista endpoints - Inventory Control System\n  const requireFaturista = (req: any, res: any, next: any) => {\n    if (!req.user || req.user.role !== 'faturista') {\n      return res.status(403).json({ error: \"Access denied. Faturista role required.\" });\n    }\n    next();\n  };\n\n  // Create upload session\n  app.post(\"/api/faturista/upload-session\", requireFaturista, async (req, res) => {\n    try {\n      const { uploadSessions, insertUploadSessionSchema } = await import(\"@shared/schema\");\n      const sessionData = insertUploadSessionSchema.parse({\n        ...req.body,\n        userId: req.user!.id\n      });\n\n      const [session] = await db.insert(uploadSessions).values(sessionData).returning();\n      res.status(201).json(session);\n    } catch (error) {\n      console.error(\"Error creating upload session:\", error);\n      res.status(400).json({ error: \"Failed to create upload session\" });\n    }\n  });\n\n  // Upload inventory PDF\n  app.post(\"/api/faturista/upload-inventory\", requireFaturista, upload.single(\"file\"), async (req, res) => {\n    try {\n      const { inventoryItems, uploadSessions } = await import(\"@shared/schema\");\n      const { parseInventoryPDF } = await import(\"./parse-inventory-pdf\");\n\n      if (!req.file) {\n        return res.status(400).json({ error: \"No file uploaded\" });\n      }\n\n      const sessionId = req.body.sessionId;\n      if (!sessionId) {\n        return res.status(400).json({ error: \"Session ID is required\" });\n      }\n\n      // Verify session exists and belongs to user\n      const [session] = await db\n        .select()\n        .from(uploadSessions)\n        .where(eq(uploadSessions.id, sessionId));\n\n      if (!session || session.userId !== req.user!.id) {\n        return res.status(404).json({ error: \"Session not found\" });\n      }\n\n      const parsedItems = await parseInventoryPDF(req.file.buffer);\n\n      if (!parsedItems || parsedItems.length === 0) {\n        return res.status(400).json({ \n          error: \"Nenhum item foi encontrado no PDF. Verifique se o formato está correto (C.VALE com colunas: Cód.Int, Mercaderia, Embalaje, Cantidad).\" \n        });\n      }\n\n      // Insert inventory items\n      const items = await db.insert(inventoryItems).values(\n        parsedItems.map(item => ({\n          productCode: item.productCode,\n          productName: item.productName,\n          packageType: item.packageType || '',\n          quantity: item.quantity.toString(),\n          uploadedBy: req.user!.id,\n          uploadSessionId: sessionId\n        }))\n      ).returning();\n\n      // Update session with inventory file name\n      await db\n        .update(uploadSessions)\n        .set({ inventoryFileName: req.file.originalname })\n        .where(eq(uploadSessions.id, sessionId));\n\n      res.json({ \n        success: true, \n        itemsCount: items.length,\n        items \n      });\n    } catch (error) {\n      console.error(\"Error uploading inventory:\", error);\n      res.status(500).json({ error: \"Failed to upload inventory\" });\n    }\n  });\n\n  // Upload orders PDF(s)\n  app.post(\"/api/faturista/upload-orders\", requireFaturista, upload.array(\"files\", 10), async (req, res) => {\n    try {\n      const { pendingOrders, uploadSessions } = await import(\"@shared/schema\");\n      const { parseOrdersPDF } = await import(\"./parse-inventory-pdf\");\n\n      if (!req.files || !Array.isArray(req.files) || req.files.length === 0) {\n        return res.status(400).json({ error: \"No files uploaded\" });\n      }\n\n      const sessionId = req.body.sessionId;\n      if (!sessionId) {\n        return res.status(400).json({ error: \"Session ID is required\" });\n      }\n\n      // Verify session exists and belongs to user\n      const [session] = await db\n        .select()\n        .from(uploadSessions)\n        .where(eq(uploadSessions.id, sessionId));\n\n      if (!session || session.userId !== req.user!.id) {\n        return res.status(404).json({ error: \"Session not found\" });\n      }\n\n      let allOrders: any[] = [];\n\n      // Parse all PDFs\n      for (const file of req.files) {\n        const parsedOrders = await parseOrdersPDF(file.buffer);\n        allOrders = allOrders.concat(parsedOrders);\n      }\n\n      if (!allOrders || allOrders.length === 0) {\n        return res.status(400).json({ \n          error: \"Nenhum pedido foi encontrado nos PDFs. Verifique se o formato está correto (C.VALE com colunas: Cód.Int, Mercaderia, Cant. Falta, Cliente, Vendedor).\" \n        });\n      }\n\n      // Insert pending orders\n      const orders = await db.insert(pendingOrders).values(\n        allOrders.map(order => ({\n          productCode: order.productCode,\n          productName: order.productName,\n          packageType: order.packageType || '',\n          quantityPending: order.quantityPending.toString(),\n          clientName: order.clientName,\n          consultorName: order.consultorName || null,\n          orderCode: order.orderCode || null,\n          uploadedBy: req.user!.id,\n          uploadSessionId: sessionId\n        }))\n      ).returning();\n\n      // Update session with order files count\n      await db\n        .update(uploadSessions)\n        .set({ orderFilesCount: req.files.length })\n        .where(eq(uploadSessions.id, sessionId));\n\n      res.json({ \n        success: true, \n        ordersCount: orders.length,\n        filesProcessed: req.files.length,\n        orders \n      });\n    } catch (error) {\n      console.error(\"Error uploading orders:\", error);\n      res.status(500).json({ error: \"Failed to upload orders\" });\n    }\n  });\n\n  // Analyze stock availability\n  app.post(\"/api/faturista/analyze-stock\", requireFaturista, async (req, res) => {\n    try {\n      const { stockAnalysisResults, inventoryItems, pendingOrders, uploadSessions } = await import(\"@shared/schema\");\n\n      const sessionId = req.body.sessionId;\n      if (!sessionId) {\n        return res.status(400).json({ error: \"Session ID is required\" });\n      }\n\n      // Verify session exists and belongs to user\n      const [session] = await db\n        .select()\n        .from(uploadSessions)\n        .where(eq(uploadSessions.id, sessionId));\n\n      if (!session || session.userId !== req.user!.id) {\n        return res.status(404).json({ error: \"Session not found\" });\n      }\n\n      // Get inventory items for this session\n      const inventory = await db\n        .select()\n        .from(inventoryItems)\n        .where(eq(inventoryItems.uploadSessionId, sessionId));\n\n      // Get pending orders for this session\n      const orders = await db\n        .select()\n        .from(pendingOrders)\n        .where(eq(pendingOrders.uploadSessionId, sessionId));\n\n      // Group orders by product code\n      const ordersByProduct = orders.reduce((acc, order) => {\n        if (!acc[order.productCode]) {\n          acc[order.productCode] = {\n            totalQuantity: 0,\n            clients: []\n          };\n        }\n        acc[order.productCode].totalQuantity += parseFloat(order.quantityPending);\n        acc[order.productCode].clients.push({\n          clientName: order.clientName,\n          quantity: parseFloat(order.quantityPending)\n        });\n        return acc;\n      }, {} as Record<string, { totalQuantity: number; clients: Array<{ clientName: string; quantity: number }> }>);\n      \n      console.log('=== ORDERS BY PRODUCT ===');\n      console.log('Order codes:', Object.keys(ordersByProduct).slice(0, 10));\n      console.log('Total order types:', Object.keys(ordersByProduct).length);\n\n      // Calculate availability for each inventory item\n      const analysisResults = [];\n      \n      console.log('=== INVENTORY ITEMS ===');\n      console.log('First 10 inventory codes:', inventory.slice(0, 10).map(i => i.productCode));\n      console.log('Total inventory items:', inventory.length);\n\n      for (const item of inventory) {\n        const stockQty = parseFloat(item.quantity);\n        const ordersData = ordersByProduct[item.productCode];\n        const ordersQty = ordersData ? ordersData.totalQuantity : 0;\n        \n        if (ordersQty > 0) {\n          console.log(`Match found: ${item.productCode} - Stock: ${stockQty}, Orders: ${ordersQty}`);\n        }\n        \n        let status = 'DISPONÍVEL';\n        let percentage = 100;\n\n        if (ordersQty > 0) {\n          percentage = (stockQty / ordersQty) * 100;\n          \n          // Limit percentage to 999.99 (database constraint)\n          if (percentage > 999.99) {\n            percentage = 999.99;\n          }\n          \n          if (percentage >= 100) {\n            status = 'DISPONÍVEL';\n          } else if (percentage >= 50) {\n            status = 'PARCIAL';\n          } else if (percentage > 0) {\n            status = 'CRÍTICO';\n          } else {\n            status = 'INDISPONÍVEL';\n          }\n        }\n\n        const result = {\n          productCode: item.productCode,\n          productName: item.productName,\n          stockQuantity: stockQty.toString(),\n          ordersQuantity: ordersQty.toString(),\n          status,\n          percentage: percentage.toFixed(2),\n          clientsList: ordersData ? ordersData.clients : [],\n          uploadSessionId: sessionId,\n          createdBy: req.user!.id\n        };\n\n        analysisResults.push(result);\n      }\n\n      // Insert analysis results\n      const results = await db.insert(stockAnalysisResults).values(analysisResults).returning();\n\n      // Update session status\n      await db\n        .update(uploadSessions)\n        .set({ \n          status: 'completed',\n          completedAt: new Date()\n        })\n        .where(eq(uploadSessions.id, sessionId));\n\n      res.json({ \n        success: true,\n        resultsCount: results.length,\n        results\n      });\n    } catch (error) {\n      console.error(\"Error analyzing stock:\", error);\n      res.status(500).json({ error: \"Failed to analyze stock\" });\n    }\n  });\n\n  // Get all sessions for user\n  app.get(\"/api/faturista/sessions\", requireFaturista, async (req, res) => {\n    try {\n      const { uploadSessions } = await import(\"@shared/schema\");\n\n      const sessions = await db\n        .select()\n        .from(uploadSessions)\n        .where(eq(uploadSessions.userId, req.user!.id))\n        .orderBy(sql`${uploadSessions.createdAt} DESC`);\n\n      res.json(sessions);\n    } catch (error) {\n      console.error(\"Error fetching sessions:\", error);\n      res.status(500).json({ error: \"Failed to fetch sessions\" });\n    }\n  });\n\n  // Get analysis results for a session\n  app.get(\"/api/faturista/analysis/:sessionId\", requireFaturista, async (req, res) => {\n    try {\n      const { stockAnalysisResults, uploadSessions } = await import(\"@shared/schema\");\n      const sessionId = req.params.sessionId;\n\n      // Verify session exists and belongs to user\n      const [session] = await db\n        .select()\n        .from(uploadSessions)\n        .where(eq(uploadSessions.id, sessionId));\n\n      if (!session || session.userId !== req.user!.id) {\n        return res.status(404).json({ error: \"Session not found\" });\n      }\n\n      const results = await db\n        .select()\n        .from(stockAnalysisResults)\n        .where(eq(stockAnalysisResults.uploadSessionId, sessionId))\n        .orderBy(\n          sql`CASE \n            WHEN ${stockAnalysisResults.status} = 'INDISPONÍVEL' THEN 1\n            WHEN ${stockAnalysisResults.status} = 'CRÍTICO' THEN 2\n            WHEN ${stockAnalysisResults.status} = 'PARCIAL' THEN 3\n            ELSE 4\n          END`,\n          sql`CAST(${stockAnalysisResults.percentage} AS DECIMAL)`\n        );\n\n      res.json(results);\n    } catch (error) {\n      console.error(\"Error fetching analysis:\", error);\n      res.status(500).json({ error: \"Failed to fetch analysis\" });\n    }\n  });\n\n  // Delete session (cascade will delete related data)\n  app.delete(\"/api/faturista/session/:id\", requireFaturista, async (req, res) => {\n    try {\n      const { uploadSessions } = await import(\"@shared/schema\");\n      const sessionId = req.params.id;\n\n      // Verify session exists and belongs to user\n      const [session] = await db\n        .select()\n        .from(uploadSessions)\n        .where(eq(uploadSessions.id, sessionId));\n\n      if (!session || session.userId !== req.user!.id) {\n        return res.status(404).json({ error: \"Session not found\" });\n      }\n\n      await db.delete(uploadSessions).where(eq(uploadSessions.id, sessionId));\n      \n      res.json({ success: true });\n    } catch (error) {\n      console.error(\"Error deleting session:\", error);\n      res.status(500).json({ error: \"Failed to delete session\" });\n    }\n  });\n\n  // ============ CRM MOBILE ROUTES ============\n  const { CRMStorage } = await import(\"./storage-crm\");\n  const { parseAgenda } = await import(\"./services/nlp.service\");\n\n  // VISITS\n  app.get(\"/api/visits\", requireAuth, async (req: any, res) => {\n    const { assignee, updated_since } = req.query as { assignee?: string; updated_since?: string };\n    const data = await CRMStorage.getVisits({ assignee, updatedSince: updated_since });\n    \n    // Enrich visits with farm coordinates\n    const enriched = await Promise.all(data.map(async (visit: any) => {\n      if (visit.farm_id) {\n        const [farm] = await db.select().from(farms).where(eq(farms.id, visit.farm_id)).limit(1);\n        if (farm) {\n          return { ...visit, lat: farm.lat, lng: farm.lng };\n        }\n      }\n      return visit;\n    }));\n    \n    res.json(enriched);\n  });\n\n  app.get(\"/api/visits/route\", requireAuth, async (req: any, res) => {\n    const { assignee, date } = req.query as { assignee?: string; date?: string };\n    const data = await CRMStorage.getRoute({ assignee, date });\n    res.json(data);\n  });\n\n  app.post(\"/api/visits\", requireAuth, async (req: any, res) => {\n    const payload = Array.isArray(req.body) ? req.body : [req.body];\n    \n    console.log('📥 [DEBUG] POST /api/visits - Payload recebido:', JSON.stringify(payload, null, 2));\n    \n    // Validação: client_id é obrigatório e não pode ser vazio\n    const invalidItems = payload.filter((v: any) => {\n      const clientId = v.clientId || v.client_id;\n      const isInvalid = !clientId || (typeof clientId === 'string' && clientId.trim() === '');\n      \n      if (isInvalid) {\n        console.log('❌ Item inválido detectado:', { \n          id: v.id, \n          clientId: v.clientId, \n          client_id: v.client_id,\n          notes: v.notes \n        });\n      }\n      \n      return isInvalid;\n    });\n    \n    if (invalidItems.length > 0) {\n      console.error('❌ Visitas inválidas sem client_id:', invalidItems);\n      return res.status(400).json({ \n        error: \"client_id é obrigatório para todas as visitas\",\n        invalid_count: invalidItems.length,\n        invalid_items: invalidItems.map((v: any) => ({ id: v.id, notes: v.notes }))\n      });\n    }\n    \n    const created = await CRMStorage.createVisitsBulk(payload);\n    res.status(201).json(created);\n  });\n\n  app.patch(\"/api/visits/:id\", requireAuth, async (req: any, res) => {\n    const { id } = req.params;\n    const data = req.body;\n    \n    // Validação: se client_id estiver presente, não pode ser vazio\n    if (data.client_id !== undefined) {\n      if (!data.client_id || (typeof data.client_id === 'string' && data.client_id.trim() === '')) {\n        return res.status(400).json({ error: \"client_id não pode ser vazio\" });\n      }\n    }\n    \n    const [updated] = await db.update(visits)\n      .set({ ...data, updatedAt: new Date() })\n      .where(eq(visits.id, id))\n      .returning();\n    \n    if (!updated) {\n      return res.status(404).json({ error: \"Visita não encontrada\" });\n    }\n    \n    res.json(updated);\n  });\n\n  app.patch(\"/api/visits/:id/status\", requireAuth, async (req: any, res) => {\n    const { id } = req.params; \n    const { status } = req.body as { status: any };\n    const updated = await CRMStorage.updateVisitStatus(id, status);\n    res.json(updated);\n  });\n\n  // TRIPS\n  app.post(\"/api/trips/start\", requireAuth, async (req: any, res) => {\n    const { visit_id, gps, odometer, op_id } = req.body || {};\n    if (!visit_id) return res.status(400).json({ error: \"visit_id é obrigatório\" });\n    const trip = await CRMStorage.startTrip({\n      visitId: visit_id,\n      odometer: odometer ?? null,\n      gps: gps ?? null,\n      opId: op_id ?? null,\n      actor: req.user?.id ?? null\n    });\n    res.status(201).json(trip);\n  });\n\n  app.post(\"/api/trips/gps\", requireAuth, async (req: any, res) => {\n    const batch = Array.isArray(req.body) ? req.body : [];\n    const n = await CRMStorage.appendGpsBatch(batch);\n    res.json({ inserted: n });\n  });\n\n  app.post(\"/api/trips/:id/end\", requireAuth, async (req: any, res) => {\n    const { id } = req.params; \n    const { odometer } = req.body || {};\n    const t = await CRMStorage.endTrip(id, odometer ?? null);\n    res.json({ ok: true, trip: t });\n  });\n\n  // CHECKLISTS\n  app.post(\"/api/checklists/:visitId\", requireAuth, async (req: any, res) => {\n    const { visitId } = req.params;\n    const { template, answers, photos, signatures, finished } = req.body || {};\n    const checklist = await CRMStorage.saveChecklist(visitId, {\n      template, answers, photos, signatures, finished\n    });\n    res.status(201).json(checklist);\n  });\n\n  // FARMS & FIELDS\n  app.get(\"/api/farms\", requireAuth, async (req: any, res) => {\n    const farmsData = await db.select().from(farms);\n    res.json(farmsData);\n  });\n\n  app.post(\"/api/farms\", requireAuth, async (req: any, res) => {\n    const data = insertFarmSchema.parse(req.body);\n    const [created] = await db.insert(farms).values(data).returning();\n    res.status(201).json(created);\n  });\n\n  app.delete(\"/api/farms/:id\", requireAuth, async (req: any, res) => {\n    const { id } = req.params;\n    await db.delete(farms).where(eq(farms.id, id));\n    res.json({ success: true });\n  });\n\n  app.get(\"/api/fields\", requireAuth, async (req: any, res) => {\n    const { farm_id } = req.query;\n    const query = farm_id \n      ? db.select().from(fields).where(eq(fields.farmId, farm_id as string))\n      : db.select().from(fields);\n    const data = await query;\n    res.json(data);\n  });\n\n  app.post(\"/api/fields\", requireAuth, async (req: any, res) => {\n    const data = insertFieldSchema.parse(req.body);\n    const [created] = await db.insert(fields).values(data).returning();\n    res.status(201).json(created);\n  });\n\n  // GEO\n  app.get(\"/api/geo/fields/:id/contains\", requireAuth, async (req: any, res) => {\n    const { id } = req.params; \n    const { lat, lng } = req.query as any;\n    if (!lat || !lng) return res.status(400).json({ error: \"lat/lng obrigatórios\" });\n    const inside = await CRMStorage.pointInsideField(id, parseFloat(lat), parseFloat(lng));\n    res.json({ inside });\n  });\n\n  // AGENDA (texto → visitas)\n  app.post(\"/api/agenda/parse\", requireAuth, async (req: any, res) => {\n    const { text } = req.body || {};\n    if (!text) return res.status(400).json({ error: \"text é obrigatório\" });\n    const parsed = await parseAgenda(text);\n    res.json({ items: parsed.map(p => ({ ...p, match_ok: !!p.client_id })) });\n  });\n\n  app.post(\"/api/agenda/confirm\", requireAuth, async (req: any, res) => {\n    const { items } = req.body || {};\n    if (!Array.isArray(items) || items.length === 0) return res.status(400).json({ error: \"items vazio\" });\n    \n    // Filtra apenas items com client_id válido\n    const validItems = items.filter(v => v.client_id);\n    const invalidItems = items.filter(v => !v.client_id);\n    \n    if (validItems.length === 0) {\n      return res.status(400).json({ \n        error: \"Nenhum cliente reconhecido\",\n        invalid: invalidItems.map(i => i.client_name || i.notes || \"Item desconhecido\")\n      });\n    }\n    \n    const payload = validItems.map((v: any) => ({\n      clientId: v.client_id,\n      farmId: v.farm_id ?? null,\n      fieldId: v.field_id ?? null,\n      scheduledAt: v.date ? new Date(`${v.date}T${v.time ? v.time : \"09:00\"}:00-03:00`) : new Date(),\n      windowStart: v.date ? new Date(`${v.date}T${v.time ? v.time : \"09:00\"}:00-03:00`) : new Date(),\n      windowEnd: null,\n      status: \"PLANEJADA\" as const,\n      assignee: req.user?.id ?? null,\n      notes: v.notes ?? null\n    }));\n    \n    const created = await CRMStorage.createVisitsBulk(payload);\n    \n    res.status(201).json({ \n      created: created.length, \n      visits: created,\n      skipped: invalidItems.length,\n      invalid_items: invalidItems.map(i => i.client_name || i.notes || \"Item desconhecido\")\n    });\n  });\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","size_bytes":273303},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","size_bytes":1139},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","size_bytes":689},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      colors: {\n        background: \"var(--background)\",\n        foreground: \"var(--foreground)\",\n        card: {\n          DEFAULT: \"var(--card)\",\n          foreground: \"var(--card-foreground)\",\n        },\n        popover: {\n          DEFAULT: \"var(--popover)\",\n          foreground: \"var(--popover-foreground)\",\n        },\n        primary: {\n          DEFAULT: \"var(--primary)\",\n          foreground: \"var(--primary-foreground)\",\n        },\n        secondary: {\n          DEFAULT: \"var(--secondary)\",\n          foreground: \"var(--secondary-foreground)\",\n        },\n        muted: {\n          DEFAULT: \"var(--muted)\",\n          foreground: \"var(--muted-foreground)\",\n        },\n        accent: {\n          DEFAULT: \"var(--accent)\",\n          foreground: \"var(--accent-foreground)\",\n        },\n        destructive: {\n          DEFAULT: \"var(--destructive)\",\n          foreground: \"var(--destructive-foreground)\",\n        },\n        border: \"var(--border)\",\n        input: \"var(--input)\",\n        ring: \"var(--ring)\",\n        chart: {\n          \"1\": \"var(--chart-1)\",\n          \"2\": \"var(--chart-2)\",\n          \"3\": \"var(--chart-3)\",\n          \"4\": \"var(--chart-4)\",\n          \"5\": \"var(--chart-5)\",\n        },\n        sidebar: {\n          DEFAULT: \"var(--sidebar-background)\",\n          foreground: \"var(--sidebar-foreground)\",\n          primary: \"var(--sidebar-primary)\",\n          \"primary-foreground\": \"var(--sidebar-primary-foreground)\",\n          accent: \"var(--sidebar-accent)\",\n          \"accent-foreground\": \"var(--sidebar-accent-foreground)\",\n          border: \"var(--sidebar-border)\",\n          ring: \"var(--sidebar-ring)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: {\n            height: \"0\",\n          },\n          to: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n        },\n        \"accordion-up\": {\n          from: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n          to: {\n            height: \"0\",\n          },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","size_bytes":2766},"client/src/lib/admin-route.tsx":{"content":"import { useAuth } from \"@/hooks/use-auth\";\nimport { Loader2 } from \"lucide-react\";\nimport { Redirect, Route } from \"wouter\";\n\nexport function AdminRoute({\n  path,\n  component: Component,\n}: {\n  path: string;\n  component: () => React.JSX.Element;\n}) {\n  const { user, isLoading } = useAuth();\n\n  if (isLoading) {\n    return (\n      <Route path={path}>\n        <div className=\"flex items-center justify-center min-h-screen\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-border\" />\n        </div>\n      </Route>\n    );\n  }\n\n  if (!user) {\n    return (\n      <Route path={path}>\n        <Redirect to=\"/auth\" />\n      </Route>\n    );\n  }\n\n  if (user.role !== 'administrador') {\n    return (\n      <Route path={path}>\n        <Redirect to=\"/dashboard\" />\n      </Route>\n    );\n  }\n\n  return <Route path={path} component={Component} />;\n}\n","size_bytes":844},"server/auth.ts":{"content":"// Blueprint: javascript_auth_all_persistance - Authentication setup\nimport passport from \"passport\";\nimport { Strategy as LocalStrategy } from \"passport-local\";\nimport { Express } from \"express\";\nimport session from \"express-session\";\nimport { scrypt, randomBytes, timingSafeEqual } from \"crypto\";\nimport { promisify } from \"util\";\nimport { storage } from \"./storage\";\nimport { User as SelectUser } from \"@shared/schema\";\n\ndeclare global {\n  namespace Express {\n    interface User extends SelectUser {}\n  }\n}\n\nconst scryptAsync = promisify(scrypt);\n\nasync function hashPassword(password: string) {\n  const salt = randomBytes(16).toString(\"hex\");\n  const buf = (await scryptAsync(password, salt, 64)) as Buffer;\n  return `${buf.toString(\"hex\")}.${salt}`;\n}\n\nasync function comparePasswords(supplied: string, stored: string) {\n  const [hashed, salt] = stored.split(\".\");\n  const hashedBuf = Buffer.from(hashed, \"hex\");\n  const suppliedBuf = (await scryptAsync(supplied, salt, 64)) as Buffer;\n  return timingSafeEqual(hashedBuf, suppliedBuf);\n}\n\nexport function setupAuth(app: Express) {\n  const sessionSettings: session.SessionOptions = {\n    secret: process.env.SESSION_SECRET!,\n    resave: false,\n    saveUninitialized: false,\n    store: storage.sessionStore,\n    cookie: {\n      secure: process.env.NODE_ENV === 'production',\n      httpOnly: true,\n      maxAge: 1000 * 60 * 60 * 24 * 7, // 7 days\n      sameSite: 'lax'\n    }\n  };\n\n  app.set(\"trust proxy\", 1);\n  app.use(session(sessionSettings));\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  passport.use(\n    new LocalStrategy(async (username, password, done) => {\n      const user = await storage.getUserByUsername(username);\n      if (!user || !(await comparePasswords(password, user.password))) {\n        return done(null, false);\n      } else {\n        return done(null, user);\n      }\n    }),\n  );\n\n  passport.serializeUser((user, done) => done(null, user.id));\n  passport.deserializeUser(async (id: string, done) => {\n    const user = await storage.getUser(id);\n    done(null, user);\n  });\n\n  app.post(\"/api/register\", async (req, res, next) => {\n    // Check if user registration is allowed\n    const settings = await storage.getSystemSettings();\n    if (settings && settings.allowUserRegistration === false) {\n      return res.status(403).json({ error: \"User registration is currently disabled\" });\n    }\n\n    const existingUser = await storage.getUserByUsername(req.body.username);\n    if (existingUser) {\n      return res.status(400).send(\"Username already exists\");\n    }\n\n    const user = await storage.createUser({\n      ...req.body,\n      password: await hashPassword(req.body.password),\n    });\n\n    req.login(user, (err) => {\n      if (err) return next(err);\n      res.status(201).json(user);\n    });\n  });\n\n  app.post(\"/api/login\", passport.authenticate(\"local\"), (req, res) => {\n    res.status(200).json(req.user);\n  });\n\n  app.post(\"/api/logout\", (req, res, next) => {\n    req.logout((err) => {\n      if (err) return next(err);\n      \n      // Destroy session completely\n      req.session.destroy((destroyErr) => {\n        if (destroyErr) {\n          console.error(\"Error destroying session:\", destroyErr);\n        }\n        \n        // Clear session cookie\n        res.clearCookie('connect.sid');\n        \n        // Add cache control headers to prevent caching\n        res.set({\n          'Cache-Control': 'no-store, no-cache, must-revalidate, private',\n          'Pragma': 'no-cache',\n          'Expires': '0'\n        });\n        \n        res.sendStatus(200);\n      });\n    });\n  });\n\n  app.get(\"/api/user\", (req, res) => {\n    if (!req.isAuthenticated()) return res.sendStatus(401);\n    res.json(req.user);\n  });\n}\n\n// Middleware to protect routes\nexport function requireAuth(req: any, res: any, next: any) {\n  if (!req.isAuthenticated()) {\n    return res.status(401).json({ error: \"Authentication required\" });\n  }\n  next();\n}\n\n// Middleware to protect admin routes\nexport function requireSuperAdmin(req: any, res: any, next: any) {\n  if (!req.isAuthenticated()) {\n    return res.status(401).json({ error: \"Authentication required\" });\n  }\n  if (req.user.role !== 'administrador') {\n    return res.status(403).json({ error: \"Administrator access required\" });\n  }\n  next();\n}\n\n// Middleware to protect manager routes\nexport function requireManager(req: any, res: any, next: any) {\n  if (!req.isAuthenticated()) {\n    return res.status(401).json({ error: \"Authentication required\" });\n  }\n  if (req.user.role !== 'gerente' && req.user.role !== 'administrador') {\n    return res.status(403).json({ error: \"Manager or administrator access required\" });\n  }\n  next();\n}\n","size_bytes":4666},"client/src/lib/commissions.ts":{"content":"import type { Category } from \"@shared/schema\";\n\nexport interface CommissionCalculation {\n  tier: \"verde\" | \"amarela\" | \"vermelha\" | \"abaixo_lista\";\n  rate: number;\n}\n\nexport function calculateCommission(category: Category, margin: number): CommissionCalculation {\n  const greenMarginMin = parseFloat(category.greenMarginMin);\n  const yellowMarginMin = parseFloat(category.yellowMarginMin);\n  const yellowMarginMax = parseFloat(category.yellowMarginMax);\n  const redMarginMin = parseFloat(category.redMarginMin);\n  const redMarginMax = parseFloat(category.redMarginMax);\n  \n  // Verde (Green tier) - above green margin minimum\n  if (margin >= greenMarginMin) {\n    return {\n      tier: \"verde\",\n      rate: parseFloat(category.greenCommission),\n    };\n  }\n  \n  // Amarela (Yellow tier) - between yellow margin min and max\n  if (margin >= yellowMarginMin && margin <= yellowMarginMax) {\n    return {\n      tier: \"amarela\", \n      rate: parseFloat(category.yellowCommission),\n    };\n  }\n  \n  // Vermelha (Red tier) - between red margin min and max\n  if (margin >= redMarginMin && margin <= redMarginMax) {\n    return {\n      tier: \"vermelha\",\n      rate: parseFloat(category.redCommission),\n    };\n  }\n  \n  // Below list - anything below red minimum\n  return {\n    tier: \"abaixo_lista\",\n    rate: parseFloat(category.belowListCommission),\n  };\n}\n\nexport function getCommissionColor(tier: string): string {\n  switch (tier) {\n    case \"verde\":\n      return \"text-verde\";\n    case \"amarela\":\n      return \"text-amarela\";\n    case \"vermelha\":\n      return \"text-vermelha\";\n    case \"abaixo_lista\":\n      return \"text-muted-foreground\";\n    default:\n      return \"text-foreground\";\n  }\n}\n\nexport function getCommissionBadgeClass(tier: string): string {\n  switch (tier) {\n    case \"verde\":\n      return \"badge-verde\";\n    case \"amarela\":\n      return \"badge-amarela\";\n    case \"vermelha\":\n      return \"badge-vermelha\";\n    case \"abaixo_lista\":\n      return \"bg-muted text-muted-foreground\";\n    default:\n      return \"badge-verde\";\n  }\n}\n","size_bytes":2031},"client/src/pages/safras.tsx":{"content":"import Navbar from \"@/components/layout/navbar\";\nimport Header from \"@/components/layout/header\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Plus, Calendar, Target, TrendingUp, Sprout } from \"lucide-react\";\nimport { format } from \"date-fns\";\nimport { classifySeason } from \"@/lib/seasons\";\nimport type { Season, InsertSeason } from \"@shared/schema\";\n\nexport default function Safras() {\n  const [showNewSeasonModal, setShowNewSeasonModal] = useState(false);\n  const { toast } = useToast();\n\n  const [formData, setFormData] = useState({\n    name: \"\",\n    type: \"\",\n    year: new Date().getFullYear(),\n    startDate: \"\",\n    endDate: \"\",\n  });\n\n  const { data: seasons, isLoading } = useQuery<Season[]>({\n    queryKey: [\"/api/seasons\"],\n  });\n\n  const { data: analytics } = useQuery({\n    queryKey: [\"/api/analytics/sales\"],\n  });\n\n  const { data: activeSeason } = useQuery<{ name: string }>({\n    queryKey: [\"/api/seasons/active\"],\n  });\n\n  const createSeasonMutation = useMutation({\n    mutationFn: async (seasonData: InsertSeason) => {\n      return apiRequest(\"POST\", \"/api/seasons\", seasonData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/seasons\"] });\n      toast({\n        title: \"Safra cadastrada\",\n        description: \"A safra foi cadastrada com sucesso.\",\n      });\n      setShowNewSeasonModal(false);\n      resetForm();\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao cadastrar safra. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      name: \"\",\n      type: \"\",\n      year: new Date().getFullYear(),\n      startDate: \"\",\n      endDate: \"\",\n    });\n  };\n\n  const generateSeasonName = (type: string, year: number) => {\n    switch (type) {\n      case \"soja_verao\":\n        return `Soja ${year % 100}/${(year + 1) % 100}`;\n      case \"soja_safrinha\":\n        return `Soja Safrinha ${year}`;\n      case \"milho\":\n        return `Milho ${year % 100}/${year % 100}`;\n      case \"trigo\":\n        return `Trigo ${year}`;\n      default:\n        return `Safra ${year}`;\n    }\n  };\n\n  const handleTypeChange = (type: string) => {\n    setFormData(prev => ({\n      ...prev,\n      type,\n      name: generateSeasonName(type, prev.year),\n    }));\n  };\n\n  const handleYearChange = (year: string) => {\n    const yearNum = parseInt(year);\n    setFormData(prev => ({\n      ...prev,\n      year: yearNum,\n      name: prev.type ? generateSeasonName(prev.type, yearNum) : \"\",\n    }));\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!formData.name || !formData.type || !formData.startDate || !formData.endDate) {\n      toast({\n        title: \"Campos obrigatórios\",\n        description: \"Preencha todos os campos obrigatórios.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const seasonData: InsertSeason = {\n      name: formData.name,\n      type: formData.type,\n      year: formData.year,\n      startDate: new Date(formData.startDate),\n      endDate: new Date(formData.endDate),\n      isActive: true,\n    };\n\n    createSeasonMutation.mutate(seasonData);\n  };\n\n  const getTypeLabel = (type: string) => {\n    switch (type) {\n      case \"soja_verao\": return \"Soja Verão\";\n      case \"soja_safrinha\": return \"Soja Safrinha\";\n      case \"milho\": return \"Milho\";\n      case \"trigo\": return \"Trigo\";\n      default: return type;\n    }\n  };\n\n  const getTypeBadgeClass = (type: string) => {\n    switch (type) {\n      case \"soja_verao\": return \"bg-verde/10 text-verde border-verde/20\";\n      case \"soja_safrinha\": return \"bg-chart-2/10 text-chart-2 border-chart-2/20\";\n      case \"milho\": return \"bg-amarela/10 text-amarela border-amarela/20\";\n      case \"trigo\": return \"bg-chart-4/10 text-chart-4 border-chart-4/20\";\n      default: return \"bg-muted text-muted-foreground\";\n    }\n  };\n\n  const getSeasonProgress = (season: Season) => {\n    const now = new Date();\n    const start = new Date(season.startDate);\n    const end = new Date(season.endDate);\n    \n    if (now < start) return 0;\n    if (now > end) return 100;\n    \n    const total = end.getTime() - start.getTime();\n    const elapsed = now.getTime() - start.getTime();\n    return Math.round((elapsed / total) * 100);\n  };\n\n  const totalSeasons = seasons?.length || 0;\n  const activeSeasons = seasons?.filter(s => s.isActive).length || 0;\n  const currentYear = new Date().getFullYear();\n\n  if (isLoading) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-32 w-32 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-screen flex flex-col overflow-hidden\" data-testid=\"safras-container\">\n      <Header \n        onNewSale={() => {}}\n        title=\"Gestão de Safras\"\n        subtitle=\"Controle de safras e períodos de plantio\"\n      />\n      <Navbar />\n      \n      <main className=\"flex-1 overflow-y-auto\">\n\n        <div className=\"p-8\">\n          {/* Summary Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8\">\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center\">\n                    <Calendar className=\"text-primary\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Total de Safras</p>\n                    <p className=\"text-2xl font-bold\">{totalSeasons}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-verde/10 rounded-lg flex items-center justify-center\">\n                    <Sprout className=\"text-verde\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Safras Ativas</p>\n                    <p className=\"text-2xl font-bold\">{activeSeasons}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                    <Target className=\"text-chart-2\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Safra Atual</p>\n                    <p className=\"text-lg font-bold\">{activeSeason?.name || \"Nenhuma\"}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-accent/10 rounded-lg flex items-center justify-center\">\n                    <TrendingUp className=\"text-accent\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Ano Agrícola</p>\n                    <p className=\"text-2xl font-bold\">{currentYear}/{currentYear + 1}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* New Season Button */}\n          <div className=\"mb-8\">\n            <Dialog open={showNewSeasonModal} onOpenChange={setShowNewSeasonModal}>\n              <DialogTrigger asChild>\n                <Button data-testid=\"button-new-season\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Nova Safra\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-2xl\" data-testid=\"new-season-modal\">\n                <DialogHeader>\n                  <DialogTitle>Nova Safra</DialogTitle>\n                </DialogHeader>\n                <form onSubmit={handleSubmit} className=\"space-y-4\">\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div>\n                      <Label htmlFor=\"type\">Tipo de Safra *</Label>\n                      <Select value={formData.type} onValueChange={handleTypeChange}>\n                        <SelectTrigger data-testid=\"select-season-type\">\n                          <SelectValue placeholder=\"Selecione o tipo\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"soja_verao\">Soja Verão</SelectItem>\n                          <SelectItem value=\"soja_safrinha\">Soja Safrinha</SelectItem>\n                          <SelectItem value=\"milho\">Milho</SelectItem>\n                          <SelectItem value=\"trigo\">Trigo</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                    <div>\n                      <Label htmlFor=\"year\">Ano *</Label>\n                      <Input\n                        type=\"number\"\n                        min=\"2020\"\n                        max=\"2030\"\n                        value={formData.year}\n                        onChange={(e) => handleYearChange(e.target.value)}\n                        data-testid=\"input-year\"\n                      />\n                    </div>\n                  </div>\n\n                  <div>\n                    <Label htmlFor=\"name\">Nome da Safra *</Label>\n                    <Input\n                      value={formData.name}\n                      onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}\n                      placeholder=\"Ex: Soja 25/26\"\n                      data-testid=\"input-season-name\"\n                    />\n                  </div>\n\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div>\n                      <Label htmlFor=\"startDate\">Data de Início *</Label>\n                      <Input\n                        type=\"date\"\n                        value={formData.startDate}\n                        onChange={(e) => setFormData(prev => ({ ...prev, startDate: e.target.value }))}\n                        data-testid=\"input-start-date\"\n                      />\n                    </div>\n                    <div>\n                      <Label htmlFor=\"endDate\">Data de Fim *</Label>\n                      <Input\n                        type=\"date\"\n                        value={formData.endDate}\n                        onChange={(e) => setFormData(prev => ({ ...prev, endDate: e.target.value }))}\n                        data-testid=\"input-end-date\"\n                      />\n                    </div>\n                  </div>\n\n                  <div className=\"flex justify-end gap-3 pt-4\">\n                    <Button\n                      type=\"button\"\n                      variant=\"outline\"\n                      onClick={() => setShowNewSeasonModal(false)}\n                      data-testid=\"button-cancel\"\n                    >\n                      Cancelar\n                    </Button>\n                    <Button\n                      type=\"submit\"\n                      disabled={createSeasonMutation.isPending}\n                      data-testid=\"button-save\"\n                    >\n                      {createSeasonMutation.isPending ? \"Salvando...\" : \"Salvar Safra\"}\n                    </Button>\n                  </div>\n                </form>\n              </DialogContent>\n            </Dialog>\n          </div>\n\n          {/* Seasons Table */}\n          <Card className=\"shadow-sm\">\n            <CardHeader>\n              <CardTitle>Lista de Safras</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {seasons?.length === 0 ? (\n                <div className=\"text-center py-12\">\n                  <p className=\"text-muted-foreground\">Nenhuma safra cadastrada</p>\n                  <Button \n                    onClick={() => setShowNewSeasonModal(true)} \n                    className=\"mt-4\"\n                    data-testid=\"button-first-season\"\n                  >\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Cadastrar primeira safra\n                  </Button>\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Nome</TableHead>\n                        <TableHead>Tipo</TableHead>\n                        <TableHead>Ano</TableHead>\n                        <TableHead>Período</TableHead>\n                        <TableHead>Progresso</TableHead>\n                        <TableHead className=\"text-center\">Status</TableHead>\n                        <TableHead className=\"text-right\">Vendas</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {seasons?.map((season) => {\n                        const progress = getSeasonProgress(season);\n                        const isActive = progress > 0 && progress < 100;\n                        \n                        return (\n                          <TableRow key={season.id} data-testid={`season-row-${season.id}`}>\n                            <TableCell className=\"font-medium\">{season.name}</TableCell>\n                            <TableCell>\n                              <Badge className={getTypeBadgeClass(season.type)}>\n                                {getTypeLabel(season.type)}\n                              </Badge>\n                            </TableCell>\n                            <TableCell className=\"font-mono\">{season.year}</TableCell>\n                            <TableCell className=\"text-sm\">\n                              {format(new Date(season.startDate), \"dd/MM/yyyy\")} - {format(new Date(season.endDate), \"dd/MM/yyyy\")}\n                            </TableCell>\n                            <TableCell>\n                              <div className=\"flex items-center gap-2\">\n                                <Progress value={progress} className=\"flex-1 h-2\" />\n                                <span className=\"text-sm font-mono w-12\">{progress}%</span>\n                              </div>\n                            </TableCell>\n                            <TableCell className=\"text-center\">\n                              {season.isActive && isActive ? (\n                                <Badge className=\"bg-verde/10 text-verde\">Ativa</Badge>\n                              ) : progress === 100 ? (\n                                <Badge variant=\"outline\">Finalizada</Badge>\n                              ) : (\n                                <Badge variant=\"outline\" className=\"text-muted-foreground\">\n                                  Aguardando\n                                </Badge>\n                              )}\n                            </TableCell>\n                            <TableCell className=\"text-right font-mono\">\n                              $0 {/* This would be calculated from sales data */}\n                            </TableCell>\n                          </TableRow>\n                        );\n                      })}\n                    </TableBody>\n                  </Table>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </main>\n    </div>\n  );\n}\n","size_bytes":16544},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","size_bytes":4120},"client/src/lib/seasons.ts":{"content":"export function classifySeason(dueDate: Date): string {\n  const year = dueDate.getFullYear();\n  const month = dueDate.getMonth() + 1;\n  const day = dueDate.getDate();\n  \n  // Soja Verão - vencimento 30/03 ou 30/04\n  if ((month === 3 && day === 30) || (month === 4 && day === 30)) {\n    return `Soja ${year % 100}/${(year + 1) % 100}`;\n  }\n  \n  // Soja Safrinha - vencimento 30/06\n  if (month === 6 && day === 30) {\n    return `Soja Safrinha ${year}`;\n  }\n  \n  // Milho - vencimento 30/08\n  if (month === 8 && day === 30) {\n    return `Milho ${year % 100}/${year % 100}`;\n  }\n  \n  // Trigo - vencimento 30/10\n  if (month === 10 && day === 30) {\n    return `Trigo ${year}`;\n  }\n  \n  // Default case\n  return `Safra ${year}`;\n}\n\nexport function getSeasonType(dueDate: Date): string {\n  const month = dueDate.getMonth() + 1;\n  const day = dueDate.getDate();\n  \n  if ((month === 3 && day === 30) || (month === 4 && day === 30)) {\n    return \"soja_verao\";\n  }\n  \n  if (month === 6 && day === 30) {\n    return \"soja_safrinha\";\n  }\n  \n  if (month === 8 && day === 30) {\n    return \"milho\";\n  }\n  \n  if (month === 10 && day === 30) {\n    return \"trigo\";\n  }\n  \n  return \"other\";\n}\n\nexport function getValidCategoriesForSeason(seasonType: string): string[] {\n  const commonCategories = [\n    \"fertilizantes\",\n    \"corretivos\",\n    \"especialidades\",\n    \"agroquimicos\"\n  ];\n\n  switch (seasonType) {\n    case \"soja_verao\":\n    case \"soja_safrinha\":\n    case \"milho\":\n    case \"trigo\":\n    case \"other\":\n      return [...commonCategories, \"sementes\"];\n    \n    default:\n      return commonCategories;\n  }\n}\n\nexport function getSeasonTypeFromName(seasonName: string): string {\n  const nameLower = seasonName.toLowerCase();\n  \n  if (nameLower.includes('soja') && nameLower.includes('safrinha')) {\n    return \"soja_safrinha\";\n  }\n  \n  if (nameLower.includes('soja')) {\n    return \"soja_verao\";\n  }\n  \n  if (nameLower.includes('milho')) {\n    return \"milho\";\n  }\n  \n  if (nameLower.includes('trigo')) {\n    return \"trigo\";\n  }\n  \n  return \"other\";\n}\n","size_bytes":2034},"client/src/components/dashboard/stat-card.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { LucideIcon } from \"lucide-react\";\n\ninterface StatCardProps {\n  title: string;\n  value: string;\n  icon: LucideIcon;\n  trend?: string;\n  trendColor?: \"verde\" | \"amarela\" | \"vermelha\";\n  subtitle: string;\n  color?: \"primary\" | \"secondary\" | \"accent\" | \"chart-4\";\n  showProgress?: boolean;\n  progressValue?: number;\n}\n\nexport default function StatCard({ \n  title, \n  value, \n  icon: Icon, \n  trend, \n  trendColor, \n  subtitle, \n  color = \"primary\",\n  showProgress = false,\n  progressValue = 0\n}: StatCardProps) {\n  const iconColorClass = {\n    primary: \"bg-primary/10 text-primary\",\n    secondary: \"bg-secondary/10 text-secondary\",\n    accent: \"bg-accent/10 text-accent\",\n    \"chart-4\": \"bg-chart-4/10 text-chart-4\",\n  }[color];\n\n  const trendColorClass = trendColor ? {\n    verde: \"text-verde bg-verde/10\",\n    amarela: \"text-amarela bg-amarela/10\",\n    vermelha: \"text-vermelha bg-vermelha/10\",\n  }[trendColor] : \"\";\n\n  return (\n    <Card className=\"stat-card shadow-sm\" data-testid={`stat-card-${title.toLowerCase().replace(/\\s+/g, '-')}`}>\n      <CardContent className=\"p-4\">\n        <div className=\"flex items-center justify-between mb-2\">\n          <h3 className=\"text-sm font-medium text-muted-foreground\">{title}</h3>\n          {trend && trendColor && (\n            <span className={`text-xs font-medium px-2 py-1 rounded ${trendColorClass}`}>\n              {trend}\n            </span>\n          )}\n        </div>\n        \n        <div className=\"flex items-center gap-3\">\n          <div className={`rounded-lg flex items-center justify-center ${iconColorClass}`}>\n            <Icon size={28} />\n          </div>\n          <p className=\"text-3xl font-bold text-foreground font-mono break-words overflow-hidden\">{value}</p>\n        </div>\n        \n        {showProgress && (\n          <div className=\"mt-3 bg-muted rounded-full h-2 overflow-hidden\">\n            <div \n              className=\"progress-bar-fill bg-accent h-full transition-all duration-300\" \n              style={{ width: `${progressValue}%` }}\n            />\n          </div>\n        )}\n        \n        {subtitle && <p className=\"text-xs text-muted-foreground mt-2\">{subtitle}</p>}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":2260},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90\",\n        outline:\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-10 px-4 py-2\",\n        sm: \"h-9 rounded-md px-3\",\n        lg: \"h-11 rounded-md px-8\",\n        icon: \"h-10 w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","size_bytes":1901},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","size_bytes":7428},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","size_bytes":1584},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","size_bytes":1077},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","size_bytes":4420},"client/src/components/layout/sidebar.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Link, useLocation } from \"wouter\";\nimport { \n  BarChart3, \n  ShoppingCart, \n  Percent, \n  Users, \n  Calendar, \n  Package, \n  FileText, \n  Settings, \n  Target,\n  Sprout,\n  TrendingUp,\n  LogOut,\n  History,\n  Repeat,\n  ListChecks,\n  Kanban\n} from \"lucide-react\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\ninterface SidebarProps {\n  collapsed: boolean;\n}\n\nconst menuItems = [\n  { href: \"/dashboard\", icon: BarChart3, label: \"Dashboard\" },\n  { href: \"/vendas\", icon: ShoppingCart, label: \"Minhas Vendas\" },\n  { href: \"/barter\", icon: Repeat, label: \"Barter\" },\n  { href: \"/kanban-metas\", icon: Kanban, label: \"Oportunidades de Negócio\" },\n  { href: \"/clientes\", icon: Users, label: \"Clientes\" },\n  // { href: \"/mercado\", icon: TrendingUp, label: \"Mercado\" }, // Temporarily hidden\n  { href: \"/historico-compras\", icon: History, label: \"Histórico Compras\" },\n  { href: \"/safras\", icon: Calendar, label: \"Safras\" },\n  { href: \"/produtos\", icon: Package, label: \"Produtos\" },\n  { href: \"/relatorios\", icon: FileText, label: \"Relatórios\" },\n];\n\nconst configItems = [\n  { href: \"/metas\", icon: Target, label: \"Metas\" },\n  { href: \"/comissoes\", icon: Percent, label: \"Comissões\" },\n];\n\nconst adminItems = [\n  { href: \"/admin\", icon: Settings, label: \"Super Admin\" },\n];\n\nexport default function Sidebar({ collapsed }: SidebarProps) {\n  const [location, setLocation] = useLocation();\n  const { user, logoutMutation } = useAuth();\n  const [currentHash, setCurrentHash] = useState(window.location.hash);\n\n  // Listen to hash changes to update active state\n  useEffect(() => {\n    const handleHashChange = () => {\n      setCurrentHash(window.location.hash);\n    };\n    \n    window.addEventListener('hashchange', handleHashChange);\n    return () => window.removeEventListener('hashchange', handleHashChange);\n  }, []);\n\n  const handleLogout = () => {\n    logoutMutation.mutate(undefined, {\n      onSuccess: () => {\n        setLocation(\"/auth\");\n      }\n    });\n  };\n\n  const getInitials = (name: string) => {\n    return name\n      .split(' ')\n      .map(word => word[0])\n      .join('')\n      .toUpperCase()\n      .slice(0, 2);\n  };\n\n  const getRoleLabel = (role: string) => {\n    const roleMap: Record<string, string> = {\n      consultor: 'Consultor',\n      gerente: 'Gerente',\n      administrador: 'Administrador',\n      faturista: 'Faturista',\n    };\n    return roleMap[role] || role;\n  };\n\n  return (\n    <aside \n      className={`bg-card border-r border-border flex flex-col slide-in transition-all duration-300 ${\n        collapsed ? 'w-20' : 'w-72'\n      }`}\n      data-testid=\"sidebar\"\n    >\n      {/* Logo & Brand */}\n      <div className=\"p-6 border-b border-border\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-10 h-10 bg-primary rounded-lg flex items-center justify-center flex-shrink-0\">\n            <Sprout className=\"text-primary-foreground text-xl\" />\n          </div>\n          {!collapsed && (\n            <div className=\"menu-text\">\n              <h1 className=\"text-lg font-bold text-foreground\">Agro Farm Digital</h1>\n              <p className=\"text-xs text-muted-foreground\">Gestão de Comissões</p>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Navigation */}\n      <nav className=\"flex-1 overflow-y-auto p-4\">\n        {/* Menu principal - Ocultar para gerentes e faturistas */}\n        {user?.role !== 'gerente' && user?.role !== 'faturista' && (\n          <>\n            <ul className=\"space-y-1\">\n              {menuItems.map((item) => {\n                const Icon = item.icon;\n                const isActive = location === item.href || (item.href === '/dashboard' && location === '/');\n                \n                return (\n                  <li key={item.href}>\n                    <Link \n                      href={item.href}\n                      className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors border-l-4 ${\n                        isActive \n                          ? 'bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200 border-green-600 dark:border-green-500' \n                          : 'hover:bg-muted text-foreground border-transparent'\n                      }`}\n                      data-testid={`nav-${item.label.toLowerCase().replace(/\\s+/g, '-')}`}\n                    >\n                      <Icon className=\"text-lg flex-shrink-0\" size={20} />\n                      {!collapsed && (\n                        <span className=\"menu-text font-medium\">{item.label}</span>\n                      )}\n                    </Link>\n                  </li>\n                );\n              })}\n            </ul>\n\n            <div className=\"mt-8 pt-4 border-t border-border\">\n              {!collapsed && (\n                <p className=\"px-4 text-xs font-semibold text-muted-foreground uppercase tracking-wider menu-text mb-2\">\n                  Configurações\n                </p>\n              )}\n              <ul className=\"space-y-1\">\n                {configItems.map((item) => {\n                  const Icon = item.icon;\n                  const isActive = location === item.href;\n                  \n                  return (\n                    <li key={item.href}>\n                      <Link \n                        href={item.href}\n                        className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors border-l-4 ${\n                          isActive \n                            ? 'bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200 border-green-600 dark:border-green-500' \n                            : 'hover:bg-muted text-foreground border-transparent'\n                        }`}\n                        data-testid={`nav-${item.label.toLowerCase().replace(/\\s+/g, '-')}`}\n                      >\n                        <Icon className=\"text-lg flex-shrink-0\" size={20} />\n                        {!collapsed && (\n                          <span className=\"menu-text font-medium\">{item.label}</span>\n                        )}\n                      </Link>\n                    </li>\n                  );\n                })}\n              </ul>\n            </div>\n          </>\n        )}\n\n        {/* Manager Section - Only for gerente */}\n        {user?.role === 'gerente' && (\n          <div className=\"mt-8 pt-4 border-t border-border\">\n            {!collapsed && (\n              <p className=\"px-4 text-xs font-semibold text-muted-foreground uppercase tracking-wider menu-text mb-2\">\n                Gerência\n              </p>\n            )}\n            <ul className=\"space-y-1\">\n              {/* Main link - Only show when NOT on manager page */}\n              {location !== '/manager' && (\n                <li>\n                  <Link \n                    href=\"/manager#dashboard\"\n                    className=\"flex items-center gap-3 px-4 py-3 rounded-lg transition-colors border-l-4 hover:bg-muted text-foreground border-transparent\"\n                    data-testid=\"nav-painel-gerente\"\n                  >\n                    <Users className=\"text-lg flex-shrink-0\" size={20} />\n                    {!collapsed && (\n                      <span className=\"menu-text font-medium\">Painel Gerente</span>\n                    )}\n                  </Link>\n                </li>\n              )}\n              \n              {/* Submenu - Only show when on manager page */}\n              {location === '/manager' && !collapsed && (\n                <>\n                  <li>\n                    <a\n                      href=\"#dashboard\"\n                      className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ml-4 ${\n                        currentHash === '#dashboard' || currentHash === ''\n                          ? 'bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200'\n                          : 'hover:bg-muted text-foreground'\n                      }`}\n                      data-testid=\"tab-dashboard\"\n                    >\n                      <TrendingUp className=\"text-lg flex-shrink-0\" size={18} />\n                      <span className=\"menu-text font-medium\">Dashboard</span>\n                    </a>\n                  </li>\n                  <li>\n                    <a\n                      href=\"#team\"\n                      className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ml-4 ${\n                        currentHash === '#team'\n                          ? 'bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200'\n                          : 'hover:bg-muted text-foreground'\n                      }`}\n                      data-testid=\"tab-team\"\n                    >\n                      <Users className=\"text-lg flex-shrink-0\" size={18} />\n                      <span className=\"menu-text font-medium\">Equipe</span>\n                    </a>\n                  </li>\n                  <li>\n                    <a\n                      href=\"#action-plans\"\n                      className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ml-4 ${\n                        currentHash === '#action-plans'\n                          ? 'bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200'\n                          : 'hover:bg-muted text-foreground'\n                      }`}\n                      data-testid=\"tab-action-plans\"\n                    >\n                      <ListChecks className=\"text-lg flex-shrink-0\" size={18} />\n                      <span className=\"menu-text font-medium\">Planos de Ação</span>\n                    </a>\n                  </li>\n                  <li>\n                    <a\n                      href=\"#metas\"\n                      className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ml-4 ${\n                        currentHash === '#metas'\n                          ? 'bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200'\n                          : 'hover:bg-muted text-foreground'\n                      }`}\n                      data-testid=\"tab-metas\"\n                    >\n                      <Target className=\"text-lg flex-shrink-0\" size={18} />\n                      <span className=\"menu-text font-medium\">Metas</span>\n                    </a>\n                  </li>\n                </>\n              )}\n            </ul>\n          </div>\n        )}\n\n        {/* Admin Section - Only for administrador */}\n        {user?.role === 'administrador' && (\n          <div className=\"mt-8 pt-4 border-t border-border\">\n            {!collapsed && (\n              <p className=\"px-4 text-xs font-semibold text-muted-foreground uppercase tracking-wider menu-text mb-2\">\n                Administração\n              </p>\n            )}\n            <ul className=\"space-y-1\">\n              <li>\n                <Link \n                  href=\"/admin#dashboard\"\n                  className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors border-l-4 ${\n                    location === '/admin'\n                      ? 'bg-blue-50 dark:bg-blue-950 text-blue-800 dark:text-blue-200 border-blue-600 dark:border-blue-500' \n                      : 'hover:bg-muted text-foreground border-transparent'\n                  }`}\n                  data-testid=\"nav-super-admin\"\n                >\n                  <Settings className=\"text-lg flex-shrink-0\" size={20} />\n                  {!collapsed && (\n                    <span className=\"menu-text font-medium\">Super Admin</span>\n                  )}\n                </Link>\n              </li>\n              \n              {/* Submenu - Only show when on admin page */}\n              {location === '/admin' && !collapsed && (\n                <>\n                  <li>\n                    <a\n                      href=\"#dashboard\"\n                      className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ml-4 ${\n                        currentHash === '#dashboard' || currentHash === ''\n                          ? 'bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200'\n                          : 'hover:bg-muted text-foreground'\n                      }`}\n                      data-testid=\"tab-dashboard\"\n                    >\n                      <BarChart3 className=\"text-lg flex-shrink-0\" size={18} />\n                      <span className=\"menu-text font-medium\">Dashboard</span>\n                    </a>\n                  </li>\n                  <li>\n                    <a\n                      href=\"#users\"\n                      className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ml-4 ${\n                        currentHash === '#users'\n                          ? 'bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200'\n                          : 'hover:bg-muted text-foreground'\n                      }`}\n                      data-testid=\"tab-users\"\n                    >\n                      <Users className=\"text-lg flex-shrink-0\" size={18} />\n                      <span className=\"menu-text font-medium\">Usuários</span>\n                    </a>\n                  </li>\n                  <li>\n                    <a\n                      href=\"#master-clients\"\n                      className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ml-4 ${\n                        currentHash === '#master-clients'\n                          ? 'bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200'\n                          : 'hover:bg-muted text-foreground'\n                      }`}\n                      data-testid=\"tab-master-clients\"\n                    >\n                      <Users className=\"text-lg flex-shrink-0\" size={18} />\n                      <span className=\"menu-text font-medium\">Clientes Master</span>\n                    </a>\n                  </li>\n                  <li>\n                    <a\n                      href=\"#categories\"\n                      className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ml-4 ${\n                        currentHash === '#categories'\n                          ? 'bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200'\n                          : 'hover:bg-muted text-foreground'\n                      }`}\n                      data-testid=\"tab-categories\"\n                    >\n                      <Package className=\"text-lg flex-shrink-0\" size={18} />\n                      <span className=\"menu-text font-medium\">Categorias</span>\n                    </a>\n                  </li>\n                  <li>\n                    <a\n                      href=\"#subcategories\"\n                      className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ml-4 ${\n                        currentHash === '#subcategories'\n                          ? 'bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200'\n                          : 'hover:bg-muted text-foreground'\n                      }`}\n                      data-testid=\"tab-subcategories\"\n                    >\n                      <Package className=\"text-lg flex-shrink-0\" size={18} />\n                      <span className=\"menu-text font-medium\">Subcategorias</span>\n                    </a>\n                  </li>\n                  <li>\n                    <a\n                      href=\"#products\"\n                      className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ml-4 ${\n                        currentHash === '#products'\n                          ? 'bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200'\n                          : 'hover:bg-muted text-foreground'\n                      }`}\n                      data-testid=\"tab-products\"\n                    >\n                      <Package className=\"text-lg flex-shrink-0\" size={18} />\n                      <span className=\"menu-text font-medium\">Produtos</span>\n                    </a>\n                  </li>\n                  <li>\n                    <a\n                      href=\"#commissions\"\n                      className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ml-4 ${\n                        currentHash === '#commissions'\n                          ? 'bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200'\n                          : 'hover:bg-muted text-foreground'\n                      }`}\n                      data-testid=\"tab-commissions\"\n                    >\n                      <Percent className=\"text-lg flex-shrink-0\" size={18} />\n                      <span className=\"menu-text font-medium\">Comissões</span>\n                    </a>\n                  </li>\n                  <li>\n                    <a\n                      href=\"#parameters\"\n                      className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ml-4 ${\n                        currentHash === '#parameters'\n                          ? 'bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200'\n                          : 'hover:bg-muted text-foreground'\n                      }`}\n                      data-testid=\"tab-parameters\"\n                    >\n                      <Settings className=\"text-lg flex-shrink-0\" size={18} />\n                      <span className=\"menu-text font-medium\">Parâmetros</span>\n                    </a>\n                  </li>\n                  <li>\n                    <a\n                      href=\"#barter\"\n                      className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ml-4 ${\n                        currentHash === '#barter'\n                          ? 'bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200'\n                          : 'hover:bg-muted text-foreground'\n                      }`}\n                      data-testid=\"tab-barter\"\n                    >\n                      <Repeat className=\"text-lg flex-shrink-0\" size={18} />\n                      <span className=\"menu-text font-medium\">Barter</span>\n                    </a>\n                  </li>\n                  <li>\n                    <a\n                      href=\"#timac\"\n                      className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ml-4 ${\n                        currentHash === '#timac'\n                          ? 'bg-green-50 dark:bg-green-950 text-green-800 dark:text-green-200'\n                          : 'hover:bg-muted text-foreground'\n                      }`}\n                      data-testid=\"tab-timac\"\n                    >\n                      <Target className=\"text-lg flex-shrink-0\" size={18} />\n                      <span className=\"menu-text font-medium\">Timac</span>\n                    </a>\n                  </li>\n                </>\n              )}\n            </ul>\n          </div>\n        )}\n\n        {/* Faturista Section - Only for faturista */}\n        {user?.role === 'faturista' && (\n          <div className=\"mt-8 pt-4 border-t border-border\">\n            {!collapsed && (\n              <p className=\"px-4 text-xs font-semibold text-muted-foreground uppercase tracking-wider menu-text mb-2\">\n                Controle de Estoque\n              </p>\n            )}\n            <ul className=\"space-y-1\">\n              <li>\n                <Link \n                  href=\"/faturista\"\n                  className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors border-l-4 ${\n                    location === '/faturista'\n                      ? 'bg-orange-50 dark:bg-orange-950 text-orange-800 dark:text-orange-200 border-orange-600 dark:border-orange-500' \n                      : 'hover:bg-muted text-foreground border-transparent'\n                  }`}\n                  data-testid=\"nav-faturista\"\n                >\n                  <Package className=\"text-lg flex-shrink-0\" size={20} />\n                  {!collapsed && (\n                    <span className=\"menu-text font-medium\">Faturista</span>\n                  )}\n                </Link>\n              </li>\n            </ul>\n          </div>\n        )}\n      </nav>\n\n      {/* User Profile */}\n      <div className=\"p-4 border-t border-border\">\n        {!collapsed ? (\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-muted cursor-pointer transition-colors\">\n              <div className=\"w-10 h-10 bg-secondary rounded-full flex items-center justify-center\">\n                <span className=\"text-secondary-foreground font-semibold\">\n                  {user ? getInitials(user.name) : 'U'}\n                </span>\n              </div>\n              <div className=\"menu-text flex-1\">\n                <p className=\"text-sm font-medium text-foreground\">{user?.name || 'Usuário'}</p>\n                <p className=\"text-xs text-muted-foreground\">{user ? getRoleLabel(user.role) : ''}</p>\n              </div>\n            </div>\n            <button\n              onClick={handleLogout}\n              className=\"w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-destructive/10 text-destructive transition-colors\"\n              data-testid=\"button-logout\"\n            >\n              <LogOut size={20} className=\"flex-shrink-0\" />\n              <span className=\"menu-text font-medium\">Sair</span>\n            </button>\n          </div>\n        ) : (\n          <button\n            onClick={handleLogout}\n            className=\"w-full flex items-center justify-center px-4 py-3 rounded-lg hover:bg-destructive/10 text-destructive transition-colors\"\n            data-testid=\"button-logout\"\n            title=\"Sair\"\n          >\n            <LogOut size={20} />\n          </button>\n        )}\n      </div>\n    </aside>\n  );\n}\n","size_bytes":21837},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","size_bytes":2712},"client/src/pages/relatorios.tsx":{"content":"import Navbar from \"@/components/layout/navbar\";\nimport Header from \"@/components/layout/header\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Download, FileText, BarChart3, TrendingUp, Users, Package } from \"lucide-react\";\nimport { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, LineChart, Line } from 'recharts';\nimport type { Category, Client, Season } from \"@shared/schema\";\n\nexport default function Relatorios() {\n  const { toast } = useToast();\n\n  const [filters, setFilters] = useState({\n    startDate: \"\",\n    endDate: \"\",\n    seasonId: \"\",\n    clientId: \"\",\n    regionId: \"\",\n    categoryId: \"\",\n    productId: \"\",\n  });\n\n  const [reportFields, setReportFields] = useState({\n    sales: true,\n    commissions: true,\n    clients: true,\n    products: true,\n    seasons: true,\n    regions: true,\n  });\n\n  const { data: categories } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const { data: clients } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: seasons } = useQuery<Season[]>({\n    queryKey: [\"/api/seasons\"],\n  });\n\n  const { data: regions } = useQuery<any[]>({\n    queryKey: [\"/api/regions\"],\n  });\n\n  const { data: analytics } = useQuery<{\n    totalSales: number;\n    totalCommissions: number;\n    salesByCategory: { categoryId: string; categoryName: string; total: number; commissions: number }[];\n    topClients: { clientId: string; clientName: string; total: number; percentage: number }[];\n  }>({\n    queryKey: [\"/api/analytics/sales\"],\n  });\n\n  const handleExportExcel = () => {\n    // Implementation would use a library like xlsx\n    toast({\n      title: \"Relatório exportado\",\n      description: \"O relatório foi exportado para Excel com sucesso.\",\n    });\n  };\n\n  const handleExportPDF = () => {\n    // Implementation would use a library like jsPDF\n    toast({\n      title: \"Relatório exportado\", \n      description: \"O relatório foi exportado para PDF com sucesso.\",\n    });\n  };\n\n  const generateReport = () => {\n    toast({\n      title: \"Relatório gerado\",\n      description: \"O relatório personalizado foi gerado com sucesso.\",\n    });\n  };\n\n  const getCategoryColor = (categoryName: string) => {\n    const normalized = categoryName.toLowerCase();\n    if (normalized.includes('agroquímico') || normalized.includes('agroquimico')) return '#ef4444'; // vermelho\n    if (normalized.includes('fertilizante')) return '#3b82f6'; // azul\n    if (normalized.includes('especialidade')) return '#22c55e'; // verde\n    if (normalized.includes('semente') || normalized.includes('semilla')) return '#eab308'; // amarelo\n    return '#8b5cf6'; // roxo padrão\n  };\n\n  const categoryData = analytics?.salesByCategory || [];\n  const COLORS = categoryData.map((item: any) => getCategoryColor(item.categoryName));\n\n  return (\n    <div className=\"h-screen flex flex-col overflow-hidden\" data-testid=\"relatorios-container\">\n      <Header \n        onNewSale={() => {}}\n        title=\"Relatórios e Analytics\"\n        subtitle=\"Análises detalhadas e relatórios personalizáveis\"\n      />\n      <Navbar />\n      \n      <main className=\"flex-1 overflow-y-auto\">\n\n        <div className=\"p-8\">\n          <Tabs defaultValue=\"analytics\" className=\"space-y-6\">\n            <TabsList>\n              <TabsTrigger value=\"analytics\">Analytics</TabsTrigger>\n              <TabsTrigger value=\"custom\">Relatórios Personalizados</TabsTrigger>\n            </TabsList>\n\n            <TabsContent value=\"analytics\" className=\"space-y-6\">\n              {/* Analytics Overview */}\n              <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n                <Card className=\"shadow-sm\">\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center\">\n                        <BarChart3 className=\"text-primary\" size={24} />\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Total de Vendas</p>\n                        <p className=\"text-2xl font-bold font-mono\">\n                          ${analytics?.totalSales?.toLocaleString() || \"0\"}\n                        </p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"shadow-sm\">\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"w-12 h-12 bg-verde/10 rounded-lg flex items-center justify-center\">\n                        <TrendingUp className=\"text-verde\" size={24} />\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Comissões Totais</p>\n                        <p className=\"text-2xl font-bold font-mono text-verde\">\n                          ${analytics?.totalCommissions?.toLocaleString() || \"0\"}\n                        </p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"shadow-sm\">\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                        <Users className=\"text-chart-2\" size={24} />\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Clientes Ativos</p>\n                        <p className=\"text-2xl font-bold\">{clients?.length || 0}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card className=\"shadow-sm\">\n                  <CardContent className=\"p-6\">\n                    <div className=\"flex items-center gap-4\">\n                      <div className=\"w-12 h-12 bg-accent/10 rounded-lg flex items-center justify-center\">\n                        <Package className=\"text-accent\" size={24} />\n                      </div>\n                      <div>\n                        <p className=\"text-sm text-muted-foreground\">Categorias</p>\n                        <p className=\"text-2xl font-bold\">{categories?.length || 0}</p>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              </div>\n\n              {/* Charts Row 1 */}\n              <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n                <Card className=\"shadow-sm\">\n                  <CardHeader>\n                    <CardTitle>Vendas por Categoria</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {categoryData.length > 0 ? (\n                      <div className=\"h-80\">\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\n                          <PieChart>\n                            <Pie\n                              data={categoryData}\n                              cx=\"50%\"\n                              cy=\"50%\"\n                              labelLine={false}\n                              label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}\n                              outerRadius={80}\n                              fill=\"#8884d8\"\n                              dataKey=\"total\"\n                            >\n                              {categoryData.map((entry: any, index: number) => (\n                                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />\n                              ))}\n                            </Pie>\n                            <Tooltip />\n                          </PieChart>\n                        </ResponsiveContainer>\n                      </div>\n                    ) : (\n                      <div className=\"h-80 flex items-center justify-center text-muted-foreground\">\n                        Nenhum dado disponível\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n\n                <Card className=\"shadow-sm\">\n                  <CardHeader>\n                    <CardTitle>Top Clientes por Vendas</CardTitle>\n                  </CardHeader>\n                  <CardContent>\n                    {analytics?.topClients && analytics.topClients.length > 0 ? (\n                      <div className=\"space-y-4\">\n                        {analytics.topClients.slice(0, 5).map((client: any, index: number) => (\n                          <div key={client.clientId} className=\"flex items-center gap-4\">\n                            <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${\n                              index === 0 ? 'bg-gold/10 text-gold' : \n                              index === 1 ? 'bg-chart-2/10 text-chart-2' :\n                              'bg-muted text-muted-foreground'\n                            }`}>\n                              {index + 1}\n                            </div>\n                            <div className=\"flex-1\">\n                              <p className=\"font-medium\">{client.clientName}</p>\n                              <p className=\"text-sm text-muted-foreground\">\n                                {client.percentage.toFixed(1)}% do total\n                              </p>\n                            </div>\n                            <div className=\"text-right\">\n                              <p className=\"font-mono font-semibold\">\n                                ${client.total.toLocaleString()}\n                              </p>\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    ) : (\n                      <div className=\"h-80 flex items-center justify-center text-muted-foreground\">\n                        Nenhum dado disponível\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </div>\n            </TabsContent>\n\n            <TabsContent value=\"custom\" className=\"space-y-6\">\n              <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n                {/* Report Configuration */}\n                <div className=\"lg:col-span-2\">\n                  <Card className=\"shadow-sm\">\n                    <CardHeader>\n                      <CardTitle>Configuração do Relatório</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-6\">\n                      {/* Date Filters */}\n                      <div>\n                        <h3 className=\"text-sm font-semibold mb-3\">Período</h3>\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          <div>\n                            <Label htmlFor=\"startDate\">Data Inicial</Label>\n                            <Input\n                              type=\"date\"\n                              value={filters.startDate}\n                              onChange={(e) => setFilters(prev => ({ ...prev, startDate: e.target.value }))}\n                              data-testid=\"input-start-date\"\n                            />\n                          </div>\n                          <div>\n                            <Label htmlFor=\"endDate\">Data Final</Label>\n                            <Input\n                              type=\"date\"\n                              value={filters.endDate}\n                              onChange={(e) => setFilters(prev => ({ ...prev, endDate: e.target.value }))}\n                              data-testid=\"input-end-date\"\n                            />\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Entity Filters */}\n                      <div>\n                        <h3 className=\"text-sm font-semibold mb-3\">Filtros</h3>\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          <div>\n                            <Label htmlFor=\"season\">Safra</Label>\n                            <Select value={filters.seasonId} onValueChange={(value) => \n                              setFilters(prev => ({ ...prev, seasonId: value }))\n                            }>\n                              <SelectTrigger data-testid=\"select-season\">\n                                <SelectValue placeholder=\"Todas as safras\" />\n                              </SelectTrigger>\n                              <SelectContent>\n                                <SelectItem value=\"all\">Todas as safras</SelectItem>\n                                {seasons?.map((season) => (\n                                  <SelectItem key={season.id} value={season.id}>\n                                    {season.name}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                          </div>\n\n                          <div>\n                            <Label htmlFor=\"client\">Cliente</Label>\n                            <Select value={filters.clientId} onValueChange={(value) => \n                              setFilters(prev => ({ ...prev, clientId: value }))\n                            }>\n                              <SelectTrigger data-testid=\"select-client\">\n                                <SelectValue placeholder=\"Todos os clientes\" />\n                              </SelectTrigger>\n                              <SelectContent>\n                                <SelectItem value=\"all\">Todos os clientes</SelectItem>\n                                {clients?.map((client) => (\n                                  <SelectItem key={client.id} value={client.id}>\n                                    {client.name}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                          </div>\n\n                          <div>\n                            <Label htmlFor=\"region\">Região</Label>\n                            <Select value={filters.regionId} onValueChange={(value) => \n                              setFilters(prev => ({ ...prev, regionId: value }))\n                            }>\n                              <SelectTrigger data-testid=\"select-region\">\n                                <SelectValue placeholder=\"Todas as regiões\" />\n                              </SelectTrigger>\n                              <SelectContent>\n                                <SelectItem value=\"all\">Todas as regiões</SelectItem>\n                                {regions?.map((region: any) => (\n                                  <SelectItem key={region.id} value={region.id}>\n                                    {region.name}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                          </div>\n\n                          <div>\n                            <Label htmlFor=\"category\">Categoria</Label>\n                            <Select value={filters.categoryId} onValueChange={(value) => \n                              setFilters(prev => ({ ...prev, categoryId: value }))\n                            }>\n                              <SelectTrigger data-testid=\"select-category\">\n                                <SelectValue placeholder=\"Todas as categorias\" />\n                              </SelectTrigger>\n                              <SelectContent>\n                                <SelectItem value=\"all\">Todas as categorias</SelectItem>\n                                {categories?.map((category) => (\n                                  <SelectItem key={category.id} value={category.id}>\n                                    {category.name}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                          </div>\n                        </div>\n                      </div>\n\n                      {/* Report Fields */}\n                      <div>\n                        <h3 className=\"text-sm font-semibold mb-3\">Campos do Relatório</h3>\n                        <div className=\"grid grid-cols-2 gap-3\">\n                          {Object.entries(reportFields).map(([field, checked]) => (\n                            <div key={field} className=\"flex items-center space-x-2\">\n                              <Checkbox\n                                id={field}\n                                checked={checked}\n                                onCheckedChange={(value) => \n                                  setReportFields(prev => ({ ...prev, [field]: value }))\n                                }\n                                data-testid={`checkbox-${field}`}\n                              />\n                              <Label htmlFor={field} className=\"text-sm capitalize\">\n                                {field === 'sales' ? 'Vendas' :\n                                 field === 'commissions' ? 'Comissões' :\n                                 field === 'clients' ? 'Clientes' :\n                                 field === 'products' ? 'Produtos' :\n                                 field === 'seasons' ? 'Safras' :\n                                 field === 'regions' ? 'Regiões' : field}\n                              </Label>\n                            </div>\n                          ))}\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                </div>\n\n                {/* Actions Panel */}\n                <div>\n                  <Card className=\"shadow-sm\">\n                    <CardHeader>\n                      <CardTitle>Ações</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-4\">\n                      <Button\n                        onClick={generateReport}\n                        className=\"w-full\"\n                        data-testid=\"button-generate-report\"\n                      >\n                        <FileText className=\"h-4 w-4 mr-2\" />\n                        Gerar Relatório\n                      </Button>\n\n                      <div className=\"space-y-2\">\n                        <Button\n                          onClick={handleExportExcel}\n                          variant=\"outline\"\n                          className=\"w-full\"\n                          data-testid=\"button-export-excel\"\n                        >\n                          <Download className=\"h-4 w-4 mr-2\" />\n                          Exportar Excel (.xlsx)\n                        </Button>\n\n                        <Button\n                          onClick={handleExportPDF}\n                          variant=\"outline\"\n                          className=\"w-full\"\n                          data-testid=\"button-export-pdf\"\n                        >\n                          <Download className=\"h-4 w-4 mr-2\" />\n                          Exportar PDF\n                        </Button>\n                      </div>\n\n                      {/* Report Summary */}\n                      <div className=\"pt-4 border-t\">\n                        <h4 className=\"text-sm font-semibold mb-2\">Resumo</h4>\n                        <div className=\"space-y-1 text-xs text-muted-foreground\">\n                          <p>Campos selecionados: {Object.values(reportFields).filter(Boolean).length}</p>\n                          <p>Filtros ativos: {Object.values(filters).filter(Boolean).length}</p>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n\n                  {/* Quick Reports */}\n                  <Card className=\"shadow-sm mt-6\">\n                    <CardHeader>\n                      <CardTitle className=\"text-sm\">Relatórios Rápidos</CardTitle>\n                    </CardHeader>\n                    <CardContent className=\"space-y-2\">\n                      <Button variant=\"ghost\" className=\"w-full text-left justify-start h-auto p-2 text-xs\">\n                        Vendas do Mês\n                      </Button>\n                      <Button variant=\"ghost\" className=\"w-full text-left justify-start h-auto p-2 text-xs\">\n                        Top Clientes 80/20\n                      </Button>\n                      <Button variant=\"ghost\" className=\"w-full text-left justify-start h-auto p-2 text-xs\">\n                        Comissões por Categoria\n                      </Button>\n                      <Button variant=\"ghost\" className=\"w-full text-left justify-start h-auto p-2 text-xs\">\n                        Alertas de Oportunidade\n                      </Button>\n                    </CardContent>\n                  </Card>\n                </div>\n              </div>\n            </TabsContent>\n          </Tabs>\n        </div>\n      </main>\n    </div>\n  );\n}\n","size_bytes":21843},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","size_bytes":7609},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","size_bytes":10481},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","size_bytes":1467},"client/src/lib/protected-route.tsx":{"content":"// Blueprint: javascript_auth_all_persistance - Protected route component\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { Loader2 } from \"lucide-react\";\nimport { Redirect, Route } from \"wouter\";\n\nexport function ProtectedRoute({\n  path,\n  component: Component,\n}: {\n  path: string;\n  component: () => React.JSX.Element;\n}) {\n  const { user, isLoading } = useAuth();\n\n  if (isLoading) {\n    return (\n      <Route path={path}>\n        <div className=\"flex items-center justify-center min-h-screen\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-border\" />\n        </div>\n      </Route>\n    );\n  }\n\n  if (!user) {\n    return (\n      <Route path={path}>\n        <Redirect to=\"/auth\" />\n      </Route>\n    );\n  }\n\n  return <Route path={path} component={Component} />;\n}\n","size_bytes":780},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","size_bytes":6210},"client/src/components/ui/sidebar.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { VariantProps, cva } from \"class-variance-authority\"\nimport { PanelLeft } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nconst SidebarProvider = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    defaultOpen?: boolean\n    open?: boolean\n    onOpenChange?: (open: boolean) => void\n  }\n>(\n  (\n    {\n      defaultOpen = true,\n      open: openProp,\n      onOpenChange: setOpenProp,\n      className,\n      style,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const isMobile = useIsMobile()\n    const [openMobile, setOpenMobile] = React.useState(false)\n\n    // This is the internal state of the sidebar.\n    // We use openProp and setOpenProp for control from outside the component.\n    const [_open, _setOpen] = React.useState(defaultOpen)\n    const open = openProp ?? _open\n    const setOpen = React.useCallback(\n      (value: boolean | ((value: boolean) => boolean)) => {\n        const openState = typeof value === \"function\" ? value(open) : value\n        if (setOpenProp) {\n          setOpenProp(openState)\n        } else {\n          _setOpen(openState)\n        }\n\n        // This sets the cookie to keep the sidebar state.\n        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n      },\n      [setOpenProp, open]\n    )\n\n    // Helper to toggle the sidebar.\n    const toggleSidebar = React.useCallback(() => {\n      return isMobile\n        ? setOpenMobile((open) => !open)\n        : setOpen((open) => !open)\n    }, [isMobile, setOpen, setOpenMobile])\n\n    // Adds a keyboard shortcut to toggle the sidebar.\n    React.useEffect(() => {\n      const handleKeyDown = (event: KeyboardEvent) => {\n        if (\n          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n          (event.metaKey || event.ctrlKey)\n        ) {\n          event.preventDefault()\n          toggleSidebar()\n        }\n      }\n\n      window.addEventListener(\"keydown\", handleKeyDown)\n      return () => window.removeEventListener(\"keydown\", handleKeyDown)\n    }, [toggleSidebar])\n\n    // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n    // This makes it easier to style the sidebar with Tailwind classes.\n    const state = open ? \"expanded\" : \"collapsed\"\n\n    const contextValue = React.useMemo<SidebarContextProps>(\n      () => ({\n        state,\n        open,\n        setOpen,\n        isMobile,\n        openMobile,\n        setOpenMobile,\n        toggleSidebar,\n      }),\n      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n    )\n\n    return (\n      <SidebarContext.Provider value={contextValue}>\n        <TooltipProvider delayDuration={0}>\n          <div\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH,\n                \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n                ...style,\n              } as React.CSSProperties\n            }\n            className={cn(\n              \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\n              className\n            )}\n            ref={ref}\n            {...props}\n          >\n            {children}\n          </div>\n        </TooltipProvider>\n      </SidebarContext.Provider>\n    )\n  }\n)\nSidebarProvider.displayName = \"SidebarProvider\"\n\nconst Sidebar = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    side?: \"left\" | \"right\"\n    variant?: \"sidebar\" | \"floating\" | \"inset\"\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n  }\n>(\n  (\n    {\n      side = \"left\",\n      variant = \"sidebar\",\n      collapsible = \"offcanvas\",\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n    if (collapsible === \"none\") {\n      return (\n        <div\n          className={cn(\n            \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n            className\n          )}\n          ref={ref}\n          {...props}\n        >\n          {children}\n        </div>\n      )\n    }\n\n    if (isMobile) {\n      return (\n        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n          <SheetContent\n            data-sidebar=\"sidebar\"\n            data-mobile=\"true\"\n            className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n              } as React.CSSProperties\n            }\n            side={side}\n          >\n            <SheetHeader className=\"sr-only\">\n              <SheetTitle>Sidebar</SheetTitle>\n              <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n            </SheetHeader>\n            <div className=\"flex h-full w-full flex-col\">{children}</div>\n          </SheetContent>\n        </Sheet>\n      )\n    }\n\n    return (\n      <div\n        ref={ref}\n        className=\"group peer hidden text-sidebar-foreground md:block\"\n        data-state={state}\n        data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n        data-variant={variant}\n        data-side={side}\n      >\n        {/* This is what handles the sidebar gap on desktop */}\n        <div\n          className={cn(\n            \"relative w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear\",\n            \"group-data-[collapsible=offcanvas]:w-0\",\n            \"group-data-[side=right]:rotate-180\",\n            variant === \"floating\" || variant === \"inset\"\n              ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n          )}\n        />\n        <div\n          className={cn(\n            \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex\",\n            side === \"left\"\n              ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n              : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n            // Adjust the padding for floating and inset variants.\n            variant === \"floating\" || variant === \"inset\"\n              ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n            className\n          )}\n          {...props}\n        >\n          <div\n            data-sidebar=\"sidebar\"\n            className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\n          >\n            {children}\n          </div>\n        </div>\n      </div>\n    )\n  }\n)\nSidebar.displayName = \"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef<\n  React.ElementRef<typeof Button>,\n  React.ComponentProps<typeof Button>\n>(({ className, onClick, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      ref={ref}\n      data-sidebar=\"trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeft />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n})\nSidebarTrigger.displayName = \"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\">\n>(({ className, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <button\n      ref={ref}\n      data-sidebar=\"rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarRail.displayName = \"SidebarRail\"\n\nconst SidebarInset = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"main\">\n>(({ className, ...props }, ref) => {\n  return (\n    <main\n      ref={ref}\n      className={cn(\n        \"relative flex w-full flex-1 flex-col bg-background\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInset.displayName = \"SidebarInset\"\n\nconst SidebarInput = React.forwardRef<\n  React.ElementRef<typeof Input>,\n  React.ComponentProps<typeof Input>\n>(({ className, ...props }, ref) => {\n  return (\n    <Input\n      ref={ref}\n      data-sidebar=\"input\"\n      className={cn(\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInput.displayName = \"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarHeader.displayName = \"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarFooter.displayName = \"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef<\n  React.ElementRef<typeof Separator>,\n  React.ComponentProps<typeof Separator>\n>(({ className, ...props }, ref) => {\n  return (\n    <Separator\n      ref={ref}\n      data-sidebar=\"separator\"\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n      {...props}\n    />\n  )\n})\nSidebarSeparator.displayName = \"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarContent.displayName = \"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarGroup.displayName = \"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"group-content\"\n    className={cn(\"w-full text-sm\", className)}\n    {...props}\n  />\n))\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu\"\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n    {...props}\n  />\n))\nSidebarMenu.displayName = \"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    data-sidebar=\"menu-item\"\n    className={cn(\"group/menu-item relative\", className)}\n    {...props}\n  />\n))\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst SidebarMenuButton = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    isActive?: boolean\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>\n  } & VariantProps<typeof sidebarMenuButtonVariants>\n>(\n  (\n    {\n      asChild = false,\n      isActive = false,\n      variant = \"default\",\n      size = \"default\",\n      tooltip,\n      className,\n      ...props\n    },\n    ref\n  ) => {\n    const Comp = asChild ? Slot : \"button\"\n    const { isMobile, state } = useSidebar()\n\n    const button = (\n      <Comp\n        ref={ref}\n        data-sidebar=\"menu-button\"\n        data-size={size}\n        data-active={isActive}\n        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n        {...props}\n      />\n    )\n\n    if (!tooltip) {\n      return button\n    }\n\n    if (typeof tooltip === \"string\") {\n      tooltip = {\n        children: tooltip,\n      }\n    }\n\n    return (\n      <Tooltip>\n        <TooltipTrigger asChild>{button}</TooltipTrigger>\n        <TooltipContent\n          side=\"right\"\n          align=\"center\"\n          hidden={state !== \"collapsed\" || isMobile}\n          {...tooltip}\n        />\n      </Tooltip>\n    )\n  }\n)\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    showOnHover?: boolean\n  }\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"menu-badge\"\n    className={cn(\n      \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n      \"peer-data-[size=sm]/menu-button:top-1\",\n      \"peer-data-[size=default]/menu-button:top-1.5\",\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    showIcon?: boolean\n  }\n>(({ className, showIcon = false, ...props }, ref) => {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[--skeleton-width] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n})\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu-sub\"\n    className={cn(\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentProps<\"a\"> & {\n    asChild?: boolean\n    size?: \"sm\" | \"md\"\n    isActive?: boolean\n  }\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","size_bytes":23567},"client/src/components/layout/admin-sidebar.tsx":{"content":"import { useLocation } from \"wouter\";\nimport { \n  Users, \n  Package, \n  FolderTree, \n  Percent,\n  Settings,\n  LayoutDashboard,\n  LogOut,\n  Repeat,\n  Trophy\n} from \"lucide-react\";\nimport { useAuth } from \"@/hooks/use-auth\";\n\ninterface AdminSidebarProps {\n  collapsed: boolean;\n  activeTab?: string;\n  onTabChange?: (tab: string) => void;\n}\n\nconst adminMenuItems = [\n  { tab: \"dashboard\", icon: LayoutDashboard, label: \"Dashboard\" },\n  { tab: \"users\", icon: Users, label: \"Usuários\" },\n  { tab: \"master-clients\", icon: Users, label: \"Clientes Master\" },\n  { tab: \"categories\", icon: FolderTree, label: \"Categorias\" },\n  { tab: \"subcategories\", icon: FolderTree, label: \"Subcategorias\" },\n  { tab: \"products\", icon: Package, label: \"Produtos\" },\n  { tab: \"commissions\", icon: Percent, label: \"Comissões\" },\n  { tab: \"parameters\", icon: Settings, label: \"Parâmetros\" },\n  { tab: \"barter\", icon: Repeat, label: \"Barter\" },\n  { tab: \"timac\", icon: Trophy, label: \"Timac\" },\n];\n\nexport default function AdminSidebar({ collapsed, activeTab = \"users\", onTabChange }: AdminSidebarProps) {\n  const [location, setLocation] = useLocation();\n  const { user, logoutMutation } = useAuth();\n\n  const handleLogout = () => {\n    logoutMutation.mutate(undefined, {\n      onSuccess: () => {\n        setLocation(\"/auth\");\n      }\n    });\n  };\n\n  const getInitials = (name: string) => {\n    return name\n      .split(' ')\n      .map(word => word[0])\n      .join('')\n      .toUpperCase()\n      .slice(0, 2);\n  };\n\n  return (\n    <aside \n      className={`bg-card border-r border-border flex flex-col slide-in transition-all duration-300 ${\n        collapsed ? 'w-20' : 'w-72'\n      }`}\n      data-testid=\"admin-sidebar\"\n    >\n      {/* Logo & Brand */}\n      <div className=\"p-6 border-b border-border\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center flex-shrink-0\">\n            <Settings className=\"text-white text-xl\" />\n          </div>\n          {!collapsed && (\n            <div className=\"menu-text\">\n              <h1 className=\"text-lg font-bold text-foreground\">Super Admin</h1>\n              <p className=\"text-xs text-muted-foreground\">Painel de Gestão</p>\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Navigation */}\n      <nav className=\"flex-1 overflow-y-auto p-4\">\n        <ul className=\"space-y-1\">\n          {adminMenuItems.map((item) => {\n            const Icon = item.icon;\n            const isActive = activeTab === item.tab;\n            \n            return (\n              <li key={item.tab}>\n                <button\n                  onClick={() => onTabChange?.(item.tab)}\n                  className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-colors border-l-4 ${\n                    isActive \n                      ? 'bg-blue-50 dark:bg-blue-950 text-blue-800 dark:text-blue-200 border-blue-600 dark:border-blue-500' \n                      : 'hover:bg-muted text-foreground border-transparent'\n                  }`}\n                  data-testid={`admin-nav-${item.label.toLowerCase().replace(/\\s+/g, '-')}`}\n                >\n                  <Icon className=\"text-lg flex-shrink-0\" size={20} />\n                  {!collapsed && (\n                    <span className=\"menu-text font-medium text-left\">{item.label}</span>\n                  )}\n                </button>\n              </li>\n            );\n          })}\n        </ul>\n      </nav>\n\n      {/* User Section */}\n      <div className=\"border-t border-border p-4\">\n        <div className={`flex items-center gap-3 ${collapsed ? 'justify-center' : ''}`}>\n          <div className=\"w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0\">\n            <span className=\"text-white font-medium text-sm\">\n              {user ? getInitials(user.name) : 'SA'}\n            </span>\n          </div>\n          {!collapsed && (\n            <div className=\"flex-1 min-w-0 menu-text\">\n              <p className=\"text-sm font-medium text-foreground truncate\">{user?.name}</p>\n              <p className=\"text-xs text-muted-foreground\">Super Admin</p>\n            </div>\n          )}\n        </div>\n        {!collapsed && (\n          <button\n            onClick={handleLogout}\n            className=\"mt-3 w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-950 transition-colors\"\n            data-testid=\"admin-logout-button\"\n          >\n            <LogOut size={16} />\n            <span>Sair</span>\n          </button>\n        )}\n      </div>\n    </aside>\n  );\n}\n","size_bytes":4638},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","size_bytes":2154},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","size_bytes":329},"client/src/pages/parametros.tsx":{"content":"import Sidebar from \"@/components/layout/sidebar\";\nimport Header from \"@/components/layout/header\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Plus, Save, Settings, Calendar, Percent, Info } from \"lucide-react\";\nimport type { SeasonParameter, InsertSeasonParameter } from \"@shared/schema\";\n\nexport default function Parametros() {\n  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);\n  const [showNewParameterModal, setShowNewParameterModal] = useState(false);\n  const [activeTab, setActiveTab] = useState(\"season-params\");\n  const { toast } = useToast();\n\n  const [formData, setFormData] = useState({\n    type: \"\",\n    dueDateMonth: 1,\n    dueDateDay: 1,\n    labelPattern: \"\",\n  });\n\n  const [ivaSettings, setIvaSettings] = useState({\n    defaultRate: \"10.00\",\n    fertilizantesRate: \"10.00\",\n    sementesRate: \"10.00\",\n    especialidadesRate: \"10.00\",\n    agroquimicosRate: \"10.00\",\n  });\n\n  const { data: seasonParameters, isLoading } = useQuery<SeasonParameter[]>({\n    queryKey: [\"/api/season-parameters\"],\n  });\n\n  const createParameterMutation = useMutation({\n    mutationFn: async (parameterData: InsertSeasonParameter) => {\n      return apiRequest(\"POST\", \"/api/season-parameters\", parameterData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/season-parameters\"] });\n      toast({\n        title: \"Parâmetro cadastrado\",\n        description: \"O parâmetro de safra foi cadastrado com sucesso.\",\n      });\n      setShowNewParameterModal(false);\n      resetForm();\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao cadastrar parâmetro. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const toggleSidebar = () => {\n    setSidebarCollapsed(!sidebarCollapsed);\n  };\n\n  const resetForm = () => {\n    setFormData({\n      type: \"\",\n      dueDateMonth: 1,\n      dueDateDay: 1,\n      labelPattern: \"\",\n    });\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!formData.type || !formData.labelPattern) {\n      toast({\n        title: \"Campos obrigatórios\",\n        description: \"Preencha todos os campos obrigatórios.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const parameterData: InsertSeasonParameter = {\n      type: formData.type,\n      dueDateMonth: formData.dueDateMonth,\n      dueDateDay: formData.dueDateDay,\n      labelPattern: formData.labelPattern,\n    };\n\n    createParameterMutation.mutate(parameterData);\n  };\n\n  const handleSaveIvaSettings = () => {\n    // This would be implemented to save IVA settings to the backend\n    toast({\n      title: \"Configurações salvas\",\n      description: \"As configurações de IVA foram atualizadas com sucesso.\",\n    });\n  };\n\n  const getTypeLabel = (type: string) => {\n    switch (type) {\n      case \"soja_verao\": return \"Soja Verão\";\n      case \"soja_safrinha\": return \"Soja Safrinha\";\n      case \"milho\": return \"Milho\";\n      case \"trigo\": return \"Trigo\";\n      default: return type;\n    }\n  };\n\n  const getTypeBadgeClass = (type: string) => {\n    switch (type) {\n      case \"soja_verao\": return \"bg-verde/10 text-verde border-verde/20\";\n      case \"soja_safrinha\": return \"bg-chart-2/10 text-chart-2 border-chart-2/20\";\n      case \"milho\": return \"bg-amarela/10 text-amarela border-amarela/20\";\n      case \"trigo\": return \"bg-chart-4/10 text-chart-4 border-chart-4/20\";\n      default: return \"bg-muted text-muted-foreground\";\n    }\n  };\n\n  const months = [\n    { value: 1, label: \"Janeiro\" },\n    { value: 2, label: \"Fevereiro\" },\n    { value: 3, label: \"Março\" },\n    { value: 4, label: \"Abril\" },\n    { value: 5, label: \"Maio\" },\n    { value: 6, label: \"Junho\" },\n    { value: 7, label: \"Julho\" },\n    { value: 8, label: \"Agosto\" },\n    { value: 9, label: \"Setembro\" },\n    { value: 10, label: \"Outubro\" },\n    { value: 11, label: \"Novembro\" },\n    { value: 12, label: \"Dezembro\" },\n  ];\n\n  const totalParameters = seasonParameters?.length || 0;\n\n  if (isLoading) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-32 w-32 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex h-screen overflow-hidden\" data-testid=\"parametros-container\">\n      <Sidebar collapsed={sidebarCollapsed} />\n      \n      <main className=\"flex-1 overflow-y-auto\">\n        <Header \n          onToggleSidebar={toggleSidebar}\n          onNewSale={() => {}}\n          title=\"Parâmetros do Sistema\"\n          subtitle=\"Configurações de safras, IVA e classificações\"\n        />\n\n        <div className=\"p-8\">\n          {/* Summary Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6 mb-8\">\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center\">\n                    <Calendar className=\"text-primary\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Parâmetros de Safra</p>\n                    <p className=\"text-2xl font-bold\">{totalParameters}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                    <Percent className=\"text-chart-2\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">IVA Padrão</p>\n                    <p className=\"text-2xl font-bold font-mono\">{ivaSettings.defaultRate}%</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-accent/10 rounded-lg flex items-center justify-center\">\n                    <Settings className=\"text-accent\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Configurações Ativas</p>\n                    <p className=\"text-2xl font-bold\">5</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Configuration Tabs */}\n          <Card className=\"shadow-sm\">\n            <CardHeader>\n              <CardTitle>Configurações do Sistema</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <Tabs value={activeTab} onValueChange={setActiveTab}>\n                <TabsList className=\"grid w-full grid-cols-2\">\n                  <TabsTrigger value=\"season-params\">Parâmetros de Safra</TabsTrigger>\n                  <TabsTrigger value=\"iva-settings\">Configurações de IVA</TabsTrigger>\n                </TabsList>\n\n                <TabsContent value=\"season-params\" className=\"space-y-6\">\n                  <div className=\"flex justify-between items-center\">\n                    <div>\n                      <h3 className=\"text-lg font-semibold\">Parâmetros de Classificação de Safra</h3>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Configure as datas e padrões de nomenclatura para classificação automática de safras\n                      </p>\n                    </div>\n                    <Dialog open={showNewParameterModal} onOpenChange={setShowNewParameterModal}>\n                      <DialogTrigger asChild>\n                        <Button data-testid=\"button-new-parameter\">\n                          <Plus className=\"h-4 w-4 mr-2\" />\n                          Novo Parâmetro\n                        </Button>\n                      </DialogTrigger>\n                      <DialogContent className=\"max-w-2xl\" data-testid=\"new-parameter-modal\">\n                        <DialogHeader>\n                          <DialogTitle>Novo Parâmetro de Safra</DialogTitle>\n                        </DialogHeader>\n                        <form onSubmit={handleSubmit} className=\"space-y-4\">\n                          <div>\n                            <Label htmlFor=\"type\">Tipo de Safra *</Label>\n                            <Select value={formData.type} onValueChange={(value) => \n                              setFormData(prev => ({ ...prev, type: value }))\n                            }>\n                              <SelectTrigger data-testid=\"select-season-type\">\n                                <SelectValue placeholder=\"Selecione o tipo\" />\n                              </SelectTrigger>\n                              <SelectContent>\n                                <SelectItem value=\"soja_verao\">Soja Verão</SelectItem>\n                                <SelectItem value=\"soja_safrinha\">Soja Safrinha</SelectItem>\n                                <SelectItem value=\"milho\">Milho</SelectItem>\n                                <SelectItem value=\"trigo\">Trigo</SelectItem>\n                              </SelectContent>\n                            </Select>\n                          </div>\n\n                          <div className=\"grid grid-cols-2 gap-4\">\n                            <div>\n                              <Label htmlFor=\"month\">Mês de Vencimento *</Label>\n                              <Select value={formData.dueDateMonth.toString()} onValueChange={(value) => \n                                setFormData(prev => ({ ...prev, dueDateMonth: parseInt(value) }))\n                              }>\n                                <SelectTrigger data-testid=\"select-month\">\n                                  <SelectValue placeholder=\"Selecione o mês\" />\n                                </SelectTrigger>\n                                <SelectContent>\n                                  {months.map((month) => (\n                                    <SelectItem key={month.value} value={month.value.toString()}>\n                                      {month.label}\n                                    </SelectItem>\n                                  ))}\n                                </SelectContent>\n                              </Select>\n                            </div>\n                            <div>\n                              <Label htmlFor=\"day\">Dia do Vencimento *</Label>\n                              <Input\n                                type=\"number\"\n                                min=\"1\"\n                                max=\"31\"\n                                value={formData.dueDateDay}\n                                onChange={(e) => setFormData(prev => ({ ...prev, dueDateDay: parseInt(e.target.value) }))}\n                                data-testid=\"input-day\"\n                              />\n                            </div>\n                          </div>\n\n                          <div>\n                            <Label htmlFor=\"labelPattern\">Padrão de Nome *</Label>\n                            <Input\n                              value={formData.labelPattern}\n                              onChange={(e) => setFormData(prev => ({ ...prev, labelPattern: e.target.value }))}\n                              placeholder=\"Ex: Soja {year}/{next_year}\"\n                              data-testid=\"input-label-pattern\"\n                            />\n                            <p className=\"text-xs text-muted-foreground mt-1\">\n                              Use {\"{year}\"} para ano atual e {\"{next_year}\"} para próximo ano\n                            </p>\n                          </div>\n\n                          <div className=\"flex justify-end gap-3 pt-4\">\n                            <Button\n                              type=\"button\"\n                              variant=\"outline\"\n                              onClick={() => setShowNewParameterModal(false)}\n                              data-testid=\"button-cancel\"\n                            >\n                              Cancelar\n                            </Button>\n                            <Button\n                              type=\"submit\"\n                              disabled={createParameterMutation.isPending}\n                              data-testid=\"button-save\"\n                            >\n                              {createParameterMutation.isPending ? \"Salvando...\" : \"Salvar Parâmetro\"}\n                            </Button>\n                          </div>\n                        </form>\n                      </DialogContent>\n                    </Dialog>\n                  </div>\n\n                  {seasonParameters?.length === 0 ? (\n                    <div className=\"text-center py-12 border border-border rounded-lg\">\n                      <Calendar className=\"h-16 w-16 mx-auto text-muted-foreground mb-4\" />\n                      <p className=\"text-muted-foreground mb-4\">Nenhum parâmetro configurado</p>\n                      <Button \n                        onClick={() => setShowNewParameterModal(true)}\n                        data-testid=\"button-first-parameter\"\n                      >\n                        <Plus className=\"h-4 w-4 mr-2\" />\n                        Configurar primeiro parâmetro\n                      </Button>\n                    </div>\n                  ) : (\n                    <div className=\"overflow-x-auto\">\n                      <Table>\n                        <TableHeader>\n                          <TableRow>\n                            <TableHead>Tipo de Safra</TableHead>\n                            <TableHead>Mês de Vencimento</TableHead>\n                            <TableHead>Dia de Vencimento</TableHead>\n                            <TableHead>Padrão de Nome</TableHead>\n                            <TableHead>Exemplo</TableHead>\n                          </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                          {seasonParameters?.map((parameter) => (\n                            <TableRow key={parameter.id} data-testid={`parameter-row-${parameter.id}`}>\n                              <TableCell>\n                                <Badge className={getTypeBadgeClass(parameter.type)}>\n                                  {getTypeLabel(parameter.type)}\n                                </Badge>\n                              </TableCell>\n                              <TableCell>\n                                {months.find(m => m.value === parameter.dueDateMonth)?.label}\n                              </TableCell>\n                              <TableCell className=\"text-center\">{parameter.dueDateDay}</TableCell>\n                              <TableCell className=\"font-mono text-sm\">\n                                {parameter.labelPattern}\n                              </TableCell>\n                              <TableCell className=\"text-sm text-muted-foreground\">\n                                {parameter.labelPattern\n                                  .replace(\"{year}\", \"25\")\n                                  .replace(\"{next_year}\", \"26\")\n                                }\n                              </TableCell>\n                            </TableRow>\n                          ))}\n                        </TableBody>\n                      </Table>\n                    </div>\n                  )}\n                </TabsContent>\n\n                <TabsContent value=\"iva-settings\" className=\"space-y-6\">\n                  <div>\n                    <h3 className=\"text-lg font-semibold\">Configurações de IVA do Paraguai</h3>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Configure as alíquotas de IVA por categoria de produto\n                    </p>\n                  </div>\n\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-base\">IVA Padrão do Sistema</CardTitle>\n                      </CardHeader>\n                      <CardContent className=\"space-y-4\">\n                        <div>\n                          <Label htmlFor=\"defaultIva\">Alíquota Padrão (%)</Label>\n                          <Input\n                            type=\"number\"\n                            step=\"0.01\"\n                            value={ivaSettings.defaultRate}\n                            onChange={(e) => setIvaSettings(prev => ({ ...prev, defaultRate: e.target.value }))}\n                            className=\"font-mono\"\n                            data-testid=\"input-default-iva\"\n                          />\n                          <p className=\"text-xs text-muted-foreground mt-1\">\n                            Usado quando não há configuração específica por categoria\n                          </p>\n                        </div>\n                      </CardContent>\n                    </Card>\n\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-base\">IVA por Categoria</CardTitle>\n                      </CardHeader>\n                      <CardContent className=\"space-y-4\">\n                        <div>\n                          <Label htmlFor=\"fertilizantesIva\">Fertilizantes (%)</Label>\n                          <Input\n                            type=\"number\"\n                            step=\"0.01\"\n                            value={ivaSettings.fertilizantesRate}\n                            onChange={(e) => setIvaSettings(prev => ({ ...prev, fertilizantesRate: e.target.value }))}\n                            className=\"font-mono\"\n                            data-testid=\"input-fertilizantes-iva\"\n                          />\n                        </div>\n\n                        <div>\n                          <Label htmlFor=\"sementesIva\">Sementes (%)</Label>\n                          <Input\n                            type=\"number\"\n                            step=\"0.01\"\n                            value={ivaSettings.sementesRate}\n                            onChange={(e) => setIvaSettings(prev => ({ ...prev, sementesRate: e.target.value }))}\n                            className=\"font-mono\"\n                            data-testid=\"input-sementes-iva\"\n                          />\n                        </div>\n\n                        <div>\n                          <Label htmlFor=\"especialidadesIva\">Especialidades (%)</Label>\n                          <Input\n                            type=\"number\"\n                            step=\"0.01\"\n                            value={ivaSettings.especialidadesRate}\n                            onChange={(e) => setIvaSettings(prev => ({ ...prev, especialidadesRate: e.target.value }))}\n                            className=\"font-mono\"\n                            data-testid=\"input-especialidades-iva\"\n                          />\n                        </div>\n\n                        <div>\n                          <Label htmlFor=\"agroquimicosIva\">Agroquímicos (%)</Label>\n                          <Input\n                            type=\"number\"\n                            step=\"0.01\"\n                            value={ivaSettings.agroquimicosRate}\n                            onChange={(e) => setIvaSettings(prev => ({ ...prev, agroquimicosRate: e.target.value }))}\n                            className=\"font-mono\"\n                            data-testid=\"input-agroquimicos-iva\"\n                          />\n                        </div>\n                      </CardContent>\n                    </Card>\n                  </div>\n\n                  <div className=\"flex justify-end\">\n                    <Button onClick={handleSaveIvaSettings} data-testid=\"button-save-iva\">\n                      <Save className=\"h-4 w-4 mr-2\" />\n                      Salvar Configurações de IVA\n                    </Button>\n                  </div>\n\n                  <Card className=\"bg-muted/30\">\n                    <CardContent className=\"p-4\">\n                      <div className=\"flex items-start gap-3\">\n                        <Info className=\"h-5 w-5 text-chart-2 mt-0.5\" />\n                        <div>\n                          <h4 className=\"text-sm font-semibold mb-1\">Informação Importante</h4>\n                          <p className=\"text-xs text-muted-foreground\">\n                            As configurações de IVA são aplicadas automaticamente no cálculo de comissões. \n                            As alterações afetarão apenas vendas futuras, não modificando vendas já registradas.\n                          </p>\n                        </div>\n                      </div>\n                    </CardContent>\n                  </Card>\n                </TabsContent>\n              </Tabs>\n            </CardContent>\n          </Card>\n        </div>\n      </main>\n    </div>\n  );\n}\n","size_bytes":21991},"client/src/hooks/use-auth.tsx":{"content":"// Blueprint: javascript_auth_all_persistance - Auth hook\nimport { createContext, ReactNode, useContext } from \"react\";\nimport {\n  useQuery,\n  useMutation,\n  UseMutationResult,\n} from \"@tanstack/react-query\";\nimport { User as SelectUser, InsertUser } from \"@shared/schema\";\nimport { getQueryFn, apiRequest, queryClient } from \"../lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\n\ntype AuthContextType = {\n  user: SelectUser | null;\n  isLoading: boolean;\n  error: Error | null;\n  loginMutation: UseMutationResult<SelectUser, Error, LoginData>;\n  logoutMutation: UseMutationResult<void, Error, void>;\n  registerMutation: UseMutationResult<SelectUser, Error, InsertUser>;\n};\n\ntype LoginData = Pick<InsertUser, \"username\" | \"password\">;\n\nexport const AuthContext = createContext<AuthContextType | null>(null);\n\nexport function AuthProvider({ children }: { children: ReactNode }) {\n  const { toast } = useToast();\n  const {\n    data: user,\n    error,\n    isLoading,\n  } = useQuery<SelectUser | undefined, Error>({\n    queryKey: [\"/api/user\"],\n    queryFn: getQueryFn({ on401: \"returnNull\" }),\n  });\n\n  const loginMutation = useMutation({\n    mutationFn: async (credentials: LoginData) => {\n      const res = await apiRequest(\"POST\", \"/api/login\", credentials);\n      return await res.json();\n    },\n    onSuccess: (user: SelectUser) => {\n      queryClient.setQueryData([\"/api/user\"], user);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Erro ao fazer login\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const registerMutation = useMutation({\n    mutationFn: async (credentials: InsertUser) => {\n      const res = await apiRequest(\"POST\", \"/api/register\", credentials);\n      return await res.json();\n    },\n    onSuccess: (user: SelectUser) => {\n      queryClient.setQueryData([\"/api/user\"], user);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Erro no cadastro\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const logoutMutation = useMutation({\n    mutationFn: async () => {\n      await apiRequest(\"POST\", \"/api/logout\");\n    },\n    onSuccess: () => {\n      // Clear ALL cached data to prevent data leakage between users\n      queryClient.clear();\n      // Set user to null for immediate UI update\n      queryClient.setQueryData([\"/api/user\"], null);\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Erro ao sair\",\n        description: error.message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  return (\n    <AuthContext.Provider\n      value={{\n        user: user ?? null,\n        isLoading,\n        error,\n        loginMutation,\n        logoutMutation,\n        registerMutation,\n      }}\n    >\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (!context) {\n    throw new Error(\"useAuth must be used within an AuthProvider\");\n  }\n  return context;\n}\n","size_bytes":3022},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","size_bytes":2263},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","size_bytes":1209},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","size_bytes":565},"client/src/pages/historico-compras.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport {\n  Select,\n  SelectContent,\n  SelectItem,\n  SelectTrigger,\n  SelectValue,\n} from \"@/components/ui/select\";\nimport { Upload, FileText, Trash2, Calendar, DollarSign, Package, TrendingUp, Target, ShoppingCart, Percent, Pencil } from \"lucide-react\";\nimport Navbar from \"@/components/layout/navbar\";\nimport Header from \"@/components/layout/header\";\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from \"@/components/ui/table\";\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogHeader,\n  DialogTitle,\n} from \"@/components/ui/dialog\";\n\ninterface PurchaseHistory {\n  id: string;\n  userId: string;\n  clientId: string;\n  seasonId: string | null;\n  seasonName: string;\n  sourceFile: string;\n  totalAmount: string;\n  importDate: Date;\n}\n\ninterface PurchaseHistoryItem {\n  id: string;\n  purchaseHistoryId: string;\n  productCode: string;\n  productName: string;\n  packageType: string;\n  quantity: string;\n  unitPrice: string;\n  totalPrice: string;\n  purchaseDate: Date;\n  orderCode: string;\n}\n\ninterface ParseResult {\n  clientId: string;\n  clientName: string;\n  seasonId: string | null;\n  seasonName: string;\n  totalAmount: number;\n  itemsCount: number;\n  items: Array<{\n    productCode: string;\n    productName: string;\n    packageType: string;\n    quantity: number;\n    unitPrice: number;\n    totalPrice: number;\n    purchaseDate: string;\n    orderCode: string;\n  }>;\n  fileName: string;\n  autoCreatedProducts?: Array<{\n    productName: string;\n    productCode: string;\n    categoryId: string;\n    hasCategory: true;\n  }>;\n  uncategorizedProducts?: Array<{\n    productName: string;\n    productCode: string;\n    hasCategory: false;\n  }>;\n}\n\ninterface HistoricalProduct {\n  productCode: string;\n  productName: string;\n  packageType: string;\n  quantity: number;\n  unitPrice: number;\n  totalPrice: number;\n  purchaseDate: Date;\n  segment: string | null;\n  subcategoryId: string | null;\n}\n\ninterface CurrentSeasonProduct {\n  productId: string;\n  productName: string;\n  quantity: number;\n  unitPrice: number;\n  totalPrice: number;\n  saleDate: Date;\n  segment: string | null;\n  subcategoryId: string | null;\n}\n\ninterface CategoryData {\n  categoryId: string;\n  categoryName: string;\n  historicalProducts: HistoricalProduct[];\n  currentSeasonProducts: CurrentSeasonProduct[];\n}\n\ninterface MonthlyTimelineItem {\n  month: number;\n  monthName: string;\n  hasPurchases: boolean;\n  itemCount: number;\n  totalValue: number;\n  isCurrentMonth: boolean;\n}\n\ninterface OpportunitiesResponse {\n  clientId: string;\n  seasonName: string;\n  historicalSeasonName: string;\n  categoriesData: CategoryData[];\n  monthlyTimeline: MonthlyTimelineItem[];\n  currentSeasonMonthlyTimeline: MonthlyTimelineItem[];\n  summary: {\n    totalHistoricalProducts: number;\n    totalSoldThisSeason: number;\n    conversionRate: string;\n  };\n}\n\nconst getSegmentDisplay = (segment: string | null): { segment: string; color: string } => {\n  if (!segment) {\n    return { segment: 'Outros', color: 'bg-gray-500' };\n  }\n\n  const segmentLower = segment.toLowerCase();\n  \n  switch (segmentLower) {\n    case 'ts':\n      return { segment: 'TS', color: 'bg-purple-600' };\n    case 'fungicida':\n      return { segment: 'Fungicida', color: 'bg-green-600' };\n    case 'inseticida':\n      return { segment: 'Inseticida', color: 'bg-blue-600' };\n    case 'herbicida':\n      return { segment: 'Herbicida', color: 'bg-yellow-600' };\n    default:\n      return { segment: 'Outros', color: 'bg-gray-500' };\n  }\n};\n\nconst groupProductsBySegment = <T extends { segment: string | null }>(products: T[], isAgrochemical: boolean) => {\n  if (!isAgrochemical) {\n    return { 'Todos': products };\n  }\n  \n  const grouped: Record<string, T[]> = {};\n  \n  products.forEach(product => {\n    const { segment } = getSegmentDisplay(product.segment);\n    if (!grouped[segment]) {\n      grouped[segment] = [];\n    }\n    grouped[segment].push(product);\n  });\n  \n  const order = ['TS', 'Herbicida', 'Inseticida', 'Fungicida', 'Outros'];\n  const sorted: Record<string, T[]> = {};\n  order.forEach(seg => {\n    if (grouped[seg]) {\n      sorted[seg] = grouped[seg];\n    }\n  });\n  \n  return sorted;\n};\n\nexport default function HistoricoCompras() {\n  const { toast } = useToast();\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [parseResult, setParseResult] = useState<ParseResult | null>(null);\n  const [selectedHistory, setSelectedHistory] = useState<string | null>(null);\n  const [isDragging, setIsDragging] = useState(false);\n  const [selectedAnalysisHistory, setSelectedAnalysisHistory] = useState<string>(\"\");\n  const [selectedClientId, setSelectedClientId] = useState<string>(\"\");\n  const [selectedSeasonId, setSelectedSeasonId] = useState<string>(\"\");\n  const [showEditProductModal, setShowEditProductModal] = useState(false);\n  const [editingProduct, setEditingProduct] = useState<{ id: string; name: string; categoryId: string; subcategoryId: string | null; segment: string | null } | null>(null);\n  const [editFormData, setEditFormData] = useState({\n    categoryId: \"\",\n    subcategoryId: \"\",\n    segment: \"\"\n  });\n  const [selectedMonth, setSelectedMonth] = useState<number | null>(null);\n  const [selectedTimelineType, setSelectedTimelineType] = useState<'historical' | 'current' | null>(null);\n\n  const { data: histories, isLoading: loadingHistories } = useQuery<PurchaseHistory[]>({\n    queryKey: selectedClientId \n      ? [\"/api/clients\", selectedClientId, \"purchase-history\"]\n      : [\"/api/purchase-history\"],\n    enabled: !selectedClientId || !!selectedClientId,\n  });\n\n  const { data: historyItems, isLoading: loadingItems } = useQuery<PurchaseHistoryItem[]>({\n    queryKey: [\"/api/purchase-history\", selectedHistory, \"items\"],\n    enabled: !!selectedHistory,\n  });\n\n  const { data: clients } = useQuery<Array<{ id: string; name: string }>>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: seasons } = useQuery<Array<{ id: string; name: string; isActive: boolean }>>({\n    queryKey: [\"/api/seasons\"],\n  });\n\n  const { data: subcategories } = useQuery<Array<{ id: string; name: string; categoryId: string }>>({\n    queryKey: [\"/api/subcategories\"],\n  });\n\n  const { data: categories } = useQuery<Array<{ id: string; name: string; type: string }>>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const { data: products } = useQuery<Array<{ id: string; name: string; categoryId: string; subcategoryId: string | null; segment: string | null }>>({\n    queryKey: [\"/api/products\"],\n  });\n\n  const updateProductMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: any }) => {\n      return apiRequest(\"PATCH\", `/api/products/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/products\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/purchase-history\"] });\n      queryClient.invalidateQueries({ \n        predicate: (query) => {\n          const key = query.queryKey as string[];\n          return key[0] === \"/api/purchase-history\" && key[2] === \"opportunities\";\n        }\n      });\n      toast({\n        title: \"Produto atualizado\",\n        description: \"O produto foi reclassificado com sucesso.\",\n      });\n      setShowEditProductModal(false);\n      setEditingProduct(null);\n    },\n    onError: () => {\n      toast({\n        variant: \"destructive\",\n        title: \"Erro\",\n        description: \"Falha ao atualizar produto.\",\n      });\n    },\n  });\n\n  const { data: opportunitiesData, isLoading: loadingOpportunities } = useQuery<OpportunitiesResponse>({\n    queryKey: [\"/api/purchase-history\", selectedAnalysisHistory, \"opportunities\", selectedSeasonId],\n    queryFn: async () => {\n      const timestamp = Date.now();\n      const url = selectedSeasonId \n        ? `/api/purchase-history/${selectedAnalysisHistory}/opportunities?seasonId=${selectedSeasonId}&_t=${timestamp}`\n        : `/api/purchase-history/${selectedAnalysisHistory}/opportunities?_t=${timestamp}`;\n      const response = await fetch(url, { credentials: \"include\" });\n      if (!response.ok) throw new Error(\"Failed to fetch opportunities\");\n      return response.json();\n    },\n    enabled: !!selectedAnalysisHistory && !!selectedSeasonId,\n  });\n\n  const parseMutation = useMutation({\n    mutationFn: async (file: File) => {\n      const formData = new FormData();\n      formData.append(\"file\", file);\n      const response = await fetch(\"/api/purchase-history/parse-pdf\", {\n        method: \"POST\",\n        body: formData,\n        credentials: \"include\",\n      });\n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.error || \"Failed to parse PDF\");\n      }\n      return response.json();\n    },\n    onSuccess: (data: ParseResult) => {\n      setParseResult(data);\n      toast({\n        title: \"PDF Analisado\",\n        description: `${data.itemsCount} produtos encontrados para ${data.clientName}`,\n      });\n    },\n    onError: (error: Error) => {\n      toast({\n        variant: \"destructive\",\n        title: \"Erro ao analisar PDF\",\n        description: error.message,\n      });\n    },\n  });\n\n  const saveMutation = useMutation({\n    mutationFn: async (data: ParseResult) => {\n      return apiRequest(\"POST\", \"/api/purchase-history\", {\n        clientId: data.clientId,\n        seasonId: data.seasonId,\n        seasonName: data.seasonName,\n        sourceFile: data.fileName,\n        totalAmount: data.totalAmount.toString(),\n        items: data.items.map(item => ({\n          ...item,\n          quantity: item.quantity.toString(),\n          unitPrice: item.unitPrice.toString(),\n          totalPrice: item.totalPrice.toString(),\n        })),\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/purchase-history\"] });\n      setParseResult(null);\n      setSelectedFile(null);\n      toast({\n        title: \"Histórico Salvo\",\n        description: \"Histórico de compras importado com sucesso\",\n      });\n    },\n    onError: () => {\n      toast({\n        variant: \"destructive\",\n        title: \"Erro\",\n        description: \"Falha ao salvar histórico\",\n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/purchase-history/${id}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/purchase-history\"] });\n      if (selectedHistory) {\n        setSelectedHistory(null);\n      }\n      toast({\n        title: \"Excluído\",\n        description: \"Histórico removido com sucesso\",\n      });\n    },\n    onError: () => {\n      toast({\n        variant: \"destructive\",\n        title: \"Erro\",\n        description: \"Falha ao excluir histórico\",\n      });\n    },\n  });\n\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file && file.type === \"application/pdf\") {\n      setSelectedFile(file);\n      parseMutation.mutate(file);\n    } else {\n      toast({\n        variant: \"destructive\",\n        title: \"Arquivo Inválido\",\n        description: \"Selecione um arquivo PDF\",\n      });\n    }\n  };\n\n  const handleDragOver = (e: React.DragEvent<HTMLLabelElement>) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setIsDragging(true);\n  };\n\n  const handleDragLeave = (e: React.DragEvent<HTMLLabelElement>) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setIsDragging(false);\n  };\n\n  const handleDrop = (e: React.DragEvent<HTMLLabelElement>) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setIsDragging(false);\n\n    const file = e.dataTransfer.files?.[0];\n    if (file && file.type === \"application/pdf\") {\n      setSelectedFile(file);\n      parseMutation.mutate(file);\n    } else {\n      toast({\n        variant: \"destructive\",\n        title: \"Arquivo Inválido\",\n        description: \"Arraste um arquivo PDF\",\n      });\n    }\n  };\n\n  const getClientName = (clientId: string) => {\n    return clients?.find((c) => c.id === clientId)?.name || \"Desconhecido\";\n  };\n\n  const getSubcategoryName = (subcategoryId: string | null) => {\n    if (!subcategoryId) return null;\n    return subcategories?.find(s => s.id === subcategoryId)?.name || null;\n  };\n\n  const openEditModal = (productName: string) => {\n    const product = products?.find(p => p.name === productName);\n    if (!product) {\n      toast({\n        variant: \"destructive\",\n        title: \"Produto não encontrado\",\n        description: \"Não foi possível encontrar este produto.\",\n      });\n      return;\n    }\n\n    setEditingProduct(product);\n    setEditFormData({\n      categoryId: product.categoryId,\n      subcategoryId: product.subcategoryId || \"\",\n      segment: product.segment || \"\"\n    });\n    setShowEditProductModal(true);\n  };\n\n  const handleEditSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!editingProduct || !editFormData.categoryId) {\n      toast({\n        variant: \"destructive\",\n        title: \"Campos obrigatórios\",\n        description: \"Selecione uma categoria.\",\n      });\n      return;\n    }\n\n    const updateData: any = {\n      categoryId: editFormData.categoryId,\n    };\n\n    if (editFormData.subcategoryId) {\n      updateData.subcategoryId = editFormData.subcategoryId;\n    }\n\n    const category = categories?.find(c => c.id === editFormData.categoryId);\n    if (category?.type === \"agroquimicos\" && editFormData.segment) {\n      updateData.segment = editFormData.segment;\n    }\n\n    updateProductMutation.mutate({ id: editingProduct.id, data: updateData });\n  };\n\n  return (\n    <div className=\"h-screen flex flex-col overflow-hidden\">\n      <Header\n        onNewSale={() => {}}\n        title=\"Histórico de Compras\"\n        subtitle=\"Importe PDFs de compras anteriores para análise de oportunidades\"\n      />\n      <Navbar />\n      <main className=\"flex-1 overflow-y-auto\">\n          <div className=\"container mx-auto p-6\">\n            <Tabs defaultValue=\"importacao\" className=\"space-y-6\">\n              <TabsList className=\"grid w-full max-w-md grid-cols-2\">\n                <TabsTrigger value=\"importacao\" data-testid=\"tab-importacao\">\n                  Importação\n                </TabsTrigger>\n                <TabsTrigger value=\"analise\" data-testid=\"tab-analise\">\n                  Análise de Oportunidades\n                </TabsTrigger>\n              </TabsList>\n\n              <TabsContent value=\"importacao\" className=\"space-y-6\">\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <Upload className=\"h-5 w-5\" />\n                      Importar PDF\n                    </CardTitle>\n                    <CardDescription>\n                      Faça upload de um PDF de fatura da C.VALE para extrair histórico de compras\n                    </CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"space-y-4\">\n                      <div className=\"flex items-center gap-4\">\n                        <Label\n                          htmlFor=\"pdf-upload\"\n                          className={`flex-1 border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors ${\n                            isDragging\n                              ? \"border-green-500 bg-green-50\"\n                              : \"border-green-300 hover:border-green-500\"\n                          }`}\n                          data-testid=\"label-upload\"\n                          onDragOver={handleDragOver}\n                          onDragLeave={handleDragLeave}\n                          onDrop={handleDrop}\n                        >\n                          <div className=\"flex flex-col items-center gap-2\">\n                            <FileText className=\"h-12 w-12 text-green-600\" />\n                            <span className=\"font-medium\">\n                              {selectedFile\n                                ? selectedFile.name\n                                : isDragging\n                                ? \"Solte o PDF aqui\"\n                                : \"Clique ou arraste um PDF\"}\n                            </span>\n                            <span className=\"text-sm text-muted-foreground\">\n                              Formato: Fatura C.VALE\n                            </span>\n                          </div>\n                          <Input\n                            id=\"pdf-upload\"\n                            type=\"file\"\n                            accept=\".pdf\"\n                            className=\"hidden\"\n                            onChange={handleFileSelect}\n                            disabled={parseMutation.isPending}\n                            data-testid=\"input-pdf-upload\"\n                          />\n                        </Label>\n                      </div>\n\n                      {parseMutation.isPending && (\n                        <div className=\"text-center py-4\">\n                          <p className=\"text-sm text-muted-foreground\">Analisando PDF...</p>\n                        </div>\n                      )}\n\n                      {parseResult && (\n                        <Card className=\"border-green-200 bg-green-50\">\n                          <CardHeader>\n                            <CardTitle className=\"text-lg\">Resultado da Análise</CardTitle>\n                          </CardHeader>\n                          <CardContent className=\"space-y-3\">\n                            <div className=\"grid grid-cols-2 gap-4\">\n                              <div>\n                                <p className=\"text-sm font-medium text-muted-foreground\">Cliente</p>\n                                <p className=\"font-semibold\">{parseResult.clientName}</p>\n                              </div>\n                              <div>\n                                <p className=\"text-sm font-medium text-muted-foreground\">Safra</p>\n                                <p className=\"font-semibold\">{parseResult.seasonName}</p>\n                              </div>\n                              <div>\n                                <p className=\"text-sm font-medium text-muted-foreground\">Total</p>\n                                <p className=\"font-semibold\">\n                                  ${parseResult.totalAmount.toLocaleString(\"pt-BR\")}\n                                </p>\n                              </div>\n                              <div>\n                                <p className=\"text-sm font-medium text-muted-foreground\">Produtos</p>\n                                <p className=\"font-semibold\">{parseResult.itemsCount} itens</p>\n                              </div>\n                            </div>\n                            \n                            {parseResult.autoCreatedProducts && parseResult.autoCreatedProducts.length > 0 && (\n                              <div className=\"pt-3 border-t\">\n                                <p className=\"text-sm font-medium text-muted-foreground mb-2\">\n                                  Produtos Criados Automaticamente ({parseResult.autoCreatedProducts.length})\n                                </p>\n                                <div className=\"flex flex-wrap gap-2\">\n                                  {parseResult.autoCreatedProducts.map((product, idx) => (\n                                    <Badge\n                                      key={idx}\n                                      variant=\"default\"\n                                      className=\"bg-green-600\"\n                                      data-testid={`badge-auto-product-${idx}`}\n                                    >\n                                      {product.productName}\n                                    </Badge>\n                                  ))}\n                                </div>\n                              </div>\n                            )}\n                            \n                            {parseResult.uncategorizedProducts && parseResult.uncategorizedProducts.length > 0 && (\n                              <div className=\"pt-3 border-t\">\n                                <p className=\"text-sm font-medium text-muted-foreground mb-2\">\n                                  Produtos Não Categorizados ({parseResult.uncategorizedProducts.length})\n                                </p>\n                                <div className=\"flex flex-wrap gap-2\">\n                                  {parseResult.uncategorizedProducts.map((product, idx) => (\n                                    <Badge\n                                      key={idx}\n                                      variant=\"secondary\"\n                                      className=\"bg-yellow-600 text-white\"\n                                      data-testid={`badge-uncategorized-product-${idx}`}\n                                    >\n                                      {product.productName} (sem categoria)\n                                    </Badge>\n                                  ))}\n                                </div>\n                              </div>\n                            )}\n                            \n                            <div className=\"flex gap-2 pt-2\">\n                              <Button\n                                onClick={() => saveMutation.mutate(parseResult)}\n                                disabled={saveMutation.isPending}\n                                className=\"flex-1\"\n                                data-testid=\"button-save-history\"\n                              >\n                                <Package className=\"mr-2 h-4 w-4\" />\n                                Salvar Histórico\n                              </Button>\n                              <Button\n                                variant=\"outline\"\n                                onClick={() => {\n                                  setParseResult(null);\n                                  setSelectedFile(null);\n                                }}\n                                data-testid=\"button-cancel-parse\"\n                              >\n                                Cancelar\n                              </Button>\n                            </div>\n                          </CardContent>\n                        </Card>\n                      )}\n                    </div>\n                  </CardContent>\n                </Card>\n\n                <Card>\n                  <CardHeader>\n                    <CardTitle>Históricos Importados</CardTitle>\n                    <CardDescription>\n                      {histories?.length || 0} históricos de compras salvos\n                    </CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    {loadingHistories ? (\n                      <div className=\"text-center py-8\">\n                        <p className=\"text-muted-foreground\">Carregando...</p>\n                      </div>\n                    ) : histories && histories.length > 0 ? (\n                      <Table>\n                        <TableHeader>\n                          <TableRow>\n                            <TableHead>Cliente</TableHead>\n                            <TableHead>Safra</TableHead>\n                            <TableHead>Arquivo</TableHead>\n                            <TableHead>Total</TableHead>\n                            <TableHead>Data Importação</TableHead>\n                            <TableHead className=\"text-right\">Ações</TableHead>\n                          </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                          {histories.map((history) => (\n                            <TableRow\n                              key={history.id}\n                              className=\"cursor-pointer hover:bg-muted/50\"\n                              onClick={() => setSelectedHistory(history.id)}\n                              data-testid={`row-history-${history.id}`}\n                            >\n                              <TableCell className=\"font-medium\">\n                                {getClientName(history.clientId)}\n                              </TableCell>\n                              <TableCell>{history.seasonName}</TableCell>\n                              <TableCell className=\"text-sm text-muted-foreground\">\n                                {history.sourceFile}\n                              </TableCell>\n                              <TableCell>\n                                ${parseFloat(history.totalAmount).toLocaleString(\"pt-BR\")}\n                              </TableCell>\n                              <TableCell>\n                                {new Date(history.importDate).toLocaleDateString(\"pt-BR\")}\n                              </TableCell>\n                              <TableCell className=\"text-right\">\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  onClick={(e) => {\n                                    e.stopPropagation();\n                                    deleteMutation.mutate(history.id);\n                                  }}\n                                  data-testid={`button-delete-${history.id}`}\n                                >\n                                  <Trash2 className=\"h-4 w-4 text-destructive\" />\n                                </Button>\n                              </TableCell>\n                            </TableRow>\n                          ))}\n                        </TableBody>\n                      </Table>\n                    ) : (\n                      <div className=\"text-center py-8\">\n                        <FileText className=\"mx-auto h-12 w-12 text-muted-foreground/50\" />\n                        <p className=\"mt-2 text-muted-foreground\">\n                          Nenhum histórico importado ainda\n                        </p>\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n              </TabsContent>\n\n              <TabsContent value=\"analise\" className=\"space-y-6\">\n                <Card>\n                  <CardHeader>\n                    <CardTitle className=\"flex items-center gap-2\">\n                      <Target className=\"h-5 w-5\" />\n                      Selecionar Cliente\n                    </CardTitle>\n                    <CardDescription>\n                      Escolha um cliente para filtrar os históricos e safras\n                    </CardDescription>\n                  </CardHeader>\n                  <CardContent>\n                    <Select\n                      value={selectedClientId}\n                      onValueChange={(value) => {\n                        setSelectedClientId(value);\n                        setSelectedAnalysisHistory(\"\");\n                      }}\n                    >\n                      <SelectTrigger className=\"w-full\" data-testid=\"select-client\">\n                        <SelectValue placeholder=\"Selecione um cliente...\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {clients && clients.length > 0 ? (\n                          clients.map((client) => (\n                            <SelectItem key={client.id} value={client.id} data-testid={`option-client-${client.id}`}>\n                              {client.name}\n                            </SelectItem>\n                          ))\n                        ) : (\n                          <SelectItem value=\"no-clients\" disabled>\n                            Nenhum cliente disponível\n                          </SelectItem>\n                        )}\n                      </SelectContent>\n                    </Select>\n                  </CardContent>\n                </Card>\n\n                {selectedClientId && (\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-lg\">Histórico</CardTitle>\n                        <CardDescription>\n                          Selecione um histórico de compras\n                        </CardDescription>\n                      </CardHeader>\n                      <CardContent>\n                        <Select\n                          value={selectedAnalysisHistory}\n                          onValueChange={setSelectedAnalysisHistory}\n                        >\n                          <SelectTrigger className=\"w-full\" data-testid=\"select-analysis-history\">\n                            <SelectValue placeholder=\"Selecione um histórico...\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {histories && histories.length > 0 ? (\n                              histories.map((history) => (\n                                <SelectItem key={history.id} value={history.id} data-testid={`option-history-${history.id}`}>\n                                  {history.seasonName} ({history.sourceFile})\n                                </SelectItem>\n                              ))\n                            ) : (\n                              <SelectItem value=\"no-histories\" disabled>\n                                Nenhum histórico disponível\n                              </SelectItem>\n                            )}\n                          </SelectContent>\n                        </Select>\n                      </CardContent>\n                    </Card>\n\n                    <Card>\n                      <CardHeader>\n                        <CardTitle className=\"text-lg\">Safra para Comparar</CardTitle>\n                        <CardDescription>\n                          Selecione uma safra para análise\n                        </CardDescription>\n                      </CardHeader>\n                      <CardContent>\n                        <Select\n                          value={selectedSeasonId}\n                          onValueChange={setSelectedSeasonId}\n                        >\n                          <SelectTrigger className=\"w-full\" data-testid=\"select-season\">\n                            <SelectValue placeholder=\"Selecione uma safra...\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {seasons && seasons.length > 0 ? (\n                              seasons.map((season) => (\n                                <SelectItem key={season.id} value={season.id} data-testid={`option-season-${season.id}`}>\n                                  {season.name} {season.isActive && <Badge className=\"ml-2\">Ativa</Badge>}\n                                </SelectItem>\n                              ))\n                            ) : (\n                              <SelectItem value=\"no-seasons\" disabled>\n                                Nenhuma safra disponível\n                              </SelectItem>\n                            )}\n                          </SelectContent>\n                        </Select>\n                      </CardContent>\n                    </Card>\n                  </div>\n                )}\n\n                {loadingOpportunities && (\n                  <div className=\"text-center py-12\">\n                    <p className=\"text-muted-foreground\">Carregando análise de oportunidades...</p>\n                  </div>\n                )}\n\n                {!selectedClientId && !loadingOpportunities && (\n                  <div className=\"text-center py-12\">\n                    <Target className=\"mx-auto h-16 w-16 text-muted-foreground/50\" />\n                    <p className=\"mt-4 text-lg font-medium text-muted-foreground\">\n                      Selecione um cliente para começar\n                    </p>\n                  </div>\n                )}\n\n                {selectedClientId && !selectedAnalysisHistory && !loadingOpportunities && (\n                  <div className=\"text-center py-12\">\n                    <Target className=\"mx-auto h-16 w-16 text-muted-foreground/50\" />\n                    <p className=\"mt-4 text-lg font-medium text-muted-foreground\">\n                      Selecione um histórico para visualizar oportunidades\n                    </p>\n                  </div>\n                )}\n\n                {opportunitiesData && selectedAnalysisHistory && (\n                  <>\n                    <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                      <Card data-testid=\"card-total-historical\">\n                        <CardHeader className=\"pb-3\">\n                          <CardDescription className=\"text-xs\">Total Histórico</CardDescription>\n                        </CardHeader>\n                        <CardContent>\n                          <div className=\"flex items-center gap-2\">\n                            <Package className=\"h-5 w-5 text-blue-600\" />\n                            <div className=\"text-2xl font-bold\" data-testid=\"value-total-historical\">\n                              {opportunitiesData.summary.totalHistoricalProducts}\n                            </div>\n                          </div>\n                          <p className=\"text-xs text-muted-foreground mt-1\">Produtos</p>\n                        </CardContent>\n                      </Card>\n\n                      <Card data-testid=\"card-sold-this-season\">\n                        <CardHeader className=\"pb-3\">\n                          <CardDescription className=\"text-xs\">Vendidos na Safra</CardDescription>\n                        </CardHeader>\n                        <CardContent>\n                          <div className=\"flex items-center gap-2\">\n                            <ShoppingCart className=\"h-5 w-5 text-green-600\" />\n                            <div className=\"text-2xl font-bold\" data-testid=\"value-sold-this-season\">\n                              {opportunitiesData.summary.totalSoldThisSeason}\n                            </div>\n                          </div>\n                          <p className=\"text-xs text-muted-foreground mt-1\">Produtos</p>\n                        </CardContent>\n                      </Card>\n\n                      <Card data-testid=\"card-conversion-rate\">\n                        <CardHeader className=\"pb-3\">\n                          <CardDescription className=\"text-xs\">Taxa de Conversão</CardDescription>\n                        </CardHeader>\n                        <CardContent>\n                          <div className=\"flex items-center gap-2\">\n                            <Percent className=\"h-5 w-5 text-purple-600\" />\n                            <div className=\"text-2xl font-bold\" data-testid=\"value-conversion-rate\">\n                              {opportunitiesData.summary.conversionRate}%\n                            </div>\n                          </div>\n                          <p className=\"text-xs text-muted-foreground mt-1\">Convertidos</p>\n                        </CardContent>\n                      </Card>\n                    </div>\n\n                    <Card data-testid=\"card-segment-summary\">\n                      <CardHeader>\n                        <CardTitle className=\"flex items-center gap-2\">\n                          <DollarSign className=\"h-5 w-5\" />\n                          Resumo por Segmento\n                        </CardTitle>\n                        <CardDescription>\n                          Comparação de valores totais entre {opportunitiesData.historicalSeasonName} e {opportunitiesData.seasonName}\n                        </CardDescription>\n                      </CardHeader>\n                      <CardContent>\n                        {(() => {\n                          const agrochemicalCategory = opportunitiesData.categoriesData.find(\n                            cat => cat.categoryName.toLowerCase().includes('agroquímico')\n                          );\n\n                          const segments = ['TS', 'Herbicida', 'Inseticida', 'Fungicida', 'Outros'];\n                          const segmentTotals: Record<string, { historical: number; current: number }> = {};\n                          const categoryTotals: Record<string, { name: string; historical: number; current: number }> = {};\n                          let grandTotalHistorical = 0;\n                          let grandTotalCurrent = 0;\n\n                          segments.forEach(segment => {\n                            segmentTotals[segment] = { historical: 0, current: 0 };\n                          });\n\n                          if (agrochemicalCategory) {\n                            agrochemicalCategory.historicalProducts.forEach(product => {\n                              const { segment } = getSegmentDisplay(product.segment);\n                              if (!segmentTotals[segment]) {\n                                segmentTotals[segment] = { historical: 0, current: 0 };\n                              }\n                              segmentTotals[segment].historical += product.totalPrice;\n                            });\n\n                            agrochemicalCategory.currentSeasonProducts.forEach(product => {\n                              const { segment } = getSegmentDisplay(product.segment);\n                              if (!segmentTotals[segment]) {\n                                segmentTotals[segment] = { historical: 0, current: 0 };\n                              }\n                              segmentTotals[segment].current += product.totalPrice;\n                            });\n                          }\n\n                          opportunitiesData.categoriesData.forEach(category => {\n                            const isAgrochemical = category.categoryName.toLowerCase().includes('agroquímico');\n                            \n                            if (!isAgrochemical) {\n                              let historical = 0;\n                              let current = 0;\n                              \n                              category.historicalProducts.forEach(product => {\n                                historical += product.totalPrice;\n                              });\n                              \n                              category.currentSeasonProducts.forEach(product => {\n                                current += product.totalPrice;\n                              });\n                              \n                              categoryTotals[category.categoryId] = {\n                                name: category.categoryName,\n                                historical,\n                                current\n                              };\n                            }\n                            \n                            category.historicalProducts.forEach(product => {\n                              grandTotalHistorical += product.totalPrice;\n                            });\n                            category.currentSeasonProducts.forEach(product => {\n                              grandTotalCurrent += product.totalPrice;\n                            });\n                          });\n\n                          return (\n                            <div className=\"space-y-1\">\n                              {agrochemicalCategory && (\n                                <div className=\"space-y-0\">\n                                  <div className=\"grid grid-cols-3 gap-4 p-3 bg-green-50 border-l-4 border-green-600\">\n                                    <div className=\"flex items-center gap-2\">\n                                      <span className=\"font-semibold text-green-800\">Agroquímicos</span>\n                                    </div>\n                                    <div className=\"text-center\">\n                                      <div className=\"font-semibold text-gray-700\">\n                                        ${(segmentTotals['TS'].historical + segmentTotals['Herbicida'].historical + segmentTotals['Inseticida'].historical + segmentTotals['Fungicida'].historical + segmentTotals['Outros'].historical).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                      </div>\n                                    </div>\n                                    <div className=\"text-center\">\n                                      <div className=\"font-semibold text-gray-700\">\n                                        ${(segmentTotals['TS'].current + segmentTotals['Herbicida'].current + segmentTotals['Inseticida'].current + segmentTotals['Fungicida'].current + segmentTotals['Outros'].current).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                      </div>\n                                    </div>\n                                  </div>\n                                  \n                                  {segments.map(segment => {\n                                    const totals = segmentTotals[segment];\n                                    if (segment === 'Outros' && totals.historical === 0 && totals.current === 0) {\n                                      return null;\n                                    }\n                                    \n                                    return (\n                                      <div \n                                        key={segment}\n                                        className=\"grid grid-cols-3 gap-4 py-2 px-3 pl-8 hover:bg-gray-50\"\n                                        data-testid={`segment-row-${segment.toLowerCase()}`}\n                                      >\n                                        <div className=\"flex items-center gap-2\">\n                                          <span className=\"text-sm text-gray-700\">{segment}</span>\n                                        </div>\n                                        <div className=\"text-center\">\n                                          <div className=\"text-sm text-gray-600\" data-testid={`historical-${segment.toLowerCase()}`}>\n                                            ${totals.historical.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                          </div>\n                                        </div>\n                                        <div className=\"text-center\">\n                                          <div className=\"text-sm text-gray-600\" data-testid={`current-${segment.toLowerCase()}`}>\n                                            ${totals.current.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                          </div>\n                                        </div>\n                                      </div>\n                                    );\n                                  })}\n                                </div>\n                              )}\n                              \n                              {Object.entries(categoryTotals).map(([categoryId, data]) => (\n                                <div \n                                  key={categoryId}\n                                  className=\"grid grid-cols-3 gap-4 p-3 border-b hover:bg-gray-50\"\n                                  data-testid={`category-row-${categoryId}`}\n                                >\n                                  <div className=\"flex items-center gap-2\">\n                                    <span className=\"font-medium text-gray-700\">{data.name}</span>\n                                  </div>\n                                  <div className=\"text-center\">\n                                    <div className=\"font-medium text-gray-600\" data-testid={`historical-${categoryId}`}>\n                                      ${data.historical.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </div>\n                                  </div>\n                                  <div className=\"text-center\">\n                                    <div className=\"font-medium text-gray-600\" data-testid={`current-${categoryId}`}>\n                                      ${data.current.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                    </div>\n                                  </div>\n                                </div>\n                              ))}\n                              \n                              <div className=\"grid grid-cols-3 gap-4 p-4 bg-green-50 border-l-4 border-green-600 mt-2\">\n                                <div className=\"flex items-center gap-2\">\n                                  <span className=\"font-bold text-base\">TOTAL GERAL</span>\n                                </div>\n                                <div className=\"text-center\">\n                                  <div className=\"text-xs text-gray-500 mb-0.5\">Safra Anterior</div>\n                                  <div className=\"font-bold text-lg text-gray-800\" data-testid=\"grand-total-historical\">\n                                    ${grandTotalHistorical.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                  </div>\n                                </div>\n                                <div className=\"text-center\">\n                                  <div className=\"text-xs text-gray-500 mb-0.5\">Safra Atual</div>\n                                  <div className=\"font-bold text-lg text-gray-800\" data-testid=\"grand-total-current\">\n                                    ${grandTotalCurrent.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                  </div>\n                                </div>\n                              </div>\n                            </div>\n                          );\n                        })()}\n                      </CardContent>\n                    </Card>\n\n                    <Card data-testid=\"card-timeline\">\n                      <CardHeader>\n                        <CardTitle className=\"flex items-center gap-2\">\n                          <Calendar className=\"h-5 w-5\" />\n                          Linha do Tempo Comparativa\n                        </CardTitle>\n                        <CardDescription>\n                          Compare os meses de compra entre as duas safras\n                        </CardDescription>\n                      </CardHeader>\n                      <CardContent className=\"space-y-4\">\n                        {/* Timeline Histórico */}\n                        <div>\n                          <h4 className=\"text-sm font-semibold text-gray-700 mb-2\">\n                            {opportunitiesData.historicalSeasonName}\n                          </h4>\n                          <div className=\"grid grid-cols-12 gap-1.5\">\n                            {opportunitiesData.monthlyTimeline.map((month) => (\n                              <div\n                                key={month.month}\n                                className=\"relative group\"\n                                data-testid={`historical-month-${month.month}`}\n                              >\n                                <div\n                                  onClick={() => {\n                                    if (month.hasPurchases) {\n                                      setSelectedMonth(month.month);\n                                      setSelectedTimelineType('historical');\n                                    }\n                                  }}\n                                  className={`p-2 rounded text-center transition-all ${\n                                    month.hasPurchases\n                                      ? \"bg-green-500 text-white shadow hover:shadow-md cursor-pointer\"\n                                      : \"bg-gray-100 text-gray-400\"\n                                  } ${\n                                    month.isCurrentMonth\n                                      ? \"ring-2 ring-blue-500 ring-offset-1\"\n                                      : \"\"\n                                  }`}\n                                >\n                                  <div className=\"text-[10px] font-semibold capitalize\">\n                                    {month.monthName}\n                                  </div>\n                                  {month.hasPurchases && (\n                                    <div className=\"text-[10px] mt-0.5\">\n                                      {month.itemCount}\n                                    </div>\n                                  )}\n                                </div>\n                                {month.hasPurchases && (\n                                  <div className=\"absolute z-10 invisible group-hover:visible bg-black text-white text-xs rounded py-1.5 px-2 bottom-full left-1/2 transform -translate-x-1/2 mb-1 whitespace-nowrap shadow-lg\">\n                                    <div className=\"font-semibold\">{month.itemCount} produtos</div>\n                                    <div>Total: ${month.totalValue.toLocaleString(\"pt-BR\", {\n                                      minimumFractionDigits: 2,\n                                      maximumFractionDigits: 2\n                                    })}</div>\n                                    <div className=\"absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-black\"></div>\n                                  </div>\n                                )}\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n\n                        {/* Timeline Safra Atual */}\n                        <div>\n                          <h4 className=\"text-sm font-semibold text-gray-700 mb-2\">\n                            {opportunitiesData.seasonName}\n                          </h4>\n                          <div className=\"grid grid-cols-12 gap-1.5\">\n                            {opportunitiesData.currentSeasonMonthlyTimeline.map((month) => (\n                              <div\n                                key={month.month}\n                                className=\"relative group\"\n                                data-testid={`current-month-${month.month}`}\n                              >\n                                <div\n                                  onClick={() => {\n                                    if (month.hasPurchases) {\n                                      setSelectedMonth(month.month);\n                                      setSelectedTimelineType('current');\n                                    }\n                                  }}\n                                  className={`p-2 rounded text-center transition-all ${\n                                    month.hasPurchases\n                                      ? \"bg-blue-500 text-white shadow hover:shadow-md cursor-pointer\"\n                                      : \"bg-gray-100 text-gray-400\"\n                                  } ${\n                                    month.isCurrentMonth\n                                      ? \"ring-2 ring-blue-500 ring-offset-1\"\n                                      : \"\"\n                                  }`}\n                                >\n                                  <div className=\"text-[10px] font-semibold capitalize\">\n                                    {month.monthName}\n                                  </div>\n                                  {month.hasPurchases && (\n                                    <div className=\"text-[10px] mt-0.5\">\n                                      {month.itemCount}\n                                    </div>\n                                  )}\n                                </div>\n                                {month.hasPurchases && (\n                                  <div className=\"absolute z-10 invisible group-hover:visible bg-black text-white text-xs rounded py-1.5 px-2 bottom-full left-1/2 transform -translate-x-1/2 mb-1 whitespace-nowrap shadow-lg\">\n                                    <div className=\"font-semibold\">{month.itemCount} {month.itemCount === 1 ? 'venda' : 'vendas'}</div>\n                                    <div>Total: ${month.totalValue.toLocaleString(\"pt-BR\", {\n                                      minimumFractionDigits: 2,\n                                      maximumFractionDigits: 2\n                                    })}</div>\n                                    <div className=\"absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-black\"></div>\n                                  </div>\n                                )}\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n\n                        {/* Legenda */}\n                        <div className=\"flex items-center gap-4 mt-4 text-xs text-muted-foreground flex-wrap\">\n                          <div className=\"flex items-center gap-2\">\n                            <div className=\"w-3 h-3 rounded bg-green-500\"></div>\n                            <span>Histórico</span>\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <div className=\"w-3 h-3 rounded bg-blue-500\"></div>\n                            <span>Safra Atual</span>\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <div className=\"w-3 h-3 rounded bg-green-500 ring-2 ring-blue-500 ring-offset-1\"></div>\n                            <span>Mês atual</span>\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <div className=\"w-3 h-3 rounded bg-gray-100\"></div>\n                            <span>Sem dados</span>\n                          </div>\n                        </div>\n                      </CardContent>\n                    </Card>\n\n                    <Card data-testid=\"card-opportunities-table\">\n                      <CardHeader>\n                        <CardTitle>Comparação de Produtos por Categoria</CardTitle>\n                        <CardDescription>\n                          {opportunitiesData.historicalSeasonName} vs {opportunitiesData.seasonName} - lado a lado\n                        </CardDescription>\n                      </CardHeader>\n                      <CardContent>\n                        {opportunitiesData.categoriesData.length === 0 ? (\n                          <div className=\"text-center py-8\">\n                            <TrendingUp className=\"mx-auto h-12 w-12 text-muted-foreground/50\" />\n                            <p className=\"mt-2 text-muted-foreground\">\n                              Nenhum dado encontrado para comparação\n                            </p>\n                          </div>\n                        ) : (\n                          <div className=\"space-y-6\">\n                            {opportunitiesData.categoriesData.map((category) => {\n                              const isAgrochemical = category.categoryName.toLowerCase().includes('agroquímico');\n                              const historicalGroups = groupProductsBySegment(category.historicalProducts, isAgrochemical);\n                              const currentGroups = groupProductsBySegment(category.currentSeasonProducts, isAgrochemical);\n                              \n                              return (\n                                <div key={category.categoryId} className=\"border rounded-lg p-4 bg-white\">\n                                  <h3 className=\"font-semibold text-lg mb-4 text-green-700\">\n                                    {category.categoryName}\n                                  </h3>\n                                  <div className=\"grid grid-cols-2 gap-4\">\n                                    <div className=\"space-y-2\">\n                                      <h4 className=\"font-medium text-sm text-muted-foreground border-b pb-2\">\n                                        {opportunitiesData.historicalSeasonName || 'Safra Histórica'}\n                                      </h4>\n                                      {category.historicalProducts.length === 0 ? (\n                                        <p className=\"text-sm text-muted-foreground py-4\">Nenhum produto</p>\n                                      ) : (\n                                        <div className=\"space-y-3\">\n                                          {Object.entries(historicalGroups).map(([segment, products]) => (\n                                            <div key={segment}>\n                                              {isAgrochemical && (\n                                                <div className=\"text-xs font-semibold text-muted-foreground mb-1 flex items-center gap-2\">\n                                                  <Badge className={`${getSegmentDisplay(products[0].segment).color} text-white text-xs`}>\n                                                    {segment}\n                                                  </Badge>\n                                                </div>\n                                              )}\n                                              <div className=\"space-y-1\">\n                                                {products.map((product, idx) => {\n                                                  const subcategoryName = getSubcategoryName(product.subcategoryId);\n                                                  const isUncategorized = category.categoryName === 'Outros';\n                                                  return (\n                                                    <div \n                                                      key={idx} \n                                                      className=\"p-2 rounded border border-gray-200 hover:bg-gray-50\"\n                                                      data-testid={`historical-product-${category.categoryId}-${idx}`}\n                                                    >\n                                                      <div className=\"flex justify-between items-start gap-2\">\n                                                        <div className=\"flex-1\">\n                                                          <div className=\"font-medium text-sm\">{product.productName}</div>\n                                                          <div className=\"text-xs text-muted-foreground\">{product.packageType}</div>\n                                                          {subcategoryName && (\n                                                            <div className=\"text-xs text-blue-600 mt-0.5 font-medium\">{subcategoryName}</div>\n                                                          )}\n                                                          <div className=\"flex justify-between items-center mt-1\">\n                                                            <span className=\"text-xs\">Qtd: {product.quantity.toFixed(2)}</span>\n                                                            <span className=\"text-xs font-semibold\">${product.totalPrice.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>\n                                                          </div>\n                                                        </div>\n                                                        {isUncategorized && (\n                                                          <Button\n                                                            variant=\"ghost\"\n                                                            size=\"sm\"\n                                                            onClick={() => openEditModal(product.productName)}\n                                                            data-testid={`button-edit-${idx}`}\n                                                            className=\"h-6 w-6 p-0\"\n                                                          >\n                                                            <Pencil className=\"h-3 w-3\" />\n                                                          </Button>\n                                                        )}\n                                                      </div>\n                                                    </div>\n                                                  );\n                                                })}\n                                              </div>\n                                            </div>\n                                          ))}\n                                        </div>\n                                      )}\n                                    </div>\n                                    \n                                    <div className=\"space-y-2\">\n                                      <h4 className=\"font-medium text-sm text-muted-foreground border-b pb-2\">\n                                        {opportunitiesData.seasonName || 'Safra Atual'}\n                                      </h4>\n                                      {category.currentSeasonProducts.length === 0 ? (\n                                        <div className=\"bg-yellow-50 border border-yellow-200 rounded p-3 text-center\">\n                                          <p className=\"text-sm font-medium text-yellow-700\">⚠️ Oportunidade!</p>\n                                          <p className=\"text-xs text-yellow-600 mt-1\">Nenhuma venda registrada</p>\n                                        </div>\n                                      ) : (\n                                        <div className=\"space-y-3\">\n                                          {Object.entries(currentGroups).map(([segment, products]) => (\n                                            <div key={segment}>\n                                              {isAgrochemical && (\n                                                <div className=\"text-xs font-semibold text-muted-foreground mb-1 flex items-center gap-2\">\n                                                  <Badge className={`${getSegmentDisplay(products[0].segment).color} text-white text-xs`}>\n                                                    {segment}\n                                                  </Badge>\n                                                </div>\n                                              )}\n                                              <div className=\"space-y-1\">\n                                                {products.map((product, idx) => {\n                                                  const subcategoryName = getSubcategoryName(product.subcategoryId);\n                                                  return (\n                                                    <div \n                                                      key={idx} \n                                                      className=\"p-2 rounded border border-green-200 bg-green-50\"\n                                                      data-testid={`current-product-${category.categoryId}-${idx}`}\n                                                    >\n                                                      <div className=\"font-medium text-sm\">{product.productName}</div>\n                                                      {subcategoryName && (\n                                                        <div className=\"text-xs text-blue-600 mt-0.5 font-medium\">{subcategoryName}</div>\n                                                      )}\n                                                      <div className=\"flex justify-between items-center mt-1\">\n                                                        <span className=\"text-xs\">Qtd: {product.quantity.toFixed(2)}</span>\n                                                        <span className=\"text-xs font-semibold text-green-700\">${product.totalPrice.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>\n                                                      </div>\n                                                    </div>\n                                                  );\n                                                })}\n                                              </div>\n                                            </div>\n                                          ))}\n                                        </div>\n                                      )}\n                                    </div>\n                                  </div>\n                                </div>\n                              );\n                            })}\n                          </div>\n                        )}\n                      </CardContent>\n                    </Card>\n                  </>\n                )}\n              </TabsContent>\n            </Tabs>\n          </div>\n\n      {/* Month Products Modal */}\n      <Dialog open={selectedMonth !== null} onOpenChange={(open) => { if (!open) { setSelectedMonth(null); setSelectedTimelineType(null); } }}>\n        <DialogContent className=\"max-w-4xl max-h-[80vh] overflow-y-auto\" data-testid=\"month-products-modal\">\n          <DialogHeader>\n            <DialogTitle>\n              {selectedTimelineType === 'historical' ? 'Compras' : 'Vendas'} de {selectedMonth !== null && opportunitiesData?.monthlyTimeline.find(m => m.month === selectedMonth)?.monthName}\n            </DialogTitle>\n            <DialogDescription>\n              {selectedTimelineType === 'historical' \n                ? `Produtos comprados neste mês (${opportunitiesData?.historicalSeasonName})`\n                : `Vendas realizadas neste mês (${opportunitiesData?.seasonName})`\n              }\n            </DialogDescription>\n          </DialogHeader>\n          \n          {selectedMonth !== null && selectedTimelineType && opportunitiesData && (() => {\n            const monthProducts = selectedTimelineType === 'historical'\n              ? opportunitiesData.categoriesData.flatMap(cat => \n                  cat.historicalProducts\n                    .filter(p => new Date(p.purchaseDate).getMonth() + 1 === selectedMonth)\n                    .map(p => ({ ...p, categoryId: cat.categoryId, categoryName: cat.categoryName }))\n                )\n              : opportunitiesData.categoriesData.flatMap(cat => \n                  cat.currentSeasonProducts\n                    .filter(p => new Date(p.saleDate).getMonth() + 1 === selectedMonth)\n                    .map(p => ({ \n                      ...p, \n                      categoryId: cat.categoryId, \n                      categoryName: cat.categoryName,\n                      productCode: p.productId,\n                      packageType: '',\n                      purchaseDate: p.saleDate\n                    }))\n                );\n\n            const groupedByCategory: Record<string, typeof monthProducts> = {};\n            monthProducts.forEach(p => {\n              if (!groupedByCategory[p.categoryId]) {\n                groupedByCategory[p.categoryId] = [];\n              }\n              groupedByCategory[p.categoryId].push(p);\n            });\n\n            const totalValue = monthProducts.reduce((sum, p) => sum + p.totalPrice, 0);\n\n            return (\n              <div className=\"space-y-4\">\n                <div className={`rounded p-3 ${selectedTimelineType === 'historical' ? 'bg-green-50 border border-green-200' : 'bg-blue-50 border border-blue-200'}`}>\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <p className=\"text-sm text-muted-foreground\">Total de Produtos</p>\n                      <p className=\"text-lg font-semibold\">{monthProducts.length}</p>\n                    </div>\n                    <div>\n                      <p className=\"text-sm text-muted-foreground\">Valor Total</p>\n                      <p className=\"text-lg font-semibold\">${totalValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>\n                    </div>\n                  </div>\n                </div>\n\n                {Object.keys(groupedByCategory).length === 0 ? (\n                  <p className=\"text-center text-muted-foreground py-8\">Nenhum produto encontrado</p>\n                ) : (\n                  <div className=\"space-y-4\">\n                    {Object.entries(groupedByCategory).map(([categoryId, products]) => {\n                      if (products.length === 0) return null;\n                      const isAgrochemical = products[0].categoryName.toLowerCase().includes('agroquímico');\n                      const segmentGroups = groupProductsBySegment(products, isAgrochemical);\n                      \n                      return (\n                        <div key={categoryId} className=\"border rounded-lg p-4\">\n                          <h3 className=\"font-semibold text-lg mb-3 text-green-700\">\n                            {products[0].categoryName}\n                          </h3>\n                          \n                          <div className=\"space-y-3\">\n                            {Object.entries(segmentGroups).map(([segment, segmentProducts]) => (\n                              <div key={segment}>\n                                {isAgrochemical && (\n                                  <div className=\"text-xs font-semibold text-muted-foreground mb-2 flex items-center gap-2\">\n                                    <Badge className={`${getSegmentDisplay(segmentProducts[0].segment).color} text-white text-xs`}>\n                                      {segment}\n                                    </Badge>\n                                  </div>\n                                )}\n                                <div className=\"space-y-2\">\n                                  {segmentProducts.map((product, idx) => {\n                                    const subcategoryName = getSubcategoryName(product.subcategoryId);\n                                    return (\n                                      <div \n                                        key={idx} \n                                        className=\"p-3 rounded border border-gray-200 bg-white hover:bg-gray-50\"\n                                        data-testid={`month-product-${idx}`}\n                                      >\n                                        <div className=\"flex justify-between items-start gap-3\">\n                                          <div className=\"flex-1\">\n                                            <div className=\"font-medium text-sm\">{product.productName}</div>\n                                            <div className=\"text-xs text-muted-foreground mt-0.5\">\n                                              Código: {product.productCode} | {product.packageType}\n                                            </div>\n                                            {subcategoryName && (\n                                              <div className=\"text-xs text-blue-600 mt-0.5 font-medium\">{subcategoryName}</div>\n                                            )}\n                                            <div className=\"flex justify-between items-center mt-2 text-xs\">\n                                              <span className=\"text-muted-foreground\">Quantidade: {product.quantity.toFixed(2)}</span>\n                                              <span className=\"text-muted-foreground\">Preço Unit.: ${product.unitPrice.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span>\n                                            </div>\n                                          </div>\n                                          <div className=\"text-right\">\n                                            <div className=\"text-xs text-muted-foreground\">Total</div>\n                                            <div className=\"text-base font-semibold text-green-700\">\n                                              ${product.totalPrice.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                                            </div>\n                                          </div>\n                                        </div>\n                                      </div>\n                                    );\n                                  })}\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </div>\n                )}\n              </div>\n            );\n          })()}\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Product Modal */}\n      <Dialog open={showEditProductModal} onOpenChange={setShowEditProductModal}>\n        <DialogContent className=\"max-w-2xl\" data-testid=\"edit-product-modal\">\n          <DialogHeader>\n            <DialogTitle>Reclassificar Produto</DialogTitle>\n            <DialogDescription>\n              Atribua a categoria e subcategoria corretas para: {editingProduct?.name}\n            </DialogDescription>\n          </DialogHeader>\n          <form onSubmit={handleEditSubmit} className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"edit-category\">Categoria *</Label>\n              <Select\n                value={editFormData.categoryId}\n                onValueChange={(value) => setEditFormData(prev => ({ ...prev, categoryId: value, subcategoryId: \"\", segment: \"\" }))}\n              >\n                <SelectTrigger id=\"edit-category\" data-testid=\"select-edit-category\">\n                  <SelectValue placeholder=\"Selecione uma categoria\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {categories?.map((cat) => (\n                    <SelectItem key={cat.id} value={cat.id} data-testid={`option-category-${cat.id}`}>\n                      {cat.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            {editFormData.categoryId && (\n              <>\n                <div>\n                  <Label htmlFor=\"edit-subcategory\">Subcategoria (opcional)</Label>\n                  <Select\n                    value={editFormData.subcategoryId || undefined}\n                    onValueChange={(value) => setEditFormData(prev => ({ ...prev, subcategoryId: value }))}\n                  >\n                    <SelectTrigger id=\"edit-subcategory\" data-testid=\"select-edit-subcategory\">\n                      <SelectValue placeholder=\"Nenhuma selecionada\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {subcategories?.filter(s => s.categoryId === editFormData.categoryId).map((sub) => (\n                        <SelectItem key={sub.id} value={sub.id} data-testid={`option-subcategory-${sub.id}`}>\n                          {sub.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                {categories?.find(c => c.id === editFormData.categoryId)?.type === \"agroquimicos\" && (\n                  <div>\n                    <Label htmlFor=\"edit-segment\">Segmento (opcional)</Label>\n                    <Select\n                      value={editFormData.segment || undefined}\n                      onValueChange={(value) => setEditFormData(prev => ({ ...prev, segment: value }))}\n                    >\n                      <SelectTrigger id=\"edit-segment\" data-testid=\"select-edit-segment\">\n                        <SelectValue placeholder=\"Nenhum selecionado\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"Fungicida\">Fungicida</SelectItem>\n                        <SelectItem value=\"Inseticida\">Inseticida</SelectItem>\n                        <SelectItem value=\"Herbicida\">Herbicida</SelectItem>\n                        <SelectItem value=\"TS\">TS (Tratamento de Sementes)</SelectItem>\n                        <SelectItem value=\"Outros\">Outros</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                )}\n              </>\n            )}\n\n            <div className=\"flex justify-end gap-3 pt-4\">\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={() => setShowEditProductModal(false)}\n                data-testid=\"button-edit-cancel\"\n              >\n                Cancelar\n              </Button>\n              <Button\n                type=\"submit\"\n                disabled={updateProductMutation.isPending}\n                data-testid=\"button-edit-save\"\n              >\n                {updateProductMutation.isPending ? \"Salvando...\" : \"Salvar\"}\n              </Button>\n            </div>\n          </form>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={!!selectedHistory} onOpenChange={() => setSelectedHistory(null)}>\n        <DialogContent className=\"max-w-4xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Detalhes do Histórico</DialogTitle>\n            <DialogDescription>\n              Produtos comprados nesta safra\n            </DialogDescription>\n          </DialogHeader>\n          {loadingItems ? (\n            <div className=\"text-center py-8\">\n              <p className=\"text-muted-foreground\">Carregando itens...</p>\n            </div>\n          ) : historyItems && historyItems.length > 0 ? (\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Código</TableHead>\n                  <TableHead>Produto</TableHead>\n                  <TableHead>Embalagem</TableHead>\n                  <TableHead>Qtd</TableHead>\n                  <TableHead>Preço Unit.</TableHead>\n                  <TableHead>Total</TableHead>\n                  <TableHead>Data</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {historyItems.map((item) => (\n                  <TableRow key={item.id} data-testid={`item-${item.id}`}>\n                    <TableCell className=\"font-mono text-sm\">\n                      {item.productCode}\n                    </TableCell>\n                    <TableCell className=\"font-medium\">{item.productName}</TableCell>\n                    <TableCell className=\"text-sm\">{item.packageType}</TableCell>\n                    <TableCell>{parseFloat(item.quantity).toFixed(2)}</TableCell>\n                    <TableCell>\n                      ${parseFloat(item.unitPrice).toFixed(2)}\n                    </TableCell>\n                    <TableCell className=\"font-semibold\">\n                      ${parseFloat(item.totalPrice).toFixed(2)}\n                    </TableCell>\n                    <TableCell>\n                      {new Date(item.purchaseDate).toLocaleDateString(\"pt-BR\")}\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          ) : (\n            <div className=\"text-center py-8\">\n              <p className=\"text-muted-foreground\">Nenhum item encontrado</p>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n      </main>\n    </div>\n  );\n}\n","size_bytes":79893},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { AuthProvider } from \"@/hooks/use-auth\";\nimport { ConsultorRoute } from \"@/lib/consultor-route\";\nimport { AdminRoute } from \"@/lib/admin-route\";\nimport { ManagerRoute } from \"@/lib/manager-route\";\nimport { FaturistaRoute } from \"@/lib/faturista-route\";\nimport NotFound from \"@/pages/not-found\";\nimport AuthPage from \"@/pages/auth-page\";\nimport Dashboard from \"@/pages/dashboard\";\nimport Vendas from \"@/pages/vendas\";\nimport Comissoes from \"@/pages/comissoes\";\nimport Clientes from \"@/pages/clientes\";\nimport Safras from \"@/pages/safras\";\nimport Produtos from \"@/pages/produtos\";\nimport Relatorios from \"@/pages/relatorios\";\nimport Parametros from \"@/pages/parametros\";\nimport Metas from \"@/pages/metas\";\nimport Mercado from \"@/pages/mercado\";\nimport HistoricoCompras from \"@/pages/historico-compras\";\nimport AdminPage from \"@/pages/admin\";\nimport ManagerPage from \"@/pages/manager\";\nimport BarterPage from \"@/pages/barter\";\nimport FaturistaPage from \"@/pages/faturista\";\nimport KanbanMetasPage from \"@/pages/kanban-metas\";\nimport ForgotPassword from \"@/pages/forgot-password\";\nimport ResetPassword from \"@/pages/reset-password\";\nimport CRMLogin from \"@/pages/crm/login\";\nimport CRMHome from \"@/pages/crm/home\";\nimport CRMAgenda from \"@/pages/crm/agenda\";\nimport CRMClientes from \"@/pages/crm/clientes\";\nimport CRMHistorico from \"@/pages/crm/historico\";\nimport CRMPerfil from \"@/pages/crm/perfil\";\nimport CRMSettings from \"@/pages/crm/settings\";\nimport CRMFarms from \"@/pages/crm/farms\";\nimport CRMChecklists from \"@/pages/crm/checklists\";\nimport CRMReports from \"@/pages/crm/reports\";\nimport CRMAtendimento from \"@/pages/crm/atendimento\";\nimport CRMLayout from \"@/components/crm/layout\";\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route path=\"/auth\" component={AuthPage} />\n      <Route path=\"/forgot-password\" component={ForgotPassword} />\n      <Route path=\"/reset-password/:token\" component={ResetPassword} />\n      <AdminRoute path=\"/admin\" component={AdminPage} />\n      <ManagerRoute path=\"/manager\" component={ManagerPage} />\n      <FaturistaRoute path=\"/faturista\" component={FaturistaPage} />\n      \n      {/* CRM Routes */}\n      <Route path=\"/crm\">\n        {() => {\n          window.location.href = \"/crm/login\";\n          return null;\n        }}\n      </Route>\n      <Route path=\"/crm/login\" component={CRMLogin} />\n      <Route path=\"/crm/home\">\n        {() => <CRMLayout><CRMHome /></CRMLayout>}\n      </Route>\n      <Route path=\"/crm/agenda\">\n        {() => <CRMLayout><CRMAgenda /></CRMLayout>}\n      </Route>\n      <Route path=\"/crm/clientes\">\n        {() => <CRMLayout><CRMClientes /></CRMLayout>}\n      </Route>\n      <Route path=\"/crm/historico\">\n        {() => <CRMLayout><CRMHistorico /></CRMLayout>}\n      </Route>\n      <Route path=\"/crm/perfil\">\n        {() => <CRMLayout><CRMPerfil /></CRMLayout>}\n      </Route>\n      <Route path=\"/crm/settings\">\n        {() => <CRMLayout><CRMSettings /></CRMLayout>}\n      </Route>\n      <Route path=\"/crm/farms\">\n        {() => <CRMLayout><CRMFarms /></CRMLayout>}\n      </Route>\n      <Route path=\"/crm/checklists\">\n        {() => <CRMLayout><CRMChecklists /></CRMLayout>}\n      </Route>\n      <Route path=\"/crm/reports\">\n        {() => <CRMLayout><CRMReports /></CRMLayout>}\n      </Route>\n      <Route path=\"/crm/atendimento/:visitId\" component={CRMAtendimento} />\n      <ConsultorRoute path=\"/\" component={Dashboard} />\n      <ConsultorRoute path=\"/dashboard\" component={Dashboard} />\n      <ConsultorRoute path=\"/vendas\" component={Vendas} />\n      <ConsultorRoute path=\"/comissoes\" component={Comissoes} />\n      <ConsultorRoute path=\"/clientes\" component={Clientes} />\n      <ConsultorRoute path=\"/safras\" component={Safras} />\n      <ConsultorRoute path=\"/produtos\" component={Produtos} />\n      <ConsultorRoute path=\"/relatorios\" component={Relatorios} />\n      <ConsultorRoute path=\"/parametros\" component={Parametros} />\n      <ConsultorRoute path=\"/metas\" component={Metas} />\n      <ConsultorRoute path=\"/mercado\" component={Mercado} />\n      <ConsultorRoute path=\"/historico-compras\" component={HistoricoCompras} />\n      <ConsultorRoute path=\"/barter\" component={BarterPage} />\n      <ConsultorRoute path=\"/kanban-metas\" component={KanbanMetasPage} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <AuthProvider>\n        <TooltipProvider>\n          <Toaster />\n          <Router />\n        </TooltipProvider>\n      </AuthProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","size_bytes":4835},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport cors from \"cors\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\n\nconst app = express();\n\napp.use(cors({\n  origin: true,\n  credentials: true,\n}));\n\ndeclare module 'http' {\n  interface IncomingMessage {\n    rawBody: unknown\n  }\n}\napp.use(express.json({\n  verify: (req, _res, buf) => {\n    req.rawBody = buf;\n  }\n}));\napp.use(express.urlencoded({ extended: false }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","size_bytes":2293},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","size_bytes":2695},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","size_bytes":2751},"client/src/components/dashboard/goal-evolution-chart.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport type { SeasonGoal, Sale, Season } from \"@shared/schema\";\nimport { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from \"recharts\";\nimport { useState, useMemo } from \"react\";\nimport { format, startOfMonth, endOfMonth, eachMonthOfInterval, isWithinInterval } from \"date-fns\";\n\nexport default function GoalEvolutionChart() {\n  const [selectedGoalId, setSelectedGoalId] = useState<string>(\"\");\n\n  const { data: goals, isLoading: goalsLoading } = useQuery<SeasonGoal[]>({\n    queryKey: [\"/api/season-goals\"],\n  });\n\n  const { data: sales, isLoading: salesLoading } = useQuery<Sale[]>({\n    queryKey: [\"/api/sales\"],\n  });\n\n  const { data: seasons, isLoading: seasonsLoading } = useQuery<Season[]>({\n    queryKey: [\"/api/seasons\"],\n  });\n\n  const selectedGoal = goals?.find(g => g.id === selectedGoalId) || goals?.[0];\n\n  const chartData = useMemo(() => {\n    if (!selectedGoal || !sales || !seasons) return [];\n\n    const season = seasons.find(s => s.id === selectedGoal.seasonId);\n    if (!season) return [];\n\n    const seasonSales = sales.filter(s => s.seasonId === selectedGoal.seasonId);\n    \n    if (seasonSales.length === 0) return [];\n    \n    const saleDates = seasonSales.map(s => new Date(s.saleDate));\n    const minDate = new Date(Math.min(...saleDates.map(d => d.getTime())));\n    const maxDate = new Date(Math.max(...saleDates.map(d => d.getTime())));\n    \n    const months = eachMonthOfInterval({\n      start: startOfMonth(minDate),\n      end: endOfMonth(maxDate),\n    });\n\n    return months.map(month => {\n      const monthStart = startOfMonth(month);\n      const monthEnd = endOfMonth(month);\n\n      const monthSales = seasonSales.filter(sale => {\n        const saleDate = new Date(sale.saleDate);\n        return isWithinInterval(saleDate, { start: monthStart, end: monthEnd });\n      });\n\n      const totalSales = monthSales.reduce((sum, sale) => sum + parseFloat(sale.totalAmount), 0);\n\n      const cumulativeSales = seasonSales\n        .filter(sale => new Date(sale.saleDate) <= monthEnd)\n        .reduce((sum, sale) => sum + parseFloat(sale.totalAmount), 0);\n\n      const goalAmount = parseFloat(selectedGoal.goalAmount);\n      const monthlyGoal = goalAmount / months.length;\n      const cumulativeGoal = monthlyGoal * (months.indexOf(month) + 1);\n\n      return {\n        month: format(month, \"MMM\"),\n        achievement: Math.round((cumulativeSales / goalAmount) * 100),\n        goal: Math.round((cumulativeGoal / goalAmount) * 100),\n        sales: Math.round(cumulativeSales),\n      };\n    });\n  }, [selectedGoal, sales, seasons]);\n\n  if (goalsLoading || salesLoading || seasonsLoading) {\n    return (\n      <Card className=\"shadow-sm\" data-testid=\"goal-evolution-chart\">\n        <CardHeader>\n          <CardTitle className=\"text-lg font-bold\">Evolução de Atingimento</CardTitle>\n          <p className=\"text-sm text-muted-foreground\">Meta vs Realizado</p>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-center py-8 text-muted-foreground\">\n            Carregando dados...\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (!goals || goals.length === 0) {\n    return (\n      <Card className=\"shadow-sm\" data-testid=\"goal-evolution-chart\">\n        <CardHeader>\n          <CardTitle className=\"text-lg font-bold\">Evolução de Atingimento</CardTitle>\n          <p className=\"text-sm text-muted-foreground\">Meta vs Realizado</p>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-center py-8 text-muted-foreground\">\n            Nenhuma meta configurada\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className=\"shadow-sm\" data-testid=\"goal-evolution-chart\">\n      <CardHeader className=\"flex flex-row items-center justify-between\">\n        <div>\n          <CardTitle className=\"text-lg font-bold\">Evolução de Atingimento</CardTitle>\n          <p className=\"text-sm text-muted-foreground\">Meta vs Realizado</p>\n        </div>\n        <Select \n          value={selectedGoal?.id} \n          onValueChange={setSelectedGoalId}\n        >\n          <SelectTrigger className=\"w-40\">\n            <SelectValue>\n              {selectedGoal && seasons?.find(s => s.id === selectedGoal.seasonId)?.name || \"Selecione\"}\n            </SelectValue>\n          </SelectTrigger>\n          <SelectContent>\n            {goals.map((goal) => {\n              const season = seasons?.find(s => s.id === goal.seasonId);\n              return (\n                <SelectItem key={goal.id} value={goal.id}>\n                  {season?.name || `Meta ${goal.id.substring(0, 8)}`}\n                </SelectItem>\n              );\n            })}\n          </SelectContent>\n        </Select>\n      </CardHeader>\n      <CardContent>\n        {chartData.length > 0 ? (\n          <ResponsiveContainer width=\"100%\" height={250}>\n            <LineChart data={chartData}>\n              <CartesianGrid strokeDasharray=\"3 3\" />\n              <XAxis dataKey=\"month\" />\n              <YAxis label={{ value: '% Atingimento', angle: -90, position: 'insideLeft' }} />\n              <Tooltip />\n              <Legend />\n              <Line \n                type=\"monotone\" \n                dataKey=\"achievement\" \n                stroke=\"hsl(var(--verde))\" \n                name=\"Realizado\"\n                strokeWidth={2}\n              />\n              <Line \n                type=\"monotone\" \n                dataKey=\"goal\" \n                stroke=\"hsl(var(--muted-foreground))\" \n                strokeDasharray=\"5 5\"\n                name=\"Meta\"\n              />\n            </LineChart>\n          </ResponsiveContainer>\n        ) : (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            Nenhuma venda registrada para esta meta\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":6077},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","size_bytes":791},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","size_bytes":3848},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","size_bytes":1128},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","size_bytes":3895},"client/src/pages/barter.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport Navbar from \"@/components/layout/navbar\";\nimport Header from \"@/components/layout/header\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Plus, Trash2, Calculator, Save, FileText } from \"lucide-react\";\nimport type { BarterProduct, BarterSettings, UserClientLink } from \"@shared/schema\";\n\ninterface BarterItem {\n  productId: string;\n  productName: string;\n  category: string;\n  quantity: number;\n  unit: string;\n  priceUsd: number;\n  totalUsd: number;\n}\n\nexport default function BarterPage() {\n  const [selectedClient, setSelectedClient] = useState(\"\");\n  const [areaHa, setAreaHa] = useState(\"\");\n  const [items, setItems] = useState<BarterItem[]>([]);\n  const [selectedCategory, setSelectedCategory] = useState(\"\");\n  const [selectedProduct, setSelectedProduct] = useState(\"\");\n  const [quantity, setQuantity] = useState(\"\");\n  const { toast } = useToast();\n\n  const { data: clients } = useQuery<UserClientLink[]>({ queryKey: ['/api/clients'] });\n  const { data: barterProducts } = useQuery<BarterProduct[]>({ queryKey: ['/api/barter/products'] });\n  const { data: barterSettings } = useQuery<BarterSettings[]>({ queryKey: ['/api/barter/settings'] });\n\n  const sackPrice = parseFloat(barterSettings?.find(s => s.key === \"sack_price\")?.value || \"23\");\n  const bufferPercentage = parseFloat(barterSettings?.find(s => s.key === \"buffer_percentage\")?.value || \"130\");\n\n  const categories = Array.from(new Set(barterProducts?.map(p => p.category) || []));\n  const filteredProducts = barterProducts?.filter(p => p.category === selectedCategory) || [];\n\n  const addItem = () => {\n    const product = barterProducts?.find(p => p.id === selectedProduct);\n    if (!product || !quantity || parseFloat(quantity) <= 0) return;\n\n    const newItem: BarterItem = {\n      productId: product.id,\n      productName: product.name,\n      category: product.category,\n      quantity: parseFloat(quantity),\n      unit: product.unit,\n      priceUsd: parseFloat(product.priceUsd),\n      totalUsd: parseFloat(quantity) * parseFloat(product.priceUsd),\n    };\n\n    setItems([...items, newItem]);\n    setSelectedProduct(\"\");\n    setQuantity(\"\");\n  };\n\n  const removeItem = (index: number) => {\n    setItems(items.filter((_, i) => i !== index));\n  };\n\n  const totalUsd = items.reduce((sum, item) => sum + item.totalUsd, 0);\n  const totalWithBuffer = totalUsd * (bufferPercentage / 100);\n  const grainQuantityKg = totalWithBuffer / sackPrice * 60;\n  const grainQuantitySacks = grainQuantityKg / 60;\n\n  const minProducts = parseInt(barterSettings?.find((s: any) => s.key === \"min_products\")?.value || \"0\");\n  const requiredCategoriesStr = barterSettings?.find((s: any) => s.key === \"required_categories\")?.value || \"\";\n  const requiredCategories = requiredCategoriesStr.split(\",\").map((c: string) => c.trim()).filter(Boolean);\n\n  const categoriesInItems = Array.from(new Set(items.map(item => item.category)));\n  const missingCategories = requiredCategories.filter(cat => !categoriesInItems.includes(cat));\n  const isValid = items.length >= minProducts && missingCategories.length === 0;\n\n  const saveSimulationMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return apiRequest(\"POST\", \"/api/barter/simulations\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/barter/simulations'] });\n      toast({\n        title: \"Simulação salva\",\n        description: \"Simulação barter salva com sucesso.\",\n      });\n      setSelectedClient(\"\");\n      setAreaHa(\"\");\n      setItems([]);\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao salvar simulação.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSave = () => {\n    if (!selectedClient || !areaHa || items.length === 0) {\n      toast({\n        title: \"Dados incompletos\",\n        description: \"Selecione cliente, área e adicione produtos.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (!isValid) {\n      toast({\n        title: \"Validação falhou\",\n        description: `Adicione pelo menos ${minProducts} produtos das categorias obrigatórias: ${requiredCategories.join(\", \")}`,\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const client = clients?.find(c => c.id === selectedClient);\n    const simulationData = {\n      clientId: selectedClient,\n      clientName: client?.name || \"\",\n      areaHa: parseFloat(areaHa),\n      totalUsd,\n      sackPriceUsd: sackPrice,\n      bufferPercentage,\n      grainQuantityKg,\n      grainQuantitySacks,\n      items,\n    };\n\n    saveSimulationMutation.mutate(simulationData);\n  };\n\n  return (\n    <div className=\"h-screen flex flex-col overflow-hidden\">\n      <Header \n        onNewSale={() => {}}\n        title=\"Simulador Barter\"\n        subtitle=\"Simule trocas de produtos por grãos\"\n      />\n      <Navbar />\n      \n      <main className=\"flex-1 overflow-y-auto\">\n        <div className=\"container mx-auto p-6 space-y-6\">\n\n      <div className=\"grid gap-6 md:grid-cols-3\">\n        <Card className=\"md:col-span-2\">\n          <CardHeader>\n            <CardTitle>Dados da Simulação</CardTitle>\n            <CardDescription>Configure cliente, área e produtos</CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            <div className=\"grid gap-4 md:grid-cols-2\">\n              <div className=\"space-y-2\">\n                <Label>Cliente</Label>\n                <Select value={selectedClient} onValueChange={setSelectedClient}>\n                  <SelectTrigger data-testid=\"select-barter-client\">\n                    <SelectValue placeholder=\"Selecione o cliente\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {clients?.map((client: any) => (\n                      <SelectItem key={client.id} value={client.id}>\n                        {client.customName || client.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label>Área (hectares)</Label>\n                <Input\n                  type=\"number\"\n                  step=\"0.01\"\n                  value={areaHa}\n                  onChange={(e) => setAreaHa(e.target.value)}\n                  placeholder=\"120\"\n                  data-testid=\"input-barter-area\"\n                />\n              </div>\n            </div>\n\n            <div className=\"border-t pt-4 space-y-4\">\n              <h3 className=\"font-semibold\">Adicionar Produtos</h3>\n              <div className=\"grid gap-4 md:grid-cols-4\">\n                <div className=\"space-y-2\">\n                  <Label>Categoria</Label>\n                  <Select value={selectedCategory} onValueChange={setSelectedCategory}>\n                    <SelectTrigger data-testid=\"select-barter-category\">\n                      <SelectValue placeholder=\"Categoria\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {categories.map((cat: string) => (\n                        <SelectItem key={cat} value={cat}>\n                          {cat.charAt(0).toUpperCase() + cat.slice(1)}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Produto</Label>\n                  <Select value={selectedProduct} onValueChange={setSelectedProduct} disabled={!selectedCategory}>\n                    <SelectTrigger data-testid=\"select-barter-product\">\n                      <SelectValue placeholder=\"Produto\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {filteredProducts.map((product: any) => (\n                        <SelectItem key={product.id} value={product.id}>\n                          {product.name} - ${product.priceUsd}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label>Quantidade</Label>\n                  <Input\n                    type=\"number\"\n                    step=\"0.01\"\n                    value={quantity}\n                    onChange={(e) => setQuantity(e.target.value)}\n                    placeholder=\"0\"\n                    disabled={!selectedProduct}\n                    data-testid=\"input-barter-quantity\"\n                  />\n                </div>\n\n                <div className=\"flex items-end\">\n                  <Button onClick={addItem} disabled={!selectedProduct || !quantity} data-testid=\"button-add-barter-item\">\n                    <Plus size={16} className=\"mr-2\" />\n                    Adicionar\n                  </Button>\n                </div>\n              </div>\n            </div>\n\n            {items.length > 0 && (\n              <div className=\"border-t pt-4\">\n                <h3 className=\"font-semibold mb-4\">Produtos Selecionados</h3>\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Produto</TableHead>\n                      <TableHead>Categoria</TableHead>\n                      <TableHead>Quantidade</TableHead>\n                      <TableHead>Preço Unit.</TableHead>\n                      <TableHead>Total USD</TableHead>\n                      <TableHead></TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {items.map((item, index) => (\n                      <TableRow key={index}>\n                        <TableCell>{item.productName}</TableCell>\n                        <TableCell>\n                          <Badge variant=\"outline\">{item.category}</Badge>\n                        </TableCell>\n                        <TableCell>{item.quantity} {item.unit}</TableCell>\n                        <TableCell>${item.priceUsd.toFixed(2)}</TableCell>\n                        <TableCell className=\"font-medium\">${item.totalUsd.toFixed(2)}</TableCell>\n                        <TableCell>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => removeItem(index)}\n                            data-testid={`button-remove-item-${index}`}\n                          >\n                            <Trash2 size={16} />\n                          </Button>\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Calculator size={20} />\n              Resumo do Cálculo\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"space-y-3\">\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"text-muted-foreground\">Total Produtos:</span>\n                <span className=\"font-medium\">${totalUsd.toFixed(2)}</span>\n              </div>\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"text-muted-foreground\">Buffer ({bufferPercentage}%):</span>\n                <span className=\"font-medium\">${totalWithBuffer.toFixed(2)}</span>\n              </div>\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"text-muted-foreground\">Preço Saca:</span>\n                <span className=\"font-medium\">${sackPrice.toFixed(2)}</span>\n              </div>\n              <div className=\"border-t pt-3\">\n                <div className=\"flex justify-between\">\n                  <span className=\"font-semibold\">Grãos (kg):</span>\n                  <span className=\"text-lg font-bold text-primary\">{grainQuantityKg.toFixed(2)} kg</span>\n                </div>\n                <div className=\"flex justify-between mt-2\">\n                  <span className=\"font-semibold\">Sacas (60kg):</span>\n                  <span className=\"text-lg font-bold text-primary\">{grainQuantitySacks.toFixed(2)}</span>\n                </div>\n              </div>\n            </div>\n\n            {!isValid && items.length > 0 && (\n              <div className=\"bg-yellow-50 dark:bg-yellow-950 p-3 rounded-lg border border-yellow-200 dark:border-yellow-800\">\n                <p className=\"text-sm text-yellow-800 dark:text-yellow-200 font-medium\">Validação Pendente:</p>\n                {items.length < minProducts && (\n                  <p className=\"text-xs text-yellow-700 dark:text-yellow-300 mt-1\">\n                    • Mínimo {minProducts} produtos (atual: {items.length})\n                  </p>\n                )}\n                {missingCategories.length > 0 && (\n                  <p className=\"text-xs text-yellow-700 dark:text-yellow-300 mt-1\">\n                    • Categorias obrigatórias: {missingCategories.join(\", \")}\n                  </p>\n                )}\n              </div>\n            )}\n\n            {isValid && items.length > 0 && (\n              <div className=\"bg-green-50 dark:bg-green-950 p-3 rounded-lg border border-green-200 dark:border-green-800\">\n                <p className=\"text-sm text-green-800 dark:text-green-200 font-medium\">✓ Simulação válida</p>\n              </div>\n            )}\n\n            <div className=\"space-y-2 pt-4\">\n              <Button\n                className=\"w-full\"\n                onClick={handleSave}\n                disabled={!selectedClient || !areaHa || items.length === 0 || !isValid || saveSimulationMutation.isPending}\n                data-testid=\"button-save-barter-simulation\"\n              >\n                <Save size={16} className=\"mr-2\" />\n                {saveSimulationMutation.isPending ? \"Salvando...\" : \"Salvar Simulação\"}\n              </Button>\n              <Button variant=\"outline\" className=\"w-full\" disabled>\n                <FileText size={16} className=\"mr-2\" />\n                Gerar Relatório\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n        </div>\n      </main>\n    </div>\n  );\n}\n","size_bytes":15058},"client/src/pages/clientes.tsx":{"content":"import Navbar from \"@/components/layout/navbar\";\nimport Header from \"@/components/layout/header\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Search, Plus, Edit, Users, MapPin, TrendingUp, FileSpreadsheet, Upload, Trash2, Users2 } from \"lucide-react\";\nimport type { Client, Region, InsertClient } from \"@shared/schema\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from \"@/components/ui/alert-dialog\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\n\nfunction FamilyGroupBadge({ clientId }: { clientId: string }) {\n  const { data: familyRelations } = useQuery<string[]>({\n    queryKey: [\"/api/clients\", clientId, \"family\"],\n  });\n\n  const familyCount = (familyRelations?.length || 0) + 1;\n\n  if (!familyRelations || familyRelations.length === 0) {\n    return null;\n  }\n\n  return (\n    <Badge variant=\"outline\" className=\"ml-2\" data-testid={`badge-family-${clientId}`}>\n      <Users2 className=\"h-3 w-3 mr-1\" />\n      Grupo ({familyCount})\n    </Badge>\n  );\n}\n\nexport default function Clientes() {\n  const [showNewClientModal, setShowNewClientModal] = useState(false);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [selectedRegion, setSelectedRegion] = useState(\"\");\n  const [showTop8020Only, setShowTop8020Only] = useState(false);\n  const [editingClient, setEditingClient] = useState<Client | null>(null);\n  const [showImportModal, setShowImportModal] = useState(false);\n  const [uploading, setUploading] = useState(false);\n  const [clientToDelete, setClientToDelete] = useState<Client | null>(null);\n  const [familyRelations, setFamilyRelations] = useState<string[]>([]);\n  const [selectedVendedorId, setSelectedVendedorId] = useState<string>(\"\");\n  const { toast } = useToast();\n\n  const [formData, setFormData] = useState({\n    name: \"\",\n    regionId: \"\",\n    plantingArea: \"\",\n    cultures: \"\",\n    plantingProgress: \"0\",\n    isTop80_20: false,\n    includeInMarketArea: false,\n  });\n\n  const { data: clients, isLoading } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\"],\n  });\n\n  const { data: regions } = useQuery<Region[]>({\n    queryKey: [\"/api/regions\"],\n  });\n\n  const { data: analytics } = useQuery<{\n    totalSales: number;\n    totalCommissions: number;\n    salesByCategory: { categoryId: string; categoryName: string; total: number; commissions: number }[];\n    topClients: { clientId: string; clientName: string; total: number; percentage: number }[];\n  }>({\n    queryKey: [\"/api/analytics/sales\"],\n  });\n\n  const { data: vendedores } = useQuery<{ id: string; username: string; name?: string; role: string }[]>({\n    queryKey: [\"/api/admin/vendedores\"],\n  });\n\n  const createClientMutation = useMutation({\n    mutationFn: async (clientData: InsertClient) => {\n      return apiRequest(\"POST\", \"/api/clients\", clientData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ \n        predicate: (query) => \n          query.queryKey[0] === \"/api/clients\" || \n          (typeof query.queryKey[0] === \"string\" && query.queryKey[0].startsWith(\"/api/clients\"))\n      });\n      toast({\n        title: \"Cliente cadastrado\",\n        description: \"O cliente foi cadastrado com sucesso.\",\n      });\n      setShowNewClientModal(false);\n      resetForm();\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao cadastrar cliente. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateClientMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<InsertClient> }) => {\n      return apiRequest(\"PATCH\", `/api/clients/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ \n        predicate: (query) => \n          query.queryKey[0] === \"/api/clients\" || \n          (typeof query.queryKey[0] === \"string\" && query.queryKey[0].startsWith(\"/api/clients\"))\n      });\n      queryClient.invalidateQueries({ predicate: (query) => \n        query.queryKey[0]?.toString().startsWith('/api/market-percentage/') ?? false\n      });\n      toast({\n        title: \"Cliente atualizado\",\n        description: \"As informações do cliente foram atualizadas.\",\n      });\n      setEditingClient(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao atualizar cliente. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteClientMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/clients/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ \n        predicate: (query) => \n          query.queryKey[0] === \"/api/clients\" || \n          (typeof query.queryKey[0] === \"string\" && query.queryKey[0].startsWith(\"/api/clients\"))\n      });\n      toast({\n        title: \"Cliente excluído\",\n        description: \"O cliente foi excluído com sucesso.\",\n      });\n      setClientToDelete(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao excluir cliente. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const { data: familyRelationsData } = useQuery<string[]>({\n    queryKey: [\"/api/clients\", editingClient?.id, \"family\"],\n    enabled: !!editingClient?.id,\n  });\n\n  const addFamilyRelationMutation = useMutation({\n    mutationFn: async ({ clientId, relatedClientId }: { clientId: string; relatedClientId: string }) => {\n      return apiRequest(\"POST\", `/api/clients/${clientId}/family`, { relatedClientId });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/clients\", editingClient?.id, \"family\"] });\n      toast({\n        title: \"Relação adicionada\",\n        description: \"Cliente vinculado ao grupo familiar.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao adicionar relação familiar.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const removeFamilyRelationMutation = useMutation({\n    mutationFn: async ({ clientId, relatedId }: { clientId: string; relatedId: string }) => {\n      return apiRequest(\"DELETE\", `/api/clients/${clientId}/family/${relatedId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/clients\", editingClient?.id, \"family\"] });\n      toast({\n        title: \"Relação removida\",\n        description: \"Cliente desvinculado do grupo familiar.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao remover relação familiar.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      name: \"\",\n      regionId: \"\",\n      plantingArea: \"\",\n      cultures: \"\",\n      plantingProgress: \"0\",\n      isTop80_20: false,\n      includeInMarketArea: false,\n    });\n  };\n\n  useEffect(() => {\n    if (editingClient) {\n      setFormData({\n        name: editingClient.name,\n        regionId: editingClient.regionId,\n        plantingArea: editingClient.plantingArea,\n        cultures: Array.isArray(editingClient.cultures) ? editingClient.cultures.join(\", \") : \"\",\n        plantingProgress: editingClient.plantingProgress,\n        isTop80_20: editingClient.isTop80_20,\n        includeInMarketArea: editingClient.includeInMarketArea || false,\n      });\n    }\n  }, [editingClient]);\n\n  useEffect(() => {\n    if (familyRelationsData) {\n      setFamilyRelations(familyRelationsData);\n    }\n  }, [familyRelationsData]);\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!formData.name || !formData.regionId || !formData.plantingArea) {\n      toast({\n        title: \"Campos obrigatórios\",\n        description: \"Preencha todos os campos obrigatórios.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const clientData: InsertClient = {\n      name: formData.name,\n      regionId: formData.regionId,\n      plantingArea: formData.plantingArea,\n      cultures: formData.cultures.split(\",\").map(c => c.trim()).filter(c => c),\n      plantingProgress: formData.plantingProgress,\n      isTop80_20: formData.isTop80_20,\n      isActive: true,\n    };\n\n    createClientMutation.mutate(clientData);\n  };\n\n  const handleEditSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!editingClient || !formData.name || !formData.regionId || !formData.plantingArea) {\n      toast({\n        title: \"Campos obrigatórios\",\n        description: \"Preencha todos os campos obrigatórios.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const clientData: Partial<InsertClient> = {\n      name: formData.name,\n      regionId: formData.regionId,\n      plantingArea: formData.plantingArea,\n      cultures: formData.cultures.split(\",\").map(c => c.trim()).filter(c => c),\n      plantingProgress: formData.plantingProgress,\n      isTop80_20: formData.isTop80_20,\n    };\n\n    updateClientMutation.mutate({ id: editingClient.id, data: clientData });\n  };\n\n  const toggleClient8020 = async (client: Client) => {\n    const newStatus = !client.isTop80_20;\n    updateClientMutation.mutate({ \n      id: client.id, \n      data: { isTop80_20: newStatus } \n    });\n    \n    toast({\n      title: newStatus ? \"Cliente marcado como 80/20\" : \"Cliente desmarcado como 80/20\",\n      description: `${client.name} ${newStatus ? 'agora é' : 'não é mais'} um cliente 80/20`,\n    });\n  };\n\n  const toggleClientMarketArea = async (client: Client) => {\n    const newStatus = !client.includeInMarketArea;\n    updateClientMutation.mutate({ \n      id: client.id, \n      data: { includeInMarketArea: newStatus } \n    });\n    \n    toast({\n      title: newStatus ? \"Cliente incluído no mercado\" : \"Cliente removido do mercado\",\n      description: `${client.name} ${newStatus ? 'agora está' : 'não está mais'} no mercado`,\n    });\n  };\n\n  const handleFamilyRelationToggle = (relatedClientId: string, isChecked: boolean) => {\n    if (!editingClient) return;\n\n    if (isChecked) {\n      addFamilyRelationMutation.mutate({\n        clientId: editingClient.id,\n        relatedClientId,\n      });\n    } else {\n      removeFamilyRelationMutation.mutate({\n        clientId: editingClient.id,\n        relatedId: relatedClientId,\n      });\n    }\n  };\n\n  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    if (!selectedVendedorId) {\n      toast({\n        title: \"Vendedor não selecionado\",\n        description: \"Por favor, selecione um vendedor antes de importar\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setUploading(true);\n    \n    const formData = new FormData();\n    formData.append('file', file);\n    formData.append('vendedorId', selectedVendedorId);\n\n    try {\n      const response = await fetch('/api/clients/import', {\n        method: 'POST',\n        body: formData,\n      });\n\n      const result = await response.json();\n\n      if (!response.ok) {\n        throw new Error(result.message || 'Erro ao importar clientes');\n      }\n\n      queryClient.invalidateQueries({ \n        predicate: (query) => \n          query.queryKey[0] === \"/api/clients\" || \n          (typeof query.queryKey[0] === \"string\" && query.queryKey[0].startsWith(\"/api/clients\"))\n      });\n      \n      toast({\n        title: \"Importação concluída\",\n        description: `${result.created || 0} clientes criados, ${result.updated || 0} atualizados`,\n      });\n      \n      setShowImportModal(false);\n      setSelectedVendedorId(\"\");\n    } catch (error: any) {\n      toast({\n        title: \"Erro na importação\",\n        description: error.message || \"Erro ao importar arquivo Excel\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setUploading(false);\n      // Reset file input\n      if (event.target) {\n        event.target.value = '';\n      }\n    }\n  };\n\n  const getRegionName = (regionId: string) => {\n    return regions?.find(r => r.id === regionId)?.name || \"Região não encontrada\";\n  };\n\n  const getClientSales = (clientId: string) => {\n    const clientSales = analytics?.topClients?.find((c: any) => c.clientId === clientId);\n    return clientSales ? clientSales.total : 0;\n  };\n\n  const filteredClients = clients?.filter(client => {\n    const nameMatch = client.name.toLowerCase().includes(searchTerm.toLowerCase());\n    const regionMatch = !selectedRegion || selectedRegion === \"all\" || client.regionId === selectedRegion;\n    return nameMatch && regionMatch;\n  }).sort((a, b) => a.name.localeCompare(b.name)) || [];\n\n  const totalClients = clients?.length || 0;\n  const top8020Clients = clients?.filter(c => c.isTop80_20).length || 0;\n  const totalPlantingArea = clients?.reduce((sum, client) => {\n    const area = parseFloat(client.plantingArea || '0');\n    return sum + (isNaN(area) ? 0 : area);\n  }, 0) || 0;\n  const top8020PlantingArea = clients?.filter(c => c.isTop80_20).reduce((sum, client) => {\n    const area = parseFloat(client.plantingArea || '0');\n    return sum + (isNaN(area) ? 0 : area);\n  }, 0) || 0;\n  const marketAreaTotal = clients?.filter(c => c.includeInMarketArea).reduce((sum, client) => {\n    const area = parseFloat(client.plantingArea || '0');\n    return sum + (isNaN(area) ? 0 : area);\n  }, 0) || 0;\n\n  if (isLoading) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-32 w-32 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-screen flex flex-col overflow-hidden\" data-testid=\"clientes-container\">\n      <Header \n        onNewSale={() => {}}\n        title=\"Gestão de Clientes\"\n        subtitle=\"Cadastro e acompanhamento da carteira de clientes\"\n      />\n      <Navbar />\n      \n      <main className=\"flex-1 overflow-y-auto\">\n\n        <div className=\"p-8\">\n          {/* Summary Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8\">\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center\">\n                    <Users className=\"text-primary\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Total de Clientes</p>\n                    <p className=\"text-2xl font-bold\">{totalClients}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-accent/10 rounded-lg flex items-center justify-center\">\n                    <MapPin className=\"text-accent\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Área Total</p>\n                    <p className=\"text-2xl font-bold\">{totalPlantingArea.toLocaleString()} ha</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                    <TrendingUp className=\"text-chart-2\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Clientes 80/20</p>\n                    <p className=\"text-2xl font-bold\">{top8020Clients}</p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {totalClients > 0 ? ((top8020Clients / totalClients) * 100).toFixed(1) : 0}% do total\n                    </p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-orange-100 dark:bg-orange-950 rounded-lg flex items-center justify-center\">\n                    <MapPin className=\"text-orange-600 dark:text-orange-400\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Área 80/20</p>\n                    <p className=\"text-2xl font-bold\">{top8020PlantingArea.toLocaleString()} ha</p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {totalPlantingArea > 0 ? ((top8020PlantingArea / totalPlantingArea) * 100).toFixed(1) : 0}% do total\n                    </p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-green-100 dark:bg-green-950 rounded-lg flex items-center justify-center\">\n                    <MapPin className=\"text-green-600 dark:text-green-400\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Área de Mercado</p>\n                    <p className=\"text-2xl font-bold\">{marketAreaTotal.toLocaleString()} ha</p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {totalPlantingArea > 0 ? ((marketAreaTotal / totalPlantingArea) * 100).toFixed(1) : 0}% do total\n                    </p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Filters and Actions */}\n          <Card className=\"shadow-sm mb-8\">\n            <CardHeader>\n              <CardTitle>Filtros e Ações</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex flex-wrap gap-4 items-end\">\n                <div className=\"flex-1 min-w-64\">\n                  <div className=\"relative\">\n                    <Search className=\"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n                    <Input\n                      placeholder=\"Buscar por nome do cliente...\"\n                      value={searchTerm}\n                      onChange={(e) => setSearchTerm(e.target.value)}\n                      className=\"pl-10\"\n                      data-testid=\"search-clients\"\n                    />\n                  </div>\n                </div>\n\n                <Select value={selectedRegion} onValueChange={setSelectedRegion}>\n                  <SelectTrigger className=\"w-48\" data-testid=\"filter-region\">\n                    <SelectValue placeholder=\"Filtrar por região\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"all\">Todas as regiões</SelectItem>\n                    {regions?.map((region) => (\n                      <SelectItem key={region.id} value={region.id}>\n                        {region.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n\n                <div className=\"flex gap-2\">\n                  <Button\n                    variant={showTop8020Only ? \"default\" : \"outline\"}\n                    onClick={() => setShowTop8020Only(!showTop8020Only)}\n                    data-testid=\"toggle-top-clients\"\n                  >\n                    {showTop8020Only ? \"Mostrar Todos\" : \"Apenas 80/20\"}\n                  </Button>\n                  \n                  <Dialog open={showImportModal} onOpenChange={setShowImportModal}>\n                    <DialogTrigger asChild>\n                      <Button variant=\"outline\" data-testid=\"button-import-clients\">\n                        <FileSpreadsheet className=\"h-4 w-4 mr-2\" />\n                        Importar Clientes\n                      </Button>\n                    </DialogTrigger>\n                    <DialogContent className=\"max-w-md\" data-testid=\"import-clients-modal\">\n                      <DialogHeader>\n                        <DialogTitle>Importar Clientes do Excel</DialogTitle>\n                      </DialogHeader>\n                      <div className=\"space-y-4\">\n                        <div className=\"bg-muted p-4 rounded-lg text-sm\">\n                          <p className=\"font-medium mb-2\">Formato esperado do Excel:</p>\n                          <ul className=\"list-disc list-inside space-y-1 text-muted-foreground\">\n                            <li><strong>Coluna A:</strong> Cliente (80/20)</li>\n                            <li><strong>Coluna B:</strong> Área de plantio em hectares (ha)</li>\n                            <li><strong>Coluna C:</strong> região</li>\n                          </ul>\n                          <p className=\"mt-3 text-xs text-muted-foreground\">\n                            * Clientes duplicados serão identificados por nome e atualizados automaticamente\n                          </p>\n                        </div>\n\n                        <div className=\"space-y-2\">\n                          <Label htmlFor=\"vendedor-select\">Selecionar Vendedor *</Label>\n                          <Select value={selectedVendedorId} onValueChange={setSelectedVendedorId}>\n                            <SelectTrigger data-testid=\"select-vendedor\">\n                              <SelectValue placeholder=\"Escolha o vendedor\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {vendedores?.map((vendedor) => (\n                                <SelectItem key={vendedor.id} value={vendedor.id}>\n                                  {vendedor.name || vendedor.username}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n                        \n                        <div className=\"border-2 border-dashed border-muted rounded-lg p-8 text-center\">\n                          <input\n                            type=\"file\"\n                            accept=\".xlsx,.xls\"\n                            onChange={handleFileUpload}\n                            disabled={uploading}\n                            className=\"hidden\"\n                            id=\"client-file-upload\"\n                            data-testid=\"input-file-upload\"\n                          />\n                          <label \n                            htmlFor=\"client-file-upload\" \n                            className={`cursor-pointer flex flex-col items-center gap-3 ${uploading ? 'opacity-50' : ''}`}\n                          >\n                            <div className=\"w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center\">\n                              <Upload className=\"text-primary\" size={24} />\n                            </div>\n                            <div>\n                              <p className=\"font-medium\">\n                                {uploading ? \"Importando...\" : \"Clique para selecionar arquivo\"}\n                              </p>\n                              <p className=\"text-sm text-muted-foreground\">\n                                Apenas arquivos Excel (.xlsx, .xls)\n                              </p>\n                            </div>\n                          </label>\n                        </div>\n                      </div>\n                    </DialogContent>\n                  </Dialog>\n                  \n                  <Dialog open={showNewClientModal} onOpenChange={setShowNewClientModal}>\n                    <DialogTrigger asChild>\n                      <Button data-testid=\"button-new-client\">\n                        <Plus className=\"h-4 w-4 mr-2\" />\n                        Novo Cliente\n                      </Button>\n                    </DialogTrigger>\n                    <DialogContent className=\"max-w-2xl\" data-testid=\"new-client-modal\">\n                      <DialogHeader>\n                        <DialogTitle>Novo Cliente</DialogTitle>\n                      </DialogHeader>\n                      <form onSubmit={handleSubmit} className=\"space-y-4\">\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          <div>\n                            <Label htmlFor=\"name\">Nome do Cliente *</Label>\n                            <Input\n                              value={formData.name}\n                              onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}\n                              data-testid=\"input-client-name\"\n                            />\n                          </div>\n                          <div>\n                            <Label htmlFor=\"region\">Região *</Label>\n                            <Select value={formData.regionId} onValueChange={(value) => \n                              setFormData(prev => ({ ...prev, regionId: value }))\n                            }>\n                              <SelectTrigger data-testid=\"select-region\">\n                                <SelectValue placeholder=\"Selecione a região\" />\n                              </SelectTrigger>\n                              <SelectContent>\n                                {regions?.map((region) => (\n                                  <SelectItem key={region.id} value={region.id}>\n                                    {region.name}\n                                  </SelectItem>\n                                ))}\n                              </SelectContent>\n                            </Select>\n                          </div>\n                        </div>\n\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                          <div>\n                            <Label htmlFor=\"plantingArea\">Área de Plantio (ha) *</Label>\n                            <Input\n                              type=\"number\"\n                              step=\"0.01\"\n                              value={formData.plantingArea}\n                              onChange={(e) => setFormData(prev => ({ ...prev, plantingArea: e.target.value }))}\n                              data-testid=\"input-planting-area\"\n                            />\n                          </div>\n                          <div>\n                            <Label htmlFor=\"plantingProgress\">Progresso de Plantio (%)</Label>\n                            <Input\n                              type=\"number\"\n                              min=\"0\"\n                              max=\"100\"\n                              value={formData.plantingProgress}\n                              onChange={(e) => setFormData(prev => ({ ...prev, plantingProgress: e.target.value }))}\n                              data-testid=\"input-planting-progress\"\n                            />\n                          </div>\n                        </div>\n\n                        <div>\n                          <Label htmlFor=\"cultures\">Culturas (separadas por vírgula)</Label>\n                          <Input\n                            placeholder=\"Ex: Soja, Milho, Trigo\"\n                            value={formData.cultures}\n                            onChange={(e) => setFormData(prev => ({ ...prev, cultures: e.target.value }))}\n                            data-testid=\"input-cultures\"\n                          />\n                        </div>\n\n                        <div className=\"flex items-center space-x-2\">\n                          <input\n                            type=\"checkbox\"\n                            id=\"isTop8020\"\n                            checked={formData.isTop80_20}\n                            onChange={(e) => setFormData(prev => ({ ...prev, isTop80_20: e.target.checked }))}\n                            data-testid=\"checkbox-top-client\"\n                          />\n                          <Label htmlFor=\"isTop8020\">Cliente 80/20 (principal contribuinte)</Label>\n                        </div>\n\n                        <div className=\"flex justify-end gap-3 pt-4\">\n                          <Button\n                            type=\"button\"\n                            variant=\"outline\"\n                            onClick={() => setShowNewClientModal(false)}\n                            data-testid=\"button-cancel\"\n                          >\n                            Cancelar\n                          </Button>\n                          <Button\n                            type=\"submit\"\n                            disabled={createClientMutation.isPending}\n                            data-testid=\"button-save\"\n                          >\n                            {createClientMutation.isPending ? \"Salvando...\" : \"Salvar Cliente\"}\n                          </Button>\n                        </div>\n                      </form>\n                    </DialogContent>\n                  </Dialog>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Edit Client Modal */}\n          <Dialog open={!!editingClient} onOpenChange={(open) => {\n            if (!open) {\n              setEditingClient(null);\n              resetForm();\n            }\n          }}>\n            <DialogContent className=\"max-w-2xl\" data-testid=\"edit-client-modal\">\n              <DialogHeader>\n                <DialogTitle>Editar Cliente</DialogTitle>\n              </DialogHeader>\n              <form onSubmit={handleEditSubmit} className=\"space-y-4\">\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"edit-name\">Nome do Cliente *</Label>\n                    <Input\n                      id=\"edit-name\"\n                      value={formData.name}\n                      onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}\n                      data-testid=\"input-edit-client-name\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor=\"edit-region\">Região *</Label>\n                    <Select value={formData.regionId} onValueChange={(value) => \n                      setFormData(prev => ({ ...prev, regionId: value }))\n                    }>\n                      <SelectTrigger data-testid=\"select-edit-region\">\n                        <SelectValue placeholder=\"Selecione a região\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {regions?.map((region) => (\n                          <SelectItem key={region.id} value={region.id}>\n                            {region.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"edit-plantingArea\">Área de Plantio (ha) *</Label>\n                    <Input\n                      id=\"edit-plantingArea\"\n                      type=\"number\"\n                      step=\"0.01\"\n                      value={formData.plantingArea}\n                      onChange={(e) => setFormData(prev => ({ ...prev, plantingArea: e.target.value }))}\n                      data-testid=\"input-edit-planting-area\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor=\"edit-plantingProgress\">Progresso de Plantio (%)</Label>\n                    <Input\n                      id=\"edit-plantingProgress\"\n                      type=\"number\"\n                      min=\"0\"\n                      max=\"100\"\n                      value={formData.plantingProgress}\n                      onChange={(e) => setFormData(prev => ({ ...prev, plantingProgress: e.target.value }))}\n                      data-testid=\"input-edit-planting-progress\"\n                    />\n                  </div>\n                </div>\n\n                <div>\n                  <Label htmlFor=\"edit-cultures\">Culturas (separadas por vírgula)</Label>\n                  <Input\n                    id=\"edit-cultures\"\n                    placeholder=\"Ex: Soja, Milho, Trigo\"\n                    value={formData.cultures}\n                    onChange={(e) => setFormData(prev => ({ ...prev, cultures: e.target.value }))}\n                    data-testid=\"input-edit-cultures\"\n                  />\n                </div>\n\n                <div className=\"flex items-center space-x-2\">\n                  <input\n                    type=\"checkbox\"\n                    id=\"edit-isTop8020\"\n                    checked={formData.isTop80_20}\n                    onChange={(e) => setFormData(prev => ({ ...prev, isTop80_20: e.target.checked }))}\n                    data-testid=\"checkbox-edit-top-client\"\n                  />\n                  <Label htmlFor=\"edit-isTop8020\">Cliente 80/20 (principal contribuinte)</Label>\n                </div>\n\n                <div className=\"border-t pt-4 mt-4\">\n                  <div className=\"flex items-center gap-2 mb-3\">\n                    <Users2 className=\"h-5 w-5 text-muted-foreground\" />\n                    <Label className=\"text-base font-semibold\">Grupo Familiar</Label>\n                  </div>\n                  <p className=\"text-sm text-muted-foreground mb-4\">\n                    Vincular clientes da mesma família (área compartilhada nos cálculos)\n                  </p>\n                  <div className=\"max-h-60 overflow-y-auto border rounded-md p-3 space-y-2\">\n                    {clients?.filter(c => c.id !== editingClient?.id).length === 0 ? (\n                      <p className=\"text-sm text-muted-foreground text-center py-4\">\n                        Nenhum outro cliente disponível\n                      </p>\n                    ) : (\n                      clients?.filter(c => c.id !== editingClient?.id).map(client => (\n                        <div key={client.id} className=\"flex items-center space-x-2\" data-testid={`family-relation-${client.id}`}>\n                          <Checkbox\n                            id={`family-${client.id}`}\n                            checked={familyRelations.includes(client.id)}\n                            onCheckedChange={(checked) => handleFamilyRelationToggle(client.id, checked as boolean)}\n                            data-testid={`checkbox-family-${client.id}`}\n                          />\n                          <Label\n                            htmlFor={`family-${client.id}`}\n                            className=\"text-sm font-normal cursor-pointer flex-1\"\n                          >\n                            {client.name}\n                            <span className=\"text-muted-foreground ml-2\">\n                              ({getRegionName(client.regionId)})\n                            </span>\n                          </Label>\n                        </div>\n                      ))\n                    )}\n                  </div>\n                </div>\n\n                <div className=\"flex justify-end gap-3 pt-4\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={() => setEditingClient(null)}\n                    data-testid=\"button-cancel-edit\"\n                  >\n                    Cancelar\n                  </Button>\n                  <Button\n                    type=\"submit\"\n                    disabled={updateClientMutation.isPending}\n                    data-testid=\"button-save-edit\"\n                  >\n                    {updateClientMutation.isPending ? \"Salvando...\" : \"Salvar Alterações\"}\n                  </Button>\n                </div>\n              </form>\n            </DialogContent>\n          </Dialog>\n\n          {/* Clients Table */}\n          <Card className=\"shadow-sm\">\n            <CardHeader>\n              <CardTitle>Lista de Clientes</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {filteredClients.length === 0 ? (\n                <div className=\"text-center py-12\">\n                  <p className=\"text-muted-foreground\">Nenhum cliente encontrado</p>\n                  <Button \n                    onClick={() => setShowNewClientModal(true)} \n                    className=\"mt-4\"\n                    data-testid=\"button-first-client\"\n                  >\n                    <Plus className=\"h-4 w-4 mr-2\" />\n                    Cadastrar primeiro cliente\n                  </Button>\n                </div>\n              ) : (\n                <div className=\"overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead>Cliente</TableHead>\n                        <TableHead>Região</TableHead>\n                        <TableHead>Área (ha)</TableHead>\n                        <TableHead>Culturas</TableHead>\n                        <TableHead>Progresso</TableHead>\n                        <TableHead className=\"text-right\">Vendas (USD)</TableHead>\n                        <TableHead className=\"text-center\">80/20</TableHead>\n                        <TableHead className=\"text-center\">Mercado</TableHead>\n                        <TableHead className=\"text-center\">Ações</TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {filteredClients.map((client) => (\n                        <TableRow key={client.id} data-testid={`client-row-${client.id}`}>\n                          <TableCell className=\"font-medium\">\n                            <div className=\"flex items-center\">\n                              {client.name}\n                              <FamilyGroupBadge clientId={client.id} />\n                            </div>\n                          </TableCell>\n                          <TableCell>{getRegionName(client.regionId)}</TableCell>\n                          <TableCell className=\"font-mono\">\n                            {parseFloat(client.plantingArea).toLocaleString()}\n                          </TableCell>\n                          <TableCell>\n                            <div className=\"flex flex-wrap gap-1\">\n                              {(Array.isArray(client.cultures) ? client.cultures : []).map((culture: string, index: number) => (\n                                <Badge key={index} variant=\"outline\" className=\"text-xs\">\n                                  {culture}\n                                </Badge>\n                              ))}\n                            </div>\n                          </TableCell>\n                          <TableCell>\n                            <div className=\"flex items-center gap-2\">\n                              <div className=\"flex-1 bg-muted rounded-full h-2\">\n                                <div\n                                  className=\"progress-bar-fill bg-primary h-full rounded-full\"\n                                  style={{ width: `${client.plantingProgress}%` }}\n                                />\n                              </div>\n                              <span className=\"text-sm font-mono\">{client.plantingProgress}%</span>\n                            </div>\n                          </TableCell>\n                          <TableCell className=\"text-right font-mono\">\n                            ${getClientSales(client.id).toLocaleString()}\n                          </TableCell>\n                          <TableCell className=\"text-center\">\n                            <Badge \n                              onClick={() => toggleClient8020(client)}\n                              className={`cursor-pointer transition-all hover:scale-105 ${\n                                client.isTop80_20 \n                                  ? 'bg-primary text-primary-foreground hover:bg-primary/90' \n                                  : 'bg-white dark:bg-white text-black dark:text-black border border-input hover:bg-white/80 dark:hover:bg-white/80'\n                              }`}\n                              data-testid={`badge-8020-${client.id}`}\n                            >\n                              80/20\n                            </Badge>\n                          </TableCell>\n                          <TableCell className=\"text-center\">\n                            <Badge \n                              onClick={() => toggleClientMarketArea(client)}\n                              style={{\n                                backgroundColor: client.includeInMarketArea ? '#F7D601' : 'white',\n                                color: client.includeInMarketArea ? 'black' : 'black',\n                                border: client.includeInMarketArea ? 'none' : '1px solid hsl(var(--input))'\n                              }}\n                              className=\"cursor-pointer transition-all hover:scale-105\"\n                              data-testid={`badge-market-${client.id}`}\n                            >\n                              Mercado\n                            </Badge>\n                          </TableCell>\n                          <TableCell className=\"text-center\">\n                            <div className=\"flex items-center justify-center gap-1\">\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => setEditingClient(client)}\n                                data-testid={`button-edit-${client.id}`}\n                              >\n                                <Edit className=\"h-4 w-4\" />\n                              </Button>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => setClientToDelete(client)}\n                                data-testid={`button-delete-${client.id}`}\n                              >\n                                <Trash2 className=\"h-4 w-4 text-destructive\" />\n                              </Button>\n                            </div>\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                    </TableBody>\n                  </Table>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </main>\n\n      {/* Delete Confirmation Dialog */}\n      <AlertDialog open={!!clientToDelete} onOpenChange={(open) => !open && setClientToDelete(null)}>\n        <AlertDialogContent data-testid=\"delete-client-dialog\">\n          <AlertDialogHeader>\n            <AlertDialogTitle>Confirmar Exclusão</AlertDialogTitle>\n            <AlertDialogDescription>\n              Tem certeza que deseja excluir o cliente <strong>{clientToDelete?.name}</strong>? \n              Esta ação não pode ser desfeita.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete\">Cancelar</AlertDialogCancel>\n            <Button\n              onClick={() => {\n                if (clientToDelete) {\n                  deleteClientMutation.mutate(clientToDelete.id);\n                }\n              }}\n              disabled={deleteClientMutation.isPending}\n              className=\"bg-destructive hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteClientMutation.isPending ? \"Excluindo...\" : \"Excluir\"}\n            </Button>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </div>\n  );\n}\n","size_bytes":44782},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","size_bytes":5128},"server/seed.ts":{"content":"import { db } from './db';\nimport * as schema from '@shared/schema';\n\nasync function seed() {\n  console.log('🌱 Seeding database...');\n\n  const categoryData = [\n    {\n      id: \"cat-fertilizantes\",\n      name: \"Fertilizantes\",\n      type: \"fertilizantes\",\n      greenCommission: \"0.30\",\n      greenMarginMin: \"7.00\",\n      yellowCommission: \"0.20\",\n      yellowMarginMin: \"6.00\",\n      yellowMarginMax: \"6.99\",\n      redCommission: \"0.18\",\n      redMarginMin: \"4.00\",\n      redMarginMax: \"4.99\",\n      belowListCommission: \"0.15\",\n      defaultIva: \"10.00\",\n    },\n    {\n      id: \"cat-sem-diversas\",\n      name: \"Sementes Diversas\",\n      type: \"sementes\",\n      greenCommission: \"1.00\",\n      greenMarginMin: \"13.00\",\n      yellowCommission: \"0.70\",\n      yellowMarginMin: \"10.00\",\n      yellowMarginMax: \"12.99\",\n      redCommission: \"0.40\",\n      redMarginMin: \"8.00\",\n      redMarginMax: \"9.99\",\n      belowListCommission: \"0.15\",\n      defaultIva: \"10.00\",\n    },\n    {\n      id: \"cat-sem-trigo\",\n      name: \"Sementes Trigo\",\n      type: \"sementes\",\n      greenCommission: \"1.50\",\n      greenMarginMin: \"16.00\",\n      yellowCommission: \"1.00\",\n      yellowMarginMin: \"13.00\",\n      yellowMarginMax: \"15.99\",\n      redCommission: \"0.50\",\n      redMarginMin: \"10.00\",\n      redMarginMax: \"12.99\",\n      belowListCommission: \"0.25\",\n      defaultIva: \"10.00\",\n    },\n    {\n      id: \"cat-sem-milho\",\n      name: \"Sementes Milho\",\n      type: \"sementes\",\n      greenCommission: \"2.50\",\n      greenMarginMin: \"25.00\",\n      yellowCommission: \"1.70\",\n      yellowMarginMin: \"20.00\",\n      yellowMarginMax: \"24.99\",\n      redCommission: \"1.00\",\n      redMarginMin: \"15.00\",\n      redMarginMax: \"19.99\",\n      belowListCommission: \"0.50\",\n      defaultIva: \"10.00\",\n    },\n    {\n      id: \"cat-sem-soja\",\n      name: \"Sementes Soja\",\n      type: \"sementes\",\n      greenCommission: \"3.50\",\n      greenMarginMin: \"25.00\",\n      yellowCommission: \"2.50\",\n      yellowMarginMin: \"20.00\",\n      yellowMarginMax: \"24.99\",\n      redCommission: \"2.00\",\n      redMarginMin: \"15.00\",\n      redMarginMax: \"19.99\",\n      belowListCommission: \"1.00\",\n      defaultIva: \"10.00\",\n    },\n    {\n      id: \"cat-especialidades\",\n      name: \"Especialidades\",\n      type: \"especialidades\",\n      greenCommission: \"1.00\",\n      greenMarginMin: \"13.00\",\n      yellowCommission: \"0.70\",\n      yellowMarginMin: \"10.00\",\n      yellowMarginMax: \"12.99\",\n      redCommission: \"0.40\",\n      redMarginMin: \"7.00\",\n      redMarginMax: \"9.99\",\n      belowListCommission: \"0.15\",\n      defaultIva: \"10.00\",\n    },\n    {\n      id: \"cat-agroquimicos\",\n      name: \"Agroquímicos\",\n      type: \"agroquimicos\",\n      greenCommission: \"1.00\",\n      greenMarginMin: \"13.00\",\n      yellowCommission: \"0.70\",\n      yellowMarginMin: \"10.00\",\n      yellowMarginMax: \"12.99\",\n      redCommission: \"0.40\",\n      redMarginMin: \"7.00\",\n      redMarginMax: \"9.99\",\n      belowListCommission: \"0.15\",\n      defaultIva: \"10.00\",\n    },\n    {\n      id: \"cat-corretivos\",\n      name: \"Corretivos\",\n      type: \"corretivos\",\n      greenCommission: \"0.30\",\n      greenMarginMin: \"7.00\",\n      yellowCommission: \"0.20\",\n      yellowMarginMin: \"6.00\",\n      yellowMarginMax: \"6.99\",\n      redCommission: \"0.18\",\n      redMarginMin: \"4.00\",\n      redMarginMax: \"4.99\",\n      belowListCommission: \"0.15\",\n      defaultIva: \"10.00\",\n    },\n  ];\n\n  const regionData = [\n    { id: \"reg-alto-parana\", name: \"Alto Paraná\", country: \"Paraguay\" },\n    { id: \"reg-itapua\", name: \"Itapúa\", country: \"Paraguay\" },\n    { id: \"reg-canindeyu\", name: \"Canindeyú\", country: \"Paraguay\" },\n    { id: \"reg-caaguazu\", name: \"Caaguazú\", country: \"Paraguay\" },\n  ];\n\n  const seasonParamData = [\n    {\n      id: \"sp-soja-verao\",\n      type: \"soja_verao\" as const,\n      dueDateMonth: 3,\n      dueDateDay: 30,\n      labelPattern: \"Soja {year}/{next_year}\",\n    },\n    {\n      id: \"sp-soja-verao-alt\",\n      type: \"soja_verao\" as const,\n      dueDateMonth: 4,\n      dueDateDay: 30,\n      labelPattern: \"Soja {year}/{next_year}\",\n    },\n    {\n      id: \"sp-soja-safrinha\",\n      type: \"soja_safrinha\" as const,\n      dueDateMonth: 6,\n      dueDateDay: 30,\n      labelPattern: \"Soja Safrinha {year}\",\n    },\n    {\n      id: \"sp-milho\",\n      type: \"milho\" as const,\n      dueDateMonth: 8,\n      dueDateDay: 30,\n      labelPattern: \"Milho {year}/{year}\",\n    },\n    {\n      id: \"sp-trigo\",\n      type: \"trigo\" as const,\n      dueDateMonth: 10,\n      dueDateDay: 30,\n      labelPattern: \"Trigo {year}\",\n    },\n  ];\n\n  try {\n    const existingCategories = await db.select().from(schema.categories);\n    if (existingCategories.length === 0) {\n      console.log('  📦 Inserting categories...');\n      await db.insert(schema.categories).values(categoryData);\n      console.log(`  ✅ Inserted ${categoryData.length} categories`);\n    } else {\n      console.log(`  ℹ️  Categories already exist (${existingCategories.length}), skipping...`);\n    }\n\n    const existingRegions = await db.select().from(schema.regions);\n    if (existingRegions.length === 0) {\n      console.log('  🗺️  Inserting regions...');\n      await db.insert(schema.regions).values(regionData);\n      console.log(`  ✅ Inserted ${regionData.length} regions`);\n    } else {\n      console.log(`  ℹ️  Regions already exist (${existingRegions.length}), skipping...`);\n    }\n\n    const existingParams = await db.select().from(schema.seasonParameters);\n    if (existingParams.length === 0) {\n      console.log('  📅 Inserting season parameters...');\n      await db.insert(schema.seasonParameters).values(seasonParamData);\n      console.log(`  ✅ Inserted ${seasonParamData.length} season parameters`);\n    } else {\n      console.log(`  ℹ️  Season parameters already exist (${existingParams.length}), skipping...`);\n    }\n\n    console.log('✅ Seed completed successfully!');\n    process.exit(0);\n  } catch (error) {\n    console.error('❌ Seed failed:', error);\n    process.exit(1);\n  }\n}\n\nseed();\n","size_bytes":5998},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","size_bytes":166},"client/src/components/dashboard/regional-progress.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\n\nconst regionData = [\n  { name: \"Alto Paraná\", progress: 78, hectares: \"12,450 ha plantados\", color: \"verde\" },\n  { name: \"Itapúa\", progress: 65, hectares: \"8,920 ha plantados\", color: \"amarela\" },\n  { name: \"Canindeyú\", progress: 52, hectares: \"6,340 ha plantados\", color: \"vermelha\" },\n  { name: \"Caaguazú\", progress: 71, hectares: \"9,180 ha plantados\", color: \"amarela\" },\n];\n\nexport default function RegionalProgress() {\n  return (\n    <Card className=\"shadow-sm\" data-testid=\"regional-progress\">\n      <CardHeader>\n        <CardTitle className=\"text-lg font-bold\">Avanço de Plantio por Região</CardTitle>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-4\">\n          {regionData.map((region) => (\n            <div key={region.name}>\n              <div className=\"flex items-center justify-between mb-2\">\n                <span className=\"text-sm font-medium text-foreground\">{region.name}</span>\n                <span className=\"text-sm font-bold text-foreground font-mono\">{region.progress}%</span>\n              </div>\n              <Progress \n                value={region.progress} \n                className=\"h-2\"\n                data-testid={`progress-${region.name.toLowerCase().replace(/\\s+/g, '-')}`}\n              />\n              <p className=\"text-xs text-muted-foreground mt-1\">{region.hectares}</p>\n            </div>\n          ))}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":1569},"client/src/components/dashboard/commissions-chart.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from 'recharts';\nimport type { SeasonGoal, Sale, Category } from \"@shared/schema\";\n\ninterface CommissionsChartProps {\n  seasonGoal: SeasonGoal | undefined;\n  salesData: Sale[] | undefined;\n  categories: Category[] | undefined;\n}\n\nconst getCategoryGoalField = (category: Category): keyof SeasonGoal | null => {\n  const type = category.type.toLowerCase();\n  const name = category.name.toLowerCase();\n  \n  if (type.includes('agroquimic') || name.includes('agroquímic')) return 'metaAgroquimicos';\n  if (type.includes('especialidad') || name.includes('especialidad')) return 'metaEspecialidades';\n  if (type.includes('fertilizante') || name.includes('fertilizante')) return 'metaFertilizantes';\n  if (type.includes('corretivo') || name.includes('corretivo')) return 'metaCorretivos';\n  \n  if (type.includes('semente') || name.includes('semente')) {\n    if (name.includes('milho')) return 'metaSementesMilho';\n    if (name.includes('soja')) return 'metaSementesSoja';\n    if (name.includes('trigo')) return 'metaSementesTrigo';\n    if (name.includes('diversas')) return 'metaSementesDiversas';\n  }\n  \n  return null;\n};\n\nconst getDisplayName = (goalField: keyof SeasonGoal): string => {\n  const nameMap: Record<string, string> = {\n    'metaAgroquimicos': 'Agroquímicos',\n    'metaEspecialidades': 'Especialidades',\n    'metaFertilizantes': 'Fertilizantes',\n    'metaCorretivos': 'Corretivos',\n    'metaSementesMilho': 'Sementes Milho',\n    'metaSementesSoja': 'Sementes Soja',\n    'metaSementesTrigo': 'Sementes Trigo',\n    'metaSementesDiversas': 'Sementes Diversas',\n  };\n  return nameMap[goalField] || goalField;\n};\n\nexport default function CommissionsChart({ seasonGoal, salesData, categories }: CommissionsChartProps) {\n  if (!salesData || !categories) {\n    return (\n      <Card className=\"shadow-sm\" data-testid=\"commissions-chart\">\n        <CardHeader className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle className=\"text-lg font-bold\">Metas por Categoria</CardTitle>\n            <p className=\"text-sm text-muted-foreground\">Meta vs Realizado</p>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex items-center justify-center h-[400px] text-muted-foreground\">\n            <p>Carregando dados...</p>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (!seasonGoal) {\n    return (\n      <Card className=\"shadow-sm\" data-testid=\"commissions-chart\">\n        <CardHeader className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle className=\"text-lg font-bold\">Metas por Categoria</CardTitle>\n            <p className=\"text-sm text-muted-foreground\">Meta vs Realizado</p>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"flex items-center justify-center h-[400px] text-muted-foreground\">\n            <p>Configure uma meta para ver o progresso</p>\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const categoryIdToCategory = categories.reduce((acc, cat) => {\n    acc[cat.id] = cat;\n    return acc;\n  }, {} as Record<string, Category>);\n\n  const categoryIdToGoalField = categories.reduce((acc, cat) => {\n    const goalField = getCategoryGoalField(cat);\n    if (goalField) {\n      acc[cat.id] = goalField;\n    }\n    return acc;\n  }, {} as Record<string, keyof SeasonGoal>);\n\n  const realizadoPorGoalField = salesData.reduce((acc, sale) => {\n    const goalField = categoryIdToGoalField[sale.categoryId];\n    if (goalField) {\n      if (!acc[goalField]) {\n        acc[goalField] = 0;\n      }\n      acc[goalField] += Number(sale.totalAmount);\n    }\n    return acc;\n  }, {} as Record<keyof SeasonGoal, number>);\n\n  const allGoalFields: Array<keyof SeasonGoal> = [\n    'metaAgroquimicos',\n    'metaEspecialidades',\n    'metaFertilizantes',\n    'metaCorretivos',\n    'metaSementesMilho',\n    'metaSementesSoja',\n    'metaSementesTrigo',\n    'metaSementesDiversas',\n  ];\n\n  const chartData = allGoalFields\n    .map(goalField => ({\n      name: getDisplayName(goalField),\n      Meta: Number(seasonGoal[goalField] || \"0\"),\n      Realizado: realizadoPorGoalField[goalField] || 0,\n    }))\n    .filter(item => item.Meta > 0 || item.Realizado > 0);\n\n  const CustomTooltip = ({ active, payload, label }: any) => {\n    if (active && payload && payload.length) {\n      const meta = payload.find((p: any) => p.dataKey === \"Meta\")?.value || 0;\n      const realizado = payload.find((p: any) => p.dataKey === \"Realizado\")?.value || 0;\n      const percentual = meta > 0 ? ((realizado / meta) * 100).toFixed(1) : \"0.0\";\n\n      return (\n        <div className=\"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 p-3 rounded shadow-lg\">\n          <p className=\"font-semibold mb-2\">{label}</p>\n          <p className=\"text-sm text-blue-600 dark:text-blue-400\">\n            Meta: ${meta.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n          </p>\n          <p className=\"text-sm text-green-600 dark:text-green-400\">\n            Realizado: ${realizado.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n          </p>\n          <p className=\"text-sm text-gray-600 dark:text-gray-400 mt-1\">\n            Atingimento: {percentual}%\n          </p>\n        </div>\n      );\n    }\n    return null;\n  };\n\n  return (\n    <Card className=\"shadow-sm\" data-testid=\"commissions-chart\">\n      <CardHeader className=\"flex items-center justify-between\">\n        <div>\n          <CardTitle className=\"text-lg font-bold\">Metas por Categoria</CardTitle>\n          <p className=\"text-sm text-muted-foreground\">Meta vs Realizado</p>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"chart-container\">\n          <ResponsiveContainer width=\"100%\" height=\"100%\">\n            <BarChart data={chartData}>\n              <CartesianGrid strokeDasharray=\"3 3\" />\n              <XAxis \n                dataKey=\"name\" \n                tick={{ fontSize: 12 }}\n                angle={-45}\n                textAnchor=\"end\"\n                height={100}\n              />\n              <YAxis \n                tick={{ fontSize: 12 }}\n                tickFormatter={(value) => `$${(value / 1000).toFixed(0)}k`}\n              />\n              <Tooltip content={<CustomTooltip />} />\n              <Legend \n                wrapperStyle={{ paddingTop: '20px' }}\n                iconType=\"rect\"\n              />\n              <Bar \n                dataKey=\"Meta\" \n                fill=\"#3b82f6\"\n                radius={[4, 4, 0, 0]}\n              />\n              <Bar \n                dataKey=\"Realizado\" \n                fill=\"#22c55e\"\n                radius={[4, 4, 0, 0]}\n              />\n            </BarChart>\n          </ResponsiveContainer>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":6993},"server/import-excel.ts":{"content":"import * as XLSX from 'xlsx';\nimport { storage } from './storage';\nimport type { InsertClient, InsertProduct, InsertSale, SeasonParameter } from '@shared/schema';\n\nexport interface ExcelRow {\n  Usuario?: string;\n  __EMPTY?: string;\n  __EMPTY_1?: string;\n  __EMPTY_2?: string;\n  'Tabla de Precio'?: string;\n  'Num. Pedido'?: string;\n  Mercadería?: string;\n  Fabricante?: string;\n  Subgrupo?: string;\n  ' Vl.Unitario Medio '?: number;\n  'Cant. Pedido'?: number;\n  ' Vl. Pedido '?: number;\n  'Plan Fin.'?: string;\n  'Fecha Emisión'?: number | string;\n  'Fecha Venc.'?: number | string;\n  Sucursal?: string;\n}\n\nexport interface ImportResult {\n  success: boolean;\n  totalRows: number;\n  importedSales: number;\n  skippedDuplicates: number;\n  createdClients: number;\n  createdProducts: number;\n  barterSales: number;\n  errors: string[];\n}\n\nexport interface ClientImportResult {\n  success: boolean;\n  created: number;\n  updated: number;\n  errors: string[];\n}\n\nfunction normalizeClientName(name: string): string {\n  // Normalizar nome do cliente: remover acentos, converter para minúsculas, remover espaços extras e pontuação\n  return name\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '') // Remove acentos\n    .replace(/[.,\\-\\s]/g, '') // Remove pontos, vírgulas, hífens e espaços\n    .toLowerCase()\n    .trim();\n}\n\n/**\n * Busca ou cria master client + user client link\n * 1. Busca master client por nome normalizado\n * 2. Se encontrou: verifica se usuário já tem link, senão cria\n * 3. Se não encontrou: cria master client + cria link\n */\nasync function getOrCreateClientLink(\n  clientName: string,\n  regionId: string,\n  userId: string\n): Promise<string> {\n  // Buscar master client por nome normalizado\n  const masterClient = await storage.findMasterClientByName(clientName);\n  \n  if (masterClient) {\n    // Master client existe - verificar se usuário já tem link\n    const existingLink = await storage.getUserClientLink(userId, masterClient.id);\n    \n    if (existingLink) {\n      // Link já existe\n      return existingLink.id;\n    }\n    \n    // Criar novo link para este usuário\n    const newLink = await storage.createUserClientLink({\n      userId,\n      masterClientId: masterClient.id,\n      customName: null,\n      plantingArea: null,\n      cultures: null,\n      plantingProgress: \"0.00\",\n      isTop80_20: false,\n      isActive: true\n    });\n    \n    return newLink.id;\n  }\n  \n  // Master client não existe - criar master + link\n  const newMasterClient = await storage.createMasterClient({\n    name: clientName,\n    regionId: regionId,\n    plantingArea: null,\n    cultures: [],\n    isActive: true\n  });\n  \n  const newLink = await storage.createUserClientLink({\n    userId,\n    masterClientId: newMasterClient.id,\n    customName: null,\n    plantingArea: null,\n    cultures: null,\n    plantingProgress: \"0.00\",\n    isTop80_20: false,\n    isActive: true\n  });\n  \n  return newLink.id;\n}\n\nfunction parseExcelDate(excelDate: any): Date | null {\n  if (!excelDate) return null;\n  \n  if (typeof excelDate === 'number') {\n    // Excel armazena datas como número de dias desde 1900-01-01\n    // Mas há um bug histórico: Excel conta 1900 como ano bissexto (incorreto)\n    const EXCEL_EPOCH = new Date(1899, 11, 30); // 30 de dezembro de 1899\n    const daysOffset = excelDate;\n    const date = new Date(EXCEL_EPOCH.getTime() + daysOffset * 24 * 60 * 60 * 1000);\n    return date;\n  }\n  \n  if (typeof excelDate === 'string') {\n    const parsed = new Date(excelDate);\n    if (!isNaN(parsed.getTime())) {\n      return parsed;\n    }\n  }\n  \n  return null;\n}\n\nfunction normalizeNumeric(value: any): number | null {\n  if (value === null || value === undefined || value === '') return null;\n  \n  if (typeof value === 'number') return value;\n  \n  if (typeof value === 'string') {\n    let normalized = value.trim();\n    \n    normalized = normalized.replace(/\\./g, '');\n    normalized = normalized.replace(',', '.');\n    \n    if (normalized.includes('/')) {\n      const parts = normalized.split('/');\n      if (parts.length === 2) {\n        const numerator = parseFloat(parts[0]);\n        const denominator = parseFloat(parts[1]);\n        if (!isNaN(numerator) && !isNaN(denominator) && denominator !== 0) {\n          return numerator / denominator;\n        }\n      }\n    }\n    \n    const parsed = parseFloat(normalized);\n    if (!isNaN(parsed)) return parsed;\n  }\n  \n  return null;\n}\n\nfunction resolveCategoryId(subgrupo: string | undefined, categories: any[]): string {\n  if (!subgrupo) {\n    return categories[0]?.id || 'cat-fertilizantes';\n  }\n  \n  const normalized = subgrupo.toLowerCase().trim()\n    .normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\n  \n  // Mapeamento específico para sementes (subcategorias específicas)\n  if (normalized.includes('soja') || normalized.includes('soya')) {\n    const category = categories.find(c => c.id === 'cat-sem-soja');\n    if (category) return category.id;\n  }\n  \n  if (normalized.includes('milho') || normalized.includes('maiz') || normalized.includes('corn')) {\n    const category = categories.find(c => c.id === 'cat-sem-milho');\n    if (category) return category.id;\n  }\n  \n  if (normalized.includes('trigo') || normalized.includes('wheat')) {\n    const category = categories.find(c => c.id === 'cat-sem-trigo');\n    if (category) return category.id;\n  }\n  \n  // Sementes genéricas ou diversas\n  if (normalized.includes('semente') || normalized.includes('semilla') || normalized.includes('semilha') || normalized.includes('seed')) {\n    const category = categories.find(c => c.id === 'cat-sem-diversas');\n    if (category) return category.id;\n  }\n  \n  // Outras categorias\n  const categoryMap: Record<string, string[]> = {\n    'cat-fertilizantes': ['fertilizante', 'fertilizantes', 'fertilizer', 'fertilizers', 'fert', 'adub'],\n    'cat-agroquimicos': ['agroquimico', 'agroquimicos', 'agrochemical', 'herbicida', 'fungicida', 'inseticida', 'defensivo'],\n    'cat-especialidades': ['especialidade', 'especialidades', 'specialty', 'specialties', 'especial'],\n  };\n  \n  for (const [categoryId, keywords] of Object.entries(categoryMap)) {\n    if (keywords.some(keyword => normalized.includes(keyword))) {\n      const category = categories.find(c => c.id === categoryId);\n      if (category) return category.id;\n    }\n  }\n  \n  // Tentar match por nome da categoria\n  const matchedCategory = categories.find(c => \n    c.name.toLowerCase().includes(normalized) || \n    normalized.includes(c.name.toLowerCase())\n  );\n  \n  if (matchedCategory) return matchedCategory.id;\n  \n  return categories[0]?.id || 'cat-fertilizantes';\n}\n\nfunction normalizeTier(tablaPrecio?: string): string {\n  if (!tablaPrecio) return 'abaixo_lista';\n  \n  const normalized = tablaPrecio.toLowerCase().trim();\n  \n  if (normalized.includes('verde') || normalized.includes('green')) return 'verde';\n  if (normalized.includes('amarela') || normalized.includes('amarilla') || normalized.includes('amarillo') || normalized.includes('yellow')) return 'amarela';\n  if (normalized.includes('vermelha') || normalized.includes('roja') || normalized.includes('rojo') || normalized.includes('red')) return 'vermelha';\n  if (normalized.includes('barter')) return 'barter';\n  if (normalized.includes('abaixo') || normalized.includes('lista')) return 'abaixo_lista';\n  \n  return 'abaixo_lista';\n}\n\nfunction extractPackageSize(productName: string): number | null {\n  if (!productName) return null;\n  \n  const patterns = [\n    /(\\d+(?:\\.\\d+)?)\\s*LTS?/i,\n    /(\\d+(?:\\.\\d+)?)\\s*L\\b/i,\n    /(\\d+(?:\\.\\d+)?)\\s*LITROS?/i,\n    /(\\d+(?:\\.\\d+)?)\\s*KGS?/i,\n    /(\\d+(?:\\.\\d+)?)\\s*KILOS?/i,\n    /(\\d+(?:\\.\\d+)?)\\s*GRS?/i,\n    /(\\d+(?:\\.\\d+)?)\\s*GRAMOS?/i,\n  ];\n  \n  for (const pattern of patterns) {\n    const match = productName.match(pattern);\n    if (match) {\n      const size = parseFloat(match[1]);\n      if (!isNaN(size)) {\n        return size;\n      }\n    }\n  }\n  \n  return null;\n}\n\n\nfunction classifySeasonFromDate(dueDate: Date, seasonParameters: SeasonParameter[]): { seasonName: string; seasonType: string; year: number } {\n  const month = dueDate.getMonth() + 1;\n  const day = dueDate.getDate();\n  const year = dueDate.getFullYear();\n  \n  for (const param of seasonParameters) {\n    if (param.dueDateMonth === month && param.dueDateDay === day) {\n      let seasonName = param.labelPattern;\n      const nextYear = year + 1;\n      \n      seasonName = seasonName\n        .replace('{year}', year.toString().slice(-2))\n        .replace('{next_year}', nextYear.toString().slice(-2))\n        .replace('YYYY', year.toString());\n      \n      return {\n        seasonName,\n        seasonType: param.type,\n        year,\n      };\n    }\n  }\n  \n  return {\n    seasonName: `Safra ${year}`,\n    seasonType: 'soja_verao',\n    year,\n  };\n}\n\nexport async function importExcelFile(fileBuffer: Buffer, selectedSeasonId: string, userId: string): Promise<ImportResult> {\n  const result: ImportResult = {\n    success: false,\n    totalRows: 0,\n    importedSales: 0,\n    skippedDuplicates: 0,\n    createdClients: 0,\n    createdProducts: 0,\n    barterSales: 0,\n    errors: [],\n  };\n\n  try {\n    const workbook = XLSX.read(fileBuffer, { type: 'buffer' });\n    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];\n    const rows: ExcelRow[] = XLSX.utils.sheet_to_json(firstSheet);\n\n    result.totalRows = rows.length;\n    \n    // Gerar ID único para este lote de importação\n    const importBatchId = `batch-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n\n    const categories = await storage.getAllCategories();\n    const regions = await storage.getAllRegions();\n    const seasonParameters = await storage.getAllSeasonParameters();\n    \n    // Pré-carregar todos os orderCodes existentes do usuário para verificação de duplicatas\n    const existingOrderCodes = await storage.getExistingOrderCodes(userId);\n    \n    // Cache para evitar buscas repetidas durante a importação\n    const clientLinkCache = new Map<string, string>();\n    const productCache = new Map<string, string>();\n    const skippedOrderCodes = new Set<string>(); // Rastrear pedidos únicos que foram pulados\n\n    let currentClientName: string | null = null;\n    let currentOrderCode: string | null = null; // Guardar último orderCode para aplicar em linhas seguintes\n\n    for (let i = 0; i < rows.length; i++) {\n      const row = rows[i];\n      \n      try {\n        // Detectar linha com nome do cliente (formato: \"Entidad : NOME_DO_CLIENTE\")\n        if (row.__EMPTY_1 && typeof row.__EMPTY_1 === 'string' && row.__EMPTY_1.includes('Entidad :')) {\n          currentClientName = row.__EMPTY_1.replace('Entidad :', '').trim();\n          currentOrderCode = null; // Resetar orderCode ao mudar de cliente\n          continue;\n        }\n\n        // Pular linhas que não tem produto (linhas de cabeçalho ou vazias)\n        if (!row.Mercadería) {\n          continue;\n        }\n        \n        if (!currentClientName) {\n          continue;\n        }\n\n        // Validar campos obrigatórios - testar diferentes variações do campo de data\n        const rowAny = row as any;\n        const fechaVenc = rowAny['Fecha Venc.'] || rowAny['Fecha Venc'] || rowAny[' Fecha Venc.'] || rowAny['Fecha Venc. '];\n        if (!fechaVenc) {\n          result.errors.push(`Linha ${i + 1}: falta data de vencimento`);\n          continue;\n        }\n\n        // Buscar ou criar client link usando o sistema de master clients\n        let clientLinkId = clientLinkCache.get(currentClientName);\n        if (!clientLinkId) {\n          const defaultRegionId = regions[0]?.id || 'reg-alto-parana';\n          clientLinkId = await getOrCreateClientLink(currentClientName!, defaultRegionId, userId);\n          clientLinkCache.set(currentClientName!, clientLinkId);\n          result.createdClients++;\n        }\n\n        const categoryId = resolveCategoryId(row.Subgrupo, categories);\n        const fabricante = row.Fabricante?.trim() || null;\n        const packageSize = extractPackageSize(row.Mercadería!);\n\n        const productKey = `${row.Mercadería}-${categoryId}`;\n        let productId = productCache.get(productKey);\n        let product: any = null;\n        \n        if (!productId) {\n          const existingProducts = await storage.getAllProducts();\n          const existingProduct = existingProducts.find(p => \n            p.name.toLowerCase() === row.Mercadería!.toLowerCase() && \n            p.categoryId === categoryId\n          );\n\n          if (existingProduct) {\n            productId = existingProduct.id;\n            product = existingProduct;\n            \n            // Atualizar produto existente se houver novos dados\n            const needsUpdate = \n              (fabricante && !existingProduct.marca) ||\n              (packageSize !== null && !existingProduct.packageSize);\n            \n            if (needsUpdate) {\n              const updateData: Partial<InsertProduct> = {};\n              \n              if (fabricante && !existingProduct.marca) {\n                updateData.marca = fabricante;\n              }\n              \n              if (packageSize !== null && !existingProduct.packageSize) {\n                updateData.packageSize = packageSize.toString();\n              }\n              \n              await storage.updateProduct(productId, updateData);\n              // Atualizar cache do produto\n              const updatedProducts = await storage.getAllProducts();\n              product = updatedProducts.find(p => p.id === productId);\n            }\n          } else {\n            const { detectSubcategory } = await import(\"./product-classifier\");\n            const classification = categoryId === 'cat-agroquimicos' \n              ? detectSubcategory(row.Mercadería!)\n              : null;\n            \n            const newProduct: InsertProduct = {\n              name: row.Mercadería!,\n              categoryId,\n              subcategoryId: classification?.subcategoryId || null,\n              description: row.Fabricante || null,\n              marca: fabricante,\n              packageSize: packageSize?.toString() || null,\n            };\n            const created = await storage.createProduct(newProduct);\n            productId = created.id;\n            product = created;\n            result.createdProducts++;\n          }\n          productCache.set(productKey, productId);\n        } else {\n          // Buscar produto do cache\n          const existingProducts = await storage.getAllProducts();\n          product = existingProducts.find(p => p.id === productId);\n        }\n\n        const dueDate = parseExcelDate(fechaVenc);\n        if (!dueDate) {\n          result.errors.push(`Data de vencimento inválida para ${currentClientName} - ${row.Mercadería}`);\n          continue;\n        }\n\n        // Usar safra selecionada pelo usuário ao invés de classificar automaticamente\n        const seasonId = selectedSeasonId;\n\n        const tier = normalizeTier(row['Tabla de Precio']);\n        if (tier === 'barter') {\n          result.barterSales++;\n        }\n\n        const category = categories.find(c => c.id === categoryId);\n        let commissionRate = '0.00';\n        let estimatedMargin = 0;\n        \n        if (category && tier !== 'barter') {\n          switch (tier) {\n            case 'verde':\n              commissionRate = category.greenCommission;\n              // Usar margem mínima da faixa verde (acima do limite verde)\n              estimatedMargin = parseFloat(category.greenMarginMin);\n              break;\n            case 'amarela':\n              commissionRate = category.yellowCommission;\n              // Usar margem média da faixa amarela\n              estimatedMargin = (parseFloat(category.yellowMarginMin) + parseFloat(category.yellowMarginMax)) / 2;\n              break;\n            case 'vermelha':\n              commissionRate = category.redCommission;\n              // Usar margem média da faixa vermelha\n              estimatedMargin = (parseFloat(category.redMarginMin) + parseFloat(category.redMarginMax)) / 2;\n              break;\n            case 'abaixo_lista':\n              commissionRate = category.belowListCommission;\n              // Usar margem média abaixo do limite vermelho mínimo\n              estimatedMargin = parseFloat(category.redMarginMin) / 2;\n              break;\n          }\n        }\n\n        const totalAmountRaw = rowAny[' Vl. Pedido '] || rowAny['Vl. Pedido'] || rowAny['Vl. Pedido '] || rowAny[' Vl. Pedido'];\n        const totalAmount = normalizeNumeric(totalAmountRaw) || 0;\n        const ivaRate = parseFloat(category?.defaultIva || '10');\n        const amountBeforeIva = totalAmount / (1 + ivaRate / 100);\n        const commissionAmount = (amountBeforeIva * parseFloat(commissionRate)) / 100;\n\n        const saleDate = parseExcelDate(row['Fecha Emisión']) || new Date();\n\n        // Calcular quantidade real: Cant. Pedido × packageSize\n        const cantPedido = normalizeNumeric(row['Cant. Pedido']) || 0;\n        const productPackageSize = product?.packageSize ? parseFloat(product.packageSize) : 1;\n        const quantity = cantPedido * productPackageSize;\n\n        // Calcular pontos Timac (apenas para produtos Timac da categoria Especialidades)\n        // Pontos = Cant. Pedido (unidades) × pontos por unidade\n        let saleTimacPoints: number | null = null;\n        \n        // Verificar se é produto Timac E categoria Especialidades\n        // Normalizar marca para comparação (remover todos os espaços e acentos)\n        const normalizedMarca = product?.marca\n          ?.toUpperCase()\n          .normalize('NFD')\n          .replace(/[\\u0300-\\u036f]/g, '') // Remove acentos\n          .replace(/\\s+/g, '') // Remove todos os espaços\n          || '';\n        \n        // Aceita \"TIMAC\", \"TIMACAGRO\", etc (começa com TIMAC)\n        const isTimac = normalizedMarca.startsWith('TIMAC');\n        const isEspecialidades = categoryId === 'cat-especialidades';\n        \n        if (isTimac && isEspecialidades) {\n          // FERTIACTYL LEGUMINOSAS = 3 pontos, outros produtos Timac = 1 ponto\n          const pointsPerUnit = product.name.toUpperCase().includes('FERTIACTYL LEGUMINOSAS') ? 3 : 1;\n          saleTimacPoints = cantPedido * pointsPerUnit;\n        }\n\n        // Extrair Num. Pedido da linha atual, ou usar o último orderCode válido\n        // (pedidos com múltiplos produtos têm orderCode apenas na primeira linha)\n        if (row['Num. Pedido']) {\n          currentOrderCode = row['Num. Pedido'].toString().trim();\n        }\n        \n        const orderCode = currentOrderCode;\n\n        // Verificar se pedido já existe (evitar duplicatas)\n        // Usar Set pré-carregado para evitar buscas repetidas no banco\n        if (orderCode && existingOrderCodes.has(orderCode)) {\n          // Pedido já foi importado anteriormente\n          skippedOrderCodes.add(orderCode);\n          continue;\n        }\n\n        const newSale: InsertSale = {\n          categoryId,\n          clientId: clientLinkId!,\n          productId,\n          seasonId: seasonId,\n          userId: userId,\n          saleDate,\n          dueDate,\n          totalAmount: totalAmount.toString(),\n          quantity: quantity > 0 ? quantity.toString() : null,\n          margin: estimatedMargin.toString(),\n          ivaRate: ivaRate.toString(),\n          commissionRate,\n          commissionAmount: commissionAmount.toString(),\n          commissionTier: tier,\n          timacPoints: saleTimacPoints !== null ? saleTimacPoints.toString() : null,\n          isManual: false,\n          importBatchId,\n          orderCode: orderCode,\n        };\n\n        await storage.createSale(newSale);\n        result.importedSales++;\n\n      } catch (error) {\n        result.errors.push(`Erro ao processar linha: ${error instanceof Error ? error.message : 'Erro desconhecido'}`);\n      }\n    }\n\n    // Atualizar contador de duplicatas com o total de pedidos únicos pulados\n    result.skippedDuplicates = skippedOrderCodes.size;\n    result.success = result.importedSales > 0;\n    return result;\n\n  } catch (error) {\n    result.errors.push(`Erro ao ler arquivo Excel: ${error instanceof Error ? error.message : 'Erro desconhecido'}`);\n    return result;\n  }\n}\n\nexport async function importClientsFromExcel(buffer: Buffer, userId: string): Promise<ClientImportResult> {\n  const result: ClientImportResult = {\n    success: false,\n    created: 0,\n    updated: 0,\n    errors: [],\n  };\n\n  try {\n    const workbook = XLSX.read(buffer, { type: 'buffer' });\n    const sheetName = workbook.SheetNames[0];\n    const worksheet = workbook.Sheets[sheetName];\n    const data = XLSX.utils.sheet_to_json<any>(worksheet, { header: 1 });\n\n    if (data.length < 2) {\n      result.errors.push('Arquivo Excel vazio ou sem dados');\n      return result;\n    }\n\n    // Buscar todas as regiões para criar novas se necessário\n    const regions = await storage.getAllRegions();\n    const regionMap = new Map(regions.map((r: any) => [r.name.toLowerCase(), r.id]));\n\n    // Começar da linha 1 (primeira linha é o cabeçalho)\n    for (let i = 1; i < data.length; i++) {\n      const row = data[i];\n      \n      // Coluna A: Cliente (80/20)\n      // Coluna B: Área de plantio em hectares (ha)\n      // Coluna C: região\n      const clientName = row[0]?.toString().trim();\n      const plantingArea = row[1]?.toString().trim();\n      const regionName = row[2]?.toString().trim();\n\n      if (!clientName) {\n        continue; // Pular linhas sem nome de cliente\n      }\n\n      // Determinar se é cliente 80/20 (se o nome contém \"80/20\")\n      const isTop8020 = clientName.toLowerCase().includes('80/20');\n\n      // Buscar ou criar região\n      let regionId = regionMap.get(regionName?.toLowerCase());\n      if (!regionId && regionName) {\n        // Criar nova região\n        const newRegion = await storage.createRegion({\n          name: regionName,\n        });\n        regionId = newRegion.id;\n        regionMap.set(regionName.toLowerCase(), regionId);\n      }\n\n      // Usar sistema de master clients\n      const defaultRegionId = regionId || regions[0]?.id || 'reg-alto-parana';\n      \n      // Buscar ou criar master client e link\n      const masterClient = await storage.findMasterClientByName(clientName);\n      \n      if (masterClient) {\n        // Master client existe - buscar ou criar link\n        let link = await storage.getUserClientLink(userId, masterClient.id);\n        \n        if (link) {\n          // Atualizar link existente\n          await storage.updateUserClientLink(link.id, {\n            plantingArea: plantingArea || link.plantingArea,\n            isTop80_20: isTop8020,\n          });\n          result.updated++;\n        } else {\n          // Criar novo link\n          await storage.createUserClientLink({\n            userId,\n            masterClientId: masterClient.id,\n            customName: null,\n            plantingArea: plantingArea || null,\n            cultures: null,\n            plantingProgress: \"0.00\",\n            isTop80_20: isTop8020,\n            isActive: true\n          });\n          result.created++;\n        }\n        \n        // Atualizar master client se necessário\n        if (plantingArea && !masterClient.plantingArea) {\n          await storage.updateMasterClient(masterClient.id, {\n            plantingArea: plantingArea,\n            regionId: defaultRegionId\n          });\n        }\n      } else {\n        // Criar novo master client + link\n        const newMasterClient = await storage.createMasterClient({\n          name: clientName,\n          regionId: defaultRegionId,\n          plantingArea: plantingArea || null,\n          cultures: [],\n          isActive: true\n        });\n        \n        await storage.createUserClientLink({\n          userId,\n          masterClientId: newMasterClient.id,\n          customName: null,\n          plantingArea: null,\n          cultures: null,\n          plantingProgress: \"0.00\",\n          isTop80_20: isTop8020,\n          isActive: true\n        });\n        \n        result.created++;\n      }\n    }\n\n    result.success = result.created > 0 || result.updated > 0;\n    return result;\n\n  } catch (error) {\n    result.errors.push(`Erro ao importar clientes: ${error instanceof Error ? error.message : 'Erro desconhecido'}`);\n    return result;\n  }\n}\n","size_bytes":24148},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","size_bytes":791},"server/parse-barter-products.ts":{"content":"import * as XLSX from 'xlsx';\nimport { pdf as pdfParse } from 'pdf-parse';\n\ninterface ParsedBarterProduct {\n  name: string;\n  category: string;\n  principioAtivo?: string;\n  dosePerHa?: string;\n  fabricante?: string;\n  priceVermelha?: string;\n  priceAmarela?: string;\n  priceVerde?: string;\n  unit: string;\n}\n\n// Normalize text by removing accents and diacritics\nfunction normalizeText(text: string): string {\n  return text\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .toUpperCase();\n}\n\n// Map PDF categories to system categories\nconst categoryMap: Record<string, string> = {\n  'TRATAMENTO DE SEMENTES': 'tratamento_sementes',\n  'DESSECACAO': 'dessecacao',\n  'EINSETICIDAS': 'inseticidas',\n  'INSETICIDAS': 'inseticidas',\n  'FUNGICIDAS': 'fungicidas',\n  'HERBICIDAS': 'herbicidas',\n  'SEMENTES': 'sementes',\n  'FERTILIZANTES': 'fertilizantes',\n  'ESPECIALIDADES': 'especialidades',\n};\n\n// Map active ingredients (P.A.) to categories\n// Note: Order matters - dessecacao checked before herbicidas to prevent misclassification\nconst principioAtivoCategories: Record<string, string[]> = {\n  'tratamento_sementes': [\n    'azospirillum', 'bradirizobium', 'rizobio', 'tricoderma', \n    'bioestimulante', 'rizospirilum', 'rizoliq'\n  ],\n  'dessecacao': [\n    'paraquate', 'diquate', 'glufosinato', 'carfentrazona'\n  ],\n  'inseticidas': [\n    'fipronil', 'clorantraniliproli', 'imidacloprid', 'thiodicarb',\n    'lambda-cialotrina', 'cipermetrina', 'deltametrina', 'abamectina',\n    'clorpirifos', 'tiametoxam', 'clotianidina', 'bifentrina'\n  ],\n  'fungicidas': [\n    'fludioxinil', 'metalaxil', 'ipconazole', 'penflufen', 'protioconazol',\n    'azoxistrobina', 'tebuconazol', 'trifloxistrobina', 'carbendazim',\n    'mancozeb', 'epoxiconazol', 'picoxistrobina', 'fluxapiroxade'\n  ],\n  'herbicidas': [\n    '2,4d', '2,4-d', 'glifosato', 'clomazone', 'diclosulan', 'flumioxazin',\n    'fomesafen', 's-metalacloro', 'cletodim', 'haloxifope', 'imazetapir',\n    'atrazina', 'nicosulfuron', 'mesotriona'\n  ],\n  'fertilizantes': [\n    'nitrogênio', 'nitrogenio', 'fosforo', 'fósforo', 'potássio', 'potassio',\n    'npk', 'ureia', 'map', 'dap', 'kcl', 'sulfato'\n  ]\n};\n\nfunction detectCategoryHeader(line: string): string | null {\n  const normalized = normalizeText(line.trim());\n  // Only match if the entire line equals a category (header detection)\n  for (const [key, value] of Object.entries(categoryMap)) {\n    if (normalized === key) {\n      return value;\n    }\n  }\n  return null;\n}\n\nfunction detectCategoryFromColumn(text: string): string | null {\n  const normalized = normalizeText(text.trim());\n  // Match category keywords anywhere in text (column detection)\n  for (const [key, value] of Object.entries(categoryMap)) {\n    if (normalized.includes(key)) {\n      return value;\n    }\n  }\n  return null;\n}\n\nexport function detectCategoryFromPA(principioAtivo: string): string | null {\n  if (!principioAtivo) return null;\n  \n  const paLower = principioAtivo.toLowerCase();\n  \n  for (const [category, keywords] of Object.entries(principioAtivoCategories)) {\n    for (const keyword of keywords) {\n      if (paLower.includes(keyword)) {\n        return category;\n      }\n    }\n  }\n  \n  return null;\n}\n\nfunction parseProductLine(line: string, currentCategory: string): ParsedBarterProduct | null {\n  const tokens = line.trim().split(/\\s+/);\n  \n  if (tokens.length < 7) return null;\n\n  // Skip header rows\n  const firstToken = tokens[0]?.toUpperCase();\n  if (firstToken === 'MERCADERÍA' || firstToken === 'MERCADERIA' || firstToken === 'PRODUTO' || \n      firstToken === 'P.A.' || firstToken === 'DOSE' || firstToken === 'FABRICANTE' ||\n      firstToken === 'VERMELHA' || firstToken === 'AMARELA' || firstToken === 'VERDE') {\n    return null;\n  }\n\n  // Extract prices (last 3 tokens)\n  const priceVerde = tokens[tokens.length - 1]?.replace(',', '.');\n  const priceAmarela = tokens[tokens.length - 2]?.replace(',', '.');\n  const priceVermelha = tokens[tokens.length - 3]?.replace(',', '.');\n\n  // Validate at least one price is numeric (some products may have missing prices)\n  const hasValidPrice = !isNaN(parseFloat(priceVerde)) || !isNaN(parseFloat(priceAmarela)) || !isNaN(parseFloat(priceVermelha));\n  if (!hasValidPrice) return null;\n\n  // Extract fabricante (4th from end)\n  const fabricante = tokens[tokens.length - 4];\n\n  // Find dose (token containing ml/, Lt/, Kg/, /Ha)\n  let doseIndex = -1;\n  for (let i = 0; i < tokens.length - 4; i++) {\n    if (tokens[i].includes('ml/') || tokens[i].includes('Lt/') || tokens[i].includes('Kg/') || tokens[i].includes('/Ha')) {\n      doseIndex = i;\n      break;\n    }\n  }\n  \n  if (doseIndex === -1) return null;\n\n  // Check if dose is part of a range (e.g., \"1 - 2Lt/Ha\")\n  let doseStartIndex = doseIndex;\n  if (doseIndex >= 2 && tokens[doseIndex - 1] === '-' && !isNaN(parseFloat(tokens[doseIndex - 2]))) {\n    doseStartIndex = doseIndex - 2;\n  }\n\n  const dosePerHa = tokens.slice(doseStartIndex, doseIndex + 1).join(' ');\n\n  // Find category in tokens before dose (look backwards from dose)\n  let categoryFromColumn: string | null = null;\n  let categoryStartIndex = -1;\n  let categoryEndIndex = -1;\n  \n  // Try 3-word, 2-word, then 1-word category matches\n  for (let windowSize = 3; windowSize >= 1; windowSize--) {\n    for (let i = Math.max(0, doseStartIndex - windowSize); i < doseStartIndex; i++) {\n      const tokenSequence = tokens.slice(i, i + windowSize).join(' ');\n      const detectedCat = detectCategoryFromColumn(tokenSequence);\n      if (detectedCat) {\n        categoryFromColumn = detectedCat;\n        categoryStartIndex = i;\n        categoryEndIndex = i + windowSize - 1;\n        break;\n      }\n    }\n    if (categoryFromColumn) break;\n  }\n\n  // Find name boundary: volume indicator (L, LT, LTS, KG, ML)\n  let nameEndIndex = -1;\n  for (let i = 0; i < tokens.length; i++) {\n    const t = tokens[i].toUpperCase();\n    // Check if token IS a volume or ENDS with volume\n    if (t === 'L' || t === 'LT' || t === 'LTS' || t === 'KG' || t === 'ML' || \n        t.endsWith('LT') || t.endsWith('LTS') || t.endsWith('KG') || t.endsWith('ML') ||\n        t.endsWith('L') && t.length <= 3) {\n      nameEndIndex = i;\n      break;\n    }\n  }\n\n  if (nameEndIndex === -1) return null;\n\n  // Name = from start to volume indicator (inclusive)\n  const name = tokens.slice(0, nameEndIndex + 1).join(' ');\n  \n  if (!name || name.length < 3) return null;\n\n  // P.A. = from name end to category start (or dose start if no category)\n  const paEndIndex = categoryStartIndex !== -1 ? categoryStartIndex - 1 : doseStartIndex - 1;\n  const principioAtivo = tokens.slice(nameEndIndex + 1, paEndIndex + 1).join(' ');\n\n  // Determine category: column > P.A. detection > currentCategory\n  let category = currentCategory;\n  \n  if (categoryFromColumn) {\n    category = categoryFromColumn;\n  } else if (category === 'outros' || !category) {\n    const detectedCategory = detectCategoryFromPA(principioAtivo);\n    if (detectedCategory) {\n      category = detectedCategory;\n    }\n  }\n\n  // Detect unit\n  let unit = 'lt';\n  if (name.includes('LTS') || name.includes('LT')) unit = 'lt';\n  else if (name.includes('KG') || name.includes('Kg')) unit = 'kg';\n  else if (dosePerHa?.includes('Kg')) unit = 'kg';\n  else if (dosePerHa?.includes('Lt')) unit = 'lt';\n\n  return {\n    name,\n    category,\n    principioAtivo: principioAtivo || undefined,\n    dosePerHa,\n    fabricante,\n    priceVermelha: priceVermelha && !isNaN(parseFloat(priceVermelha)) ? priceVermelha : undefined,\n    priceAmarela: priceAmarela && !isNaN(parseFloat(priceAmarela)) ? priceAmarela : undefined,\n    priceVerde: priceVerde && !isNaN(parseFloat(priceVerde)) ? priceVerde : undefined,\n    unit,\n  };\n}\n\nexport async function parsePdfBarterProducts(buffer: Buffer): Promise<ParsedBarterProduct[]> {\n  const data = await pdfParse(new Uint8Array(buffer));\n  const lines = data.text.split('\\n');\n  \n  const products: ParsedBarterProduct[] = [];\n  let currentCategory = 'outros';\n\n  for (const line of lines) {\n    const trimmed = line.trim();\n    if (!trimmed) continue;\n\n    // Check if this line is a category header (entire line = category)\n    const detectedCategory = detectCategoryHeader(trimmed);\n    if (detectedCategory) {\n      currentCategory = detectedCategory;\n      continue;\n    }\n\n    // Try to parse as product line\n    const product = parseProductLine(trimmed, currentCategory);\n    if (product) {\n      products.push(product);\n    }\n  }\n\n  return products;\n}\n\nexport async function parseExcelBarterProducts(buffer: Buffer): Promise<ParsedBarterProduct[]> {\n  const workbook = XLSX.read(buffer, { type: 'buffer' });\n  const sheetName = workbook.SheetNames[0];\n  const sheet = workbook.Sheets[sheetName];\n  \n  // Convert to JSON\n  const rows: any[] = XLSX.utils.sheet_to_json(sheet, { header: 1 });\n  \n  const products: ParsedBarterProduct[] = [];\n  let currentCategory = 'outros';\n  let headerRow = -1;\n  let hasCategoryColumn = false;\n\n  for (let i = 0; i < rows.length; i++) {\n    const row = rows[i];\n    if (!row || row.length === 0) continue;\n\n    const firstCell = String(row[0] || '').trim();\n    \n    // Check if this is a category header (entire cell = category)\n    const detectedCategory = detectCategoryHeader(firstCell);\n    if (detectedCategory) {\n      currentCategory = detectedCategory;\n      continue;\n    }\n\n    // Check if this is the header row\n    if (firstCell.toLowerCase().includes('mercader') || firstCell.toLowerCase().includes('produto')) {\n      headerRow = i;\n      // Check if there's a category column (usually between P.A. and Dose)\n      const headerCells = row.map((cell: any) => String(cell || '').trim().toUpperCase());\n      hasCategoryColumn = headerCells.some((cell: string) => \n        cell === 'CATEGORIA' || cell === 'CATEGORY' || \n        cell === 'TRATAMENTO DE SEMENTES' || cell === 'DESSECAÇÃO' || \n        cell === 'INSETICIDAS' || cell === 'FUNGICIDAS' || \n        cell === 'HERBICIDAS' || cell === 'ESPECIALIDADES'\n      );\n      continue;\n    }\n\n    // Skip if we haven't found headers yet\n    if (headerRow === -1) continue;\n\n    // Parse product row - adjust indices based on whether category column exists\n    let name, principioAtivo, categoryCell, dosePerHa, fabricante, priceVermelha, priceAmarela, priceVerde;\n    \n    if (hasCategoryColumn) {\n      // Format: Name | P.A. | Category | Dose | Fabricante | Vermelha | Amarela | Verde\n      name = String(row[0] || '').trim();\n      principioAtivo = String(row[1] || '').trim();\n      categoryCell = String(row[2] || '').trim();\n      dosePerHa = String(row[3] || '').trim();\n      fabricante = String(row[4] || '').trim();\n      priceVermelha = String(row[5] || '').replace(',', '.');\n      priceAmarela = String(row[6] || '').replace(',', '.');\n      priceVerde = String(row[7] || '').replace(',', '.');\n    } else {\n      // Format: Name | P.A. | Dose | Fabricante | Vermelha | Amarela | Verde\n      name = String(row[0] || '').trim();\n      principioAtivo = String(row[1] || '').trim();\n      dosePerHa = String(row[2] || '').trim();\n      fabricante = String(row[3] || '').trim();\n      priceVermelha = String(row[4] || '').replace(',', '.');\n      priceAmarela = String(row[5] || '').replace(',', '.');\n      priceVerde = String(row[6] || '').replace(',', '.');\n    }\n\n    if (!name || name.length < 3) continue;\n\n    // Determine category: use category column > P.A. detection > fallback to currentCategory\n    let category = currentCategory;\n    \n    if (hasCategoryColumn && categoryCell) {\n      const detectedFromColumn = detectCategoryFromColumn(categoryCell);\n      if (detectedFromColumn) {\n        category = detectedFromColumn;\n      }\n    }\n    \n    if (category === 'outros' || !category) {\n      const detectedCategory = detectCategoryFromPA(principioAtivo);\n      if (detectedCategory) {\n        category = detectedCategory;\n      }\n    }\n\n    // Detect unit\n    let unit = 'lt';\n    if (name.includes('LTS') || name.includes('LT')) unit = 'lt';\n    else if (name.includes('KG') || name.includes('Kg')) unit = 'kg';\n    else if (dosePerHa?.includes('Kg')) unit = 'kg';\n    else if (dosePerHa?.includes('Lt')) unit = 'lt';\n\n    products.push({\n      name,\n      category,\n      principioAtivo: principioAtivo || undefined,\n      dosePerHa: dosePerHa || undefined,\n      fabricante: fabricante || undefined,\n      priceVermelha: priceVermelha || undefined,\n      priceAmarela: priceAmarela || undefined,\n      priceVerde: priceVerde || undefined,\n      unit,\n    });\n  }\n\n  return products;\n}\n","size_bytes":12519},"client/src/components/dashboard/opportunity-alerts.tsx":{"content":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\n\nexport default function OpportunityAlerts() {\n  return (\n    <Card className=\"shadow-sm\" data-testid=\"opportunity-alerts\">\n      <CardHeader className=\"flex items-center justify-between\">\n        <div>\n          <CardTitle className=\"text-lg font-bold\">Alertas de Oportunidade</CardTitle>\n          <p className=\"text-sm text-muted-foreground\">Produtos não vendidos vs safra anterior</p>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"text-center py-8 text-muted-foreground\">\n          Nenhum alerta de oportunidade\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n","size_bytes":686},"client/src/index.css":{"content":"@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap');\n\n@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n:root {\n  --background: hsl(120, 20%, 98%);\n  --foreground: hsl(142, 10%, 15%);\n  --card: hsl(0, 0%, 100%);\n  --card-foreground: hsl(142, 10%, 15%);\n  --popover: hsl(0, 0%, 100%);\n  --popover-foreground: hsl(142, 10%, 15%);\n  --primary: hsl(142, 76%, 36%);\n  --primary-foreground: hsl(0, 0%, 100%);\n  --secondary: hsl(24, 71%, 53%);\n  --secondary-foreground: hsl(0, 0%, 100%);\n  --muted: hsl(120, 20%, 95%);\n  --muted-foreground: hsl(142, 10%, 40%);\n  --accent: hsl(43, 96%, 56%);\n  --accent-foreground: hsl(142, 10%, 15%);\n  --destructive: hsl(0, 84%, 60%);\n  --destructive-foreground: hsl(0, 0%, 100%);\n  --border: hsl(142, 20%, 88%);\n  --input: hsl(142, 20%, 88%);\n  --ring: hsl(142, 76%, 36%);\n  --radius: 0.75rem;\n  --chart-1: hsl(142, 76%, 36%);\n  --chart-2: hsl(24, 71%, 53%);\n  --chart-3: hsl(43, 96%, 56%);\n  --chart-4: hsl(210, 40%, 50%);\n  --chart-5: hsl(280, 65%, 60%);\n  --verde: hsl(142, 71%, 45%);\n  --amarela: hsl(43, 96%, 56%);\n  --vermelha: hsl(0, 84%, 60%);\n  --sidebar: hsl(0, 0%, 100%);\n  --sidebar-foreground: hsl(142, 10%, 15%);\n  --sidebar-primary: hsl(142, 76%, 36%);\n  --sidebar-primary-foreground: hsl(0, 0%, 100%);\n  --sidebar-accent: hsl(120, 20%, 95%);\n  --sidebar-accent-foreground: hsl(142, 10%, 15%);\n  --sidebar-border: hsl(142, 20%, 88%);\n  --sidebar-ring: hsl(142, 76%, 36%);\n  --font-sans: 'Inter', sans-serif;\n  --font-mono: 'JetBrains Mono', monospace;\n}\n\n.dark {\n  --background: hsl(142, 10%, 5%);\n  --foreground: hsl(120, 20%, 95%);\n  --card: hsl(142, 10%, 8%);\n  --card-foreground: hsl(120, 20%, 95%);\n  --popover: hsl(142, 10%, 8%);\n  --popover-foreground: hsl(120, 20%, 95%);\n  --primary: hsl(142, 76%, 36%);\n  --primary-foreground: hsl(0, 0%, 100%);\n  --secondary: hsl(24, 71%, 53%);\n  --secondary-foreground: hsl(0, 0%, 100%);\n  --muted: hsl(142, 10%, 12%);\n  --muted-foreground: hsl(142, 10%, 60%);\n  --accent: hsl(43, 96%, 56%);\n  --accent-foreground: hsl(142, 10%, 5%);\n  --destructive: hsl(0, 84%, 60%);\n  --destructive-foreground: hsl(0, 0%, 100%);\n  --border: hsl(142, 10%, 18%);\n  --input: hsl(142, 10%, 18%);\n  --ring: hsl(142, 76%, 36%);\n  --verde: hsl(142, 71%, 45%);\n  --amarela: hsl(43, 96%, 56%);\n  --vermelha: hsl(0, 84%, 60%);\n  --sidebar: hsl(142, 10%, 8%);\n  --sidebar-foreground: hsl(120, 20%, 95%);\n  --sidebar-primary: hsl(142, 76%, 36%);\n  --sidebar-primary-foreground: hsl(0, 0%, 100%);\n  --sidebar-accent: hsl(142, 10%, 12%);\n  --sidebar-accent-foreground: hsl(120, 20%, 95%);\n  --sidebar-border: hsl(142, 10%, 18%);\n  --sidebar-ring: hsl(142, 76%, 36%);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n  }\n}\n\n.sidebar-collapsed {\n  width: 80px;\n}\n\n.sidebar-collapsed .menu-text {\n  display: none;\n}\n\n.chart-container {\n  position: relative;\n  height: 300px;\n}\n\n.progress-bar-fill {\n  transition: width 0.3s ease-in-out;\n}\n\n.stat-card {\n  transition: transform 0.2s ease, box-shadow 0.2s ease;\n}\n\n.stat-card:hover {\n  transform: translateY(-2px);\n  box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);\n}\n\n.badge-verde {\n  background-color: hsl(var(--verde) / 0.1);\n  color: hsl(var(--verde));\n  border: 1px solid hsl(var(--verde) / 0.2);\n}\n\n.badge-amarela {\n  background-color: hsl(var(--amarela) / 0.1);\n  color: hsl(var(--amarela) / 1.2);\n  border: 1px solid hsl(var(--amarela) / 0.2);\n}\n\n.badge-vermelha {\n  background-color: hsl(var(--vermelha) / 0.1);\n  color: hsl(var(--vermelha));\n  border: 1px solid hsl(var(--vermelha) / 0.2);\n}\n\n.table-header {\n  position: sticky;\n  top: 0;\n  background-color: hsl(var(--muted));\n  z-index: 10;\n}\n\n.modal-backdrop {\n  background-color: rgba(0, 0, 0, 0.5);\n  backdrop-filter: blur(4px);\n}\n\n@keyframes slideIn {\n  from {\n    transform: translateX(-100%);\n  }\n  to {\n    transform: translateX(0);\n  }\n}\n\n.slide-in {\n  animation: slideIn 0.3s ease-out;\n}\n","size_bytes":4080},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","size_bytes":1723},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","size_bytes":3021},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","size_bytes":325},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","size_bytes":710},"client/src/pages/comissoes.tsx":{"content":"import Navbar from \"@/components/layout/navbar\";\nimport Header from \"@/components/layout/header\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Edit, Save, X, Percent, TrendingUp, BarChart, Upload, FileSpreadsheet, Trash2 } from \"lucide-react\";\nimport { BarChart as RechartsBarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';\nimport type { Category } from \"@shared/schema\";\n\nexport default function Comissoes() {\n  const [editingCategory, setEditingCategory] = useState<string | null>(null);\n  const [editValues, setEditValues] = useState<any>({});\n  const [showImportModal, setShowImportModal] = useState(false);\n  const [uploading, setUploading] = useState(false);\n  const [selectedSeasonId, setSelectedSeasonId] = useState<string>(\"\");\n  const { toast } = useToast();\n\n  const { data: user } = useQuery<{ role: string }>({\n    queryKey: [\"/api/user\"],\n  });\n\n  const isAdmin = user?.role === \"administrador\";\n\n  const { data: categories, isLoading } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const { data: analytics } = useQuery<{\n    totalSales: number;\n    totalCommissions: number;\n    salesByCategory: { categoryId: string; categoryName: string; total: number; commissions: number }[];\n    topClients: { clientId: string; clientName: string; total: number; percentage: number }[];\n  }>({\n    queryKey: [\"/api/analytics/sales\"],\n  });\n\n  const { data: importBatches, isLoading: batchesLoading } = useQuery<Array<{\n    batchId: string;\n    importDate: Date;\n    salesCount: number;\n    totalAmount: number;\n    totalCommissions: number;\n  }>>({\n    queryKey: [\"/api/sales/import-batches\"],\n  });\n\n  const { data: seasons } = useQuery<{ id: string; name: string }[]>({\n    queryKey: [\"/api/seasons\"],\n  });\n\n  const { data: timacPoints } = useQuery<{\n    totalPoints: string;\n    rewardPerPoint: string;\n    totalReward: string;\n    currency: string;\n  }>({\n    queryKey: [\"/api/timac-points\"],\n  });\n\n  const updateCategoryMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: any }) => {\n      return apiRequest(\"PATCH\", `/api/categories/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/categories\"] });\n      toast({\n        title: \"Categoria atualizada\",\n        description: \"As configurações de comissão foram atualizadas com sucesso.\",\n      });\n      setEditingCategory(null);\n      setEditValues({});\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao atualizar a categoria. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteBatchMutation = useMutation({\n    mutationFn: async (batchId: string) => {\n      return apiRequest(\"DELETE\", `/api/sales/import-batches/${batchId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/sales/import-batches\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/sales\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/analytics/sales\"] });\n      toast({\n        title: \"Lote excluído\",\n        description: \"O lote de vendas foi excluído com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao excluir o lote. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const startEditing = (category: Category) => {\n    setEditingCategory(category.id);\n    setEditValues({\n      greenCommission: category.greenCommission,\n      greenMarginMin: category.greenMarginMin,\n      yellowCommission: category.yellowCommission,\n      yellowMarginMin: category.yellowMarginMin,\n      yellowMarginMax: category.yellowMarginMax,\n      redCommission: category.redCommission,\n      redMarginMin: category.redMarginMin,\n      redMarginMax: category.redMarginMax,\n      belowListCommission: category.belowListCommission,\n    });\n  };\n\n  const cancelEditing = () => {\n    setEditingCategory(null);\n    setEditValues({});\n  };\n\n  const saveChanges = () => {\n    if (editingCategory && editValues) {\n      updateCategoryMutation.mutate({\n        id: editingCategory,\n        data: editValues\n      });\n    }\n  };\n\n  const updateEditValue = (field: string, value: string) => {\n    setEditValues((prev: any) => ({\n      ...prev,\n      [field]: value\n    }));\n  };\n\n  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    if (!selectedSeasonId) {\n      toast({\n        title: \"Safra não selecionada\",\n        description: \"Por favor, selecione uma safra antes de fazer o upload.\",\n        variant: \"destructive\",\n      });\n      event.target.value = '';\n      return;\n    }\n\n    if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {\n      toast({\n        title: \"Arquivo inválido\",\n        description: \"Por favor, selecione um arquivo Excel (.xlsx ou .xls)\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setUploading(true);\n\n    try {\n      const formData = new FormData();\n      formData.append('file', file);\n      formData.append('seasonId', selectedSeasonId);\n\n      const response = await fetch('/api/sales/import-excel', {\n        method: 'POST',\n        body: formData,\n      });\n\n      const result = await response.json();\n\n      if (result.success) {\n        const duplicateMsg = result.skippedDuplicates > 0 \n          ? ` ${result.skippedDuplicates} pedido(s) duplicado(s) ignorado(s).` \n          : '';\n        \n        toast({\n          title: \"Importação concluída!\",\n          description: `${result.importedSales} vendas importadas com sucesso. ${result.createdClients} novos clientes, ${result.createdProducts} novos produtos criados.${duplicateMsg}`,\n        });\n        \n        queryClient.invalidateQueries({ queryKey: [\"/api/sales\"] });\n        queryClient.invalidateQueries({ queryKey: [\"/api/clients\"] });\n        queryClient.invalidateQueries({ queryKey: [\"/api/products\"] });\n        queryClient.invalidateQueries({ queryKey: [\"/api/analytics/sales\"] });\n        queryClient.invalidateQueries({ queryKey: [\"/api/sales/import-batches\"] });\n        \n        setShowImportModal(false);\n        setSelectedSeasonId(\"\");\n      } else {\n        toast({\n          title: \"Erro na importação\",\n          description: result.message || \"Verifique o arquivo e tente novamente.\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      toast({\n        title: \"Erro ao importar\",\n        description: \"Erro ao processar o arquivo. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setUploading(false);\n      event.target.value = '';\n    }\n  };\n\n  const getTierBadgeClass = (tier: string) => {\n    switch (tier) {\n      case 'verde': return 'badge-verde';\n      case 'amarela': return 'badge-amarela'; \n      case 'vermelha': return 'badge-vermelha';\n      default: return 'bg-muted text-muted-foreground';\n    }\n  };\n\n  const getCategoryColor = (categoryName: string) => {\n    const normalized = categoryName.toLowerCase();\n    if (normalized.includes('agroquímico') || normalized.includes('agroquimico')) return '#ef4444'; // vermelho\n    if (normalized.includes('fertilizante')) return '#3b82f6'; // azul\n    if (normalized.includes('especialidade')) return '#22c55e'; // verde\n    if (normalized.includes('semente') || normalized.includes('semilla')) return '#eab308'; // amarelo\n    return '#8b5cf6'; // roxo padrão\n  };\n\n  const chartData = analytics?.salesByCategory?.map((item: any) => ({\n    name: item.categoryName,\n    value: item.commissions,\n    fill: getCategoryColor(item.categoryName),\n  })) || [];\n\n  const totalCommissions = analytics?.totalCommissions || 0;\n\n  if (isLoading) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-32 w-32 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"h-screen flex flex-col overflow-hidden\" data-testid=\"comissoes-container\">\n      <Header \n        onNewSale={() => {}}\n        title=\"Gestão de Comissões\"\n        subtitle=\"Configuração e acompanhamento de comissões por categoria\"\n      />\n      <Navbar />\n      \n      <main className=\"flex-1 overflow-y-auto\">\n\n        <div className=\"p-4 md:p-8\">\n          {/* Import Button */}\n          <div className=\"flex justify-end mb-6\">\n            <Button\n              onClick={() => setShowImportModal(true)}\n              className=\"gap-2\"\n              data-testid=\"button-import-excel\"\n            >\n              <FileSpreadsheet className=\"h-4 w-4\" />\n              Importar Excel\n            </Button>\n          </div>\n\n          {/* Summary Cards */}\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-6 md:mb-8\">\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-4 md:p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-verde/10 rounded-lg flex items-center justify-center\">\n                    <Percent className=\"text-verde\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Comissões Totais</p>\n                    <p className=\"text-2xl font-bold font-mono text-verde\">\n                      ${totalCommissions.toLocaleString()}\n                    </p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                    <TrendingUp className=\"text-chart-2\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Categorias Ativas</p>\n                    <p className=\"text-2xl font-bold\">{categories?.length || 0}</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card className=\"shadow-sm\">\n              <CardContent className=\"p-6\">\n                <div className=\"flex items-center gap-4\">\n                  <div className=\"w-12 h-12 bg-accent/10 rounded-lg flex items-center justify-center\">\n                    <BarChart className=\"text-accent\" size={24} />\n                  </div>\n                  <div>\n                    <p className=\"text-sm text-muted-foreground\">Maior Comissão</p>\n                    <p className=\"text-2xl font-bold\">4,00%</p>\n                    <p className=\"text-xs text-muted-foreground\">Especialidades</p>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Commission Chart and Batch Management Side by Side */}\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-6 md:mb-8\">\n            {/* Commission Chart */}\n            <Card className=\"shadow-sm\">\n              <CardHeader>\n                <CardTitle>Comissões por Categoria</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"h-80\">\n                  <ResponsiveContainer width=\"100%\" height=\"100%\">\n                    <RechartsBarChart data={chartData}>\n                      <CartesianGrid strokeDasharray=\"3 3\" />\n                      <XAxis \n                        dataKey=\"name\" \n                        tick={{ fontSize: 12 }}\n                        angle={-45}\n                        textAnchor=\"end\"\n                        height={80}\n                      />\n                      <YAxis tick={{ fontSize: 12 }} />\n                      <Tooltip \n                        formatter={(value: number) => [`$${value.toLocaleString()}`, 'Comissão']}\n                      />\n                      <Bar \n                        dataKey=\"value\" \n                        radius={[4, 4, 0, 0]}\n                      />\n                    </RechartsBarChart>\n                  </ResponsiveContainer>\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Imported Batches Management */}\n            <Card className=\"shadow-sm\">\n              <CardHeader>\n                <CardTitle className=\"flex items-center gap-2\">\n                  <FileSpreadsheet className=\"h-5 w-5\" />\n                  Gerenciamento de Planilhas\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"h-80 overflow-y-auto\">\n                  {batchesLoading ? (\n                    <p className=\"text-muted-foreground text-center py-4\">Carregando...</p>\n                  ) : importBatches && importBatches.length > 0 ? (\n                    <div className=\"space-y-2\">\n                      {importBatches.map((batch) => (\n                        <div\n                          key={batch.batchId}\n                          className=\"flex items-center justify-between p-4 border rounded-lg hover:bg-accent/50 transition-colors\"\n                          data-testid={`batch-${batch.batchId}`}\n                        >\n                          <div className=\"flex-1\">\n                            <div className=\"flex items-center gap-4\">\n                              <div>\n                                <p className=\"font-medium\">\n                                  Importado em {new Date(batch.importDate).toLocaleDateString('pt-BR', {\n                                    day: '2-digit',\n                                    month: '2-digit',\n                                    year: 'numeric',\n                                    hour: '2-digit',\n                                    minute: '2-digit'\n                                  })}\n                                </p>\n                                <p className=\"text-sm text-muted-foreground\">\n                                  {batch.salesCount} vendas • ${batch.totalAmount.toLocaleString()} • \n                                  Comissão: ${batch.totalCommissions.toLocaleString()}\n                                </p>\n                              </div>\n                            </div>\n                          </div>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => {\n                              if (confirm('Tem certeza que deseja excluir este lote de vendas?')) {\n                                deleteBatchMutation.mutate(batch.batchId);\n                              }\n                            }}\n                            data-testid={`button-delete-batch-${batch.batchId}`}\n                            disabled={deleteBatchMutation.isPending}\n                          >\n                            <Trash2 className=\"h-4 w-4 text-destructive\" />\n                          </Button>\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <p className=\"text-muted-foreground text-center py-8\">\n                      Nenhuma planilha importada ainda. Use o botão \"Importar Excel\" acima para fazer upload de vendas.\n                    </p>\n                  )}\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Commission Configuration Table */}\n          <Card className=\"shadow-sm\">\n            <CardHeader className=\"flex flex-row items-center justify-between\">\n              <CardTitle>Configuração de Comissões</CardTitle>\n              <div className=\"flex gap-2\">\n                {isAdmin && editingCategory && (\n                  <>\n                    <Button \n                      onClick={saveChanges} \n                      size=\"sm\"\n                      disabled={updateCategoryMutation.isPending}\n                      data-testid=\"button-save-changes\"\n                    >\n                      <Save className=\"h-4 w-4 mr-2\" />\n                      Salvar\n                    </Button>\n                    <Button \n                      onClick={cancelEditing} \n                      variant=\"outline\" \n                      size=\"sm\"\n                      data-testid=\"button-cancel-edit\"\n                    >\n                      <X className=\"h-4 w-4 mr-2\" />\n                      Cancelar\n                    </Button>\n                  </>\n                )}\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"overflow-x-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Categoria</TableHead>\n                      <TableHead className=\"text-center\">Verde</TableHead>\n                      <TableHead className=\"text-center\">Margem Verde</TableHead>\n                      <TableHead className=\"text-center\">Amarela</TableHead>\n                      <TableHead className=\"text-center\">Margem Amarela</TableHead>\n                      <TableHead className=\"text-center\">Vermelha</TableHead>\n                      <TableHead className=\"text-center\">Margem Vermelha</TableHead>\n                      <TableHead className=\"text-center\">Abaixo Lista</TableHead>\n                      {isAdmin && <TableHead className=\"text-center\">Ações</TableHead>}\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {categories?.map((category) => (\n                      <TableRow key={category.id} data-testid={`commission-row-${category.id}`}>\n                        <TableCell className=\"font-medium\">{category.name}</TableCell>\n                        \n                        {/* Verde Commission */}\n                        <TableCell className=\"text-center\">\n                          {editingCategory === category.id ? (\n                            <input\n                              type=\"number\"\n                              step=\"0.01\"\n                              value={editValues.greenCommission}\n                              onChange={(e) => updateEditValue('greenCommission', e.target.value)}\n                              className=\"w-16 px-2 py-1 text-center border rounded\"\n                            />\n                          ) : (\n                            <Badge className=\"badge-verde font-mono\">\n                              {parseFloat(category.greenCommission).toFixed(2)}%\n                            </Badge>\n                          )}\n                        </TableCell>\n                        \n                        {/* Verde Margin */}\n                        <TableCell className=\"text-center text-xs\">\n                          {editingCategory === category.id ? (\n                            <input\n                              type=\"number\"\n                              step=\"0.01\"\n                              value={editValues.greenMarginMin}\n                              onChange={(e) => updateEditValue('greenMarginMin', e.target.value)}\n                              className=\"w-16 px-2 py-1 text-center border rounded text-xs\"\n                            />\n                          ) : (\n                            `≥${parseFloat(category.greenMarginMin).toFixed(0)}%`\n                          )}\n                        </TableCell>\n                        \n                        {/* Amarela Commission */}\n                        <TableCell className=\"text-center\">\n                          {editingCategory === category.id ? (\n                            <input\n                              type=\"number\"\n                              step=\"0.01\"\n                              value={editValues.yellowCommission}\n                              onChange={(e) => updateEditValue('yellowCommission', e.target.value)}\n                              className=\"w-16 px-2 py-1 text-center border rounded\"\n                            />\n                          ) : (\n                            <Badge className=\"badge-amarela font-mono\">\n                              {parseFloat(category.yellowCommission).toFixed(2)}%\n                            </Badge>\n                          )}\n                        </TableCell>\n                        \n                        {/* Amarela Margin */}\n                        <TableCell className=\"text-center text-xs\">\n                          {editingCategory === category.id ? (\n                            <div className=\"flex gap-1\">\n                              <input\n                                type=\"number\"\n                                step=\"0.01\"\n                                value={editValues.yellowMarginMin}\n                                onChange={(e) => updateEditValue('yellowMarginMin', e.target.value)}\n                                className=\"w-12 px-1 py-1 text-center border rounded text-xs\"\n                              />\n                              <span>-</span>\n                              <input\n                                type=\"number\"\n                                step=\"0.01\"\n                                value={editValues.yellowMarginMax}\n                                onChange={(e) => updateEditValue('yellowMarginMax', e.target.value)}\n                                className=\"w-12 px-1 py-1 text-center border rounded text-xs\"\n                              />\n                            </div>\n                          ) : (\n                            `${parseFloat(category.yellowMarginMin).toFixed(0)}-${parseFloat(category.yellowMarginMax).toFixed(0)}%`\n                          )}\n                        </TableCell>\n                        \n                        {/* Vermelha Commission */}\n                        <TableCell className=\"text-center\">\n                          {editingCategory === category.id ? (\n                            <input\n                              type=\"number\"\n                              step=\"0.01\"\n                              value={editValues.redCommission}\n                              onChange={(e) => updateEditValue('redCommission', e.target.value)}\n                              className=\"w-16 px-2 py-1 text-center border rounded\"\n                            />\n                          ) : (\n                            <Badge className=\"badge-vermelha font-mono\">\n                              {parseFloat(category.redCommission).toFixed(2)}%\n                            </Badge>\n                          )}\n                        </TableCell>\n                        \n                        {/* Vermelha Margin */}\n                        <TableCell className=\"text-center text-xs\">\n                          {editingCategory === category.id ? (\n                            <div className=\"flex gap-1\">\n                              <input\n                                type=\"number\"\n                                step=\"0.01\"\n                                value={editValues.redMarginMin}\n                                onChange={(e) => updateEditValue('redMarginMin', e.target.value)}\n                                className=\"w-12 px-1 py-1 text-center border rounded text-xs\"\n                              />\n                              <span>-</span>\n                              <input\n                                type=\"number\"\n                                step=\"0.01\"\n                                value={editValues.redMarginMax}\n                                onChange={(e) => updateEditValue('redMarginMax', e.target.value)}\n                                className=\"w-12 px-1 py-1 text-center border rounded text-xs\"\n                              />\n                            </div>\n                          ) : (\n                            `${parseFloat(category.redMarginMin).toFixed(0)}-${parseFloat(category.redMarginMax).toFixed(0)}%`\n                          )}\n                        </TableCell>\n                        \n                        {/* Below List Commission */}\n                        <TableCell className=\"text-center\">\n                          {editingCategory === category.id ? (\n                            <input\n                              type=\"number\"\n                              step=\"0.01\"\n                              value={editValues.belowListCommission}\n                              onChange={(e) => updateEditValue('belowListCommission', e.target.value)}\n                              className=\"w-16 px-2 py-1 text-center border rounded\"\n                            />\n                          ) : (\n                            <Badge variant=\"outline\" className=\"font-mono\">\n                              {parseFloat(category.belowListCommission).toFixed(2)}%\n                            </Badge>\n                          )}\n                        </TableCell>\n                        \n                        {/* Actions */}\n                        {isAdmin && (\n                          <TableCell className=\"text-center\">\n                            {editingCategory === category.id ? (\n                              <span className=\"text-sm text-blue-600\">Editando...</span>\n                            ) : (\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => startEditing(category)}\n                                data-testid={`button-edit-${category.id}`}\n                              >\n                                <Edit className=\"h-4 w-4\" />\n                              </Button>\n                            )}\n                          </TableCell>\n                        )}\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </main>\n\n      {/* Import Excel Modal */}\n      <Dialog open={showImportModal} onOpenChange={(open) => {\n        setShowImportModal(open);\n        if (!open) setSelectedSeasonId(\"\");\n      }}>\n        <DialogContent className=\"sm:max-w-md\" data-testid=\"import-excel-modal\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              <FileSpreadsheet className=\"h-5 w-5\" />\n              Importar Planilha Excel\n            </DialogTitle>\n          </DialogHeader>\n          \n          <div className=\"space-y-4 py-4\">\n            <div className=\"text-sm text-muted-foreground\">\n              <p className=\"mb-2\">Selecione um arquivo Excel com as seguintes colunas:</p>\n              <ul className=\"list-disc list-inside space-y-1 text-xs\">\n                <li><strong>Entidad</strong> - Nome do cliente</li>\n                <li><strong>Tabla de Precio</strong> - Verde/Amarela/Vermelha/Abaixo de Lista/Barter</li>\n                <li><strong>Mercadería</strong> - Nome do produto</li>\n                <li><strong>Subgrupo</strong> - Categoria do produto</li>\n                <li><strong>Vl.Unitario Medio</strong> - Preço unitário</li>\n                <li><strong>Cant. Pedido</strong> - Quantidade</li>\n                <li><strong>Vl. Pedido</strong> - Valor total</li>\n                <li><strong>Fecha Venc.</strong> - Data de vencimento</li>\n                <li><strong>Fecha Emisión</strong> - Data da venda</li>\n              </ul>\n            </div>\n\n            <div className=\"space-y-2\">\n              <label htmlFor=\"season-select\" className=\"text-sm font-medium text-foreground\">\n                Safra <span className=\"text-red-500\">*</span>\n              </label>\n              <Select value={selectedSeasonId} onValueChange={setSelectedSeasonId}>\n                <SelectTrigger id=\"season-select\" data-testid=\"select-season\">\n                  <SelectValue placeholder=\"Selecione a safra...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {seasons?.map((season) => (\n                    <SelectItem key={season.id} value={season.id}>\n                      {season.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              <p className=\"text-xs text-muted-foreground\">\n                Todas as vendas importadas serão atribuídas à safra selecionada.\n              </p>\n            </div>\n\n            <div className=\"border-2 border-dashed border-border rounded-lg p-8 text-center hover:border-primary transition-colors\">\n              <input\n                type=\"file\"\n                accept=\".xlsx,.xls\"\n                onChange={handleFileUpload}\n                disabled={uploading}\n                className=\"hidden\"\n                id=\"excel-upload\"\n                data-testid=\"input-excel-file\"\n              />\n              <label\n                htmlFor=\"excel-upload\"\n                className=\"cursor-pointer flex flex-col items-center gap-3\"\n              >\n                {uploading ? (\n                  <>\n                    <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary\"></div>\n                    <p className=\"text-sm text-muted-foreground\">Processando arquivo...</p>\n                  </>\n                ) : (\n                  <>\n                    <Upload className=\"h-12 w-12 text-muted-foreground\" />\n                    <div>\n                      <p className=\"text-sm font-medium\">Clique para selecionar arquivo Excel</p>\n                      <p className=\"text-xs text-muted-foreground mt-1\">Formatos aceitos: .xlsx, .xls</p>\n                    </div>\n                  </>\n                )}\n              </label>\n            </div>\n\n            <div className=\"text-xs text-amber-600 bg-amber-50 p-3 rounded-lg\">\n              <strong>Nota:</strong> Vendas marcadas como \"Barter\" serão importadas sem comissão calculada. Você precisará editar manualmente após a importação.\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":30870},"replit.md":{"content":"# Sales Commission Management System\n\n## Overview\nThis full-stack agricultural sales commission management system, designed for the Paraguayan agricultural market, streamlines sales tracking, commission calculation, and seasonal goal management. Key features include PDF invoice imports, margin-based commission calculations, crop-type seasonal classification, comprehensive sales analytics, and a BARTER module for product-grain exchange simulations. It aims to enhance sales management efficiency and commission processes for agricultural businesses. The system also includes a robust CRM with mobile capabilities for managing client visits, field data, and trip tracking.\n\n## User Preferences\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### UI/UX\nThe frontend uses React 18, TypeScript, and Vite. UI components are built with shadcn/ui on Radix UI, styled with Tailwind CSS, featuring an agricultural green primary color scheme. Data visualization uses Recharts.\n\n### Technical Implementations\n\n#### Frontend\n- **Framework**: React 18 with TypeScript.\n- **Routing**: Wouter.\n- **State Management**: TanStack Query for server state, React hooks for local UI state.\n- **Forms**: React Hook Form with Zod for validation.\n- **Mobile**:\n    - **PWA**: Offline-first with IndexedDB (Dexie.js) and service worker caching.\n    - **Native Mobile App**: Android (Expo + React Native) with SQLite for offline data, background geofencing, GPS tracking, and route optimization.\n\n#### Backend\n- **Framework**: Express.js.\n- **Database**: PostgreSQL (Neon) with Drizzle ORM.\n- **Session Management**: `connect-pg-simple`.\n- **CRM Module**: PostGIS-enabled database schema for geospatial data (farms, fields, visits, trips).\n- **NLP Service**: Fuse.js for fuzzy matching in agenda parsing.\n- **State Machine**: Enforces workflow rules for visit status transitions.\n\n### Feature Specifications\n\n#### Core System\n- **User Roles**: Administrador, gerente, consultor, faturista for access control.\n- **Entities**: Users, Categories, Products, Master Clients, User Client Links, Seasons, Sales, Season Parameters, Season Goals.\n- **Commission Calculation**: Five-tier system (green, yellow, red, below list, barter) with configurable rates and IVA. Manual commission entry for barter sales.\n- **Season Classification**: Rule-based system assigning sales to seasons based on due dates.\n- **Administrative Panel**: Super admin interface for user, client, product, category, commission, and system parameter management, including bulk import and merging.\n- **File Processing**: PDF import for C.VALE invoices (sales data extraction, category detection, season assignment). Excel import with duplicate order detection.\n- **BARTER Module**: Simulation system for product-grain exchange, including `barter_products`, `barter_settings`, and `barter_simulations`.\n\n#### Manager Dashboard & Action Plans\n- **Role-based Management**: `managerId` links consultors to managers.\n- **Manager Dashboard**: Aggregated team sales, Timac points, team count, top categories/clients. Individual consultor performance.\n- **Action Plans**: Meeting-based goal tracking and task management with CRUD operations.\n\n#### Kanban de Metas (Sales Targets)\n- **Visual Drag & Drop**: Kanban-style board with client opportunity cards (Oportunidades → Realizado → Capturado).\n- **Subcategory Support**: Agroquímicos segment supports 4 subcategories (TS, Dessecação, Inseticidas, Fungicidas) with JSONB storage.\n- **Edit Functionality**: Clicking captured client names opens pre-filled modal for updating values or deleting targets.\n- **Market Benchmarks**: Integrated market percentage/progress tracker displays benchmark values by category for active season.\n- **Backend**: PATCH `/api/sales-targets/:id` supports subcategories parameter. Database stores subcategories as JSONB.\n- **Application Tracking System** (In Development):\n  - **Products Price Table**: `products_price_table` stores product catalog with verde/amarela/vermelha pricing tiers ($/ha).\n  - **Global Management**: `global_management_applications` stores consultant's global crop management plan (fungicide/insecticide applications).\n  - **Client Tracking**: `client_application_tracking` tracks application status per client (sold, lost to competitor, open opportunity).\n  - **Super Admin Interface**: New \"Tabela de Preços\" tab for product catalog management (CRUD operations, organized by category).\n  - **API Endpoints**: GET/POST/PATCH/DELETE `/api/admin/price-table` for product management (super admin only).\n\n#### Faturista (Billing) Panel\n- **Inventory Control**: Dedicated panel for billing staff to analyze stock against pending orders.\n- **Workflow**: Create upload session → upload inventory PDF → upload order PDFs → analyze stock availability.\n- **Analysis**: Compares aggregated orders with inventory, calculates availability (DISPONÍVEL, PARCIAL, INDISPONÍVEL).\n\n#### CRM Module\n- **Database**: `farms`, `fields`, `visits`, `trips`, `telemetry_gps`, `checklists`, `automations`, `audit_logs` with PostGIS support. Farms table includes `lat`, `lng`, `address`, `notes`, `created_at` for geofencing.\n- **API**: RESTful endpoints for CRUD operations, spatial queries, trip management, and checklist submissions.\n- **NLP Agenda Parser**: Converts natural language text into structured visit objects.\n- **Geofencing**: Background geofencing for trip detection and location-based automations. **Requires farm coordinates** - visits without farm_id cannot use geofencing.\n- **Farm Management**: `/crm/farms` page for cadastro with required lat/lng coordinates. Syncs to server via POST `/api/farms` with PostGIS POINT format.\n- **Schema Mapping**: Frontend uses snake_case (client_id, farm_id, window_start), Drizzle schema uses camelCase (clientId, farmId, windowStart). Backend converts via `createVisitsBulk` helper with Date object conversion for timestamps.\n- **Automated Attendance System (6-Phase Workflow)**:\n  - **Phase 1 - Fixed Agenda**: Agenda panel at top of Home page with sequential visits (1ª, 2ª, 3ª), status colors, \"Iniciar\" button, visual indicator for next visit (green border/ring).\n  - **Phase 2 - Farm Geofencing**: Monitors distance to farms (200m radius), auto-changes status to NO_LOCAL on arrival, vibration notifications, uses lat/lng from farm cadastro, monitors only next visit in sequence.\n  - **Phase 3 - Auto Sequencing**: Leaving base (100m) auto-starts first PLANEJADA visit, visits ordered by time, route start notifications, tracking monitors next in queue.\n  - **Phase 4 - Attendance Screen**: Route `/crm/atendimento/:visitId`, pre-filled data (client, farm, service), photo upload (camera/gallery), description per photo, saves photos in IndexedDB (photos array field), auto-redirects when status becomes NO_LOCAL.\n  - **Phase 5 - Gallery Feed**: Instagram-style horizontal scroll photos, multiple photo indicators, description below each photo, displays only CONCLUIDA visits.\n  - **Phase 6 - UX Refinements**: Visual next-visit indicator, enhanced notifications, consistent status colors.\n- **Tracking Implementation**: \n  - Uses `activeFarmLatRef` and `activeFarmLngRef` to store active farm coordinates independently from visit status.\n  - Exit detection (400m = 2x geofence radius) resets all tracking refs (`inFarmRef`, `activeVisitIdRef`, `activeFarmLatRef`, `activeFarmLngRef`) to enable monitoring next visit.\n  - Ensures continuous multi-visit sequencing even after visits change to CONCLUIDA status.\n- **Odometer (Quilometragem) Tracking**:\n  - **Automatic Start**: When leaving base (100m trigger), displays odometer dialog to capture vehicle mileage before starting first visit.\n  - **Manual Start**: \"Iniciar\" button in agenda also requests odometer reading before trip begins.\n  - **Trip Completion**: Attendance screen requests final odometer reading when completing visit.\n  - **Backend Integration**: `trips` table stores `start_odometer` and `end_odometer` fields. Backend `endTrip` method accepts both `trip_id` and `visit_id` for flexible lookups.\n  - **Status Preservation**: Backend uses CASE expression to preserve CONCLUIDA status when ending trip, preventing status downgrades during sync.\n  - **Duplicate Prevention**: Manual trip start sets `tripStartedRef` to prevent automatic base-exit trigger from firing again.\n  - **Sync Flow**: Enqueues VISIT_CREATE (status) + TRIP_START (odometer) on start, VISIT_CREATE (status+photos) + TRIP_END (visit_id+odometer) on completion.\n\n### System Design Choices\n- **Monorepo Structure**: Shared schema and type sharing via a `/shared` directory.\n- **Path Aliases**: For cleaner imports.\n- **Authentication**: Session-based with complete cache clearing and session destruction on logout.\n- **Security**: HTTP Cache-Control headers (`no-store, no-cache, must-revalidate, private`) and React Query stale/garbage collection times for data security.\n- **Role-based Routing**: Custom route components (`AdminRoute`, `ManagerRoute`, `FaturistaRoute`, `ConsultorRoute`) enforce access control and redirect users post-login.\n- **Performance Optimizations** (November 2025):\n  - **Batch Query Pattern**: Eliminated N+1 query problems in critical endpoints by implementing batch fetching with `inArray()`.\n  - **Analytics Endpoint**: `/api/analytics/sales` reduced from 20s to <1s by batch-fetching only needed categories and client links instead of individual queries per sale.\n  - **Kanban Endpoint**: `/api/kanban-metas` optimized from 3-5s to <1s by batch-fetching all sales and targets for all clients in single queries using PostgreSQL `ANY()` operator.\n  - **Family Relations**: Created batch endpoint `/api/clients/family/batch` to fetch relations for multiple clients in one query, preventing 30+ sequential API calls.\n  - **Query Optimization**: Uses `inArray()` with empty array guards to fetch only required rows, with proper joins for `userClientLinks` and `masterClients` name resolution.\n\n## External Dependencies\n\n-   **Database**: PostgreSQL via `@neondatabase/serverless`\n-   **ORM/Schema**: Drizzle ORM, Drizzle Kit, `drizzle-zod`\n-   **UI Components**: Radix UI, shadcn/ui, Recharts, `date-fns`, `cmdk`\n-   **Styling**: Tailwind CSS, `class-variance-authority`, `clsx`, `tailwind-merge`\n-   **Form & Validation**: Zod, React Hook Form, `@hookform/resolvers`\n-   **Session Management**: `connect-pg-simple`, Express sessions\n-   **Development Tools**: TypeScript, Vite, ESBuild, PostCSS, Autoprefixer\n-   **Mobile (PWA)**: Dexie.js (IndexedDB), React-Leaflet\n-   **Mobile (Native)**: Expo, `expo-sqlite`, `expo-location`, `expo-task-manager`, `react-native-maps`","size_bytes":10665},"server/parse-cvale-pdf.ts":{"content":"import { createRequire } from \"module\";\n\ninterface ParsedProduct {\n  productCode: string;\n  productName: string;\n  packageType: string;\n  quantity: number;\n  unitPrice: number;\n  totalPrice: number;\n  purchaseDate: Date;\n  orderCode: string;\n}\n\nexport function detectCategoryFromProductName(productName: string): string | null {\n  const name = productName.toUpperCase();\n  \n  const categoryKeywords: Record<string, string[]> = {\n    'cat-fertilizantes': ['FERT', 'FERTILIZANTE', 'UREIA', 'NPK', 'SULFATO', 'MAP', 'DAP', 'NITRATO', 'FOSFATO'],\n    'cat-agroquimicos': ['HERBICIDA', 'FUNGICIDA', 'INSETICIDA', 'AGROQUIMICO', 'GLIFOSATO', 'ATRAZINA', 'PARAQUAT', 'CLORANTRANILIPROLE', 'IPCONAZOLE', 'METALAXIL', 'DERMACOR', 'RANCONA', 'NEMATICIDA', 'GLUFOSINATO', 'TODYM', 'CLOMAZONE', 'FIPRONIL', 'METOXIFENOZIDA', 'MANCOZEB', 'DIFENO', 'TEBUCO', 'PROTHIO', 'TRIFLOX', 'FLUMIOXAZIM'],\n    'cat-sementes': ['SEMENTE', 'SEED', 'SEMILLA', 'HIBRIDO', 'CULTIVAR', 'VARIEDADE']\n  };\n  \n  for (const [categoryId, keywords] of Object.entries(categoryKeywords)) {\n    for (const keyword of keywords) {\n      if (name.includes(keyword)) {\n        return categoryId;\n      }\n    }\n  }\n  \n  return null;\n}\n\ninterface ParsedPurchaseHistory {\n  clientName: string;\n  seasonName: string;\n  totalAmount: number;\n  items: ParsedProduct[];\n}\n\nconst require = createRequire(import.meta.url);\nlet pdfParser: any = null;\n\nfunction getPdfParser() {\n  if (!pdfParser) {\n    pdfParser = require(\"pdf-parse\");\n  }\n  return pdfParser;\n}\n\nexport async function parseCVALEPDF(buffer: Buffer): Promise<ParsedPurchaseHistory> {\n  const pdf = getPdfParser();\n  const data = await pdf(buffer);\n  const text = data.text;\n  \n  const lines = text.split('\\n').map((l: string) => l.trim()).filter((l: string) => l.length > 0);\n  \n  let clientName = '';\n  let seasonName = '';\n  const items: ParsedProduct[] = [];\n  let totalAmount = 0;\n  \n  let currentOrderCode = '';\n  let currentEmissionDate: Date | null = null;\n  \n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i];\n    \n    if (!clientName && line.includes('Entidad') && line.includes('-')) {\n      const match = line.match(/Entidad\\s*:?\\s*(\\d+)\\s*-\\s*([^:]+)/);\n      if (match) {\n        clientName = match[2].trim();\n      }\n    }\n    \n    if (!seasonName && line.includes('Plan de Financiación') && line.includes('ZAFRA')) {\n      const match = line.match(/Plan de Financiación\\s*:?\\s*(\\d+)\\s*-\\s*(ZAFRA[^-]+)-\\s*([^:]+)/);\n      if (match) {\n        seasonName = `${match[2].trim()} ${match[3].trim()}`;\n      }\n    }\n    \n    const orderMatch = line.match(/^(\\d{6})\\s+.*?(\\d{2}\\/\\d{2}\\/\\d{2})\\s+(\\d{2}\\/\\d{2}\\/\\d{2})/);\n    if (orderMatch) {\n      currentOrderCode = orderMatch[1];\n      const emissionDateStr = orderMatch[2];\n      const parts = emissionDateStr.split('/');\n      const day = parseInt(parts[0]);\n      const month = parseInt(parts[1]) - 1;\n      let year = parseInt(parts[2]);\n      year = year < 50 ? 2000 + year : 1900 + year;\n      currentEmissionDate = new Date(year, month, day);\n    }\n    \n    const productMatch = line.match(/^([A-Z\\s\\d]+)\\((\\d+)\\)\\s+(.+?)\\s+(\\d+[\\d,\\.]*)\\s+(\\d+[\\d,\\.]+)\\s+(\\d+[\\d,\\.]*)\\s+/);\n    if (productMatch && currentEmissionDate && currentOrderCode) {\n      const packageType = productMatch[1].trim();\n      const productCode = productMatch[2];\n      const productName = productMatch[3].trim();\n      const unitPrice = parseFloat(productMatch[4].replace(/\\./g, '').replace(',', '.'));\n      const totalPrice = parseFloat(productMatch[5].replace(/\\./g, '').replace(',', '.'));\n      const quantity = parseFloat(productMatch[6].replace(/\\./g, '').replace(',', '.'));\n      \n      items.push({\n        productCode,\n        productName,\n        packageType,\n        quantity,\n        unitPrice,\n        totalPrice,\n        purchaseDate: currentEmissionDate,\n        orderCode: currentOrderCode\n      });\n    }\n    \n    if (line.includes('TOTAL ÍTENS FACTURADOS') || line.includes('TOTAL ÍTEMS FACTURADOS')) {\n      const match = line.match(/=\\s+([\\d,.]+)/);\n      if (match) {\n        totalAmount = parseFloat(match[1].replace(/\\./g, '').replace(',', '.'));\n      }\n    }\n  }\n  \n  return {\n    clientName,\n    seasonName,\n    totalAmount,\n    items\n  };\n}\n","size_bytes":4246},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","size_bytes":1419},"client/src/pages/admin.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from \"@/components/ui/alert-dialog\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Users, Package, FolderTree, Percent, Settings as SettingsIcon, Menu, Bell, Plus, Upload, Edit, Save, X, Trash2, Repeat, ChevronDown, ChevronRight, RefreshCw, Calendar, Sprout, Target, TrendingUp, Loader2 } from \"lucide-react\";\nimport { Switch } from \"@/components/ui/switch\";\nimport AdminNavbar from \"@/components/layout/admin-navbar\";\nimport Header from \"@/components/layout/header\";\nimport type { Category, User, Subcategory, Product, MasterClient, Region, BarterProduct, BarterSettings, InsertBarterProduct, Season, InsertSeason } from \"@shared/schema\";\nimport { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts';\nimport { format } from \"date-fns\";\nimport { Progress } from \"@/components/ui/progress\";\n\nexport default function AdminPage() {\n  const [activeTab, setActiveTab] = useState(\"users\");\n\n  // Read hash from URL to determine active tab\n  useEffect(() => {\n    const hash = window.location.hash.replace('#', '');\n    if (hash && ['dashboard', 'users', 'master-clients', 'seasons', 'categories', 'subcategories', 'products', 'price-table', 'commissions', 'parameters', 'barter', 'timac', 'system'].includes(hash)) {\n      setActiveTab(hash);\n    } else {\n      setActiveTab('dashboard');\n    }\n\n    const handleHashChange = () => {\n      const newHash = window.location.hash.replace('#', '');\n      if (newHash && ['dashboard', 'users', 'master-clients', 'seasons', 'categories', 'subcategories', 'products', 'price-table', 'commissions', 'parameters', 'barter', 'timac', 'system'].includes(newHash)) {\n        setActiveTab(newHash);\n      } else {\n        setActiveTab('dashboard');\n      }\n    };\n\n    window.addEventListener('hashchange', handleHashChange);\n    return () => window.removeEventListener('hashchange', handleHashChange);\n  }, []);\n\n  return (\n    <div className=\"flex flex-col h-screen overflow-hidden\">\n      <Header />\n      <AdminNavbar activeTab={activeTab} onTabChange={setActiveTab} />\n\n      <main className=\"flex-1 overflow-auto p-6\">\n        {activeTab === 'dashboard' && <DashboardManagement />}\n        {activeTab === 'users' && <UsersManagement />}\n        {activeTab === 'master-clients' && <MasterClientsManagement />}\n        {activeTab === 'seasons' && <SeasonsManagement />}\n        {activeTab === 'categories' && <CategoriesManagement />}\n        {activeTab === 'subcategories' && <SubcategoriesManagement />}\n        {activeTab === 'products' && <ProductsManagement />}\n        {activeTab === 'price-table' && <PriceTableManagement />}\n        {activeTab === 'commissions' && <CommissionsManagement />}\n        {activeTab === 'parameters' && <ParametersManagement />}\n        {activeTab === 'barter' && <BarterManagement />}\n        {activeTab === 'timac' && <TimacManagement />}\n        {activeTab === 'system' && <SystemManagement />}\n      </main>\n    </div>\n  );\n}\n\nfunction DashboardManagement() {\n  const { data: regionalData, isLoading } = useQuery<any[]>({\n    queryKey: ['/api/admin/regional-sales'],\n  });\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  // Filter regions with sales only\n  const regionsWithSales = regionalData?.filter(region => region.totalSales > 0) || [];\n\n  if (!regionsWithSales || regionsWithSales.length === 0) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle>Dashboard Administrativo</CardTitle>\n          <CardDescription>Análise Regional de Vendas</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <p className=\"text-muted-foreground\">Nenhum dado de vendas disponível.</p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  // Calculate totals\n  const totalSales = regionsWithSales.reduce((sum, region) => sum + region.totalSales, 0);\n  const totalVolume = regionsWithSales.reduce((sum, region) => sum + region.totalVolume, 0);\n  const totalSalesCount = regionsWithSales.reduce((sum, region) => sum + region.salesCount, 0);\n\n  // Find top region by sales\n  const topRegion = regionsWithSales.reduce((max, region) => \n    region.totalSales > max.totalSales ? region : max, regionsWithSales[0]);\n\n  // Prepare data for charts\n  const chartData = regionsWithSales.map(region => ({\n    name: region.regionName,\n    vendas: region.totalSales,\n    volume: region.totalVolume,\n  }));\n\n  // Colors for pie chart\n  const COLORS = ['#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316'];\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h2 className=\"text-2xl font-bold\">Dashboard Administrativo</h2>\n        <p className=\"text-muted-foreground\">Análise Regional de Vendas e Performance</p>\n      </div>\n\n      {/* Summary Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total de Vendas</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              ${totalSales.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">Todas as regiões</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Volume Total</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              {totalVolume.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">Unidades vendidas</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Total de Transações</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{totalSalesCount}</div>\n            <p className=\"text-xs text-muted-foreground mt-1\">Vendas realizadas</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground\">Região Líder</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{topRegion.regionName}</div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              ${topRegion.totalSales.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n            </p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Regional Details Table */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Top 5 Produtos por Região</CardTitle>\n          <CardDescription>Produtos mais vendidos em cada região</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-6\">\n            {regionsWithSales.map((region) => (\n              <div key={region.regionId} className=\"border-b pb-4 last:border-b-0\">\n                <h3 className=\"font-semibold text-lg mb-3\">{region.regionName}</h3>\n                <div className=\"grid grid-cols-1 gap-2\">\n                  {region.topProducts.length > 0 ? (\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead>Produto</TableHead>\n                          <TableHead>Marca</TableHead>\n                          <TableHead className=\"text-right\">Volume</TableHead>\n                          <TableHead className=\"text-right\">Vendas</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {region.topProducts.slice(0, 5).map((product: any, idx: number) => (\n                          <TableRow key={idx}>\n                            <TableCell className=\"font-medium\">{product.productName}</TableCell>\n                            <TableCell>\n                              <Badge variant=\"outline\">{product.brand}</Badge>\n                            </TableCell>\n                            <TableCell className=\"text-right\">\n                              {product.volume.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}\n                            </TableCell>\n                            <TableCell className=\"text-right font-semibold\">\n                              ${product.sales.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                            </TableCell>\n                          </TableRow>\n                        ))}\n                      </TableBody>\n                    </Table>\n                  ) : (\n                    <p className=\"text-sm text-muted-foreground\">Nenhum produto vendido nesta região.</p>\n                  )}\n                </div>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nfunction UsersManagement() {\n  const [editingUser, setEditingUser] = useState<any>(null);\n  const [deletingUser, setDeletingUser] = useState<any>(null);\n  const [userDataCheck, setUserDataCheck] = useState<any>(null);\n  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);\n  const [editName, setEditName] = useState(\"\");\n  const [editRole, setEditRole] = useState(\"\");\n  const [editManagerId, setEditManagerId] = useState<string>(\"\");\n  const { toast } = useToast();\n\n  const { data: users, isLoading } = useQuery<User[]>({\n    queryKey: ['/api/admin/users'],\n  });\n\n  // Get only managers for the dropdown\n  const managers = users?.filter(u => u.role === 'gerente') || [];\n\n  const updateUserMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: any }) => {\n      return apiRequest(\"PATCH\", `/api/admin/users/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/users'] });\n      toast({\n        title: \"Usuário atualizado\",\n        description: \"As informações do usuário foram atualizadas com sucesso.\",\n      });\n      setEditingUser(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao atualizar o usuário. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const checkUserDataMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"GET\", `/api/admin/users/${id}/data-check`);\n    },\n    onSuccess: (data: any) => {\n      setUserDataCheck(data);\n      setShowDeleteConfirm(true);\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao verificar dados do usuário. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteUserMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/admin/users/${id}?confirmed=true`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/users'] });\n      toast({\n        title: \"Usuário excluído\",\n        description: \"O usuário e todos os seus dados foram excluídos com sucesso.\",\n      });\n      setDeletingUser(null);\n      setShowDeleteConfirm(false);\n      setUserDataCheck(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao excluir o usuário. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const startEdit = (user: any) => {\n    setEditingUser(user);\n    setEditName(user.name);\n    setEditRole(user.role);\n    setEditManagerId(user.managerId || \"none\");\n  };\n\n  const handleUpdate = () => {\n    if (editingUser) {\n      updateUserMutation.mutate({\n        id: editingUser.id,\n        data: { \n          name: editName, \n          role: editRole,\n          managerId: editRole === 'consultor' ? (editManagerId === 'none' ? null : editManagerId) : null\n        }\n      });\n    }\n  };\n\n  const startDelete = (user: any) => {\n    setDeletingUser(user);\n    checkUserDataMutation.mutate(user.id);\n  };\n\n  const confirmDelete = () => {\n    if (deletingUser) {\n      deleteUserMutation.mutate(deletingUser.id);\n    }\n  };\n\n  const cancelDelete = () => {\n    setDeletingUser(null);\n    setShowDeleteConfirm(false);\n    setUserDataCheck(null);\n  };\n\n  if (isLoading) {\n    return <div className=\"text-center py-8\">Carregando usuários...</div>;\n  }\n\n  return (\n    <>\n      <Card>\n        <CardHeader>\n          <CardTitle>Gestão de Usuários</CardTitle>\n          <CardDescription>Gerencie os usuários do sistema</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-4\">\n            {users && users.length > 0 ? (\n              <div className=\"border rounded-lg divide-y\">\n                {users.map((user: any) => (\n                  <div key={user.id} className=\"p-4 flex items-center justify-between hover:bg-accent/50 transition-colors\">\n                    <div>\n                      <p className=\"font-medium\">{user.name}</p>\n                      <p className=\"text-sm text-muted-foreground\">@{user.username}</p>\n                    </div>\n                    <div className=\"flex items-center gap-3\">\n                      <span className={`px-3 py-1 rounded-full text-xs font-medium ${\n                        user.role === 'administrador' \n                          ? 'bg-blue-100 text-blue-800 dark:bg-blue-950 dark:text-blue-200' \n                          : user.role === 'gerente'\n                          ? 'bg-green-100 text-green-800 dark:bg-green-950 dark:text-green-200'\n                          : user.role === 'faturista'\n                          ? 'bg-orange-100 text-orange-800 dark:bg-orange-950 dark:text-orange-200'\n                          : 'bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200'\n                      }`}>\n                        {user.role === 'administrador' ? 'Administrador' : user.role === 'gerente' ? 'Gerente' : user.role === 'faturista' ? 'Faturista' : 'Consultor'}\n                      </span>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => startEdit(user)}\n                        data-testid={`button-edit-user-${user.id}`}\n                      >\n                        <Edit className=\"h-4 w-4\" />\n                      </Button>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"icon\"\n                        onClick={() => startDelete(user)}\n                        data-testid={`button-delete-user-${user.id}`}\n                      >\n                        <Trash2 className=\"h-4 w-4 text-destructive\" />\n                      </Button>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            ) : (\n              <p className=\"text-muted-foreground text-center py-8\">Nenhum usuário encontrado</p>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      <Dialog open={!!editingUser} onOpenChange={(open) => !open && setEditingUser(null)}>\n        <DialogContent data-testid=\"dialog-edit-user\">\n          <DialogHeader>\n            <DialogTitle>Editar Usuário</DialogTitle>\n            <DialogDescription>\n              Altere as informações do usuário abaixo.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-name\">Nome</Label>\n              <Input\n                id=\"edit-name\"\n                value={editName}\n                onChange={(e) => setEditName(e.target.value)}\n                data-testid=\"input-edit-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-role\">Função</Label>\n              <Select value={editRole} onValueChange={setEditRole}>\n                <SelectTrigger data-testid=\"select-edit-role\">\n                  <SelectValue placeholder=\"Selecione a função\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"consultor\">Consultor</SelectItem>\n                  <SelectItem value=\"gerente\">Gerente</SelectItem>\n                  <SelectItem value=\"administrador\">Administrador</SelectItem>\n                  <SelectItem value=\"faturista\">Faturista</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n            \n            {editRole === 'consultor' && (\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"edit-manager\">Gerente Responsável</Label>\n                <Select value={editManagerId} onValueChange={setEditManagerId}>\n                  <SelectTrigger data-testid=\"select-edit-manager\">\n                    <SelectValue placeholder=\"Selecione o gerente (opcional)\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"none\">Nenhum</SelectItem>\n                    {managers.map(manager => (\n                      <SelectItem key={manager.id} value={manager.id}>\n                        {manager.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            )}\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setEditingUser(null)}\n              data-testid=\"button-cancel-edit-user\"\n            >\n              Cancelar\n            </Button>\n            <Button\n              onClick={handleUpdate}\n              disabled={updateUserMutation.isPending}\n              data-testid=\"button-save-user\"\n            >\n              {updateUserMutation.isPending ? \"Salvando...\" : \"Salvar\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <AlertDialog open={showDeleteConfirm} onOpenChange={cancelDelete}>\n        <AlertDialogContent data-testid=\"dialog-delete-user-confirm\">\n          <AlertDialogHeader>\n            <AlertDialogTitle>⚠️ Atenção: Este usuário possui dados no sistema</AlertDialogTitle>\n            <AlertDialogDescription className=\"space-y-3\">\n              <p>\n                O usuário <strong>{deletingUser?.name}</strong> possui os seguintes dados vinculados:\n              </p>\n              \n              {userDataCheck?.hasData && (\n                <div className=\"bg-muted p-4 rounded-lg space-y-1 text-sm\">\n                  {userDataCheck.data.clients > 0 && (\n                    <p>• <strong>{userDataCheck.data.clients}</strong> cliente(s)</p>\n                  )}\n                  {userDataCheck.data.sales > 0 && (\n                    <p>• <strong>{userDataCheck.data.sales}</strong> venda(s)</p>\n                  )}\n                  {userDataCheck.data.goals > 0 && (\n                    <p>• <strong>{userDataCheck.data.goals}</strong> meta(s) de safra</p>\n                  )}\n                  {userDataCheck.data.marketRates > 0 && (\n                    <p>• <strong>{userDataCheck.data.marketRates}</strong> configuração(ões) de mercado</p>\n                  )}\n                  {userDataCheck.data.externalPurchases > 0 && (\n                    <p>• <strong>{userDataCheck.data.externalPurchases}</strong> compra(s) externa(s)</p>\n                  )}\n                  {userDataCheck.data.purchaseHistory > 0 && (\n                    <p>• <strong>{userDataCheck.data.purchaseHistory}</strong> histórico(s) de compra</p>\n                  )}\n                  {userDataCheck.data.marketBenchmarks > 0 && (\n                    <p>• <strong>{userDataCheck.data.marketBenchmarks}</strong> benchmark(s) de mercado</p>\n                  )}\n                </div>\n              )}\n              \n              <p className=\"font-semibold text-destructive\">\n                Ao confirmar, TODOS estes dados serão PERMANENTEMENTE excluídos.\n                Esta ação não pode ser desfeita.\n              </p>\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel onClick={cancelDelete} data-testid=\"button-cancel-delete-user\">\n              Cancelar\n            </AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmDelete}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              disabled={deleteUserMutation.isPending}\n              data-testid=\"button-confirm-delete-user\"\n            >\n              {deleteUserMutation.isPending ? \"Excluindo...\" : \"Confirmar Exclusão\"}\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n    </>\n  );\n}\n\nfunction CategoriesManagement() {\n  const { data: categories, isLoading } = useQuery<Category[]>({\n    queryKey: ['/api/categories'],\n  });\n\n  if (isLoading) {\n    return <div className=\"text-center py-8\">Carregando categorias...</div>;\n  }\n\n  return (\n    <Card>\n      <CardHeader className=\"flex flex-row items-center justify-between\">\n        <div>\n          <CardTitle>Gestão de Categorias</CardTitle>\n          <CardDescription>Gerencie as categorias de produtos</CardDescription>\n        </div>\n        <Button size=\"sm\" className=\"gap-2\">\n          <Plus size={16} />\n          Nova Categoria\n        </Button>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-4\">\n          {categories && categories.length > 0 ? (\n            <div className=\"border rounded-lg divide-y\">\n              {categories.map((category: any) => (\n                <div key={category.id} className=\"p-4 flex items-center justify-between hover:bg-accent/50 transition-colors\">\n                  <div>\n                    <p className=\"font-medium\">{category.name}</p>\n                    <p className=\"text-sm text-muted-foreground\">{category.type}</p>\n                  </div>\n                  <div className=\"flex gap-2\">\n                    <Button variant=\"ghost\" size=\"icon\">\n                      <Edit className=\"h-4 w-4\" />\n                    </Button>\n                    <Button variant=\"ghost\" size=\"icon\">\n                      <Trash2 className=\"h-4 w-4 text-destructive\" />\n                    </Button>\n                  </div>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <p className=\"text-muted-foreground text-center py-8\">Nenhuma categoria encontrada</p>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction SubcategoriesManagement() {\n  const { data: subcategories, isLoading } = useQuery<Subcategory[]>({\n    queryKey: ['/api/subcategories'],\n  });\n\n  if (isLoading) {\n    return <div className=\"text-center py-8\">Carregando subcategorias...</div>;\n  }\n\n  return (\n    <Card>\n      <CardHeader className=\"flex flex-row items-center justify-between\">\n        <div>\n          <CardTitle>Gestão de Subcategorias</CardTitle>\n          <CardDescription>Gerencie as subcategorias de produtos</CardDescription>\n        </div>\n        <Button size=\"sm\" className=\"gap-2\">\n          <Plus size={16} />\n          Nova Subcategoria\n        </Button>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-4\">\n          {subcategories && subcategories.length > 0 ? (\n            <div className=\"border rounded-lg divide-y\">\n              {subcategories.map((sub: any) => (\n                <div key={sub.id} className=\"p-4 flex items-center justify-between hover:bg-accent/50 transition-colors\">\n                  <p className=\"font-medium\">{sub.name}</p>\n                  <div className=\"flex gap-2\">\n                    <Button variant=\"ghost\" size=\"icon\">\n                      <Edit className=\"h-4 w-4\" />\n                    </Button>\n                    <Button variant=\"ghost\" size=\"icon\">\n                      <Trash2 className=\"h-4 w-4 text-destructive\" />\n                    </Button>\n                  </div>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <p className=\"text-muted-foreground text-center py-8\">Nenhuma subcategoria encontrada</p>\n          )}\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction ProductsManagement() {\n  const { toast } = useToast();\n  const [searchTerm, setSearchTerm] = useState('');\n  const [categoryFilter, setCategoryFilter] = useState<string | undefined>(undefined);\n  const [brandFilter, setBrandFilter] = useState<string | undefined>(undefined);\n  const [editingProduct, setEditingProduct] = useState<any>(null);\n  \n  const { data: products, isLoading } = useQuery<Product[]>({\n    queryKey: ['/api/products'],\n  });\n\n  const { data: categories } = useQuery<Category[]>({\n    queryKey: ['/api/categories'],\n  });\n\n  const { data: subcategories } = useQuery<Subcategory[]>({\n    queryKey: ['/api/subcategories'],\n  });\n\n  const autoClassifyMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/admin/products/auto-classify\", {});\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/products'] });\n      toast({\n        title: \"Classificação automática concluída\",\n        description: `${data.classified} de ${data.totalProducts} produtos foram classificados automaticamente.`,\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao classificar produtos. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateProductMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: any }) => {\n      return apiRequest(\"PATCH\", `/api/admin/products/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/products'] });\n      toast({\n        title: \"Produto atualizado\",\n        description: \"Produto atualizado com sucesso.\",\n      });\n      setEditingProduct(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao atualizar produto. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const syncCategoriesMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"POST\", \"/api/admin/sales/sync-categories\", {});\n    },\n    onSuccess: (data: any) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/sales'] });\n      toast({\n        title: \"Sincronização concluída\",\n        description: data.message || `${data.updated} vendas atualizadas`,\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao sincronizar categorias. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleAutoClassify = () => {\n    if (confirm(\"Deseja classificar automaticamente todos os produtos agroquímicos sem subcategoria?\")) {\n      autoClassifyMutation.mutate();\n    }\n  };\n\n  if (isLoading) {\n    return <div className=\"text-center py-8\">Carregando produtos...</div>;\n  }\n\n  // Filtrar produtos\n  const filteredProducts = products?.filter((product: any) => {\n    const matchesSearch = product.name.toLowerCase().includes(searchTerm.toLowerCase());\n    const matchesCategory = !categoryFilter || product.categoryId === categoryFilter;\n    const matchesBrand = !brandFilter || product.marca === brandFilter;\n    return matchesSearch && matchesCategory && matchesBrand;\n  }) || [];\n\n  // Obter marcas únicas\n  const uniqueBrands = Array.from(new Set(products?.map((p: any) => p.marca).filter(Boolean))) as string[];\n\n  const agroquimicosWithoutSubcategory = products?.filter(\n    (p: any) => p.categoryId === 'cat-agroquimicos' && !p.subcategoryId\n  ).length || 0;\n\n  return (\n    <Card>\n      <CardHeader className=\"flex flex-row items-center justify-between\">\n        <div>\n          <CardTitle>Gestão de Produtos</CardTitle>\n          <CardDescription>\n            Gerencie os produtos do sistema\n            {agroquimicosWithoutSubcategory > 0 && (\n              <span className=\"ml-2 text-amber-600 dark:text-amber-400\">\n                • {agroquimicosWithoutSubcategory} agroquímicos sem subcategoria\n              </span>\n            )}\n          </CardDescription>\n        </div>\n        <div className=\"flex gap-2\">\n          {agroquimicosWithoutSubcategory > 0 && (\n            <Button \n              size=\"sm\" \n              variant=\"secondary\" \n              className=\"gap-2\"\n              onClick={handleAutoClassify}\n              disabled={autoClassifyMutation.isPending}\n              data-testid=\"button-auto-classify\"\n            >\n              <Package size={16} />\n              {autoClassifyMutation.isPending ? \"Classificando...\" : \"Classificar Automaticamente\"}\n            </Button>\n          )}\n          <Button \n            size=\"sm\" \n            variant=\"outline\" \n            className=\"gap-2\"\n            onClick={() => {\n              if (confirm(\"Deseja sincronizar as categorias das vendas com os produtos atuais? Isso atualizará todas as vendas para refletir a categoria atual de cada produto.\")) {\n                syncCategoriesMutation.mutate();\n              }\n            }}\n            disabled={syncCategoriesMutation.isPending}\n            data-testid=\"button-sync-categories\"\n          >\n            <RefreshCw size={16} />\n            {syncCategoriesMutation.isPending ? \"Sincronizando...\" : \"Sincronizar Categorias\"}\n          </Button>\n          <Button size=\"sm\" variant=\"outline\" className=\"gap-2\">\n            <Upload size={16} />\n            Importar\n          </Button>\n          <Button size=\"sm\" className=\"gap-2\">\n            <Plus size={16} />\n            Novo Produto\n          </Button>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"space-y-4\">\n          {/* Filtros */}\n          <div className=\"flex gap-3 items-end\">\n            <div className=\"flex-1\">\n              <Label>Buscar produto</Label>\n              <Input\n                placeholder=\"Digite o nome do produto...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                data-testid=\"input-search-products\"\n              />\n            </div>\n            <div className=\"w-48\">\n              <Label>Categoria</Label>\n              <Select value={categoryFilter || ''} onValueChange={(value) => setCategoryFilter(value || undefined)}>\n                <SelectTrigger data-testid=\"select-filter-category\">\n                  <SelectValue placeholder=\"Todas\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {categories?.map((cat) => (\n                    <SelectItem key={cat.id} value={cat.id}>\n                      {cat.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"w-48\">\n              <Label>Marca</Label>\n              <Select value={brandFilter || ''} onValueChange={(value) => setBrandFilter(value || undefined)}>\n                <SelectTrigger data-testid=\"select-filter-brand\">\n                  <SelectValue placeholder=\"Todas\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {uniqueBrands.map((brand) => (\n                    <SelectItem key={brand} value={brand}>\n                      {brand}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            {(searchTerm || categoryFilter || brandFilter) && (\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setSearchTerm('');\n                  setCategoryFilter(undefined);\n                  setBrandFilter(undefined);\n                }}\n                data-testid=\"button-clear-filters\"\n              >\n                Limpar\n              </Button>\n            )}\n          </div>\n\n          {/* Lista de produtos */}\n          {products && products.length > 0 ? (\n            <>\n              <div className=\"text-sm text-muted-foreground mb-2\">\n                Exibindo {filteredProducts.length} de {products.length} produtos\n              </div>\n              <div className=\"border rounded-lg divide-y max-h-[600px] overflow-auto\">\n                {filteredProducts.length > 0 ? (\n                  filteredProducts.map((product: any) => (\n                    <div key={product.id} className=\"p-4 flex items-center justify-between hover:bg-accent/50 transition-colors\">\n                      <div className=\"flex-1\">\n                        <p className=\"font-medium\">{product.name}</p>\n                        <div className=\"flex gap-2 mt-1\">\n                          <p className=\"text-sm text-muted-foreground\">{product.marca || 'Sem marca'}</p>\n                          {product.subcategoryId && (\n                            <Badge variant=\"outline\" className=\"text-xs\">\n                              {product.subcategoryId.replace('sub-', '').replace(/-/g, ' ')}\n                            </Badge>\n                          )}\n                        </div>\n                      </div>\n                      <div className=\"flex gap-2\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => setEditingProduct(product)}\n                          data-testid={`button-edit-product-${product.id}`}\n                        >\n                          <Edit className=\"h-4 w-4\" />\n                        </Button>\n                        <Button variant=\"ghost\" size=\"icon\">\n                          <Trash2 className=\"h-4 w-4 text-destructive\" />\n                        </Button>\n                      </div>\n                    </div>\n                  ))\n                ) : (\n                  <p className=\"text-muted-foreground text-center py-8\">Nenhum produto encontrado com os filtros aplicados</p>\n                )}\n              </div>\n            </>\n          ) : (\n            <p className=\"text-muted-foreground text-center py-8\">Nenhum produto encontrado</p>\n          )}\n        </div>\n      </CardContent>\n\n      {/* Modal de Edição */}\n      {editingProduct && (\n        <Dialog open={!!editingProduct} onOpenChange={() => setEditingProduct(null)}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Editar Produto</DialogTitle>\n              <DialogDescription>\n                Alterar categoria e marca de: {editingProduct.name}\n              </DialogDescription>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label>Categoria</Label>\n                <Select\n                  value={editingProduct.categoryId}\n                  onValueChange={(value) => setEditingProduct({ ...editingProduct, categoryId: value, subcategoryId: null })}\n                >\n                  <SelectTrigger data-testid=\"select-edit-category\">\n                    <SelectValue placeholder=\"Selecione a categoria\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {categories?.map((cat) => (\n                      <SelectItem key={cat.id} value={cat.id}>\n                        {cat.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              {editingProduct.categoryId && (subcategories?.filter(s => s.categoryId === editingProduct.categoryId).length ?? 0) > 0 && (\n                <div className=\"space-y-2\">\n                  <Label>Subcategoria (opcional)</Label>\n                  <Select\n                    value={editingProduct.subcategoryId || undefined}\n                    onValueChange={(value) => setEditingProduct({ ...editingProduct, subcategoryId: value })}\n                  >\n                    <SelectTrigger data-testid=\"select-edit-subcategory\">\n                      <SelectValue placeholder=\"Selecione...\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {subcategories\n                        ?.filter(s => s.categoryId === editingProduct.categoryId)\n                        .map((sub) => (\n                          <SelectItem key={sub.id} value={sub.id}>\n                            {sub.name}\n                          </SelectItem>\n                        ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              )}\n\n              <div className=\"space-y-2\">\n                <Label>Marca</Label>\n                <Input\n                  value={editingProduct.marca || ''}\n                  onChange={(e) => setEditingProduct({ ...editingProduct, marca: e.target.value })}\n                  placeholder=\"Digite a marca\"\n                  data-testid=\"input-edit-brand\"\n                />\n              </div>\n            </div>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setEditingProduct(null)}>\n                Cancelar\n              </Button>\n              <Button\n                onClick={() => updateProductMutation.mutate({\n                  id: editingProduct.id,\n                  data: {\n                    categoryId: editingProduct.categoryId,\n                    subcategoryId: editingProduct.subcategoryId || null,\n                    marca: editingProduct.marca\n                  }\n                })}\n                disabled={updateProductMutation.isPending}\n                data-testid=\"button-save-product\"\n              >\n                {updateProductMutation.isPending ? \"Salvando...\" : \"Salvar\"}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      )}\n    </Card>\n  );\n}\n\nfunction CommissionsManagement() {\n  const [editingCategory, setEditingCategory] = useState<string | null>(null);\n  const [editValues, setEditValues] = useState<any>({});\n  const { toast } = useToast();\n\n  const { data: categories, isLoading } = useQuery<Category[]>({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const updateCategoryMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: any }) => {\n      return apiRequest(\"PATCH\", `/api/categories/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/categories\"] });\n      toast({\n        title: \"Categoria atualizada\",\n        description: \"As configurações de comissão foram atualizadas com sucesso.\",\n      });\n      setEditingCategory(null);\n      setEditValues({});\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao atualizar a categoria. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const startEditing = (category: Category) => {\n    setEditingCategory(category.id);\n    setEditValues({\n      greenCommission: category.greenCommission,\n      greenMarginMin: category.greenMarginMin,\n      yellowCommission: category.yellowCommission,\n      yellowMarginMin: category.yellowMarginMin,\n      yellowMarginMax: category.yellowMarginMax,\n      redCommission: category.redCommission,\n      redMarginMin: category.redMarginMin,\n      redMarginMax: category.redMarginMax,\n      belowListCommission: category.belowListCommission,\n    });\n  };\n\n  const cancelEditing = () => {\n    setEditingCategory(null);\n    setEditValues({});\n  };\n\n  const saveChanges = () => {\n    if (editingCategory && editValues) {\n      updateCategoryMutation.mutate({\n        id: editingCategory,\n        data: editValues\n      });\n    }\n  };\n\n  const updateEditValue = (field: string, value: string) => {\n    setEditValues((prev: any) => ({\n      ...prev,\n      [field]: value\n    }));\n  };\n\n  if (isLoading) {\n    return <div className=\"text-center py-8\">Carregando...</div>;\n  }\n\n  return (\n    <Card>\n      <CardHeader className=\"flex flex-row items-center justify-between\">\n        <div>\n          <CardTitle>Tabela de Comissões</CardTitle>\n          <CardDescription>Gerencie as taxas de comissão por categoria</CardDescription>\n        </div>\n        <div className=\"flex gap-2\">\n          {editingCategory && (\n            <>\n              <Button \n                onClick={saveChanges} \n                size=\"sm\"\n                disabled={updateCategoryMutation.isPending}\n                data-testid=\"button-save-changes\"\n              >\n                <Save className=\"h-4 w-4 mr-2\" />\n                Salvar\n              </Button>\n              <Button \n                onClick={cancelEditing} \n                variant=\"outline\" \n                size=\"sm\"\n                data-testid=\"button-cancel-edit\"\n              >\n                <X className=\"h-4 w-4 mr-2\" />\n                Cancelar\n              </Button>\n            </>\n          )}\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"overflow-x-auto\">\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Categoria</TableHead>\n                <TableHead className=\"text-center\">Verde</TableHead>\n                <TableHead className=\"text-center\">Margem Verde</TableHead>\n                <TableHead className=\"text-center\">Amarela</TableHead>\n                <TableHead className=\"text-center\">Margem Amarela</TableHead>\n                <TableHead className=\"text-center\">Vermelha</TableHead>\n                <TableHead className=\"text-center\">Margem Vermelha</TableHead>\n                <TableHead className=\"text-center\">Abaixo Lista</TableHead>\n                <TableHead className=\"text-center\">Ações</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {categories?.map((category) => (\n                <TableRow key={category.id} data-testid={`commission-row-${category.id}`}>\n                  <TableCell className=\"font-medium\">{category.name}</TableCell>\n                  \n                  <TableCell className=\"text-center\">\n                    {editingCategory === category.id ? (\n                      <input\n                        type=\"number\"\n                        step=\"0.01\"\n                        value={editValues.greenCommission}\n                        onChange={(e) => updateEditValue('greenCommission', e.target.value)}\n                        className=\"w-16 px-2 py-1 text-center border rounded\"\n                      />\n                    ) : (\n                      <Badge className=\"badge-verde font-mono\">\n                        {parseFloat(category.greenCommission).toFixed(2)}%\n                      </Badge>\n                    )}\n                  </TableCell>\n                  \n                  <TableCell className=\"text-center text-xs\">\n                    {editingCategory === category.id ? (\n                      <input\n                        type=\"number\"\n                        step=\"0.01\"\n                        value={editValues.greenMarginMin}\n                        onChange={(e) => updateEditValue('greenMarginMin', e.target.value)}\n                        className=\"w-16 px-2 py-1 text-center border rounded text-xs\"\n                      />\n                    ) : (\n                      `≥${parseFloat(category.greenMarginMin).toFixed(0)}%`\n                    )}\n                  </TableCell>\n                  \n                  <TableCell className=\"text-center\">\n                    {editingCategory === category.id ? (\n                      <input\n                        type=\"number\"\n                        step=\"0.01\"\n                        value={editValues.yellowCommission}\n                        onChange={(e) => updateEditValue('yellowCommission', e.target.value)}\n                        className=\"w-16 px-2 py-1 text-center border rounded\"\n                      />\n                    ) : (\n                      <Badge className=\"badge-amarela font-mono\">\n                        {parseFloat(category.yellowCommission).toFixed(2)}%\n                      </Badge>\n                    )}\n                  </TableCell>\n                  \n                  <TableCell className=\"text-center text-xs\">\n                    {editingCategory === category.id ? (\n                      <div className=\"flex gap-1 justify-center\">\n                        <input\n                          type=\"number\"\n                          step=\"0.01\"\n                          value={editValues.yellowMarginMin}\n                          onChange={(e) => updateEditValue('yellowMarginMin', e.target.value)}\n                          className=\"w-12 px-1 py-1 text-center border rounded text-xs\"\n                        />\n                        <span>-</span>\n                        <input\n                          type=\"number\"\n                          step=\"0.01\"\n                          value={editValues.yellowMarginMax}\n                          onChange={(e) => updateEditValue('yellowMarginMax', e.target.value)}\n                          className=\"w-12 px-1 py-1 text-center border rounded text-xs\"\n                        />\n                      </div>\n                    ) : (\n                      `${parseFloat(category.yellowMarginMin).toFixed(0)}-${parseFloat(category.yellowMarginMax).toFixed(0)}%`\n                    )}\n                  </TableCell>\n                  \n                  <TableCell className=\"text-center\">\n                    {editingCategory === category.id ? (\n                      <input\n                        type=\"number\"\n                        step=\"0.01\"\n                        value={editValues.redCommission}\n                        onChange={(e) => updateEditValue('redCommission', e.target.value)}\n                        className=\"w-16 px-2 py-1 text-center border rounded\"\n                      />\n                    ) : (\n                      <Badge className=\"badge-vermelha font-mono\">\n                        {parseFloat(category.redCommission).toFixed(2)}%\n                      </Badge>\n                    )}\n                  </TableCell>\n                  \n                  <TableCell className=\"text-center text-xs\">\n                    {editingCategory === category.id ? (\n                      <div className=\"flex gap-1 justify-center\">\n                        <input\n                          type=\"number\"\n                          step=\"0.01\"\n                          value={editValues.redMarginMin}\n                          onChange={(e) => updateEditValue('redMarginMin', e.target.value)}\n                          className=\"w-12 px-1 py-1 text-center border rounded text-xs\"\n                        />\n                        <span>-</span>\n                        <input\n                          type=\"number\"\n                          step=\"0.01\"\n                          value={editValues.redMarginMax}\n                          onChange={(e) => updateEditValue('redMarginMax', e.target.value)}\n                          className=\"w-12 px-1 py-1 text-center border rounded text-xs\"\n                        />\n                      </div>\n                    ) : (\n                      `${parseFloat(category.redMarginMin).toFixed(0)}-${parseFloat(category.redMarginMax).toFixed(0)}%`\n                    )}\n                  </TableCell>\n                  \n                  <TableCell className=\"text-center\">\n                    {editingCategory === category.id ? (\n                      <input\n                        type=\"number\"\n                        step=\"0.01\"\n                        value={editValues.belowListCommission}\n                        onChange={(e) => updateEditValue('belowListCommission', e.target.value)}\n                        className=\"w-16 px-2 py-1 text-center border rounded\"\n                      />\n                    ) : (\n                      <Badge className=\"bg-muted text-muted-foreground font-mono\">\n                        {parseFloat(category.belowListCommission).toFixed(2)}%\n                      </Badge>\n                    )}\n                  </TableCell>\n                  \n                  <TableCell className=\"text-center\">\n                    {editingCategory === category.id ? (\n                      <span className=\"text-muted-foreground text-xs\">Editando...</span>\n                    ) : (\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => startEditing(category)}\n                        data-testid={`button-edit-${category.id}`}\n                      >\n                        <Edit className=\"h-4 w-4\" />\n                      </Button>\n                    )}\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction MasterClientsManagement() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [editingClient, setEditingClient] = useState<any>(null);\n  const [mergingClient, setMergingClient] = useState<any>(null);\n  const [mergeTarget, setMergeTarget] = useState<string>(\"\");\n  const [showImportModal, setShowImportModal] = useState(false);\n  const [uploading, setUploading] = useState(false);\n  const [selectedVendedorId, setSelectedVendedorId] = useState<string>(\"\");\n  const [expandedConsultant, setExpandedConsultant] = useState<string | null>(null);\n  const { toast } = useToast();\n\n  const { data: masterClients, isLoading } = useQuery<MasterClient[]>({\n    queryKey: ['/api/admin/master-clients'],\n  });\n\n  const { data: regions } = useQuery<Region[]>({\n    queryKey: ['/api/regions'],\n  });\n\n  const { data: vendedores } = useQuery<User[]>({\n    queryKey: ['/api/admin/vendedores'],\n  });\n\n  const { data: allUserClientLinks, isLoading: loadingLinks, isError: errorLinks } = useQuery<any[]>({\n    queryKey: ['/api/admin/user-client-links'],\n  });\n\n  const updateClientMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: any }) => {\n      return apiRequest(\"PATCH\", `/api/admin/master-clients/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/master-clients'] });\n      toast({\n        title: \"Cliente atualizado\",\n        description: \"As informações do cliente foram atualizadas com sucesso.\",\n      });\n      setEditingClient(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao atualizar o cliente. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const mergeClientsMutation = useMutation({\n    mutationFn: async ({ sourceId, targetId }: { sourceId: string; targetId: string }) => {\n      return apiRequest(\"POST\", `/api/admin/master-clients/${sourceId}/merge/${targetId}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/master-clients'] });\n      toast({\n        title: \"Clientes mesclados\",\n        description: \"Os clientes foram mesclados com sucesso.\",\n      });\n      setMergingClient(null);\n      setMergeTarget(\"\");\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao mesclar clientes. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteAllClientsMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"DELETE\", \"/api/admin/master-clients/delete-all\", {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/master-clients'] });\n      toast({\n        title: \"Todos os clientes excluídos\",\n        description: \"Todos os clientes master e dados relacionados foram removidos do sistema.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao excluir clientes. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteConsultorClientsMutation = useMutation({\n    mutationFn: async (userId: string) => {\n      return apiRequest(\"DELETE\", `/api/admin/user-client-links/user/${userId}`, {});\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/user-client-links'] });\n      toast({\n        title: \"Clientes excluídos\",\n        description: \"Todos os clientes do consultor foram removidos com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao excluir clientes do consultor. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    if (!selectedVendedorId) {\n      toast({\n        title: \"Vendedor não selecionado\",\n        description: \"Por favor, selecione um vendedor antes de importar.\",\n        variant: \"destructive\",\n      });\n      event.target.value = '';\n      return;\n    }\n\n    setUploading(true);\n    \n    const formData = new FormData();\n    formData.append('file', file);\n    formData.append('vendedorId', selectedVendedorId);\n\n    try {\n      const response = await fetch('/api/clients/import', {\n        method: 'POST',\n        body: formData,\n      });\n\n      const result = await response.json();\n\n      if (response.ok) {\n        toast({\n          title: \"Importação concluída\",\n          description: `${result.created} cliente(s) criado(s), ${result.updated} atualizado(s)`,\n        });\n        queryClient.invalidateQueries({ queryKey: ['/api/admin/master-clients'] });\n        queryClient.invalidateQueries({ queryKey: ['/api/admin/user-client-links'] });\n        setShowImportModal(false);\n        setSelectedVendedorId(\"\");\n      } else {\n        toast({\n          title: \"Erro na importação\",\n          description: result.error || \"Erro ao importar arquivo\",\n          variant: \"destructive\",\n        });\n      }\n    } catch (error) {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao fazer upload do arquivo\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setUploading(false);\n      event.target.value = '';\n    }\n  };\n\n  const toggleConsultant = (consultantId: string) => {\n    setExpandedConsultant(expandedConsultant === consultantId ? null : consultantId);\n  };\n\n  if (isLoading || loadingLinks) {\n    return <div className=\"text-center py-8\">Carregando clientes master...</div>;\n  }\n\n  return (\n    <>\n      <Card>\n        <CardHeader className=\"flex flex-row items-center justify-between\">\n          <div>\n            <CardTitle>Gestão de Clientes Master</CardTitle>\n            <CardDescription>\n              Base de dados global de clientes - evita duplicação entre usuários\n            </CardDescription>\n          </div>\n          <div className=\"flex gap-2\">\n            <AlertDialog>\n              <AlertDialogTrigger asChild>\n                <Button variant=\"destructive\" data-testid=\"button-delete-all-clients\">\n                  <Trash2 className=\"h-4 w-4 mr-2\" />\n                  Excluir Todos\n                </Button>\n              </AlertDialogTrigger>\n              <AlertDialogContent data-testid=\"dialog-delete-all-clients\">\n                <AlertDialogHeader>\n                  <AlertDialogTitle>⚠️ ATENÇÃO: Ação Irreversível</AlertDialogTitle>\n                  <AlertDialogDescription className=\"space-y-3\">\n                    <p className=\"font-semibold text-destructive\">\n                      Você está prestes a excluir TODOS os clientes master do sistema.\n                    </p>\n                    <p>\n                      Esta ação irá:\n                    </p>\n                    <ul className=\"list-disc list-inside space-y-1\">\n                      <li>Remover todos os clientes master</li>\n                      <li>Remover todos os vínculos de usuários com clientes</li>\n                      <li>Excluir todas as vendas, metas e históricos relacionados</li>\n                    </ul>\n                    <p className=\"font-bold text-destructive\">\n                      ESTA AÇÃO NÃO PODE SER DESFEITA.\n                    </p>\n                  </AlertDialogDescription>\n                </AlertDialogHeader>\n                <AlertDialogFooter>\n                  <AlertDialogCancel data-testid=\"button-cancel-delete-all\">\n                    Cancelar\n                  </AlertDialogCancel>\n                  <AlertDialogAction\n                    onClick={() => deleteAllClientsMutation.mutate()}\n                    className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n                    disabled={deleteAllClientsMutation.isPending}\n                    data-testid=\"button-confirm-delete-all\"\n                  >\n                    {deleteAllClientsMutation.isPending ? \"Excluindo...\" : \"Confirmar Exclusão Total\"}\n                  </AlertDialogAction>\n                </AlertDialogFooter>\n              </AlertDialogContent>\n            </AlertDialog>\n\n            <Dialog open={showImportModal} onOpenChange={setShowImportModal}>\n              <DialogTrigger asChild>\n                <Button variant=\"outline\" data-testid=\"button-import-master-clients\">\n                  <Upload className=\"h-4 w-4 mr-2\" />\n                  Importar Clientes\n                </Button>\n              </DialogTrigger>\n            <DialogContent className=\"max-w-md\" data-testid=\"import-master-clients-modal\">\n              <DialogHeader>\n                <DialogTitle>Importar Clientes do Excel</DialogTitle>\n              </DialogHeader>\n              <div className=\"space-y-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"vendedor-select\">Selecionar Vendedor *</Label>\n                  <Select value={selectedVendedorId} onValueChange={setSelectedVendedorId}>\n                    <SelectTrigger id=\"vendedor-select\" data-testid=\"select-vendedor-import\">\n                      <SelectValue placeholder=\"Selecione o vendedor para vincular os clientes\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {vendedores?.map((vendedor) => (\n                        <SelectItem key={vendedor.id} value={vendedor.id} data-testid={`option-vendedor-${vendedor.id}`}>\n                          {vendedor.name} (@{vendedor.username})\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  <p className=\"text-xs text-muted-foreground\">\n                    Os clientes importados serão vinculados ao vendedor selecionado\n                  </p>\n                </div>\n\n                <div className=\"bg-muted p-4 rounded-lg text-sm\">\n                  <p className=\"font-medium mb-2\">Formato esperado do Excel:</p>\n                  <ul className=\"list-disc list-inside space-y-1 text-muted-foreground\">\n                    <li><strong>Coluna A:</strong> Cliente (80/20)</li>\n                    <li><strong>Coluna B:</strong> Área de plantio em hectares (ha)</li>\n                    <li><strong>Coluna C:</strong> região</li>\n                  </ul>\n                  <p className=\"mt-3 text-xs text-muted-foreground\">\n                    * Clientes duplicados serão identificados por nome e atualizados automaticamente\n                  </p>\n                </div>\n                \n                <div className=\"border-2 border-dashed border-muted rounded-lg p-8 text-center\">\n                  <input\n                    type=\"file\"\n                    accept=\".xlsx,.xls\"\n                    onChange={handleFileUpload}\n                    disabled={uploading || !selectedVendedorId}\n                    className=\"hidden\"\n                    id=\"master-client-file-upload\"\n                    data-testid=\"input-file-upload-master-clients\"\n                  />\n                  <label \n                    htmlFor=\"master-client-file-upload\" \n                    className={`cursor-pointer flex flex-col items-center gap-3 ${(uploading || !selectedVendedorId) ? 'opacity-50 cursor-not-allowed' : ''}`}\n                  >\n                    <div className=\"w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center\">\n                      <Upload className=\"text-primary\" size={24} />\n                    </div>\n                    <div>\n                      <p className=\"font-medium\">\n                        {uploading ? \"Importando...\" : selectedVendedorId ? \"Clique para selecionar arquivo\" : \"Selecione um vendedor primeiro\"}\n                      </p>\n                      <p className=\"text-sm text-muted-foreground\">\n                        Apenas arquivos Excel (.xlsx, .xls)\n                      </p>\n                    </div>\n                  </label>\n                </div>\n              </div>\n            </DialogContent>\n          </Dialog>\n          </div>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-4\">\n            <Input\n              placeholder=\"Buscar consultor por nome...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              data-testid=\"input-search-master-clients\"\n            />\n\n            <div className=\"space-y-2\">\n              {vendedores\n                ?.filter((consultor) => {\n                  const clientsCount = allUserClientLinks?.filter(link => link.userId === consultor.id).length || 0;\n                  if (!loadingLinks && !errorLinks && clientsCount === 0) return false;\n                  return searchQuery ? consultor.name.toLowerCase().includes(searchQuery.toLowerCase()) : true;\n                })\n                .map((consultor) => {\n                  const clientsCount = allUserClientLinks?.filter(link => link.userId === consultor.id).length || 0;\n                  const consultorClients = allUserClientLinks?.filter(link => link.userId === consultor.id) || [];\n                  const isExpanded = expandedConsultant === consultor.id;\n\n                  return (\n                    <div key={consultor.id} className=\"border rounded-lg overflow-hidden\">\n                      <button\n                        onClick={() => toggleConsultant(consultor.id)}\n                        className=\"w-full p-4 flex items-center justify-between hover:bg-accent/50 transition-colors text-left\"\n                        data-testid={`button-toggle-consultant-${consultor.id}`}\n                      >\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center\">\n                            <Users className=\"text-primary\" size={20} />\n                          </div>\n                          <div>\n                            <p className=\"font-medium\">{consultor.name}</p>\n                            <p className=\"text-sm text-muted-foreground\">@{consultor.username}</p>\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-3\">\n                          <Badge variant=\"secondary\" data-testid={`badge-clients-count-${consultor.id}`}>\n                            {clientsCount} {clientsCount === 1 ? 'cliente' : 'clientes'}\n                          </Badge>\n                          <div className={`transform transition-transform ${isExpanded ? 'rotate-180' : ''}`}>\n                            ▼\n                          </div>\n                        </div>\n                      </button>\n\n                      {isExpanded && (\n                        <div className=\"border-t bg-muted/30\">\n                          {consultorClients.length === 0 ? (\n                            <div className=\"p-4 text-center text-muted-foreground\">\n                              Nenhum cliente vinculado a este consultor\n                            </div>\n                          ) : (\n                            <>\n                              <div className=\"divide-y\">\n                                {consultorClients.map((link: any) => (\n                                  <div\n                                    key={link.id}\n                                    className=\"p-4 flex items-center justify-between hover:bg-accent/30 transition-colors\"\n                                    data-testid={`client-item-${link.id}`}\n                                  >\n                                    <div className=\"flex-1\">\n                                      <p className=\"font-medium\">{link.masterClient?.name || link.customName || 'Cliente sem nome'}</p>\n                                      <div className=\"flex gap-2 mt-1 text-sm text-muted-foreground\">\n                                        {link.masterClient?.plantingArea && (\n                                          <span>Área: {link.masterClient.plantingArea} ha</span>\n                                        )}\n                                        {link.masterClient?.regionId && (\n                                          <span>\n                                            • Região: {regions?.find((r: any) => r.id === link.masterClient.regionId)?.name || link.masterClient.regionId}\n                                          </span>\n                                        )}\n                                        {link.isTop80_20 && (\n                                          <Badge variant=\"default\" className=\"ml-2\">TOP 80/20</Badge>\n                                        )}\n                                      </div>\n                                    </div>\n                                    <div className=\"flex gap-2\">\n                                      <Button\n                                        variant=\"ghost\"\n                                        size=\"icon\"\n                                        onClick={() => setEditingClient(link.masterClient)}\n                                        data-testid={`button-edit-client-${link.id}`}\n                                      >\n                                        <Edit className=\"h-4 w-4\" />\n                                      </Button>\n                                      <Button\n                                        variant=\"ghost\"\n                                        size=\"icon\"\n                                        onClick={() => setMergingClient(link.masterClient)}\n                                        data-testid={`button-merge-client-${link.id}`}\n                                      >\n                                        <Users className=\"h-4 w-4\" />\n                                      </Button>\n                                    </div>\n                                  </div>\n                                ))}\n                              </div>\n                              <div className=\"p-4 border-t bg-muted/50\">\n                                <AlertDialog>\n                                  <AlertDialogTrigger asChild>\n                                    <Button \n                                      variant=\"destructive\" \n                                      size=\"sm\"\n                                      className=\"w-full\"\n                                      data-testid={`button-delete-consultor-clients-${consultor.id}`}\n                                    >\n                                      <Trash2 className=\"h-4 w-4 mr-2\" />\n                                      Excluir Todos os Clientes deste Consultor\n                                    </Button>\n                                  </AlertDialogTrigger>\n                                  <AlertDialogContent data-testid={`dialog-delete-consultor-clients-${consultor.id}`}>\n                                    <AlertDialogHeader>\n                                      <AlertDialogTitle>⚠️ Confirmar Exclusão</AlertDialogTitle>\n                                      <AlertDialogDescription className=\"space-y-3\">\n                                        <p className=\"font-semibold text-destructive\">\n                                          Você está prestes a excluir todos os {clientsCount} cliente(s) de {consultor.name}.\n                                        </p>\n                                        <p>\n                                          Esta ação irá remover todos os vínculos deste consultor com seus clientes.\n                                        </p>\n                                        <p className=\"text-sm text-muted-foreground\">\n                                          Os clientes master permanecerão no sistema e poderão ser vinculados novamente a qualquer consultor.\n                                        </p>\n                                      </AlertDialogDescription>\n                                    </AlertDialogHeader>\n                                    <AlertDialogFooter>\n                                      <AlertDialogCancel data-testid={`button-cancel-delete-consultor-${consultor.id}`}>\n                                        Cancelar\n                                      </AlertDialogCancel>\n                                      <AlertDialogAction\n                                        onClick={() => deleteConsultorClientsMutation.mutate(consultor.id)}\n                                        className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n                                        disabled={deleteConsultorClientsMutation.isPending}\n                                        data-testid={`button-confirm-delete-consultor-${consultor.id}`}\n                                      >\n                                        {deleteConsultorClientsMutation.isPending ? \"Excluindo...\" : \"Excluir Clientes\"}\n                                      </AlertDialogAction>\n                                    </AlertDialogFooter>\n                                  </AlertDialogContent>\n                                </AlertDialog>\n                              </div>\n                            </>\n                          )}\n                        </div>\n                      )}\n                    </div>\n                  );\n                })}\n\n              {(() => {\n                const linkedClientIds = new Set(allUserClientLinks?.map(link => link.masterClientId) || []);\n                const unlinkedClients = masterClients?.filter(client => !linkedClientIds.has(client.id)) || [];\n                \n                if (unlinkedClients.length > 0) {\n                  const isExpanded = expandedConsultant === 'unassigned';\n                  \n                  return (\n                    <div className=\"border rounded-lg overflow-hidden border-dashed\">\n                      <button\n                        onClick={() => toggleConsultant('unassigned')}\n                        className=\"w-full p-4 flex items-center justify-between hover:bg-accent/50 transition-colors text-left\"\n                        data-testid=\"button-toggle-unassigned-clients\"\n                      >\n                        <div className=\"flex items-center gap-3\">\n                          <div className=\"w-10 h-10 bg-muted rounded-full flex items-center justify-center\">\n                            <Users className=\"text-muted-foreground\" size={20} />\n                          </div>\n                          <div>\n                            <p className=\"font-medium text-muted-foreground\">Sem Consultor</p>\n                            <p className=\"text-sm text-muted-foreground\">Clientes não vinculados</p>\n                          </div>\n                        </div>\n                        <div className=\"flex items-center gap-3\">\n                          <Badge variant=\"outline\" data-testid=\"badge-unassigned-clients-count\">\n                            {unlinkedClients.length} {unlinkedClients.length === 1 ? 'cliente' : 'clientes'}\n                          </Badge>\n                          <div className={`transform transition-transform ${isExpanded ? 'rotate-180' : ''}`}>\n                            ▼\n                          </div>\n                        </div>\n                      </button>\n\n                      {isExpanded && (\n                        <div className=\"border-t bg-muted/30\">\n                          <div className=\"divide-y\">\n                            {unlinkedClients.map((client: any) => (\n                              <div\n                                key={client.id}\n                                className=\"p-4 flex items-center justify-between hover:bg-accent/30 transition-colors\"\n                                data-testid={`unassigned-client-item-${client.id}`}\n                              >\n                                <div className=\"flex-1\">\n                                  <p className=\"font-medium\">{client.name}</p>\n                                  <div className=\"flex gap-2 mt-1 text-sm text-muted-foreground\">\n                                    {client.plantingArea && (\n                                      <span>Área: {client.plantingArea} ha</span>\n                                    )}\n                                    {client.regionId && (\n                                      <span>\n                                        • Região: {regions?.find((r: any) => r.id === client.regionId)?.name || client.regionId}\n                                      </span>\n                                    )}\n                                  </div>\n                                </div>\n                                <div className=\"flex gap-2\">\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"icon\"\n                                    onClick={() => setEditingClient(client)}\n                                    data-testid={`button-edit-unassigned-client-${client.id}`}\n                                  >\n                                    <Edit className=\"h-4 w-4\" />\n                                  </Button>\n                                  <Button\n                                    variant=\"ghost\"\n                                    size=\"icon\"\n                                    onClick={() => setMergingClient(client)}\n                                    data-testid={`button-merge-unassigned-client-${client.id}`}\n                                  >\n                                    <Users className=\"h-4 w-4\" />\n                                  </Button>\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  );\n                }\n                return null;\n              })()}\n\n              {vendedores?.length === 0 && (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  Nenhum consultor cadastrado\n                </div>\n              )}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Dialog open={!!editingClient} onOpenChange={(open) => !open && setEditingClient(null)}>\n        <DialogContent data-testid=\"dialog-edit-master-client\">\n          <DialogHeader>\n            <DialogTitle>Editar Cliente Master</DialogTitle>\n            <DialogDescription>\n              Altere as informações do cliente abaixo.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-client-name\">Nome</Label>\n              <Input\n                id=\"edit-client-name\"\n                value={editingClient?.name || \"\"}\n                onChange={(e) =>\n                  setEditingClient({ ...editingClient, name: e.target.value })\n                }\n                data-testid=\"input-edit-master-client-name\"\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-client-region\">Região</Label>\n              <Select\n                value={editingClient?.regionId || \"\"}\n                onValueChange={(value) =>\n                  setEditingClient({ ...editingClient, regionId: value })\n                }\n              >\n                <SelectTrigger data-testid=\"select-edit-master-client-region\">\n                  <SelectValue placeholder=\"Selecione a região\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {regions?.map((region: any) => (\n                    <SelectItem key={region.id} value={region.id}>\n                      {region.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"edit-client-area\">Área de Plantio (ha)</Label>\n              <Input\n                id=\"edit-client-area\"\n                value={editingClient?.plantingArea || \"\"}\n                onChange={(e) =>\n                  setEditingClient({ ...editingClient, plantingArea: e.target.value })\n                }\n                data-testid=\"input-edit-master-client-area\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => setEditingClient(null)}\n              data-testid=\"button-cancel-edit-master-client\"\n            >\n              Cancelar\n            </Button>\n            <Button\n              onClick={() =>\n                updateClientMutation.mutate({\n                  id: editingClient.id,\n                  data: {\n                    name: editingClient.name,\n                    regionId: editingClient.regionId,\n                    plantingArea: editingClient.plantingArea,\n                  },\n                })\n              }\n              disabled={updateClientMutation.isPending}\n              data-testid=\"button-save-master-client\"\n            >\n              {updateClientMutation.isPending ? \"Salvando...\" : \"Salvar\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      <Dialog open={!!mergingClient} onOpenChange={(open) => !open && setMergingClient(null)}>\n        <DialogContent data-testid=\"dialog-merge-master-client\">\n          <DialogHeader>\n            <DialogTitle>Mesclar Clientes Duplicados</DialogTitle>\n            <DialogDescription>\n              Selecione o cliente de destino. Todos os vínculos de \"{mergingClient?.name}\" serão transferidos.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4 py-4\">\n            <div className=\"space-y-2\">\n              <Label>Cliente de origem (será removido)</Label>\n              <Input value={mergingClient?.name || \"\"} disabled />\n            </div>\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"merge-target\">Cliente de destino (receberá os vínculos)</Label>\n              <Select value={mergeTarget} onValueChange={setMergeTarget}>\n                <SelectTrigger data-testid=\"select-merge-target\">\n                  <SelectValue placeholder=\"Selecione o cliente de destino\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {masterClients\n                    ?.filter((c: any) => c.id !== mergingClient?.id)\n                    .map((client: any) => (\n                      <SelectItem key={client.id} value={client.id}>\n                        {client.name}\n                      </SelectItem>\n                    ))}\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setMergingClient(null);\n                setMergeTarget(\"\");\n              }}\n              data-testid=\"button-cancel-merge\"\n            >\n              Cancelar\n            </Button>\n            <Button\n              onClick={() =>\n                mergeClientsMutation.mutate({\n                  sourceId: mergingClient.id,\n                  targetId: mergeTarget,\n                })\n              }\n              disabled={!mergeTarget || mergeClientsMutation.isPending}\n              data-testid=\"button-confirm-merge\"\n            >\n              {mergeClientsMutation.isPending ? \"Mesclando...\" : \"Mesclar\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\n\nfunction ParametersManagement() {\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle>Parâmetros do Sistema</CardTitle>\n        <CardDescription>Configure os parâmetros de safras e classificações</CardDescription>\n      </CardHeader>\n      <CardContent>\n        <p className=\"text-muted-foreground text-center py-8\">Parâmetros do sistema serão implementados aqui</p>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction BarterManagement() {\n  const [activeSubTab, setActiveSubTab] = useState(\"products\");\n\n  return (\n    <Tabs value={activeSubTab} onValueChange={setActiveSubTab} className=\"space-y-4\">\n      <TabsList className=\"grid w-full grid-cols-3 max-w-2xl\">\n        <TabsTrigger value=\"products\">Produtos</TabsTrigger>\n        <TabsTrigger value=\"seasons\">Safras</TabsTrigger>\n        <TabsTrigger value=\"settings\">Configurações</TabsTrigger>\n      </TabsList>\n\n      <TabsContent value=\"products\">\n        <BarterProductsManagement />\n      </TabsContent>\n\n      <TabsContent value=\"seasons\">\n        <BarterSeasonsManagement />\n      </TabsContent>\n\n      <TabsContent value=\"settings\">\n        <BarterSettingsManagement />\n      </TabsContent>\n    </Tabs>\n  );\n}\n\nfunction BarterProductsManagement() {\n  const [newProduct, setNewProduct] = useState<Partial<InsertBarterProduct & {id: string}>>({ name: \"\", category: \"\", dosePerHa: \"\", unit: \"\", priceUsd: \"\", seasonId: \"\", isActive: true });\n  const [editingProduct, setEditingProduct] = useState<BarterProduct | null>(null);\n  const [showDialog, setShowDialog] = useState(false);\n  const [showImportDialog, setShowImportDialog] = useState(false);\n  const [showDeleteAllDialog, setShowDeleteAllDialog] = useState(false);\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [previewProducts, setPreviewProducts] = useState<any[]>([]);\n  const [importing, setImporting] = useState(false);\n  const [importSeasonId, setImportSeasonId] = useState<string>(\"\");\n  const { toast } = useToast();\n\n  const { data: products, isLoading } = useQuery<BarterProduct[]>({\n    queryKey: ['/api/admin/barter/products'],\n  });\n\n  const { data: seasons } = useQuery<any[]>({\n    queryKey: ['/api/seasons'],\n  });\n\n  const createProductMutation = useMutation({\n    mutationFn: async (product: any) => {\n      const payload = { ...product, seasonId: product.seasonId || undefined };\n      return apiRequest(\"POST\", \"/api/admin/barter/products\", payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/barter/products'] });\n      toast({ title: \"Produto criado\", description: \"Produto barter criado com sucesso.\" });\n      setShowDialog(false);\n      setNewProduct({ name: \"\", category: \"\", dosePerHa: \"\", unit: \"\", priceUsd: \"\", seasonId: \"\", isActive: true });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Erro ao criar produto barter.\", variant: \"destructive\" });\n    },\n  });\n\n  const updateProductMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: any }) => {\n      // Remove timestamp fields and id before sending update\n      const { createdAt, updatedAt, id: _id, ...updateFields } = data;\n      const payload = { ...updateFields, seasonId: data.seasonId || undefined };\n      return apiRequest(\"PATCH\", `/api/admin/barter/products/${id}`, payload);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/barter/products'] });\n      toast({ title: \"Produto atualizado\", description: \"Produto barter atualizado com sucesso.\" });\n      setEditingProduct(null);\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Erro ao atualizar produto barter.\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteProductMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/admin/barter/products/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/barter/products'] });\n      toast({ title: \"Produto excluído\", description: \"Produto barter excluído com sucesso.\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Erro ao excluir produto barter.\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteAllProductsMutation = useMutation({\n    mutationFn: async () => {\n      return apiRequest(\"DELETE\", \"/api/admin/barter/products\");\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/barter/products'] });\n      toast({ title: \"Produtos excluídos\", description: \"Todos os produtos barter foram excluídos com sucesso.\" });\n      setShowDeleteAllDialog(false);\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Erro ao excluir produtos barter.\", variant: \"destructive\" });\n    },\n  });\n\n  const categories = [\n    { value: \"sementes\", label: \"Sementes\" },\n    { value: \"fertilizantes\", label: \"Fertilizantes\" },\n    { value: \"herbicidas\", label: \"Herbicidas\" },\n    { value: \"inseticidas\", label: \"Inseticidas\" },\n    { value: \"fungicidas\", label: \"Fungicidas\" },\n    { value: \"especialidades\", label: \"Especialidades\" },\n  ];\n\n  const units = [\n    { value: \"kg\", label: \"kg\" },\n    { value: \"lt\", label: \"lt\" },\n    { value: \"sc\", label: \"sc\" },\n    { value: \"un\", label: \"un\" },\n  ];\n\n  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    setSelectedFile(file);\n    \n    // Preview mode\n    const formData = new FormData();\n    formData.append('file', file);\n    formData.append('preview', 'true');\n\n    try {\n      const response = await fetch('/api/admin/barter/products/bulk-import', {\n        method: 'POST',\n        body: formData,\n      });\n\n      if (!response.ok) throw new Error('Failed to preview');\n      \n      const data = await response.json();\n      setPreviewProducts(data.products || []);\n    } catch (error) {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao processar arquivo para preview.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleImport = async () => {\n    if (!selectedFile) return;\n\n    setImporting(true);\n    const formData = new FormData();\n    formData.append('file', selectedFile);\n    if (importSeasonId) {\n      formData.append('seasonId', importSeasonId);\n    }\n\n    try {\n      const response = await fetch('/api/admin/barter/products/bulk-import', {\n        method: 'POST',\n        body: formData,\n      });\n\n      if (!response.ok) throw new Error('Failed to import');\n      \n      const data = await response.json();\n      \n      queryClient.invalidateQueries({ queryKey: ['/api/admin/barter/products'] });\n      \n      toast({\n        title: \"Importação concluída\",\n        description: `${data.created} produtos importados com sucesso. ${data.errors > 0 ? `${data.errors} erros.` : ''}`,\n      });\n      \n      setShowImportDialog(false);\n      setSelectedFile(null);\n      setPreviewProducts([]);\n    } catch (error) {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao importar produtos.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setImporting(false);\n    }\n  };\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle>Produtos Barter</CardTitle>\n            <CardDescription>Gerencie o catálogo de produtos para simulações barter</CardDescription>\n          </div>\n          <div className=\"flex gap-2\">\n            <AlertDialog open={showDeleteAllDialog} onOpenChange={setShowDeleteAllDialog}>\n              <AlertDialogTrigger asChild>\n                <Button \n                  variant=\"destructive\" \n                  size=\"sm\"\n                  disabled={!products || products.length === 0}\n                  data-testid=\"button-delete-all-barter-products\"\n                >\n                  <Trash2 size={16} className=\"mr-2\" />\n                  Excluir Todos\n                </Button>\n              </AlertDialogTrigger>\n              <AlertDialogContent>\n                <AlertDialogHeader>\n                  <AlertDialogTitle>Tem certeza?</AlertDialogTitle>\n                  <AlertDialogDescription>\n                    Esta ação não pode ser desfeita. Todos os {products?.length || 0} produtos barter serão permanentemente excluídos.\n                  </AlertDialogDescription>\n                </AlertDialogHeader>\n                <AlertDialogFooter>\n                  <AlertDialogCancel>Cancelar</AlertDialogCancel>\n                  <AlertDialogAction\n                    onClick={() => deleteAllProductsMutation.mutate()}\n                    className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n                  >\n                    Excluir Todos\n                  </AlertDialogAction>\n                </AlertDialogFooter>\n              </AlertDialogContent>\n            </AlertDialog>\n            \n            <Dialog open={showImportDialog} onOpenChange={setShowImportDialog}>\n              <DialogTrigger asChild>\n                <Button variant=\"outline\" data-testid=\"button-import-barter-products\">\n                  <Upload size={16} className=\"mr-2\" />\n                  Importar Planilha\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-4xl max-h-[80vh] overflow-y-auto\">\n                <DialogHeader>\n                  <DialogTitle>Importar Produtos Barter</DialogTitle>\n                  <DialogDescription>\n                    Faça upload de uma planilha Excel ou PDF com produtos barter. O sistema detectará automaticamente as categorias e preços.\n                  </DialogDescription>\n                </DialogHeader>\n                <div className=\"space-y-4 py-4\">\n                  <div className=\"space-y-2\">\n                    <Label>Safra (Opcional)</Label>\n                    <div className=\"flex gap-2\">\n                      <Select value={importSeasonId || undefined} onValueChange={setImportSeasonId}>\n                        <SelectTrigger data-testid=\"select-import-season\">\n                          <SelectValue placeholder=\"Sem safra específica\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {seasons?.map((season: any) => (\n                            <SelectItem key={season.id} value={season.id}>\n                              {season.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                      {importSeasonId && (\n                        <Button\n                          type=\"button\"\n                          variant=\"outline\"\n                          size=\"icon\"\n                          onClick={() => setImportSeasonId('')}\n                          data-testid=\"button-clear-import-season\"\n                        >\n                          <X size={16} />\n                        </Button>\n                      )}\n                    </div>\n                    <p className=\"text-sm text-muted-foreground\">\n                      Selecione uma safra para associar a todos os produtos importados\n                    </p>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label>Arquivo (Excel ou PDF)</Label>\n                    <Input\n                      type=\"file\"\n                      accept=\".xlsx,.xls,.pdf\"\n                      onChange={handleFileSelect}\n                      data-testid=\"input-import-file\"\n                    />\n                  </div>\n                  \n                  {previewProducts.length > 0 && (\n                    <div className=\"space-y-2\">\n                      <Label>Preview - {previewProducts.length} produtos detectados</Label>\n                      <div className=\"border rounded-md max-h-96 overflow-y-auto\">\n                        <Table>\n                          <TableHeader>\n                            <TableRow>\n                              <TableHead>Nome</TableHead>\n                              <TableHead>Categoria</TableHead>\n                              <TableHead>P.A.</TableHead>\n                              <TableHead>Dose</TableHead>\n                              <TableHead>Fabricante</TableHead>\n                              <TableHead>Vermelha</TableHead>\n                              <TableHead>Amarela</TableHead>\n                              <TableHead>Verde</TableHead>\n                            </TableRow>\n                          </TableHeader>\n                          <TableBody>\n                            {previewProducts.slice(0, 20).map((product, idx) => (\n                              <TableRow key={idx}>\n                                <TableCell className=\"font-medium\">{product.name}</TableCell>\n                                <TableCell>\n                                  <Badge variant=\"outline\">{product.category}</Badge>\n                                </TableCell>\n                                <TableCell className=\"text-xs\">{product.principioAtivo?.substring(0, 30)}...</TableCell>\n                                <TableCell className=\"text-xs\">{product.dosePerHa}</TableCell>\n                                <TableCell>{product.fabricante}</TableCell>\n                                <TableCell>{product.priceVermelha}</TableCell>\n                                <TableCell>{product.priceAmarela}</TableCell>\n                                <TableCell>{product.priceVerde}</TableCell>\n                              </TableRow>\n                            ))}\n                          </TableBody>\n                        </Table>\n                        {previewProducts.length > 20 && (\n                          <p className=\"text-sm text-muted-foreground p-2 text-center\">\n                            ... e mais {previewProducts.length - 20} produtos\n                          </p>\n                        )}\n                      </div>\n                    </div>\n                  )}\n                </div>\n                <DialogFooter>\n                  <Button variant=\"outline\" onClick={() => {\n                    setShowImportDialog(false);\n                    setSelectedFile(null);\n                    setPreviewProducts([]);\n                  }}>\n                    Cancelar\n                  </Button>\n                  <Button\n                    onClick={handleImport}\n                    disabled={!selectedFile || previewProducts.length === 0 || importing}\n                    data-testid=\"button-confirm-import\"\n                  >\n                    {importing ? \"Importando...\" : `Importar ${previewProducts.length} Produtos`}\n                  </Button>\n                </DialogFooter>\n              </DialogContent>\n            </Dialog>\n            \n            <Dialog open={showDialog} onOpenChange={setShowDialog}>\n              <DialogTrigger asChild>\n                <Button data-testid=\"button-add-barter-product\">\n                  <Plus size={16} className=\"mr-2\" />\n                  Novo Produto\n                </Button>\n              </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Novo Produto Barter</DialogTitle>\n                <DialogDescription>Adicione um novo produto ao catálogo barter</DialogDescription>\n              </DialogHeader>\n              <div className=\"space-y-4 py-4\">\n                <div className=\"space-y-2\">\n                  <Label>Nome do Produto</Label>\n                  <Input\n                    value={newProduct.name}\n                    onChange={(e) => setNewProduct({ ...newProduct, name: e.target.value })}\n                    placeholder=\"Ex: Soja 63I64RSF IPRO\"\n                    data-testid=\"input-product-name\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Categoria</Label>\n                  <Select value={newProduct.category} onValueChange={(value) => setNewProduct({ ...newProduct, category: value })}>\n                    <SelectTrigger data-testid=\"select-product-category\">\n                      <SelectValue placeholder=\"Selecione a categoria\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {categories.map((cat) => (\n                        <SelectItem key={cat.value} value={cat.value}>\n                          {cat.label}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Safra (Opcional)</Label>\n                  <div className=\"flex gap-2\">\n                    <Select value={newProduct.seasonId || undefined} onValueChange={(value) => setNewProduct({ ...newProduct, seasonId: value || null })}>\n                      <SelectTrigger data-testid=\"select-product-season\">\n                        <SelectValue placeholder=\"Sem safra específica\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {seasons?.map((season: any) => (\n                          <SelectItem key={season.id} value={season.id}>\n                            {season.name}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                    {newProduct.seasonId && (\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        size=\"icon\"\n                        onClick={() => setNewProduct({ ...newProduct, seasonId: null })}\n                      >\n                        <X size={16} />\n                      </Button>\n                    )}\n                  </div>\n                </div>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-2\">\n                    <Label>Dose/Ha</Label>\n                    <Input\n                      type=\"text\"\n                      value={newProduct.dosePerHa || ''}\n                      onChange={(e) => setNewProduct({ ...newProduct, dosePerHa: e.target.value })}\n                      placeholder=\"2ml/Kg ou 1Lt/Há\"\n                      data-testid=\"input-dose-per-ha\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label>Unidade</Label>\n                    <Select value={newProduct.unit} onValueChange={(value) => setNewProduct({ ...newProduct, unit: value })}>\n                      <SelectTrigger data-testid=\"select-product-unit\">\n                        <SelectValue placeholder=\"Unidade\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {units.map((unit) => (\n                          <SelectItem key={unit.value} value={unit.value}>\n                            {unit.label}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label>Preço USD</Label>\n                  <Input\n                    type=\"number\"\n                    step=\"0.01\"\n                    value={newProduct.priceUsd}\n                    onChange={(e) => setNewProduct({ ...newProduct, priceUsd: e.target.value })}\n                    placeholder=\"320.00\"\n                    data-testid=\"input-product-price\"\n                  />\n                </div>\n              </div>\n              <DialogFooter>\n                <Button variant=\"outline\" onClick={() => setShowDialog(false)}>\n                  Cancelar\n                </Button>\n                <Button\n                  onClick={() => createProductMutation.mutate(newProduct)}\n                  disabled={!newProduct.name || !newProduct.category || !newProduct.unit || !newProduct.priceUsd || createProductMutation.isPending}\n                  data-testid=\"button-save-barter-product\"\n                >\n                  {createProductMutation.isPending ? \"Salvando...\" : \"Salvar\"}\n                </Button>\n              </DialogFooter>\n            </DialogContent>\n          </Dialog>\n          </div>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {isLoading ? (\n          <p className=\"text-center py-8\">Carregando produtos...</p>\n        ) : (\n          <ProductsBySeasonView \n            products={products || []} \n            seasons={seasons || []} \n            categories={categories}\n            onEdit={setEditingProduct}\n            onDelete={(id) => deleteProductMutation.mutate(id)}\n            onToggleActive={(id, isActive) => updateProductMutation.mutate({ id, data: { isActive } })}\n            onToggleSeasonActive={(seasonId, isActive) => {\n              const seasonProducts = products?.filter(p => p.seasonId === seasonId) || [];\n              seasonProducts.forEach(p => updateProductMutation.mutate({ id: p.id, data: { isActive } }));\n            }}\n          />\n        )}\n      </CardContent>\n\n      {editingProduct && (\n        <Dialog open={!!editingProduct} onOpenChange={() => setEditingProduct(null)}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Editar Produto</DialogTitle>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label>Nome</Label>\n                <Input\n                  value={editingProduct.name}\n                  onChange={(e) => setEditingProduct({ ...editingProduct, name: e.target.value })}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Categoria</Label>\n                <Select value={editingProduct.category} onValueChange={(value) => setEditingProduct({ ...editingProduct, category: value })}>\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Selecione a categoria\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {categories.map((cat) => (\n                      <SelectItem key={cat.value} value={cat.value}>\n                        {cat.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Safra (Opcional)</Label>\n                <div className=\"flex gap-2\">\n                  <Select value={editingProduct.seasonId || undefined} onValueChange={(value) => setEditingProduct({ ...editingProduct, seasonId: value || null })}>\n                    <SelectTrigger>\n                      <SelectValue placeholder=\"Sem safra específica\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {seasons?.map((season: any) => (\n                        <SelectItem key={season.id} value={season.id}>\n                          {season.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                  {editingProduct.seasonId && (\n                    <Button\n                      type=\"button\"\n                      variant=\"outline\"\n                      size=\"icon\"\n                      onClick={() => setEditingProduct({ ...editingProduct, seasonId: null })}\n                    >\n                      <X size={16} />\n                    </Button>\n                  )}\n                </div>\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Preço USD</Label>\n                <Input\n                  type=\"number\"\n                  step=\"0.01\"\n                  value={editingProduct.priceUsd}\n                  onChange={(e) => setEditingProduct({ ...editingProduct, priceUsd: e.target.value })}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Status</Label>\n                <Select\n                  value={editingProduct.isActive ? \"true\" : \"false\"}\n                  onValueChange={(value) => setEditingProduct({ ...editingProduct, isActive: value === \"true\" })}\n                >\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"true\">Ativo</SelectItem>\n                    <SelectItem value=\"false\">Inativo</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setEditingProduct(null)}>\n                Cancelar\n              </Button>\n              <Button\n                onClick={() => updateProductMutation.mutate({ id: editingProduct.id, data: editingProduct })}\n                disabled={updateProductMutation.isPending}\n              >\n                {updateProductMutation.isPending ? \"Salvando...\" : \"Salvar\"}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      )}\n    </Card>\n  );\n}\n\nfunction ProductsBySeasonView({ products, seasons, categories, onEdit, onDelete, onToggleActive, onToggleSeasonActive }: {\n  products: any[];\n  seasons: any[];\n  categories: any[];\n  onEdit: (product: any) => void;\n  onDelete: (id: string) => void;\n  onToggleActive: (id: string, isActive: boolean) => void;\n  onToggleSeasonActive: (seasonId: string, isActive: boolean) => void;\n}) {\n  const [expandedSeasons, setExpandedSeasons] = useState<Set<string>>(new Set());\n\n  const toggleSeason = (seasonId: string) => {\n    const newExpanded = new Set(expandedSeasons);\n    if (newExpanded.has(seasonId)) {\n      newExpanded.delete(seasonId);\n    } else {\n      newExpanded.add(seasonId);\n    }\n    setExpandedSeasons(newExpanded);\n  };\n\n  const productsWithoutSeason = products.filter(p => !p.seasonId);\n  const productsBySeason = seasons.reduce((acc: any, season: any) => {\n    acc[season.id] = products.filter(p => p.seasonId === season.id);\n    return acc;\n  }, {});\n\n  const seasonGroups = seasons.filter(season => productsBySeason[season.id]?.length > 0);\n\n  return (\n    <div className=\"space-y-4\">\n      {productsWithoutSeason.length > 0 && (\n        <div className=\"border rounded-lg p-4\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <div className=\"flex items-center gap-2\">\n              <h3 className=\"font-semibold\">Produtos sem safra específica</h3>\n              <Badge variant=\"outline\">{productsWithoutSeason.length} produtos</Badge>\n            </div>\n          </div>\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Nome</TableHead>\n                <TableHead>Categoria</TableHead>\n                <TableHead>Dose/Ha</TableHead>\n                <TableHead>Unidade</TableHead>\n                <TableHead>Preço USD</TableHead>\n                <TableHead>Status</TableHead>\n                <TableHead className=\"text-right\">Ações</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {productsWithoutSeason.map((product: any) => (\n                <TableRow key={product.id}>\n                  <TableCell>{product.name}</TableCell>\n                  <TableCell>\n                    <Badge variant=\"outline\">{categories.find(c => c.value === product.category)?.label}</Badge>\n                  </TableCell>\n                  <TableCell>{product.dosePerHa || \"-\"}</TableCell>\n                  <TableCell>{product.unit}</TableCell>\n                  <TableCell>${product.priceUsd}</TableCell>\n                  <TableCell>\n                    <Switch\n                      checked={product.isActive}\n                      onCheckedChange={(checked) => onToggleActive(product.id, checked)}\n                      data-testid={`toggle-product-${product.id}`}\n                    />\n                  </TableCell>\n                  <TableCell className=\"text-right\">\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => onEdit(product)}\n                      data-testid={`button-edit-product-${product.id}`}\n                    >\n                      <Edit size={16} />\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => onDelete(product.id)}\n                      data-testid={`button-delete-product-${product.id}`}\n                    >\n                      <Trash2 size={16} />\n                    </Button>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        </div>\n      )}\n\n      {seasonGroups.map((season: any) => {\n        const seasonProducts = productsBySeason[season.id] || [];\n        const allActive = seasonProducts.every((p: any) => p.isActive);\n        const isExpanded = expandedSeasons.has(season.id);\n\n        return (\n          <div key={season.id} className=\"border rounded-lg p-4\">\n            <div className=\"flex items-center justify-between mb-4\">\n              <div className=\"flex items-center gap-3\">\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => toggleSeason(season.id)}\n                  data-testid={`toggle-season-${season.id}`}\n                >\n                  {isExpanded ? <ChevronDown size={20} /> : <ChevronRight size={20} />}\n                </Button>\n                <h3 className=\"font-semibold\">{season.name}</h3>\n                <Badge variant=\"outline\">{seasonProducts.length} produtos</Badge>\n                <Badge variant={allActive ? \"default\" : \"secondary\"}>\n                  {allActive ? \"Todos ativos\" : \"Alguns inativos\"}\n                </Badge>\n              </div>\n              <div className=\"flex items-center gap-2\">\n                <Label className=\"text-sm\">Ativar/Desativar todos</Label>\n                <Switch\n                  checked={allActive}\n                  onCheckedChange={(checked) => onToggleSeasonActive(season.id, checked)}\n                  data-testid={`toggle-season-all-${season.id}`}\n                />\n              </div>\n            </div>\n\n            {isExpanded && (\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Nome</TableHead>\n                    <TableHead>Categoria</TableHead>\n                    <TableHead>Dose/Ha</TableHead>\n                    <TableHead>Unidade</TableHead>\n                    <TableHead>Preço USD</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead className=\"text-right\">Ações</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {seasonProducts.map((product: any) => (\n                    <TableRow key={product.id}>\n                      <TableCell>{product.name}</TableCell>\n                      <TableCell>\n                        <Badge variant=\"outline\">{categories.find(c => c.value === product.category)?.label}</Badge>\n                      </TableCell>\n                      <TableCell>{product.dosePerHa || \"-\"}</TableCell>\n                      <TableCell>{product.unit}</TableCell>\n                      <TableCell>${product.priceUsd}</TableCell>\n                      <TableCell>\n                        <Switch\n                          checked={product.isActive}\n                          onCheckedChange={(checked) => onToggleActive(product.id, checked)}\n                          data-testid={`toggle-product-${product.id}`}\n                        />\n                      </TableCell>\n                      <TableCell className=\"text-right\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => onEdit(product)}\n                          data-testid={`button-edit-product-${product.id}`}\n                        >\n                          <Edit size={16} />\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => onDelete(product.id)}\n                          data-testid={`button-delete-product-${product.id}`}\n                        >\n                          <Trash2 size={16} />\n                        </Button>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            )}\n          </div>\n        );\n      })}\n\n      {seasonGroups.length === 0 && productsWithoutSeason.length === 0 && (\n        <p className=\"text-center py-8 text-muted-foreground\">Nenhum produto cadastrado</p>\n      )}\n    </div>\n  );\n}\n\nfunction BarterSeasonsManagement() {\n  const [newSeason, setNewSeason] = useState({ name: \"\", type: \"\", year: new Date().getFullYear(), startDate: \"\", endDate: \"\" });\n  const [editingSeason, setEditingSeason] = useState<any | null>(null);\n  const [showDialog, setShowDialog] = useState(false);\n  const { toast } = useToast();\n\n  const { data: seasons, isLoading } = useQuery<any[]>({\n    queryKey: ['/api/seasons'],\n  });\n\n  const createSeasonMutation = useMutation({\n    mutationFn: async (seasonData: any) => {\n      return apiRequest(\"POST\", \"/api/seasons\", seasonData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/seasons'] });\n      toast({ title: \"Safra criada\", description: \"Safra criada com sucesso.\" });\n      setShowDialog(false);\n      setNewSeason({ name: \"\", type: \"\", year: new Date().getFullYear(), startDate: \"\", endDate: \"\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Erro ao criar safra.\", variant: \"destructive\" });\n    },\n  });\n\n  const updateSeasonMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: any }) => {\n      return apiRequest(\"PATCH\", `/api/seasons/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/seasons'] });\n      toast({ title: \"Safra atualizada\", description: \"Safra atualizada com sucesso.\" });\n      setEditingSeason(null);\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Erro ao atualizar safra.\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteSeasonMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/seasons/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/seasons'] });\n      toast({ title: \"Safra excluída\", description: \"Safra excluída com sucesso.\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Erro ao excluir safra.\", variant: \"destructive\" });\n    },\n  });\n\n  const seasonTypes = [\n    { value: \"soja_verao\", label: \"Soja Verão\" },\n    { value: \"safrinha\", label: \"Safrinha\" },\n    { value: \"milho\", label: \"Milho\" },\n    { value: \"trigo\", label: \"Trigo\" },\n  ];\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <CardTitle>Safras Barter</CardTitle>\n            <CardDescription>Gerencie as safras disponíveis para produtos barter</CardDescription>\n          </div>\n          <Dialog open={showDialog} onOpenChange={setShowDialog}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"button-add-barter-season\">\n                <Plus size={16} className=\"mr-2\" />\n                Nova Safra\n              </Button>\n            </DialogTrigger>\n            <DialogContent>\n              <DialogHeader>\n                <DialogTitle>Nova Safra Barter</DialogTitle>\n                <DialogDescription>Adicione uma nova safra para organizar produtos barter</DialogDescription>\n              </DialogHeader>\n              <div className=\"space-y-4 py-4\">\n                <div className=\"space-y-2\">\n                  <Label>Nome da Safra</Label>\n                  <Input\n                    value={newSeason.name}\n                    onChange={(e) => setNewSeason({ ...newSeason, name: e.target.value })}\n                    placeholder=\"Ex: Soja Verão 24/25\"\n                    data-testid=\"input-season-name\"\n                  />\n                </div>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-2\">\n                    <Label>Tipo</Label>\n                    <Select value={newSeason.type} onValueChange={(value) => setNewSeason({ ...newSeason, type: value })}>\n                      <SelectTrigger data-testid=\"select-season-type\">\n                        <SelectValue placeholder=\"Selecione o tipo\" />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {seasonTypes.map((type) => (\n                          <SelectItem key={type.value} value={type.value}>\n                            {type.label}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label>Ano</Label>\n                    <Input\n                      type=\"number\"\n                      value={newSeason.year}\n                      onChange={(e) => setNewSeason({ ...newSeason, year: parseInt(e.target.value) })}\n                      data-testid=\"input-season-year\"\n                    />\n                  </div>\n                </div>\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div className=\"space-y-2\">\n                    <Label>Data Início</Label>\n                    <Input\n                      type=\"date\"\n                      value={newSeason.startDate}\n                      onChange={(e) => setNewSeason({ ...newSeason, startDate: e.target.value })}\n                      data-testid=\"input-season-start\"\n                    />\n                  </div>\n                  <div className=\"space-y-2\">\n                    <Label>Data Fim</Label>\n                    <Input\n                      type=\"date\"\n                      value={newSeason.endDate}\n                      onChange={(e) => setNewSeason({ ...newSeason, endDate: e.target.value })}\n                      data-testid=\"input-season-end\"\n                    />\n                  </div>\n                </div>\n              </div>\n              <DialogFooter>\n                <Button variant=\"outline\" onClick={() => setShowDialog(false)}>\n                  Cancelar\n                </Button>\n                <Button\n                  onClick={() => createSeasonMutation.mutate(newSeason)}\n                  disabled={!newSeason.name || !newSeason.type || createSeasonMutation.isPending}\n                  data-testid=\"button-save-barter-season\"\n                >\n                  {createSeasonMutation.isPending ? \"Salvando...\" : \"Salvar\"}\n                </Button>\n              </DialogFooter>\n            </DialogContent>\n          </Dialog>\n        </div>\n      </CardHeader>\n      <CardContent>\n        {isLoading ? (\n          <p className=\"text-center py-8\">Carregando safras...</p>\n        ) : (\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead>Nome</TableHead>\n                <TableHead>Tipo</TableHead>\n                <TableHead>Ano</TableHead>\n                <TableHead>Período</TableHead>\n                <TableHead className=\"text-right\">Ações</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {seasons?.map((season: any) => (\n                <TableRow key={season.id}>\n                  <TableCell className=\"font-medium\">{season.name}</TableCell>\n                  <TableCell>\n                    <Badge variant=\"outline\">\n                      {seasonTypes.find(t => t.value === season.type)?.label || season.type}\n                    </Badge>\n                  </TableCell>\n                  <TableCell>{season.year}</TableCell>\n                  <TableCell className=\"text-sm text-muted-foreground\">\n                    {season.startDate && season.endDate\n                      ? `${new Date(season.startDate).toLocaleDateString()} - ${new Date(season.endDate).toLocaleDateString()}`\n                      : \"-\"}\n                  </TableCell>\n                  <TableCell className=\"text-right\">\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => setEditingSeason(season)}\n                      data-testid={`button-edit-season-${season.id}`}\n                    >\n                      <Edit size={16} />\n                    </Button>\n                    <Button\n                      variant=\"ghost\"\n                      size=\"sm\"\n                      onClick={() => deleteSeasonMutation.mutate(season.id)}\n                      data-testid={`button-delete-season-${season.id}`}\n                    >\n                      <Trash2 size={16} />\n                    </Button>\n                  </TableCell>\n                </TableRow>\n              ))}\n            </TableBody>\n          </Table>\n        )}\n      </CardContent>\n\n      {editingSeason && (\n        <Dialog open={!!editingSeason} onOpenChange={() => setEditingSeason(null)}>\n          <DialogContent>\n            <DialogHeader>\n              <DialogTitle>Editar Safra</DialogTitle>\n            </DialogHeader>\n            <div className=\"space-y-4 py-4\">\n              <div className=\"space-y-2\">\n                <Label>Nome</Label>\n                <Input\n                  value={editingSeason.name}\n                  onChange={(e) => setEditingSeason({ ...editingSeason, name: e.target.value })}\n                />\n              </div>\n              <div className=\"space-y-2\">\n                <Label>Tipo</Label>\n                <Select value={editingSeason.type} onValueChange={(value) => setEditingSeason({ ...editingSeason, type: value })}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {seasonTypes.map((type) => (\n                      <SelectItem key={type.value} value={type.value}>\n                        {type.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setEditingSeason(null)}>\n                Cancelar\n              </Button>\n              <Button\n                onClick={() => updateSeasonMutation.mutate({ id: editingSeason.id, data: editingSeason })}\n                disabled={updateSeasonMutation.isPending}\n              >\n                {updateSeasonMutation.isPending ? \"Salvando...\" : \"Salvar\"}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      )}\n    </Card>\n  );\n}\n\nfunction BarterSettingsManagement() {\n  const [settings, setSettings] = useState<Record<string, string>>({});\n  const { toast } = useToast();\n\n  const { data: barterSettings, isLoading } = useQuery<BarterSettings[]>({\n    queryKey: ['/api/admin/barter/settings'],\n  });\n\n  const updateSettingMutation = useMutation({\n    mutationFn: async ({ key, value, description }: { key: string; value: string; description?: string }) => {\n      return apiRequest(\"PUT\", `/api/admin/barter/settings/${key}`, { value, description });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/barter/settings'] });\n      toast({ title: \"Configuração salva\", description: \"Configuração atualizada com sucesso.\" });\n    },\n    onError: () => {\n      toast({ title: \"Erro\", description: \"Erro ao salvar configuração.\", variant: \"destructive\" });\n    },\n  });\n\n  const settingsConfig = [\n    { key: \"sack_price\", label: \"Preço da Saca (USD)\", description: \"Preço da saca usado no cálculo\", type: \"number\" },\n    { key: \"buffer_percentage\", label: \"Buffer de Segurança (%)\", description: \"Percentual de buffer aplicado ao contrato\", type: \"number\" },\n    { key: \"min_products\", label: \"Produtos Mínimos\", description: \"Quantidade mínima de produtos obrigatórios\", type: \"number\" },\n    { key: \"min_productivity\", label: \"Produtividade Mínima (sacas/ha)\", description: \"Produtividade mínima validada\", type: \"number\" },\n    { key: \"max_productivity\", label: \"Produtividade Máxima (sacas/ha)\", description: \"Produtividade máxima validada\", type: \"number\" },\n    { key: \"required_categories\", label: \"Categorias Obrigatórias\", description: \"Categorias separadas por vírgula (ex: sementes,fertilizantes)\", type: \"text\" },\n  ];\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle>Configurações Barter</CardTitle>\n        <CardDescription>Configure os parâmetros globais do sistema barter</CardDescription>\n      </CardHeader>\n      <CardContent className=\"space-y-6\">\n        {isLoading ? (\n          <p className=\"text-center py-8\">Carregando configurações...</p>\n        ) : (\n          settingsConfig.map((config) => {\n            const currentSetting = barterSettings?.find((s: any) => s.key === config.key);\n            const value = settings[config.key] !== undefined ? settings[config.key] : currentSetting?.value || \"\";\n\n            return (\n              <div key={config.key} className=\"flex items-end gap-4\">\n                <div className=\"flex-1 space-y-2\">\n                  <Label htmlFor={config.key}>{config.label}</Label>\n                  <Input\n                    id={config.key}\n                    type={config.type}\n                    value={value}\n                    onChange={(e) => setSettings({ ...settings, [config.key]: e.target.value })}\n                    placeholder={currentSetting?.value || \"Não configurado\"}\n                    data-testid={`input-setting-${config.key}`}\n                  />\n                  <p className=\"text-sm text-muted-foreground\">{config.description}</p>\n                </div>\n                <Button\n                  onClick={() => {\n                    updateSettingMutation.mutate({\n                      key: config.key,\n                      value: settings[config.key] || currentSetting?.value || '',\n                      description: config.description,\n                    });\n                  }}\n                  disabled={updateSettingMutation.isPending}\n                  data-testid={`button-save-setting-${config.key}`}\n                >\n                  <Save size={16} className=\"mr-2\" />\n                  Salvar\n                </Button>\n              </div>\n            );\n          })\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction TimacManagement() {\n  const [activeSubTab, setActiveSubTab] = useState(\"values\");\n\n  return (\n    <Tabs value={activeSubTab} onValueChange={setActiveSubTab} className=\"space-y-4\">\n      <TabsList className=\"grid w-full grid-cols-2 max-w-xl\">\n        <TabsTrigger value=\"values\">Valores por Tipo</TabsTrigger>\n        <TabsTrigger value=\"points\">Pontos dos Produtos</TabsTrigger>\n      </TabsList>\n\n      <TabsContent value=\"values\">\n        <TimacValuesManagement />\n      </TabsContent>\n\n      <TabsContent value=\"points\">\n        <TimacProductPointsManagement />\n      </TabsContent>\n    </Tabs>\n  );\n}\n\nfunction TimacValuesManagement() {\n  const { toast } = useToast();\n  const [values, setValues] = useState({\n    consultorValue: \"\",\n    gerentesValue: \"\",\n    faturistasValue: \"\"\n  });\n\n  const { data: settings, isLoading } = useQuery<any>({\n    queryKey: ['/api/admin/timac-settings'],\n  });\n\n  const updateSettingsMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return apiRequest(\"PUT\", \"/api/admin/timac-settings\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/timac-settings'] });\n      toast({\n        title: \"Valores atualizados\",\n        description: \"Os valores por tipo de usuário foram atualizados com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao atualizar valores. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Update local state when settings load\n  useEffect(() => {\n    if (settings) {\n      setValues({\n        consultorValue: settings.consultorValue || \"\",\n        gerentesValue: settings.gerentesValue || \"\",\n        faturistasValue: settings.faturistasValue || \"\"\n      });\n    }\n  }, [settings]);\n\n  const handleSave = () => {\n    updateSettingsMutation.mutate({\n      consultorValue: values.consultorValue,\n      gerentesValue: values.gerentesValue,\n      faturistasValue: values.faturistasValue\n    });\n  };\n\n  if (isLoading) {\n    return <div className=\"text-center py-8\">Carregando configurações...</div>;\n  }\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle>Valores por Tipo de Usuário</CardTitle>\n        <CardDescription>\n          Configure o valor em USD de cada ponto Timac para cada tipo de usuário\n        </CardDescription>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        <div className=\"space-y-4 max-w-md\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"consultor-value\">Valor para Consultor (USD por ponto)</Label>\n            <Input\n              id=\"consultor-value\"\n              type=\"number\"\n              step=\"0.01\"\n              value={values.consultorValue}\n              onChange={(e) => setValues({ ...values, consultorValue: e.target.value })}\n              placeholder=\"0.76\"\n              data-testid=\"input-consultor-value\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"gerentes-value\">Valor para Gerentes (USD por ponto)</Label>\n            <Input\n              id=\"gerentes-value\"\n              type=\"number\"\n              step=\"0.01\"\n              value={values.gerentesValue}\n              onChange={(e) => setValues({ ...values, gerentesValue: e.target.value })}\n              placeholder=\"0.76\"\n              data-testid=\"input-gerentes-value\"\n            />\n          </div>\n\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"faturistas-value\">Valor para Faturistas (USD por ponto)</Label>\n            <Input\n              id=\"faturistas-value\"\n              type=\"number\"\n              step=\"0.01\"\n              value={values.faturistasValue}\n              onChange={(e) => setValues({ ...values, faturistasValue: e.target.value })}\n              placeholder=\"0.76\"\n              data-testid=\"input-faturistas-value\"\n            />\n          </div>\n\n          <Button \n            onClick={handleSave} \n            disabled={updateSettingsMutation.isPending}\n            data-testid=\"button-save-timac-values\"\n          >\n            <Save size={16} className=\"mr-2\" />\n            Salvar Valores\n          </Button>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction TimacProductPointsManagement() {\n  const { toast } = useToast();\n  const [editingProduct, setEditingProduct] = useState<string | null>(null);\n  const [editPoints, setEditPoints] = useState(\"\");\n  const [showNewProductModal, setShowNewProductModal] = useState(false);\n  const [newProductData, setNewProductData] = useState({\n    name: \"\",\n    marca: \"Timac Agro\",\n    timacPoints: \"1\",\n    description: \"\"\n  });\n\n  const { data: products, isLoading } = useQuery<Product[]>({\n    queryKey: ['/api/products'],\n  });\n\n  const createProductMutation = useMutation({\n    mutationFn: async (productData: any) => {\n      return apiRequest(\"POST\", \"/api/products\", {\n        name: productData.name,\n        categoryId: \"cat-especialidades\",\n        marca: productData.marca,\n        timacPoints: productData.timacPoints,\n        description: productData.description || null,\n        isActive: true\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/products'] });\n      toast({\n        title: \"Produto criado\",\n        description: \"O produto Timac foi criado com sucesso.\",\n      });\n      setShowNewProductModal(false);\n      setNewProductData({\n        name: \"\",\n        marca: \"Timac Agro\",\n        timacPoints: \"1\",\n        description: \"\"\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao criar produto. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updatePointsMutation = useMutation({\n    mutationFn: async ({ id, timacPoints }: { id: string; timacPoints: string }) => {\n      return apiRequest(\"PATCH\", `/api/admin/products/${id}/timac-points`, { timacPoints });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/products'] });\n      toast({\n        title: \"Pontos atualizados\",\n        description: \"Os pontos Timac do produto foram atualizados com sucesso.\",\n      });\n      setEditingProduct(null);\n      setEditPoints(\"\");\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao atualizar pontos. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const startEdit = (product: Product) => {\n    setEditingProduct(product.id);\n    setEditPoints(product.timacPoints || \"0\");\n  };\n\n  const handleSave = (productId: string) => {\n    updatePointsMutation.mutate({\n      id: productId,\n      timacPoints: editPoints\n    });\n  };\n\n  const handleCreateProduct = () => {\n    if (!newProductData.name.trim()) {\n      toast({\n        title: \"Campo obrigatório\",\n        description: \"O nome do produto é obrigatório.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    createProductMutation.mutate(newProductData);\n  };\n\n  if (isLoading) {\n    return <div className=\"text-center py-8\">Carregando produtos...</div>;\n  }\n\n  // Filter products: only Timac brand AND Especialidades category\n  const timacProducts = products?.filter(product => {\n    const isTimacBrand = product.marca?.toLowerCase().includes('timac');\n    const isEspecialidades = product.categoryId === 'cat-especialidades';\n    return isTimacBrand && isEspecialidades;\n  }) || [];\n\n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex justify-between items-start\">\n          <div>\n            <CardTitle>Pontos Timac dos Produtos</CardTitle>\n            <CardDescription>\n              Configure quantos pontos Timac cada produto gera (apenas produtos Timac da categoria Especialidades)\n            </CardDescription>\n          </div>\n          <Dialog open={showNewProductModal} onOpenChange={setShowNewProductModal}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"button-add-timac-product\">\n                <Plus size={16} className=\"mr-2\" />\n                Adicionar Produto Timac\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"sm:max-w-[500px]\">\n              <DialogHeader>\n                <DialogTitle>Adicionar Produto Timac</DialogTitle>\n                <DialogDescription>\n                  Cadastre um novo produto Timac para calcular pontos\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"space-y-4 py-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"product-name\">Nome do Produto *</Label>\n                  <Input\n                    id=\"product-name\"\n                    value={newProductData.name}\n                    onChange={(e) => setNewProductData({ ...newProductData, name: e.target.value })}\n                    placeholder=\"Ex: FERTIACTYL LEGUMINOSAS\"\n                    data-testid=\"input-product-name\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"product-marca\">Marca</Label>\n                  <Input\n                    id=\"product-marca\"\n                    value={newProductData.marca}\n                    onChange={(e) => setNewProductData({ ...newProductData, marca: e.target.value })}\n                    placeholder=\"Timac Agro\"\n                    data-testid=\"input-product-marca\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"product-points\">Pontos Timac por Unidade *</Label>\n                  <Input\n                    id=\"product-points\"\n                    type=\"number\"\n                    step=\"0.01\"\n                    value={newProductData.timacPoints}\n                    onChange={(e) => setNewProductData({ ...newProductData, timacPoints: e.target.value })}\n                    placeholder=\"1\"\n                    data-testid=\"input-product-points\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"product-description\">Descrição (opcional)</Label>\n                  <Input\n                    id=\"product-description\"\n                    value={newProductData.description}\n                    onChange={(e) => setNewProductData({ ...newProductData, description: e.target.value })}\n                    placeholder=\"Informações adicionais\"\n                    data-testid=\"input-product-description\"\n                  />\n                </div>\n              </div>\n              <DialogFooter>\n                <Button\n                  variant=\"outline\"\n                  onClick={() => setShowNewProductModal(false)}\n                  data-testid=\"button-cancel-product\"\n                >\n                  Cancelar\n                </Button>\n                <Button\n                  onClick={handleCreateProduct}\n                  disabled={createProductMutation.isPending}\n                  data-testid=\"button-save-product\"\n                >\n                  {createProductMutation.isPending && <Loader2 size={16} className=\"mr-2 animate-spin\" />}\n                  Criar Produto\n                </Button>\n              </DialogFooter>\n            </DialogContent>\n          </Dialog>\n        </div>\n      </CardHeader>\n      <CardContent>\n        <div className=\"rounded-md border\">\n          <table className=\"w-full\">\n            <thead className=\"bg-muted/50\">\n              <tr>\n                <th className=\"px-4 py-3 text-left text-sm font-medium\">Produto</th>\n                <th className=\"px-4 py-3 text-left text-sm font-medium\">Marca</th>\n                <th className=\"px-4 py-3 text-left text-sm font-medium\">Pontos Timac</th>\n                <th className=\"px-4 py-3 text-right text-sm font-medium\">Ações</th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y\">\n              {timacProducts.length === 0 ? (\n                <tr>\n                  <td colSpan={4} className=\"px-4 py-8 text-center text-sm text-muted-foreground\">\n                    Nenhum produto Timac da categoria Especialidades encontrado\n                  </td>\n                </tr>\n              ) : (\n                timacProducts.map((product) => (\n                  <tr key={product.id} className=\"hover:bg-muted/50\">\n                    <td className=\"px-4 py-3 text-sm\">{product.name}</td>\n                    <td className=\"px-4 py-3 text-sm text-muted-foreground\">{product.marca || \"-\"}</td>\n                    <td className=\"px-4 py-3 text-sm\">\n                      {editingProduct === product.id ? (\n                        <Input\n                          type=\"number\"\n                          step=\"0.01\"\n                          value={editPoints}\n                          onChange={(e) => setEditPoints(e.target.value)}\n                          className=\"w-32\"\n                          data-testid={`input-points-${product.id}`}\n                        />\n                      ) : (\n                        <span className=\"font-medium\">{product.timacPoints || \"0\"}</span>\n                      )}\n                    </td>\n                    <td className=\"px-4 py-3 text-right\">\n                      {editingProduct === product.id ? (\n                        <div className=\"flex justify-end gap-2\">\n                          <Button\n                            size=\"sm\"\n                            onClick={() => handleSave(product.id)}\n                            disabled={updatePointsMutation.isPending}\n                            data-testid={`button-save-points-${product.id}`}\n                          >\n                            <Save size={14} className=\"mr-1\" />\n                            Salvar\n                          </Button>\n                          <Button\n                            size=\"sm\"\n                            variant=\"outline\"\n                            onClick={() => {\n                              setEditingProduct(null);\n                              setEditPoints(\"\");\n                            }}\n                            data-testid={`button-cancel-points-${product.id}`}\n                          >\n                            <X size={14} className=\"mr-1\" />\n                            Cancelar\n                          </Button>\n                        </div>\n                      ) : (\n                        <Button\n                          size=\"sm\"\n                          variant=\"outline\"\n                          onClick={() => startEdit(product)}\n                          data-testid={`button-edit-points-${product.id}`}\n                        >\n                          <Edit size={14} className=\"mr-1\" />\n                          Editar\n                        </Button>\n                      )}\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}\n\n\nfunction SeasonsManagement() {\n  const { toast } = useToast();\n  const [showNewSeasonModal, setShowNewSeasonModal] = useState(false);\n  const [formData, setFormData] = useState({\n    name: \"\",\n    type: \"\",\n    year: new Date().getFullYear(),\n    startDate: \"\",\n    endDate: \"\",\n  });\n\n  const { data: seasons, isLoading } = useQuery<Season[]>({\n    queryKey: [\"/api/seasons\"],\n  });\n\n  const createSeasonMutation = useMutation({\n    mutationFn: async (seasonData: InsertSeason) => {\n      return apiRequest(\"POST\", \"/api/seasons\", seasonData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/seasons\"] });\n      toast({\n        title: \"Safra cadastrada\",\n        description: \"A safra foi cadastrada com sucesso.\",\n      });\n      setShowNewSeasonModal(false);\n      resetForm();\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao cadastrar safra. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      name: \"\",\n      type: \"\",\n      year: new Date().getFullYear(),\n      startDate: \"\",\n      endDate: \"\",\n    });\n  };\n\n  const generateSeasonName = (type: string, year: number) => {\n    switch (type) {\n      case \"soja_verao\":\n        return `Soja ${year % 100}/${(year + 1) % 100}`;\n      case \"soja_safrinha\":\n        return `Soja Safrinha ${year}`;\n      case \"milho\":\n        return `Milho ${year % 100}/${year % 100}`;\n      case \"trigo\":\n        return `Trigo ${year}`;\n      default:\n        return `Safra ${year}`;\n    }\n  };\n\n  const handleTypeChange = (type: string) => {\n    setFormData(prev => ({\n      ...prev,\n      type,\n      name: generateSeasonName(type, prev.year),\n    }));\n  };\n\n  const handleYearChange = (year: string) => {\n    const yearNum = parseInt(year);\n    setFormData(prev => ({\n      ...prev,\n      year: yearNum,\n      name: prev.type ? generateSeasonName(prev.type, yearNum) : \"\",\n    }));\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    if (!formData.name || !formData.type || !formData.startDate || !formData.endDate) {\n      toast({\n        title: \"Campos obrigatórios\",\n        description: \"Preencha todos os campos obrigatórios.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const seasonData: InsertSeason = {\n      name: formData.name,\n      type: formData.type,\n      year: formData.year,\n      startDate: new Date(formData.startDate),\n      endDate: new Date(formData.endDate),\n      isActive: true,\n    };\n\n    createSeasonMutation.mutate(seasonData);\n  };\n\n  const getTypeLabel = (type: string) => {\n    switch (type) {\n      case \"soja_verao\": return \"Soja Verão\";\n      case \"soja_safrinha\": return \"Soja Safrinha\";\n      case \"milho\": return \"Milho\";\n      case \"trigo\": return \"Trigo\";\n      default: return type;\n    }\n  };\n\n  const getTypeBadgeClass = (type: string) => {\n    switch (type) {\n      case \"soja_verao\": return \"bg-verde/10 text-verde border-verde/20\";\n      case \"soja_safrinha\": return \"bg-chart-2/10 text-chart-2 border-chart-2/20\";\n      case \"milho\": return \"bg-amarela/10 text-amarela border-amarela/20\";\n      case \"trigo\": return \"bg-chart-4/10 text-chart-4 border-chart-4/20\";\n      default: return \"bg-muted text-muted-foreground\";\n    }\n  };\n\n  const getSeasonProgress = (season: Season) => {\n    const now = new Date();\n    const start = new Date(season.startDate);\n    const end = new Date(season.endDate);\n    \n    if (now < start) return 0;\n    if (now > end) return 100;\n    \n    const total = end.getTime() - start.getTime();\n    const elapsed = now.getTime() - start.getTime();\n    return Math.round((elapsed / total) * 100);\n  };\n\n  const totalSeasons = seasons?.length || 0;\n  const activeSeasons = seasons?.filter(s => s.isActive).length || 0;\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h2 className=\"text-2xl font-bold\">Gestão de Safras</h2>\n          <p className=\"text-muted-foreground\">Controle de safras e períodos de plantio</p>\n        </div>\n        <Dialog open={showNewSeasonModal} onOpenChange={setShowNewSeasonModal}>\n          <DialogTrigger asChild>\n            <Button data-testid=\"button-new-season\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Nova Safra\n            </Button>\n          </DialogTrigger>\n          <DialogContent className=\"max-w-2xl\" data-testid=\"new-season-modal\">\n            <DialogHeader>\n              <DialogTitle>Nova Safra</DialogTitle>\n            </DialogHeader>\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"type\">Tipo de Safra *</Label>\n                  <Select value={formData.type} onValueChange={handleTypeChange}>\n                    <SelectTrigger data-testid=\"select-season-type\">\n                      <SelectValue placeholder=\"Selecione o tipo\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"soja_verao\">Soja Verão</SelectItem>\n                      <SelectItem value=\"soja_safrinha\">Soja Safrinha</SelectItem>\n                      <SelectItem value=\"milho\">Milho</SelectItem>\n                      <SelectItem value=\"trigo\">Trigo</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div>\n                  <Label htmlFor=\"year\">Ano *</Label>\n                  <Input\n                    type=\"number\"\n                    min=\"2020\"\n                    max=\"2030\"\n                    value={formData.year}\n                    onChange={(e) => handleYearChange(e.target.value)}\n                    data-testid=\"input-year\"\n                  />\n                </div>\n              </div>\n\n              <div>\n                <Label htmlFor=\"name\">Nome da Safra *</Label>\n                <Input\n                  value={formData.name}\n                  onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}\n                  placeholder=\"Ex: Soja 25/26\"\n                  data-testid=\"input-season-name\"\n                />\n              </div>\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <Label htmlFor=\"startDate\">Data de Início *</Label>\n                  <Input\n                    type=\"date\"\n                    value={formData.startDate}\n                    onChange={(e) => setFormData(prev => ({ ...prev, startDate: e.target.value }))}\n                    data-testid=\"input-start-date\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"endDate\">Data de Fim *</Label>\n                  <Input\n                    type=\"date\"\n                    value={formData.endDate}\n                    onChange={(e) => setFormData(prev => ({ ...prev, endDate: e.target.value }))}\n                    data-testid=\"input-end-date\"\n                  />\n                </div>\n              </div>\n\n              <div className=\"flex justify-end gap-2\">\n                <Button type=\"button\" variant=\"outline\" onClick={() => setShowNewSeasonModal(false)}>\n                  Cancelar\n                </Button>\n                <Button type=\"submit\" disabled={createSeasonMutation.isPending}>\n                  {createSeasonMutation.isPending ? \"Cadastrando...\" : \"Cadastrar Safra\"}\n                </Button>\n              </div>\n            </form>\n          </DialogContent>\n        </Dialog>\n      </div>\n\n      <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n        <Card className=\"shadow-sm\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center\">\n                <Calendar className=\"text-primary\" size={24} />\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Total de Safras</p>\n                <p className=\"text-2xl font-bold\">{totalSeasons}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"shadow-sm\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"w-12 h-12 bg-verde/10 rounded-lg flex items-center justify-center\">\n                <Sprout className=\"text-verde\" size={24} />\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Safras Ativas</p>\n                <p className=\"text-2xl font-bold\">{activeSeasons}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"shadow-sm\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                <Target className=\"text-chart-2\" size={24} />\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Ano Agrícola</p>\n                <p className=\"text-2xl font-bold\">{new Date().getFullYear()}/{new Date().getFullYear() + 1}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      <Card className=\"shadow-sm\">\n        <CardHeader>\n          <CardTitle>Lista de Safras</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {seasons?.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <p className=\"text-muted-foreground\">Nenhuma safra cadastrada</p>\n              <Button \n                onClick={() => setShowNewSeasonModal(true)} \n                className=\"mt-4\"\n                data-testid=\"button-first-season\"\n              >\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Cadastrar primeira safra\n              </Button>\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Nome</TableHead>\n                    <TableHead>Tipo</TableHead>\n                    <TableHead>Ano</TableHead>\n                    <TableHead>Período</TableHead>\n                    <TableHead>Progresso</TableHead>\n                    <TableHead className=\"text-center\">Status</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {seasons?.map((season) => {\n                    const progress = getSeasonProgress(season);\n                    const isActive = progress > 0 && progress < 100;\n                    \n                    return (\n                      <TableRow key={season.id} data-testid={`season-row-${season.id}`}>\n                        <TableCell className=\"font-medium\">{season.name}</TableCell>\n                        <TableCell>\n                          <Badge className={getTypeBadgeClass(season.type)}>\n                            {getTypeLabel(season.type)}\n                          </Badge>\n                        </TableCell>\n                        <TableCell className=\"font-mono\">{season.year}</TableCell>\n                        <TableCell className=\"text-sm\">\n                          {format(new Date(season.startDate), \"dd/MM/yyyy\")} - {format(new Date(season.endDate), \"dd/MM/yyyy\")}\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"flex items-center gap-2\">\n                            <Progress value={progress} className=\"flex-1 h-2\" />\n                            <span className=\"text-sm text-muted-foreground min-w-[3rem]\">\n                              {progress}%\n                            </span>\n                          </div>\n                        </TableCell>\n                        <TableCell className=\"text-center\">\n                          <Badge variant={season.isActive ? \"default\" : \"secondary\"}>\n                            {season.isActive ? \"Ativa\" : \"Inativa\"}\n                          </Badge>\n                        </TableCell>\n                      </TableRow>\n                    );\n                  })}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\n\nfunction PriceTableManagement() {\n  const { toast } = useToast();\n  const [showAddModal, setShowAddModal] = useState(false);\n  const [editingProduct, setEditingProduct] = useState<any | null>(null);\n  const [importing, setImporting] = useState(false);\n  \n  const [formData, setFormData] = useState({\n    mercaderia: \"\",\n    principioAtivo: \"\",\n    categoria: \"FUNGICIDAS\",\n    subcategory: \"\",\n    dose: \"\",\n    fabricante: \"\",\n    precoVerde: \"\",\n    precoAmarela: \"\",\n    precoVermelha: \"\",\n    unidade: \"$/ha\"\n  });\n\n  const { data: products, isLoading } = useQuery<any[]>({\n    queryKey: ['/api/admin/price-table'],\n  });\n\n  const createProductMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const response = await apiRequest('POST', '/api/admin/price-table', data);\n      return response;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/price-table'] });\n      toast({\n        title: \"Sucesso!\",\n        description: \"Produto adicionado à tabela de preços\",\n      });\n      setShowAddModal(false);\n      resetForm();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Erro\",\n        description: error.message || \"Erro ao adicionar produto\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateProductMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string, data: any }) => {\n      const response = await apiRequest('PATCH', `/api/admin/price-table/${id}`, data);\n      return response;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/price-table'] });\n      toast({\n        title: \"Sucesso!\",\n        description: \"Produto atualizado\",\n      });\n      setEditingProduct(null);\n      resetForm();\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Erro\",\n        description: error.message || \"Erro ao atualizar produto\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteProductMutation = useMutation({\n    mutationFn: async (id: string) => {\n      const response = await apiRequest('DELETE', `/api/admin/price-table/${id}`);\n      return response;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/price-table'] });\n      toast({\n        title: \"Sucesso!\",\n        description: \"Produto excluído\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Erro\",\n        description: error.message || \"Erro ao excluir produto\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      mercaderia: \"\",\n      principioAtivo: \"\",\n      categoria: \"FUNGICIDAS\",\n      subcategory: \"\",\n      dose: \"\",\n      fabricante: \"\",\n      precoVerde: \"\",\n      precoAmarela: \"\",\n      precoVermelha: \"\",\n      unidade: \"$/ha\"\n    });\n  };\n\n  const handleSubmit = () => {\n    if (!formData.mercaderia || !formData.categoria) {\n      toast({\n        title: \"Erro\",\n        description: \"Preencha os campos obrigatórios\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    if (editingProduct) {\n      updateProductMutation.mutate({\n        id: editingProduct.id,\n        data: formData\n      });\n    } else {\n      createProductMutation.mutate(formData);\n    }\n  };\n\n  const handleEdit = (product: any) => {\n    setEditingProduct(product);\n    setFormData({\n      mercaderia: product.mercaderia || \"\",\n      principioAtivo: product.principioAtivo || \"\",\n      categoria: product.categoria || \"FUNGICIDAS\",\n      subcategory: product.subcategory || \"\",\n      dose: product.dose || \"\",\n      fabricante: product.fabricante || \"\",\n      precoVerde: product.precoVerde || \"\",\n      precoAmarela: product.precoAmarela || \"\",\n      precoVermelha: product.precoVermelha || \"\",\n      unidade: product.unidade || \"$/ha\"\n    });\n  };\n\n  const handleFileImport = async (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    setImporting(true);\n    const formData = new FormData();\n    formData.append('file', file);\n\n    try {\n      const response = await fetch('/api/admin/price-table/import', {\n        method: 'POST',\n        body: formData,\n        credentials: 'include'\n      });\n\n      const result = await response.json();\n\n      if (!response.ok) {\n        throw new Error(result.error || 'Erro ao importar planilha');\n      }\n\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/price-table'] });\n      \n      if (result.imported === 0 && result.errors && result.errors.length > 0) {\n        // Mostrar primeiro erro para diagnóstico\n        const firstError = result.errors[0];\n        toast({\n          title: \"Erro na importação\",\n          description: firstError.length > 200 ? firstError.substring(0, 200) + \"...\" : firstError,\n          variant: \"destructive\",\n        });\n        console.log('Erros de importação:', result.errors);\n      } else {\n        toast({\n          title: result.imported > 0 ? \"Importação concluída!\" : \"Nenhum produto importado\",\n          description: `${result.imported} produtos importados de ${result.totalRows} linhas.${result.errors ? ` ${result.errors.length} erros encontrados.` : ''}`,\n          variant: result.imported > 0 ? \"default\" : \"destructive\",\n        });\n\n        if (result.errors && result.errors.length > 0) {\n          console.log('Erros de importação:', result.errors);\n        }\n      }\n    } catch (error: any) {\n      toast({\n        title: \"Erro na importação\",\n        description: error.message || \"Erro ao importar planilha\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setImporting(false);\n      event.target.value = '';\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  const fungicidasProducts = products?.filter(p => p.categoria === \"FUNGICIDAS\") || [];\n  const inseticidasProducts = products?.filter(p => p.categoria === \"INSETICIDAS\") || [];\n  const otherProducts = products?.filter(p => ![\"FUNGICIDAS\", \"INSETICIDAS\"].includes(p.categoria)) || [];\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h2 className=\"text-2xl font-bold\">Tabela de Preços</h2>\n          <p className=\"text-muted-foreground\">Gestão de produtos e preços para manejo</p>\n        </div>\n        <div className=\"flex gap-2\">\n          <div>\n            <input\n              type=\"file\"\n              id=\"excel-import\"\n              accept=\".xlsx,.xls\"\n              onChange={handleFileImport}\n              style={{ display: 'none' }}\n              disabled={importing}\n            />\n            <Button\n              variant=\"outline\"\n              onClick={() => document.getElementById('excel-import')?.click()}\n              disabled={importing}\n              data-testid=\"button-import-excel\"\n            >\n              {importing ? (\n                <>\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  Importando...\n                </>\n              ) : (\n                <>\n                  <Upload className=\"h-4 w-4 mr-2\" />\n                  Importar Excel\n                </>\n              )}\n            </Button>\n          </div>\n          <Button onClick={() => setShowAddModal(true)} data-testid=\"button-add-product\">\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Adicionar Produto\n          </Button>\n        </div>\n      </div>\n\n      {fungicidasProducts.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Fungicidas ({fungicidasProducts.length})</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Mercadoria</TableHead>\n                  <TableHead>Subcategoria</TableHead>\n                  <TableHead>P.A</TableHead>\n                  <TableHead>Dose</TableHead>\n                  <TableHead>Fabricante</TableHead>\n                  <TableHead className=\"text-right\">Verde</TableHead>\n                  <TableHead className=\"text-right\">Amarela</TableHead>\n                  <TableHead className=\"text-right\">Vermelha</TableHead>\n                  <TableHead>Ações</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {fungicidasProducts.map((product) => (\n                  <TableRow key={product.id}>\n                    <TableCell className=\"font-medium\">{product.mercadoria}</TableCell>\n                    <TableCell>{product.subcategory ? <Badge variant=\"secondary\">{product.subcategory}</Badge> : \"-\"}</TableCell>\n                    <TableCell>{product.principioAtivo || \"-\"}</TableCell>\n                    <TableCell className=\"text-sm\">{product.dose || \"-\"}</TableCell>\n                    <TableCell>{product.fabricante || \"-\"}</TableCell>\n                    <TableCell className=\"text-right font-mono text-green-600\">${Number(product.precoVerde).toFixed(2)}</TableCell>\n                    <TableCell className=\"text-right font-mono text-yellow-600\">${Number(product.precoAmarela).toFixed(2)}</TableCell>\n                    <TableCell className=\"text-right font-mono text-red-600\">${Number(product.precoVermelha).toFixed(2)}</TableCell>\n                    <TableCell>\n                      <div className=\"flex gap-2\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => handleEdit(product)}\n                          data-testid={`button-edit-product-${product.id}`}\n                        >\n                          <Edit className=\"h-4 w-4\" />\n                        </Button>\n                        <AlertDialog>\n                          <AlertDialogTrigger asChild>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              data-testid={`button-delete-product-${product.id}`}\n                            >\n                              <Trash2 className=\"h-4 w-4\" />\n                            </Button>\n                          </AlertDialogTrigger>\n                          <AlertDialogContent>\n                            <AlertDialogHeader>\n                              <AlertDialogTitle>Confirmar Exclusão</AlertDialogTitle>\n                              <AlertDialogDescription>\n                                Tem certeza que deseja excluir o produto {product.mercaderia}?\n                              </AlertDialogDescription>\n                            </AlertDialogHeader>\n                            <AlertDialogFooter>\n                              <AlertDialogCancel>Cancelar</AlertDialogCancel>\n                              <AlertDialogAction\n                                onClick={() => deleteProductMutation.mutate(product.id)}\n                                className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n                              >\n                                Excluir\n                              </AlertDialogAction>\n                            </AlertDialogFooter>\n                          </AlertDialogContent>\n                        </AlertDialog>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      )}\n\n      {inseticidasProducts.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Inseticidas ({inseticidasProducts.length})</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Mercadoria</TableHead>\n                  <TableHead>Subcategoria</TableHead>\n                  <TableHead>P.A</TableHead>\n                  <TableHead>Dose</TableHead>\n                  <TableHead>Fabricante</TableHead>\n                  <TableHead className=\"text-right\">Verde</TableHead>\n                  <TableHead className=\"text-right\">Amarela</TableHead>\n                  <TableHead className=\"text-right\">Vermelha</TableHead>\n                  <TableHead>Ações</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {inseticidasProducts.map((product) => (\n                  <TableRow key={product.id}>\n                    <TableCell className=\"font-medium\">{product.mercaderia}</TableCell>\n                    <TableCell>{product.subcategory ? <Badge variant=\"secondary\">{product.subcategory}</Badge> : \"-\"}</TableCell>\n                    <TableCell>{product.principioAtivo || \"-\"}</TableCell>\n                    <TableCell className=\"text-sm\">{product.dose || \"-\"}</TableCell>\n                    <TableCell>{product.fabricante || \"-\"}</TableCell>\n                    <TableCell className=\"text-right font-mono text-green-600\">${Number(product.precoVerde).toFixed(2)}</TableCell>\n                    <TableCell className=\"text-right font-mono text-yellow-600\">${Number(product.precoAmarela).toFixed(2)}</TableCell>\n                    <TableCell className=\"text-right font-mono text-red-600\">${Number(product.precoVermelha).toFixed(2)}</TableCell>\n                    <TableCell>\n                      <div className=\"flex gap-2\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => handleEdit(product)}\n                          data-testid={`button-edit-product-${product.id}`}\n                        >\n                          <Edit className=\"h-4 w-4\" />\n                        </Button>\n                        <AlertDialog>\n                          <AlertDialogTrigger asChild>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              data-testid={`button-delete-product-${product.id}`}\n                            >\n                              <Trash2 className=\"h-4 w-4\" />\n                            </Button>\n                          </AlertDialogTrigger>\n                          <AlertDialogContent>\n                            <AlertDialogHeader>\n                              <AlertDialogTitle>Confirmar Exclusão</AlertDialogTitle>\n                              <AlertDialogDescription>\n                                Tem certeza que deseja excluir o produto {product.mercaderia}?\n                              </AlertDialogDescription>\n                            </AlertDialogHeader>\n                            <AlertDialogFooter>\n                              <AlertDialogCancel>Cancelar</AlertDialogCancel>\n                              <AlertDialogAction\n                                onClick={() => deleteProductMutation.mutate(product.id)}\n                                className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n                              >\n                                Excluir\n                              </AlertDialogAction>\n                            </AlertDialogFooter>\n                          </AlertDialogContent>\n                        </AlertDialog>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      )}\n\n      {otherProducts.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Outras Categorias ({otherProducts.length})</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <Table>\n              <TableHeader>\n                <TableRow>\n                  <TableHead>Mercadoria</TableHead>\n                  <TableHead>Categoria</TableHead>\n                  <TableHead>Subcategoria</TableHead>\n                  <TableHead>P.A</TableHead>\n                  <TableHead>Fabricante</TableHead>\n                  <TableHead className=\"text-right\">Verde</TableHead>\n                  <TableHead className=\"text-right\">Amarela</TableHead>\n                  <TableHead className=\"text-right\">Vermelha</TableHead>\n                  <TableHead>Ações</TableHead>\n                </TableRow>\n              </TableHeader>\n              <TableBody>\n                {otherProducts.map((product) => (\n                  <TableRow key={product.id}>\n                    <TableCell className=\"font-medium\">{product.mercaderia}</TableCell>\n                    <TableCell><Badge variant=\"outline\">{product.categoria}</Badge></TableCell>\n                    <TableCell>{product.subcategory ? <Badge variant=\"secondary\">{product.subcategory}</Badge> : \"-\"}</TableCell>\n                    <TableCell>{product.principioAtivo || \"-\"}</TableCell>\n                    <TableCell>{product.fabricante || \"-\"}</TableCell>\n                    <TableCell className=\"text-right font-mono text-green-600\">${Number(product.precoVerde).toFixed(2)}</TableCell>\n                    <TableCell className=\"text-right font-mono text-yellow-600\">${Number(product.precoAmarela).toFixed(2)}</TableCell>\n                    <TableCell className=\"text-right font-mono text-red-600\">${Number(product.precoVermelha).toFixed(2)}</TableCell>\n                    <TableCell>\n                      <div className=\"flex gap-2\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"icon\"\n                          onClick={() => handleEdit(product)}\n                          data-testid={`button-edit-product-${product.id}`}\n                        >\n                          <Edit className=\"h-4 w-4\" />\n                        </Button>\n                        <AlertDialog>\n                          <AlertDialogTrigger asChild>\n                            <Button\n                              variant=\"ghost\"\n                              size=\"icon\"\n                              data-testid={`button-delete-product-${product.id}`}\n                            >\n                              <Trash2 className=\"h-4 w-4\" />\n                            </Button>\n                          </AlertDialogTrigger>\n                          <AlertDialogContent>\n                            <AlertDialogHeader>\n                              <AlertDialogTitle>Confirmar Exclusão</AlertDialogTitle>\n                              <AlertDialogDescription>\n                                Tem certeza que deseja excluir o produto {product.mercaderia}?\n                              </AlertDialogDescription>\n                            </AlertDialogHeader>\n                            <AlertDialogFooter>\n                              <AlertDialogCancel>Cancelar</AlertDialogCancel>\n                              <AlertDialogAction\n                                onClick={() => deleteProductMutation.mutate(product.id)}\n                                className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n                              >\n                                Excluir\n                              </AlertDialogAction>\n                            </AlertDialogFooter>\n                          </AlertDialogContent>\n                        </AlertDialog>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                ))}\n              </TableBody>\n            </Table>\n          </CardContent>\n        </Card>\n      )}\n\n      {(!products || products.length === 0) && (\n        <Card>\n          <CardContent className=\"py-12 text-center\">\n            <p className=\"text-muted-foreground\">Nenhum produto cadastrado</p>\n            <Button onClick={() => setShowAddModal(true)} className=\"mt-4\">\n              <Plus className=\"h-4 w-4 mr-2\" />\n              Adicionar primeiro produto\n            </Button>\n          </CardContent>\n        </Card>\n      )}\n\n      <Dialog open={showAddModal || editingProduct !== null} onOpenChange={(open) => {\n        if (!open) {\n          setShowAddModal(false);\n          setEditingProduct(null);\n          resetForm();\n        }\n      }}>\n        <DialogContent className=\"max-w-2xl\">\n          <DialogHeader>\n            <DialogTitle>{editingProduct ? \"Editar Produto\" : \"Adicionar Produto\"}</DialogTitle>\n            <DialogDescription>\n              Configure os preços do produto para verde, amarela e vermelha\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"space-y-2\">\n              <Label>Mercadoria *</Label>\n              <Input\n                value={formData.mercaderia}\n                onChange={(e) => setFormData({ ...formData, mercaderia: e.target.value })}\n                placeholder=\"Nome do produto\"\n                data-testid=\"input-mercaderia\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Princípio Ativo</Label>\n              <Input\n                value={formData.principioAtivo}\n                onChange={(e) => setFormData({ ...formData, principioAtivo: e.target.value })}\n                placeholder=\"P.A\"\n                data-testid=\"input-principio-ativo\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Categoria *</Label>\n              <Select\n                value={formData.categoria}\n                onValueChange={(value) => setFormData({ ...formData, categoria: value })}\n              >\n                <SelectTrigger data-testid=\"select-categoria\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"FUNGICIDAS\">Fungicidas</SelectItem>\n                  <SelectItem value=\"INSETICIDAS\">Inseticidas</SelectItem>\n                  <SelectItem value=\"TS\">TS</SelectItem>\n                  <SelectItem value=\"DESSECAÇÃO\">Dessecação</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Subcategoria</Label>\n              <Select\n                value={formData.subcategory || undefined}\n                onValueChange={(value) => setFormData({ ...formData, subcategory: value })}\n              >\n                <SelectTrigger data-testid=\"select-subcategory\">\n                  <SelectValue placeholder=\"Selecione...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"Fungicidas\">Fungicidas</SelectItem>\n                  <SelectItem value=\"Inseticidas\">Inseticidas</SelectItem>\n                  <SelectItem value=\"TS\">TS</SelectItem>\n                  <SelectItem value=\"Dessecação\">Dessecação</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Dose</Label>\n              <Input\n                value={formData.dose}\n                onChange={(e) => setFormData({ ...formData, dose: e.target.value })}\n                placeholder=\"Ex: 1 L/Ha\"\n                data-testid=\"input-dose\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Fabricante</Label>\n              <Input\n                value={formData.fabricante}\n                onChange={(e) => setFormData({ ...formData, fabricante: e.target.value })}\n                placeholder=\"Nome do fabricante\"\n                data-testid=\"input-fabricante\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Unidade</Label>\n              <Select\n                value={formData.unidade}\n                onValueChange={(value) => setFormData({ ...formData, unidade: value })}\n              >\n                <SelectTrigger data-testid=\"select-unidade\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"$/ha\">$/ha</SelectItem>\n                  <SelectItem value=\"$/L/Ha\">$/L/Ha</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Preço Verde</Label>\n              <Input\n                type=\"number\"\n                step=\"0.01\"\n                value={formData.precoVerde}\n                onChange={(e) => setFormData({ ...formData, precoVerde: e.target.value })}\n                placeholder=\"0.00\"\n                data-testid=\"input-preco-verde\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Preço Amarela</Label>\n              <Input\n                type=\"number\"\n                step=\"0.01\"\n                value={formData.precoAmarela}\n                onChange={(e) => setFormData({ ...formData, precoAmarela: e.target.value })}\n                placeholder=\"0.00\"\n                data-testid=\"input-preco-amarela\"\n              />\n            </div>\n\n            <div className=\"space-y-2\">\n              <Label>Preço Vermelha</Label>\n              <Input\n                type=\"number\"\n                step=\"0.01\"\n                value={formData.precoVermelha}\n                onChange={(e) => setFormData({ ...formData, precoVermelha: e.target.value })}\n                placeholder=\"0.00\"\n                data-testid=\"input-preco-vermelha\"\n              />\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button\n              variant=\"outline\"\n              onClick={() => {\n                setShowAddModal(false);\n                setEditingProduct(null);\n                resetForm();\n              }}\n              data-testid=\"button-cancel-product\"\n            >\n              Cancelar\n            </Button>\n            <Button\n              onClick={handleSubmit}\n              disabled={createProductMutation.isPending || updateProductMutation.isPending}\n              data-testid=\"button-save-product\"\n            >\n              {(createProductMutation.isPending || updateProductMutation.isPending) ? \"Salvando...\" : \"Salvar\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n\nfunction SystemManagement() {\n  const { toast } = useToast();\n  const [allowRegistration, setAllowRegistration] = useState(true);\n\n  const { data: settings, isLoading } = useQuery<any>({\n    queryKey: ['/api/admin/system-settings'],\n  });\n\n  const updateSettingsMutation = useMutation({\n    mutationFn: async (data: { allowUserRegistration: boolean }) => {\n      return apiRequest(\"PATCH\", \"/api/admin/system-settings\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/admin/system-settings'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/system-settings'] });\n      toast({\n        title: \"Configurações atualizadas\",\n        description: \"As configurações do sistema foram atualizadas com sucesso.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao atualizar configurações. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Update local state when settings load\n  useEffect(() => {\n    if (settings) {\n      setAllowRegistration(settings.allowUserRegistration ?? true);\n    }\n  }, [settings]);\n\n  const handleToggleRegistration = (checked: boolean) => {\n    setAllowRegistration(checked);\n    updateSettingsMutation.mutate({ allowUserRegistration: checked });\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div>\n        <h2 className=\"text-2xl font-bold\">Configurações do Sistema</h2>\n        <p className=\"text-muted-foreground\">Gerencie as configurações globais do sistema</p>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Autenticação</CardTitle>\n          <CardDescription>Controle o acesso e cadastro de novos usuários</CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"space-y-0.5\">\n              <Label htmlFor=\"allow-registration\" className=\"text-base\">Permitir Cadastro de Novos Usuários</Label>\n              <p className=\"text-sm text-muted-foreground\">\n                Quando desabilitado, o botão \"Cadastre-se\" será removido da tela de login\n              </p>\n            </div>\n            <Switch\n              id=\"allow-registration\"\n              checked={allowRegistration}\n              onCheckedChange={handleToggleRegistration}\n              disabled={updateSettingsMutation.isPending}\n              data-testid=\"switch-allow-registration\"\n            />\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":186467},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","size_bytes":1251},"client/src/lib/manager-route.tsx":{"content":"import { useAuth } from \"@/hooks/use-auth\";\nimport { Loader2 } from \"lucide-react\";\nimport { Redirect, Route } from \"wouter\";\n\nexport function ManagerRoute({\n  path,\n  component: Component,\n}: {\n  path: string;\n  component: () => React.JSX.Element;\n}) {\n  const { user, isLoading } = useAuth();\n\n  if (isLoading) {\n    return (\n      <Route path={path}>\n        <div className=\"flex items-center justify-center min-h-screen\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-border\" />\n        </div>\n      </Route>\n    );\n  }\n\n  if (!user) {\n    return (\n      <Route path={path}>\n        <Redirect to=\"/auth\" />\n      </Route>\n    );\n  }\n\n  if (user.role !== 'gerente') {\n    return (\n      <Route path={path}>\n        <Redirect to=\"/dashboard\" />\n      </Route>\n    );\n  }\n\n  return <Route path={path} component={Component} />;\n}\n","size_bytes":840},"client/src/pages/manager.tsx":{"content":"import { useState, useEffect, useMemo } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Button } from '@/components/ui/button';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Users, TrendingUp, Target, ListChecks, ArrowLeft, Download, Plus, Edit, Trash2, Trash, Calendar, CheckCircle, FileDown, Settings, Loader2 } from 'lucide-react';\nimport { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest, queryClient } from '@/lib/queryClient';\nimport ManagerNavbar from '@/components/layout/manager-navbar';\nimport Header from '@/components/layout/header';\nimport { Badge } from '@/components/ui/badge';\nimport { Progress } from '@/components/ui/progress';\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from '@/components/ui/alert-dialog';\nimport jsPDF from 'jspdf';\nimport autoTable from 'jspdf-autotable';\nimport pptxgen from 'pptxgenjs';\nimport type { Season, SeasonGoal, InsertSeasonGoal } from '@shared/schema';\n\ninterface TeamData {\n  totalSales: number;\n  salesByCategory: Record<string, number>;\n  salesBySeason: Record<string, number>;\n  clientSales: Record<string, number>;\n  totalTimacPoints: number;\n  gerentesValue: string;\n  teamMembers: Array<{\n    id: string;\n    name: string;\n    totalSales: number;\n    timacPoints: number;\n  }>;\n}\n\nexport default function ManagerDashboard() {\n  const [activeTab, setActiveTab] = useState('dashboard');\n  const { toast } = useToast();\n\n  // Read hash from URL to determine active tab\n  useEffect(() => {\n    const hash = window.location.hash.replace('#', '');\n    if (hash && ['dashboard', 'team', 'action-plans', 'metas'].includes(hash)) {\n      setActiveTab(hash);\n    } else {\n      setActiveTab('dashboard');\n    }\n\n    const handleHashChange = () => {\n      const newHash = window.location.hash.replace('#', '');\n      if (newHash && ['dashboard', 'team', 'action-plans', 'metas'].includes(newHash)) {\n        setActiveTab(newHash);\n      } else {\n        setActiveTab('dashboard');\n      }\n    };\n\n    window.addEventListener('hashchange', handleHashChange);\n    return () => window.removeEventListener('hashchange', handleHashChange);\n  }, []);\n\n  const { data: teamData, isLoading } = useQuery<TeamData>({\n    queryKey: ['/api/manager/team-data'],\n  });\n\n  const exportToPDF = () => {\n    if (!teamData) return;\n\n    const doc = new jsPDF();\n    const pageWidth = doc.internal.pageSize.width;\n    \n    // Title\n    doc.setFontSize(20);\n    doc.text('Painel Gerente - Relatório Consolidado', pageWidth / 2, 15, { align: 'center' });\n    \n    // Date\n    doc.setFontSize(10);\n    doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, pageWidth / 2, 22, { align: 'center' });\n    \n    // Summary metrics\n    doc.setFontSize(12);\n    doc.text('Resumo Executivo', 14, 35);\n    \n    doc.setFontSize(10);\n    let yPos = 45;\n    doc.text(`Total de Vendas: $${teamData.totalSales.toLocaleString()}`, 14, yPos);\n    yPos += 7;\n    doc.text(`Pontos Timac: ${teamData.totalTimacPoints.toLocaleString()}`, 14, yPos);\n    yPos += 7;\n    doc.text(`Membros da Equipe: ${teamData.teamMembers.length}`, 14, yPos);\n    yPos += 15;\n    \n    // Team ranking table\n    doc.setFontSize(12);\n    doc.text('Ranking da Equipe', 14, yPos);\n    yPos += 5;\n    \n    const sortedMembers = [...teamData.teamMembers].sort((a, b) => b.totalSales - a.totalSales);\n    const tableData = sortedMembers.map((member, index) => {\n      const percentage = teamData.totalSales > 0 \n        ? ((member.totalSales / teamData.totalSales) * 100).toFixed(1)\n        : '0.0';\n      \n      return [\n        `${index + 1}º`,\n        member.name,\n        `$${member.totalSales.toLocaleString()}`,\n        `${percentage}%`,\n        member.timacPoints.toLocaleString(),\n      ];\n    });\n    \n    autoTable(doc, {\n      startY: yPos,\n      head: [['#', 'Consultor', 'Vendas', '% Total', 'Pontos Timac']],\n      body: tableData,\n      theme: 'grid',\n      headStyles: { fillColor: [34, 197, 94] },\n    });\n    \n    // Save PDF\n    doc.save(`painel-gerente-${new Date().toISOString().split('T')[0]}.pdf`);\n    \n    toast({\n      title: 'PDF exportado',\n      description: 'O relatório foi baixado com sucesso.',\n    });\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex h-screen items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-32 w-32 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex flex-col h-screen overflow-hidden\" data-testid=\"manager-dashboard-container\">\n      <Header />\n      <ManagerNavbar activeTab={activeTab} onTabChange={setActiveTab} />\n      \n      <main className=\"flex-1 overflow-y-auto\">\n        <div className=\"p-8\">\n          {activeTab === 'dashboard' && (\n            <div className=\"space-y-6\">\n              <div className=\"flex items-center justify-end\">\n                <Button onClick={exportToPDF} variant=\"outline\" data-testid=\"button-export-pdf\">\n                  <Download className=\"h-4 w-4 mr-2\" />\n                  Exportar PDF\n                </Button>\n              </div>\n              <DashboardTab teamData={teamData} />\n            </div>\n          )}\n\n          {activeTab === 'team' && <TeamTab teamData={teamData} />}\n\n          {activeTab === 'action-plans' && <ActionPlansTab />}\n\n          {activeTab === 'metas' && <ManagerGoalsTab />}\n        </div>\n      </main>\n    </div>\n  );\n}\n\nfunction DashboardTab({ teamData }: { teamData?: TeamData }) {\n  const [season1, setSeason1] = useState<string>('');\n  const [season2, setSeason2] = useState<string>('');\n  const [season3, setSeason3] = useState<string>('');\n\n  const { data: seasons } = useQuery<any[]>({\n    queryKey: ['/api/seasons'],\n  });\n\n  const { data: salesEvolution } = useQuery<any[]>({\n    queryKey: ['/api/manager/team-sales-evolution'],\n  });\n\n  const { data: teamGoals } = useQuery<any[]>({\n    queryKey: ['/api/manager/team-goals'],\n  });\n\n  if (!teamData) {\n    return <div className=\"text-center py-8 text-muted-foreground\">Nenhum dado disponível</div>;\n  }\n\n  const formatCurrency = (value: number) => {\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: 'USD',\n      minimumFractionDigits: 2,\n    }).format(value);\n  };\n\n  const topCategories = Object.entries(teamData.salesByCategory)\n    .sort(([, a], [, b]) => b - a)\n    .slice(0, 5);\n\n  const topClients = Object.entries(teamData.clientSales)\n    .sort(([, a], [, b]) => b - a)\n    .slice(0, 10);\n\n  const timacValue = teamData.totalTimacPoints * parseFloat(teamData.gerentesValue || '0');\n  \n  // Helper to get text color for deviation based on performance\n  const getDeviationColor = (deviation: number) => {\n    if (deviation > 0) return 'text-green-600 font-semibold';\n    if (deviation < 0) return 'text-red-600 font-semibold';\n    return 'text-yellow-600 font-semibold';\n  };\n\n  // Transform sales evolution data for multi-line chart\n  const chartData = useMemo(() => {\n    if (!salesEvolution || salesEvolution.length === 0) return [];\n    \n    // Group by month\n    const monthlyData: Record<string, any> = {};\n    \n    salesEvolution.forEach((item: any) => {\n      const month = item.month;\n      const category = item.category || 'Outros';\n      const amount = parseFloat(item.totalAmount || '0');\n      \n      if (!monthlyData[month]) {\n        monthlyData[month] = { month };\n      }\n      \n      monthlyData[month][category] = amount;\n    });\n    \n    return Object.values(monthlyData).sort((a: any, b: any) => a.month.localeCompare(b.month));\n  }, [salesEvolution]);\n\n  // Get all unique categories for the legend\n  const categories = useMemo(() => {\n    const cats = new Set<string>();\n    salesEvolution?.forEach((item: any) => {\n      const category = item.category || 'Outros';\n      cats.add(category);\n    });\n    return Array.from(cats);\n  }, [salesEvolution]);\n\n  // Category color mapping\n  const categoryColors: Record<string, string> = {\n    'Fertilizantes': '#22c55e',      // Green\n    'Especialidades': '#3b82f6',     // Blue\n    'Agroquímicos': '#ef4444',       // Red\n    'Sementes': '#eab308',           // Yellow\n    'Sementes Soja': '#eab308',      // Yellow\n    'Sementes Milho': '#f59e0b',     // Amber\n    'Sementes Diversas': '#fbbf24',  // Light Yellow\n    'Sementes Trigo': '#f97316',     // Orange\n    'Corretivos': '#8b5cf6',         // Purple\n    'Outros': '#6b7280',             // Gray\n  };\n\n  // Calculate goal progress for active season\n  const activeSeason = seasons?.find(s => s.isActive);\n  const activeSeasonGoal = teamGoals?.find(g => g.seasonId === activeSeason?.id);\n  const goalAmount = activeSeasonGoal ? parseFloat(activeSeasonGoal.totalGoal || '0') : 0;\n  const goalProgress = goalAmount > 0 ? (teamData.totalSales / goalAmount) * 100 : 0;\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total de Vendas</CardTitle>\n            <TrendingUp className=\"h-4 w-4 text-green-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"total-sales\">\n              {formatCurrency(teamData.totalSales)}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">Consolidado da equipe</p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Pontos Timac</CardTitle>\n            <Target className=\"h-4 w-4 text-blue-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"total-timac-points\">\n              {teamData.totalTimacPoints.toLocaleString()}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              Valor: {formatCurrency(timacValue)}\n            </p>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Membros da Equipe</CardTitle>\n            <Users className=\"h-4 w-4 text-purple-600\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\" data-testid=\"team-size\">\n              {teamData.teamMembers.length}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">Consultores ativos</p>\n          </CardContent>\n        </Card>\n\n        <SoybeanPriceCard />\n      </div>\n\n      {/* Market Penetration Analysis */}\n      <MarketPenetrationTab season1={season1} season2={season2} season3={season3} setSeason1={setSeason1} setSeason2={setSeason2} setSeason3={setSeason3} />\n\n      {/* Captured Targets by Team */}\n      <CapturedTargetsCard />\n\n      {/* Sales Evolution Chart */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Evolução de Vendas da Equipe</CardTitle>\n          <CardDescription>Vendas mensais por segmento</CardDescription>\n        </CardHeader>\n        <CardContent>\n          {chartData.length > 0 ? (\n            <ResponsiveContainer width=\"100%\" height={400}>\n              <LineChart data={chartData}>\n                <CartesianGrid strokeDasharray=\"3 3\" />\n                <XAxis dataKey=\"month\" />\n                <YAxis />\n                <Tooltip formatter={(value: number) => formatCurrency(value)} />\n                <Legend />\n                {categories.map((category) => (\n                  <Line\n                    key={category}\n                    type=\"monotone\"\n                    dataKey={category}\n                    stroke={categoryColors[category] || '#6b7280'}\n                    strokeWidth={2}\n                    name={category}\n                    connectNulls\n                  />\n                ))}\n              </LineChart>\n            </ResponsiveContainer>\n          ) : (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              Dados de evolução disponíveis quando houver vendas\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Goal vs Achieved */}\n      {goalAmount > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Meta vs Realizado</CardTitle>\n            <CardDescription>{activeSeason?.name || 'Safra Ativa'}</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <p className=\"text-sm text-muted-foreground\">Meta da Equipe</p>\n                  <p className=\"text-2xl font-bold\">{formatCurrency(goalAmount)}</p>\n                </div>\n                <div className=\"text-right\">\n                  <p className=\"text-sm text-muted-foreground\">Realizado</p>\n                  <p className=\"text-2xl font-bold text-primary\">{formatCurrency(teamData.totalSales)}</p>\n                </div>\n              </div>\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between text-sm\">\n                  <span>Progresso</span>\n                  <span className=\"font-medium\">{goalProgress.toFixed(1)}%</span>\n                </div>\n                <div className=\"w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4\">\n                  <div \n                    className={`h-4 rounded-full transition-all ${goalProgress >= 100 ? 'bg-green-600' : 'bg-primary'}`}\n                    style={{ width: `${Math.min(goalProgress, 100)}%` }}\n                  ></div>\n                </div>\n                <div className=\"flex items-center justify-between text-xs text-muted-foreground\">\n                  <span>Falta: {formatCurrency(Math.max(goalAmount - teamData.totalSales, 0))}</span>\n                  {goalProgress >= 100 && <span className=\"text-green-600 font-medium\">✓ Meta atingida!</span>}\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Top Categories & Top Clients */}\n      <div className=\"grid gap-6 md:grid-cols-2\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Top 5 Categorias</CardTitle>\n            <CardDescription>Vendas por categoria</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              {topCategories.map(([category, amount]) => (\n                <div key={category} className=\"flex items-center justify-between\">\n                  <span className=\"text-sm font-medium\">{category}</span>\n                  <span className=\"text-sm font-bold\">{formatCurrency(amount)}</span>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Top 10 Clientes</CardTitle>\n            <CardDescription>Clientes com maior volume</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              {topClients.map(([client, amount]) => (\n                <div key={client} className=\"flex items-center justify-between\">\n                  <span className=\"text-sm font-medium truncate\">{client}</span>\n                  <span className=\"text-sm font-bold\">{formatCurrency(amount)}</span>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n\nfunction SoybeanPriceCard() {\n  const { data: priceData, isLoading } = useQuery<any>({\n    queryKey: ['/api/commodity/soybean'],\n    refetchInterval: 60000, // Refetch every 60 seconds\n  });\n\n  const formatPrice = (price: number) => {\n    return new Intl.NumberFormat('en-US', {\n      style: 'currency',\n      currency: 'USD',\n      minimumFractionDigits: 2,\n      maximumFractionDigits: 2,\n    }).format(price);\n  };\n\n  return (\n    <Card>\n      <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n        <CardTitle className=\"text-sm font-medium\">Preço Soja (Bushel)</CardTitle>\n        <TrendingUp className=\"h-4 w-4 text-orange-600\" />\n      </CardHeader>\n      <CardContent>\n        {isLoading ? (\n          <div className=\"text-2xl font-bold text-muted-foreground\">Carregando...</div>\n        ) : priceData ? (\n          <>\n            <div className=\"text-2xl font-bold\" data-testid=\"soybean-price\">\n              {formatPrice(priceData.price)}\n            </div>\n            <p className=\"text-xs text-muted-foreground mt-1\">\n              CME/CBOT • Tempo Real\n            </p>\n          </>\n        ) : (\n          <div className=\"text-sm text-muted-foreground\">Dados indisponíveis</div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction MarketPenetrationTab({\n  season1,\n  season2,\n  season3,\n  setSeason1,\n  setSeason2,\n  setSeason3,\n}: {\n  season1: string;\n  season2: string;\n  season3: string;\n  setSeason1: (value: string) => void;\n  setSeason2: (value: string) => void;\n  setSeason3: (value: string) => void;\n}) {\n  const { toast } = useToast();\n  \n  const { data: seasons } = useQuery<any[]>({\n    queryKey: ['/api/seasons'],\n  });\n\n  // Build seasonIds parameter based on selected seasons\n  const seasonIds = [season1, season2, season3].filter(Boolean).join(',');\n\n  // Get market percentages (for Mercado column) - uses (sales + FECHADAS) / potential\n  const { data: marketPercentagesMulti } = useQuery<any>({\n    queryKey: seasonIds \n      ? [`/api/manager/team-market-percentages-multi?seasonIds=${seasonIds}`]\n      : ['/api/manager/team-market-percentages-multi'],\n    enabled: !!seasonIds,\n  });\n\n  // Get sales vs goals (for C.Vale column) - uses team sales / manager goal\n  const { data: salesVsGoalsMulti } = useQuery<any>({\n    queryKey: seasonIds\n      ? [`/api/manager/team-sales-vs-goals-multi?seasonIds=${seasonIds}`]\n      : ['/api/manager/team-sales-vs-goals-multi'],\n    enabled: !!seasonIds,\n  });\n\n  const formatPercentage = (value: any) => {\n    const numValue = Number(value);\n    if (isNaN(numValue) || numValue === 0) return 'NA';\n    return `${numValue.toFixed(1)}%`;\n  };\n\n  const activeSeason = seasons?.find(s => s.isActive);\n\n  useEffect(() => {\n    if (activeSeason && !season1) {\n      setSeason1(activeSeason.id);\n    }\n  }, [activeSeason, season1]);\n\n  const season1Name = seasons?.find(s => s.id === season1)?.name || '';\n  const season2Name = seasons?.find(s => s.id === season2)?.name || '';\n  const season3Name = seasons?.find(s => s.id === season3)?.name || '';\n\n  // Market percentages (Mercado column) - uses (sales + FECHADAS) / potential\n  const marketPercentage1 = season1 ? marketPercentagesMulti?.[season1] : null;\n  const marketPercentage2 = season2 ? marketPercentagesMulti?.[season2] : null;\n  const marketPercentage3 = season3 ? marketPercentagesMulti?.[season3] : null;\n\n  // Use sales vs goals for C.Vale column - uses team sales / manager goal\n  const salesVsGoals1 = season1 ? salesVsGoalsMulti?.[season1] : null;\n  const salesVsGoals2 = season2 ? salesVsGoalsMulti?.[season2] : null;\n  const salesVsGoals3 = season3 ? salesVsGoalsMulti?.[season3] : null;\n\n  // Define fixed order for categories as per DIPRO image\n  const categoryOrder = [\n    'Agroquímicos',\n    'Especialidades',\n    'Fertilizantes',\n    'Corretivos',\n    'Sementes Soja',\n    'Sementes Milho',\n    'Sementes Diversas',\n    'Sementes Trigo',\n    'Outros'\n  ];\n\n  // Collect all unique categories\n  const categoriesSet = new Set<string>();\n  if (salesVsGoals1) Object.keys(salesVsGoals1).forEach(cat => categoriesSet.add(cat));\n  if (salesVsGoals2) Object.keys(salesVsGoals2).forEach(cat => categoriesSet.add(cat));\n  if (salesVsGoals3) Object.keys(salesVsGoals3).forEach(cat => categoriesSet.add(cat));\n  if (marketPercentage1) Object.keys(marketPercentage1).forEach(cat => categoriesSet.add(cat));\n  if (marketPercentage2) Object.keys(marketPercentage2).forEach(cat => categoriesSet.add(cat));\n  if (marketPercentage3) Object.keys(marketPercentage3).forEach(cat => categoriesSet.add(cat));\n\n  // Sort categories according to predefined order\n  const allCategories = Array.from(categoriesSet).sort((a, b) => {\n    const indexA = categoryOrder.indexOf(a);\n    const indexB = categoryOrder.indexOf(b);\n    \n    // If both are in the order list, sort by their position\n    if (indexA !== -1 && indexB !== -1) return indexA - indexB;\n    \n    // If only A is in the list, it comes first\n    if (indexA !== -1) return -1;\n    \n    // If only B is in the list, it comes first\n    if (indexB !== -1) return 1;\n    \n    // If neither is in the list, sort alphabetically\n    return a.localeCompare(b);\n  });\n\n  const exportToPowerPoint = async () => {\n    const pptx = new pptxgen();\n    const slide = pptx.addSlide();\n\n    // Title\n    slide.addText('Análise de Penetração de Mercado', {\n      x: 0.5,\n      y: 0.3,\n      w: 9,\n      h: 0.6,\n      fontSize: 24,\n      bold: true,\n      color: '2a4a6f',\n      align: 'center'\n    });\n\n    slide.addText('Comparativo C.Vale vs Mercado', {\n      x: 0.5,\n      y: 0.9,\n      w: 9,\n      h: 0.4,\n      fontSize: 14,\n      color: '666666',\n      align: 'center'\n    });\n\n    // Get season names\n    const seasonName1 = seasons?.find(s => s.id === season1)?.name || '';\n    const seasonName2 = seasons?.find(s => s.id === season2)?.name || '';\n    const seasonName3 = seasons?.find(s => s.id === season3)?.name || '';\n\n    // Prepare table data without rowspan/colspan (pptxgenjs limitation)\n    const tableRows: any[] = [];\n\n    // Header row 1: Season names (centered once per season group)\n    const headerRow1: any[] = [\n      { text: 'Família', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'left' } }\n    ];\n    \n    if (season1) {\n      headerRow1.push(\n        { text: '', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center' } },\n        { text: seasonName1, options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center', fontSize: 12 } },\n        { text: '', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center' } }\n      );\n    }\n    if (season2) {\n      headerRow1.push(\n        { text: '', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center' } },\n        { text: seasonName2, options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center', fontSize: 12 } },\n        { text: '', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center' } }\n      );\n    }\n    if (season3) {\n      headerRow1.push(\n        { text: '', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center' } },\n        { text: seasonName3, options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center', fontSize: 12 } },\n        { text: '', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center' } }\n      );\n    }\n\n    // Header row 2: C.Vale, Mercado, % Desvio\n    const headerRow2: any[] = [\n      { text: '', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true } }\n    ];\n    \n    if (season1) {\n      headerRow2.push(\n        { text: 'C.Vale', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center' } },\n        { text: 'Mercado', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center' } },\n        { text: '% Desvio', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center' } }\n      );\n    }\n    if (season2) {\n      headerRow2.push(\n        { text: 'C.Vale', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center' } },\n        { text: 'Mercado', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center' } },\n        { text: '% Desvio', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center' } }\n      );\n    }\n    if (season3) {\n      headerRow2.push(\n        { text: 'C.Vale', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center' } },\n        { text: 'Mercado', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center' } },\n        { text: '% Desvio', options: { fill: '2a4a6f', color: 'FFFFFF', bold: true, align: 'center' } }\n      );\n    }\n\n    tableRows.push(headerRow1);\n    tableRows.push(headerRow2);\n\n    // Data rows\n    allCategories.forEach((category) => {\n      const cvale1 = season1 ? (salesVsGoals1?.[category] || 0) : null;\n      const mercado1 = season1 ? (marketPercentage1?.[category] || 0) : null;\n      const desvio1 = (cvale1 !== null && mercado1 !== null) ? (cvale1 - mercado1) : null;\n\n      const cvale2 = season2 ? (salesVsGoals2?.[category] || 0) : null;\n      const mercado2 = season2 ? (marketPercentage2?.[category] || 0) : null;\n      const desvio2 = (cvale2 !== null && mercado2 !== null) ? (cvale2 - mercado2) : null;\n\n      const cvale3 = season3 ? (salesVsGoals3?.[category] || 0) : null;\n      const mercado3 = season3 ? (marketPercentage3?.[category] || 0) : null;\n      const desvio3 = (cvale3 !== null && mercado3 !== null) ? (cvale3 - mercado3) : null;\n\n      const desvio1Text = desvio1 !== null ? formatPercentage(desvio1) : '-';\n      const desvio2Text = desvio2 !== null ? formatPercentage(desvio2) : '-';\n      const desvio3Text = desvio3 !== null ? formatPercentage(desvio3) : '-';\n\n      const getDesvioColor = (text: string, value: number | null) => {\n        if (text === 'NA') return { color: 'FFC107', fill: 'FFFFFF' };\n        if (value !== null && value >= 0) return { color: '16A34A', fill: 'FFFFFF' };\n        if (value !== null) return { color: 'DC2626', fill: 'FFFFFF' };\n        return { color: '000000', fill: 'FFFFFF' };\n      };\n\n      const row: any[] = [\n        { text: category, options: { bold: true, align: 'left' } }\n      ];\n\n      if (season1) {\n        const desvio1Style = getDesvioColor(desvio1Text, desvio1);\n        row.push(\n          { text: cvale1 !== null ? formatPercentage(cvale1) : '-', options: { align: 'center' } },\n          { text: mercado1 !== null ? formatPercentage(mercado1) : '-', options: { align: 'center' } },\n          { text: desvio1Text, options: { align: 'center', bold: true, ...desvio1Style } }\n        );\n      }\n      if (season2) {\n        const desvio2Style = getDesvioColor(desvio2Text, desvio2);\n        row.push(\n          { text: cvale2 !== null ? formatPercentage(cvale2) : '-', options: { align: 'center' } },\n          { text: mercado2 !== null ? formatPercentage(mercado2) : '-', options: { align: 'center' } },\n          { text: desvio2Text, options: { align: 'center', bold: true, ...desvio2Style } }\n        );\n      }\n      if (season3) {\n        const desvio3Style = getDesvioColor(desvio3Text, desvio3);\n        row.push(\n          { text: cvale3 !== null ? formatPercentage(cvale3) : '-', options: { align: 'center' } },\n          { text: mercado3 !== null ? formatPercentage(mercado3) : '-', options: { align: 'center' } },\n          { text: desvio3Text, options: { align: 'center', bold: true, ...desvio3Style } }\n        );\n      }\n\n      tableRows.push(row);\n    });\n\n    // Add table to slide\n    const colCount = 1 + (season1 ? 3 : 0) + (season2 ? 3 : 0) + (season3 ? 3 : 0);\n    const colW = 9 / colCount;\n\n    slide.addTable(tableRows, {\n      x: 0.5,\n      y: 1.5,\n      w: 9,\n      h: 4.5,\n      colW: Array(colCount).fill(colW),\n      border: { type: 'solid', pt: 1, color: 'CCCCCC' },\n      fontSize: 10\n    });\n\n    // Save file\n    await pptx.writeFile({ fileName: 'Penetracao_Mercado.pptx' });\n    \n    toast({\n      title: 'Exportado com sucesso',\n      description: 'A apresentação PowerPoint foi gerada.',\n    });\n  };\n\n  return (\n    <Card>\n      <CardHeader className=\"flex flex-row items-center justify-between\">\n        <div>\n          <CardTitle>Penetração de Mercado</CardTitle>\n          <CardDescription>Comparativo C.Vale vs Mercado por Safra</CardDescription>\n        </div>\n        {season1 && (\n          <Button onClick={exportToPowerPoint} variant=\"outline\" size=\"sm\" data-testid=\"button-export-pptx\">\n            <FileDown className=\"h-4 w-4 mr-2\" />\n            Exportar PowerPoint\n          </Button>\n        )}\n      </CardHeader>\n      <CardContent>\n        {season1 ? (\n          <div className=\"rounded-lg overflow-hidden border\">\n            <div className=\"relative w-full overflow-auto\">\n              <table className=\"w-full caption-bottom text-sm\">\n                <thead className=\"border-b transition-colors hover:bg-muted/50 bg-[#2a4a6f]\">\n                  <tr className=\"border-b\">\n                    <th className=\"h-12 px-4 text-left align-middle font-semibold text-white border-r border-[#2a4a6f] p-2\" rowSpan={2}>Família</th>\n                    <th className=\"h-12 align-middle font-semibold text-center border-r border-[#2a4a6f] p-2 text-white\" colSpan={3}>\n                      <Select value={season1} onValueChange={setSeason1}>\n                        <SelectTrigger className=\"w-full bg-transparent border-none text-white h-8\" data-testid=\"select-season1\">\n                          <SelectValue placeholder=\"Selecione safra\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {seasons?.map((season) => (\n                            <SelectItem key={season.id} value={season.id}>\n                              {season.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </th>\n                    <th className=\"h-12 align-middle font-semibold text-center border-r border-[#2a4a6f] p-2 text-white\" colSpan={3}>\n                      <Select value={season2 || undefined} onValueChange={setSeason2}>\n                        <SelectTrigger className=\"w-full bg-transparent border-none text-white h-8\" data-testid=\"select-season2\">\n                          <SelectValue placeholder=\"Selecione safra\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {seasons?.map((season) => (\n                            <SelectItem key={season.id} value={season.id}>\n                              {season.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </th>\n                    <th className=\"h-12 align-middle font-semibold text-center border-r border-[#2a4a6f] p-2 text-white\" colSpan={3}>\n                      <Select value={season3 || undefined} onValueChange={setSeason3}>\n                        <SelectTrigger className=\"w-full bg-transparent border-none text-white h-8\" data-testid=\"select-season3\">\n                          <SelectValue placeholder=\"Selecione safra\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          {seasons?.map((season) => (\n                            <SelectItem key={season.id} value={season.id}>\n                              {season.name}\n                            </SelectItem>\n                          ))}\n                        </SelectContent>\n                      </Select>\n                    </th>\n                  </tr>\n                  <tr className=\"border-b\">\n                    <th className=\"h-12 px-4 text-center align-middle font-semibold text-white border-r border-[#2a4a6f] pr-0\">C.Vale</th>\n                    <th className=\"h-12 px-4 text-center align-middle font-semibold text-white border-r border-[#2a4a6f]\">Mercado</th>\n                    <th className=\"h-12 px-4 text-center align-middle font-semibold text-white border-r-2 border-gray-400\">% Desvio</th>\n                    <th className=\"h-12 px-4 text-center align-middle font-semibold text-white border-r border-[#2a4a6f]\">C.Vale</th>\n                    <th className=\"h-12 px-4 text-center align-middle font-semibold text-white border-r border-[#2a4a6f]\">Mercado</th>\n                    <th className=\"h-12 px-4 text-center align-middle font-semibold text-white border-r-2 border-gray-400\">% Desvio</th>\n                    <th className=\"h-12 px-4 text-center align-middle font-semibold text-white border-r border-[#2a4a6f]\">C.Vale</th>\n                    <th className=\"h-12 px-4 text-center align-middle font-semibold text-white border-r border-[#2a4a6f]\">Mercado</th>\n                    <th className=\"h-12 px-4 text-center align-middle font-semibold text-white border-r border-[#2a4a6f]\">% Desvio</th>\n                  </tr>\n                </thead>\n                <tbody>\n                  {allCategories.map((category) => {\n                    const cvale1 = season1 ? (salesVsGoals1?.[category] || 0) : null;\n                    const mercado1 = season1 ? (marketPercentage1?.[category] || 0) : null;\n                    const desvio1 = (cvale1 !== null && mercado1 !== null) ? (cvale1 - mercado1) : null;\n\n                    const cvale2 = season2 ? (salesVsGoals2?.[category] || 0) : null;\n                    const mercado2 = season2 ? (marketPercentage2?.[category] || 0) : null;\n                    const desvio2 = (cvale2 !== null && mercado2 !== null) ? (cvale2 - mercado2) : null;\n\n                    const cvale3 = season3 ? (salesVsGoals3?.[category] || 0) : null;\n                    const mercado3 = season3 ? (marketPercentage3?.[category] || 0) : null;\n                    const desvio3 = (cvale3 !== null && mercado3 !== null) ? (cvale3 - mercado3) : null;\n\n                    const desvio1Text = desvio1 !== null ? formatPercentage(desvio1) : '-';\n                    const desvio2Text = desvio2 !== null ? formatPercentage(desvio2) : '-';\n                    const desvio3Text = desvio3 !== null ? formatPercentage(desvio3) : '-';\n\n                    const getDesvioColor = (text: string, value: number | null) => {\n                      if (text === 'NA') return 'text-yellow-600';\n                      if (value !== null && value >= 0) return 'text-green-600';\n                      if (value !== null) return 'text-red-600';\n                      return '';\n                    };\n\n                    return (\n                      <tr key={category} className=\"border-b transition-colors hover:bg-muted/50\" data-testid={`category-row-${category}`}>\n                        <td className=\"p-4 align-middle font-medium\">{category}</td>\n                        <td className=\"p-4 align-middle text-center\">{cvale1 !== null ? formatPercentage(cvale1) : '-'}</td>\n                        <td className=\"p-4 align-middle text-center\">{mercado1 !== null ? formatPercentage(mercado1) : '-'}</td>\n                        <td className={`p-4 align-middle text-center font-semibold border-r-2 border-gray-300 ${getDesvioColor(desvio1Text, desvio1)}`}>\n                          {desvio1Text}\n                        </td>\n                        <td className=\"p-4 align-middle text-center\">{cvale2 !== null ? formatPercentage(cvale2) : '-'}</td>\n                        <td className=\"p-4 align-middle text-center\">{mercado2 !== null ? formatPercentage(mercado2) : '-'}</td>\n                        <td className={`p-4 align-middle text-center font-semibold border-r-2 border-gray-300 ${getDesvioColor(desvio2Text, desvio2)}`}>\n                          {desvio2Text}\n                        </td>\n                        <td className=\"p-4 align-middle text-center\">{cvale3 !== null ? formatPercentage(cvale3) : '-'}</td>\n                        <td className=\"p-4 align-middle text-center\">{mercado3 !== null ? formatPercentage(mercado3) : '-'}</td>\n                        <td className={`p-4 align-middle text-center font-semibold ${getDesvioColor(desvio3Text, desvio3)}`}>\n                          {desvio3Text}\n                        </td>\n                      </tr>\n                    );\n                  })}\n                </tbody>\n              </table>\n            </div>\n          </div>\n        ) : (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            Selecione ao menos uma safra para ver a análise de penetração de mercado\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction TeamTab({ teamData }: { teamData?: TeamData }) {\n  if (!teamData) {\n    return <div className=\"text-center py-8 text-muted-foreground\">Nenhum dado disponível</div>;\n  }\n\n  const formatCurrency = (value: number) => {\n    return new Intl.NumberFormat('pt-BR', {\n      style: 'currency',\n      currency: 'USD',\n      minimumFractionDigits: 2,\n    }).format(value);\n  };\n\n  // Sort by total sales descending\n  const sortedMembers = [...teamData.teamMembers].sort((a, b) => b.totalSales - a.totalSales);\n  \n  // Calculate max values for percentage bars\n  const maxSales = Math.max(...teamData.teamMembers.map(m => m.totalSales), 1);\n  const maxTimac = Math.max(...teamData.teamMembers.map(m => m.timacPoints), 1);\n\n  return (\n    <Card>\n      <CardHeader>\n        <CardTitle>Ranking da Equipe</CardTitle>\n        <CardDescription>Desempenho individual dos consultores</CardDescription>\n      </CardHeader>\n      <CardContent>\n        {teamData.teamMembers.length > 0 ? (\n          <Table>\n            <TableHeader>\n              <TableRow>\n                <TableHead className=\"w-12\">#</TableHead>\n                <TableHead>Consultor</TableHead>\n                <TableHead className=\"text-right\">Volume de Vendas</TableHead>\n                <TableHead className=\"text-right\">% do Total</TableHead>\n                <TableHead className=\"text-right\">Pontos Timac</TableHead>\n                <TableHead className=\"text-right\">% Timac</TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {sortedMembers.map((member, index) => {\n                const salesPercent = (member.totalSales / teamData.totalSales) * 100;\n                const timacPercent = (member.timacPoints / teamData.totalTimacPoints) * 100;\n                \n                return (\n                  <TableRow key={member.id} data-testid={`team-member-${member.id}`}>\n                    <TableCell className=\"font-medium\">{index + 1}º</TableCell>\n                    <TableCell className=\"font-medium\">{member.name}</TableCell>\n                    <TableCell className=\"text-right\">{formatCurrency(member.totalSales)}</TableCell>\n                    <TableCell className=\"text-right\">\n                      <div className=\"flex items-center justify-end gap-2\">\n                        <div className=\"w-16 bg-gray-200 dark:bg-gray-700 rounded-full h-2\">\n                          <div \n                            className=\"bg-primary h-2 rounded-full\" \n                            style={{ width: `${(member.totalSales / maxSales) * 100}%` }}\n                          ></div>\n                        </div>\n                        <span className=\"font-medium\">{salesPercent.toFixed(1)}%</span>\n                      </div>\n                    </TableCell>\n                    <TableCell className=\"text-right\">{member.timacPoints.toLocaleString()}</TableCell>\n                    <TableCell className=\"text-right\">\n                      <div className=\"flex items-center justify-end gap-2\">\n                        <div className=\"w-16 bg-gray-200 dark:bg-gray-700 rounded-full h-2\">\n                          <div \n                            className=\"bg-blue-600 h-2 rounded-full\" \n                            style={{ width: `${(member.timacPoints / maxTimac) * 100}%` }}\n                          ></div>\n                        </div>\n                        <span className=\"font-medium\">{timacPercent.toFixed(1)}%</span>\n                      </div>\n                    </TableCell>\n                  </TableRow>\n                );\n              })}\n            </TableBody>\n          </Table>\n        ) : (\n          <div className=\"text-center py-8 text-muted-foreground\">\n            Nenhum membro na equipe\n          </div>\n        )}\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction ActionPlansTab() {\n  const [showNewPlanDialog, setShowNewPlanDialog] = useState(false);\n  const [selectedPlan, setSelectedPlan] = useState<any>(null);\n\n  const { data: actionPlans, isLoading } = useQuery<any[]>({\n    queryKey: ['/api/manager/action-plans'],\n  });\n\n  if (selectedPlan) {\n    return <ActionPlanDetails plan={selectedPlan} onBack={() => setSelectedPlan(null)} />;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-2xl font-bold\">Planos de Ação</h2>\n          <p className=\"text-muted-foreground\">Gerencie reuniões e ações da equipe</p>\n        </div>\n        <CreateActionPlanDialog \n          open={showNewPlanDialog} \n          onOpenChange={setShowNewPlanDialog}\n        />\n      </div>\n\n      {isLoading ? (\n        <div className=\"text-center py-12\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto\"></div>\n        </div>\n      ) : actionPlans && actionPlans.length > 0 ? (\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-3\">\n          {actionPlans.map((plan) => (\n            <Card \n              key={plan.id} \n              className=\"cursor-pointer hover:shadow-lg transition-shadow\"\n              onClick={() => setSelectedPlan(plan)}\n              data-testid={`action-plan-card-${plan.id}`}\n            >\n              <CardHeader>\n                <CardTitle className=\"text-lg\">{plan.title}</CardTitle>\n                <CardDescription>\n                  {new Date(plan.meetingDate).toLocaleDateString('pt-BR')}\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2 text-sm\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-muted-foreground\">Ações:</span>\n                    <span className=\"font-medium\">{plan.itemCount || 0}</span>\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-muted-foreground\">Participantes:</span>\n                    <span className=\"font-medium\">{plan.participantCount || 0}</span>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      ) : (\n        <Card>\n          <CardContent className=\"py-12\">\n            <div className=\"text-center\">\n              <ListChecks className=\"h-12 w-12 mx-auto text-muted-foreground mb-4\" />\n              <p className=\"text-muted-foreground mb-4\">Nenhum plano de ação criado</p>\n              <Button onClick={() => setShowNewPlanDialog(true)} data-testid=\"button-first-action-plan\">\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Criar Primeiro Plano\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n\nfunction CreateActionPlanDialog({ open, onOpenChange }: { open: boolean; onOpenChange: (open: boolean) => void }) {\n  const [title, setTitle] = useState('');\n  const [meetingDate, setMeetingDate] = useState('');\n  const { toast } = useToast();\n\n  const createPlanMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return apiRequest('POST', '/api/manager/action-plans', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/manager/action-plans'] });\n      toast({\n        title: 'Plano criado',\n        description: 'O plano de ação foi criado com sucesso.',\n      });\n      onOpenChange(false);\n      setTitle('');\n      setMeetingDate('');\n    },\n    onError: () => {\n      toast({\n        title: 'Erro',\n        description: 'Erro ao criar plano de ação.',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const handleCreate = () => {\n    if (!title || !meetingDate) {\n      toast({\n        title: 'Campos obrigatórios',\n        description: 'Preencha todos os campos.',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    createPlanMutation.mutate({ title, meetingDate });\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={onOpenChange}>\n      <DialogTrigger asChild>\n        <Button data-testid=\"button-new-action-plan\">\n          <Plus className=\"h-4 w-4 mr-2\" />\n          Novo Plano de Ação\n        </Button>\n      </DialogTrigger>\n      <DialogContent data-testid=\"dialog-create-action-plan\">\n        <DialogHeader>\n          <DialogTitle>Novo Plano de Ação</DialogTitle>\n          <DialogDescription>\n            Crie um novo plano de ação para uma reunião com a equipe\n          </DialogDescription>\n        </DialogHeader>\n        <div className=\"space-y-4 py-4\">\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"plan-title\">Título da Reunião</Label>\n            <Input\n              id=\"plan-title\"\n              value={title}\n              onChange={(e) => setTitle(e.target.value)}\n              placeholder=\"Ex: Reunião de Planejamento Q1\"\n              data-testid=\"input-plan-title\"\n            />\n          </div>\n          <div className=\"space-y-2\">\n            <Label htmlFor=\"meeting-date\">Data da Reunião</Label>\n            <Input\n              id=\"meeting-date\"\n              type=\"date\"\n              value={meetingDate}\n              onChange={(e) => setMeetingDate(e.target.value)}\n              data-testid=\"input-meeting-date\"\n            />\n          </div>\n        </div>\n        <DialogFooter>\n          <Button\n            variant=\"outline\"\n            onClick={() => onOpenChange(false)}\n            data-testid=\"button-cancel-create-plan\"\n          >\n            Cancelar\n          </Button>\n          <Button\n            onClick={handleCreate}\n            disabled={createPlanMutation.isPending}\n            data-testid=\"button-save-plan\"\n          >\n            {createPlanMutation.isPending ? 'Criando...' : 'Criar Plano'}\n          </Button>\n        </DialogFooter>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction ActionPlanDetails({ plan, onBack }: { plan: any; onBack: () => void }) {\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center gap-4\">\n        <Button variant=\"ghost\" size=\"icon\" onClick={onBack} data-testid=\"button-back\">\n          <ArrowLeft className=\"h-4 w-4\" />\n        </Button>\n        <div>\n          <h2 className=\"text-2xl font-bold\">{plan.title}</h2>\n          <p className=\"text-sm text-muted-foreground\">\n            Reunião: {new Date(plan.meetingDate).toLocaleDateString('pt-BR')}\n          </p>\n        </div>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle>Detalhes do Plano</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <p className=\"text-center py-8 text-muted-foreground\">Detalhes em desenvolvimento...</p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nconst AGROQUIMICOS_SUBCATEGORIAS = [\n  'Tratamento de semente',\n  'Dessecação',\n  'Inseticidas',\n  'Fungicidas'\n];\n\nfunction ManagerGoalsTab() {\n  const [showNewGoalModal, setShowNewGoalModal] = useState(false);\n  const [selectedSeason, setSelectedSeason] = useState(\"\");\n  const [editingGoal, setEditingGoal] = useState<SeasonGoal | null>(null);\n  const [goalToDelete, setGoalToDelete] = useState<string | null>(null);\n  const { toast } = useToast();\n\n  // Estados para \"Incluir Potencial Geral\"\n  const [showGlobalConfig, setShowGlobalConfig] = useState(false);\n  const [globalSeasonId, setGlobalSeasonId] = useState<string>(\"\");\n  const [globalRateValues, setGlobalRateValues] = useState<Record<string, string>>({});\n  const [globalSubcategoryValues, setGlobalSubcategoryValues] = useState<Record<string, Record<string, string>>>({});\n  const [viewSeasonId, setViewSeasonId] = useState<string>(\"\");\n\n  // Estados para \"Configurar Manejo\"\n  const [showManejoDialog, setShowManejoDialog] = useState(false);\n  const [showAddApplicationDialog, setShowAddApplicationDialog] = useState(false);\n  const [applicationCategory, setApplicationCategory] = useState<\"FUNGICIDAS\" | \"INSETICIDAS\">(\"FUNGICIDAS\");\n  const [applicationNumber, setApplicationNumber] = useState<number>(1);\n  const [selectedProductId, setSelectedProductId] = useState<string>(\"\");\n  const [selectedPriceTier, setSelectedPriceTier] = useState<string>(\"verde\");\n  const [productsInApplication, setProductsInApplication] = useState<Array<{productId: string; priceTier: string}>>([]);\n\n  const [formData, setFormData] = useState({\n    seasonId: \"\",\n    goalAmount: \"\",\n    metaAgroquimicos: \"\",\n    metaEspecialidades: \"\",\n    metaSementesMilho: \"\",\n    metaSementesSoja: \"\",\n    metaSementesTrigo: \"\",\n    metaSementesDiversas: \"\",\n    metaFertilizantes: \"\",\n    metaCorretivos: \"\",\n  });\n\n  const { data: seasons } = useQuery<Season[]>({\n    queryKey: [\"/api/seasons\"],\n  });\n\n  const { data: analytics } = useQuery({\n    queryKey: [\"/api/analytics/sales\"],\n  });\n\n  const { data: categories } = useQuery({\n    queryKey: [\"/api/categories\"],\n  });\n\n  const { data: priceTableProducts } = useQuery<any[]>({\n    queryKey: [\"/api/price-table-products\"],\n  });\n\n  const { data: globalManagementApplications } = useQuery<any[]>({\n    queryKey: [\"/api/global-management\", viewSeasonId],\n    queryFn: viewSeasonId \n      ? async () => {\n          const res = await fetch(`/api/global-management?seasonId=${viewSeasonId}`);\n          if (!res.ok) throw new Error('Failed to fetch global management');\n          return res.json();\n        }\n      : undefined,\n    enabled: !!viewSeasonId,\n  });\n\n  // Query to fetch existing market rates for selected season\n  const { data: existingMarketRates } = useQuery<any[]>({\n    queryKey: [\"/api/clients/manager-team/market-rates\", globalSeasonId],\n    queryFn: globalSeasonId\n      ? async () => {\n          const res = await fetch(`/api/clients/manager-team/market-rates/${globalSeasonId}`);\n          if (!res.ok) throw new Error('Failed to fetch market rates');\n          const data = await res.json();\n          console.log('API Response for market rates:', data);\n          return data;\n        }\n      : undefined,\n    enabled: !!globalSeasonId && showGlobalConfig,\n  });\n\n  const fungicidasProducts = priceTableProducts?.filter((p: any) => p.categoria === \"FUNGICIDAS\") || [];\n  const inseticidasProducts = priceTableProducts?.filter((p: any) => p.categoria === \"INSETICIDAS\") || [];\n\n  const { data: seasonGoals, isLoading: goalsLoading } = useQuery<SeasonGoal[]>({\n    queryKey: [\"/api/season-goals\"],\n  });\n\n  const createGoalMutation = useMutation({\n    mutationFn: async (goalData: InsertSeasonGoal) => {\n      return apiRequest(\"POST\", \"/api/season-goals\", goalData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/season-goals\"] });\n      toast({\n        title: \"Meta cadastrada\",\n        description: \"A meta foi cadastrada com sucesso.\",\n      });\n      setShowNewGoalModal(false);\n      resetForm();\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao cadastrar meta. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const updateGoalMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<InsertSeasonGoal> }) => {\n      return apiRequest(\"PATCH\", `/api/season-goals/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/season-goals\"] });\n      toast({\n        title: \"Meta atualizada\",\n        description: \"A meta foi atualizada com sucesso.\",\n      });\n      setEditingGoal(null);\n      setShowNewGoalModal(false);\n      resetForm();\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao atualizar meta. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deleteGoalMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/season-goals/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/season-goals\"] });\n      toast({\n        title: \"Meta excluída\",\n        description: \"A meta foi excluída com sucesso.\",\n      });\n      setGoalToDelete(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao excluir meta. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutations para \"Incluir Potencial Geral\"\n  const saveGlobalRatesMutation = useMutation({\n    mutationFn: async ({ rates }: { rates: Array<{ clientId: string; categoryId: string; seasonId: string; investmentPerHa: string; subcategories?: any }> }) => {\n      // Gerente: o endpoint vai replicar automaticamente para toda a equipe\n      return apiRequest(\"POST\", `/api/clients/manager-team/market-rates`, {\n        allRates: rates\n      });\n    },\n    onSuccess: (response: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/market-analysis\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/kanban-metas\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/clients/manager-team/market-rates\", globalSeasonId] });\n      \n      const count = response?.count || 0;\n      const categoryCount = response?.categoryCount || 0;\n      toast({\n        title: \"Configuração aplicada!\",\n        description: `Potencial de ${categoryCount} categoria(s) aplicado a ${count} cliente(s) da equipe.`,\n      });\n      setShowGlobalConfig(false);\n      setGlobalRateValues({});\n      setGlobalSubcategoryValues({});\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Erro ao aplicar configuração. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutation to recalculate existing potential for all team clients\n  const recalculatePotentialMutation = useMutation({\n    mutationFn: async () => {\n      if (!globalSeasonId) {\n        throw new Error(\"Safra não selecionada\");\n      }\n      \n      // Use existing market rates data to recalculate\n      if (!existingMarketRates || existingMarketRates.length === 0) {\n        throw new Error(\"Nenhum valor de potencial salvo para esta safra\");\n      }\n      \n      // Build rates array from existing data\n      const rates = existingMarketRates.map((rate: any) => ({\n        categoryId: rate.categoryId,\n        seasonId: globalSeasonId,\n        investmentPerHa: rate.investmentPerHa,\n        subcategories: rate.subcategories || null\n      }));\n      \n      return apiRequest(\"POST\", `/api/clients/manager-team/market-rates`, {\n        allRates: rates\n      });\n    },\n    onSuccess: (response: any) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/market-analysis\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/kanban-metas\"] });\n      \n      const count = response?.count || 0;\n      const categoryCount = existingMarketRates?.length || 0;\n      toast({\n        title: \"Potencial recalculado!\",\n        description: `Valores de ${categoryCount} categoria(s) reaplicados para ${count} cliente(s).`,\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Erro\",\n        description: error?.message || \"Erro ao recalcular potencial. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Mutations para \"Configurar Manejo\"\n  const createApplicationMutation = useMutation({\n    mutationFn: async (data: { categoria: string; applicationNumber: number; productId: string; priceTier: string; seasonId: string }) => {\n      return apiRequest(\"POST\", \"/api/global-management\", data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/global-management\", viewSeasonId] });\n      toast({\n        title: \"Aplicação adicionada!\",\n        description: \"A aplicação foi adicionada para toda a equipe.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Erro\",\n        description: error?.message || \"Não foi possível adicionar a aplicação.\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  const deleteApplicationMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return apiRequest(\"DELETE\", `/api/global-management/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/global-management\", viewSeasonId] });\n      toast({\n        title: \"Aplicação removida!\",\n        description: \"A aplicação foi removida para toda a equipe.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Erro\",\n        description: error?.message || \"Não foi possível remover a aplicação.\",\n        variant: \"destructive\"\n      });\n    }\n  });\n\n  const resetForm = () => {\n    setFormData({\n      seasonId: \"\",\n      goalAmount: \"\",\n      metaAgroquimicos: \"\",\n      metaEspecialidades: \"\",\n      metaSementesMilho: \"\",\n      metaSementesSoja: \"\",\n      metaSementesTrigo: \"\",\n      metaSementesDiversas: \"\",\n      metaFertilizantes: \"\",\n      metaCorretivos: \"\",\n    });\n    setEditingGoal(null);\n  };\n\n  // Handlers para \"Incluir Potencial Geral\"\n  const openGlobalConfigDialog = () => {\n    const activeSeason = seasons?.find(s => s.isActive);\n    if (activeSeason) {\n      setViewSeasonId(activeSeason.id);\n      setGlobalSeasonId(activeSeason.id);\n    }\n    setShowGlobalConfig(true);\n  };\n\n  const closeGlobalConfigDialog = () => {\n    setShowGlobalConfig(false);\n    setGlobalRateValues({});\n    setGlobalSubcategoryValues({});\n    setGlobalSeasonId(\"\");\n  };\n\n  // Load existing market rates when season is selected\n  useEffect(() => {\n    console.log('useEffect triggered - existingMarketRates:', existingMarketRates);\n    if (existingMarketRates && Array.isArray(existingMarketRates)) {\n      console.log('existingMarketRates is array with length:', existingMarketRates.length);\n      if (existingMarketRates.length > 0) {\n        const rateValues: Record<string, string> = {};\n        const subValues: Record<string, Record<string, string>> = {};\n        \n        existingMarketRates.forEach((rate: any) => {\n          // Convert investment to string, handling both number and string types\n          const investmentValue = rate.investmentPerHa ? String(rate.investmentPerHa) : '';\n          console.log(`Setting rate for ${rate.categoryId}:`, investmentValue);\n          rateValues[rate.categoryId] = investmentValue;\n          \n          if (rate.subcategories) {\n            subValues[rate.categoryId] = rate.subcategories;\n          }\n        });\n        \n        console.log('Final rateValues:', rateValues);\n        setGlobalRateValues(rateValues);\n        setGlobalSubcategoryValues(subValues);\n      } else {\n        console.log('existingMarketRates is empty, clearing values');\n        // Clear values when no data exists for this season\n        setGlobalRateValues({});\n        setGlobalSubcategoryValues({});\n      }\n    } else {\n      console.log('existingMarketRates is not an array or is undefined');\n    }\n  }, [existingMarketRates]);\n\n  const handleSaveGlobalRates = () => {\n    if (!globalSeasonId) {\n      toast({\n        title: \"Safra não selecionada\",\n        description: \"Selecione uma safra para aplicar as configurações.\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    const rates: Array<{ clientId: string; categoryId: string; seasonId: string; investmentPerHa: string; subcategories?: any }> = [];\n\n    if (categories && Array.isArray(categories)) {\n      categories.forEach((category: any) => {\n        const categoryId = category.id;\n        const investmentPerHa = globalRateValues[categoryId];\n        \n        if (investmentPerHa) {\n          const isAgroquimicos = category.name.toLowerCase().includes('agroqu');\n          const subcategories = isAgroquimicos && globalSubcategoryValues[categoryId] \n            ? globalSubcategoryValues[categoryId]\n            : undefined;\n\n          rates.push({\n            clientId: \"manager-team\", // Placeholder - backend vai replicar para toda a equipe\n            categoryId,\n            seasonId: globalSeasonId,\n            investmentPerHa,\n            subcategories\n          });\n        }\n      });\n    }\n\n    if (rates.length > 0) {\n      saveGlobalRatesMutation.mutate({ rates });\n    } else {\n      toast({\n        title: \"Nenhum valor configurado\",\n        description: \"Configure pelo menos um valor antes de salvar.\",\n        variant: \"destructive\"\n      });\n    }\n  };\n\n  const handleEditClick = (goal: SeasonGoal) => {\n    setEditingGoal(goal);\n    setFormData({\n      seasonId: goal.seasonId,\n      goalAmount: goal.goalAmount,\n      metaAgroquimicos: goal.metaAgroquimicos || \"0\",\n      metaEspecialidades: goal.metaEspecialidades || \"0\",\n      metaSementesMilho: goal.metaSementesMilho || \"0\",\n      metaSementesSoja: goal.metaSementesSoja || \"0\",\n      metaSementesTrigo: goal.metaSementesTrigo || \"0\",\n      metaSementesDiversas: goal.metaSementesDiversas || \"0\",\n      metaFertilizantes: goal.metaFertilizantes || \"0\",\n      metaCorretivos: goal.metaCorretivos || \"0\",\n    });\n    setShowNewGoalModal(true);\n  };\n\n  const handleDeleteClick = (goalId: string) => {\n    setGoalToDelete(goalId);\n  };\n\n  const confirmDelete = () => {\n    if (goalToDelete) {\n      deleteGoalMutation.mutate(goalToDelete);\n    }\n  };\n\n  const calculateGlobalGoal = () => {\n    const agro = parseFloat(formData.metaAgroquimicos) || 0;\n    const espec = parseFloat(formData.metaEspecialidades) || 0;\n    const sementesMilho = parseFloat(formData.metaSementesMilho) || 0;\n    const sementesSoja = parseFloat(formData.metaSementesSoja) || 0;\n    const sementesTrigo = parseFloat(formData.metaSementesTrigo) || 0;\n    const sementesDiversas = parseFloat(formData.metaSementesDiversas) || 0;\n    const fert = parseFloat(formData.metaFertilizantes) || 0;\n    const corr = parseFloat(formData.metaCorretivos) || 0;\n    return agro + espec + sementesMilho + sementesSoja + sementesTrigo + sementesDiversas + fert + corr;\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    \n    const globalGoal = calculateGlobalGoal();\n    \n    if (!formData.seasonId || globalGoal === 0) {\n      toast({\n        title: \"Campos obrigatórios\",\n        description: \"Selecione uma safra e preencha pelo menos uma meta de categoria.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const goalData: InsertSeasonGoal = {\n      seasonId: formData.seasonId,\n      goalAmount: globalGoal.toString(),\n      metaAgroquimicos: formData.metaAgroquimicos || \"0\",\n      metaEspecialidades: formData.metaEspecialidades || \"0\",\n      metaSementesMilho: formData.metaSementesMilho || \"0\",\n      metaSementesSoja: formData.metaSementesSoja || \"0\",\n      metaSementesTrigo: formData.metaSementesTrigo || \"0\",\n      metaSementesDiversas: formData.metaSementesDiversas || \"0\",\n      metaFertilizantes: formData.metaFertilizantes || \"0\",\n      metaCorretivos: formData.metaCorretivos || \"0\",\n      userId: \"default-vendedor-id\",\n    };\n\n    if (editingGoal) {\n      updateGoalMutation.mutate({ id: editingGoal.id, data: goalData });\n    } else {\n      createGoalMutation.mutate(goalData);\n    }\n  };\n\n  const getSeasonName = (seasonId: string) => {\n    return seasons?.find(s => s.id === seasonId)?.name || \"Safra não encontrada\";\n  };\n\n  const getTypeBadgeClass = (type: string) => {\n    switch (type) {\n      case \"soja_verao\": return \"bg-verde/10 text-verde border-verde/20\";\n      case \"soja_safrinha\": return \"bg-chart-2/10 text-chart-2 border-chart-2/20\";\n      case \"milho\": return \"bg-amarela/10 text-amarela border-amarela/20\";\n      case \"trigo\": return \"bg-chart-4/10 text-chart-4 border-chart-4/20\";\n      default: return \"bg-muted text-muted-foreground\";\n    }\n  };\n\n  const getTypeLabel = (type: string) => {\n    switch (type) {\n      case \"soja_verao\": return \"Soja Verão\";\n      case \"soja_safrinha\": return \"Soja Safrinha\";\n      case \"milho\": return \"Milho\";\n      case \"trigo\": return \"Trigo\";\n      default: return type;\n    }\n  };\n\n  const { data: sales } = useQuery({\n    queryKey: [\"/api/sales\"],\n  });\n\n  const goalsWithDetails = (seasonGoals || []).map(goal => {\n    const season = seasons?.find(s => s.id === goal.seasonId);\n    const goalSales = (sales as any[])?.filter(s => s.seasonId === goal.seasonId) || [];\n    \n    const categoryMap: Record<string, string> = {\n      \"Agroquímicos\": \"cat-agroquimicos\",\n      \"Especialidades\": \"cat-especialidades\",\n      \"Sementes Milho\": \"cat-sem-milho\",\n      \"Sementes Soja\": \"cat-sem-soja\",\n      \"Sementes Trigo\": \"cat-sem-trigo\",\n      \"Sementes Diversas\": \"cat-sem-diversas\",\n      \"Fertilizantes\": \"cat-fertilizantes\",\n      \"Corretivos\": \"cat-corretivos\",\n    };\n    \n    const salesByCategory = goalSales.reduce((acc: Record<string, number>, sale: any) => {\n      const categoryId = sale.categoryId;\n      const amount = parseFloat(sale.totalAmount || \"0\");\n      acc[categoryId] = (acc[categoryId] || 0) + amount;\n      return acc;\n    }, {});\n    \n    const realizadoAgroquimicos = salesByCategory[categoryMap[\"Agroquímicos\"]] || 0;\n    const realizadoEspecialidades = salesByCategory[categoryMap[\"Especialidades\"]] || 0;\n    const realizadoSementesMilho = salesByCategory[categoryMap[\"Sementes Milho\"]] || 0;\n    const realizadoSementesSoja = salesByCategory[categoryMap[\"Sementes Soja\"]] || 0;\n    const realizadoSementesTrigo = salesByCategory[categoryMap[\"Sementes Trigo\"]] || 0;\n    const realizadoSementesDiversas = salesByCategory[categoryMap[\"Sementes Diversas\"]] || 0;\n    const realizadoFertilizantes = salesByCategory[categoryMap[\"Fertilizantes\"]] || 0;\n    const realizadoCorretivos = salesByCategory[categoryMap[\"Corretivos\"]] || 0;\n    \n    const achievedAmount = realizadoAgroquimicos + realizadoEspecialidades + \n                          realizadoSementesMilho + realizadoSementesSoja + \n                          realizadoSementesTrigo + realizadoSementesDiversas + \n                          realizadoFertilizantes + realizadoCorretivos;\n    \n    const metaAgroquimicosNum = parseFloat(goal.metaAgroquimicos || \"0\");\n    const metaEspecialidadesNum = parseFloat(goal.metaEspecialidades || \"0\");\n    const metaSementesMilhoNum = parseFloat(goal.metaSementesMilho || \"0\");\n    const metaSementesSojaNum = parseFloat(goal.metaSementesSoja || \"0\");\n    const metaSementesTrigoNum = parseFloat(goal.metaSementesTrigo || \"0\");\n    const metaSementesDiversasNum = parseFloat(goal.metaSementesDiversas || \"0\");\n    const metaFertilizantesNum = parseFloat(goal.metaFertilizantes || \"0\");\n    const metaCorretivosNum = parseFloat(goal.metaCorretivos || \"0\");\n    \n    const percentAgroquimicos = metaAgroquimicosNum > 0 ? (realizadoAgroquimicos / metaAgroquimicosNum) * 100 : 0;\n    const percentEspecialidades = metaEspecialidadesNum > 0 ? (realizadoEspecialidades / metaEspecialidadesNum) * 100 : 0;\n    const percentSementesMilho = metaSementesMilhoNum > 0 ? (realizadoSementesMilho / metaSementesMilhoNum) * 100 : 0;\n    const percentSementesSoja = metaSementesSojaNum > 0 ? (realizadoSementesSoja / metaSementesSojaNum) * 100 : 0;\n    const percentSementesTrigo = metaSementesTrigoNum > 0 ? (realizadoSementesTrigo / metaSementesTrigoNum) * 100 : 0;\n    const percentSementesDiversas = metaSementesDiversasNum > 0 ? (realizadoSementesDiversas / metaSementesDiversasNum) * 100 : 0;\n    const percentFertilizantes = metaFertilizantesNum > 0 ? (realizadoFertilizantes / metaFertilizantesNum) * 100 : 0;\n    const percentCorretivos = metaCorretivosNum > 0 ? (realizadoCorretivos / metaCorretivosNum) * 100 : 0;\n    \n    const goalAmountNum = parseFloat(goal.goalAmount);\n    const percentage = goalAmountNum > 0 ? (achievedAmount / goalAmountNum) * 100 : 0;\n\n    return {\n      id: goal.id,\n      seasonId: goal.seasonId,\n      seasonName: season?.name || \"Safra desconhecida\",\n      seasonType: season?.type || \"unknown\",\n      goalAmount: goalAmountNum,\n      achievedAmount,\n      percentage,\n      status: percentage >= 100 ? \"concluida\" as const : \"em_andamento\" as const,\n      metaAgroquimicos: goal.metaAgroquimicos || \"0\",\n      metaEspecialidades: goal.metaEspecialidades || \"0\",\n      metaSementesMilho: goal.metaSementesMilho || \"0\",\n      metaSementesSoja: goal.metaSementesSoja || \"0\",\n      metaSementesTrigo: goal.metaSementesTrigo || \"0\",\n      metaSementesDiversas: goal.metaSementesDiversas || \"0\",\n      metaFertilizantes: goal.metaFertilizantes || \"0\",\n      metaCorretivos: goal.metaCorretivos || \"0\",\n      realizadoAgroquimicos,\n      realizadoEspecialidades,\n      realizadoSementesMilho,\n      realizadoSementesSoja,\n      realizadoSementesTrigo,\n      realizadoSementesDiversas,\n      realizadoFertilizantes,\n      realizadoCorretivos,\n      percentAgroquimicos,\n      percentEspecialidades,\n      percentSementesMilho,\n      percentSementesSoja,\n      percentSementesTrigo,\n      percentSementesDiversas,\n      percentFertilizantes,\n      percentCorretivos,\n    };\n  });\n\n  const totalGoals = goalsWithDetails.length;\n  const activeGoals = goalsWithDetails.filter(g => g.status === \"em_andamento\").length;\n  const averageAchievement = totalGoals > 0 \n    ? goalsWithDetails.reduce((sum, goal) => sum + goal.percentage, 0) / totalGoals \n    : 0;\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Summary Cards */}\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\n        <Card className=\"shadow-sm\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center\">\n                <Target className=\"text-primary\" size={24} />\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Total de Metas</p>\n                <p className=\"text-2xl font-bold\">{totalGoals}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"shadow-sm\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"w-12 h-12 bg-chart-2/10 rounded-lg flex items-center justify-center\">\n                <Calendar className=\"text-chart-2\" size={24} />\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Metas Ativas</p>\n                <p className=\"text-2xl font-bold\">{activeGoals}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"shadow-sm\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"w-12 h-12 bg-verde/10 rounded-lg flex items-center justify-center\">\n                <TrendingUp className=\"text-verde\" size={24} />\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Atingimento Médio</p>\n                <p className=\"text-2xl font-bold\">{averageAchievement.toFixed(0)}%</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card className=\"shadow-sm\">\n          <CardContent className=\"p-6\">\n            <div className=\"flex items-center gap-4\">\n              <div className=\"w-12 h-12 bg-accent/10 rounded-lg flex items-center justify-center\">\n                <CheckCircle className=\"text-accent\" size={24} />\n              </div>\n              <div>\n                <p className=\"text-sm text-muted-foreground\">Metas Pessoais</p>\n                <p className=\"text-2xl font-bold\">{totalGoals}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Goals List */}\n      <Card className=\"shadow-sm\">\n        <CardHeader className=\"flex flex-row items-center justify-between\">\n          <CardTitle>Minhas Metas por Safra</CardTitle>\n          <div className=\"flex gap-2\">\n            <Button \n              variant=\"outline\"\n              onClick={openGlobalConfigDialog}\n              data-testid=\"button-incluir-potencial-geral\"\n            >\n              <Settings className=\"h-4 w-4 mr-2\" />\n              Incluir Potencial Geral\n            </Button>\n            <Button \n              variant=\"outline\"\n              onClick={() => {\n                const activeSeason = seasons?.find(s => s.isActive);\n                if (activeSeason) {\n                  setViewSeasonId(activeSeason.id);\n                }\n                setShowManejoDialog(true);\n              }}\n              data-testid=\"button-configurar-manejo\"\n            >\n              <Target className=\"h-4 w-4 mr-2\" />\n              Configurar Manejo\n            </Button>\n            <Dialog open={showNewGoalModal} onOpenChange={(open) => {\n              setShowNewGoalModal(open);\n              if (!open) resetForm();\n            }}>\n              <DialogTrigger asChild>\n                <Button data-testid=\"button-new-goal\">\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Nova Meta\n                </Button>\n              </DialogTrigger>\n              <DialogContent data-testid=\"new-goal-modal\" className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle>{editingGoal ? \"Editar Meta de Safra\" : \"Nova Meta de Safra\"}</DialogTitle>\n              </DialogHeader>\n              <form onSubmit={handleSubmit} className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"season\">Safra *</Label>\n                  <Select value={formData.seasonId} onValueChange={(value) => \n                    setFormData(prev => ({ ...prev, seasonId: value }))\n                  }>\n                    <SelectTrigger data-testid=\"select-season\">\n                      <SelectValue placeholder=\"Selecione a safra\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {seasons?.map((season) => (\n                        <SelectItem key={season.id} value={season.id}>\n                          {season.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-3\">\n                  <Label className=\"text-base font-semibold\">Metas por Categoria (USD)</Label>\n                  \n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                    <div>\n                      <Label htmlFor=\"metaAgroquimicos\">Agroquímicos</Label>\n                      <Input\n                        type=\"number\"\n                        step=\"0.01\"\n                        value={formData.metaAgroquimicos}\n                        onChange={(e) => setFormData(prev => ({ ...prev, metaAgroquimicos: e.target.value }))}\n                        placeholder=\"0.00\"\n                        className=\"font-mono\"\n                        data-testid=\"input-meta-agroquimicos\"\n                      />\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"metaEspecialidades\">Especialidades</Label>\n                      <Input\n                        type=\"number\"\n                        step=\"0.01\"\n                        value={formData.metaEspecialidades}\n                        onChange={(e) => setFormData(prev => ({ ...prev, metaEspecialidades: e.target.value }))}\n                        placeholder=\"0.00\"\n                        className=\"font-mono\"\n                        data-testid=\"input-meta-especialidades\"\n                      />\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"metaSementesMilho\">Sementes Milho</Label>\n                      <Input\n                        type=\"number\"\n                        step=\"0.01\"\n                        value={formData.metaSementesMilho}\n                        onChange={(e) => setFormData(prev => ({ ...prev, metaSementesMilho: e.target.value }))}\n                        placeholder=\"0.00\"\n                        className=\"font-mono\"\n                        data-testid=\"input-meta-sementes-milho\"\n                      />\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"metaSementesSoja\">Sementes Soja</Label>\n                      <Input\n                        type=\"number\"\n                        step=\"0.01\"\n                        value={formData.metaSementesSoja}\n                        onChange={(e) => setFormData(prev => ({ ...prev, metaSementesSoja: e.target.value }))}\n                        placeholder=\"0.00\"\n                        className=\"font-mono\"\n                        data-testid=\"input-meta-sementes-soja\"\n                      />\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"metaSementesTrigo\">Sementes Trigo</Label>\n                      <Input\n                        type=\"number\"\n                        step=\"0.01\"\n                        value={formData.metaSementesTrigo}\n                        onChange={(e) => setFormData(prev => ({ ...prev, metaSementesTrigo: e.target.value }))}\n                        placeholder=\"0.00\"\n                        className=\"font-mono\"\n                        data-testid=\"input-meta-sementes-trigo\"\n                      />\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"metaSementesDiversas\">Sementes Diversas</Label>\n                      <Input\n                        type=\"number\"\n                        step=\"0.01\"\n                        value={formData.metaSementesDiversas}\n                        onChange={(e) => setFormData(prev => ({ ...prev, metaSementesDiversas: e.target.value }))}\n                        placeholder=\"0.00\"\n                        className=\"font-mono\"\n                        data-testid=\"input-meta-sementes-diversas\"\n                      />\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"metaFertilizantes\">Fertilizantes</Label>\n                      <Input\n                        type=\"number\"\n                        step=\"0.01\"\n                        value={formData.metaFertilizantes}\n                        onChange={(e) => setFormData(prev => ({ ...prev, metaFertilizantes: e.target.value }))}\n                        placeholder=\"0.00\"\n                        className=\"font-mono\"\n                        data-testid=\"input-meta-fertilizantes\"\n                      />\n                    </div>\n\n                    <div>\n                      <Label htmlFor=\"metaCorretivos\">Corretivos</Label>\n                      <Input\n                        type=\"number\"\n                        step=\"0.01\"\n                        value={formData.metaCorretivos}\n                        onChange={(e) => setFormData(prev => ({ ...prev, metaCorretivos: e.target.value }))}\n                        placeholder=\"0.00\"\n                        className=\"font-mono\"\n                        data-testid=\"input-meta-corretivos\"\n                      />\n                    </div>\n                  </div>\n                </div>\n\n                <div className=\"bg-muted p-4 rounded-lg\">\n                  <Label className=\"text-base font-semibold\">Meta Global (USD)</Label>\n                  <p className=\"text-2xl font-bold font-mono mt-2 text-primary\">\n                    ${calculateGlobalGoal().toLocaleString()}\n                  </p>\n                  <p className=\"text-sm text-muted-foreground mt-1\">\n                    Soma das metas por categoria\n                  </p>\n                </div>\n\n                <div className=\"flex justify-end gap-3 pt-4\">\n                  <Button\n                    type=\"button\"\n                    variant=\"outline\"\n                    onClick={() => setShowNewGoalModal(false)}\n                    data-testid=\"button-cancel\"\n                  >\n                    Cancelar\n                  </Button>\n                  <Button\n                    type=\"submit\"\n                    disabled={createGoalMutation.isPending}\n                    data-testid=\"button-save\"\n                  >\n                    {createGoalMutation.isPending ? \"Salvando...\" : \"Salvar Meta\"}\n                  </Button>\n                </div>\n              </form>\n              </DialogContent>\n            </Dialog>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {goalsLoading ? (\n            <div className=\"text-center py-12 text-muted-foreground\">\n              Carregando metas...\n            </div>\n          ) : goalsWithDetails.length === 0 ? (\n            <div className=\"text-center py-12\">\n              <Target className=\"h-16 w-16 mx-auto text-muted-foreground mb-4\" />\n              <p className=\"text-muted-foreground mb-4\">Nenhuma meta definida</p>\n              <Button \n                onClick={() => setShowNewGoalModal(true)}\n                data-testid=\"button-first-goal\"\n              >\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Definir primeira meta\n              </Button>\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Safra</TableHead>\n                    <TableHead>Tipo</TableHead>\n                    <TableHead className=\"text-right\">Meta (USD)</TableHead>\n                    <TableHead className=\"text-right\">Realizado (USD)</TableHead>\n                    <TableHead>Atingimento</TableHead>\n                    <TableHead className=\"text-center\">Status</TableHead>\n                    <TableHead className=\"text-center\">Ações</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {goalsWithDetails.map((goal) => (\n                    <TableRow key={goal.id} data-testid={`goal-row-${goal.id}`}>\n                      <TableCell className=\"font-medium\">{goal.seasonName}</TableCell>\n                      <TableCell>\n                        <Badge className={getTypeBadgeClass(goal.seasonType)}>\n                          {getTypeLabel(goal.seasonType)}\n                        </Badge>\n                      </TableCell>\n                      <TableCell className=\"text-right font-mono font-bold\">\n                        ${goal.goalAmount.toLocaleString()}\n                      </TableCell>\n                      <TableCell className=\"text-right font-mono font-bold text-primary\">\n                        ${goal.achievedAmount.toLocaleString()}\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"space-y-1\">\n                          <Progress value={Math.min(goal.percentage, 100)} className=\"h-2\" />\n                          <p className=\"text-xs font-medium\">{goal.percentage.toFixed(1)}%</p>\n                        </div>\n                      </TableCell>\n                      <TableCell className=\"text-center\">\n                        <Badge variant={goal.status === \"concluida\" ? \"default\" : \"secondary\"}>\n                          {goal.status === \"concluida\" ? \"Concluída\" : \"Em Andamento\"}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"flex items-center justify-center gap-2\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => handleEditClick(goal as any)}\n                            data-testid={`button-edit-goal-${goal.id}`}\n                          >\n                            <Edit className=\"h-4 w-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"icon\"\n                            onClick={() => handleDeleteClick(goal.id)}\n                            data-testid={`button-delete-goal-${goal.id}`}\n                          >\n                            <Trash2 className=\"h-4 w-4 text-destructive\" />\n                          </Button>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Delete Confirmation Dialog */}\n      <AlertDialog open={!!goalToDelete} onOpenChange={(open) => !open && setGoalToDelete(null)}>\n        <AlertDialogContent>\n          <AlertDialogHeader>\n            <AlertDialogTitle>Confirmar Exclusão</AlertDialogTitle>\n            <AlertDialogDescription>\n              Tem certeza que deseja excluir esta meta? Esta ação não pode ser desfeita.\n            </AlertDialogDescription>\n          </AlertDialogHeader>\n          <AlertDialogFooter>\n            <AlertDialogCancel data-testid=\"button-cancel-delete\">Cancelar</AlertDialogCancel>\n            <AlertDialogAction\n              onClick={confirmDelete}\n              className=\"bg-destructive text-destructive-foreground hover:bg-destructive/90\"\n              data-testid=\"button-confirm-delete\"\n            >\n              Excluir\n            </AlertDialogAction>\n          </AlertDialogFooter>\n        </AlertDialogContent>\n      </AlertDialog>\n\n      {/* Global Configuration Dialog */}\n      <Dialog open={showGlobalConfig} onOpenChange={(open) => !open && closeGlobalConfigDialog()}>\n        <DialogContent className=\"max-w-2xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Incluir Potencial Geral</DialogTitle>\n          </DialogHeader>\n          \n          {/* Season Selection */}\n          <div className=\"mt-4\">\n            <Label htmlFor=\"global-season-select\" className=\"text-base font-semibold\">Safra</Label>\n            <Select value={globalSeasonId} onValueChange={setGlobalSeasonId}>\n              <SelectTrigger id=\"global-season-select\" data-testid=\"select-global-season\">\n                <SelectValue placeholder=\"Selecione a safra\" />\n              </SelectTrigger>\n              <SelectContent>\n                {seasons?.map((season) => (\n                  <SelectItem key={season.id} value={season.id} data-testid={`global-season-option-${season.id}`}>\n                    {season.name} {season.isActive && \"(Ativa)\"}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n\n          <div className=\"space-y-4 mt-4\">\n            {(categories && Array.isArray(categories)) ? categories.map((category: any) => {\n              const categoryId = category.id;\n              const categoryName = category.name;\n              const isAgroquimicos = categoryName.toLowerCase().includes('agroqu');\n              const hasSubcategoryValues = isAgroquimicos && globalSubcategoryValues[categoryId] \n                && Object.values(globalSubcategoryValues[categoryId]).some(v => v?.trim() !== '');\n              \n              return (\n                <div key={categoryId} className=\"border rounded-lg p-4 space-y-3\">\n                  <Label htmlFor={`global-rate-${categoryId}`} className=\"text-base font-semibold\">\n                    {categoryName}\n                  </Label>\n                  <div className=\"flex-1\">\n                    <Input\n                      id={`global-rate-${categoryId}`}\n                      type=\"number\"\n                      step=\"0.01\"\n                      placeholder=\"Ex: 150.00\"\n                      value={globalRateValues[categoryId] || ''}\n                      onChange={(e) => setGlobalRateValues({ ...globalRateValues, [categoryId]: e.target.value })}\n                      readOnly={hasSubcategoryValues}\n                      className={hasSubcategoryValues ? 'bg-muted cursor-not-allowed' : ''}\n                      data-testid={`input-global-rate-${categoryId}`}\n                    />\n                    {hasSubcategoryValues ? (\n                      <p className=\"text-xs text-primary mt-1 font-medium\">\n                        ✓ Calculado automaticamente pela soma das subcategorias\n                      </p>\n                    ) : (\n                      <p className=\"text-xs text-muted-foreground mt-1\">\n                        USD por hectare (total geral)\n                      </p>\n                    )}\n                  </div>\n                  \n                  {/* Subcategories for Agroquímicos */}\n                  {isAgroquimicos && (\n                    <div className=\"mt-4 pl-4 border-l-2 border-primary/20 space-y-3\">\n                      <p className=\"text-sm font-medium text-muted-foreground\">\n                        Detalhamento por subcategoria (opcional):\n                      </p>\n                      {AGROQUIMICOS_SUBCATEGORIAS.map((subcat) => (\n                        <div key={subcat} className=\"flex items-center gap-2\">\n                          <Label htmlFor={`global-subcat-${categoryId}-${subcat}`} className=\"text-sm w-28\">\n                            {subcat}:\n                          </Label>\n                          <Input\n                            id={`global-subcat-${categoryId}-${subcat}`}\n                            type=\"number\"\n                            step=\"0.01\"\n                            placeholder=\"0.00\"\n                            value={globalSubcategoryValues[categoryId]?.[subcat] || ''}\n                            onChange={(e) => setGlobalSubcategoryValues({\n                              ...globalSubcategoryValues,\n                              [categoryId]: {\n                                ...globalSubcategoryValues[categoryId],\n                                [subcat]: e.target.value\n                              }\n                            })}\n                            className=\"flex-1\"\n                            data-testid={`input-global-subcat-${categoryId}-${subcat}`}\n                          />\n                          <span className=\"text-xs text-muted-foreground w-16\">$/ha</span>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n                </div>\n              );\n            }) : null}\n          </div>\n\n          <div className=\"mt-6 space-y-4\">\n            {/* Recalculate button */}\n            {existingMarketRates && existingMarketRates.length > 0 && (\n              <div className=\"border border-primary/20 rounded-lg p-4 bg-primary/5\">\n                <div className=\"flex items-start justify-between gap-4\">\n                  <div className=\"flex-1\">\n                    <h4 className=\"text-sm font-semibold mb-1\">Reaplicar valores salvos</h4>\n                    <p className=\"text-xs text-muted-foreground\">\n                      Clique aqui para reaplicar os valores já configurados para todos os clientes da equipe (incluindo novos clientes adicionados após a última configuração).\n                    </p>\n                  </div>\n                  <Button \n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => recalculatePotentialMutation.mutate()}\n                    disabled={recalculatePotentialMutation.isPending}\n                    data-testid=\"button-recalculate-potential\"\n                  >\n                    {recalculatePotentialMutation.isPending ? \"Recalculando...\" : \"Recalcular Potencial\"}\n                  </Button>\n                </div>\n              </div>\n            )}\n\n            <div className=\"flex justify-between items-center\">\n              <p className=\"text-sm text-muted-foreground\">\n                Os valores serão aplicados para todos os clientes marcados com badge amarelo (Mercado)\n              </p>\n              <div className=\"flex gap-2\">\n                <Button variant=\"outline\" onClick={closeGlobalConfigDialog} data-testid=\"button-cancel-global\">\n                  Cancelar\n                </Button>\n                <Button \n                  onClick={handleSaveGlobalRates} \n                  disabled={saveGlobalRatesMutation.isPending}\n                  data-testid=\"button-save-global\"\n                >\n                  {saveGlobalRatesMutation.isPending ? \"Aplicando...\" : \"Aplicar a Toda a Equipe\"}\n                </Button>\n              </div>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Modal de Configuração de Manejo Global */}\n      <Dialog open={showManejoDialog} onOpenChange={setShowManejoDialog}>\n        <DialogContent className=\"max-w-4xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Configurar Manejo Global</DialogTitle>\n            <DialogDescription>\n              Configure as aplicações de fungicidas e inseticidas que serão usadas para todos os clientes da equipe.\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-6\">\n            {/* Seleção de Safra */}\n            <div className=\"space-y-2\">\n              <Label>Safra *</Label>\n              <Select value={viewSeasonId} onValueChange={setViewSeasonId}>\n                <SelectTrigger data-testid=\"select-manejo-season\">\n                  <SelectValue placeholder=\"Selecione a safra\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {seasons?.map((season: any) => (\n                    <SelectItem key={season.id} value={season.id}>\n                      {season.name} ({season.year})\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              {!viewSeasonId && (\n                <p className=\"text-sm text-muted-foreground\">\n                  Selecione uma safra para configurar o manejo global\n                </p>\n              )}\n            </div>\n            {/* Fungicidas */}\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center justify-between mb-4\">\n                  <h3 className=\"text-lg font-semibold\">Fungicidas</h3>\n                  <Button\n                    size=\"sm\"\n                    disabled={!viewSeasonId}\n                    onClick={() => {\n                      if (!viewSeasonId) {\n                        toast({\n                          title: \"Safra não selecionada\",\n                          description: \"Selecione uma safra antes de adicionar aplicações.\",\n                          variant: \"destructive\"\n                        });\n                        return;\n                      }\n                      if (fungicidasProducts.length === 0) {\n                        toast({\n                          title: \"Sem produtos\",\n                          description: \"Cadastre produtos de fungicidas primeiro no painel admin.\",\n                          variant: \"destructive\"\n                        });\n                        return;\n                      }\n                      setApplicationCategory(\"FUNGICIDAS\");\n                      const existingApps = globalManagementApplications?.filter((a: any) => a.categoria === \"FUNGICIDAS\") || [];\n                      const maxNumber = existingApps.length > 0 ? Math.max(...existingApps.map((a: any) => a.applicationNumber)) : 0;\n                      setApplicationNumber(maxNumber + 1);\n                      setSelectedProductId(fungicidasProducts[0]?.id || \"\");\n                      setSelectedPriceTier(\"verde\");\n                      setProductsInApplication([]);\n                      setShowAddApplicationDialog(true);\n                    }}\n                    data-testid=\"button-add-fungicida\"\n                  >\n                    <Target className=\"h-4 w-4 mr-1\" />\n                    Adicionar Aplicação\n                  </Button>\n                </div>\n\n                <div className=\"space-y-2\">\n                  {(() => {\n                    const fungicidasApps = globalManagementApplications?.filter((a: any) => a.categoria === \"FUNGICIDAS\") || [];\n                    \n                    const groupedApps = fungicidasApps.reduce((acc: any, app: any) => {\n                      if (!acc[app.applicationNumber]) {\n                        acc[app.applicationNumber] = [];\n                      }\n                      acc[app.applicationNumber].push(app);\n                      return acc;\n                    }, {});\n                    \n                    const appNumbers = Object.keys(groupedApps).sort((a, b) => Number(a) - Number(b));\n                    \n                    if (appNumbers.length === 0) {\n                      return (\n                        <p className=\"text-muted-foreground text-sm text-center py-4\">\n                          Nenhuma aplicação de fungicida configurada\n                        </p>\n                      );\n                    }\n                    \n                    return appNumbers.map(appNum => {\n                      const apps = groupedApps[appNum];\n                      const totalCost = apps.reduce((sum: number, app: any) => sum + Number(app.pricePerHa || 0), 0);\n                      \n                      return (\n                        <div key={appNum} className=\"border rounded p-2\">\n                          <div className=\"flex items-start gap-2\">\n                            <span className=\"font-medium min-w-[100px] mt-1\">Aplicação {appNum}</span>\n                            <div className=\"flex-1 space-y-1\">\n                              {apps.map((app: any) => {\n                                const product = priceTableProducts?.find((p: any) => p.id === app.productId);\n                                return (\n                                  <div key={app.id} className=\"flex items-center gap-2 text-sm\">\n                                    <span className=\"flex-1\">{product?.mercaderia || \"Produto\"}</span>\n                                    <span className={`px-2 py-0.5 rounded text-xs font-medium ${\n                                      app.priceTier === \"verde\" ? \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100\" : \n                                      app.priceTier === \"amarela\" ? \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-100\" : \n                                      \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100\"\n                                    }`}>\n                                      {app.priceTier === \"verde\" ? \"Verde\" : app.priceTier === \"amarela\" ? \"Amarela\" : \"Vermelha\"}\n                                    </span>\n                                    <Button\n                                      size=\"icon\"\n                                      variant=\"ghost\"\n                                      className=\"h-6 w-6\"\n                                      onClick={() => deleteApplicationMutation.mutate(app.id)}\n                                      data-testid={`button-delete-app-${app.id}`}\n                                    >\n                                      <Trash className=\"h-3 w-3 text-red-600\" />\n                                    </Button>\n                                  </div>\n                                );\n                              })}\n                            </div>\n                            <span className=\"font-mono font-bold text-lg\">${totalCost.toFixed(2)}/ha</span>\n                          </div>\n                        </div>\n                      );\n                    });\n                  })()}\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Inseticidas */}\n            <Card>\n              <CardContent className=\"p-4\">\n                <div className=\"flex items-center justify-between mb-4\">\n                  <h3 className=\"text-lg font-semibold\">Inseticidas</h3>\n                  <Button\n                    size=\"sm\"\n                    disabled={!viewSeasonId}\n                    onClick={() => {\n                      if (!viewSeasonId) {\n                        toast({\n                          title: \"Safra não selecionada\",\n                          description: \"Selecione uma safra antes de adicionar aplicações.\",\n                          variant: \"destructive\"\n                        });\n                        return;\n                      }\n                      if (inseticidasProducts.length === 0) {\n                        toast({\n                          title: \"Sem produtos\",\n                          description: \"Cadastre produtos de inseticidas primeiro no painel admin.\",\n                          variant: \"destructive\"\n                        });\n                        return;\n                      }\n                      setApplicationCategory(\"INSETICIDAS\");\n                      const existingApps = globalManagementApplications?.filter((a: any) => a.categoria === \"INSETICIDAS\") || [];\n                      const maxNumber = existingApps.length > 0 ? Math.max(...existingApps.map((a: any) => a.applicationNumber)) : 0;\n                      setApplicationNumber(maxNumber + 1);\n                      setSelectedProductId(inseticidasProducts[0]?.id || \"\");\n                      setSelectedPriceTier(\"verde\");\n                      setProductsInApplication([]);\n                      setShowAddApplicationDialog(true);\n                    }}\n                    data-testid=\"button-add-inseticida\"\n                  >\n                    <Target className=\"h-4 w-4 mr-1\" />\n                    Adicionar Aplicação\n                  </Button>\n                </div>\n\n                <div className=\"space-y-2\">\n                  {(() => {\n                    const inseticidasApps = globalManagementApplications?.filter((a: any) => a.categoria === \"INSETICIDAS\") || [];\n                    \n                    const groupedApps = inseticidasApps.reduce((acc: any, app: any) => {\n                      if (!acc[app.applicationNumber]) {\n                        acc[app.applicationNumber] = [];\n                      }\n                      acc[app.applicationNumber].push(app);\n                      return acc;\n                    }, {});\n                    \n                    const appNumbers = Object.keys(groupedApps).sort((a, b) => Number(a) - Number(b));\n                    \n                    if (appNumbers.length === 0) {\n                      return (\n                        <p className=\"text-muted-foreground text-sm text-center py-4\">\n                          Nenhuma aplicação de inseticida configurada\n                        </p>\n                      );\n                    }\n                    \n                    return appNumbers.map(appNum => {\n                      const apps = groupedApps[appNum];\n                      const totalCost = apps.reduce((sum: number, app: any) => sum + Number(app.pricePerHa || 0), 0);\n                      \n                      return (\n                        <div key={appNum} className=\"border rounded p-2\">\n                          <div className=\"flex items-start gap-2\">\n                            <span className=\"font-medium min-w-[100px] mt-1\">Aplicação {appNum}</span>\n                            <div className=\"flex-1 space-y-1\">\n                              {apps.map((app: any) => {\n                                const product = priceTableProducts?.find((p: any) => p.id === app.productId);\n                                return (\n                                  <div key={app.id} className=\"flex items-center gap-2 text-sm\">\n                                    <span className=\"flex-1\">{product?.mercaderia || \"Produto\"}</span>\n                                    <span className={`px-2 py-0.5 rounded text-xs font-medium ${\n                                      app.priceTier === \"verde\" ? \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100\" : \n                                      app.priceTier === \"amarela\" ? \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-100\" : \n                                      \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100\"\n                                    }`}>\n                                      {app.priceTier === \"verde\" ? \"Verde\" : app.priceTier === \"amarela\" ? \"Amarela\" : \"Vermelha\"}\n                                    </span>\n                                    <Button\n                                      size=\"icon\"\n                                      variant=\"ghost\"\n                                      className=\"h-6 w-6\"\n                                      onClick={() => deleteApplicationMutation.mutate(app.id)}\n                                      data-testid={`button-delete-app-${app.id}`}\n                                    >\n                                      <Trash className=\"h-3 w-3 text-red-600\" />\n                                    </Button>\n                                  </div>\n                                );\n                              })}\n                            </div>\n                            <span className=\"font-mono font-bold text-lg\">${totalCost.toFixed(2)}/ha</span>\n                          </div>\n                        </div>\n                      );\n                    });\n                  })()}\n                </div>\n              </CardContent>\n            </Card>\n          </div>\n\n          <DialogFooter>\n            <Button onClick={() => setShowManejoDialog(false)} data-testid=\"button-close-manejo\">\n              Fechar\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Modal de Adição de Aplicação */}\n      <Dialog open={showAddApplicationDialog} onOpenChange={setShowAddApplicationDialog}>\n        <DialogContent className=\"max-w-2xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Adicionar Aplicação de {applicationCategory === \"FUNGICIDAS\" ? \"Fungicida\" : \"Inseticida\"}</DialogTitle>\n            <DialogDescription>\n              Escolha o número da aplicação e adicione um ou mais produtos.\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"application-number\">Número da Aplicação</Label>\n              <Select \n                value={applicationNumber.toString()} \n                onValueChange={(val) => setApplicationNumber(Number(val))}\n              >\n                <SelectTrigger id=\"application-number\" data-testid=\"select-application-number\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"1\">1ª Aplicação</SelectItem>\n                  <SelectItem value=\"2\">2ª Aplicação</SelectItem>\n                  <SelectItem value=\"3\">3ª Aplicação</SelectItem>\n                  <SelectItem value=\"4\">4ª Aplicação</SelectItem>\n                  <SelectItem value=\"5\">5ª Aplicação</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {productsInApplication.length > 0 && (\n              <Card>\n                <CardContent className=\"p-3\">\n                  <h4 className=\"font-semibold mb-2 text-sm\">Produtos adicionados:</h4>\n                  <div className=\"space-y-2\">\n                    {productsInApplication.map((item, idx) => {\n                      const product = priceTableProducts?.find((p: any) => p.id === item.productId);\n                      return (\n                        <div key={idx} className=\"flex items-center gap-2 p-2 border rounded text-sm\">\n                          <span className=\"flex-1\">{product?.mercaderia || \"Produto\"}</span>\n                          <span className={`px-2 py-1 rounded text-xs font-medium ${\n                            item.priceTier === \"verde\" ? \"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100\" : \n                            item.priceTier === \"amarela\" ? \"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-100\" : \n                            \"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100\"\n                          }`}>\n                            {item.priceTier === \"verde\" ? \"Verde\" : item.priceTier === \"amarela\" ? \"Amarela\" : \"Vermelha\"}\n                          </span>\n                          <Button\n                            size=\"icon\"\n                            variant=\"ghost\"\n                            className=\"h-7 w-7\"\n                            onClick={() => {\n                              setProductsInApplication(prev => prev.filter((_, i) => i !== idx));\n                            }}\n                            data-testid={`button-remove-product-${idx}`}\n                          >\n                            <Trash className=\"h-4 w-4 text-red-600\" />\n                          </Button>\n                        </div>\n                      );\n                    })}\n                  </div>\n                </CardContent>\n              </Card>\n            )}\n\n            <div className=\"border-t pt-4\">\n              <h4 className=\"font-semibold mb-3\">Adicionar produto:</h4>\n              <div className=\"space-y-3\">\n                <div>\n                  <Label htmlFor=\"product-select\">Produto</Label>\n                  <Select value={selectedProductId} onValueChange={setSelectedProductId}>\n                    <SelectTrigger id=\"product-select\" data-testid=\"select-product\">\n                      <SelectValue placeholder=\"Selecione um produto\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {(applicationCategory === \"FUNGICIDAS\" ? fungicidasProducts : inseticidasProducts).map((product: any) => (\n                        <SelectItem key={product.id} value={product.id}>\n                          {product.mercaderia}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div>\n                  <Label htmlFor=\"price-tier-select\">Tier de Preço</Label>\n                  <Select value={selectedPriceTier} onValueChange={setSelectedPriceTier}>\n                    <SelectTrigger id=\"price-tier-select\" data-testid=\"select-price-tier\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"verde\">Verde</SelectItem>\n                      <SelectItem value=\"amarela\">Amarela</SelectItem>\n                      <SelectItem value=\"vermelha\">Vermelha</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                {selectedProductId && (\n                  <div className=\"p-3 bg-muted rounded-lg\">\n                    <div className=\"text-sm text-muted-foreground\">Custo por hectare (preço × dose):</div>\n                    <div className=\"text-xl font-bold\">\n                      ${(() => {\n                        const product = priceTableProducts?.find((p: any) => p.id === selectedProductId);\n                        if (!product) return \"0.00\";\n                        \n                        let basePrice = 0;\n                        if (selectedPriceTier === \"verde\") basePrice = Number(product.preco_verde || product.precoVerde || 0);\n                        else if (selectedPriceTier === \"amarela\") basePrice = Number(product.preco_amarela || product.precoAmarela || 0);\n                        else basePrice = Number(product.preco_vermelha || product.precoVermelha || 0);\n                        \n                        let dose = 1;\n                        if (product.dose) {\n                          const doseStr = product.dose.toString().replace(',', '.');\n                          const doseMatch = doseStr.match(/[\\d.]+/);\n                          if (doseMatch) {\n                            dose = parseFloat(doseMatch[0]);\n                          }\n                        }\n                        \n                        const costPerHa = basePrice * dose;\n                        return costPerHa.toFixed(2);\n                      })()}/ha\n                    </div>\n                    <div className=\"text-xs text-muted-foreground mt-1\">\n                      {(() => {\n                        const product = priceTableProducts?.find((p: any) => p.id === selectedProductId);\n                        if (!product) return \"\";\n                        \n                        let basePrice = 0;\n                        if (selectedPriceTier === \"verde\") basePrice = Number(product.preco_verde || product.precoVerde || 0);\n                        else if (selectedPriceTier === \"amarela\") basePrice = Number(product.preco_amarela || product.precoAmarela || 0);\n                        else basePrice = Number(product.preco_vermelha || product.precoVermelha || 0);\n                        \n                        let doseNumeric = 1;\n                        if (product.dose) {\n                          const doseStr = product.dose.toString().replace(',', '.');\n                          const doseMatch = doseStr.match(/[\\d.]+/);\n                          if (doseMatch) {\n                            doseNumeric = parseFloat(doseMatch[0]);\n                          }\n                        }\n                        \n                        const doseDisplay = product.dose || \"1\";\n                        return `$${basePrice.toFixed(2)} × ${doseDisplay} = $${(basePrice * doseNumeric).toFixed(2)}/ha`;\n                      })()}\n                    </div>\n                  </div>\n                )}\n\n                <Button \n                  onClick={() => {\n                    if (!selectedProductId) {\n                      toast({\n                        title: \"Erro\",\n                        description: \"Selecione um produto primeiro.\",\n                        variant: \"destructive\"\n                      });\n                      return;\n                    }\n                    setProductsInApplication(prev => [...prev, { productId: selectedProductId, priceTier: selectedPriceTier }]);\n                    setSelectedProductId(\"\");\n                    setSelectedPriceTier(\"verde\");\n                  }}\n                  disabled={!selectedProductId}\n                  className=\"w-full\"\n                  data-testid=\"button-add-to-list\"\n                >\n                  <Target className=\"h-4 w-4 mr-1\" />\n                  Adicionar à Lista\n                </Button>\n              </div>\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setShowAddApplicationDialog(false)}>\n              Cancelar\n            </Button>\n            <Button \n              onClick={async () => {\n                if (productsInApplication.length === 0) {\n                  toast({\n                    title: \"Erro\",\n                    description: \"Adicione pelo menos um produto à lista.\",\n                    variant: \"destructive\"\n                  });\n                  return;\n                }\n                \n                for (const item of productsInApplication) {\n                  await createApplicationMutation.mutateAsync({\n                    categoria: applicationCategory,\n                    applicationNumber: applicationNumber,\n                    productId: item.productId,\n                    priceTier: item.priceTier,\n                    seasonId: viewSeasonId\n                  });\n                }\n                \n                setShowAddApplicationDialog(false);\n                setProductsInApplication([]);\n              }}\n              disabled={productsInApplication.length === 0 || createApplicationMutation.isPending}\n              data-testid=\"button-confirm-add-application\"\n            >\n              {createApplicationMutation.isPending ? \"Salvando...\" : \"Concluir\"}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n\nfunction CapturedTargetsCard() {\n  const [selectedSegmento, setSelectedSegmento] = useState<string | null>(null);\n  const [selectedSeasonId, setSelectedSeasonId] = useState<string | null>(null);\n  \n  const { data: capturedData, isLoading } = useQuery<any>({\n    queryKey: ['/api/manager/team-captured-totals'],\n  });\n\n  const { data: clientsData, isLoading: isLoadingClients } = useQuery<any>({\n    queryKey: [`/api/manager/team-captured-by-category/${selectedSegmento}?seasonId=${selectedSeasonId}`],\n    enabled: !!selectedSegmento && !!selectedSeasonId,\n  });\n\n  const formatCurrency = (value: number) => {\n    return new Intl.NumberFormat('en-US', {\n      style: 'currency',\n      currency: 'USD',\n      minimumFractionDigits: 0,\n    }).format(value);\n  };\n\n  if (isLoading) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle>Metas Capturadas pela Equipe</CardTitle>\n          <CardDescription>Valores totais comprometidos por safra</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"captured-targets-loading\">\n            Carregando...\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  const totalsBySeason = capturedData?.totalsBySeason || {};\n  const seasonIds = Object.keys(totalsBySeason);\n\n  if (seasonIds.length === 0) {\n    return (\n      <Card>\n        <CardHeader>\n          <CardTitle>Metas Capturadas pela Equipe</CardTitle>\n          <CardDescription>Valores totais comprometidos por safra</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"captured-targets-empty\">\n            Nenhuma meta capturada ainda\n          </div>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  // Calculate grand total across all seasons\n  const grandTotal = seasonIds.reduce((sum, seasonId) => {\n    return sum + totalsBySeason[seasonId].seasonTotal;\n  }, 0);\n\n  return (\n    <>\n      <Card>\n        <CardHeader>\n          <CardTitle>Metas Capturadas pela Equipe</CardTitle>\n          <CardDescription>Valores totais comprometidos por safra (clique nas categorias para ver detalhes)</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-3\">\n            {/* Grand Total */}\n            <div className=\"p-2.5 bg-primary/10 rounded-lg border-2 border-primary\">\n              <div className=\"flex items-center justify-between\">\n                <span className=\"text-base font-bold\">Total Geral</span>\n                <span className=\"text-xl font-bold text-primary\" data-testid=\"captured-grand-total\">\n                  {formatCurrency(grandTotal)}\n                </span>\n              </div>\n            </div>\n\n            {/* Seasons */}\n            {seasonIds.map((seasonId) => {\n              const seasonData = totalsBySeason[seasonId];\n              const categories = Object.keys(seasonData.categories);\n\n              return (\n                <div key={seasonId} className=\"space-y-1.5\">\n                  {/* Season Header */}\n                  <div className=\"p-2 bg-green-50 dark:bg-green-950/20 rounded-lg border border-green-200 dark:border-green-800\">\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-sm font-bold text-green-700 dark:text-green-400\" data-testid={`season-name-${seasonId}`}>\n                        {seasonData.seasonName}\n                      </span>\n                      <span className=\"text-base font-bold text-green-600 dark:text-green-400\" data-testid={`season-total-${seasonId}`}>\n                        {formatCurrency(seasonData.seasonTotal)}\n                      </span>\n                    </div>\n                  </div>\n\n                  {/* Categories within this Season */}\n                  <div className=\"grid gap-2 md:grid-cols-2 lg:grid-cols-4 ml-2\">\n                    {categories.map((segmento) => {\n                      const categoryData = seasonData.categories[segmento];\n                      const hasSubcategories = categoryData.subcategories && Object.keys(categoryData.subcategories).length > 0;\n\n                      return (\n                        <Card \n                          key={segmento} \n                          className=\"shadow-sm cursor-pointer hover:shadow-md hover:border-primary transition-all\"\n                          onClick={() => {\n                            setSelectedSegmento(segmento);\n                            setSelectedSeasonId(seasonId);\n                          }}\n                          data-testid={`card-category-${seasonId}-${segmento}`}\n                        >\n                          <CardHeader className=\"pb-2 pt-2.5 px-3\">\n                            <CardTitle className=\"text-sm\">{categoryData.categoryName}</CardTitle>\n                          </CardHeader>\n                          <CardContent className=\"px-3 pb-2.5\">\n                            <div className=\"space-y-1.5\">\n                              <div className=\"flex items-center justify-between\">\n                                <span className=\"text-xs font-medium text-muted-foreground\">Total</span>\n                                <span \n                                  className=\"text-base font-bold text-green-600\"\n                                  data-testid={`captured-total-${seasonId}-${segmento}`}\n                                >\n                                  {formatCurrency(categoryData.total)}\n                                </span>\n                              </div>\n\n                              {/* Subcategories for Agroquímicos */}\n                              {hasSubcategories && (\n                                <div className=\"mt-1.5 pt-1.5 border-t space-y-1\">\n                                  <p className=\"text-xs font-medium text-muted-foreground mb-1\">Detalhes:</p>\n                                  {Object.entries(categoryData.subcategories).map(([subcatName, subcatValue]) => (\n                                    <div key={subcatName} className=\"flex items-center justify-between pl-2\">\n                                      <span className=\"text-xs text-muted-foreground\">{subcatName}</span>\n                                      <span \n                                        className=\"text-xs font-semibold\"\n                                        data-testid={`captured-subcat-${seasonId}-${segmento}-${subcatName.toLowerCase().replace(/\\s/g, '-')}`}\n                                      >\n                                        {formatCurrency(subcatValue as number)}\n                                      </span>\n                                    </div>\n                                  ))}\n                                </div>\n                              )}\n                            </div>\n                          </CardContent>\n                        </Card>\n                      );\n                    })}\n                  </div>\n                </div>\n              );\n            })}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Client Details Dialog */}\n      <Dialog open={!!selectedSegmento} onOpenChange={(open) => {\n        if (!open) {\n          setSelectedSegmento(null);\n          setSelectedSeasonId(null);\n        }\n      }}>\n        <DialogContent className=\"max-w-3xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>\n              Clientes - {selectedSegmento}\n            </DialogTitle>\n            <DialogDescription>\n              Detalhamento dos valores capturados por cliente nesta categoria\n            </DialogDescription>\n          </DialogHeader>\n\n          {isLoadingClients ? (\n            <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"clients-loading\">\n              Carregando clientes...\n            </div>\n          ) : clientsData?.clientTargets?.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"clients-empty\">\n              Nenhum cliente encontrado\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Cliente</TableHead>\n                    <TableHead>Consultor</TableHead>\n                    <TableHead className=\"text-right\">Valor Capturado</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {clientsData?.clientTargets?.map((client: any, index: number) => (\n                    <TableRow key={client.clientId} data-testid={`row-client-${index}`}>\n                      <TableCell className=\"font-medium\">{client.clientName}</TableCell>\n                      <TableCell>{client.consultorName}</TableCell>\n                      <TableCell className=\"text-right font-bold text-green-600\">\n                        {formatCurrency(client.valorCapturado)}\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n\n              {/* Show subcategory breakdown for individual clients if applicable */}\n              {selectedSegmento === 'agroquimicos' && (\n                <div className=\"mt-4\">\n                  <h4 className=\"text-sm font-semibold mb-3\">Detalhamento por Subcategorias:</h4>\n                  {clientsData?.clientTargets?.map((client: any, index: number) => {\n                    if (!client.subcategories || Object.keys(client.subcategories).length === 0) return null;\n                    \n                    return (\n                      <Card key={client.clientId} className=\"mb-3\">\n                        <CardHeader className=\"pb-3\">\n                          <CardTitle className=\"text-sm\">{client.clientName}</CardTitle>\n                        </CardHeader>\n                        <CardContent>\n                          <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                            {Object.entries(client.subcategories).map(([subcatName, subcatValue]) => (\n                              <div key={subcatName} className=\"flex justify-between\">\n                                <span className=\"text-muted-foreground\">{subcatName}:</span>\n                                <span className=\"font-semibold\">{formatCurrency(subcatValue as number)}</span>\n                              </div>\n                            ))}\n                          </div>\n                        </CardContent>\n                      </Card>\n                    );\n                  })}\n                </div>\n              )}\n            </div>\n          )}\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setSelectedSegmento(null)} data-testid=\"button-close-dialog\">\n              Fechar\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </>\n  );\n}\n","size_bytes":127822},"client/src/lib/faturista-route.tsx":{"content":"import { useAuth } from \"@/hooks/use-auth\";\nimport { Loader2 } from \"lucide-react\";\nimport { Redirect, Route } from \"wouter\";\n\nexport function FaturistaRoute({\n  path,\n  component: Component,\n}: {\n  path: string;\n  component: () => React.JSX.Element;\n}) {\n  const { user, isLoading } = useAuth();\n\n  if (isLoading) {\n    return (\n      <Route path={path}>\n        <div className=\"flex items-center justify-center min-h-screen\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-border\" />\n        </div>\n      </Route>\n    );\n  }\n\n  if (!user) {\n    return (\n      <Route path={path}>\n        <Redirect to=\"/auth\" />\n      </Route>\n    );\n  }\n\n  if (user.role !== 'faturista') {\n    return (\n      <Route path={path}>\n        <Redirect to=\"/dashboard\" />\n      </Route>\n    );\n  }\n\n  return <Route path={path} component={Component} />;\n}\n","size_bytes":844},"server/parse-inventory-pdf.ts":{"content":"import { createRequire } from \"module\";\n\nexport interface ParsedInventoryItem {\n  productCode: string;\n  productName: string;\n  packageType: string;\n  quantity: number;\n}\n\nexport interface ParsedPendingOrder {\n  productCode: string;\n  productName: string;\n  packageType: string;\n  quantityPending: number;\n  clientName: string;\n  consultorName?: string;\n  orderCode?: string;\n}\n\nconst require = createRequire(import.meta.url);\nlet pdfParser: any = null;\n\nfunction getPdfParser() {\n  if (!pdfParser) {\n    pdfParser = require(\"pdf-parse\");\n  }\n  return pdfParser;\n}\n\nexport async function parseInventoryPDF(buffer: Buffer): Promise<ParsedInventoryItem[]> {\n  const pdf = getPdfParser();\n  const data = await pdf(buffer);\n  const text = data.text;\n  \n  console.log('=== PDF TEXT EXTRACTED (first 500 chars) ===');\n  console.log(text.substring(0, 500));\n  console.log('=== END PDF TEXT ===');\n  \n  const lines = text.split('\\n').map((l: string) => l.trim()).filter((l: string) => l.length > 0);\n  const items: ParsedInventoryItem[] = [];\n  \n  console.log(`Total lines found: ${lines.length}`);\n  console.log('First 10 lines:', lines.slice(0, 10));\n  \n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i];\n    \n    // Match pattern: Cód.Int Embalaje Cant Costo Mercadería\n    // Example: \"0921273 BIDON 20 L 5 02,4 D AMINA TM - 2,4D AMINA 72% - 20LTS\"\n    // Pattern: 7-digit code + package type + quantity + cost + product name (rest)\n    const match = line.match(/^(\\d{7})\\s+([A-Z\\s\\d]+?)\\s+(\\d+(?:[,\\.]\\d+)?)\\s+\\d+(?:[,\\.]\\d+)?\\s*(.+)$/);\n    \n    if (match) {\n      let productCode = match[1].trim();\n      // Remove leading zero if present (0921273 -> 921273)\n      if (productCode.startsWith('0')) {\n        productCode = productCode.substring(1);\n      }\n      const packageType = match[2].trim();\n      const quantityStr = match[3].replace(/\\./g, '').replace(',', '.');\n      const quantity = parseFloat(quantityStr);\n      const productName = match[4].trim();\n      \n      if (!isNaN(quantity) && quantity >= 0) {\n        items.push({\n          productCode,\n          productName,\n          packageType,\n          quantity\n        });\n        console.log(`Matched item: ${productCode} - ${productName} - ${packageType} - ${quantity}`);\n      }\n    }\n  }\n  \n  console.log(`Total items parsed: ${items.length}`);\n  return items;\n}\n\nexport async function parseOrdersPDF(buffer: Buffer): Promise<ParsedPendingOrder[]> {\n  const pdf = getPdfParser();\n  const data = await pdf(buffer);\n  const text = data.text;\n  \n  console.log('=== ORDERS PDF TEXT (first 500 chars) ===');\n  console.log(text.substring(0, 500));\n  console.log('=== END ORDERS PDF TEXT ===');\n  \n  const lines = text.split('\\n').map((l: string) => l.trim()).filter((l: string) => l.length > 0);\n  const orders: ParsedPendingOrder[] = [];\n  \n  console.log(`Orders PDF: Total lines found: ${lines.length}`);\n  console.log('Orders PDF: First 30 lines:', lines.slice(0, 30));\n  \n  let currentClient = '';\n  let currentConsultor = '';\n  \n  for (let i = 0; i < lines.length; i++) {\n    const line = lines[i];\n    \n    // Extract client name - format: \"CLIENTE NOME CIDADE####\"\n    // Client appears before order code (pattern ending with numbers)\n    if (line.match(/^[A-Z\\s\\.]+\\d{5,}$/)) {\n      // Remove trailing numbers and trim\n      currentClient = line.replace(/\\d+$/, '').trim();\n      console.log(`Found client: ${currentClient}`);\n    }\n    \n    // Extract consultor/vendedor name from filters\n    if (line.includes('Comprador/Vendedor') && line.includes('-')) {\n      const match = line.match(/Comprador\\/Vendedor\\s+\\d+\\s+-\\s+([^:]+)/);\n      if (match) {\n        currentConsultor = match[1].trim();\n        console.log(`Found consultor: ${currentConsultor}`);\n      }\n    }\n    \n    // Match product lines\n    // Format: EMBALAJE(CÓDIGO) PRODUCTO valores... CANT_FALTA fecha\n    // Example: BIDON 10 L(924094) FERTILEADER 954 - VITAL - 10LTS 288,50 3.462,00 0 0 12 31/01/202512\n    const productMatch = line.match(/^([A-Z\\s\\d]+)\\((\\d{6,7})\\)\\s+(.+?)\\s+([\\d,\\.]+)\\s+([\\d,\\.]+)\\s+(\\d+)\\s+(\\d+)\\s+(\\d+)\\s+/);\n    \n    if (productMatch && currentClient) {\n      const packageType = productMatch[1].trim();\n      const productCode = productMatch[2].trim();\n      const productName = productMatch[3].trim();\n      const quantityPending = parseInt(productMatch[8]); // Cant. Falta is the 8th group\n      \n      if (!isNaN(quantityPending) && quantityPending > 0) {\n        orders.push({\n          productCode,\n          productName,\n          packageType,\n          quantityPending,\n          clientName: currentClient,\n          consultorName: currentConsultor || undefined\n        });\n        console.log(`Matched order: ${productCode} - ${productName} - ${quantityPending} units for ${currentClient}`);\n      }\n    }\n  }\n  \n  console.log(`Total orders parsed: ${orders.length}`);\n  \n  return orders;\n}\n","size_bytes":4889},"client/src/pages/faturista.tsx":{"content":"import { useState } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Button } from '@/components/ui/button';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Package, AlertTriangle, CheckCircle, Upload, FileText, Trash2, Clock, Search, Users } from 'lucide-react';\nimport { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest, queryClient } from '@/lib/queryClient';\nimport FaturistaNavbar from '@/components/layout/faturista-navbar';\nimport Header from '@/components/layout/header';\nimport { Badge } from '@/components/ui/badge';\nimport { Progress } from '@/components/ui/progress';\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from '@/components/ui/alert-dialog';\nimport type { UploadSession, StockAnalysisResult } from '@shared/schema';\n\ninterface SessionWithAnalysis extends UploadSession {\n  analysisCount?: number;\n  availableCount?: number;\n  partialCount?: number;\n  unavailableCount?: number;\n}\n\nexport default function FaturistaPanel() {\n  const [activeTab, setActiveTab] = useState('sessions');\n  const [searchTerm, setSearchTerm] = useState('');\n  const [selectedSession, setSelectedSession] = useState<string | null>(null);\n  const [sessionToDelete, setSessionToDelete] = useState<string | null>(null);\n  const [isUploadDialogOpen, setIsUploadDialogOpen] = useState(false);\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\n  \n  // Upload state\n  const [sessionName, setSessionName] = useState('');\n  const [inventoryFile, setInventoryFile] = useState<File | null>(null);\n  const [orderFiles, setOrderFiles] = useState<File[]>([]);\n  const [currentSessionId, setCurrentSessionId] = useState<string | null>(null);\n  const [uploadStep, setUploadStep] = useState<'name' | 'inventory' | 'orders' | 'analyze'>('name');\n\n  const { toast } = useToast();\n\n  const { data: sessions, isLoading: loadingSessions } = useQuery<SessionWithAnalysis[]>({\n    queryKey: ['/api/faturista/sessions'],\n  });\n\n  const { data: analysisResults, isLoading: loadingAnalysis} = useQuery<StockAnalysisResult[]>({\n    queryKey: ['/api/faturista/analysis', selectedSession],\n    enabled: !!selectedSession,\n  });\n\n  const createSessionMutation = useMutation({\n    mutationFn: async (name: string) => {\n      const res = await fetch('/api/faturista/upload-session', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ sessionName: name }),\n        credentials: 'include',\n      });\n      \n      if (!res.ok) {\n        const error = await res.text();\n        throw new Error(error || res.statusText);\n      }\n      \n      return res.json();\n    },\n    onSuccess: (data) => {\n      setCurrentSessionId(data.id);\n      setUploadStep('inventory');\n      queryClient.invalidateQueries({ queryKey: ['/api/faturista/sessions'] });\n      toast({\n        title: \"Sessão criada\",\n        description: \"Agora faça upload do PDF de estoque\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Falha ao criar sessão\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const uploadInventoryMutation = useMutation({\n    mutationFn: async (file: File) => {\n      const formData = new FormData();\n      formData.append('file', file);\n      formData.append('sessionId', currentSessionId!);\n\n      const res = await fetch('/api/faturista/upload-inventory', {\n        method: 'POST',\n        body: formData,\n        credentials: 'include',\n      });\n      \n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({ error: res.statusText }));\n        throw new Error(errorData.error || res.statusText);\n      }\n      \n      return res.json();\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"Estoque importado\",\n        description: `${data.itemsCount} produtos processados`,\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/faturista/sessions'] });\n      setUploadStep('orders');\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Erro ao importar estoque\",\n        description: error.message || \"Falha ao importar estoque\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const uploadOrdersMutation = useMutation({\n    mutationFn: async (files: File[]) => {\n      const formData = new FormData();\n      files.forEach(file => formData.append('files', file));\n      formData.append('sessionId', currentSessionId!);\n\n      const res = await fetch('/api/faturista/upload-orders', {\n        method: 'POST',\n        body: formData,\n        credentials: 'include',\n      });\n      \n      if (!res.ok) {\n        const errorData = await res.json().catch(() => ({ error: res.statusText }));\n        throw new Error(errorData.error || res.statusText);\n      }\n      \n      return res.json();\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"Pedidos importados\",\n        description: `${data.ordersCount} pedidos processados de ${data.filesProcessed} arquivo(s)`,\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/faturista/sessions'] });\n      setUploadStep('analyze');\n    },\n    onError: (error: Error) => {\n      toast({\n        title: \"Erro ao importar pedidos\",\n        description: error.message || \"Falha ao importar pedidos\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const analyzeStockMutation = useMutation({\n    mutationFn: async () => {\n      const res = await fetch('/api/faturista/analyze-stock', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ sessionId: currentSessionId }),\n        credentials: 'include',\n      });\n      \n      if (!res.ok) {\n        const error = await res.text();\n        throw new Error(error || res.statusText);\n      }\n      \n      return res.json();\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"Análise concluída\",\n        description: `${data.resultsCount} produtos analisados`,\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/faturista/sessions'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/faturista/analysis', currentSessionId] });\n      setIsAnalyzing(false);\n      setIsUploadDialogOpen(false);\n      resetUploadForm();\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Falha ao analisar estoque\",\n        variant: \"destructive\",\n      });\n      setIsAnalyzing(false);\n    },\n  });\n\n  const deleteSessionMutation = useMutation({\n    mutationFn: async (sessionId: string) => {\n      const res = await fetch(`/api/faturista/session/${sessionId}`, {\n        method: 'DELETE',\n        credentials: 'include',\n      });\n      \n      if (!res.ok) {\n        const error = await res.text();\n        throw new Error(error || res.statusText);\n      }\n      \n      return res.json();\n    },\n    onSuccess: () => {\n      toast({\n        title: \"Sessão excluída\",\n        description: \"A sessão foi removida com sucesso\",\n      });\n      queryClient.invalidateQueries({ queryKey: ['/api/faturista/sessions'] });\n      if (selectedSession === sessionToDelete) {\n        setSelectedSession(null);\n      }\n      setSessionToDelete(null);\n    },\n    onError: () => {\n      toast({\n        title: \"Erro\",\n        description: \"Falha ao excluir sessão\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const resetUploadForm = () => {\n    setSessionName('');\n    setInventoryFile(null);\n    setOrderFiles([]);\n    setCurrentSessionId(null);\n    setUploadStep('name');\n  };\n\n  const handleCreateSession = () => {\n    if (!sessionName.trim()) {\n      toast({\n        title: \"Nome obrigatório\",\n        description: \"Digite um nome para a sessão\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    createSessionMutation.mutate(sessionName);\n  };\n\n  const handleUploadInventory = () => {\n    if (!inventoryFile) {\n      toast({\n        title: \"Arquivo obrigatório\",\n        description: \"Selecione o PDF de estoque\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    uploadInventoryMutation.mutate(inventoryFile);\n  };\n\n  const handleUploadOrders = () => {\n    if (orderFiles.length === 0) {\n      toast({\n        title: \"Arquivo obrigatório\",\n        description: \"Selecione pelo menos um PDF de pedido\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    uploadOrdersMutation.mutate(orderFiles);\n  };\n\n  const handleAnalyze = () => {\n    setIsAnalyzing(true);\n    analyzeStockMutation.mutate();\n  };\n\n  const getStatusBadge = (status: string) => {\n    if (status === 'DISPONÍVEL') {\n      return <Badge className=\"bg-green-500\" data-testid={`badge-disponivel`}><CheckCircle className=\"h-3 w-3 mr-1\" />Disponível</Badge>;\n    } else if (status === 'PARCIAL') {\n      return <Badge className=\"bg-yellow-500\" data-testid={`badge-parcial`}><AlertTriangle className=\"h-3 w-3 mr-1\" />Parcial</Badge>;\n    } else if (status === 'CRÍTICO') {\n      return <Badge className=\"bg-orange-500\" data-testid={`badge-critico`}><AlertTriangle className=\"h-3 w-3 mr-1\" />Crítico</Badge>;\n    } else {\n      return <Badge className=\"bg-red-500\" data-testid={`badge-indisponivel`}><AlertTriangle className=\"h-3 w-3 mr-1\" />Indisponível</Badge>;\n    }\n  };\n\n  const filteredResults = analysisResults?.filter(result => \n    result.productCode.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    result.productName.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  return (\n    <div className=\"flex flex-col h-screen overflow-hidden\">\n      <Header />\n      <FaturistaNavbar activeTab={activeTab} onTabChange={setActiveTab} selectedSession={selectedSession} />\n        \n      <div className=\"flex-1 overflow-auto p-6\">\n        <div className=\"max-w-7xl mx-auto space-y-4\">\n          {activeTab === 'sessions' && (\n            <>\n                <Card>\n                  <CardHeader>\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <CardTitle>Sessões de Upload</CardTitle>\n                        <CardDescription>Histórico de importações de estoque e pedidos</CardDescription>\n                      </div>\n                      <Dialog open={isUploadDialogOpen} onOpenChange={setIsUploadDialogOpen}>\n                        <DialogTrigger asChild>\n                          <Button data-testid=\"button-new-session\">\n                            <Upload className=\"h-4 w-4 mr-2\" />\n                            Nova Importação\n                          </Button>\n                        </DialogTrigger>\n                        <DialogContent className=\"max-w-2xl\">\n                          <DialogHeader>\n                            <DialogTitle>Importar Estoque e Pedidos</DialogTitle>\n                            <DialogDescription>\n                              {uploadStep === 'name' && 'Passo 1: Nome da sessão'}\n                              {uploadStep === 'inventory' && 'Passo 2: Upload do estoque (PDF)'}\n                              {uploadStep === 'orders' && 'Passo 3: Upload dos pedidos (PDFs)'}\n                              {uploadStep === 'analyze' && 'Passo 4: Analisar disponibilidade'}\n                            </DialogDescription>\n                          </DialogHeader>\n\n                          {uploadStep === 'name' && (\n                            <div className=\"space-y-4\">\n                              <div>\n                                <Label>Nome da Sessão</Label>\n                                <Input\n                                  value={sessionName}\n                                  onChange={(e) => setSessionName(e.target.value)}\n                                  placeholder=\"Ex: Estoque Janeiro 2024\"\n                                  data-testid=\"input-session-name\"\n                                />\n                              </div>\n                              <DialogFooter>\n                                <Button onClick={handleCreateSession} disabled={createSessionMutation.isPending} data-testid=\"button-create-session\">\n                                  Criar Sessão\n                                </Button>\n                              </DialogFooter>\n                            </div>\n                          )}\n\n                          {uploadStep === 'inventory' && (\n                            <div className=\"space-y-4\">\n                              <div>\n                                <Label>PDF de Estoque</Label>\n                                <Input\n                                  type=\"file\"\n                                  accept=\".pdf\"\n                                  onChange={(e) => setInventoryFile(e.target.files?.[0] || null)}\n                                  data-testid=\"input-inventory-file\"\n                                />\n                                <p className=\"text-sm text-muted-foreground mt-1\">\n                                  Arquivo contendo Cód.Int, Mercadería, Embalaje e Cantidad\n                                </p>\n                              </div>\n                              <DialogFooter>\n                                <Button onClick={handleUploadInventory} disabled={uploadInventoryMutation.isPending} data-testid=\"button-upload-inventory\">\n                                  Importar Estoque\n                                </Button>\n                              </DialogFooter>\n                            </div>\n                          )}\n\n                          {uploadStep === 'orders' && (\n                            <div className=\"space-y-4\">\n                              <div>\n                                <Label>PDFs de Pedidos (múltiplos)</Label>\n                                <Input\n                                  type=\"file\"\n                                  accept=\".pdf\"\n                                  multiple\n                                  onChange={(e) => setOrderFiles(Array.from(e.target.files || []))}\n                                  data-testid=\"input-order-files\"\n                                />\n                                <p className=\"text-sm text-muted-foreground mt-1\">\n                                  Arquivos contendo (Cód), Descripción, Cant. Falta e Entidad\n                                </p>\n                              </div>\n                              <DialogFooter>\n                                <Button onClick={handleUploadOrders} disabled={uploadOrdersMutation.isPending} data-testid=\"button-upload-orders\">\n                                  Importar Pedidos\n                                </Button>\n                              </DialogFooter>\n                            </div>\n                          )}\n\n                          {uploadStep === 'analyze' && (\n                            <div className=\"space-y-4\">\n                              <div className=\"p-4 bg-green-50 dark:bg-green-900/20 rounded-lg\">\n                                <p className=\"text-sm\">\n                                  ✅ Estoque importado<br />\n                                  ✅ Pedidos importados<br /><br />\n                                  Clique em \"Analisar\" para calcular a disponibilidade dos produtos.\n                                </p>\n                              </div>\n                              <DialogFooter>\n                                <Button onClick={handleAnalyze} disabled={analyzeStockMutation.isPending || isAnalyzing} data-testid=\"button-analyze-stock\">\n                                  {analyzeStockMutation.isPending || isAnalyzing ? 'Analisando...' : 'Analisar Disponibilidade'}\n                                </Button>\n                              </DialogFooter>\n                            </div>\n                          )}\n                        </DialogContent>\n                      </Dialog>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    {loadingSessions ? (\n                      <div className=\"text-center py-8\" data-testid=\"loading-sessions\">Carregando...</div>\n                    ) : sessions && sessions.length > 0 ? (\n                      <Table>\n                        <TableHeader>\n                          <TableRow>\n                            <TableHead>Nome da Sessão</TableHead>\n                            <TableHead>Status</TableHead>\n                            <TableHead>Arquivo de Estoque</TableHead>\n                            <TableHead>Arquivos de Pedidos</TableHead>\n                            <TableHead>Data</TableHead>\n                            <TableHead>Ações</TableHead>\n                          </TableRow>\n                        </TableHeader>\n                        <TableBody>\n                          {sessions.map((session) => (\n                            <TableRow key={session.id} data-testid={`row-session-${session.id}`}>\n                              <TableCell className=\"font-medium\" data-testid={`text-session-name-${session.id}`}>{session.sessionName}</TableCell>\n                              <TableCell>\n                                {session.status === 'completed' ? (\n                                  <Badge className=\"bg-green-500\" data-testid={`badge-status-${session.id}`}>Concluída</Badge>\n                                ) : (\n                                  <Badge variant=\"secondary\" data-testid={`badge-status-${session.id}`}>Processando</Badge>\n                                )}\n                              </TableCell>\n                              <TableCell data-testid={`text-inventory-file-${session.id}`}>{session.inventoryFileName || '-'}</TableCell>\n                              <TableCell data-testid={`text-order-count-${session.id}`}>{session.orderFilesCount || 0}</TableCell>\n                              <TableCell data-testid={`text-created-at-${session.id}`}>\n                                {new Date(session.createdAt).toLocaleDateString('pt-BR')}\n                              </TableCell>\n                              <TableCell>\n                                <div className=\"flex gap-2\">\n                                  <Button\n                                    size=\"sm\"\n                                    variant=\"outline\"\n                                    onClick={() => {\n                                      setSelectedSession(session.id);\n                                      setActiveTab('analysis');\n                                    }}\n                                    data-testid={`button-view-analysis-${session.id}`}\n                                  >\n                                    Ver Análise\n                                  </Button>\n                                  <Button\n                                    size=\"sm\"\n                                    variant=\"destructive\"\n                                    onClick={() => setSessionToDelete(session.id)}\n                                    data-testid={`button-delete-session-${session.id}`}\n                                  >\n                                    <Trash2 className=\"h-4 w-4\" />\n                                  </Button>\n                                </div>\n                              </TableCell>\n                            </TableRow>\n                          ))}\n                        </TableBody>\n                      </Table>\n                    ) : (\n                      <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"empty-sessions\">\n                        Nenhuma sessão de importação encontrada\n                      </div>\n                    )}\n                  </CardContent>\n                </Card>\n            </>\n          )}\n\n          {activeTab === 'analysis' && (\n            <>\n                {selectedSession && (\n                  <>\n                    <Card>\n                      <CardHeader>\n                        <div className=\"flex items-center justify-between\">\n                          <div>\n                            <CardTitle>Análise de Disponibilidade</CardTitle>\n                            <CardDescription>Status de estoque vs pedidos em carteira</CardDescription>\n                          </div>\n                          <div className=\"flex items-center gap-2\">\n                            <Search className=\"h-4 w-4 text-muted-foreground\" />\n                            <Input\n                              placeholder=\"Buscar produto...\"\n                              value={searchTerm}\n                              onChange={(e) => setSearchTerm(e.target.value)}\n                              className=\"w-64\"\n                              data-testid=\"input-search-products\"\n                            />\n                          </div>\n                        </div>\n                      </CardHeader>\n                      <CardContent>\n                        {loadingAnalysis ? (\n                          <div className=\"text-center py-8\" data-testid=\"loading-analysis\">Carregando análise...</div>\n                        ) : filteredResults && filteredResults.length > 0 ? (\n                          <Table>\n                            <TableHeader>\n                              <TableRow>\n                                <TableHead>Código</TableHead>\n                                <TableHead>Produto</TableHead>\n                                <TableHead>Estoque</TableHead>\n                                <TableHead>Pedidos</TableHead>\n                                <TableHead>Status</TableHead>\n                                <TableHead>Cobertura</TableHead>\n                                <TableHead>Clientes</TableHead>\n                              </TableRow>\n                            </TableHeader>\n                            <TableBody>\n                              {filteredResults.map((result) => {\n                                const clientsList = result.clientsList as Array<{clientName: string; quantity: number}>;\n                                return (\n                                  <TableRow key={result.id} data-testid={`row-analysis-${result.productCode}`}>\n                                    <TableCell className=\"font-mono\" data-testid={`text-product-code-${result.productCode}`}>{result.productCode}</TableCell>\n                                    <TableCell data-testid={`text-product-name-${result.productCode}`}>{result.productName}</TableCell>\n                                    <TableCell data-testid={`text-stock-qty-${result.productCode}`}>{parseFloat(result.stockQuantity).toLocaleString()}</TableCell>\n                                    <TableCell data-testid={`text-orders-qty-${result.productCode}`}>{parseFloat(result.ordersQuantity).toLocaleString()}</TableCell>\n                                    <TableCell>{getStatusBadge(result.status)}</TableCell>\n                                    <TableCell data-testid={`text-percentage-${result.productCode}`}>\n                                      <div className=\"flex items-center gap-2\">\n                                        <Progress value={parseFloat(result.percentage || '0')} className=\"w-20\" />\n                                        <span className=\"text-sm\">{parseFloat(result.percentage || '0').toFixed(0)}%</span>\n                                      </div>\n                                    </TableCell>\n                                    <TableCell data-testid={`text-clients-count-${result.productCode}`}>\n                                      {clientsList && clientsList.length > 0 ? (\n                                        <Popover>\n                                          <PopoverTrigger asChild>\n                                            <Button variant=\"outline\" size=\"sm\" className=\"gap-2\">\n                                              <Users className=\"h-4 w-4\" />\n                                              {clientsList.length} cliente(s)\n                                            </Button>\n                                          </PopoverTrigger>\n                                          <PopoverContent className=\"w-80\" align=\"start\">\n                                            <div className=\"space-y-2\">\n                                              <h4 className=\"font-semibold text-sm\">Clientes com pedidos:</h4>\n                                              <div className=\"max-h-60 overflow-y-auto space-y-1\">\n                                                {clientsList.map((client, idx) => (\n                                                  <div key={idx} className=\"flex items-center justify-between py-1 px-2 bg-muted rounded text-sm\">\n                                                    <span className=\"truncate flex-1\" title={client.clientName}>\n                                                      {client.clientName}\n                                                    </span>\n                                                    <Badge variant=\"secondary\" className=\"ml-2\">\n                                                      {client.quantity} un.\n                                                    </Badge>\n                                                  </div>\n                                                ))}\n                                              </div>\n                                            </div>\n                                          </PopoverContent>\n                                        </Popover>\n                                      ) : (\n                                        <span className=\"text-muted-foreground\">0 cliente(s)</span>\n                                      )}\n                                    </TableCell>\n                                  </TableRow>\n                                );\n                              })}\n                            </TableBody>\n                          </Table>\n                        ) : (\n                          <div className=\"text-center py-8 text-muted-foreground\" data-testid=\"empty-analysis\">\n                            Nenhum resultado encontrado\n                          </div>\n                        )}\n                      </CardContent>\n                    </Card>\n                  </>\n                )}\n            </>\n          )}\n        </div>\n\n        <AlertDialog open={!!sessionToDelete} onOpenChange={() => setSessionToDelete(null)}>\n          <AlertDialogContent>\n            <AlertDialogHeader>\n              <AlertDialogTitle>Excluir Sessão</AlertDialogTitle>\n              <AlertDialogDescription>\n                Tem certeza que deseja excluir esta sessão? Todos os dados de estoque, pedidos e análise serão removidos permanentemente.\n              </AlertDialogDescription>\n            </AlertDialogHeader>\n            <AlertDialogFooter>\n              <AlertDialogCancel data-testid=\"button-cancel-delete\">Cancelar</AlertDialogCancel>\n              <AlertDialogAction\n                onClick={() => sessionToDelete && deleteSessionMutation.mutate(sessionToDelete)}\n                data-testid=\"button-confirm-delete\"\n              >\n                Excluir\n              </AlertDialogAction>\n            </AlertDialogFooter>\n          </AlertDialogContent>\n        </AlertDialog>\n      </div>\n    </div>\n  );\n}\n","size_bytes":27936},"client/src/lib/consultor-route.tsx":{"content":"import { useAuth } from \"@/hooks/use-auth\";\nimport { Loader2 } from \"lucide-react\";\nimport { Redirect, Route } from \"wouter\";\n\nexport function ConsultorRoute({\n  path,\n  component: Component,\n}: {\n  path: string;\n  component: () => React.JSX.Element;\n}) {\n  const { user, isLoading } = useAuth();\n\n  if (isLoading) {\n    return (\n      <Route path={path}>\n        <div className=\"flex items-center justify-center min-h-screen\">\n          <Loader2 className=\"h-8 w-8 animate-spin text-border\" />\n        </div>\n      </Route>\n    );\n  }\n\n  if (!user) {\n    return (\n      <Route path={path}>\n        <Redirect to=\"/auth\" />\n      </Route>\n    );\n  }\n\n  if (user.role === 'faturista') {\n    return (\n      <Route path={path}>\n        <Redirect to=\"/faturista\" />\n      </Route>\n    );\n  }\n\n  return <Route path={path} component={Component} />;\n}\n","size_bytes":844},"client/src/components/layout/manager-navbar.tsx":{"content":"import { Link } from \"wouter\";\nimport { \n  BarChart3,\n  Users,\n  ListChecks,\n  Target\n} from \"lucide-react\";\n\ninterface ManagerNavbarProps {\n  activeTab: string;\n  onTabChange: (tab: string) => void;\n}\n\nconst menuItems = [\n  { id: \"dashboard\", icon: BarChart3, label: \"Dashboard\" },\n  { id: \"team\", icon: Users, label: \"Equipe\" },\n  { id: \"action-plans\", icon: ListChecks, label: \"Planos de Ação\" },\n  { id: \"metas\", icon: Target, label: \"Metas\" },\n];\n\nexport default function ManagerNavbar({ activeTab, onTabChange }: ManagerNavbarProps) {\n  return (\n    <nav className=\"bg-card border-b border-border\">\n      <div className=\"px-8 py-0\">\n        <div className=\"flex items-center gap-1 overflow-x-auto\">\n          {menuItems.map((item) => {\n            const Icon = item.icon;\n            const isActive = activeTab === item.id;\n            \n            return (\n              <button\n                key={item.id}\n                onClick={() => {\n                  onTabChange(item.id);\n                  window.location.hash = item.id;\n                }}\n                className={`flex items-center gap-2 px-4 py-3 whitespace-nowrap transition-colors border-b-2 ${\n                  isActive \n                    ? 'text-green-600 border-green-600 font-medium' \n                    : 'text-muted-foreground hover:text-foreground border-transparent'\n                }`}\n                data-testid={`nav-${item.id}`}\n              >\n                <Icon size={18} />\n                <span className=\"text-sm\">{item.label}</span>\n              </button>\n            );\n          })}\n        </div>\n      </div>\n    </nav>\n  );\n}\n","size_bytes":1635},"client/src/components/layout/navbar.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { \n  BarChart3, \n  ShoppingCart, \n  Percent, \n  Users, \n  Calendar,\n  Package,\n  FileText, \n  Settings, \n  Target,\n  TrendingUp,\n  History,\n  Repeat,\n  Kanban,\n  Menu,\n  X\n} from \"lucide-react\";\nimport { useAuth } from \"@/hooks/use-auth\";\nimport { Button } from \"@/components/ui/button\";\nimport { Sheet, SheetContent, SheetHeader, SheetTitle, SheetClose } from \"@/components/ui/sheet\";\nimport { useState } from \"react\";\n\nconst menuItems = [\n  { href: \"/dashboard\", icon: BarChart3, label: \"Dashboard\" },\n  { href: \"/vendas\", icon: ShoppingCart, label: \"Minhas Vendas\" },\n  { href: \"/barter\", icon: Repeat, label: \"Barter\" },\n  { href: \"/kanban-metas\", icon: Kanban, label: \"Oportunidades de Negócio\" },\n  { href: \"/clientes\", icon: Users, label: \"Clientes\" },\n  // { href: \"/mercado\", icon: TrendingUp, label: \"Mercado\" }, // Temporarily hidden\n  { href: \"/historico-compras\", icon: History, label: \"Histórico Compras\" },\n  { href: \"/relatorios\", icon: FileText, label: \"Relatórios\" },\n];\n\nconst adminOnlyItems = [\n  { href: \"/safras\", icon: Calendar, label: \"Safras\" },\n  { href: \"/produtos\", icon: Package, label: \"Produtos\" },\n];\n\nconst configItems = [\n  { href: \"/metas\", icon: Target, label: \"Metas\" },\n  { href: \"/comissoes\", icon: Percent, label: \"Carregar Arquivos\" },\n];\n\nexport default function Navbar() {\n  const [location] = useLocation();\n  const { user } = useAuth();\n  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);\n\n  // Don't show navbar for gerente and faturista\n  if (user?.role === 'gerente' || user?.role === 'faturista') {\n    return null;\n  }\n\n  const isAdmin = user?.role === 'administrador';\n\n  const NavLink = ({ item, onClick }: { item: typeof menuItems[0]; onClick?: () => void }) => {\n    const Icon = item.icon;\n    const isActive = location === item.href || (item.href === '/dashboard' && location === '/');\n    \n    return (\n      <Link \n        key={item.href}\n        href={item.href}\n        onClick={onClick}\n        className={`flex items-center gap-2 px-4 py-3 whitespace-nowrap transition-colors border-b-2 md:border-b-2 ${\n          isActive \n            ? 'text-primary border-primary font-medium bg-primary/5 md:bg-transparent' \n            : 'text-muted-foreground hover:text-foreground border-transparent hover:bg-muted/50 md:hover:bg-transparent'\n        }`}\n        data-testid={`nav-${item.label.toLowerCase().replace(/\\s+/g, '-')}`}\n      >\n        <Icon size={18} />\n        <span className=\"text-sm\">{item.label}</span>\n      </Link>\n    );\n  };\n\n  return (\n    <>\n      {/* Mobile Menu Button */}\n      <div className=\"md:hidden bg-card border-b border-border\">\n        <div className=\"px-4 py-2 flex items-center justify-between\">\n          <span className=\"text-sm font-medium text-foreground\">Menu</span>\n          <Button\n            variant=\"ghost\"\n            className=\"h-11 w-11 p-0\"\n            onClick={() => setMobileMenuOpen(true)}\n            aria-label=\"Abrir menu de navegação\"\n            data-testid=\"mobile-menu-button\"\n          >\n            <Menu size={24} />\n          </Button>\n        </div>\n      </div>\n\n      {/* Desktop Navbar - Hidden on Mobile */}\n      <nav className=\"hidden md:block bg-card border-b border-border\">\n        <div className=\"px-8 py-0\">\n          <div className=\"flex items-center gap-1 overflow-x-auto\">\n            {/* Main Menu Items */}\n            {menuItems.map((item) => (\n              <NavLink key={item.href} item={item} />\n            ))}\n\n            {/* Admin Only Items - Safras e Produtos */}\n            {isAdmin && adminOnlyItems.map((item) => (\n              <NavLink key={item.href} item={item} />\n            ))}\n\n            {/* Separator */}\n            <div className=\"h-6 w-px bg-border mx-2\" />\n\n            {/* Config Items */}\n            {configItems.map((item) => (\n              <NavLink key={item.href} item={item} />\n            ))}\n\n            {/* Admin Link - Only for administrador */}\n            {user?.role === 'administrador' && (\n              <>\n                <div className=\"h-6 w-px bg-border mx-2\" />\n                <Link \n                  href=\"/admin#dashboard\"\n                  className={`flex items-center gap-2 px-4 py-3 whitespace-nowrap transition-colors border-b-2 ${\n                    location === '/admin'\n                      ? 'text-blue-600 border-blue-600 font-medium' \n                      : 'text-muted-foreground hover:text-foreground border-transparent'\n                  }`}\n                  data-testid=\"nav-super-admin\"\n                >\n                  <Settings size={18} />\n                  <span className=\"text-sm\">Super Admin</span>\n                </Link>\n              </>\n            )}\n          </div>\n        </div>\n      </nav>\n\n      {/* Mobile Menu Sheet */}\n      <Sheet open={mobileMenuOpen} onOpenChange={setMobileMenuOpen}>\n        <SheetContent side=\"left\" className=\"w-72\">\n          <SheetHeader className=\"flex flex-row items-center justify-between\">\n            <SheetTitle>Menu de Navegação</SheetTitle>\n            <SheetClose asChild>\n              <Button variant=\"ghost\" className=\"h-11 w-11 p-0\" aria-label=\"Fechar menu\" data-testid=\"close-mobile-menu\">\n                <X size={20} />\n              </Button>\n            </SheetClose>\n          </SheetHeader>\n          \n          <div className=\"flex flex-col gap-1 mt-6\">\n            {/* Main Menu Items */}\n            {menuItems.map((item) => (\n              <NavLink key={item.href} item={item} onClick={() => setMobileMenuOpen(false)} />\n            ))}\n\n            {/* Admin Only Items */}\n            {isAdmin && (\n              <>\n                <div className=\"my-2 border-t border-border\" />\n                <p className=\"px-4 py-2 text-xs font-semibold text-muted-foreground\">Administração</p>\n                {adminOnlyItems.map((item) => (\n                  <NavLink key={item.href} item={item} onClick={() => setMobileMenuOpen(false)} />\n                ))}\n              </>\n            )}\n\n            {/* Config Items */}\n            <div className=\"my-2 border-t border-border\" />\n            <p className=\"px-4 py-2 text-xs font-semibold text-muted-foreground\">Configurações</p>\n            {configItems.map((item) => (\n              <NavLink key={item.href} item={item} onClick={() => setMobileMenuOpen(false)} />\n            ))}\n\n            {/* Admin Link */}\n            {user?.role === 'administrador' && (\n              <>\n                <div className=\"my-2 border-t border-border\" />\n                <Link \n                  href=\"/admin#dashboard\"\n                  onClick={() => setMobileMenuOpen(false)}\n                  className={`flex items-center gap-2 px-4 py-3 whitespace-nowrap transition-colors ${\n                    location === '/admin'\n                      ? 'text-blue-600 font-medium bg-blue-50' \n                      : 'text-muted-foreground hover:text-foreground hover:bg-muted/50'\n                  }`}\n                  data-testid=\"nav-super-admin\"\n                >\n                  <Settings size={18} />\n                  <span className=\"text-sm\">Super Admin</span>\n                </Link>\n              </>\n            )}\n          </div>\n        </SheetContent>\n      </Sheet>\n    </>\n  );\n}\n","size_bytes":7292},"client/src/components/layout/admin-navbar.tsx":{"content":"import { \n  BarChart3,\n  Users,\n  Package,\n  FolderTree,\n  Percent,\n  Settings,\n  Repeat,\n  Target,\n  Calendar,\n  DollarSign,\n  Shield\n} from \"lucide-react\";\n\ninterface AdminNavbarProps {\n  activeTab: string;\n  onTabChange: (tab: string) => void;\n}\n\nconst menuItems = [\n  { id: \"dashboard\", icon: BarChart3, label: \"Dashboard\" },\n  { id: \"users\", icon: Users, label: \"Usuários\" },\n  { id: \"master-clients\", icon: Users, label: \"Clientes\" },\n  { id: \"seasons\", icon: Calendar, label: \"Safras\" },\n  { id: \"categories\", icon: Package, label: \"Categorias\" },\n  { id: \"subcategories\", icon: FolderTree, label: \"Subcategorias\" },\n  { id: \"products\", icon: Package, label: \"Produtos\" },\n  { id: \"price-table\", icon: DollarSign, label: \"Tabela de Preços\" },\n  { id: \"commissions\", icon: Percent, label: \"Comissões\" },\n  { id: \"parameters\", icon: Settings, label: \"Parâmetros\" },\n  { id: \"barter\", icon: Repeat, label: \"Barter\" },\n  { id: \"timac\", icon: Target, label: \"Timac\" },\n  { id: \"system\", icon: Shield, label: \"Sistema\" },\n];\n\nexport default function AdminNavbar({ activeTab, onTabChange }: AdminNavbarProps) {\n  return (\n    <nav className=\"bg-card border-b border-border\">\n      <div className=\"px-8 py-0\">\n        <div className=\"flex items-center gap-1 overflow-x-auto\">\n          {menuItems.map((item) => {\n            const Icon = item.icon;\n            const isActive = activeTab === item.id;\n            \n            return (\n              <button\n                key={item.id}\n                onClick={() => {\n                  onTabChange(item.id);\n                  window.location.hash = item.id;\n                }}\n                className={`flex items-center gap-2 px-4 py-3 whitespace-nowrap transition-colors border-b-2 ${\n                  isActive \n                    ? 'text-primary border-primary font-medium' \n                    : 'text-muted-foreground hover:text-foreground border-transparent'\n                }`}\n                data-testid={`nav-${item.id}`}\n              >\n                <Icon size={18} />\n                <span className=\"text-sm\">{item.label}</span>\n              </button>\n            );\n          })}\n        </div>\n      </div>\n    </nav>\n  );\n}\n","size_bytes":2203},"client/src/components/layout/faturista-navbar.tsx":{"content":"import { \n  Package,\n  BarChart3\n} from \"lucide-react\";\n\ninterface FaturistaNavbarProps {\n  activeTab: string;\n  onTabChange: (tab: string) => void;\n  selectedSession?: string | null;\n}\n\nconst menuItems = [\n  { id: \"sessions\", icon: Package, label: \"Sessões\" },\n  { id: \"analysis\", icon: BarChart3, label: \"Análises\" },\n];\n\nexport default function FaturistaNavbar({ activeTab, onTabChange, selectedSession }: FaturistaNavbarProps) {\n  return (\n    <nav className=\"bg-card border-b border-border\">\n      <div className=\"px-8 py-0\">\n        <div className=\"flex items-center gap-1 overflow-x-auto\">\n          {menuItems.map((item) => {\n            const Icon = item.icon;\n            const isActive = activeTab === item.id;\n            const isDisabled = item.id === 'analysis' && !selectedSession;\n            \n            return (\n              <button\n                key={item.id}\n                onClick={() => {\n                  if (!isDisabled) {\n                    onTabChange(item.id);\n                  }\n                }}\n                disabled={isDisabled}\n                className={`flex items-center gap-2 px-4 py-3 whitespace-nowrap transition-colors border-b-2 ${\n                  isActive \n                    ? 'text-orange-600 border-orange-600 font-medium' \n                    : isDisabled\n                    ? 'text-muted-foreground/50 border-transparent cursor-not-allowed'\n                    : 'text-muted-foreground hover:text-foreground border-transparent'\n                }`}\n                data-testid={`nav-${item.id}`}\n              >\n                <Icon size={18} />\n                <span className=\"text-sm\">{item.label}</span>\n              </button>\n            );\n          })}\n        </div>\n      </div>\n    </nav>\n  );\n}\n","size_bytes":1771},"crm-agro-mobile/BUILD_ANDROID.md":{"content":"# 📱 BUILD ANDROID - CRM Agro Mobile\n\n## ✅ Assets Configurados!\n\nOs arquivos necessários foram criados:\n- ✅ `assets/icon.png` - Ícone do app\n- ✅ `assets/splash.png` - Tela de splash\n- ✅ `app.json` - Configurado com assets\n\n---\n\n## 🔧 Próximos Passos - Execute no Terminal do Mac\n\n### 1️⃣ Gerar arquivos nativos Android\n\n```bash\ncd ~/Downloads/crm-agro-mobile\nnpx expo prebuild --platform android\n```\n\n**O que vai acontecer:**\n- ✅ Cria pasta `android/` com código nativo\n- ✅ Gera arquivos do Android Studio\n- ✅ Configura dependências nativas\n\n---\n\n### 2️⃣ Conectar celular via USB\n\n**No Android:**\n1. Vá em **Configurações** → **Sobre o telefone**\n2. Toque 7x em **Número da versão** (ativa modo desenvolvedor)\n3. Volte → **Opções do desenvolvedor** → Ative **Depuração USB**\n4. Conecte o cabo USB ao Mac\n\n**No Mac:**\n```bash\n# Verificar se o celular foi detectado\nadb devices\n```\n\nDeve aparecer algo como:\n```\nList of devices attached\nABCD1234    device\n```\n\n---\n\n### 3️⃣ Build e Instalação Automática\n\n```bash\ncd ~/Downloads/crm-agro-mobile\nnpx expo run:android\n```\n\n**O que vai acontecer:**\n1. ✅ Compila o APK\n2. ✅ Instala automaticamente no celular\n3. ✅ Abre o app\n4. ✅ App conecta ao backend Replit via HTTPS\n\n---\n\n## ⚠️ Requisitos\n\n- ✅ Android Studio instalado (ou apenas Android SDK)\n- ✅ Java JDK 17+ instalado\n- ✅ Variável ANDROID_HOME configurada\n\n### Instalar Android SDK no Mac (se necessário):\n\n```bash\n# Via Homebrew\nbrew install --cask android-commandlinetools\n\n# Configurar ANDROID_HOME\nexport ANDROID_HOME=$HOME/Library/Android/sdk\nexport PATH=$PATH:$ANDROID_HOME/emulator\nexport PATH=$PATH:$ANDROID_HOME/platform-tools\n```\n\n---\n\n## 🎯 Resultado Esperado\n\n✅ App instalado no celular  \n✅ Ícone \"CRM Agro\" aparece na lista de apps  \n✅ Ao abrir, mostra tela de login  \n✅ Login funciona (conecta ao Replit)  \n✅ GPS e localização funcionam nativamente  \n\n---\n\n## 🔍 Troubleshooting\n\n### Erro: \"adb not found\"\n```bash\nbrew install android-platform-tools\n```\n\n### Erro: \"SDK location not found\"\n```bash\n# Criar local.properties\necho \"sdk.dir=$HOME/Library/Android/sdk\" > android/local.properties\n```\n\n### Erro: \"Gradle build failed\"\n```bash\ncd android\n./gradlew clean\ncd ..\nnpx expo run:android\n```\n\n---\n\n## 📊 Diferença: Expo Go vs Build Nativo\n\n| Recurso | Expo Go | Build Nativo |\n|---------|---------|--------------|\n| Cache problemático | ❌ Sim | ✅ Não |\n| Background GPS | ❌ Limitado | ✅ Total |\n| Acesso Replit | ❌ Bloqueado | ✅ Direto |\n| Instalação | Via QR | APK Instalado |\n| Dependências nativas | ❌ Limitado | ✅ Todas |\n\n---\n\n## 🚀 Execute Agora!\n\n```bash\ncd ~/Downloads/crm-agro-mobile\nnpx expo prebuild --platform android\nnpx expo run:android\n```\n\n**Quando terminar, me avise o resultado!** 📱✨\n","size_bytes":2838},"client/src/pages/crm/settings.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { db } from \"@/lib/crm/idb\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\n\ntype Settings = {\n  geofenceBase: number;\n  geofenceFarm: number;\n  gpsInterval: number;\n  baseLat: number;\n  baseLng: number;\n};\n\nconst DEFAULTS: Settings = {\n  geofenceBase: 200,\n  geofenceFarm: 200,\n  gpsInterval: 10000,\n  baseLat: -25.516,\n  baseLng: -54.616,\n};\n\nexport default function CRMSettings() {\n  const [form, setForm] = useState<Settings>(DEFAULTS);\n  const [saved, setSaved] = useState(false);\n\n  useEffect(() => {\n    (async () => {\n      const config = await db.settings.get(\"config\");\n      if (config?.value) {\n        setForm(config.value);\n      }\n    })();\n  }, []);\n\n  function handleChange(e: React.ChangeEvent<HTMLInputElement>) {\n    const { name, value } = e.target;\n    setForm((f) => ({ ...f, [name]: parseFloat(value) }));\n  }\n\n  async function handleSave() {\n    await db.settings.put({ key: \"config\", value: form });\n    setSaved(true);\n    setTimeout(() => setSaved(false), 2000);\n  }\n\n  return (\n    <div className=\"p-4 space-y-4\">\n      <Card>\n        <CardHeader>\n          <CardTitle>⚙️ Configurações de Rastreamento</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div>\n            <label className=\"block mb-2 font-medium text-sm\">Raio da Base (metros)</label>\n            <Input\n              type=\"number\"\n              name=\"geofenceBase\"\n              value={form.geofenceBase}\n              onChange={handleChange}\n            />\n          </div>\n\n          <div>\n            <label className=\"block mb-2 font-medium text-sm\">Raio da Fazenda (metros)</label>\n            <Input\n              type=\"number\"\n              name=\"geofenceFarm\"\n              value={form.geofenceFarm}\n              onChange={handleChange}\n            />\n          </div>\n\n          <div>\n            <label className=\"block mb-2 font-medium text-sm\">Intervalo GPS (ms)</label>\n            <Input\n              type=\"number\"\n              name=\"gpsInterval\"\n              value={form.gpsInterval}\n              onChange={handleChange}\n            />\n          </div>\n\n          <div className=\"border-t pt-4\">\n            <h3 className=\"font-semibold mb-4\">📍 Coordenadas da Base</h3>\n            \n            <div className=\"mb-3\">\n              <label className=\"block mb-2 font-medium text-sm\">Latitude</label>\n              <Input\n                type=\"number\"\n                name=\"baseLat\"\n                value={form.baseLat}\n                onChange={handleChange}\n                step=\"0.000001\"\n              />\n            </div>\n\n            <div>\n              <label className=\"block mb-2 font-medium text-sm\">Longitude</label>\n              <Input\n                type=\"number\"\n                name=\"baseLng\"\n                value={form.baseLng}\n                onChange={handleChange}\n                step=\"0.000001\"\n              />\n            </div>\n          </div>\n\n          <Button onClick={handleSave} className=\"w-full\">\n            {saved ? \"✅ Salvo!\" : \"💾 Salvar Configurações\"}\n          </Button>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":3317},"client/src/pages/crm/agenda.tsx":{"content":"import { useEffect, useMemo, useState } from \"react\";\nimport VisitList from \"@/components/crm/visit-list\";\nimport { db, ClientLocal, FarmLocal } from \"@/lib/crm/idb\";\nimport { Button } from \"@/components/ui/button\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\nimport { Input } from \"@/components/ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Plus } from \"lucide-react\";\n\nconst STATUS = [\"PLANEJADA\",\"PRONTA\",\"EM_DESLOCAMENTO\",\"NO_LOCAL\",\"CONCLUIDA\"] as const;\n\nconst TIPOS_SERVICO = [\n  \"Inspeção Técnica\",\n  \"Amostra Solo\",\n  \"Amostra Folha\",\n  \"Demonstração Produto\",\n  \"Assistência Técnica\",\n  \"Visita Comercial\",\n  \"Outros\",\n];\n\nexport default function CRMAgenda() {\n  const [filter, setFilter] = useState<\"TODAS\" | typeof STATUS[number]>(\"TODAS\");\n  const [visits, setVisits] = useState<any[]>([]);\n  const [clients, setClients] = useState<ClientLocal[]>([]);\n  const [farms, setFarms] = useState<FarmLocal[]>([]);\n  const [createOpen, setCreateOpen] = useState(false);\n  const [editingVisit, setEditingVisit] = useState<any>(null);\n  \n  const [form, setForm] = useState({\n    client_id: \"\",\n    farm_id: \"\",\n    service_type: \"\",\n    scheduled_date: \"\",\n    scheduled_time: \"\",\n    status: \"PLANEJADA\" as const,\n    notes: \"\",\n  });\n\n  async function load() {\n    const v = await db.visits.orderBy(\"window_start\").toArray();\n    setVisits(v as any);\n  }\n\n  async function loadClients() {\n    try {\n      const res = await fetch('/api/clients', { credentials: 'include' });\n      const data = await res.json();\n      // Garante que data é array antes de setar\n      if (Array.isArray(data)) {\n        setClients(data);\n        await db.clients.bulkPut(data);\n      } else {\n        // Se não for array (erro, etc), carrega do local\n        setClients(await db.clients.toArray());\n      }\n    } catch {\n      setClients(await db.clients.toArray());\n    }\n  }\n\n  async function loadFarms(clientId: string) {\n    try {\n      const res = await fetch(`/api/farms?client_id=${clientId}`, { credentials: 'include' });\n      const data = await res.json();\n      setFarms(data);\n    } catch {\n      const localFarms = await db.farms.where('client_id').equals(clientId).toArray();\n      setFarms(localFarms);\n    }\n  }\n\n  function handleEditVisit(visit: any) {\n    setEditingVisit(visit);\n    \n    // Preenche form com dados da visita\n    const datetime = visit.window_start ? new Date(visit.window_start) : new Date();\n    const date = datetime.toISOString().split('T')[0];\n    const time = datetime.toTimeString().slice(0, 5);\n    \n    // Extrai service_type das notes\n    const serviceType = TIPOS_SERVICO.find(tipo => visit.notes?.includes(tipo)) || \"Visita Comercial\";\n    const notes = visit.notes?.replace(serviceType, '').replace(/^\\s*-\\s*/, '') || '';\n    \n    setForm({\n      client_id: visit.client_id,\n      farm_id: visit.farm_id || \"\",\n      service_type: serviceType,\n      scheduled_date: date,\n      scheduled_time: time,\n      status: visit.status,\n      notes: notes,\n    });\n    \n    setCreateOpen(true);\n  }\n\n  async function saveVisit() {\n    // Validação rigorosa\n    if (!form.client_id || !form.service_type || !form.scheduled_date) {\n      alert('Por favor, preencha todos os campos obrigatórios:\\n- Cliente\\n- Tipo de Serviço\\n- Data');\n      return;\n    }\n\n    // Validação extra: client_id não pode ser vazio\n    if (form.client_id.trim() === '') {\n      alert('Por favor, selecione um cliente válido');\n      return;\n    }\n\n    const datetime = form.scheduled_time \n      ? `${form.scheduled_date}T${form.scheduled_time}:00` \n      : `${form.scheduled_date}T08:00:00`;\n\n    const isEditing = !!editingVisit;\n    const visit = {\n      id: editingVisit?.id || `visit-${Date.now()}`,\n      client_id: form.client_id,\n      farm_id: form.farm_id || null,\n      window_start: datetime,\n      window_end: datetime,\n      status: form.status,\n      notes: `${form.service_type}${form.notes ? ` - ${form.notes}` : ''}`,\n    };\n\n    // Save to IndexedDB\n    await db.visits.put(visit as any);\n\n    // Try to sync to backend\n    try {\n      const method = isEditing ? 'PATCH' : 'POST';\n      const url = isEditing ? `/api/visits/${visit.id}` : '/api/visits';\n      \n      const response = await fetch(url, {\n        method,\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify(visit),\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        console.error('❌ Erro ao salvar visita:', error);\n        alert(`Erro ao salvar: ${error.error || 'Erro desconhecido'}`);\n        return;\n      }\n    } catch (err) {\n      console.error('Error syncing visit:', err);\n      // Save to outbox for later sync\n      await db.outbox.add({\n        type: isEditing ? 'VISIT_UPDATE' : 'VISIT_CREATE',\n        payload: visit,\n        created_at: Date.now(),\n        attempts: 0,\n      });\n    }\n\n    setCreateOpen(false);\n    setEditingVisit(null);\n    setForm({\n      client_id: \"\",\n      farm_id: \"\",\n      service_type: \"\",\n      scheduled_date: \"\",\n      scheduled_time: \"\",\n      status: \"PLANEJADA\",\n      notes: \"\",\n    });\n    load();\n  }\n\n  useEffect(() => { \n    load(); \n    loadClients();\n  }, []);\n\n  useEffect(() => {\n    if (form.client_id) {\n      loadFarms(form.client_id);\n    }\n  }, [form.client_id]);\n\n  const filtered = useMemo(() => \n    filter === \"TODAS\" ? visits : visits.filter(v => v.status === filter), \n    [visits, filter]\n  );\n\n  return (\n    <div className=\"p-3\">\n      {/* Filters */}\n      <div className=\"flex gap-2 flex-wrap mb-3\">\n        {([\"TODAS\", ...STATUS] as const).map(s => (\n          <button \n            key={s} \n            onClick={() => setFilter(s as any)}\n            className={`px-3 py-1.5 rounded-full border text-sm font-medium transition-colors ${\n              filter === s \n                ? 'border-green-600 text-green-600 bg-green-50 dark:bg-green-950/30' \n                : 'border-gray-300 dark:border-gray-700 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-900'\n            }`}\n            data-testid={`filter-${s.toLowerCase()}`}\n          >\n            {s}\n          </button>\n        ))}\n      </div>\n\n      {/* Create Visit Button */}\n      <Dialog open={createOpen} onOpenChange={(open) => {\n        setCreateOpen(open);\n        if (!open) {\n          // Reset ao fechar dialog\n          setEditingVisit(null);\n          setForm({\n            client_id: \"\",\n            farm_id: \"\",\n            service_type: \"\",\n            scheduled_date: \"\",\n            scheduled_time: \"\",\n            status: \"PLANEJADA\",\n            notes: \"\",\n          });\n        }\n      }}>\n        <DialogTrigger asChild>\n          <Button \n            className=\"w-full mb-3 bg-green-600 hover:bg-green-700 text-white\" \n            size=\"lg\"\n            onClick={() => {\n              // Reset ao clicar em criar nova\n              setEditingVisit(null);\n              setForm({\n                client_id: \"\",\n                farm_id: \"\",\n                service_type: \"\",\n                scheduled_date: \"\",\n                scheduled_time: \"\",\n                status: \"PLANEJADA\",\n                notes: \"\",\n              });\n            }}\n            data-testid=\"button-create-visit\"\n          >\n            <Plus className=\"h-5 w-5 mr-2\" />\n            CRIAR VISITA\n          </Button>\n        </DialogTrigger>\n        <DialogContent className=\"max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>{editingVisit ? 'Editar Visita' : 'Nova Visita'}</DialogTitle>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label>Cliente *</Label>\n              <Select value={form.client_id} onValueChange={(v) => setForm({...form, client_id: v, farm_id: \"\"})}>\n                <SelectTrigger data-testid=\"select-client\">\n                  <SelectValue placeholder=\"Selecione o cliente\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {clients.map(c => (\n                    <SelectItem key={c.id} value={c.id}>{c.name}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            {form.client_id && farms.length > 0 && (\n              <div>\n                <Label>Fazenda</Label>\n                <Select value={form.farm_id} onValueChange={(v) => setForm({...form, farm_id: v})}>\n                  <SelectTrigger data-testid=\"select-farm\">\n                    <SelectValue placeholder=\"Selecione a fazenda (opcional)\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {farms.map(f => (\n                      <SelectItem key={f.id} value={f.id}>{f.name}</SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            )}\n\n            <div>\n              <Label>Tipo de Serviço *</Label>\n              <Select value={form.service_type} onValueChange={(v) => setForm({...form, service_type: v})}>\n                <SelectTrigger data-testid=\"select-service-type\">\n                  <SelectValue placeholder=\"Selecione o tipo\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {TIPOS_SERVICO.map(tipo => (\n                    <SelectItem key={tipo} value={tipo}>{tipo}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div className=\"grid grid-cols-2 gap-2\">\n              <div>\n                <Label>Data *</Label>\n                <Input \n                  type=\"date\"\n                  value={form.scheduled_date}\n                  onChange={(e) => setForm({...form, scheduled_date: e.target.value})}\n                  data-testid=\"input-date\"\n                />\n              </div>\n              <div>\n                <Label>Hora</Label>\n                <Input \n                  type=\"time\"\n                  value={form.scheduled_time}\n                  onChange={(e) => setForm({...form, scheduled_time: e.target.value})}\n                  data-testid=\"input-time\"\n                />\n              </div>\n            </div>\n\n            <div>\n              <Label>Status</Label>\n              <Select value={form.status} onValueChange={(v: any) => setForm({...form, status: v})}>\n                <SelectTrigger data-testid=\"select-status\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  {STATUS.map(s => (\n                    <SelectItem key={s} value={s}>{s}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            <div>\n              <Label>Observações</Label>\n              <Textarea \n                value={form.notes}\n                onChange={(e) => setForm({...form, notes: e.target.value})}\n                placeholder=\"Ex: Verificar pragas, aplicar fertilizante...\"\n                rows={3}\n                data-testid=\"input-notes\"\n              />\n            </div>\n\n            <Button \n              onClick={saveVisit} \n              className=\"w-full bg-green-600 hover:bg-green-700\"\n              disabled={!form.client_id || !form.service_type || !form.scheduled_date}\n              data-testid=\"button-save-visit\"\n            >\n              {editingVisit ? 'Salvar Alterações' : 'Criar Visita'}\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      <VisitList visits={filtered} clients={clients} onEdit={handleEditVisit} />\n    </div>\n  );\n}\n","size_bytes":11848},"client/src/hooks/useNotifications.ts":{"content":"import { useEffect } from \"react\";\nimport { showNotification } from \"@/utils/sw-register\";\n\nexport function useNotifications() {\n  useEffect(() => {\n    // Listener para eventos customizados de notificação\n    const handleCustomNotification = (event: Event) => {\n      const customEvent = event as CustomEvent;\n      const { title, body, icon } = customEvent.detail;\n      showNotification(title, { body, icon });\n    };\n\n    window.addEventListener(\"crm-notification\", handleCustomNotification);\n\n    return () => {\n      window.removeEventListener(\"crm-notification\", handleCustomNotification);\n    };\n  }, []);\n\n  function notify(title: string, body?: string, options?: { vibrate?: boolean; sound?: boolean }) {\n    // Vibração\n    if (options?.vibrate && \"vibrate\" in navigator) {\n      navigator.vibrate([200, 100, 200]);\n    }\n\n    // Som (opcional - pode ser adicionado um elemento audio)\n    if (options?.sound) {\n      try {\n        const audio = new Audio(\"/notification.mp3\");\n        audio.play().catch(() => {\n          /* ignore */\n        });\n      } catch {\n        /* ignore */\n      }\n    }\n\n    // Notificação visual\n    showNotification(title, {\n      body,\n      icon: \"/icon-192.png\",\n      badge: \"/icon-192.png\",\n      tag: \"crm-notification\",\n      requireInteraction: false,\n    });\n  }\n\n  return { notify };\n}\n","size_bytes":1343},"crm-agro-mobile/App.tsx":{"content":"import { registerRootComponent } from 'expo';\nimport App from './src/App';\n\nregisterRootComponent(App);\n","size_bytes":104},"crm-agro-mobile/src/features/navigation/AppNavigator.tsx":{"content":"import React from \"react\";\nimport { NavigationContainer, DefaultTheme } from \"@react-navigation/native\";\nimport { createBottomTabNavigator } from \"@react-navigation/bottom-tabs\";\nimport { Ionicons } from \"@expo/vector-icons\";\n\nimport HomeScreen from \"../screens/HomeScreen\";\nimport AgendaScreen from \"../screens/AgendaScreen\";\nimport ClientsScreen from \"../screens/ClientsScreen\";\nimport HistoryScreen from \"../screens/HistoryScreen\";\nimport ProfileScreen from \"../screens/ProfileScreen\";\n\nconst Tab = createBottomTabNavigator();\n\nconst theme = {\n  ...DefaultTheme,\n  colors: { ...DefaultTheme.colors, background: \"#fff\" }\n};\n\nexport default function AppNavigator() {\n  return (\n    <NavigationContainer theme={theme}>\n      <Tab.Navigator\n        screenOptions={({ route }) => ({\n          headerTitleAlign: \"center\",\n          tabBarActiveTintColor: \"#22c55e\",\n          tabBarInactiveTintColor: \"#888\",\n          tabBarLabelStyle: { fontSize: 12 },\n          tabBarIcon: ({ color, size }) => {\n            const map: Record<string, keyof typeof Ionicons.glyphMap> = {\n              Home: \"home\",\n              Agenda: \"calendar\",\n              Clientes: \"people\",\n              Historico: \"time\",\n              Perfil: \"person\"\n            };\n            const name = map[route.name] || \"ellipse\";\n            return <Ionicons name={name} size={size} color={color} />;\n          }\n        })}\n      >\n        <Tab.Screen name=\"Home\" component={HomeScreen} />\n        <Tab.Screen name=\"Agenda\" component={AgendaScreen} />\n        <Tab.Screen name=\"Clientes\" component={ClientsScreen} />\n        <Tab.Screen name=\"Historico\" component={HistoryScreen} />\n        <Tab.Screen name=\"Perfil\" component={ProfileScreen} />\n      </Tab.Navigator>\n    </NavigationContainer>\n  );\n}\n","size_bytes":1775},"client/src/components/crm/text-parser.tsx":{"content":"import { useState } from \"react\";\nimport { useToast } from \"@/hooks/use-toast\";\n\nexport default function TextParser({ onCreated }: { onCreated: () => void }) {\n  const [text, setText] = useState(\"\");\n  const [loading, setLoading] = useState(false);\n  const { toast } = useToast();\n\n  async function handleParse() {\n    if (!text.trim()) return;\n    setLoading(true);\n    try {\n      const res = await fetch(\"/api/agenda/parse\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ text })\n      });\n      const data = await res.json();\n      console.log(\"Parsed:\", data);\n      \n      if (data.items && data.items.length > 0) {\n        console.log(\"Confirmando visitas:\", data.items);\n        const confirmRes = await fetch(\"/api/agenda/confirm\", {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          credentials: \"include\",\n          body: JSON.stringify({ items: data.items })\n        });\n        \n        const result = await confirmRes.json();\n        console.log(\"Resultado confirm:\", result);\n        \n        if (confirmRes.ok) {\n          setText(\"\");\n          const description = result.skipped > 0 \n            ? `${result.skipped} não reconhecido(s): ${result.invalid_items?.join(', ')}`\n            : undefined;\n          \n          toast({\n            title: `${result.created} visita(s) criada(s)!`,\n            description,\n          });\n          onCreated();\n        } else {\n          const invalidNames = result.invalid?.join(', ') || 'clientes não reconhecidos';\n          toast({\n            variant: \"destructive\",\n            title: \"Erro ao criar visitas\",\n            description: `${result.error || 'Nenhum cliente reconhecido'}: ${invalidNames}`,\n          });\n        }\n      } else {\n        toast({\n          variant: \"destructive\",\n          title: \"Nenhum item identificado\",\n          description: \"Digite pelo menos um nome de cliente\",\n        });\n      }\n    } catch (err) {\n      console.error(\"Erro:\", err);\n      toast({\n        variant: \"destructive\",\n        title: \"Erro ao processar\",\n        description: \"Verifique sua conexão e tente novamente\",\n      });\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  return (\n    <div>\n      <h4 style={{ marginBottom: 8, fontWeight: 600 }}>Criar visitas por texto</h4>\n      <textarea\n        value={text}\n        onChange={e => setText(e.target.value)}\n        placeholder=\"Ex: amanhã João Silva inspeção 08:00; Maria Lopes amostra 10:30\"\n        style={{ width: \"100%\", padding: 8, border: \"1px solid #ddd\", borderRadius: 6, minHeight: 80 }}\n      />\n      <button\n        onClick={handleParse}\n        disabled={loading || !text.trim()}\n        style={{ \n          marginTop: 8, \n          background: loading ? \"#ccc\" : \"#1db954\", \n          color: \"#fff\", \n          border: 0, \n          padding: \"8px 16px\", \n          borderRadius: 6,\n          cursor: loading ? \"not-allowed\" : \"pointer\"\n        }}\n      >\n        {loading ? \"Criando...\" : \"Criar Visitas\"}\n      </button>\n    </div>\n  );\n}\n","size_bytes":3135},"crm-agro-mobile/src/features/screens/HomeScreen.tsx":{"content":"import React, { useState } from \"react\";\nimport { View, Text, Button, ScrollView, Alert } from \"react-native\";\nimport { syncNow } from \"@sync/sync\";\nimport ActiveVisit from \"../visits/ActiveVisit\";\nimport RouteMap from \"../visits/RouteMap\";\n\nexport default function HomeScreen() {\n  const [syncing, setSyncing] = useState(false);\n\n  async function handleSync() {\n    setSyncing(true);\n    const result = await syncNow();\n    setSyncing(false);\n    \n    if (result.success) {\n      Alert.alert(\"Sincronizado\", `${result.synced} visitas atualizadas`);\n    } else {\n      Alert.alert(\"Erro\", \"Falha na sincronização\");\n    }\n  }\n\n  return (\n    <ScrollView style={{ flex: 1 }} contentContainerStyle={{ padding: 16, gap: 16 }}>\n      <Button \n        title={syncing ? \"Sincronizando...\" : \"SINCRONIZAR AGORA\"} \n        color=\"#22c55e\" \n        onPress={handleSync}\n        disabled={syncing}\n      />\n\n      <Text style={{ fontWeight: \"bold\", marginTop: 8 }}>Rota do dia — selecione a visita ativa</Text>\n      \n      <View style={{ height: 360 }}>\n        <Text style={{ fontWeight: \"600\", marginBottom: 6 }}>Mapa da Rota</Text>\n        <View style={{ height: 300, borderWidth: 1, borderColor: \"#eee\", borderRadius: 8, overflow: \"hidden\" }}>\n          <RouteMap />\n        </View>\n      </View>\n\n      <ActiveVisit />\n    </ScrollView>\n  );\n}\n","size_bytes":1344},"crm-agro-mobile/README.md":{"content":"# 📱 CRM Agro Mobile\n\nApp mobile Android (Expo + React Native) para gerenciamento de visitas de campo com funcionalidades offline-first.\n\n## 🚀 Funcionalidades\n\n- ✅ **Autenticação por Cookie** - Sessão compartilhada com web app\n- 📍 **Geofencing Inteligente** - Detecta saída da base + velocidade para iniciar viagens\n- 🗺️ **Mapa de Rota** - Visualização otimizada das visitas do dia\n- 📝 **Agenda por Texto** - Parser NLP para criar visitas com linguagem natural\n- 💾 **Offline-First** - SQLite local + outbox pattern para sincronização\n- 🔄 **Delta Sync** - Sincronização incremental com backend\n- 📊 **Tracking GPS** - Registro automático de telemetria durante viagens\n\n## 📋 Pré-requisitos\n\n- Node.js 18+\n- Android Studio (para emulador) ou dispositivo Android físico\n- Expo CLI: `npm install -g expo-cli`\n\n## 🔧 Instalação\n\n1. **Instalar dependências**\n```bash\ncd crm-agro-mobile\nnpm install\n```\n\n2. **Configurar URL do backend**\n\nEdite `src/api/client.ts` e configure a URL do seu Replit:\n\n```typescript\nexport const API_BASE = \"https://seu-repl.replit.app\";\n```\n\nOu crie um arquivo `.env` na raiz:\n```\nEXPO_PUBLIC_API_URL=https://seu-repl.replit.app\n```\n\n3. **Iniciar o app**\n```bash\nnpx expo start\n```\n\n4. **Rodar no Android**\n- Pressione `a` no terminal para abrir no emulador Android\n- Ou escaneie o QR code com o app Expo Go no celular\n\n## 🏗️ Estrutura do Projeto\n\n```\ncrm-agro-mobile/\n├── src/\n│   ├── api/              # Cliente HTTP com axios\n│   ├── auth/             # Sistema de autenticação\n│   ├── db/               # SQLite local (schema + state)\n│   ├── geo/              # Geofencing e tracking GPS\n│   ├── sync/             # Sincronização offline-first\n│   └── features/\n│       ├── visits/       # Telas de visitas e mapa\n│       └── agenda/       # Parser NLP para agenda\n├── app.json              # Configuração Expo\n├── package.json\n└── tsconfig.json\n```\n\n## 🔐 Configuração do Backend\n\nO app se conecta aos seguintes endpoints:\n\n- `POST /api/login` - Autenticação (retorna cookie de sessão)\n- `GET /api/user` - Dados do usuário logado\n- `POST /api/logout` - Encerrar sessão\n- `GET /api/visits?updated_since=ISO_DATE` - Delta sync de visitas\n- `GET /api/visits/route?date=YYYY-MM-DD` - Rota otimizada do dia\n- `POST /api/trips/start` - Iniciar viagem\n- `POST /api/trips/gps` - Enviar telemetria GPS\n- `POST /api/trips/:id/end` - Finalizar viagem\n- `POST /api/agenda/parse` - Parser NLP de texto\n- `POST /api/agenda/confirm` - Criar visitas em lote\n\n**IMPORTANTE:** O backend deve configurar cookies com `SameSite=None; Secure` para funcionar em HTTPS.\n\n## 📱 Funcionalidades Detalhadas\n\n### Sincronização Offline\n\nO app usa **outbox pattern** para garantir que nenhuma ação seja perdida:\n\n1. Ações do usuário são salvas localmente no SQLite\n2. Tentativas de sincronização automáticas quando online\n3. Retry com backoff exponencial em caso de falha\n4. Delta-sync incremental usando `updated_since`\n\n### Geofencing e Trip Detection\n\n- Registra geofence de 200m na base (coordenadas configuráveis)\n- Detecta saída da base + velocidade > 15km/h\n- Inicia trip automaticamente e ativa tracking GPS\n- Envia telemetria a cada 7 segundos ou 10 metros\n\n### Parser NLP de Agenda\n\nConverte texto natural em visitas agendadas:\n\n```\n\"amanhã: João Pereira inspeção 08:00; Maria Lopes amostra 10:30 (obs: prioridade)\"\n```\n\nO sistema:\n- Extrai nomes de clientes (fuzzy match com master_clients)\n- Identifica intent (inspeção, reunião, entrega, amostra)\n- Parseia data/hora\n- Detecta prioridade e observações\n\n## 🧪 Testando\n\n1. **Fazer login** com credenciais do sistema web\n2. **Sincronizar** para baixar visitas do dia\n3. **Selecionar visita ativa** na lista\n4. **Ver mapa de rota** com visitas ordenadas\n5. **Criar agenda** usando texto natural\n\n## 🔒 Permissões Android\n\nO app requer as seguintes permissões (já configuradas em `app.json`):\n\n- `ACCESS_FINE_LOCATION` - GPS preciso\n- `ACCESS_COARSE_LOCATION` - Localização aproximada\n- `ACCESS_BACKGROUND_LOCATION` - Tracking em background\n\n## 🐛 Troubleshooting\n\n### Cookies não funcionam\n- Verifique se o backend está em HTTPS\n- Confirme que `SameSite=None; Secure` está configurado\n- Use `withCredentials: true` no axios (já configurado)\n\n### Geofencing não detecta saída\n- Verifique permissões de localização em background\n- Android 10+ requer `ACCESS_BACKGROUND_LOCATION`\n- Teste com velocidade > 15km/h\n\n### Delta sync não atualiza\n- Confirme que o backend atualiza `updatedAt` em todas mutations\n- Verifique timestamp salvo em `app_state.last_sync`\n\n## 📚 Próximos Passos\n\n- [ ] Adicionar upload de fotos em checklists\n- [ ] Implementar assinaturas digitais\n- [ ] Cache de mapas offline\n- [ ] Notificações push para novas visitas\n- [ ] Modo escuro\n\n## 📄 Licença\n\nUso interno - Agro Farma Digital\n","size_bytes":4970},"client/src/pages/crm/historico.tsx":{"content":"import { useEffect, useMemo, useState } from \"react\";\nimport { db } from \"@/lib/crm/idb\";\nimport VisitList from \"@/components/crm/visit-list\";\n\nexport default function CRMHistorico() {\n  const [visits, setVisits] = useState<any[]>([]);\n\n  useEffect(() => {\n    (async () => {\n      const all = await db.visits.toArray();\n      setVisits(all as any);\n    })();\n  }, []);\n\n  const concluded = useMemo(\n    () => (visits || [])\n      .filter(v => v.status === \"CONCLUIDA\")\n      .sort((a, b) =>\n        (new Date((b.window_start||0) as any).getTime() - new Date((a.window_start||0) as any).getTime())\n      ),\n    [visits]\n  );\n\n  return (\n    <div style={{ padding: 12 }}>\n      <h3>Histórico de Visitas</h3>\n      {concluded.length ? <VisitList visits={concluded} /> : <div>Nenhuma visita concluída.</div>}\n    </div>\n  );\n}\n","size_bytes":826},"crm-agro-mobile/src/features/agenda/AgendaFromText.tsx":{"content":"import React, { useState } from \"react\";\nimport { View, Text, TextInput, Button, FlatList, StyleSheet, Alert } from \"react-native\";\nimport { api } from \"@api/client\";\n\nexport default function AgendaFromText() {\n  const [text, setText] = useState(\"amanhã: João Pereira inspeção 08:00; Maria Lopes amostra 10:30 (obs: prioridade)\");\n  const [items, setItems] = useState<any[]>([]);\n  const [loading, setLoading] = useState(false);\n\n  async function parse() {\n    try {\n      setLoading(true);\n      const { data } = await api.post(\"/api/agenda/parse\", { text });\n      setItems(data.items || []);\n    } catch (error) {\n      Alert.alert(\"Erro\", \"Falha ao analisar texto\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function confirm() {\n    const validItems = items.filter(i => i.client_id);\n    \n    if (!validItems.length) {\n      Alert.alert(\"Aviso\", \"Nenhuma visita válida para confirmar\");\n      return;\n    }\n\n    try {\n      setLoading(true);\n      \n      const payload = validItems.map(i => ({\n        client_id: i.client_id,\n        intent: i.intent,\n        date: i.date,\n        time: i.time,\n        notes: i.notes,\n        priority: i.priority\n      }));\n      \n      await api.post(\"/api/agenda/confirm\", { items: payload });\n      Alert.alert(\"Sucesso\", `${payload.length} visitas criadas!`);\n      setItems([]);\n      setText(\"\");\n    } catch (error) {\n      Alert.alert(\"Erro\", \"Falha ao criar visitas\");\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  return (\n    <View style={styles.container}>\n      <Text style={styles.title}>Gerar agenda por texto</Text>\n      \n      <TextInput\n        value={text}\n        onChangeText={setText}\n        placeholder=\"Digite aqui... Ex: amanhã João Silva inspeção 08:00\"\n        multiline\n        style={styles.input}\n      />\n      \n      <Button\n        title={loading ? \"Analisando...\" : \"Analisar\"}\n        onPress={parse}\n        disabled={loading}\n        color=\"#22c55e\"\n      />\n      \n      <FlatList\n        data={items}\n        keyExtractor={(_, i) => String(i)}\n        renderItem={({ item }) => (\n          <View style={[\n            styles.itemCard,\n            !item.client_id && styles.itemCardError\n          ]}>\n            <Text style={styles.itemClient}>\n              Cliente: {item.client_name} {item.client_id ? \"✅\" : \"❌ não encontrado\"}\n            </Text>\n            <Text style={styles.itemDetail}>Intent: {item.intent || \"-\"}</Text>\n            <Text style={styles.itemDetail}>Dia/Hora: {item.date} {item.time || \"\"}</Text>\n            {item.notes ? <Text style={styles.itemDetail}>Obs: {item.notes}</Text> : null}\n            <Text style={styles.itemDetail}>Prioridade: {item.priority || \"normal\"}</Text>\n          </View>\n        )}\n      />\n      \n      {items.length > 0 && (\n        <Button\n          title={loading ? \"Criando...\" : `Confirmar e criar ${items.filter(i => i.client_id).length} visitas`}\n          onPress={confirm}\n          disabled={loading}\n          color=\"#22c55e\"\n        />\n      )}\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    padding: 16,\n    gap: 12,\n  },\n  title: {\n    fontWeight: \"bold\",\n    fontSize: 16,\n  },\n  input: {\n    minHeight: 100,\n    borderWidth: 1,\n    borderColor: \"#ddd\",\n    borderRadius: 8,\n    padding: 8,\n    textAlignVertical: \"top\",\n  },\n  itemCard: {\n    padding: 8,\n    borderBottomWidth: 1,\n    borderColor: \"#eee\",\n    marginVertical: 4,\n  },\n  itemCardError: {\n    backgroundColor: \"#fee2e2\",\n  },\n  itemClient: {\n    fontWeight: \"500\",\n  },\n  itemDetail: {\n    fontSize: 12,\n    color: \"#666\",\n    marginTop: 2,\n  },\n});\n","size_bytes":3631},"server/services/stateMachine.ts":{"content":"export type VisitStatus = \"PLANEJADA\"|\"PRONTA\"|\"EM_DESLOCAMENTO\"|\"NO_LOCAL\"|\"CONCLUIDA\";\n\nconst transitions: Record<VisitStatus, VisitStatus[]> = {\n  PLANEJADA: [\"PRONTA\",\"EM_DESLOCAMENTO\"],\n  PRONTA: [\"EM_DESLOCAMENTO\",\"PLANEJADA\"],\n  EM_DESLOCAMENTO: [\"NO_LOCAL\",\"PLANEJADA\"],\n  NO_LOCAL: [\"CONCLUIDA\",\"EM_DESLOCAMENTO\"],\n  CONCLUIDA: []\n};\n\nexport function canTransition(from: VisitStatus, to: VisitStatus) {\n  return transitions[from]?.includes(to);\n}\n","size_bytes":456},"server/services/nlp.service.ts":{"content":"import Fuse from \"fuse.js\";\nimport { db } from \"../db\";\nimport { sql } from \"drizzle-orm\";\n\ntype ParsedAgendaItem = {\n  client_name: string;\n  client_id?: string;\n  intent?: string;\n  notes?: string;\n  priority?: \"A\" | \"B\" | \"C\";\n  date?: string;\n  time?: string;\n};\n\nconst INTENT_MAP: Record<string, string> = {\n  \"inspecao\": \"INSPECAO_SOJA\",\n  \"inspeção\": \"INSPECAO_SOJA\",\n  \"amostra\": \"AMOSTRA_SOLO\",\n  \"pos-venda\": \"POS_VENDA\",\n  \"pós-venda\": \"POS_VENDA\",\n  \"colheita\": \"INSPECAO_COLHEITA\"\n};\n\nfunction normalize(s: string){ return s.normalize(\"NFD\").replace(/\\p{Diacritic}/gu,\"\").toLowerCase(); }\n\nfunction parseLines(text: string): ParsedAgendaItem[] {\n  const lines = text.split(/\\n|;|,/).map(l => l.trim()).filter(Boolean);\n  const items: ParsedAgendaItem[] = [];\n  for (const raw of lines) {\n    const s = normalize(raw);\n    const item: ParsedAgendaItem = { client_name: raw };\n    if (/\\burgente\\b|\\bprioriza\\b/.test(s)) item.priority = \"A\";\n    else if (/\\balta\\b/.test(s)) item.priority = \"A\";\n    else if (/\\bmedia\\b|\\bmédia\\b/.test(s)) item.priority = \"B\";\n    else if (/\\bbaixa\\b/.test(s)) item.priority = \"C\";\n\n    for (const k of Object.keys(INTENT_MAP)) {\n      if (s.includes(normalize(k))) { item.intent = INTENT_MAP[k]; break; }\n    }\n    const hm = s.match(/\\b(\\d{1,2})(?:[:h](\\d{2}))?\\b/);\n    if (hm) {\n      const hh = hm[1].padStart(2,\"0\"); const mm = (hm[2]||\"00\").padStart(2,\"0\");\n      item.time = `${hh}:${mm}`;\n    }\n    const obs = s.match(/obs[:\\-\\s]+(.+)$/) || raw.match(/\\((.+)\\)/);\n    if (obs) item.notes = obs[1];\n    items.push(item);\n  }\n  return items;\n}\n\nexport async function parseAgenda(text: string) {\n  const items = parseLines(text);\n\n  // Busca clientes ativos via master_clients\n  const res = await db.execute(sql`SELECT id, name FROM master_clients WHERE is_active = true`);\n  const rows = (res as any).rows || [];\n  const fuse = new Fuse(rows, { keys: [\"name\"], threshold: 0.3 });\n\n  const resolved = items.map(i => {\n    const best = fuse.search(i.client_name)[0];\n    return { ...i, client_id: (best?.item as any)?.id };\n  });\n\n  const d = new Date().toISOString().slice(0,10);\n  return resolved.map(i => ({ ...i, date: i.date || d }));\n}\n","size_bytes":2197},"client/src/pages/crm/atendimento.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { useRoute, useLocation } from \"wouter\";\nimport { db } from \"@/lib/crm/idb\";\nimport { Button } from \"@/components/ui/button\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Camera, X, Check } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { OdometerDialog } from \"@/components/OdometerDialog\";\n\ntype Photo = {\n  id: string;\n  url: string;\n  description: string;\n  timestamp: Date;\n};\n\nexport default function Atendimento() {\n  const [, params] = useRoute(\"/crm/atendimento/:visitId\");\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  \n  const [visitId] = useState(params?.visitId || \"\");\n  const [clientName, setClientName] = useState(\"\");\n  const [farmName, setFarmName] = useState(\"\");\n  const [serviceType, setServiceType] = useState(\"\");\n  const [photos, setPhotos] = useState<Photo[]>([]);\n  const [currentDescription, setCurrentDescription] = useState(\"\");\n  const [loading, setLoading] = useState(false);\n  const [showOdometerDialog, setShowOdometerDialog] = useState(false);\n\n  useEffect(() => {\n    (async () => {\n      if (!visitId) return;\n      \n      const visit = await db.visits.get(visitId);\n      if (!visit) return;\n\n      const client = await db.clients.get(visit.client_id);\n      setClientName(client?.name || visit.client_id);\n\n      if (visit.farm_id) {\n        const farm = await db.farms.get(visit.farm_id);\n        setFarmName(farm?.name || \"\");\n      }\n\n      // Extrai tipo de serviço das notas\n      const service = visit.notes?.split(' - ')[0] || 'Atendimento';\n      setServiceType(service);\n    })();\n  }, [visitId]);\n\n  async function handlePhotoCapture(e: React.ChangeEvent<HTMLInputElement>) {\n    const file = e.target.files?.[0];\n    if (!file) return;\n\n    const reader = new FileReader();\n    reader.onload = (evt) => {\n      const photo: Photo = {\n        id: `photo-${Date.now()}`,\n        url: evt.target?.result as string,\n        description: currentDescription,\n        timestamp: new Date(),\n      };\n      setPhotos([...photos, photo]);\n      setCurrentDescription(\"\");\n    };\n    reader.readAsDataURL(file);\n  }\n\n  function removePhoto(photoId: string) {\n    setPhotos(photos.filter(p => p.id !== photoId));\n  }\n\n  function updatePhotoDescription(photoId: string, description: string) {\n    setPhotos(photos.map(p => \n      p.id === photoId ? { ...p, description } : p\n    ));\n  }\n\n  async function iniciarConclusao() {\n    if (photos.length === 0) {\n      toast({\n        title: \"Adicione pelo menos uma foto\",\n        description: \"Registre o atendimento com fotos\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    // Solicita quilometragem final antes de concluir\n    setShowOdometerDialog(true);\n  }\n\n  async function concluirAtendimento(odometerFinal: number) {\n    setLoading(true);\n\n    try {\n      // Prepara fotos\n      const photoData = photos.map(p => ({\n        url: p.url,\n        description: p.description,\n        timestamp: p.timestamp.toISOString(),\n      }));\n\n      // Atualiza visita como concluída COM FOTOS\n      await db.visits.update(visitId, { \n        status: \"CONCLUIDA\",\n        notes: `${serviceType} - ${photos.length} foto(s) anexada(s)`,\n        photos: photoData\n      });\n\n      // Salva no outbox para sync\n      await db.outbox.add({\n        type: \"VISIT_CREATE\",\n        payload: {\n          id: visitId,\n          status: \"CONCLUIDA\",\n          photos: photoData,\n        },\n        created_at: Date.now(),\n        attempts: 0,\n      });\n\n      // Finaliza trip com quilometragem final\n      await db.outbox.add({\n        type: \"TRIP_END\",\n        payload: {\n          visit_id: visitId,\n          odometer: odometerFinal,\n        },\n        created_at: Date.now(),\n        attempts: 0,\n      });\n\n      toast({\n        title: \"Atendimento concluído!\",\n        description: `${clientName} - ${photos.length} foto(s) salva(s)`,\n      });\n\n      // Volta para home\n      setLocation(\"/crm/home\");\n    } catch (err) {\n      console.error(\"Erro ao concluir:\", err);\n      toast({\n        title: \"Erro\",\n        description: \"Não foi possível concluir o atendimento\",\n        variant: \"destructive\"\n      });\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-950 p-4\">\n      {/* Header */}\n      <Card className=\"mb-4\">\n        <CardHeader className=\"pb-3\">\n          <CardTitle className=\"text-lg\">Atendimento em Andamento</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-2\">\n          <div>\n            <p className=\"text-sm text-muted-foreground\">Cliente</p>\n            <p className=\"font-semibold\">{clientName}</p>\n          </div>\n          {farmName && (\n            <div>\n              <p className=\"text-sm text-muted-foreground\">Fazenda</p>\n              <p className=\"font-semibold\">{farmName}</p>\n            </div>\n          )}\n          <div>\n            <p className=\"text-sm text-muted-foreground\">Serviço</p>\n            <p className=\"font-semibold\">{serviceType}</p>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Fotos */}\n      <Card className=\"mb-4\">\n        <CardHeader className=\"pb-3\">\n          <CardTitle className=\"text-base\">Fotos do Atendimento</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-3\">\n          {/* Upload Button */}\n          <div>\n            <label htmlFor=\"photo-upload\" className=\"block\">\n              <div className=\"border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg p-4 text-center cursor-pointer hover:border-green-500 transition-colors\">\n                <Camera className=\"h-8 w-8 mx-auto mb-2 text-gray-400\" />\n                <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                  Toque para adicionar foto\n                </p>\n              </div>\n            </label>\n            <input\n              id=\"photo-upload\"\n              type=\"file\"\n              accept=\"image/*\"\n              capture=\"environment\"\n              className=\"hidden\"\n              onChange={handlePhotoCapture}\n              data-testid=\"input-photo-upload\"\n            />\n          </div>\n\n          {/* Descrição da próxima foto */}\n          <Textarea\n            value={currentDescription}\n            onChange={(e) => setCurrentDescription(e.target.value)}\n            placeholder=\"Descrição da próxima foto...\"\n            rows={2}\n            data-testid=\"input-photo-description\"\n          />\n\n          {/* Lista de Fotos */}\n          <div className=\"space-y-3\">\n            {photos.map((photo) => (\n              <div key={photo.id} className=\"border rounded-lg p-3 bg-white dark:bg-gray-900\">\n                <div className=\"flex gap-3\">\n                  <img \n                    src={photo.url} \n                    alt=\"Foto do atendimento\"\n                    className=\"w-20 h-20 object-cover rounded\"\n                  />\n                  <div className=\"flex-1 min-w-0\">\n                    <Textarea\n                      value={photo.description}\n                      onChange={(e) => updatePhotoDescription(photo.id, e.target.value)}\n                      placeholder=\"Adicione uma descrição...\"\n                      rows={2}\n                      className=\"mb-2\"\n                      data-testid={`input-description-${photo.id}`}\n                    />\n                    <p className=\"text-xs text-muted-foreground\">\n                      {photo.timestamp.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}\n                    </p>\n                  </div>\n                  <Button\n                    size=\"icon\"\n                    variant=\"ghost\"\n                    onClick={() => removePhoto(photo.id)}\n                    data-testid={`button-remove-${photo.id}`}\n                  >\n                    <X className=\"h-4 w-4\" />\n                  </Button>\n                </div>\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Botão Concluir */}\n      <Button\n        className=\"w-full bg-green-600 hover:bg-green-700\"\n        size=\"lg\"\n        onClick={iniciarConclusao}\n        disabled={loading || photos.length === 0}\n        data-testid=\"button-complete-visit\"\n      >\n        <Check className=\"h-5 w-5 mr-2\" />\n        Concluir Atendimento ({photos.length} foto{photos.length !== 1 ? 's' : ''})\n      </Button>\n\n      {/* Diálogo de Quilometragem Final */}\n      <OdometerDialog\n        open={showOdometerDialog}\n        title=\"Quilometragem Final\"\n        description=\"Digite a quilometragem atual do veículo para finalizar o atendimento\"\n        onConfirm={(odometer) => {\n          setShowOdometerDialog(false);\n          concluirAtendimento(odometer);\n        }}\n        onCancel={() => {\n          setShowOdometerDialog(false);\n          setLoading(false);\n        }}\n      />\n    </div>\n  );\n}\n","size_bytes":9049},"client/src/utils/sw-register.ts":{"content":"export async function registerServiceWorker() {\n  if (\"serviceWorker\" in navigator) {\n    try {\n      const registration = await navigator.serviceWorker.register(\"/sw.js\");\n      console.log(\"✅ Service Worker registrado:\", registration.scope);\n      return registration;\n    } catch (error) {\n      console.error(\"❌ Erro ao registrar Service Worker:\", error);\n    }\n  }\n}\n\nexport async function requestNotificationPermission() {\n  if (\"Notification\" in window) {\n    const permission = await Notification.requestPermission();\n    console.log(\"Permissão de notificação:\", permission);\n    return permission === \"granted\";\n  }\n  return false;\n}\n\nexport function showNotification(title: string, options?: NotificationOptions) {\n  if (\"Notification\" in window && Notification.permission === \"granted\") {\n    new Notification(title, options);\n  }\n}\n","size_bytes":851},"crm-agro-mobile/TEST_CONNECTION.md":{"content":"# 📡 TESTE DE CONECTIVIDADE MOBILE\n\n## 🔍 Status Atual\n\n**Backend:** ✅ Rodando em `https://17ae9dc1-8e31-40d1-881b-109572f48345-00-1ksns2gutezyn.spock.replit.dev`  \n**Mobile App:** ❓ Não conecta (zero requisições no log do backend)\n\n## 🧪 Como Testar\n\n### 1️⃣ No Terminal do Mac (mobile):\n\n```bash\ncd ~/Downloads/crm-agro-mobile\nnpx expo start --clear\n```\n\n### 2️⃣ No celular Android:\n\n1. **Force close do Expo Go** (matar app completamente)\n2. **Abrir Expo Go** novamente\n3. **Escanear QR code** que aparece no Terminal\n\n### 3️⃣ Quando o app abrir:\n\n**Tela de login deve mostrar:**\n- ✅ Campos de usuário e senha\n- ✅ **Linha pequena com URL** (🔗 https://17ae9dc1...)\n- ✅ Botão \"ENTRAR\"\n\n**Teste de Login:**\n- Usuário: `fregolao`\n- Senha: `123`\n\n**OU**\n\n- Usuário: `bruno`\n- Senha: `123`\n\n### 4️⃣ Verificar logs:\n\n**Se aparecer erro \"Falha no login\":**\n- Verificar se a **URL aparece** na tela\n- Verificar no **Terminal do mobile** se há erros de rede\n- Verificar no **log do backend** (Replit) se apareceu `POST /api/login`\n\n## ⚠️ Problemas Conhecidos\n\n### Expo Go tem limitações:\n\n1. **Background location NÃO funciona totalmente** no Expo Go\n   - Aviso \"Background location permission denied\" é **NORMAL**\n   - Para background tracking funcionar 100%, precisa fazer build nativo\n\n2. **Cookies podem não funcionar** entre dispositivo e Replit\n   - Replit usa HTTPS mas pode ter problemas de CORS/cookies\n   - Vamos debugar isso se o login falhar\n\n## 📋 Checklist\n\n- [ ] Terminal mostra QR code sem erros vermelhos\n- [ ] App abre no celular sem tela vermelha de erro\n- [ ] Tela de login aparece com URL visível\n- [ ] Ao fazer login, backend recebe `POST /api/login` (verificar logs)\n- [ ] Se falhar, anotar mensagem de erro EXATA\n","size_bytes":1785},"crm-agro-mobile/src/db/operations.ts":{"content":"import { db } from \"./schema\";\n\nexport function updateVisitStatus(visitId: string, status: string) {\n  try {\n    db.runSync(\n      \"UPDATE visits SET status = ?, updated_at = ? WHERE id = ?\",\n      [status, new Date().toISOString(), visitId]\n    );\n    \n    db.runSync(\n      \"INSERT INTO outbox (op_id, type, payload, created_at) VALUES (?, ?, ?, ?)\",\n      [\n        `visit_status_${visitId}_${Date.now()}`,\n        \"VISIT_STATUS\",\n        JSON.stringify({\n          visit_id: visitId,\n          status,\n          updated_at: new Date().toISOString()\n        }),\n        new Date().toISOString()\n      ]\n    );\n    \n    return true;\n  } catch (error) {\n    console.error('Update visit status error:', error);\n    return false;\n  }\n}\n\nexport function saveChecklist(visitId: string, data: any) {\n  try {\n    db.runSync(\n      \"INSERT INTO outbox (op_id, type, payload, created_at) VALUES (?, ?, ?, ?)\",\n      [\n        `checklist_${visitId}_${Date.now()}`,\n        \"CHECKLIST_SAVE\",\n        JSON.stringify({\n          visit_id: visitId,\n          data,\n          completed_at: new Date().toISOString()\n        }),\n        new Date().toISOString()\n      ]\n    );\n    \n    db.runSync(\n      \"UPDATE visits SET status = ?, updated_at = ? WHERE id = ?\",\n      ['CONCLUIDA', new Date().toISOString(), visitId]\n    );\n    \n    return true;\n  } catch (error) {\n    console.error('Save checklist error:', error);\n    return false;\n  }\n}\n\nexport function createVisit(visitData: any) {\n  try {\n    const visitId = `visit-${Date.now()}`;\n    const now = new Date().toISOString();\n    \n    db.runSync(\n      `INSERT INTO visits (id, client_id, farm_id, field_id, scheduled_at, window_start, window_end, status, assignee, notes, created_at, updated_at) \n       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,\n      [\n        visitId,\n        visitData.client_id || null,\n        visitData.farm_id || null,\n        visitData.field_id || null,\n        visitData.scheduled_at || null,\n        visitData.window_start || null,\n        visitData.window_end || null,\n        'PLANEJADA',\n        visitData.assignee || null,\n        visitData.notes || null,\n        now,\n        now\n      ]\n    );\n    \n    db.runSync(\n      \"INSERT INTO outbox (op_id, type, payload, created_at) VALUES (?, ?, ?, ?)\",\n      [\n        `visit_create_${visitId}`,\n        \"VISIT_CREATE\",\n        JSON.stringify({\n          ...visitData,\n          id: visitId,\n          status: 'PLANEJADA',\n          created_at: now\n        }),\n        now\n      ]\n    );\n    \n    return visitId;\n  } catch (error) {\n    console.error('Create visit error:', error);\n    return null;\n  }\n}\n","size_bytes":2631},"client/src/pages/crm/perfil.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\n\nexport default function CRMPerfil() {\n  async function logout() {\n    try {\n      await fetch(\"/api/logout\", { method: \"POST\", credentials: \"include\" });\n    } catch {}\n    window.location.href = \"/\";\n  }\n\n  return (\n    <div className=\"p-4 space-y-4\">\n      <Card>\n        <CardHeader>\n          <CardTitle>Perfil</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <Button onClick={logout} variant=\"destructive\">\n            Sair do CRM\n          </Button>\n          <p className=\"text-sm text-muted-foreground\">\n            Dica: adicione este app à tela inicial (PWA) para uma experiência tipo nativa.\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":845},"client/src/pages/crm/home.tsx":{"content":"import { useEffect, useState, useRef } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { useSync } from \"@/hooks/useSync\";\nimport { useTracking } from \"@/hooks/useTracking\";\nimport { db, VisitLocal } from \"@/lib/crm/idb\";\nimport { Camera, MapPin, Clock, ChevronRight, Play } from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport { ptBR } from \"date-fns/locale\";\nimport { Button } from \"@/components/ui/button\";\nimport { OdometerDialog } from \"@/components/OdometerDialog\";\n\ntype FeedItem = {\n  id: string;\n  type: \"visit\" | \"photo\" | \"checklist\";\n  userName: string;\n  clientName: string;\n  farmName?: string;\n  description: string;\n  timestamp: Date;\n  photos?: { url: string; description: string; timestamp: string; }[];\n  status?: string;\n};\n\ntype AgendaVisit = {\n  id: string;\n  order: number;\n  clientName: string;\n  farmName?: string;\n  scheduledTime: string;\n  status: string;\n  serviceType: string;\n};\n\nexport default function CRMHome() {\n  const [, setLocation] = useLocation();\n  const { syncing, syncNow } = useSync();\n  const [feedItems, setFeedItems] = useState<FeedItem[]>([]);\n  const [agendaVisits, setAgendaVisits] = useState<AgendaVisit[]>([]);\n  const [userId, setUserId] = useState<string>(\"\");\n  const [userName, setUserName] = useState<string>(\"Consultor\");\n  const redirectedRef = useRef(false);\n  const [showOdometer, setShowOdometer] = useState(false);\n  const odometerCallbackRef = useRef<((odometer: number) => void) | null>(null);\n  const markTripStartedRef = useRef<(() => void) | null>(null);\n\n  useEffect(() => {\n    const stored = localStorage.getItem(\"crm_user\");\n    if (stored) {\n      const user = JSON.parse(stored);\n      setUserId(user.id);\n      setUserName(user.name || \"Consultor\");\n    }\n  }, []);\n\n  // Auto-redirecionar para atendimento quando visita ficar NO_LOCAL\n  useEffect(() => {\n    const interval = setInterval(async () => {\n      if (redirectedRef.current) return;\n\n      const visits = await db.visits.toArray();\n      const visitaNoLocal = visits.find(v => v.status === 'NO_LOCAL');\n      \n      if (visitaNoLocal) {\n        redirectedRef.current = true;\n        setLocation(`/crm/atendimento/${visitaNoLocal.id}`);\n      }\n    }, 1000);\n\n    return () => clearInterval(interval);\n  }, [setLocation]);\n\n  useEffect(() => {\n    (async () => {\n      const visits = await db.visits.toArray();\n      const clients = await db.clients.toArray();\n      const farms = await db.farms.toArray();\n      \n      // Filter upcoming visits for agenda (today and next 7 days)\n      const today = new Date();\n      today.setHours(0, 0, 0, 0);\n      const weekFromNow = new Date(today);\n      weekFromNow.setDate(weekFromNow.getDate() + 7);\n      \n      const upcomingVisits = visits.filter(v => {\n        if (!v.window_start) return false;\n        const visitDate = new Date(v.window_start);\n        visitDate.setHours(0, 0, 0, 0);\n        return visitDate >= today && visitDate <= weekFromNow;\n      });\n\n      // Sort by scheduled time and create agenda\n      upcomingVisits.sort((a, b) => {\n        const timeA = a.window_start ? new Date(a.window_start).getTime() : 0;\n        const timeB = b.window_start ? new Date(b.window_start).getTime() : 0;\n        return timeA - timeB;\n      });\n\n      const agenda: AgendaVisit[] = upcomingVisits.map((v, index) => {\n        const client = clients.find(c => c.id === v.client_id);\n        const farm = v.farm_id ? farms.find(f => f.id === v.farm_id) : null;\n        \n        let scheduledTime = '00:00';\n        if (v.window_start) {\n          const visitDate = new Date(v.window_start);\n          const dateLabel = visitDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });\n          const timeLabel = visitDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });\n          scheduledTime = `${dateLabel} ${timeLabel}`;\n        }\n        \n        return {\n          id: v.id,\n          order: index + 1,\n          clientName: client?.name || v.client_id,\n          farmName: farm?.name,\n          scheduledTime: scheduledTime,\n          status: v.status,\n          serviceType: v.notes?.split(' - ')[0] || 'Visita',\n        };\n      });\n\n      setAgendaVisits(agenda);\n      \n      // Create feed items from completed visits\n      const items: FeedItem[] = [];\n      \n      for (const visit of visits.filter(v => v.status === 'CONCLUIDA').slice(0, 20)) {\n        const client = clients.find(c => c.id === visit.client_id);\n        const farm = visit.farm_id ? farms.find(f => f.id === visit.farm_id) : null;\n        \n        items.push({\n          id: visit.id,\n          type: \"visit\",\n          userName,\n          clientName: client?.name || visit.client_id,\n          farmName: farm?.name || undefined,\n          description: visit.notes || `Visita ${visit.status}`,\n          timestamp: visit.window_start ? new Date(visit.window_start) : new Date(),\n          photos: visit.photos || [],\n          status: visit.status,\n        });\n      }\n      \n      items.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());\n      \n      setFeedItems(items);\n    })();\n  }, [syncing, userName]);\n\n  async function startVisit(visitId: string) {\n    // Solicitar quilometragem antes de iniciar\n    odometerCallbackRef.current = async (odometer: number) => {\n      await db.visits.update(visitId, { status: 'EM_DESLOCAMENTO' });\n      \n      // Pegar dados da visita\n      const visit = await db.visits.get(visitId);\n      if (visit) {\n        const { enqueue } = await import(\"@/hooks/useSync\");\n        \n        // Enqueue status change\n        await enqueue(\"VISIT_CREATE\", { \n          id: visitId, \n          status: \"EM_DESLOCAMENTO\" \n        });\n        \n        // Enqueue trip start com quilometragem\n        await enqueue(\"TRIP_START\", { \n          visit_id: visitId,\n          ts: new Date().toISOString(), \n          odometer: odometer\n        });\n      }\n      \n      // Marcar trip como iniciado para prevenir disparo automático\n      if (markTripStartedRef.current) {\n        markTripStartedRef.current();\n      }\n      \n      // Trigger re-render\n      syncNow();\n    };\n    setShowOdometer(true);\n  }\n\n  useTracking(userId, {\n    onRequestOdometer: (callback) => {\n      odometerCallbackRef.current = callback;\n      setShowOdometer(true);\n    },\n    onTripStarted: (markStarted) => {\n      markTripStartedRef.current = markStarted;\n    }\n  });\n\n  const statusColors = {\n    'PLANEJADA': 'bg-blue-500',\n    'PRONTA': 'bg-purple-500',\n    'EM_DESLOCAMENTO': 'bg-orange-500',\n    'NO_LOCAL': 'bg-yellow-500',\n    'CONCLUIDA': 'bg-green-500',\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-950\">\n      {/* Sync Banner */}\n      <div className=\"sticky top-0 z-20 bg-green-600 dark:bg-green-700 text-white p-3 shadow-md\">\n        <div className=\"flex items-center justify-between\">\n          <span className=\"text-sm font-medium\">📡 GPS ativo</span>\n          <button \n            onClick={syncNow}\n            disabled={syncing}\n            className=\"bg-white/20 hover:bg-white/30 px-3 py-1 rounded-md text-xs font-medium transition-colors disabled:opacity-50\"\n            data-testid=\"button-sync-now\"\n          >\n            {syncing ? \"Sincronizando...\" : \"Sincronizar\"}\n          </button>\n        </div>\n      </div>\n\n      {/* Agenda Fixa */}\n      <div className=\"sticky top-14 z-10 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 shadow-sm\">\n        <div className=\"p-3\">\n          <h2 className=\"text-sm font-bold text-gray-900 dark:text-white mb-2\">📅 Próximas Visitas</h2>\n          \n          {agendaVisits.length === 0 ? (\n            <p className=\"text-xs text-gray-500 dark:text-gray-400 py-2\">Nenhuma visita agendada nos próximos 7 dias</p>\n          ) : (\n            <div className=\"space-y-2\">\n              {agendaVisits.map((visit, index) => {\n                const isNext = index === 0 && (visit.status === 'PLANEJADA' || visit.status === 'EM_DESLOCAMENTO');\n                return (\n                <div \n                  key={visit.id}\n                  className={`flex items-center gap-2 p-2 rounded-lg border ${\n                    isNext \n                      ? 'border-green-600 dark:border-green-500 bg-green-50 dark:bg-green-950/30 shadow-sm' \n                      : 'border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800'\n                  }`}\n                  data-testid={`agenda-visit-${visit.id}`}\n                >\n                  {/* Order Number */}\n                  <div className={`flex-shrink-0 w-6 h-6 rounded-full ${\n                    isNext ? 'bg-green-600 dark:bg-green-600 ring-2 ring-green-300' : 'bg-green-600 dark:bg-green-700'\n                  } text-white flex items-center justify-center text-xs font-bold`}>\n                    {visit.order}\n                  </div>\n                  \n                  {/* Status Indicator */}\n                  <div className={`flex-shrink-0 w-2 h-2 rounded-full ${statusColors[visit.status as keyof typeof statusColors] || 'bg-gray-400'}`} />\n                  \n                  {/* Visit Info */}\n                  <div className=\"flex-1 min-w-0\">\n                    <p className=\"text-sm font-semibold text-gray-900 dark:text-white truncate\">\n                      {visit.clientName}\n                    </p>\n                    <div className=\"flex items-center gap-2 text-xs text-gray-600 dark:text-gray-400\">\n                      <span>{visit.scheduledTime}</span>\n                      {visit.farmName && (\n                        <>\n                          <span>•</span>\n                          <span className=\"truncate\">{visit.farmName}</span>\n                        </>\n                      )}\n                    </div>\n                  </div>\n                  \n                  {/* Action Button */}\n                  {visit.status === 'PLANEJADA' && (\n                    <>\n                      {visit.farmName ? (\n                        <Button \n                          size=\"sm\" \n                          variant=\"ghost\"\n                          onClick={() => startVisit(visit.id)}\n                          className=\"flex-shrink-0\"\n                          data-testid={`button-start-${visit.id}`}\n                        >\n                          <Play className=\"h-4 w-4\" />\n                        </Button>\n                      ) : (\n                        <span className=\"text-xs text-red-600 dark:text-red-400 flex-shrink-0\">Sem local</span>\n                      )}\n                    </>\n                  )}\n                  {visit.status === 'EM_DESLOCAMENTO' && (\n                    <span className=\"text-xs text-orange-600 dark:text-orange-400 flex-shrink-0\">Em rota</span>\n                  )}\n                  {visit.status === 'NO_LOCAL' && (\n                    <span className=\"text-xs text-yellow-600 dark:text-yellow-400 flex-shrink-0\">No local</span>\n                  )}\n                  {visit.status === 'CONCLUIDA' && (\n                    <span className=\"text-xs text-green-600 dark:text-green-400 flex-shrink-0\">✓</span>\n                  )}\n                </div>\n              );\n              })}\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Feed de Histórico */}\n      <div className=\"max-w-2xl mx-auto\">\n        <div className=\"p-3 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900\">\n          <h3 className=\"text-sm font-bold text-gray-900 dark:text-white\">📸 Histórico de Atendimentos</h3>\n        </div>\n        \n        {feedItems.length === 0 ? (\n          <div className=\"p-8 text-center text-gray-500 dark:text-gray-400 bg-white dark:bg-gray-900\">\n            <Camera className=\"h-16 w-16 mx-auto mb-4 opacity-50\" />\n            <p>Nenhum atendimento concluído</p>\n            <p className=\"text-sm mt-2\">Seus atendimentos finalizados aparecerão aqui</p>\n          </div>\n        ) : (\n          feedItems.map((item) => (\n            <div \n              key={item.id} \n              className=\"bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-800 mb-0\"\n              data-testid={`feed-item-${item.id}`}\n            >\n              {/* Header */}\n              <div className=\"p-3 flex items-center gap-3\">\n                <img \n                  src={`https://api.dicebear.com/7.x/avataaars/svg?seed=${encodeURIComponent(item.userName)}`}\n                  alt={item.userName}\n                  className=\"w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700\"\n                />\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"font-semibold text-sm text-gray-900 dark:text-white truncate\">\n                    {item.clientName}\n                  </p>\n                  <div className=\"flex items-center gap-1 text-xs text-gray-500 dark:text-gray-400\">\n                    <MapPin className=\"h-3 w-3\" />\n                    <span className=\"truncate\">{item.farmName || 'Sem fazenda'}</span>\n                  </div>\n                </div>\n                <span className=\"text-xs text-gray-400 dark:text-gray-500\">\n                  {formatDistanceToNow(item.timestamp, { addSuffix: true, locale: ptBR })}\n                </span>\n              </div>\n\n              {/* Galeria de Fotos (Instagram style) */}\n              {item.photos && item.photos.length > 0 && (\n                <div className=\"w-full overflow-x-auto snap-x snap-mandatory scrollbar-hide\">\n                  <div className=\"flex\">\n                    {item.photos.map((photo, idx) => (\n                      <div key={idx} className=\"flex-shrink-0 w-full snap-center\">\n                        <div className=\"aspect-square bg-gray-100 dark:bg-gray-800\">\n                          <img \n                            src={photo.url} \n                            alt={photo.description || \"Foto do atendimento\"} \n                            className=\"w-full h-full object-cover\"\n                          />\n                        </div>\n                        {photo.description && (\n                          <div className=\"p-3 bg-gray-50 dark:bg-gray-800/50\">\n                            <p className=\"text-sm text-gray-700 dark:text-gray-300\">{photo.description}</p>\n                          </div>\n                        )}\n                      </div>\n                    ))}\n                  </div>\n                  {item.photos.length > 1 && (\n                    <div className=\"flex justify-center gap-1 p-2\">\n                      {item.photos.map((_, idx) => (\n                        <div key={idx} className=\"w-1.5 h-1.5 rounded-full bg-gray-300 dark:bg-gray-600\" />\n                      ))}\n                    </div>\n                  )}\n                </div>\n              )}\n\n              {/* Content */}\n              <div className=\"p-3\">\n                <p className=\"text-sm text-gray-900 dark:text-gray-100\">\n                  {item.description}\n                </p>\n                <div className=\"flex items-center gap-1 mt-1 text-xs text-gray-500 dark:text-gray-400\">\n                  <Clock className=\"h-3 w-3\" />\n                  {item.timestamp.toLocaleDateString('pt-BR')} às {item.timestamp.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}\n                </div>\n              </div>\n            </div>\n          ))\n        )}\n      </div>\n\n      {/* Diálogo de Quilometragem */}\n      <OdometerDialog\n        open={showOdometer}\n        title=\"Quilometragem Inicial\"\n        description=\"Digite a quilometragem do veículo para iniciar a rota\"\n        onConfirm={(odometer) => {\n          if (odometerCallbackRef.current) {\n            odometerCallbackRef.current(odometer);\n            odometerCallbackRef.current = null;\n          }\n          setShowOdometer(false);\n        }}\n        onCancel={() => {\n          setShowOdometer(false);\n          odometerCallbackRef.current = null;\n        }}\n      />\n    </div>\n  );\n}\n","size_bytes":15993},"public/sw.js":{"content":"const CACHE_NAME = \"agro-crm-v1\";\nconst urlsToCache = [\n  \"/\",\n  \"/crm/login\",\n  \"/crm/home\",\n  \"/crm/agenda\",\n  \"/crm/clientes\",\n  \"/crm/historico\",\n  \"/crm/settings\",\n];\n\nself.addEventListener(\"install\", (event) => {\n  event.waitUntil(\n    caches.open(CACHE_NAME).then((cache) => {\n      console.log(\"Cache aberto\");\n      return cache.addAll(urlsToCache);\n    })\n  );\n});\n\nself.addEventListener(\"fetch\", (event) => {\n  event.respondWith(\n    caches.match(event.request).then((response) => {\n      if (response) {\n        return response;\n      }\n      return fetch(event.request).then((response) => {\n        if (!response || response.status !== 200 || response.type !== \"basic\") {\n          return response;\n        }\n        const responseToCache = response.clone();\n        caches.open(CACHE_NAME).then((cache) => {\n          cache.put(event.request, responseToCache);\n        });\n        return response;\n      });\n    })\n  );\n});\n\nself.addEventListener(\"activate\", (event) => {\n  const cacheWhitelist = [CACHE_NAME];\n  event.waitUntil(\n    caches.keys().then((cacheNames) => {\n      return Promise.all(\n        cacheNames.map((cacheName) => {\n          if (cacheWhitelist.indexOf(cacheName) === -1) {\n            return caches.delete(cacheName);\n          }\n        })\n      );\n    })\n  );\n});\n","size_bytes":1302},"client/src/pages/crm/clientes.tsx":{"content":"import { useEffect, useMemo, useState } from \"react\";\nimport { db, ClientLocal, FarmLocal, FieldLocal } from \"@/lib/crm/idb\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { ArrowLeft, MapPin, Sprout } from \"lucide-react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Label } from \"@/components/ui/label\";\n\nexport default function CRMClientes() {\n  const [q, setQ] = useState(\"\");\n  const [clients, setClients] = useState<ClientLocal[]>([]);\n  const [selectedClient, setSelectedClient] = useState<ClientLocal | null>(null);\n  const [farms, setFarms] = useState<FarmLocal[]>([]);\n  const [fields, setFields] = useState<FieldLocal[]>([]);\n  const [selectedFarm, setSelectedFarm] = useState<FarmLocal | null>(null);\n\n  // Dialog states for new farm/field\n  const [newFarmOpen, setNewFarmOpen] = useState(false);\n  const [newFieldOpen, setNewFieldOpen] = useState(false);\n  const [farmForm, setFarmForm] = useState({ name: \"\", lat: \"\", lng: \"\", address: \"\" });\n  const [fieldForm, setFieldForm] = useState({ name: \"\", area: \"\", crop: \"\" });\n\n  async function load() {\n    try {\n      const res = await fetch(`/api/clients?q=${q}`, {\n        credentials: 'include'\n      });\n      const data = await res.json() as ClientLocal[];\n      setClients(data);\n      await db.clients.bulkPut(data);\n    } catch {\n      setClients(await db.clients.toArray());\n    }\n  }\n\n  async function loadFarms(clientId: string) {\n    try {\n      const res = await fetch(`/api/farms?client_id=${clientId}`, {\n        credentials: 'include'\n      });\n      const data = await res.json() as FarmLocal[];\n      setFarms(data);\n      await db.farms.bulkPut(data);\n    } catch {\n      const localFarms = await db.farms.where('client_id').equals(clientId).toArray();\n      setFarms(localFarms);\n    }\n  }\n\n  async function loadFields(farmId: string) {\n    try {\n      const res = await fetch(`/api/fields?farm_id=${farmId}`, {\n        credentials: 'include'\n      });\n      const data = await res.json() as FieldLocal[];\n      setFields(data);\n      await db.fields.bulkPut(data);\n    } catch {\n      const localFields = await db.fields.where('farm_id').equals(farmId).toArray();\n      setFields(localFields);\n    }\n  }\n\n  async function createFarm() {\n    if (!selectedClient || !farmForm.name) return;\n    \n    const farm: FarmLocal = {\n      id: `farm-${Date.now()}`,\n      name: farmForm.name,\n      client_id: selectedClient.id,\n      lat: farmForm.lat ? parseFloat(farmForm.lat) : null,\n      lng: farmForm.lng ? parseFloat(farmForm.lng) : null,\n      address: farmForm.address || null,\n    };\n\n    try {\n      await fetch('/api/farms', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify(farm)\n      });\n    } catch (err) {\n      console.error('Error creating farm:', err);\n    }\n\n    await db.farms.put(farm);\n    await loadFarms(selectedClient.id);\n    setNewFarmOpen(false);\n    setFarmForm({ name: \"\", lat: \"\", lng: \"\", address: \"\" });\n  }\n\n  async function createField() {\n    if (!selectedFarm || !fieldForm.name) return;\n    \n    const field: FieldLocal = {\n      id: `field-${Date.now()}`,\n      name: fieldForm.name,\n      farm_id: selectedFarm.id,\n      area: fieldForm.area ? parseFloat(fieldForm.area) : null,\n      crop: fieldForm.crop || null,\n    };\n\n    try {\n      await fetch('/api/fields', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify(field)\n      });\n    } catch (err) {\n      console.error('Error creating field:', err);\n    }\n\n    await db.fields.put(field);\n    if (selectedFarm) await loadFields(selectedFarm.id);\n    setNewFieldOpen(false);\n    setFieldForm({ name: \"\", area: \"\", crop: \"\" });\n  }\n\n  useEffect(() => { load(); }, []);\n\n  useEffect(() => {\n    if (selectedClient) {\n      loadFarms(selectedClient.id);\n    }\n  }, [selectedClient]);\n\n  useEffect(() => {\n    if (selectedFarm) {\n      loadFields(selectedFarm.id);\n    }\n  }, [selectedFarm]);\n\n  const list = useMemo(() => {\n    const s = q.trim().toLowerCase();\n    if (!s) return clients;\n    return clients.filter(c => c.name.toLowerCase().includes(s));\n  }, [clients, q]);\n\n  // Show farm details if a farm is selected\n  if (selectedFarm) {\n    return (\n      <div className=\"p-4 space-y-4\">\n        <div className=\"flex items-center gap-2\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            onClick={() => setSelectedFarm(null)}\n            data-testid=\"button-back-to-farms\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          <div>\n            <h2 className=\"text-lg font-bold\">{selectedFarm.name}</h2>\n            <p className=\"text-sm text-muted-foreground\">{selectedClient?.name}</p>\n          </div>\n        </div>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between\">\n            <CardTitle className=\"text-base\">Talhões</CardTitle>\n            <Dialog open={newFieldOpen} onOpenChange={setNewFieldOpen}>\n              <DialogTrigger asChild>\n                <Button size=\"sm\" data-testid=\"button-add-field\">+ Talhão</Button>\n              </DialogTrigger>\n              <DialogContent>\n                <DialogHeader>\n                  <DialogTitle>Novo Talhão</DialogTitle>\n                </DialogHeader>\n                <div className=\"space-y-4\">\n                  <div>\n                    <Label>Nome</Label>\n                    <Input \n                      value={fieldForm.name}\n                      onChange={(e) => setFieldForm({...fieldForm, name: e.target.value})}\n                      placeholder=\"Ex: Talhão 1\"\n                      data-testid=\"input-field-name\"\n                    />\n                  </div>\n                  <div>\n                    <Label>Área (hectares)</Label>\n                    <Input \n                      type=\"number\"\n                      value={fieldForm.area}\n                      onChange={(e) => setFieldForm({...fieldForm, area: e.target.value})}\n                      placeholder=\"Ex: 10.5\"\n                      data-testid=\"input-field-area\"\n                    />\n                  </div>\n                  <div>\n                    <Label>Cultura</Label>\n                    <Input \n                      value={fieldForm.crop}\n                      onChange={(e) => setFieldForm({...fieldForm, crop: e.target.value})}\n                      placeholder=\"Ex: Soja\"\n                      data-testid=\"input-field-crop\"\n                    />\n                  </div>\n                  <Button onClick={createField} className=\"w-full\" data-testid=\"button-save-field\">\n                    Criar Talhão\n                  </Button>\n                </div>\n              </DialogContent>\n            </Dialog>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2\">\n              {fields.map(field => (\n                <div key={field.id} className=\"border rounded-lg p-3\" data-testid={`field-item-${field.id}`}>\n                  <div className=\"flex items-start justify-between\">\n                    <div>\n                      <div className=\"font-medium flex items-center gap-2\">\n                        <Sprout className=\"h-4 w-4 text-green-600\" />\n                        {field.name}\n                      </div>\n                      {field.area && (\n                        <div className=\"text-sm text-muted-foreground\">\n                          Área: {field.area} ha\n                        </div>\n                      )}\n                      {field.crop && (\n                        <Badge variant=\"outline\" className=\"mt-1\">\n                          {field.crop}\n                        </Badge>\n                      )}\n                    </div>\n                  </div>\n                </div>\n              ))}\n              {fields.length === 0 && (\n                <div className=\"text-center text-muted-foreground py-8\">\n                  Nenhum talhão cadastrado\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  // Show farms list if a client is selected\n  if (selectedClient) {\n    return (\n      <div className=\"p-4 space-y-4\">\n        <div className=\"flex items-center gap-2\">\n          <Button \n            variant=\"ghost\" \n            size=\"icon\"\n            onClick={() => setSelectedClient(null)}\n            data-testid=\"button-back-to-clients\"\n          >\n            <ArrowLeft className=\"h-5 w-5\" />\n          </Button>\n          <div>\n            <h2 className=\"text-lg font-bold\">{selectedClient.name}</h2>\n            <p className=\"text-sm text-muted-foreground\">Fazendas</p>\n          </div>\n        </div>\n\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between\">\n            <CardTitle className=\"text-base\">Fazendas</CardTitle>\n            <Dialog open={newFarmOpen} onOpenChange={setNewFarmOpen}>\n              <DialogTrigger asChild>\n                <Button size=\"sm\" data-testid=\"button-add-farm\">+ Fazenda</Button>\n              </DialogTrigger>\n              <DialogContent>\n                <DialogHeader>\n                  <DialogTitle>Nova Fazenda</DialogTitle>\n                </DialogHeader>\n                <div className=\"space-y-4\">\n                  <div>\n                    <Label>Nome</Label>\n                    <Input \n                      value={farmForm.name}\n                      onChange={(e) => setFarmForm({...farmForm, name: e.target.value})}\n                      placeholder=\"Ex: Fazenda Aurora\"\n                      data-testid=\"input-farm-name\"\n                    />\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-2\">\n                    <div>\n                      <Label>Latitude</Label>\n                      <Input \n                        value={farmForm.lat}\n                        onChange={(e) => setFarmForm({...farmForm, lat: e.target.value})}\n                        placeholder=\"-25.123\"\n                        data-testid=\"input-farm-lat\"\n                      />\n                    </div>\n                    <div>\n                      <Label>Longitude</Label>\n                      <Input \n                        value={farmForm.lng}\n                        onChange={(e) => setFarmForm({...farmForm, lng: e.target.value})}\n                        placeholder=\"-54.456\"\n                        data-testid=\"input-farm-lng\"\n                      />\n                    </div>\n                  </div>\n                  <div>\n                    <Label>Endereço</Label>\n                    <Input \n                      value={farmForm.address}\n                      onChange={(e) => setFarmForm({...farmForm, address: e.target.value})}\n                      placeholder=\"Ex: Alto Paraná, Paraguai\"\n                      data-testid=\"input-farm-address\"\n                    />\n                  </div>\n                  <Button onClick={createFarm} className=\"w-full\" data-testid=\"button-save-farm\">\n                    Criar Fazenda\n                  </Button>\n                </div>\n              </DialogContent>\n            </Dialog>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2\">\n              {farms.map(farm => (\n                <div \n                  key={farm.id} \n                  className=\"border rounded-lg p-3 cursor-pointer hover:bg-accent transition-colors\"\n                  onClick={() => setSelectedFarm(farm)}\n                  data-testid={`farm-item-${farm.id}`}\n                >\n                  <div className=\"font-medium flex items-center gap-2\">\n                    <MapPin className=\"h-4 w-4 text-green-600\" />\n                    {farm.name}\n                  </div>\n                  {farm.address && (\n                    <div className=\"text-sm text-muted-foreground mt-1\">\n                      {farm.address}\n                    </div>\n                  )}\n                  {(farm.lat && farm.lng) && (\n                    <div className=\"text-xs text-muted-foreground mt-1\">\n                      📍 {farm.lat.toFixed(4)}, {farm.lng.toFixed(4)}\n                    </div>\n                  )}\n                </div>\n              ))}\n              {farms.length === 0 && (\n                <div className=\"text-center text-muted-foreground py-8\">\n                  Nenhuma fazenda cadastrada\n                </div>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  // Show clients list\n  return (\n    <div className=\"p-4 space-y-4\">\n      <Card>\n        <CardHeader>\n          <CardTitle>Clientes</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <Input\n            value={q}\n            onChange={(e) => setQ(e.target.value)}\n            placeholder=\"Buscar cliente...\"\n            data-testid=\"input-search-client\"\n          />\n          <div className=\"space-y-2\">\n            {list.map(c => (\n              <div \n                key={c.id} \n                className=\"border rounded-lg p-3 cursor-pointer hover:bg-accent transition-colors\"\n                onClick={() => setSelectedClient(c)}\n                data-testid={`client-item-${c.id}`}\n              >\n                <div className=\"font-semibold\">{c.name}</div>\n                <div className=\"text-sm text-muted-foreground\">\n                  {c.cluster && `Cluster: ${c.cluster}`}\n                  {c.cluster && c.priority && \" • \"}\n                  {c.priority && `Prioridade: ${c.priority}`}\n                </div>\n                <Badge variant={c.isActive ? \"default\" : \"secondary\"} className=\"mt-2\">\n                  {c.isActive ? \"Ativo\" : \"Inativo\"}\n                </Badge>\n              </div>\n            ))}\n            {list.length === 0 && (\n              <div className=\"text-center text-muted-foreground py-8\">\n                Nenhum cliente encontrado\n              </div>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":14387},"client/src/components/crm/layout.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { Home, Calendar, Users, MapPin, Settings } from \"lucide-react\";\n\nexport default function CRMLayout({ children }: { children: React.ReactNode }) {\n  const [location] = useLocation();\n\n  const navItems = [\n    { path: \"/crm/home\", icon: Home, label: \"Início\" },\n    { path: \"/crm/agenda\", icon: Calendar, label: \"Agenda\" },\n    { path: \"/crm/clientes\", icon: Users, label: \"Clientes\" },\n    { path: \"/crm/farms\", icon: MapPin, label: \"Fazendas\" },\n    { path: \"/crm/settings\", icon: Settings, label: \"Config\" },\n  ];\n\n  return (\n    <div className=\"min-h-screen flex flex-col bg-background\">\n      <header className=\"bg-green-600 dark:bg-green-700 text-white p-4 shadow-md\">\n        <h1 className=\"text-xl font-bold\">CRM Agro</h1>\n      </header>\n\n      <main className=\"flex-1 overflow-y-auto pb-16\">\n        {children}\n      </main>\n\n      <nav className=\"fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-800 flex justify-around items-center h-16 shadow-lg\">\n        {navItems.map((item) => {\n          const Icon = item.icon;\n          const isActive = location === item.path;\n          \n          return (\n            <Link key={item.path} href={item.path} className={`flex flex-col items-center justify-center w-16 h-16 ${\n              isActive \n                ? \"text-green-600 dark:text-green-400\" \n                : \"text-gray-600 dark:text-gray-400\"\n            }`}>\n              <Icon className=\"h-6 w-6\" />\n              <span className=\"text-xs mt-1\">{item.label}</span>\n            </Link>\n          );\n        })}\n      </nav>\n    </div>\n  );\n}\n","size_bytes":1662},"crm-agro-mobile/src/api/client.ts":{"content":"import axios from \"axios\";\n\nexport const API_BASE = \"http://10.0.2.2:5000\";\n\nexport const api = axios.create({\n  baseURL: API_BASE,\n  withCredentials: true,\n  headers: {\n    \"Content-Type\": \"application/json\",\n  },\n});\n\nexport function attachAuthInterceptors(onUnauthorized: () => void) {\n  api.interceptors.response.use(\n    (res) => res,\n    (err) => {\n      if (err?.response?.status === 401) {\n        onUnauthorized();\n      }\n      return Promise.reject(err);\n    }\n  );\n}\n","size_bytes":479},"client/src/hooks/useSync.ts":{"content":"import { useCallback, useEffect, useState } from \"react\";\nimport { db, OutboxItem, VisitLocal } from \"@/lib/crm/idb\";\n\nexport function useSync() {\n  const [syncing, setSyncing] = useState(false);\n  const [lastSync, setLastSync] = useState<number | null>(null);\n\n  const pull = useCallback(async () => {\n    try {\n      const last = (await getLastUpdatedSince()) || \"2024-01-01T00:00:00Z\";\n      const res = await fetch(`/api/visits?updated_since=${last}`, {\n        credentials: 'include'\n      });\n      \n      if (!res.ok) {\n        console.log('Pull failed:', res.status);\n        return;\n      }\n      \n      const data = await res.json() as VisitLocal[];\n      \n      if (!Array.isArray(data)) {\n        console.log('Pull data is not an array:', data);\n        return;\n      }\n      \n      await db.transaction('rw', db.visits, async () => {\n        for (const v of data) await db.visits.put(v);\n      });\n    } catch (err) {\n      console.error('Pull error:', err);\n    }\n  }, []);\n\n  const push = useCallback(async () => {\n    const items = await db.outbox.orderBy(\"created_at\").toArray();\n    for (const it of items) {\n      try {\n        if (it.type === \"TRIP_START\") {\n          await fetch(\"/api/trips/start\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            credentials: \"include\",\n            body: JSON.stringify(it.payload)\n          });\n        } else if (it.type === \"TRIP_END\") {\n          const visitId = it.payload.visit_id;\n          if (visitId) {\n            await fetch(`/api/trips/${visitId}/end`, {\n              method: \"POST\",\n              headers: { \"Content-Type\": \"application/json\" },\n              credentials: \"include\",\n              body: JSON.stringify({ odometer: it.payload.odometer })\n            });\n          }\n        } else if (it.type === \"GPS_BATCH\") {\n          await fetch(\"/api/trips/gps\", {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            credentials: \"include\",\n            body: JSON.stringify(it.payload)\n          });\n        } else if (it.type === \"CHECKLIST\") {\n          await fetch(`/api/checklists/${it.payload.visitId}`, {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            credentials: \"include\",\n            body: JSON.stringify(it.payload.data)\n          });\n        } else if (it.type === \"VISIT_CREATE\") {\n          await fetch(`/api/visits`, {\n            method: \"POST\",\n            headers: { \"Content-Type\": \"application/json\" },\n            credentials: \"include\",\n            body: JSON.stringify(it.payload)\n          });\n        } else if (it.type === \"VISIT_UPDATE\") {\n          await fetch(`/api/visits/${it.payload.id}`, {\n            method: \"PATCH\",\n            headers: { \"Content-Type\": \"application/json\" },\n            credentials: \"include\",\n            body: JSON.stringify(it.payload)\n          });\n        }\n        await db.outbox.delete(it.id!);\n      } catch {\n        await db.outbox.update(it.id!, { attempts: (it.attempts||0)+1 });\n        break;\n      }\n    }\n  }, []);\n\n  const syncNow = useCallback(async () => {\n    try {\n      setSyncing(true);\n      await push();\n      await pull();\n      setLastSync(Date.now());\n      await setLastUpdatedSince(new Date().toISOString());\n    } finally {\n      setSyncing(false);\n    }\n  }, [pull, push]);\n\n  useEffect(() => {\n    syncNow();\n    const online = () => syncNow();\n    window.addEventListener('online', online);\n    return () => window.removeEventListener('online', online);\n  }, [syncNow]);\n\n  return { syncing, lastSync, syncNow };\n}\n\nasync function setLastUpdatedSince(iso: string) {\n  await db.settings.put({ key: \"lastUpdatedSince\", value: iso });\n}\n\nasync function getLastUpdatedSince() {\n  const s = await db.settings.get(\"lastUpdatedSince\");\n  return s?.value as string | undefined;\n}\n\nexport async function enqueue(type: OutboxItem[\"type\"], payload: any) {\n  await db.outbox.add({ type, payload, created_at: Date.now(), attempts: 0 });\n}\n","size_bytes":4051},"crm-agro-mobile/src/App.tsx":{"content":"import React, { useEffect } from \"react\";\nimport { View, ActivityIndicator } from \"react-native\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { initDb } from \"@db/schema\";\nimport { registerBaseGeofence } from \"@geo/tripDetector\";\nimport { AuthProvider, useAuth } from \"@auth/AuthContext\";\nimport { queryClient } from \"@lib/queryClient\";\nimport LoginScreen from \"@auth/LoginScreen\";\nimport AppNavigator from \"@features/navigation/AppNavigator\";\n\nfunction Main() {\n  const { user, loading } = useAuth();\n\n  useEffect(() => {\n    initDb();\n    if (user) {\n      registerBaseGeofence(-25.3000, -57.6000, 200).catch(err => {\n        console.log('Geofence registration skipped:', err.message);\n      });\n    }\n  }, [user]);\n\n  if (loading) {\n    return (\n      <View style={{ flex: 1, alignItems: \"center\", justifyContent: \"center\" }}>\n        <ActivityIndicator size=\"large\" color=\"#22c55e\" />\n      </View>\n    );\n  }\n\n  if (!user) {\n    return <LoginScreen />;\n  }\n\n  return <AppNavigator />;\n}\n\nexport default function App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <AuthProvider>\n        <Main />\n      </AuthProvider>\n    </QueryClientProvider>\n  );\n}\n","size_bytes":1201},"crm-agro-mobile/src/features/visits/ActiveVisit.tsx":{"content":"import React, { useEffect, useState } from \"react\";\nimport { View, Text, FlatList, TouchableOpacity, StyleSheet, Button } from \"react-native\";\nimport { db } from \"@db/schema\";\nimport { setState, getState } from \"@db/state\";\nimport { updateVisitStatus } from \"@db/operations\";\nimport { manualTripStart, stopTracking } from \"@geo/tripDetector\";\n\nexport default function ActiveVisit() {\n  const [visits, setVisits] = useState<any[]>([]);\n  const [activeId, setActiveId] = useState<string | null>(getState(\"active_visit_id\"));\n\n  useEffect(() => {\n    loadVisits();\n  }, []);\n\n  function loadVisits() {\n    const v = db.getAllSync(\n      \"SELECT id, client_id, window_start, status FROM visits ORDER BY window_start\"\n    );\n    setVisits((v as any[]) || []);\n  }\n\n  function choose(id: string) {\n    setActiveId(id);\n    setState(\"active_visit_id\", id);\n  }\n\n  async function startTrip() {\n    if (!activeId) return;\n    try {\n      await manualTripStart(activeId);\n      updateVisitStatus(activeId, \"EM_DESLOCAMENTO\");\n      loadVisits();\n    } catch (error) {\n      console.error('Start trip error:', error);\n    }\n  }\n\n  async function arrivedAtLocation() {\n    if (!activeId) return;\n    await stopTracking();\n    updateVisitStatus(activeId, \"NO_LOCAL\");\n    loadVisits();\n  }\n\n  return (\n    <View style={styles.container}>\n      <Text style={styles.title}>Rota do dia — selecione a visita ativa</Text>\n      <FlatList\n        data={visits}\n        keyExtractor={(i: any) => i.id}\n        renderItem={({ item }) => (\n          <TouchableOpacity\n            onPress={() => choose(item.id)}\n            style={[\n              styles.visitCard,\n              activeId === item.id && styles.activeCard\n            ]}\n          >\n            <Text style={styles.clientText}>{item.client_id} • {item.status}</Text>\n            <Text style={styles.timeText}>\n              {item.window_start ? new Date(item.window_start).toLocaleTimeString() : \"sem janela\"}\n            </Text>\n            {activeId === item.id && (\n              <Text style={styles.activeText}>✓ VISITA ATIVA</Text>\n            )}\n          </TouchableOpacity>\n        )}\n      />\n      \n      {activeId && (\n        <View style={styles.actions}>\n          <Button title=\"Iniciar Viagem\" onPress={startTrip} color=\"#1e90ff\" />\n          <Button title=\"Cheguei no Local\" onPress={arrivedAtLocation} color=\"#22c55e\" />\n        </View>\n      )}\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    padding: 16,\n  },\n  title: {\n    fontWeight: \"bold\",\n    marginBottom: 12,\n    fontSize: 16,\n  },\n  visitCard: {\n    padding: 12,\n    borderWidth: 1,\n    borderColor: \"#ddd\",\n    marginBottom: 8,\n    borderRadius: 8,\n  },\n  activeCard: {\n    borderColor: \"#22c55e\",\n    backgroundColor: \"#f0fdf4\",\n  },\n  clientText: {\n    fontSize: 14,\n    fontWeight: \"500\",\n  },\n  timeText: {\n    fontSize: 12,\n    color: \"#666\",\n    marginTop: 4,\n  },\n  activeText: {\n    color: \"#22c55e\",\n    fontWeight: \"bold\",\n    marginTop: 4,\n  },\n  actions: {\n    marginTop: 16,\n    gap: 8,\n    flexDirection: \"row\",\n    justifyContent: \"space-between\",\n  },\n});\n","size_bytes":3126},"shared/schema.crm.ts":{"content":"import {\n  pgTable, uuid, varchar, text, timestamp, jsonb, integer, numeric, boolean,\n  bigint, pgEnum, customType\n} from \"drizzle-orm/pg-core\";\nimport { sql } from \"drizzle-orm\";\n\n// ENUM de status de visita\nexport const visitStatusEnum = pgEnum(\"visit_status\", [\n  \"PLANEJADA\", \"PRONTA\", \"EM_DESLOCAMENTO\", \"NO_LOCAL\", \"CONCLUIDA\"\n]);\n\n// Custom type for PostGIS geometry\nconst geometryPoint = customType<{ data: string }>({\n  dataType() {\n    return 'geometry(Point,4326)';\n  },\n});\n\nconst geometryPolygon = customType<{ data: string }>({\n  dataType() {\n    return 'geometry(Polygon,4326)';\n  },\n});\n\n// --- FARMS (fazendas) ---\nexport const farms = pgTable(\"farms\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  clientId: varchar(\"client_id\").notNull(),\n  name: text(\"name\"),\n  centroid: geometryPoint(\"centroid\")\n});\n\n// --- FIELDS (talhões) ---\nexport const fields = pgTable(\"fields\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  farmId: varchar(\"farm_id\").notNull().references(() => farms.id),\n  name: text(\"name\"),\n  crop: text(\"crop\"),\n  season: text(\"season\"),\n  geom: geometryPolygon(\"geom\"),\n  areaHa: numeric(\"area_ha\"),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true }).defaultNow(),\n  updatedBy: varchar(\"updated_by\")\n});\n\n// --- VISITS ---\nexport const visits = pgTable(\"visits\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  clientId: varchar(\"client_id\").notNull(),\n  farmId: varchar(\"farm_id\").references(() => farms.id),\n  fieldId: varchar(\"field_id\").references(() => fields.id),\n  scheduledAt: timestamp(\"scheduled_at\", { withTimezone: true }),\n  windowStart: timestamp(\"window_start\", { withTimezone: true }),\n  windowEnd: timestamp(\"window_end\", { withTimezone: true }),\n  status: visitStatusEnum(\"status\").notNull().default(\"PLANEJADA\"),\n  assignee: varchar(\"assignee\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true }).defaultNow()\n});\n\n// --- TRIPS (viagens) ---\nexport const trips = pgTable(\"trips\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  visitId: varchar(\"visit_id\").references(() => visits.id),\n  startedAt: timestamp(\"started_at\", { withTimezone: true }),\n  endedAt: timestamp(\"ended_at\", { withTimezone: true }),\n  startOdometer: integer(\"start_odometer\"),\n  endOdometer: integer(\"end_odometer\"),\n  distanceKm: numeric(\"distance_km\"),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true }).defaultNow()\n});\n\n// --- TELEMETRY ---\nexport const telemetryGps = pgTable(\"telemetry_gps\", {\n  id: bigint(\"id\", { mode: \"number\" }).primaryKey().generatedAlwaysAsIdentity(),\n  tripId: varchar(\"trip_id\").references(() => trips.id),\n  ts: timestamp(\"ts\", { withTimezone: true }),\n  lat: numeric(\"lat\"),\n  lng: numeric(\"lng\"),\n  speedKmh: numeric(\"speed_kmh\"),\n  accuracyM: numeric(\"accuracy_m\")\n});\n\n// --- CHECKLISTS ---\nexport const checklists = pgTable(\"checklists\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  visitId: varchar(\"visit_id\").references(() => visits.id),\n  template: text(\"template\"),\n  answers: jsonb(\"answers\"),\n  photos: jsonb(\"photos\"),\n  signatures: jsonb(\"signatures\"),\n  finished: boolean(\"finished\").default(false),\n  finishedAt: timestamp(\"finished_at\", { withTimezone: true }),\n  createdAt: timestamp(\"created_at\", { withTimezone: true }).defaultNow(),\n  updatedAt: timestamp(\"updated_at\", { withTimezone: true }).defaultNow()\n});\n\n// --- AUTOMATIONS (mínimo viável p/ futuro) ---\nexport const automations = pgTable(\"automations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  title: text(\"title\"),\n  active: boolean(\"active\").default(true),\n  schedule: text(\"schedule\"),\n  config: jsonb(\"config\")\n});\n\n// --- AUDIT LOGS ---\nexport const auditLogs = pgTable(\"audit_logs\", {\n  id: bigint(\"id\", { mode: \"number\" }).primaryKey().generatedAlwaysAsIdentity(),\n  at: timestamp(\"at\", { withTimezone: true }).defaultNow(),\n  actor: varchar(\"actor\"),\n  action: text(\"action\"),\n  entity: text(\"entity\"),\n  entityId: text(\"entity_id\"),\n  payload: jsonb(\"payload\")\n});\n","size_bytes":4265},"client/src/pages/crm/login.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useLocation } from \"wouter\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { MapPin } from \"lucide-react\";\nimport { registerServiceWorker, requestNotificationPermission } from \"@/utils/sw-register\";\n\nexport default function CRMLogin() {\n  const [, setLocation] = useLocation();\n  const [username, setUsername] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState(\"\");\n\n  useEffect(() => {\n    registerServiceWorker();\n    requestNotificationPermission();\n  }, []);\n\n  const handleLogin = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setError(\"\");\n    setLoading(true);\n\n    try {\n      const res = await fetch(\"/api/login\", {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        credentials: \"include\",\n        body: JSON.stringify({ username, password })\n      });\n\n      if (res.ok) {\n        setLocation(\"/crm/home\");\n      } else {\n        setError(\"Usuário ou senha incorretos\");\n      }\n    } catch {\n      setError(\"Erro ao conectar ao servidor\");\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-green-500 to-green-700 dark:from-green-600 dark:to-green-800 flex items-center justify-center p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"text-center\">\n          <div className=\"flex justify-center mb-4\">\n            <div className=\"bg-green-100 dark:bg-green-900 p-3 rounded-full\">\n              <MapPin className=\"h-12 w-12 text-green-600 dark:text-green-400\" />\n            </div>\n          </div>\n          <CardTitle className=\"text-2xl\">CRM Agro Móvel</CardTitle>\n          <CardDescription>Gestão de visitas e rastreamento GPS</CardDescription>\n        </CardHeader>\n        <CardContent>\n          <form onSubmit={handleLogin} className=\"space-y-4\">\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Usuário</label>\n              <Input\n                type=\"text\"\n                value={username}\n                onChange={(e) => setUsername(e.target.value)}\n                placeholder=\"Digite seu usuário\"\n                required\n              />\n            </div>\n            <div className=\"space-y-2\">\n              <label className=\"text-sm font-medium\">Senha</label>\n              <Input\n                type=\"password\"\n                value={password}\n                onChange={(e) => setPassword(e.target.value)}\n                placeholder=\"Digite sua senha\"\n                required\n              />\n            </div>\n            {error && (\n              <div className=\"text-sm text-red-600 dark:text-red-400\">\n                {error}\n              </div>\n            )}\n            <Button type=\"submit\" className=\"w-full\" disabled={loading}>\n              {loading ? \"Entrando...\" : \"Entrar\"}\n            </Button>\n          </form>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":3229},"client/src/components/crm/visit-list.tsx":{"content":"import { useMemo } from \"react\";\n\nexport type Visit = {\n  id: string;\n  client_id: string;\n  status: \"PLANEJADA\"|\"PRONTA\"|\"EM_DESLOCAMENTO\"|\"NO_LOCAL\"|\"CONCLUIDA\";\n  window_start?: string | null;\n  notes?: string | null;\n};\n\ntype Client = {\n  id: string;\n  name: string;\n};\n\nexport default function VisitList({ \n  visits, \n  clients = [], \n  onEdit \n}: { \n  visits: Visit[]; \n  clients?: Client[];\n  onEdit?: (visit: Visit) => void;\n}) {\n  const clientNames = useMemo(() => {\n    const names: Record<string, string> = {};\n    clients.forEach(c => {\n      names[c.id] = c.name;\n    });\n    return names;\n  }, [clients]);\n\n  return (\n    <div>\n      {visits.map(v => (\n        <div \n          key={v.id} \n          onClick={() => onEdit?.(v)}\n          style={{ \n            padding: 10, \n            borderBottom: \"1px solid #eee\", \n            marginBottom: 8, \n            background: \"#fff\", \n            borderRadius: 6,\n            cursor: onEdit ? \"pointer\" : \"default\"\n          }}\n          className=\"hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors\"\n        >\n          <div style={{ fontWeight: 600 }}>{clientNames[v.client_id] || v.client_id}</div>\n          <div style={{ fontSize: 14, color: \"#666\", marginTop: 4 }}>\n            {v.window_start ? new Date(v.window_start).toLocaleString('pt-BR') : 'Sem horário'}\n          </div>\n          <div style={{ fontSize: 12, marginTop: 4, color: v.status === \"CONCLUIDA\" ? \"#1db954\" : \"#666\" }}>\n            {v.status}\n          </div>\n          {v.notes && <div style={{ fontSize: 12, color: \"#999\", marginTop: 4 }}>{v.notes}</div>}\n        </div>\n      ))}\n    </div>\n  );\n}\n","size_bytes":1643},"client/src/components/crm/photo-upload.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Camera, Upload, X } from \"lucide-react\";\n\ntype PhotoData = {\n  id: string;\n  dataUrl: string;\n  caption?: string;\n  timestamp: string;\n};\n\nexport default function PhotoUpload({\n  visitId,\n  onSave,\n}: {\n  visitId: string;\n  onSave?: (photos: PhotoData[]) => void;\n}) {\n  const [photos, setPhotos] = useState<PhotoData[]>([]);\n  const [capturing, setCapturing] = useState(false);\n\n  async function handleCapture(e: React.ChangeEvent<HTMLInputElement>) {\n    const files = e.target.files;\n    if (!files) return;\n\n    const newPhotos: PhotoData[] = [];\n    for (let i = 0; i < files.length; i++) {\n      const file = files[i];\n      const reader = new FileReader();\n      \n      reader.onload = (event) => {\n        const photoData: PhotoData = {\n          id: crypto.randomUUID(),\n          dataUrl: event.target?.result as string,\n          timestamp: new Date().toISOString(),\n        };\n        newPhotos.push(photoData);\n        \n        if (newPhotos.length === files.length) {\n          setPhotos((prev) => [...prev, ...newPhotos]);\n          if (onSave) onSave([...photos, ...newPhotos]);\n        }\n      };\n      \n      reader.readAsDataURL(file);\n    }\n  }\n\n  function handleRemove(id: string) {\n    const updated = photos.filter((p) => p.id !== id);\n    setPhotos(updated);\n    if (onSave) onSave(updated);\n  }\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex gap-2\">\n        <label className=\"flex-1\">\n          <input\n            type=\"file\"\n            accept=\"image/*\"\n            capture=\"environment\"\n            onChange={handleCapture}\n            className=\"hidden\"\n          />\n          <Button type=\"button\" className=\"w-full\" variant=\"outline\">\n            <Camera className=\"w-4 h-4 mr-2\" />\n            Tirar Foto\n          </Button>\n        </label>\n\n        <label className=\"flex-1\">\n          <input\n            type=\"file\"\n            accept=\"image/*\"\n            multiple\n            onChange={handleCapture}\n            className=\"hidden\"\n          />\n          <Button type=\"button\" className=\"w-full\" variant=\"outline\">\n            <Upload className=\"w-4 h-4 mr-2\" />\n            Galeria\n          </Button>\n        </label>\n      </div>\n\n      {photos.length > 0 && (\n        <div className=\"grid grid-cols-2 gap-2\">\n          {photos.map((photo) => (\n            <Card key={photo.id} className=\"relative\">\n              <CardContent className=\"p-2\">\n                <img\n                  src={photo.dataUrl}\n                  alt=\"Foto da visita\"\n                  className=\"w-full h-32 object-cover rounded\"\n                />\n                <button\n                  onClick={() => handleRemove(photo.id)}\n                  className=\"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1\"\n                >\n                  <X className=\"w-3 h-3\" />\n                </button>\n                <p className=\"text-xs text-gray-500 mt-1\">\n                  {new Date(photo.timestamp).toLocaleTimeString()}\n                </p>\n              </CardContent>\n            </Card>\n          ))}\n        </div>\n      )}\n    </div>\n  );\n}\n","size_bytes":3250},"crm-agro-mobile/src/db/state.ts":{"content":"import { db } from \"./schema\";\n\nexport function setState(key: string, value: string) {\n  db.runSync(\"INSERT OR REPLACE INTO app_state(key,value) VALUES (?,?)\", [key, value]);\n}\n\nexport function getState(key: string): string | null {\n  const row = db.getFirstSync(\"SELECT value FROM app_state WHERE key=?\", [key]) as any;\n  return row?.value ?? null;\n}\n\nexport function deleteState(key: string) {\n  db.runSync(\"DELETE FROM app_state WHERE key=?\", [key]);\n}\n","size_bytes":456},"crm-agro-mobile/src/geo/tripDetector.ts":{"content":"import * as Location from \"expo-location\";\nimport * as TaskManager from \"expo-task-manager\";\nimport { db } from \"@db/schema\";\nimport { getState, setState } from \"@db/state\";\n\nconst GEOFENCE_TASK = \"GEOFENCE_BASE\";\nconst TRACK_TASK = \"TRACK_TRIP\";\n\nlet currentTripId: string | null = null;\n\nexport async function registerBaseGeofence(lat: number, lng: number, radius = 200) {\n  try {\n    const { status } = await Location.requestBackgroundPermissionsAsync();\n    if (status !== 'granted') {\n      console.warn('Background location permission denied');\n      return;\n    }\n    \n    await Location.startGeofencingAsync(GEOFENCE_TASK, [{\n      latitude: lat,\n      longitude: lng,\n      radius,\n      identifier: \"base\"\n    }]);\n    \n    setState(\"base_lat\", String(lat));\n    setState(\"base_lng\", String(lng));\n  } catch (error) {\n    console.error('Geofence setup error:', error);\n  }\n}\n\nTaskManager.defineTask(GEOFENCE_TASK, async ({ data, error }) => {\n  if (error || !data) return;\n  \n  const { eventType, region } = (data as any);\n  \n  if (eventType === Location.GeofencingEventType.Exit) {\n    const activeVisitId = getState(\"active_visit_id\");\n    if (!activeVisitId) return;\n    \n    try {\n      const location = await Location.getCurrentPositionAsync({\n        accuracy: Location.Accuracy.High\n      });\n      \n      const speedKmh = (location.coords.speed ?? 0) * 3.6;\n      \n      if (speedKmh > 15) {\n        const tripId = `trip-${Date.now()}`;\n        currentTripId = tripId;\n        setState(\"current_trip_id\", tripId);\n        \n        db.runSync(\n          \"INSERT INTO outbox (op_id, type, payload, created_at) VALUES (?, ?, ?, ?)\",\n          [\n            `trip_start_${tripId}`,\n            \"TRIP_START\",\n            JSON.stringify({\n              trip_id: tripId,\n              visit_id: activeVisitId,\n              gps: {\n                lat: location.coords.latitude,\n                lng: location.coords.longitude,\n                speed_kmh: speedKmh,\n                accuracy_m: location.coords.accuracy\n              },\n              odometer: null,\n              started_at: new Date().toISOString()\n            }),\n            new Date().toISOString()\n          ]\n        );\n        \n        await startTracking();\n      }\n    } catch (err) {\n      console.error('Exit handler error:', err);\n    }\n  }\n});\n\nexport async function startTracking() {\n  try {\n    await Location.startLocationUpdatesAsync(TRACK_TASK, {\n      accuracy: Location.Accuracy.High,\n      timeInterval: 7000,\n      distanceInterval: 10,\n      showsBackgroundLocationIndicator: true,\n      pausesUpdatesAutomatically: true,\n      foregroundService: {\n        notificationTitle: \"CRM Agro\",\n        notificationBody: \"Rastreando viagem\",\n      }\n    });\n  } catch (error) {\n    console.error('Tracking error:', error);\n  }\n}\n\nexport async function stopTracking() {\n  try {\n    await Location.stopLocationUpdatesAsync(TRACK_TASK);\n    \n    const tripId = getState(\"current_trip_id\");\n    if (tripId) {\n      const remaining = db.getAllSync(\n        \"SELECT * FROM telemetry_buffer WHERE trip_id = ? ORDER BY ts\",\n        [tripId]\n      );\n      \n      if (remaining && Array.isArray(remaining) && remaining.length > 0) {\n        const normalizedPoints = remaining.map((row: any) => ({\n          lat: row.lat,\n          lng: row.lng,\n          speed_kmh: row.speed_kmh,\n          accuracy_m: row.accuracy_m,\n          timestamp: row.ts\n        }));\n        \n        const batchId = `gps_batch_${tripId}_final`;\n        db.runSync(\n          \"INSERT INTO outbox (op_id, type, payload, created_at) VALUES (?, ?, ?, ?)\",\n          [\n            batchId,\n            \"GPS_BATCH\",\n            JSON.stringify({\n              trip_id: tripId,\n              points: normalizedPoints\n            }),\n            new Date().toISOString()\n          ]\n        );\n        \n        db.runSync(\"DELETE FROM telemetry_buffer WHERE trip_id = ?\", [tripId]);\n      }\n      \n      db.runSync(\n        \"INSERT INTO outbox (op_id, type, payload, created_at) VALUES (?, ?, ?, ?)\",\n        [\n          `trip_end_${tripId}`,\n          \"TRIP_END\",\n          JSON.stringify({\n            trip_id: tripId,\n            ended_at: new Date().toISOString(),\n            odometer: null\n          }),\n          new Date().toISOString()\n        ]\n      );\n      \n      setState(\"current_trip_id\", \"\");\n      currentTripId = null;\n    }\n  } catch (error) {\n    console.error('Stop tracking error:', error);\n  }\n}\n\nTaskManager.defineTask(TRACK_TASK, ({ data, error }) => {\n  if (error || !data) {\n    console.error('Tracking task error:', error);\n    return;\n  }\n  \n  const { locations } = (data as any);\n  const tripId = getState(\"current_trip_id\");\n  \n  if (!tripId || !locations || locations.length === 0) return;\n  \n  try {\n    for (const loc of locations) {\n      const gpsPoint = {\n        trip_id: tripId,\n        lat: loc.coords.latitude,\n        lng: loc.coords.longitude,\n        speed_kmh: (loc.coords.speed ?? 0) * 3.6,\n        accuracy_m: loc.coords.accuracy,\n        ts: new Date(loc.timestamp).toISOString()\n      };\n      \n      db.runSync(\n        \"INSERT INTO telemetry_buffer (trip_id, lat, lng, speed_kmh, accuracy_m, ts) VALUES (?, ?, ?, ?, ?, ?)\",\n        [\n          gpsPoint.trip_id,\n          gpsPoint.lat,\n          gpsPoint.lng,\n          gpsPoint.speed_kmh,\n          gpsPoint.accuracy_m,\n          gpsPoint.ts\n        ]\n      );\n    }\n    \n    const buffered = db.getAllSync(\n      \"SELECT * FROM telemetry_buffer WHERE trip_id = ? ORDER BY ts\",\n      [tripId]\n    );\n    \n    if (buffered && Array.isArray(buffered) && buffered.length >= 10) {\n      const normalizedPoints = buffered.map((row: any) => ({\n        lat: row.lat,\n        lng: row.lng,\n        speed_kmh: row.speed_kmh,\n        accuracy_m: row.accuracy_m,\n        timestamp: row.ts\n      }));\n      \n      const batchId = `gps_batch_${tripId}_${Date.now()}`;\n      db.runSync(\n        \"INSERT INTO outbox (op_id, type, payload, created_at) VALUES (?, ?, ?, ?)\",\n        [\n          batchId,\n          \"GPS_BATCH\",\n          JSON.stringify({\n            trip_id: tripId,\n            points: normalizedPoints\n          }),\n          new Date().toISOString()\n        ]\n      );\n      \n      db.runSync(\"DELETE FROM telemetry_buffer WHERE trip_id = ?\", [tripId]);\n    }\n  } catch (err) {\n    console.error('GPS buffer error:', err);\n  }\n});\n\nexport async function manualTripStart(visitId: string) {\n  try {\n    const location = await Location.getCurrentPositionAsync({\n      accuracy: Location.Accuracy.High\n    });\n    \n    const tripId = `trip-${Date.now()}`;\n    currentTripId = tripId;\n    setState(\"current_trip_id\", tripId);\n    \n    db.runSync(\n      \"INSERT INTO outbox (op_id, type, payload, created_at) VALUES (?, ?, ?, ?)\",\n      [\n        `trip_start_${tripId}`,\n        \"TRIP_START\",\n        JSON.stringify({\n          trip_id: tripId,\n          visit_id: visitId,\n          gps: {\n            lat: location.coords.latitude,\n            lng: location.coords.longitude,\n            speed_kmh: (location.coords.speed ?? 0) * 3.6,\n            accuracy_m: location.coords.accuracy\n          },\n          odometer: null,\n          started_at: new Date().toISOString()\n        }),\n        new Date().toISOString()\n      ]\n    );\n    \n    await startTracking();\n    return tripId;\n  } catch (error) {\n    console.error('Manual trip start error:', error);\n    throw error;\n  }\n}\n","size_bytes":7429},"crm-agro-mobile/src/lib/queryClient.ts":{"content":"import { QueryClient } from \"@tanstack/react-query\";\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      retry: 1,\n      staleTime: 1000 * 60 * 5, // 5 minutos\n    },\n  },\n});\n","size_bytes":211},"crm-agro-mobile/src/features/screens/HistoryScreen.tsx":{"content":"import React, { useMemo } from \"react\";\nimport { View, Text, FlatList, RefreshControl } from \"react-native\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { api } from \"@api/client\";\n\ntype Visit = { \n  id: string; \n  client_id: string; \n  status: string; \n  window_start?: string | null; \n  notes?: string | null \n};\n\nexport default function HistoryScreen() {\n  const { data, refetch, isFetching } = useQuery({\n    queryKey: [\"visits\", \"history\"],\n    queryFn: async () => {\n      const { data } = await api.get<Visit[]>(\"/api/visits\");\n      return data;\n    }\n  });\n\n  const concluded = useMemo(\n    () => (data || []).filter(v => v.status === \"CONCLUIDA\").sort((a,b) =>\n      (new Date(b.window_start || 0).getTime() - new Date(a.window_start || 0).getTime())\n    ),\n    [data]\n  );\n\n  return (\n    <FlatList\n      data={concluded}\n      keyExtractor={(i) => i.id}\n      refreshControl={<RefreshControl refreshing={isFetching} onRefresh={refetch} />}\n      renderItem={({ item }) => (\n        <View style={{ padding: 12, borderBottomWidth: 1, borderColor: \"#eee\" }}>\n          <Text style={{ fontWeight: \"600\" }}>{item.client_id}</Text>\n          <Text style={{ color: \"#666\" }}>\n            {item.window_start ? new Date(item.window_start).toLocaleString() : \"—\"}\n          </Text>\n          {item.notes ? <Text style={{ color: \"#555\" }}>{item.notes}</Text> : null}\n        </View>\n      )}\n      ListEmptyComponent={\n        <View style={{ padding: 16 }}>\n          <Text>Nenhuma visita concluída ainda.</Text>\n        </View>\n      }\n    />\n  );\n}\n","size_bytes":1568},"crm-agro-mobile/src/sync/sync.ts":{"content":"import { db } from \"@db/schema\";\nimport { api } from \"@api/client\";\nimport { setState, getState } from \"@db/state\";\n\nexport async function syncNow() {\n  try {\n    // PULL: Delta-sync usando updated_since persistente\n    const lastSync = getState(\"last_sync\") || \"2024-01-01T00:00:00Z\";\n    const { data: serverVisits } = await api.get(\"/api/visits\", { \n      params: { updated_since: lastSync } \n    });\n    \n    db.withTransactionSync(() => {\n      for (const v of serverVisits || []) {\n        db.execSync(\n          `INSERT OR REPLACE INTO visits(\n            id, client_id, farm_id, field_id, scheduled_at, window_start, window_end, \n            status, assignee, notes, created_at, updated_at\n          ) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)`,\n          [\n            v.id, v.clientId, v.farmId, v.fieldId, v.scheduledAt,\n            v.windowStart, v.windowEnd, v.status, v.assignee, v.notes,\n            v.createdAt, v.updatedAt\n          ]\n        );\n      }\n    });\n    \n    // Atualizar timestamp de última sincronização\n    setState(\"last_sync\", new Date().toISOString());\n\n    // PUSH: Outbox pattern - enviar operações pendentes\n    const pending = db.getAllSync(\n      \"SELECT op_id, type, payload, attempts FROM outbox ORDER BY created_at ASC\"\n    );\n    \n    for (const op of (pending as any[]) || []) {\n      try {\n        const payload = JSON.parse(op.payload);\n        \n        if (op.type === \"TRIP_START\") {\n          await api.post(\"/api/trips/start\", payload);\n        } else if (op.type === \"GPS_BATCH\") {\n          await api.post(\"/api/trips/gps\", payload);\n        } else if (op.type === \"TRIP_END\") {\n          await api.post(`/api/trips/${payload.trip_id}/end`, { \n            odometer: payload.odometer \n          });\n        } else if (op.type === \"VISIT_STATUS\") {\n          await api.patch(`/api/visits/${payload.visit_id}/status`, { \n            status: payload.status \n          });\n        } else if (op.type === \"CHECKLIST_SAVE\") {\n          await api.post(`/api/checklists/${payload.visit_id}`, payload.data);\n        } else if (op.type === \"VISIT_CREATE\") {\n          await api.post(\"/api/visits\", payload);\n        }\n        \n        // Sucesso: remover da outbox\n        db.runSync(\"DELETE FROM outbox WHERE op_id=?\", [op.op_id]);\n      } catch (err) {\n        // Falha: incrementar tentativas e aplicar backoff\n        db.runSync(\"UPDATE outbox SET attempts = attempts + 1 WHERE op_id=?\", [op.op_id]);\n        \n        // Se falhou 5 vezes, parar e reportar erro\n        if (op.attempts >= 4) {\n          console.error(\"Max retries reached for op:\", op.op_id);\n          break;\n        }\n        break; // Backoff natural\n      }\n    }\n    \n    return { success: true, synced: serverVisits?.length || 0 };\n  } catch (error) {\n    console.error(\"Sync error:\", error);\n    return { success: false, error };\n  }\n}\n\nexport function enqueue(op_type: string, payload: any) {\n  const op_id = `${op_type}_${Date.now()}_${Math.random().toString(36).slice(2)}`;\n  db.runSync(\n    \"INSERT OR REPLACE INTO outbox(op_id, type, payload, created_at) VALUES (?,?,?,datetime('now'))\",\n    [op_id, op_type, JSON.stringify(payload)]\n  );\n  return op_id;\n}\n","size_bytes":3178},"client/src/components/OdometerDialog.tsx":{"content":"import { useState } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Gauge } from \"lucide-react\";\n\ntype OdometerDialogProps = {\n  open: boolean;\n  onConfirm: (odometer: number) => void;\n  onCancel?: () => void;\n  title?: string;\n  description?: string;\n};\n\nexport function OdometerDialog({ \n  open, \n  onConfirm, \n  onCancel,\n  title = \"Quilometragem do Veículo\",\n  description = \"Digite a quilometragem atual do veículo para iniciar a viagem\"\n}: OdometerDialogProps) {\n  const [odometer, setOdometer] = useState(\"\");\n\n  const handleConfirm = () => {\n    const value = parseFloat(odometer);\n    if (!isNaN(value) && value > 0) {\n      onConfirm(value);\n      setOdometer(\"\");\n    }\n  };\n\n  return (\n    <Dialog open={open} onOpenChange={(isOpen) => {\n      if (!isOpen && onCancel) onCancel();\n    }}>\n      <DialogContent className=\"sm:max-w-md\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center gap-2\">\n            <Gauge className=\"w-5 h-5\" />\n            {title}\n          </DialogTitle>\n          <DialogDescription>\n            {description}\n          </DialogDescription>\n        </DialogHeader>\n        \n        <div className=\"space-y-4\">\n          <div>\n            <Input\n              type=\"number\"\n              placeholder=\"Ex: 15234\"\n              value={odometer}\n              onChange={(e) => setOdometer(e.target.value)}\n              onKeyDown={(e) => {\n                if (e.key === 'Enter') handleConfirm();\n              }}\n              autoFocus\n              data-testid=\"input-odometer\"\n            />\n            <p className=\"text-sm text-gray-500 dark:text-gray-400 mt-1\">\n              Quilometragem em km\n            </p>\n          </div>\n\n          <div className=\"flex gap-2\">\n            {onCancel && (\n              <Button \n                variant=\"outline\" \n                onClick={onCancel} \n                className=\"flex-1\"\n                data-testid=\"button-cancel-odometer\"\n              >\n                Cancelar\n              </Button>\n            )}\n            <Button \n              onClick={handleConfirm}\n              disabled={!odometer || parseFloat(odometer) <= 0}\n              className=\"flex-1\"\n              data-testid=\"button-confirm-odometer\"\n            >\n              Confirmar\n            </Button>\n          </div>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":2552},"crm-agro-mobile/src/features/screens/ClientsScreen.tsx":{"content":"import React, { useMemo, useState } from \"react\";\nimport { View, Text, TextInput, FlatList, RefreshControl } from \"react-native\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { api } from \"@api/client\";\n\ntype Client = { \n  id: string; \n  name: string; \n  cluster?: string | null; \n  priority?: string | null; \n  active: boolean \n};\n\nexport default function ClientsScreen() {\n  const [q, setQ] = useState(\"\");\n\n  const { data, refetch, isFetching } = useQuery({\n    queryKey: [\"clients\", \"list\"],\n    queryFn: async () => {\n      const { data } = await api.get<Client[]>(\"/api/clients\");\n      return data;\n    }\n  });\n\n  const list = useMemo(() => {\n    if (!data) return [];\n    const s = q.trim().toLowerCase();\n    if (!s) return data;\n    return data.filter(c => c.name.toLowerCase().includes(s));\n  }, [data, q]);\n\n  return (\n    <View style={{ flex: 1 }}>\n      <View style={{ padding: 16 }}>\n        <Text style={{ fontWeight: \"bold\", fontSize: 16 }}>Clientes</Text>\n        <TextInput\n          value={q}\n          onChangeText={setQ}\n          placeholder=\"Buscar cliente...\"\n          style={{ \n            borderWidth: 1, \n            borderColor: \"#ddd\", \n            borderRadius: 8, \n            padding: 10, \n            marginTop: 8 \n          }}\n        />\n      </View>\n      <FlatList\n        data={list}\n        keyExtractor={(i) => i.id}\n        refreshControl={<RefreshControl refreshing={isFetching} onRefresh={refetch} />}\n        renderItem={({ item }) => (\n          <View style={{ padding: 12, borderBottomWidth: 1, borderColor: \"#eee\" }}>\n            <Text style={{ fontWeight: \"600\" }}>{item.name}</Text>\n            <Text style={{ color: \"#666\" }}>\n              {item.cluster ? `Cluster: ${item.cluster}  • ` : \"\"}{item.priority ? `Prioridade: ${item.priority}` : \"\"}\n            </Text>\n            <Text style={{ color: item.active ? \"#22c55e\" : \"#c00\" }}>\n              {item.active ? \"Ativo\" : \"Inativo\"}\n            </Text>\n          </View>\n        )}\n      />\n    </View>\n  );\n}\n","size_bytes":2031},"client/src/pages/crm/farms.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { db } from \"@/lib/crm/idb\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Plus, MapPin, Trash2 } from \"lucide-react\";\n\ntype Farm = {\n  id: string;\n  name: string;\n  client_id?: string;\n  lat?: number;\n  lng?: number;\n  address?: string;\n  notes?: string;\n};\n\ntype Field = {\n  id: string;\n  name: string;\n  farm_id: string;\n  area?: number;\n  crop?: string;\n  notes?: string;\n};\n\ntype Client = {\n  id: string;\n  name: string;\n};\n\nexport default function CRMFarms() {\n  const [farms, setFarms] = useState<Farm[]>([]);\n  const [fields, setFields] = useState<Field[]>([]);\n  const [clients, setClients] = useState<Client[]>([]);\n  const [selectedFarm, setSelectedFarm] = useState<string | null>(null);\n  const [showAddFarm, setShowAddFarm] = useState(false);\n  const [showAddField, setShowAddField] = useState(false);\n\n  const [farmForm, setFarmForm] = useState({ client_id: \"\", name: \"\", lat: \"\", lng: \"\", address: \"\", notes: \"\" });\n  const [fieldForm, setFieldForm] = useState({ name: \"\", area: \"\", crop: \"\", notes: \"\" });\n\n  useEffect(() => {\n    loadFarms();\n    loadClients();\n  }, []);\n\n  async function loadClients() {\n    // Buscar do servidor e sincronizar com IndexedDB\n    try {\n      const response = await fetch('/api/clients', {\n        credentials: 'include'\n      });\n      \n      if (response.ok) {\n        const serverClients = await response.json();\n        \n        // Sincronizar com IndexedDB\n        await db.clients.clear();\n        for (const client of serverClients) {\n          await db.clients.put(client);\n        }\n        \n        setClients(serverClients);\n      } else {\n        // Se falhar, carrega do IndexedDB local\n        const data = await db.clients.toArray();\n        setClients(data as any);\n      }\n    } catch (err) {\n      console.error('Erro ao carregar clientes:', err);\n      // Se falhar, carrega do IndexedDB local\n      const data = await db.clients.toArray();\n      setClients(data as any);\n    }\n  }\n\n  useEffect(() => {\n    if (selectedFarm) {\n      loadFields(selectedFarm);\n    }\n  }, [selectedFarm]);\n\n  async function loadFarms() {\n    // Buscar do servidor e sincronizar com IndexedDB\n    try {\n      const response = await fetch('/api/farms', {\n        credentials: 'include'\n      });\n      \n      if (response.ok) {\n        const serverFarms = await response.json();\n        \n        // Sincronizar com IndexedDB\n        await db.farms.clear();\n        for (const farm of serverFarms) {\n          await db.farms.put({\n            id: farm.id,\n            client_id: farm.clientId,\n            name: farm.name,\n            lat: farm.lat ? parseFloat(farm.lat) : undefined,\n            lng: farm.lng ? parseFloat(farm.lng) : undefined,\n            address: farm.address,\n            notes: farm.notes,\n          });\n        }\n        \n        setFarms(serverFarms.map((f: any) => ({\n          id: f.id,\n          client_id: f.clientId,\n          name: f.name,\n          lat: f.lat ? parseFloat(f.lat) : undefined,\n          lng: f.lng ? parseFloat(f.lng) : undefined,\n          address: f.address,\n          notes: f.notes,\n        })));\n      } else {\n        // Se falhar, carrega do IndexedDB local\n        const data = await db.farms.toArray();\n        setFarms(data as any);\n      }\n    } catch (err) {\n      console.error('Erro ao carregar fazendas:', err);\n      // Se falhar, carrega do IndexedDB local\n      const data = await db.farms.toArray();\n      setFarms(data as any);\n    }\n  }\n\n  async function loadFields(farmId: string) {\n    const data = await db.fields.where(\"farm_id\").equals(farmId).toArray();\n    setFields(data as any);\n  }\n\n  async function handleAddFarm() {\n    if (!farmForm.client_id) {\n      alert('Selecione um cliente');\n      return;\n    }\n    \n    if (!farmForm.name) {\n      alert('Nome da fazenda é obrigatório');\n      return;\n    }\n    \n    if (!farmForm.lat || !farmForm.lng) {\n      alert('Coordenadas (Latitude e Longitude) são obrigatórias para o geofencing funcionar!');\n      return;\n    }\n\n    const newFarm = {\n      id: crypto.randomUUID(),\n      client_id: farmForm.client_id,\n      name: farmForm.name,\n      lat: parseFloat(farmForm.lat),\n      lng: parseFloat(farmForm.lng),\n      address: farmForm.address,\n      notes: farmForm.notes,\n    };\n    \n    // Salvar localmente\n    await db.farms.add(newFarm as any);\n    \n    // Sincronizar com servidor\n    try {\n      const payload = {\n        name: newFarm.name,\n        clientId: newFarm.client_id,\n        lat: String(farmForm.lat),\n        lng: String(farmForm.lng),\n        address: farmForm.address || null,\n        notes: farmForm.notes || null\n      };\n      \n      console.log('📤 Enviando fazenda para servidor:', payload);\n      \n      const response = await fetch('/api/farms', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify(payload)\n      });\n      \n      if (!response.ok) {\n        const error = await response.text();\n        console.error('❌ Erro do servidor:', error);\n        throw new Error(error);\n      }\n      \n      console.log('✅ Fazenda sincronizada com sucesso');\n    } catch (err) {\n      console.error('❌ Erro ao sincronizar fazenda:', err);\n      alert('Fazenda salva localmente, mas erro ao sincronizar com servidor');\n    }\n    \n    setFarmForm({ client_id: \"\", name: \"\", lat: \"\", lng: \"\", address: \"\", notes: \"\" });\n    setShowAddFarm(false);\n    loadFarms();\n  }\n\n  async function handleDeleteFarm(farmId: string) {\n    if (!confirm('Tem certeza que deseja excluir esta fazenda?')) return;\n    \n    await db.farms.delete(farmId);\n    \n    try {\n      await fetch(`/api/farms/${farmId}`, {\n        method: 'DELETE',\n        credentials: 'include',\n      });\n    } catch (err) {\n      console.error('Erro ao deletar fazenda do servidor:', err);\n    }\n    \n    loadFarms();\n    if (selectedFarm === farmId) {\n      setSelectedFarm(null);\n    }\n  }\n\n  async function handleAddField() {\n    if (!selectedFarm) return;\n    const newField = {\n      id: crypto.randomUUID(),\n      name: fieldForm.name,\n      farm_id: selectedFarm,\n      area: fieldForm.area ? parseFloat(fieldForm.area) : undefined,\n      crop: fieldForm.crop,\n      notes: fieldForm.notes,\n    };\n    await db.fields.add(newField as any);\n    setFieldForm({ name: \"\", area: \"\", crop: \"\", notes: \"\" });\n    setShowAddField(false);\n    loadFields(selectedFarm);\n  }\n\n  return (\n    <div className=\"p-4 space-y-4\">\n      <Card>\n        <CardHeader>\n          <div className=\"flex justify-between items-center\">\n            <CardTitle>🏡 Fazendas</CardTitle>\n            <Button onClick={() => setShowAddFarm(!showAddFarm)} size=\"sm\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Nova Fazenda\n            </Button>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {showAddFarm && (\n            <div className=\"mb-4 p-4 border rounded space-y-3\">\n              <Select value={farmForm.client_id} onValueChange={(val) => setFarmForm({ ...farmForm, client_id: val })}>\n                <SelectTrigger>\n                  <SelectValue placeholder=\"Selecione o cliente\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {clients.map(c => (\n                    <SelectItem key={c.id} value={c.id}>{c.name}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              \n              <Input\n                placeholder=\"Nome da fazenda\"\n                value={farmForm.name}\n                onChange={(e) => setFarmForm({ ...farmForm, name: e.target.value })}\n              />\n              <div className=\"grid grid-cols-2 gap-2\">\n                <Input\n                  placeholder=\"Latitude\"\n                  type=\"number\"\n                  step=\"0.000001\"\n                  value={farmForm.lat}\n                  onChange={(e) => setFarmForm({ ...farmForm, lat: e.target.value })}\n                />\n                <Input\n                  placeholder=\"Longitude\"\n                  type=\"number\"\n                  step=\"0.000001\"\n                  value={farmForm.lng}\n                  onChange={(e) => setFarmForm({ ...farmForm, lng: e.target.value })}\n                />\n              </div>\n              <Input\n                placeholder=\"Endereço\"\n                value={farmForm.address}\n                onChange={(e) => setFarmForm({ ...farmForm, address: e.target.value })}\n              />\n              <Input\n                placeholder=\"Observações\"\n                value={farmForm.notes}\n                onChange={(e) => setFarmForm({ ...farmForm, notes: e.target.value })}\n              />\n              <Button onClick={handleAddFarm} className=\"w-full\">Salvar Fazenda</Button>\n            </div>\n          )}\n\n          <div className=\"space-y-2\">\n            {farms.map((farm) => {\n              const client = clients.find(c => c.id === farm.client_id);\n              return (\n              <div\n                key={farm.id}\n                className={`p-3 border rounded ${\n                  selectedFarm === farm.id ? \"border-green-600 bg-green-50 dark:bg-green-950\" : \"\"\n                }`}\n              >\n                <div className=\"flex justify-between items-start\">\n                  <div className=\"flex-1 cursor-pointer\" onClick={() => setSelectedFarm(farm.id)}>\n                    <h4 className=\"font-semibold text-gray-900 dark:text-white\">{farm.name}</h4>\n                    {client && <p className=\"text-sm text-gray-600 dark:text-gray-400\">Cliente: {client.name}</p>}\n                    {farm.address && <p className=\"text-sm text-gray-600 dark:text-gray-400\">{farm.address}</p>}\n                    {farm.lat && farm.lng && (\n                      <p className=\"text-xs text-gray-500 dark:text-gray-500 mt-1 flex items-center gap-1\">\n                        <MapPin className=\"w-3 h-3\" />\n                        {farm.lat}, {farm.lng}\n                      </p>\n                    )}\n                  </div>\n                  <Button \n                    size=\"sm\" \n                    variant=\"ghost\" \n                    onClick={(e) => {\n                      e.stopPropagation();\n                      handleDeleteFarm(farm.id);\n                    }}\n                    className=\"text-red-600 hover:text-red-700 hover:bg-red-50\"\n                  >\n                    <Trash2 className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n              </div>\n              );\n            })}\n          </div>\n        </CardContent>\n      </Card>\n\n      {selectedFarm && (\n        <Card>\n          <CardHeader>\n            <div className=\"flex justify-between items-center\">\n              <CardTitle>🌾 Talhões</CardTitle>\n              <Button onClick={() => setShowAddField(!showAddField)} size=\"sm\">\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Novo Talhão\n              </Button>\n            </div>\n          </CardHeader>\n          <CardContent>\n            {showAddField && (\n              <div className=\"mb-4 p-4 border rounded space-y-3\">\n                <Input\n                  placeholder=\"Nome do talhão\"\n                  value={fieldForm.name}\n                  onChange={(e) => setFieldForm({ ...fieldForm, name: e.target.value })}\n                />\n                <Input\n                  placeholder=\"Área (hectares)\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  value={fieldForm.area}\n                  onChange={(e) => setFieldForm({ ...fieldForm, area: e.target.value })}\n                />\n                <Input\n                  placeholder=\"Cultura\"\n                  value={fieldForm.crop}\n                  onChange={(e) => setFieldForm({ ...fieldForm, crop: e.target.value })}\n                />\n                <Input\n                  placeholder=\"Observações\"\n                  value={fieldForm.notes}\n                  onChange={(e) => setFieldForm({ ...fieldForm, notes: e.target.value })}\n                />\n                <Button onClick={handleAddField} className=\"w-full\">Salvar Talhão</Button>\n              </div>\n            )}\n\n            <div className=\"space-y-2\">\n              {fields.map((field) => (\n                <div key={field.id} className=\"p-3 border rounded\">\n                  <h5 className=\"font-medium\">{field.name}</h5>\n                  <div className=\"text-sm text-gray-600 mt-1\">\n                    {field.area && <span>{field.area} ha</span>}\n                    {field.crop && <span> • {field.crop}</span>}\n                  </div>\n                  {field.notes && <p className=\"text-sm mt-1\">{field.notes}</p>}\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","size_bytes":13119},"client/src/pages/kanban-metas.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Progress } from \"@/components/ui/progress\";\nimport MarketManagementPanel from \"@/components/MarketManagementPanel\";\nimport Header from \"@/components/layout/header\";\nimport Navbar from \"@/components/layout/navbar\";\nimport { TrendingUp, DollarSign, Layers } from \"lucide-react\";\n\ninterface Client {\n  id: string;\n  name: string;\n}\n\ninterface Season {\n  id: string;\n  name: string;\n}\n\ninterface CategoryCard {\n  categoryId: string;\n  categoryName: string;\n  categoryType: string;\n  potentialUsd: number;\n  potentialHa: number;\n  cvaleUsd: number;\n  fechadoUsd: number;\n  totalCapturedUsd: number;\n  penetrationPercent: number;\n}\n\nexport default function KanbanMetasPage() {\n  const [viewSeasonId, setViewSeasonId] = useState<string>(\"\");\n  const [showMarketPanel, setShowMarketPanel] = useState(false);\n  const [selectedMarketClient, setSelectedMarketClient] = useState<{\n    clientId: string;\n    clientName: string;\n  } | null>(null);\n\n  const { data: seasons } = useQuery<Season[]>({\n    queryKey: [\"/api/seasons\"]\n  });\n\n  const { data: clients } = useQuery<Client[]>({\n    queryKey: [\"/api/clients\", { top8020: \"true\" }],\n    queryFn: async () => {\n      const res = await fetch(\"/api/clients?top8020=true\", { credentials: \"include\" });\n      if (!res.ok) throw new Error(\"Failed to fetch clients\");\n      return res.json();\n    }\n  });\n\n  const { data: categoryCardsData, isLoading: isLoadingCards } = useQuery<{ cards: CategoryCard[] }>({\n    queryKey: [\"/api/market-opportunity/category-cards\", viewSeasonId],\n    queryFn: async () => {\n      const res = await fetch(`/api/market-opportunity/category-cards/${viewSeasonId}`, { \n        credentials: \"include\" \n      });\n      if (!res.ok) throw new Error(\"Failed to fetch category cards\");\n      return res.json();\n    },\n    enabled: !!viewSeasonId\n  });\n\n  const handleNextClient = () => {\n    if (!clients || !selectedMarketClient) return;\n    \n    const currentIndex = clients.findIndex(c => c.id === selectedMarketClient.clientId);\n    if (currentIndex === -1 || currentIndex === clients.length - 1) return;\n    \n    const nextClient = clients[currentIndex + 1];\n    setSelectedMarketClient({\n      clientId: nextClient.id,\n      clientName: nextClient.name\n    });\n  };\n\n  const hasNextClient = () => {\n    if (!clients || !selectedMarketClient) return false;\n    const currentIndex = clients.findIndex(c => c.id === selectedMarketClient.clientId);\n    return currentIndex !== -1 && currentIndex < clients.length - 1;\n  };\n\n  return (\n    <div className=\"h-screen flex flex-col overflow-hidden\">\n      <Header \n        title=\"Oportunidades de Negócios\"\n        subtitle=\"Gestão de oportunidades de mercado\"\n        showNewSaleButton={false}\n      />\n      <Navbar />\n      \n      <main className=\"flex-1 overflow-y-auto\">\n        <div className=\"p-6 space-y-6\">\n          <div className=\"max-w-7xl mx-auto space-y-6\">\n            <h1 className=\"text-2xl font-bold\">Oportunidades de Negócios</h1>\n            \n            {/* Seletor de Safra */}\n            <div className=\"space-y-2 max-w-2xl\">\n              <Label>Safra</Label>\n              <Select value={viewSeasonId} onValueChange={setViewSeasonId}>\n                <SelectTrigger data-testid=\"select-season\">\n                  <SelectValue placeholder=\"Selecione uma safra\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {seasons?.map(season => (\n                    <SelectItem key={season.id} value={season.id}>\n                      {season.name}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n\n            {/* Category Cards - Market Progress */}\n            {viewSeasonId && categoryCardsData && categoryCardsData.cards.length > 0 && (\n              <div className=\"space-y-4\">\n                <h2 className=\"text-xl font-semibold flex items-center gap-2\">\n                  <TrendingUp className=\"h-5 w-5 text-primary\" />\n                  Progresso de Mercado por Categoria\n                </h2>\n                \n                {isLoadingCards ? (\n                  <div className=\"text-sm text-muted-foreground\">Carregando...</div>\n                ) : (\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\n                    {categoryCardsData.cards.map((card) => (\n                      <Card key={card.categoryId} data-testid={`category-card-${card.categoryType}`}>\n                        <CardHeader className=\"pb-3\">\n                          <CardTitle className=\"text-lg\">{card.categoryName}</CardTitle>\n                        </CardHeader>\n                        <CardContent className=\"space-y-3\">\n                          {/* Potencial */}\n                          <div className=\"flex items-start gap-2\">\n                            <Layers className=\"h-4 w-4 text-muted-foreground mt-0.5\" />\n                            <div className=\"flex-1\">\n                              <div className=\"text-xs text-muted-foreground\">Potencial de Mercado</div>\n                              <div className=\"font-semibold\">\n                                ${card.potentialUsd.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                              </div>\n                              <div className=\"text-xs text-muted-foreground\">\n                                {card.potentialHa.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ha\n                              </div>\n                            </div>\n                          </div>\n                          \n                          {/* C.Vale */}\n                          <div className=\"flex items-start gap-2\">\n                            <DollarSign className=\"h-4 w-4 text-green-600 mt-0.5\" />\n                            <div className=\"flex-1\">\n                              <div className=\"text-xs text-muted-foreground\">Vendas C.Vale</div>\n                              <div className=\"font-semibold text-green-600\">\n                                ${card.cvaleUsd.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                              </div>\n                            </div>\n                          </div>\n                          \n                          {/* FECHADO */}\n                          <div className=\"flex items-start gap-2\">\n                            <DollarSign className=\"h-4 w-4 text-blue-600 mt-0.5\" />\n                            <div className=\"flex-1\">\n                              <div className=\"text-xs text-muted-foreground\">Aplicações Fechadas</div>\n                              <div className=\"font-semibold text-blue-600\">\n                                ${card.fechadoUsd.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                              </div>\n                            </div>\n                          </div>\n                          \n                          {/* Total Capturado */}\n                          <div className=\"pt-2 border-t\">\n                            <div className=\"text-xs text-muted-foreground mb-1\">Total Capturado</div>\n                            <div className=\"font-bold text-primary\">\n                              ${card.totalCapturedUsd.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}\n                            </div>\n                          </div>\n                          \n                          {/* Barra de Progresso */}\n                          <div className=\"space-y-1\">\n                            <div className=\"flex justify-between items-center text-xs\">\n                              <span className=\"text-muted-foreground\">Penetração de Mercado</span>\n                              <span className=\"font-semibold\">\n                                {card.penetrationPercent.toFixed(1)}%\n                              </span>\n                            </div>\n                            <Progress \n                              value={card.penetrationPercent} \n                              className=\"h-2\"\n                              data-testid={`progress-${card.categoryType}`}\n                            />\n                          </div>\n                        </CardContent>\n                      </Card>\n                    ))}\n                  </div>\n                )}\n              </div>\n            )}\n\n            {/* Seletor de Cliente (só aparece se safra selecionada) */}\n            {viewSeasonId && clients && clients.length > 0 && (\n              <div className=\"space-y-2 max-w-2xl\">\n                <Label>Cliente</Label>\n                <Select \n                  value={selectedMarketClient?.clientId || \"\"} \n                  onValueChange={(clientId) => {\n                    const client = clients.find(c => c.id === clientId);\n                    if (client) {\n                      setSelectedMarketClient({ \n                        clientId: client.id, \n                        clientName: client.name \n                      });\n                      setShowMarketPanel(true);\n                    }\n                  }}\n                >\n                  <SelectTrigger data-testid=\"select-client\">\n                    <SelectValue placeholder=\"Selecione um cliente\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {clients.map(client => (\n                      <SelectItem key={client.id} value={client.id}>\n                        {client.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            )}\n          </div>\n        </div>\n      </main>\n\n      {/* Market Management Panel Dialog */}\n      {selectedMarketClient && (\n        <MarketManagementPanel\n          clientId={selectedMarketClient.clientId}\n          clientName={selectedMarketClient.clientName}\n          seasonId={viewSeasonId}\n          isOpen={showMarketPanel}\n          onClose={() => {\n            setShowMarketPanel(false);\n            setSelectedMarketClient(null);\n          }}\n          onNextClient={handleNextClient}\n          hasNextClient={hasNextClient()}\n        />\n      )}\n    </div>\n  );\n}\n","size_bytes":10657},"crm-agro-mobile/src/DebugInfo.tsx":{"content":"import { useEffect, useState } from \"react\";\nimport { View, Text, Button } from \"react-native\";\nimport { API_BASE, api } from \"@api/client\";\n\nexport function DebugInfo() {\n  const [status, setStatus] = useState(\"Testando...\");\n\n  async function testConnection() {\n    try {\n      setStatus(\"Conectando...\");\n      const response = await api.get(\"/api/user\");\n      setStatus(`✅ Conectado! Status: ${response.status}`);\n    } catch (err: any) {\n      const errorMsg = err.message || \"Erro desconhecido\";\n      const code = err.code || \"N/A\";\n      const responseStatus = err.response?.status || \"N/A\";\n      setStatus(`❌ Erro: ${errorMsg} | Code: ${code} | HTTP: ${responseStatus}`);\n      console.error(\"Connection test failed:\", err);\n    }\n  }\n\n  useEffect(() => {\n    testConnection();\n  }, []);\n\n  return (\n    <View style={{ backgroundColor: '#fef3c7', padding: 8, marginBottom: 16 }}>\n      <Text style={{ fontSize: 10, color: '#92400e', fontWeight: 'bold' }}>\n        🔍 DEBUG v4.0 - {new Date().toLocaleTimeString()}\n      </Text>\n      <Text style={{ fontSize: 9, color: '#92400e' }}>\n        API: {API_BASE}\n      </Text>\n      <Text style={{ fontSize: 9, color: '#92400e', marginTop: 4 }}>\n        {status}\n      </Text>\n      <Button title=\"Testar Novamente\" onPress={testConnection} color=\"#92400e\" />\n    </View>\n  );\n}\n","size_bytes":1340},"crm-agro-mobile/src/db/schema.ts":{"content":"import * as SQLite from \"expo-sqlite\";\n\nexport const db = SQLite.openDatabaseSync(\"crm_agro.db\");\n\nexport function initDb() {\n  db.execSync(`\n    PRAGMA journal_mode = WAL;\n    \n    CREATE TABLE IF NOT EXISTS visits (\n      id TEXT PRIMARY KEY,\n      client_id TEXT,\n      farm_id TEXT,\n      field_id TEXT,\n      scheduled_at TEXT,\n      window_start TEXT,\n      window_end TEXT,\n      status TEXT,\n      assignee TEXT,\n      notes TEXT,\n      created_at TEXT,\n      updated_at TEXT\n    );\n    \n    CREATE TABLE IF NOT EXISTS trips (\n      id TEXT PRIMARY KEY,\n      visit_id TEXT,\n      started_at TEXT,\n      ended_at TEXT,\n      start_odometer INTEGER,\n      end_odometer INTEGER,\n      distance_km REAL,\n      created_at TEXT,\n      updated_at TEXT\n    );\n    \n    CREATE TABLE IF NOT EXISTS telemetry_buffer (\n      id INTEGER PRIMARY KEY AUTOINCREMENT,\n      trip_id TEXT,\n      ts TEXT,\n      lat REAL,\n      lng REAL,\n      speed_kmh REAL,\n      accuracy_m REAL\n    );\n    \n    CREATE TABLE IF NOT EXISTS outbox (\n      op_id TEXT PRIMARY KEY,\n      type TEXT,\n      payload TEXT,\n      attempts INTEGER DEFAULT 0,\n      created_at TEXT\n    );\n    \n    CREATE TABLE IF NOT EXISTS app_state (\n      key TEXT PRIMARY KEY,\n      value TEXT\n    );\n  `);\n}\n","size_bytes":1261},"client/src/pages/crm/checklists.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { db } from \"@/lib/crm/idb\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { CheckSquare, Plus, Save } from \"lucide-react\";\n\ntype ChecklistTemplate = {\n  id: string;\n  name: string;\n  items: ChecklistItem[];\n};\n\ntype ChecklistItem = {\n  id: string;\n  label: string;\n  type: \"boolean\" | \"text\" | \"number\" | \"photo\";\n  required?: boolean;\n};\n\ntype ChecklistData = {\n  id: string;\n  visit_id: string;\n  template_id: string;\n  template_name: string;\n  responses: Record<string, any>;\n  created_at: string;\n};\n\nconst DEFAULT_TEMPLATES: ChecklistTemplate[] = [\n  {\n    id: \"soil-analysis\",\n    name: \"Análise de Solo\",\n    items: [\n      { id: \"1\", label: \"Solo preparado?\", type: \"boolean\", required: true },\n      { id: \"2\", label: \"pH do solo\", type: \"number\", required: true },\n      { id: \"3\", label: \"Umidade adequada?\", type: \"boolean\", required: true },\n      { id: \"4\", label: \"Observações\", type: \"text\" },\n    ],\n  },\n  {\n    id: \"crop-health\",\n    name: \"Saúde da Lavoura\",\n    items: [\n      { id: \"1\", label: \"Pragas identificadas?\", type: \"boolean\", required: true },\n      { id: \"2\", label: \"Altura média das plantas (cm)\", type: \"number\" },\n      { id: \"3\", label: \"Aplicação de defensivos necessária?\", type: \"boolean\" },\n      { id: \"4\", label: \"Notas adicionais\", type: \"text\" },\n    ],\n  },\n  {\n    id: \"fertilizer-app\",\n    name: \"Aplicação de Fertilizantes\",\n    items: [\n      { id: \"1\", label: \"Produto aplicado\", type: \"text\", required: true },\n      { id: \"2\", label: \"Quantidade (kg/ha)\", type: \"number\", required: true },\n      { id: \"3\", label: \"Área coberta (ha)\", type: \"number\", required: true },\n      { id: \"4\", label: \"Condições climáticas adequadas?\", type: \"boolean\" },\n    ],\n  },\n];\n\nexport default function CRMChecklists() {\n  const [templates] = useState<ChecklistTemplate[]>(DEFAULT_TEMPLATES);\n  const [selectedTemplate, setSelectedTemplate] = useState<ChecklistTemplate | null>(null);\n  const [responses, setResponses] = useState<Record<string, any>>({});\n  const [visits, setVisits] = useState<any[]>([]);\n  const [selectedVisit, setSelectedVisit] = useState<string | null>(null);\n  const [saved, setSaved] = useState(false);\n\n  useEffect(() => {\n    loadVisits();\n  }, []);\n\n  async function loadVisits() {\n    const data = await db.visits.where(\"status\").equals(\"NO_LOCAL\").toArray();\n    setVisits(data);\n  }\n\n  function handleResponseChange(itemId: string, value: any) {\n    setResponses((prev) => ({ ...prev, [itemId]: value }));\n  }\n\n  async function handleSave() {\n    if (!selectedTemplate || !selectedVisit) return;\n\n    const checklistData: ChecklistData = {\n      id: crypto.randomUUID(),\n      visit_id: selectedVisit,\n      template_id: selectedTemplate.id,\n      template_name: selectedTemplate.name,\n      responses,\n      created_at: new Date().toISOString(),\n    };\n\n    // Save to IndexedDB (will sync to server later)\n    await db.outbox.add({\n      type: \"CHECKLIST\",\n      payload: checklistData,\n      created_at: Date.now(),\n      attempts: 0,\n    });\n\n    setSaved(true);\n    setTimeout(() => {\n      setSaved(false);\n      setResponses({});\n      setSelectedTemplate(null);\n      setSelectedVisit(null);\n    }, 2000);\n  }\n\n  return (\n    <div className=\"p-4 space-y-4\">\n      <Card>\n        <CardHeader>\n          <CardTitle>📋 Checklists de Campo</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {/* Select Visit */}\n          <div>\n            <label className=\"block mb-2 font-medium text-sm\">Visita Atual</label>\n            <select\n              value={selectedVisit || \"\"}\n              onChange={(e) => setSelectedVisit(e.target.value)}\n              className=\"w-full p-2 border rounded\"\n            >\n              <option value=\"\">Selecione uma visita</option>\n              {visits.map((v) => (\n                <option key={v.id} value={v.id}>\n                  {v.client_id} - {v.notes || \"Sem descrição\"}\n                </option>\n              ))}\n            </select>\n          </div>\n\n          {/* Select Template */}\n          <div>\n            <label className=\"block mb-2 font-medium text-sm\">Template</label>\n            <div className=\"grid grid-cols-1 gap-2\">\n              {templates.map((tmpl) => (\n                <button\n                  key={tmpl.id}\n                  onClick={() => setSelectedTemplate(tmpl)}\n                  className={`p-3 border rounded text-left ${\n                    selectedTemplate?.id === tmpl.id ? \"border-green-600 bg-green-50\" : \"\"\n                  }`}\n                >\n                  <div className=\"flex items-center gap-2\">\n                    <CheckSquare className=\"w-4 h-4\" />\n                    <span className=\"font-medium\">{tmpl.name}</span>\n                  </div>\n                </button>\n              ))}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Checklist Form */}\n      {selectedTemplate && selectedVisit && (\n        <Card>\n          <CardHeader>\n            <CardTitle>{selectedTemplate.name}</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            {selectedTemplate.items.map((item) => (\n              <div key={item.id}>\n                <label className=\"block mb-2 text-sm font-medium\">\n                  {item.label}\n                  {item.required && <span className=\"text-red-500 ml-1\">*</span>}\n                </label>\n\n                {item.type === \"boolean\" && (\n                  <div className=\"flex items-center gap-2\">\n                    <Checkbox\n                      checked={responses[item.id] || false}\n                      onCheckedChange={(checked) => handleResponseChange(item.id, checked)}\n                    />\n                    <span className=\"text-sm\">\n                      {responses[item.id] ? \"Sim\" : \"Não\"}\n                    </span>\n                  </div>\n                )}\n\n                {item.type === \"text\" && (\n                  <Input\n                    value={responses[item.id] || \"\"}\n                    onChange={(e) => handleResponseChange(item.id, e.target.value)}\n                    placeholder=\"Digite aqui...\"\n                  />\n                )}\n\n                {item.type === \"number\" && (\n                  <Input\n                    type=\"number\"\n                    value={responses[item.id] || \"\"}\n                    onChange={(e) => handleResponseChange(item.id, parseFloat(e.target.value))}\n                    placeholder=\"Digite um número...\"\n                  />\n                )}\n              </div>\n            ))}\n\n            <Button onClick={handleSave} className=\"w-full\">\n              <Save className=\"w-4 h-4 mr-2\" />\n              {saved ? \"✅ Salvo!\" : \"Salvar Checklist\"}\n            </Button>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","size_bytes":7090},"crm-agro-mobile/src/features/screens/AgendaScreen.tsx":{"content":"import React, { useMemo, useState } from \"react\";\nimport { View, Text, FlatList, TouchableOpacity, RefreshControl } from \"react-native\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { api } from \"@api/client\";\nimport AgendaFromText from \"../agenda/AgendaFromText\";\n\ntype Visit = {\n  id: string; \n  client_id: string; \n  status: string;\n  window_start?: string | null; \n  notes?: string | null;\n};\n\nconst STATUS = [\"PLANEJADA\",\"PRONTA\",\"EM_DESLOCAMENTO\",\"NO_LOCAL\",\"CONCLUIDA\"] as const;\n\nexport default function AgendaScreen() {\n  const [filter, setFilter] = useState<typeof STATUS[number] | \"TODAS\">(\"TODAS\");\n\n  const { data, refetch, isFetching } = useQuery({\n    queryKey: [\"visits\", \"agenda\"],\n    queryFn: async () => {\n      const { data } = await api.get<Visit[]>(\"/api/visits\");\n      return data;\n    }\n  });\n\n  const visits = data || [];\n  const filtered = useMemo(\n    () => filter === \"TODAS\" ? visits : visits.filter(v => v.status === filter),\n    [visits, filter]\n  );\n\n  return (\n    <FlatList\n      ListHeaderComponent={\n        <View style={{ padding: 16, gap: 12 }}>\n          <Text style={{ fontWeight: \"bold\", fontSize: 16 }}>Agenda</Text>\n          <View style={{ flexDirection: \"row\", flexWrap: \"wrap\", gap: 8 }}>\n            {([\"TODAS\", ...STATUS] as const).map(s => (\n              <TouchableOpacity \n                key={s} \n                onPress={() => setFilter(s)}\n                style={{ \n                  paddingVertical: 6, \n                  paddingHorizontal: 10, \n                  borderWidth: 1, \n                  borderColor: filter===s?\"#22c55e\":\"#ddd\", \n                  borderRadius: 999 \n                }}\n              >\n                <Text style={{ color: filter===s?\"#22c55e\":\"#444\" }}>{s}</Text>\n              </TouchableOpacity>\n            ))}\n          </View>\n        </View>\n      }\n      data={filtered}\n      keyExtractor={(i) => i.id}\n      renderItem={({ item }) => (\n        <View style={{ padding: 12, borderBottomWidth: 1, borderColor: \"#eee\" }}>\n          <Text style={{ fontWeight: \"600\" }}>{item.client_id}</Text>\n          <Text style={{ color: \"#666\" }}>\n            {item.window_start ? new Date(item.window_start).toLocaleString() : \"sem horário\"}\n          </Text>\n          <Text style={{ color: \"#22c55e\", fontWeight: \"600\" }}>{item.status}</Text>\n          {item.notes ? <Text style={{ color: \"#555\" }}>{item.notes}</Text> : null}\n        </View>\n      )}\n      refreshControl={<RefreshControl refreshing={isFetching} onRefresh={refetch} />}\n      ListFooterComponent={\n        <View style={{ padding: 16 }}>\n          <AgendaFromText />\n        </View>\n      }\n    />\n  );\n}\n","size_bytes":2667},"server/storage-crm.ts":{"content":"import { and, eq, gte, sql } from \"drizzle-orm\";\nimport { db } from \"./db\";\nimport {\n  visits, trips, telemetryGps, checklists, fields, farms, auditLogs\n} from \"@shared/schema.crm\";\n\nexport type InsertVisit = typeof visits.$inferInsert;\nexport type Visit = typeof visits.$inferSelect;\nexport type Trip = typeof trips.$inferSelect;\n\nexport const CRMStorage = {\n  // VISITS\n  async getVisits(params: { assignee?: string; updatedSince?: string }) {\n    const where = [];\n    if (params.assignee) where.push(eq(visits.assignee, params.assignee));\n    if (params.updatedSince) {\n      where.push(gte(visits.updatedAt, new Date(params.updatedSince)));\n    }\n    return db.select().from(visits)\n      .where(where.length ? and(...where) : undefined)\n      .orderBy(visits.updatedAt);\n  },\n\n  async getRoute(params: { assignee?: string; date?: string }) {\n    const dateFilter = params.date ? sql`DATE(v.window_start) = ${params.date}` : sql`true`;\n    const assigneeFilter = params.assignee ? sql`v.assignee = ${params.assignee}` : sql`true`;\n\n    return db.execute(sql`\n      SELECT v.id, v.client_id, v.status, v.window_start, v.window_end,\n             COALESCE(ST_Y(ST_Centroid(f.geom)), ST_Y(fa.centroid)) AS lat,\n             COALESCE(ST_X(ST_Centroid(f.geom)), ST_X(fa.centroid)) AS lng\n        FROM visits v\n   LEFT JOIN fields f ON f.id = v.field_id\n   LEFT JOIN farms  fa ON fa.id = v.farm_id\n       WHERE ${assigneeFilter} AND ${dateFilter}\n    ORDER BY v.window_start NULLS LAST\n    `) as unknown as Array<{\n      id: string; client_id: string; status: string;\n      window_start: string | null; window_end: string | null;\n      lat: number | null; lng: number | null;\n    }>;\n  },\n\n  async createVisitsBulk(payload: any[]) {\n    if (!payload?.length) return [];\n    \n    // Mapear snake_case para camelCase (schema do Drizzle) e converter strings para Date\n    const normalized = payload.map(v => ({\n      id: v.id,\n      clientId: v.clientId || v.client_id,\n      farmId: v.farmId || v.farm_id || null,\n      fieldId: v.fieldId || v.field_id || null,\n      scheduledAt: v.scheduledAt ? new Date(v.scheduledAt) : v.scheduled_at ? new Date(v.scheduled_at) : null,\n      windowStart: v.windowStart ? new Date(v.windowStart) : v.window_start ? new Date(v.window_start) : null,\n      windowEnd: v.windowEnd ? new Date(v.windowEnd) : v.window_end ? new Date(v.window_end) : null,\n      status: v.status || 'PLANEJADA',\n      assignee: v.assignee || null,\n      notes: v.notes || null,\n    }));\n    \n    const inserted = await db.insert(visits).values(normalized).returning();\n    return inserted;\n  },\n\n  async updateVisitStatus(id: string, next: typeof visits.$inferInsert[\"status\"]) {\n    const row = await db.update(visits).set({ status: next, updatedAt: new Date() }).where(eq(visits.id, id)).returning();\n    return row[0];\n  },\n\n  // TRIPS\n  async startTrip(data: {\n    visitId: string; odometer?: number | null; gps?: { lat?: number; lng?: number; speedKmh?: number; accuracyM?: number } | null; opId?: string | null; actor?: string | null;\n  }) {\n    if (data.opId) {\n      const dup = await db.execute(sql`SELECT 1 FROM audit_logs WHERE action='TRIP_START' AND payload->>'op_id' = ${data.opId} LIMIT 1`);\n      if ((dup as any).rowCount > 0) return { duplicate: true };\n    }\n\n    const [trip] = await db.insert(trips).values({\n      visitId: data.visitId,\n      startedAt: new Date(),\n      startOdometer: data.odometer ?? null\n    }).returning();\n\n    await db.update(visits).set({ status: \"EM_DESLOCAMENTO\", updatedAt: new Date() }).where(eq(visits.id, data.visitId));\n    await db.insert(auditLogs).values({\n      actor: data.actor ?? null,\n      action: \"TRIP_START\",\n      entity: \"trip\",\n      entityId: trip.id,\n      payload: { op_id: data.opId ?? null }\n    });\n\n    if (data.gps?.lat && data.gps?.lng) {\n      await db.insert(telemetryGps).values({\n        tripId: trip.id,\n        ts: new Date(),\n        lat: String(data.gps.lat),\n        lng: String(data.gps.lng),\n        speedKmh: data.gps.speedKmh ? String(data.gps.speedKmh) : null,\n        accuracyM: data.gps.accuracyM ? String(data.gps.accuracyM) : null\n      });\n    }\n    return trip;\n  },\n\n  async appendGpsBatch(batch: Array<{ tripId: string; ts?: string; lat: number; lng: number; speedKmh?: number | null; accuracyM?: number | null }>) {\n    if (!batch?.length) return 0;\n    await db.insert(telemetryGps).values(batch.map(p => ({\n      tripId: p.tripId,\n      ts: p.ts ? new Date(p.ts) : new Date(),\n      lat: String(p.lat),\n      lng: String(p.lng),\n      speedKmh: p.speedKmh != null ? String(p.speedKmh) : null,\n      accuracyM: p.accuracyM != null ? String(p.accuracyM) : null\n    })));\n    return batch.length;\n  },\n\n  async endTrip(id: string, odometer?: number | null) {\n    // Aceita tanto trip_id quanto visit_id\n    // Primeiro tenta como trip_id\n    let tripResult = await db.select().from(trips).where(eq(trips.id, id)).limit(1);\n    \n    // Se não encontrou, tenta buscar por visit_id (trip mais recente da visita)\n    if (!tripResult || tripResult.length === 0) {\n      tripResult = await db.select().from(trips)\n        .where(eq(trips.visitId, id))\n        .orderBy(sql`${trips.startedAt} DESC`)\n        .limit(1);\n    }\n    \n    if (!tripResult || tripResult.length === 0) {\n      throw new Error(`Trip não encontrado para ID: ${id}`);\n    }\n    \n    const tripId = tripResult[0].id;\n    const visitId = tripResult[0].visitId;\n    \n    const [t] = await db.update(trips).set({\n      endedAt: new Date(),\n      endOdometer: odometer ?? null,\n      updatedAt: new Date()\n    }).where(eq(trips.id, tripId)).returning();\n\n    // Não sobrescreve status se já está CONCLUIDA\n    await db.execute(sql`\n      UPDATE visits \n      SET status = CASE \n        WHEN status = 'CONCLUIDA' THEN 'CONCLUIDA'\n        ELSE 'NO_LOCAL'\n      END,\n      updated_at = NOW()\n      WHERE id = ${visitId}\n    `);\n    return t;\n  },\n\n  // CHECKLIST\n  async saveChecklist(visitId: string, payload: {\n    template?: string | null;\n    answers?: Record<string, any>;\n    photos?: any;\n    signatures?: any;\n    finished?: boolean;\n  }) {\n    const row = await db.insert(checklists).values({\n      visitId,\n      template: payload.template ?? null,\n      answers: payload.answers ?? {},\n      photos: payload.photos ?? {},\n      signatures: payload.signatures ?? {},\n      finished: !!payload.finished,\n      finishedAt: payload.finished ? new Date() : null\n    }).returning();\n\n    // Always update visit's updatedAt for delta-sync, and status when finished\n    if (payload.finished) {\n      await db.update(visits).set({ status: \"CONCLUIDA\", updatedAt: new Date() }).where(eq(visits.id, visitId));\n    } else {\n      await db.update(visits).set({ updatedAt: new Date() }).where(eq(visits.id, visitId));\n    }\n    return row[0];\n  },\n\n  // GEO (ST_Contains)\n  async pointInsideField(fieldId: string, lat: number, lng: number) {\n    const res = await db.execute(sql`\n      SELECT ST_Contains(geom, ST_SetSRID(ST_Point(${lng}, ${lat}),4326)) AS inside\n        FROM fields WHERE id = ${fieldId}\n    `);\n    const row = (res as any).rows?.[0];\n    return !!row?.inside;\n  }\n};\n","size_bytes":7155},"client/src/components/crm/map-view.tsx":{"content":"import { MapContainer, TileLayer, Marker, Popup } from \"react-leaflet\";\n\ntype MapPoint = {\n  lat: number;\n  lng: number;\n  title: string;\n};\n\nexport default function MapView({ points }: { points: MapPoint[] }) {\n  const center = points.length > 0 ? [points[0].lat, points[0].lng] as [number, number] : [-25.516, -54.616] as [number, number];\n\n  return (\n    <div style={{ height: 400, width: \"100%\", borderRadius: 8, overflow: \"hidden\", border: \"1px solid #ddd\" }}>\n      <MapContainer center={center} zoom={13} style={{ height: \"100%\", width: \"100%\" }}>\n        <TileLayer\n          url=\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"\n          attribution='&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a>'\n        />\n        {points.map((p, i) => (\n          <Marker key={i} position={[p.lat, p.lng]}>\n            <Popup>{p.title}</Popup>\n          </Marker>\n        ))}\n      </MapContainer>\n    </div>\n  );\n}\n","size_bytes":945},"crm-agro-mobile/fix-mobile.sh":{"content":"#!/bin/bash\nset -e\n\necho \"🔧 CONSERTANDO MOBILE APP - Aguarde...\"\necho \"\"\n\n# 1. Limpar TUDO\necho \"1️⃣ Removendo node_modules e caches...\"\nrm -rf node_modules .expo .metro package-lock.json\n\n# 2. Reinstalar LIMPO\necho \"2️⃣ Reinstalando dependências...\"\nnpm install --legacy-peer-deps\n\n# 3. Limpar Metro cache\necho \"3️⃣ Limpando Metro bundler...\"\nnpx expo start --clear &\nEXPO_PID=$!\nsleep 3\nkill $EXPO_PID 2>/dev/null || true\n\necho \"\"\necho \"✅ PRONTO! Agora execute:\"\necho \"   npx expo start --clear\"\necho \"\"\necho \"📱 No celular:\"\necho \"   1. FECHE Expo Go completamente\"\necho \"   2. Abra novamente\"\necho \"   3. Escaneie o QR code\"\n","size_bytes":649},"crm-agro-mobile/TESTE_SIMPLES.md":{"content":"# 📱 TESTE SIMPLES - SEM REINSTALAR NADA\n\n## 🎯 Objetivo\nFazer o login funcionar no mobile sem mexer em dependências.\n\n## ⚠️ IMPORTANTE\n**NÃO delete node_modules**  \n**NÃO reinstale nada**  \n**Use o que já está instalado**\n\n---\n\n## 🔄 Passos\n\n### 1. No Terminal do Mac onde está o Expo rodando:\n\nSe o Expo já está rodando:\n- Pressione **R** (reload)\n- OU pressione **Ctrl+C** e rode: `npx expo start` (sem --clear)\n\nSe não está rodando:\n```bash\ncd ~/Downloads/crm-agro-mobile\nnpx expo start\n```\n\n### 2. No celular:\n\n1. **Abra o Expo Go** (se já está aberto, balance o celular → Reload)\n2. **Escaneie o QR code** (se precisar)\n\n### 3. O que deve acontecer:\n\n**Tela de login carrega → Digite:**\n- Usuário: `fregolao`\n- Senha: `123`\n\n**OU**\n\n- Usuário: `bruno`  \n- Senha: `123`\n\n---\n\n## 📊 Resultados Possíveis\n\n### ✅ Cenário 1: LOGIN FUNCIONA\n- App redireciona para dashboard\n- **SUCESSO!**\n\n### ❌ Cenário 2: \"Falha no login\"\n**Me diga:**\n- Qual mensagem de erro aparece EXATA?\n- A URL aparece na tela? (linha pequena com 🔗)\n- Aparece popup de erro?\n\n### ❌ Cenário 3: Tela vermelha de erro\n**Tire foto e me envie**\n\n---\n\n## 🔍 Debugging\n\nSe falhar, no **Terminal do Mac**, pressione:\n- **J** → abre debugger do React Native\n- Veja o console e me diga o que aparece\n\n---\n\n**Execute isso e me diga o resultado exato!**\n","size_bytes":1362},"client/src/utils/geo.ts":{"content":"export function haversineDistance(lat1: number, lon1: number, lat2: number, lon2: number) {\n  const R = 6371e3; // metros\n  const φ1 = (lat1 * Math.PI) / 180;\n  const φ2 = (lat2 * Math.PI) / 180;\n  const Δφ = ((lat2 - lat1) * Math.PI) / 180;\n  const Δλ = ((lon2 - lon1) * Math.PI) / 180;\n\n  const a =\n    Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +\n    Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n  return R * c; // retorna metros\n}\n","size_bytes":527},"crm-agro-mobile/src/auth/LoginScreen.tsx":{"content":"import React, { useState } from \"react\";\nimport { View, Text, TextInput, Button, ActivityIndicator, StyleSheet, Alert } from \"react-native\";\nimport { useAuth } from \"./AuthContext\";\nimport { DebugInfo } from \"../DebugInfo\";\n\nexport default function LoginScreen() {\n  const { login, loading } = useAuth();\n  const [username, setUsername] = useState(\"\");\n  const [password, setPassword] = useState(\"\");\n  const [busy, setBusy] = useState(false);\n  const [err, setErr] = useState<string | null>(null);\n\n  async function onSubmit() {\n    setBusy(true);\n    setErr(null);\n    try {\n      await login(username.trim(), password);\n    } catch (e: any) {\n      const errorMsg = e?.message || e?.response?.data?.error || \"Falha no login\";\n      setErr(errorMsg);\n      console.error(\"Login error:\", e);\n      Alert.alert(\"Erro de Login\", errorMsg);\n    } finally {\n      setBusy(false);\n    }\n  }\n\n  return (\n    <View style={styles.container}>\n      <Text style={styles.title}>CRM Agro Mobile</Text>\n      <Text style={styles.subtitle}>Entrar v3.0</Text>\n      \n      <DebugInfo />\n      \n      <TextInput\n        placeholder=\"Usuário\"\n        value={username}\n        onChangeText={setUsername}\n        autoCapitalize=\"none\"\n        style={styles.input}\n      />\n      \n      <TextInput\n        placeholder=\"Senha\"\n        value={password}\n        onChangeText={setPassword}\n        secureTextEntry\n        style={styles.input}\n      />\n      \n      {err ? <Text style={styles.error}>{err}</Text> : null}\n      \n      <Button\n        title={busy ? \"Entrando...\" : \"Entrar\"}\n        onPress={onSubmit}\n        disabled={busy || loading}\n        color=\"#22c55e\"\n      />\n      \n      {(busy || loading) && <ActivityIndicator style={styles.loader} />}\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    justifyContent: \"center\",\n    padding: 24,\n    backgroundColor: \"#fff\",\n  },\n  title: {\n    fontSize: 28,\n    fontWeight: \"bold\",\n    marginBottom: 8,\n    color: \"#22c55e\",\n    textAlign: \"center\",\n  },\n  subtitle: {\n    fontSize: 20,\n    fontWeight: \"600\",\n    marginBottom: 12,\n    textAlign: \"center\",\n  },\n  input: {\n    borderWidth: 1,\n    borderColor: \"#ddd\",\n    borderRadius: 8,\n    padding: 12,\n    marginBottom: 16,\n    fontSize: 16,\n  },\n  error: {\n    color: \"#ef4444\",\n    marginBottom: 12,\n  },\n  loader: {\n    marginTop: 12,\n  },\n});\n","size_bytes":2378},"client/src/hooks/useTracking.ts":{"content":"import { useEffect, useRef } from \"react\";\nimport { haversineDistance } from \"@/utils/geo\";\nimport { enqueue } from \"@/hooks/useSync\";\nimport { db } from \"@/lib/crm/idb\";\nimport { showNotification } from \"@/utils/sw-register\";\n\ntype Visit = {\n  id: string;\n  client_id: string;\n  status: \"PLANEJADA\" | \"PRONTA\" | \"EM_DESLOCAMENTO\" | \"NO_LOCAL\" | \"CONCLUIDA\";\n  window_start?: string | null;\n};\n\ntype TrackingOptions = {\n  onRequestOdometer?: (callback: (odometer: number) => void) => void;\n  onTripStarted?: (markStarted: () => void) => void;\n};\n\nexport function useTracking(userId: string, options?: TrackingOptions) {\n  const watchId = useRef<number | null>(null);\n  const activeVisitIdRef = useRef<string | null>(null);\n  const activeFarmLatRef = useRef<number | null>(null);\n  const activeFarmLngRef = useRef<number | null>(null);\n  const inFarmRef = useRef(false);\n  const inBaseRef = useRef(true);\n  const tripStartedRef = useRef(false);\n\n  useEffect(() => {\n    if (!(\"geolocation\" in navigator)) {\n      console.error(\"GPS não disponível\");\n      return;\n    }\n\n    // Expõe função para marcar trip como iniciado (para início manual)\n    if (options?.onTripStarted) {\n      options.onTripStarted(() => {\n        tripStartedRef.current = true;\n      });\n    }\n\n    async function handlePosition(pos: GeolocationPosition) {\n      const { latitude, longitude, speed } = pos.coords;\n\n      // salva ponto no banco local\n      await db.telemetry.add({\n        trip_id: null,\n        ts: new Date().toISOString(),\n        lat: latitude,\n        lng: longitude,\n        speed_kmh: speed || 0,\n        accuracy_m: pos.coords.accuracy\n      });\n\n      // pega visitas do dia\n      const visits = await db.visits.toArray() as Visit[];\n      if (!visits?.length) return;\n\n      // pega configurações\n      const settings = await db.settings.get(\"config\");\n      const geofenceBase = (settings?.value?.geofenceBase) || 200;\n      const geofenceFarm = (settings?.value?.geofenceFarm) || 200;\n      const baseLat = (settings?.value?.baseLat) || -25.516;\n      const baseLng = (settings?.value?.baseLng) || -54.616;\n\n      // verifica saída da base\n      const distBase = haversineDistance(latitude, longitude, baseLat, baseLng);\n      if (inBaseRef.current && distBase > geofenceBase && !tripStartedRef.current) {\n        inBaseRef.current = false;\n        console.log(\"🚗 Saiu da base! Solicitando quilometragem...\");\n        \n        // Auto-iniciar primeira visita da agenda\n        const today = new Date();\n        today.setHours(0, 0, 0, 0);\n        \n        const todayVisits = visits.filter(v => {\n          if (!v.window_start) return false;\n          const visitDate = new Date(v.window_start);\n          visitDate.setHours(0, 0, 0, 0);\n          return visitDate.getTime() === today.getTime();\n        });\n\n        const firstPlanned = todayVisits\n          .filter(v => v.status === 'PLANEJADA')\n          .sort((a, b) => {\n            const timeA = a.window_start ? new Date(a.window_start).getTime() : 0;\n            const timeB = b.window_start ? new Date(b.window_start).getTime() : 0;\n            return timeA - timeB;\n          })[0];\n\n        if (firstPlanned && options?.onRequestOdometer) {\n          const clients = await db.clients.toArray();\n          const client = clients.find(c => c.id === firstPlanned.client_id);\n          const clientName = client?.name || firstPlanned.client_id;\n          \n          // Solicita quilometragem antes de iniciar\n          options.onRequestOdometer(async (odometer: number) => {\n            tripStartedRef.current = true;\n            \n            // Atualiza status local\n            await db.visits.update(firstPlanned.id, { status: \"EM_DESLOCAMENTO\" });\n            \n            console.log(`🎯 Rota iniciada para ${clientName} - KM: ${odometer}`);\n            \n            showNotification(\"Rota Iniciada!\", {\n              body: `Indo para ${clientName}`,\n              icon: \"/icon-192.png\",\n              vibrate: [200, 100, 200],\n            });\n            \n            // Envia para backend\n            await enqueue(\"VISIT_CREATE\", { \n              id: firstPlanned.id, \n              status: \"EM_DESLOCAMENTO\" \n            });\n            \n            // Inicia trip com quilometragem\n            await enqueue(\"TRIP_START\", { \n              visit_id: firstPlanned.id,\n              ts: new Date().toISOString(), \n              lat: latitude, \n              lng: longitude,\n              odometer: odometer\n            });\n          });\n        } else if (!firstPlanned) {\n          // Se não tem visita planejada, apenas marca que saiu da base\n          tripStartedRef.current = true;\n        }\n      }\n\n      // Ordena visitas por horário (agenda sequencial)\n      const sortedVisits = visits\n        .filter(v => v.status !== 'CONCLUIDA')\n        .sort((a, b) => {\n          const timeA = a.window_start ? new Date(a.window_start).getTime() : 0;\n          const timeB = b.window_start ? new Date(b.window_start).getTime() : 0;\n          return timeA - timeB;\n        });\n\n      // Monitora próxima visita OU visita ativa (NO_LOCAL)\n      const nextVisit = sortedVisits.find(v => \n        v.status === 'EM_DESLOCAMENTO' || v.status === 'PLANEJADA' || v.status === 'NO_LOCAL'\n      );\n\n      if (nextVisit) {\n        const farmLat = (nextVisit as any).lat;\n        const farmLng = (nextVisit as any).lng;\n        \n        if (farmLat && farmLng) {\n          const distFarm = haversineDistance(latitude, longitude, farmLat, farmLng);\n\n          // entrada na fazenda (200m)\n          if (!inFarmRef.current && distFarm < geofenceFarm && nextVisit.status !== 'NO_LOCAL') {\n            inFarmRef.current = true;\n            activeVisitIdRef.current = nextVisit.id;\n            activeFarmLatRef.current = farmLat;\n            activeFarmLngRef.current = farmLng;\n            \n            // Pega nome do cliente\n            const clients = await db.clients.toArray();\n            const client = clients.find(c => c.id === nextVisit.client_id);\n            const clientName = client?.name || nextVisit.client_id;\n            \n            console.log(`📍 Chegou à fazenda ${clientName}`);\n            \n            showNotification(`Chegou em ${clientName}!`, {\n              body: `Iniciando atendimento automaticamente`,\n              icon: \"/icon-192.png\",\n              vibrate: [200, 100, 200],\n            });\n            \n            // Atualiza status local IMEDIATAMENTE\n            await db.visits.update(nextVisit.id, { status: \"NO_LOCAL\" });\n            \n            // Envia para backend depois\n            await enqueue(\"VISIT_CREATE\", { \n              id: nextVisit.id, \n              status: \"NO_LOCAL\" \n            });\n          }\n        }\n      }\n\n      // saída da fazenda - verifica distância da fazenda ativa (independente de sortedVisits)\n      if (inFarmRef.current && activeFarmLatRef.current && activeFarmLngRef.current) {\n        const distFromActiveFarm = haversineDistance(\n          latitude, \n          longitude, \n          activeFarmLatRef.current, \n          activeFarmLngRef.current\n        );\n\n        // Se distância > 400m da fazenda ativa, reseta tracking\n        if (distFromActiveFarm > geofenceFarm * 2) {\n          console.log(`✅ Saindo da fazenda - Preparando para próxima visita`);\n          \n          showNotification(\"Saindo da fazenda\", {\n            body: `Próxima visita será monitorada automaticamente`,\n            icon: \"/icon-192.png\",\n            vibrate: [200],\n          });\n\n          // RESETA tudo para permitir próxima visita\n          inFarmRef.current = false;\n          activeVisitIdRef.current = null;\n          activeFarmLatRef.current = null;\n          activeFarmLngRef.current = null;\n        }\n      }\n    }\n\n    // inicia o watcher\n    watchId.current = navigator.geolocation.watchPosition(\n      handlePosition,\n      (err) => console.error(\"Erro GPS\", err),\n      { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }\n    );\n\n    console.log(\"📡 Rastreamento iniciado\");\n\n    return () => {\n      if (watchId.current) navigator.geolocation.clearWatch(watchId.current);\n    };\n  }, [userId]);\n}\n","size_bytes":8167},"crm-agro-mobile/src/features/visits/RouteMap.tsx":{"content":"import React, { useEffect, useMemo, useState } from \"react\";\nimport { View, Text, FlatList, StyleSheet } from \"react-native\";\nimport { api } from \"@api/client\";\nimport { useAuth } from \"@auth/AuthContext\";\n\nconst BASE = { lat: -25.3, lng: -57.6 };\n\nfunction haversine(a: {lat:number,lng:number}, b: {lat:number,lng:number}) {\n  const R = 6371;\n  const dLat = (b.lat - a.lat) * Math.PI / 180;\n  const dLng = (b.lng - a.lng) * Math.PI / 180;\n  const s1 = Math.sin(dLat/2)**2 + Math.cos(a.lat*Math.PI/180) * Math.cos(b.lat*Math.PI/180) * Math.sin(dLng/2)**2;\n  return 2 * R * Math.asin(Math.sqrt(s1));\n}\n\nfunction statusColor(status?: string) {\n  switch(status) {\n    case \"PLANEJADA\": return \"#9aa0a6\";\n    case \"PRONTA\": return \"#1e90ff\";\n    case \"EM_DESLOCAMENTO\": return \"#ff8c00\";\n    case \"NO_LOCAL\": return \"#34a853\";\n    case \"CONCLUIDA\": return \"#6f42c1\";\n    default: return \"#9aa0a6\";\n  }\n}\n\nexport default function RouteMap() {\n  const { user } = useAuth();\n  const [visits, setVisits] = useState<any[]>([]);\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    loadRoute();\n  }, []);\n\n  async function loadRoute() {\n    try {\n      setLoading(true);\n      const today = new Date().toISOString().slice(0, 10);\n      const { data } = await api.get(\"/api/visits/route\", {\n        params: { date: today, assignee: user?.username }\n      });\n      const filtered = (data || []).filter((v: any) => v.lat && v.lng);\n      setVisits(filtered);\n    } catch (error) {\n      console.error('Load route error:', error);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  const ordered = useMemo(() => {\n    const withScore = visits.map((v: any) => {\n      const timeScore = v.window_start ? new Date(v.window_start).getTime() : Number.MAX_SAFE_INTEGER;\n      const dist = haversine(BASE, { lat: v.lat, lng: v.lng });\n      return { ...v, _time: timeScore, _dist: dist };\n    });\n    withScore.sort((a: any, b: any) => (a._time - b._time) || (a._dist - b._dist));\n    return withScore;\n  }, [visits]);\n\n  if (loading) {\n    return (\n      <View style={styles.container}>\n        <Text style={styles.loadingText}>Carregando rota...</Text>\n      </View>\n    );\n  }\n\n  return (\n    <View style={styles.container}>\n      <View style={styles.mapPlaceholder}>\n        <Text style={styles.mapText}>🗺️ Mapa temporariamente desabilitado</Text>\n        <Text style={styles.mapSubtext}>Rota otimizada por horário e distância</Text>\n      </View>\n      \n      <FlatList\n        data={ordered}\n        keyExtractor={(i: any) => i.id}\n        ListHeaderComponent={\n          <View style={styles.listHeader}>\n            <Text style={styles.headerText}>📍 Base → {ordered.length} visitas</Text>\n          </View>\n        }\n        renderItem={({ item, index }) => (\n          <View style={styles.visitItem}>\n            <View style={[styles.statusDot, { backgroundColor: statusColor(item.status) }]} />\n            <View style={styles.visitContent}>\n              <Text style={styles.visitNumber}>\n                {index + 1}. {item.client_id}\n              </Text>\n              <Text style={styles.visitStatus}>{item.status}</Text>\n              <Text style={styles.visitTime}>\n                {item.window_start ? new Date(item.window_start).toLocaleTimeString('pt-BR', { \n                  hour: '2-digit', \n                  minute: '2-digit' \n                }) : \"sem horário\"}\n              </Text>\n              <Text style={styles.visitDistance}>~{item._dist.toFixed(1)} km da base</Text>\n            </View>\n          </View>\n        )}\n        ListEmptyComponent={\n          <View style={styles.emptyState}>\n            <Text style={styles.emptyText}>Nenhuma visita agendada para hoje</Text>\n          </View>\n        }\n      />\n    </View>\n  );\n}\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: \"#fff\",\n  },\n  mapPlaceholder: {\n    height: 150,\n    backgroundColor: \"#f0f9ff\",\n    justifyContent: \"center\",\n    alignItems: \"center\",\n    borderRadius: 8,\n    margin: 16,\n  },\n  mapText: {\n    fontSize: 16,\n    fontWeight: \"600\",\n    color: \"#0369a1\",\n  },\n  mapSubtext: {\n    fontSize: 12,\n    color: \"#0284c7\",\n    marginTop: 4,\n  },\n  loadingText: {\n    textAlign: \"center\",\n    padding: 20,\n    color: \"#666\",\n  },\n  listHeader: {\n    padding: 12,\n    backgroundColor: \"#f9fafb\",\n    borderBottomWidth: 1,\n    borderColor: \"#e5e7eb\",\n  },\n  headerText: {\n    fontSize: 14,\n    fontWeight: \"600\",\n    color: \"#374151\",\n  },\n  visitItem: {\n    flexDirection: \"row\",\n    padding: 12,\n    borderBottomWidth: 1,\n    borderColor: \"#eee\",\n    alignItems: \"center\",\n  },\n  statusDot: {\n    width: 12,\n    height: 12,\n    borderRadius: 6,\n    marginRight: 12,\n  },\n  visitContent: {\n    flex: 1,\n  },\n  visitNumber: {\n    fontSize: 14,\n    fontWeight: \"600\",\n    color: \"#111\",\n  },\n  visitStatus: {\n    fontSize: 11,\n    color: \"#666\",\n    marginTop: 2,\n  },\n  visitTime: {\n    fontSize: 12,\n    color: \"#0284c7\",\n    marginTop: 4,\n  },\n  visitDistance: {\n    fontSize: 11,\n    color: \"#9ca3af\",\n    marginTop: 2,\n  },\n  emptyState: {\n    padding: 40,\n    alignItems: \"center\",\n  },\n  emptyText: {\n    fontSize: 14,\n    color: \"#9ca3af\",\n  },\n});\n","size_bytes":5209},"MOBILE_INTEGRATION.md":{"content":"# 📱 Integração Mobile - CRM Agro\n\nEste documento descreve como integrar o app mobile Android (`crm-agro-mobile`) com o backend existente.\n\n## 🏗️ Arquitetura\n\nO app mobile usa **offline-first architecture** com:\n\n- **SQLite local** para armazenamento persistente\n- **Outbox pattern** para sincronização confiável\n- **Delta-sync** incremental usando timestamps `updatedAt`\n- **Cookie-based auth** compartilhada com web app\n- **Geofencing** para detecção automática de viagens\n- **GPS tracking** com telemetria em batch\n\n## ✅ Backend já implementado\n\nTodos os endpoints necessários já estão implementados:\n\n### Autenticação\n- ✅ `POST /api/login` - Retorna cookie de sessão\n- ✅ `GET /api/user` - Dados do usuário logado  \n- ✅ `POST /api/logout` - Encerra sessão\n\n### Visitas e CRM\n- ✅ `GET /api/visits?updated_since=ISO` - Delta-sync de visitas\n- ✅ `GET /api/visits/route?date=YYYY-MM-DD&assignee=username` - Rota otimizada\n- ✅ `PATCH /api/visits/:id/status` - Atualiza status da visita\n\n### Viagens e GPS\n- ✅ `POST /api/trips/start` - Inicia viagem\n- ✅ `POST /api/trips/gps` - Envia telemetria GPS em batch\n- ✅ `POST /api/trips/:id/end` - Finaliza viagem\n\n### Checklists\n- ✅ `POST /api/checklists/:visitId` - Salva checklist de inspeção\n\n### Parser NLP\n- ✅ `POST /api/agenda/parse` - Converte texto em visitas estruturadas\n- ✅ `POST /api/agenda/confirm` - Cria visitas em lote\n\n### Geofencing\n- ✅ `GET /api/geo/fields/:id/contains` - Validação de geofence\n\n## 🔧 Configuração Necessária\n\n### 1. Cookies HTTPS\n\nPara o app funcionar com autenticação por cookie, o backend precisa configurar:\n\n```typescript\n// Em server/index.ts ou onde configura sessão\napp.use(session({\n  cookie: {\n    httpOnly: true,\n    secure: true,           // Requer HTTPS\n    sameSite: 'none',       // Permite cross-origin\n    maxAge: 7 * 24 * 60 * 60 * 1000  // 7 dias\n  }\n}));\n```\n\n### 2. CORS\n\nO backend já está configurado para aceitar credenciais:\n\n```typescript\napp.use(cors({\n  origin: true,\n  credentials: true\n}));\n```\n\n### 3. Cache Control\n\nTodos os endpoints já enviam headers de cache corretos:\n\n```typescript\nres.setHeader('Cache-Control', 'no-store, no-cache, must-revalidate, private');\n```\n\n## 📊 Fluxo de Sincronização\n\n### Delta-sync (Backend → Mobile)\n\n1. App mobile envia `GET /api/visits?updated_since=2025-01-01T10:00:00Z`\n2. Backend retorna apenas visitas com `updatedAt > timestamp`\n3. App merge local com dados do servidor\n\n**CRÍTICO:** Todas as mutations devem atualizar `updatedAt`:\n\n```typescript\n// ✅ CORRETO - Atualiza timestamp\nawait db.update(visits)\n  .set({ \n    status: 'CONCLUIDA',\n    updatedAt: new Date()  // Importante!\n  })\n  .where(eq(visits.id, id));\n\n// ❌ ERRADO - Não atualiza timestamp\nawait db.update(visits)\n  .set({ status: 'CONCLUIDA' })\n  .where(eq(visits.id, id));\n```\n\n### Outbox Pattern (Mobile → Backend)\n\n1. Ações do usuário são salvas em `outbox` local\n2. Worker tenta enviar quando online\n3. Remove da outbox após sucesso\n4. Retry com backoff exponencial se falhar\n\n## 🗺️ Geofencing e Trip Detection\n\n### Detecção Automática de Viagem\n\nO app registra um geofence circular de 200m na base e monitora:\n\n1. **Evento de saída** da geofence\n2. **Velocidade > 15km/h**\n3. Se ambos verdadeiros → `POST /api/trips/start`\n\n### GPS Tracking\n\nDurante a viagem:\n- Telemetria a cada 7 segundos ou 10 metros\n- Enviado em batch: `POST /api/trips/gps`\n- Payload: `{ trip_id, points: [{lat, lng, speed_kmh, accuracy_m, timestamp}] }`\n\n### Finalização\n\nQuando usuário marca visita como \"NO_LOCAL\":\n- App chama `POST /api/trips/:id/end`\n- Backend calcula distância total e duração\n\n## 📝 Parser NLP\n\n### Formato de Entrada\n\n```\namanhã: João Silva inspeção 08:00; Maria Lopes amostra 10:30 (obs: prioridade)\n```\n\n### Pipeline\n\n1. **Parse** → `POST /api/agenda/parse { text }`\n2. Backend usa Fuse.js para fuzzy match de clientes\n3. Retorna: `{ items: [{ client_id, intent, date, time, notes, priority }] }`\n4. **Confirm** → `POST /api/agenda/confirm { items }`\n5. Backend cria visitas em batch\n\n## 🔐 Segurança\n\n### Sessões\n\n- Cookie HttpOnly impede acesso via JavaScript\n- SameSite=None requer HTTPS\n- Expira em 7 dias automaticamente\n\n### Dados Locais\n\n- SQLite não criptografado (Android protege por sandbox)\n- Logout limpa banco local completamente\n- Nenhum dado sensível em AsyncStorage\n\n## 📱 Instalação e Deploy\n\n### Desenvolvimento\n\n```bash\ncd crm-agro-mobile\nnpm install\nnpx expo start\n# Pressione 'a' para Android\n```\n\n### Build de Produção\n\n```bash\n# Build APK\nnpx eas build --platform android --profile preview\n\n# Build AAB para Google Play\nnpx eas build --platform android --profile production\n```\n\nRequer configuração de `eas.json`:\n\n```json\n{\n  \"build\": {\n    \"production\": {\n      \"android\": {\n        \"buildType\": \"app-bundle\"\n      }\n    }\n  }\n}\n```\n\n## 🧪 Testando Integração\n\n### Checklist de Testes\n\n- [ ] Login funciona e cria sessão persistente\n- [ ] Delta-sync retorna apenas visitas modificadas\n- [ ] Geofence detecta saída da base\n- [ ] Trip inicia automaticamente com velocidade\n- [ ] GPS tracking envia telemetria\n- [ ] Parser NLP reconhece clientes corretamente\n- [ ] Checklist salva e atualiza `visit.updatedAt`\n- [ ] Logout limpa banco local e sessão\n\n### Testando Offline\n\n1. Ativar modo avião\n2. Tentar marcar visita como concluída\n3. Verificar outbox: `SELECT * FROM outbox`\n4. Desativar modo avião\n5. Verificar que ação foi sincronizada\n\n## 🐛 Troubleshooting\n\n### \"Network Error\" no login\n- Verifique se backend está em HTTPS\n- Confirme URL correta em `src/api/client.ts`\n- Teste com `curl -v https://seu-repl.replit.app/api/user`\n\n### Delta-sync não funciona\n- Backend deve atualizar `updatedAt` em TODAS mutations\n- Verificar tabelas CRM: `createdAt`, `updatedAt` são obrigatórios\n- Checar timezone: usar sempre UTC\n\n### Geofence não detecta saída\n- Permissões de localização em background (Android 10+)\n- Raio muito pequeno (testar com 300-500m)\n- Velocidade muito baixa (mínimo 15km/h)\n\n### Trip não inicia automaticamente\n- Verificar logs: `await Location.hasStartedGeofencingAsync(GEOFENCE_TASK)`\n- Confirmar que `lastExitAt` foi registrado\n- Testar manualmente: `POST /api/trips/start`\n\n## 📚 Referências\n\n- [Expo Location](https://docs.expo.dev/versions/latest/sdk/location/)\n- [Expo SQLite](https://docs.expo.dev/versions/latest/sdk/sqlite/)\n- [Expo Task Manager](https://docs.expo.dev/versions/latest/sdk/task-manager/)\n- [React Native Maps](https://github.com/react-native-maps/react-native-maps)\n\n## 🚀 Próximos Passos\n\n- [ ] Adicionar upload de fotos em checklists\n- [ ] Implementar assinaturas digitais\n- [ ] Cache de mapas offline (react-native-offline-maps)\n- [ ] Push notifications (Expo Notifications)\n- [ ] Modo escuro\n","size_bytes":6842},"crm-agro-mobile/src/features/screens/ProfileScreen.tsx":{"content":"import React from \"react\";\nimport { View, Text, Button, Alert } from \"react-native\";\nimport { useAuth } from \"@auth/AuthContext\";\nimport * as Location from \"expo-location\";\n\nexport default function ProfileScreen() {\n  const { user, logout } = useAuth();\n\n  async function checkPerms() {\n    const fg = await Location.getForegroundPermissionsAsync();\n    const bg = await Location.getBackgroundPermissionsAsync();\n    Alert.alert(\n      \"Permissões\",\n      `Foreground: ${fg.status}\\nBackground: ${bg.status}`\n    );\n  }\n\n  return (\n    <View style={{ flex: 1, padding: 16, gap: 16 }}>\n      <Text style={{ fontWeight: \"bold\", fontSize: 16 }}>Perfil</Text>\n      <Text>Usuário: {user?.username}</Text>\n      <Text>Papel: {user?.role}</Text>\n\n      <Button title=\"Ver permissões de GPS\" onPress={checkPerms} />\n      <Button title=\"Sair\" color=\"#c0392b\" onPress={logout} />\n    </View>\n  );\n}\n","size_bytes":894},"client/src/pages/crm/reports.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { db } from \"@/lib/crm/idb\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Download, FileText, Table } from \"lucide-react\";\n\ntype Visit = {\n  id: string;\n  client_id: string;\n  status: string;\n  window_start?: string | null;\n  window_end?: string | null;\n  notes?: string | null;\n};\n\nexport default function CRMReports() {\n  const [visits, setVisits] = useState<Visit[]>([]);\n  const [startDate, setStartDate] = useState(\"\");\n  const [endDate, setEndDate] = useState(\"\");\n  const [statusFilter, setStatusFilter] = useState(\"ALL\");\n\n  useEffect(() => {\n    loadVisits();\n  }, []);\n\n  async function loadVisits() {\n    const data = await db.visits.toArray();\n    setVisits(data as any);\n  }\n\n  const filteredVisits = visits.filter((v) => {\n    if (statusFilter !== \"ALL\" && v.status !== statusFilter) return false;\n    if (startDate && v.window_start && v.window_start < startDate) return false;\n    if (endDate && v.window_end && v.window_end > endDate) return false;\n    return true;\n  });\n\n  function exportToCSV() {\n    const headers = [\"ID\", \"Cliente\", \"Status\", \"Início\", \"Fim\", \"Notas\"];\n    const rows = filteredVisits.map((v) => [\n      v.id,\n      v.client_id,\n      v.status,\n      v.window_start || \"\",\n      v.window_end || \"\",\n      v.notes || \"\",\n    ]);\n\n    const csv = [headers, ...rows].map((row) => row.join(\",\")).join(\"\\n\");\n    const blob = new Blob([csv], { type: \"text/csv\" });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement(\"a\");\n    a.href = url;\n    a.download = `relatorio_visitas_${new Date().toISOString().slice(0, 10)}.csv`;\n    a.click();\n  }\n\n  function exportToJSON() {\n    const json = JSON.stringify(filteredVisits, null, 2);\n    const blob = new Blob([json], { type: \"application/json\" });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement(\"a\");\n    a.href = url;\n    a.download = `relatorio_visitas_${new Date().toISOString().slice(0, 10)}.json`;\n    a.click();\n  }\n\n  const stats = {\n    total: filteredVisits.length,\n    planejadas: filteredVisits.filter((v) => v.status === \"PLANEJADA\").length,\n    concluidas: filteredVisits.filter((v) => v.status === \"CONCLUIDA\").length,\n    noLocal: filteredVisits.filter((v) => v.status === \"NO_LOCAL\").length,\n  };\n\n  return (\n    <div className=\"p-4 space-y-4\">\n      <Card>\n        <CardHeader>\n          <CardTitle>📊 Relatórios e Exportação</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {/* Filters */}\n          <div className=\"grid grid-cols-2 gap-3\">\n            <div>\n              <label className=\"block mb-2 text-sm font-medium\">Data Início</label>\n              <input\n                type=\"date\"\n                value={startDate}\n                onChange={(e) => setStartDate(e.target.value)}\n                className=\"w-full p-2 border rounded\"\n              />\n            </div>\n            <div>\n              <label className=\"block mb-2 text-sm font-medium\">Data Fim</label>\n              <input\n                type=\"date\"\n                value={endDate}\n                onChange={(e) => setEndDate(e.target.value)}\n                className=\"w-full p-2 border rounded\"\n              />\n            </div>\n          </div>\n\n          <div>\n            <label className=\"block mb-2 text-sm font-medium\">Status</label>\n            <select\n              value={statusFilter}\n              onChange={(e) => setStatusFilter(e.target.value)}\n              className=\"w-full p-2 border rounded\"\n            >\n              <option value=\"ALL\">Todos</option>\n              <option value=\"PLANEJADA\">Planejada</option>\n              <option value=\"PRONTA\">Pronta</option>\n              <option value=\"EM_DESLOCAMENTO\">Em Deslocamento</option>\n              <option value=\"NO_LOCAL\">No Local</option>\n              <option value=\"CONCLUIDA\">Concluída</option>\n            </select>\n          </div>\n\n          {/* Stats */}\n          <div className=\"grid grid-cols-2 gap-3 py-3\">\n            <div className=\"p-3 bg-blue-50 rounded\">\n              <p className=\"text-sm text-gray-600\">Total</p>\n              <p className=\"text-2xl font-bold\">{stats.total}</p>\n            </div>\n            <div className=\"p-3 bg-green-50 rounded\">\n              <p className=\"text-sm text-gray-600\">Concluídas</p>\n              <p className=\"text-2xl font-bold\">{stats.concluidas}</p>\n            </div>\n            <div className=\"p-3 bg-yellow-50 rounded\">\n              <p className=\"text-sm text-gray-600\">Planejadas</p>\n              <p className=\"text-2xl font-bold\">{stats.planejadas}</p>\n            </div>\n            <div className=\"p-3 bg-purple-50 rounded\">\n              <p className=\"text-sm text-gray-600\">No Local</p>\n              <p className=\"text-2xl font-bold\">{stats.noLocal}</p>\n            </div>\n          </div>\n\n          {/* Export Buttons */}\n          <div className=\"space-y-2\">\n            <Button onClick={exportToCSV} className=\"w-full\" variant=\"outline\">\n              <Table className=\"w-4 h-4 mr-2\" />\n              Exportar CSV\n            </Button>\n            <Button onClick={exportToJSON} className=\"w-full\" variant=\"outline\">\n              <FileText className=\"w-4 h-4 mr-2\" />\n              Exportar JSON\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Visit List */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Visitas Filtradas ({filteredVisits.length})</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-2 max-h-96 overflow-y-auto\">\n            {filteredVisits.map((v) => (\n              <div key={v.id} className=\"p-3 border rounded\">\n                <div className=\"flex justify-between items-start\">\n                  <div>\n                    <h5 className=\"font-medium\">{v.client_id}</h5>\n                    <p className=\"text-sm text-gray-600\">{v.status}</p>\n                  </div>\n                  <span className=\"text-xs text-gray-500\">\n                    {v.window_start ? new Date(v.window_start).toLocaleDateString() : \"-\"}\n                  </span>\n                </div>\n                {v.notes && <p className=\"text-sm mt-2\">{v.notes}</p>}\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":6439},"crm-agro-mobile/FIX_LOGIN_MAC.md":{"content":"# 🔧 FIX LOGIN - Executar no Mac\n\n## Problema Identificado\nO Replit bloqueia acesso externo de dispositivos móveis. Solução: usar LocalTunnel.\n\n---\n\n## ✅ PASSO A PASSO COMPLETO\n\n### 1️⃣ Atualizar client.ts\n\n```bash\ncd ~/Downloads/crm-agro-mobile/src/api\n\n# Backup do arquivo original\ncp client.ts client.ts.backup\n\n# Criar novo client.ts\ncat > client.ts << 'ENDOFFILE'\nimport axios from \"axios\";\n\nexport const API_BASE = \"https://mighty-seas-mix.loca.lt\";\nconsole.log(\"API_BASE carregado:\", API_BASE);\n\nexport const api = axios.create({\n  baseURL: API_BASE,\n  withCredentials: true,\n  headers: {\n    \"Content-Type\": \"application/json\",\n  },\n});\n\nexport function attachAuthInterceptors(onUnauthorized: () => void) {\n  api.interceptors.response.use(\n    (res) => res,\n    (err) => {\n      if (err?.response?.status === 401) {\n        onUnauthorized();\n      }\n      return Promise.reject(err);\n    }\n  );\n}\nENDOFFILE\n\n# Verificar se foi criado corretamente\ncat client.ts\n```\n\n---\n\n### 2️⃣ Atualizar DebugInfo.tsx\n\n```bash\ncd ~/Downloads/crm-agro-mobile/src\n\ncat > DebugInfo.tsx << 'ENDOFFILE'\nimport { useEffect, useState } from \"react\";\nimport { View, Text, Button } from \"react-native\";\nimport { API_BASE, api } from \"./api/client\";\n\nexport function DebugInfo() {\n  const [status, setStatus] = useState(\"Testando...\");\n\n  async function testConnection() {\n    try {\n      setStatus(\"Conectando...\");\n      const response = await api.get(\"/api/user\");\n      setStatus(\"CONECTADO! Status: \" + response.status);\n    } catch (err: any) {\n      const errorMsg = err.message || \"Erro desconhecido\";\n      const code = err.code || \"N/A\";\n      const responseStatus = err.response?.status || \"N/A\";\n      setStatus(\"ERRO: \" + errorMsg + \" | Code: \" + code + \" | HTTP: \" + responseStatus);\n      console.error(\"Connection test failed:\", err);\n    }\n  }\n\n  useEffect(() => {\n    testConnection();\n  }, []);\n\n  return (\n    <View style={{ backgroundColor: \"#fef3c7\", padding: 8, marginBottom: 16 }}>\n      <Text style={{ fontSize: 10, color: \"#92400e\", fontWeight: \"bold\" }}>\n        DEBUG v5.0 - {new Date().toLocaleTimeString()}\n      </Text>\n      <Text style={{ fontSize: 9, color: \"#92400e\" }}>\n        API: {API_BASE}\n      </Text>\n      <Text style={{ fontSize: 9, color: \"#92400e\", marginTop: 4 }}>\n        {status}\n      </Text>\n      <Button title=\"Testar Novamente\" onPress={testConnection} color=\"#92400e\" />\n    </View>\n  );\n}\nENDOFFILE\n\n# Verificar\ncat DebugInfo.tsx\n```\n\n---\n\n### 3️⃣ Rebuild Completo\n\n```bash\ncd ~/Downloads/crm-agro-mobile\n\n# Limpar cache\nrm -rf .expo node_modules/.cache\n\n# Rebuild\nnpx expo run:android --clear\n```\n\n---\n\n### 4️⃣ Enquanto compila: Liberar LocalTunnel\n\n**No browser do emulador Android:**\n1. Abra: `https://mighty-seas-mix.loca.lt`\n2. Role até o final da página\n3. Clique: **\"Are you the developer?\"**\n4. Isso libera o acesso permanentemente\n\n---\n\n### 5️⃣ Testar Login\n\nDepois do rebuild:\n- Usuário: `bruno`\n- Senha: `123`\n\n---\n\n## 🔍 Debug\n\n**Se ainda falhar, me envie:**\n1. Print da tela do app (deve mostrar DEBUG v5.0)\n2. Mensagem de erro completa do terminal\n3. O que aparece ao clicar em \"Testar Novamente\"\n\n---\n\n## ⚡ Atalho Rápido (Se já fez o rebuild antes)\n\n```bash\ncd ~/Downloads/crm-agro-mobile\n\n# Apenas atualizar os arquivos e reload\n# Execute os comandos cat > client.ts e cat > DebugInfo.tsx acima\n# Depois no terminal do Expo, pressione: r\n```\n","size_bytes":3434},"crm-agro-mobile/clear-all.sh":{"content":"#!/bin/bash\n# Script de limpeza completa de cache para Mac\n\necho \"🧹 Limpando cache do mobile...\"\n\n# Limpar diretórios de cache\nrm -rf .expo 2>/dev/null\nrm -rf .metro 2>/dev/null\nrm -rf node_modules/.cache 2>/dev/null\n\n# Limpar Metro Bundler cache (compatível com Mac)\nif [ -d \"$TMPDIR\" ]; then\n  find \"$TMPDIR\" -name 'metro-*' -type d -exec rm -rf {} + 2>/dev/null || true\n  find \"$TMPDIR\" -name 'haste-*' -type d -exec rm -rf {} + 2>/dev/null || true\n  find \"$TMPDIR\" -name 'react-*' -type d -exec rm -rf {} + 2>/dev/null || true\nfi\n\necho \"✅ Cache limpo!\"\necho \"\"\necho \"📱 Agora execute: npx expo start --clear\"\n","size_bytes":622},"crm-agro-mobile/src/auth/AuthContext.tsx":{"content":"import React, { createContext, useContext, useEffect, useMemo, useState } from \"react\";\nimport { api, attachAuthInterceptors } from \"@api/client\";\n\ntype User = { id: string; username: string; role: string } | null;\n\ntype AuthCtx = {\n  user: User;\n  loading: boolean;\n  login: (username: string, password: string) => Promise<void>;\n  logout: () => Promise<void>;\n  ensure: () => Promise<void>;\n};\n\nconst Ctx = createContext<AuthCtx>(null as any);\n\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\n  const [user, setUser] = useState<User>(null);\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    attachAuthInterceptors(() => setUser(null));\n    ensure();\n  }, []);\n\n  async function ensure() {\n    try {\n      setLoading(true);\n      const { data } = await api.get(\"/api/user\");\n      setUser(data || null);\n    } catch {\n      setUser(null);\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function login(username: string, password: string) {\n    await api.post(\"/api/login\", { username, password });\n    await ensure();\n  }\n\n  async function logout() {\n    try {\n      await api.post(\"/api/logout\");\n    } catch {}\n    setUser(null);\n  }\n\n  const value = useMemo(() => ({ user, loading, login, logout, ensure }), [user, loading]);\n\n  return <Ctx.Provider value={value}>{children}</Ctx.Provider>;\n}\n\nexport function useAuth() {\n  return useContext(Ctx);\n}\n","size_bytes":1417},"crm-agro-mobile/babel.config.js":{"content":"module.exports = function(api) {\n  api.cache(true);\n  return {\n    presets: ['babel-preset-expo'],\n    plugins: [\n      [\n        'module-resolver',\n        {\n          root: ['./src'],\n          extensions: ['.js', '.jsx', '.ts', '.tsx', '.json'],\n          alias: {\n            '@api': './src/api',\n            '@auth': './src/auth',\n            '@db': './src/db',\n            '@geo': './src/geo',\n            '@sync': './src/sync',\n            '@features': './src/features',\n            '@lib': './src/lib',\n          },\n        },\n      ],\n    ],\n  };\n};\n","size_bytes":559},"client/src/lib/crm/idb.ts":{"content":"import Dexie, { Table } from \"dexie\";\n\nexport type VisitLocal = {\n  id: string;\n  client_id: string;\n  farm_id?: string | null;\n  field_id?: string | null;\n  lat?: number | null;\n  lng?: number | null;\n  window_start?: string | null;\n  window_end?: string | null;\n  status: \"PLANEJADA\"|\"PRONTA\"|\"EM_DESLOCAMENTO\"|\"NO_LOCAL\"|\"CONCLUIDA\";\n  assignee?: string | null;\n  notes?: string | null;\n  photos?: { url: string; description: string; timestamp: string; }[];\n  updated_at?: string;\n};\n\nexport type ClientLocal = {\n  id: string;\n  name: string;\n  cluster?: string | null;\n  priority?: string | null;\n  isActive: boolean;\n};\n\nexport type TripPoint = {\n  id?: number;\n  trip_id: string | null;\n  ts: string;\n  lat: number;\n  lng: number;\n  speed_kmh?: number | null;\n  accuracy_m?: number | null;\n};\n\nexport type FarmLocal = {\n  id: string;\n  name: string;\n  client_id?: string | null;\n  lat?: number | null;\n  lng?: number | null;\n  address?: string | null;\n  notes?: string | null;\n};\n\nexport type FieldLocal = {\n  id: string;\n  name: string;\n  farm_id: string;\n  area?: number | null;\n  crop?: string | null;\n  notes?: string | null;\n};\n\nexport type OutboxItem = {\n  id?: number;\n  type: \"TRIP_START\"|\"TRIP_END\"|\"GPS_BATCH\"|\"CHECKLIST\"|\"VISIT_CREATE\"|\"VISIT_UPDATE\";\n  payload: any;\n  created_at: number;\n  attempts: number;\n};\n\nexport class CRMDB extends Dexie {\n  visits!: Table<VisitLocal, string>;\n  clients!: Table<ClientLocal, string>;\n  farms!: Table<FarmLocal, string>;\n  fields!: Table<FieldLocal, string>;\n  telemetry!: Table<TripPoint, number>;\n  outbox!: Table<OutboxItem, number>;\n  settings!: Table<{ key: string; value: any }, string>;\n\n  constructor() {\n    super(\"crm_agro\");\n    this.version(2).stores({\n      visits: \"id, status, assignee, window_start\",\n      clients: \"id, name\",\n      farms: \"id, name, client_id\",\n      fields: \"id, name, farm_id\",\n      telemetry: \"++id, trip_id, ts\",\n      outbox: \"++id, type, created_at, attempts\",\n      settings: \"key\"\n    });\n  }\n}\n\nexport const db = new CRMDB();\n\nexport async function putSetting<T=any>(key: string, value: T) {\n  await db.settings.put({ key, value });\n}\n\nexport async function getSetting<T=any>(key: string): Promise<T|null> {\n  const row = await db.settings.get(key);\n  return (row?.value ?? null) as T|null;\n}\n","size_bytes":2297},"client/src/pages/forgot-password.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Link } from \"wouter\";\nimport { ArrowLeft, Mail } from \"lucide-react\";\n\nconst forgotPasswordSchema = z.object({\n  username: z.string().min(1, \"Nome de usuário é obrigatório\"),\n});\n\ntype ForgotPasswordForm = z.infer<typeof forgotPasswordSchema>;\n\nexport default function ForgotPassword() {\n  const { toast } = useToast();\n  const [emailSent, setEmailSent] = useState(false);\n\n  const form = useForm<ForgotPasswordForm>({\n    resolver: zodResolver(forgotPasswordSchema),\n    defaultValues: {\n      username: \"\",\n    },\n  });\n\n  const forgotPasswordMutation = useMutation({\n    mutationFn: async (data: ForgotPasswordForm) => {\n      return await apiRequest(\"POST\", \"/api/forgot-password\", data);\n    },\n    onSuccess: () => {\n      setEmailSent(true);\n      toast({\n        title: \"Email Enviado\",\n        description: \"Se o nome de usuário existir, você receberá instruções para redefinir sua senha.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Erro\",\n        description: error.message || \"Não foi possível processar sua solicitação. Tente novamente.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: ForgotPasswordForm) => {\n    forgotPasswordMutation.mutate(data);\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 to-green-100 dark:from-gray-900 dark:to-gray-800 p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"space-y-1\">\n          <div className=\"flex items-center gap-2 mb-2\">\n            <Link href=\"/login\">\n              <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-back-to-login\">\n                <ArrowLeft className=\"h-4 w-4 mr-1\" />\n                Voltar ao Login\n              </Button>\n            </Link>\n          </div>\n          <CardTitle className=\"text-2xl font-bold text-center\">\n            Esqueci minha senha\n          </CardTitle>\n          <CardDescription className=\"text-center\">\n            Digite seu nome de usuário e enviaremos instruções para redefinir sua senha\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {emailSent ? (\n            <div className=\"text-center space-y-4\">\n              <div className=\"w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto\">\n                <Mail className=\"h-8 w-8 text-green-600 dark:text-green-400\" />\n              </div>\n              <div>\n                <h3 className=\"font-semibold text-lg mb-2\">\n                  Verifique seu email\n                </h3>\n                <p className=\"text-sm text-muted-foreground\">\n                  Se o nome de usuário informado existir em nosso sistema, você receberá um email com instruções para redefinir sua senha.\n                </p>\n              </div>\n              <Link href=\"/login\">\n                <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-return-to-login\">\n                  Voltar ao Login\n                </Button>\n              </Link>\n            </div>\n          ) : (\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"username\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Nome de Usuário</FormLabel>\n                      <FormControl>\n                        <Input\n                          {...field}\n                          placeholder=\"Digite seu nome de usuário\"\n                          data-testid=\"input-username\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <Button\n                  type=\"submit\"\n                  className=\"w-full\"\n                  disabled={forgotPasswordMutation.isPending}\n                  data-testid=\"button-submit-forgot-password\"\n                >\n                  {forgotPasswordMutation.isPending ? \"Enviando...\" : \"Enviar Instruções\"}\n                </Button>\n              </form>\n            </Form>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":4941},"server/email.ts":{"content":"import nodemailer from \"nodemailer\";\n\ninterface EmailConfig {\n  host?: string;\n  port?: number;\n  secure?: boolean;\n  auth?: {\n    user?: string;\n    pass?: string;\n  };\n}\n\nclass EmailService {\n  private transporter: nodemailer.Transporter | null = null;\n\n  constructor() {\n    this.initializeTransporter();\n  }\n\n  private initializeTransporter() {\n    const emailHost = process.env.EMAIL_HOST;\n    const emailPort = process.env.EMAIL_PORT;\n    const emailUser = process.env.EMAIL_USER;\n    const emailPass = process.env.EMAIL_PASS;\n\n    if (emailHost && emailUser && emailPass) {\n      this.transporter = nodemailer.createTransporter({\n        host: emailHost,\n        port: emailPort ? parseInt(emailPort) : 587,\n        secure: emailPort === \"465\",\n        auth: {\n          user: emailUser,\n          pass: emailPass,\n        },\n      });\n    } else {\n      console.warn(\"Email credentials not configured. Password reset emails will not be sent.\");\n      this.transporter = null;\n    }\n  }\n\n  async sendPasswordResetEmail(to: string, resetToken: string, userName: string): Promise<boolean> {\n    if (!this.transporter) {\n      console.error(\"Email transporter not configured\");\n      return false;\n    }\n\n    const resetUrl = `${process.env.REPLIT_DEV_DOMAIN || 'http://localhost:5000'}/reset-password/${resetToken}`;\n\n    try {\n      await this.transporter.sendMail({\n        from: `\"Agro Farm Digital\" <${process.env.EMAIL_USER}>`,\n        to,\n        subject: \"Recuperação de Senha - Agro Farm Digital\",\n        html: `\n          <div style=\"font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;\">\n            <h2 style=\"color: #22c55e;\">Recuperação de Senha</h2>\n            <p>Olá, <strong>${userName}</strong>!</p>\n            <p>Você solicitou a recuperação de senha para sua conta no <strong>Agro Farm Digital</strong>.</p>\n            <p>Clique no botão abaixo para redefinir sua senha:</p>\n            <div style=\"margin: 30px 0;\">\n              <a href=\"${resetUrl}\" \n                 style=\"background-color: #22c55e; color: white; padding: 12px 24px; \n                        text-decoration: none; border-radius: 4px; display: inline-block;\">\n                Redefinir Senha\n              </a>\n            </div>\n            <p>Ou copie e cole este link no seu navegador:</p>\n            <p style=\"background-color: #f3f4f6; padding: 10px; border-radius: 4px; word-break: break-all;\">\n              ${resetUrl}\n            </p>\n            <p style=\"color: #6b7280; font-size: 14px; margin-top: 30px;\">\n              <strong>Este link expira em 1 hora.</strong>\n            </p>\n            <p style=\"color: #6b7280; font-size: 14px;\">\n              Se você não solicitou esta recuperação de senha, ignore este email.\n            </p>\n            <hr style=\"border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;\">\n            <p style=\"color: #9ca3af; font-size: 12px;\">\n              Agro Farm Digital - Sistema de Gestão Agrícola\n            </p>\n          </div>\n        `,\n      });\n      \n      return true;\n    } catch (error) {\n      console.error(\"Error sending password reset email:\", error);\n      return false;\n    }\n  }\n\n  isConfigured(): boolean {\n    return this.transporter !== null;\n  }\n}\n\nexport const emailService = new EmailService();\n","size_bytes":3306},"client/src/pages/reset-password.tsx":{"content":"import { useState } from \"react\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { z } from \"zod\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Button } from \"@/components/ui/button\";\nimport {\n  Form,\n  FormControl,\n  FormField,\n  FormItem,\n  FormLabel,\n  FormMessage,\n} from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Link, useParams, useLocation } from \"wouter\";\nimport { CheckCircle2, XCircle } from \"lucide-react\";\n\nconst resetPasswordSchema = z.object({\n  newPassword: z.string().min(6, \"A senha deve ter pelo menos 6 caracteres\"),\n  confirmPassword: z.string().min(6, \"A senha deve ter pelo menos 6 caracteres\"),\n}).refine((data) => data.newPassword === data.confirmPassword, {\n  message: \"As senhas não coincidem\",\n  path: [\"confirmPassword\"],\n});\n\ntype ResetPasswordForm = z.infer<typeof resetPasswordSchema>;\n\nexport default function ResetPassword() {\n  const { token } = useParams<{ token: string }>();\n  const [, setLocation] = useLocation();\n  const { toast } = useToast();\n  const [resetSuccess, setResetSuccess] = useState(false);\n\n  const form = useForm<ResetPasswordForm>({\n    resolver: zodResolver(resetPasswordSchema),\n    defaultValues: {\n      newPassword: \"\",\n      confirmPassword: \"\",\n    },\n  });\n\n  const resetPasswordMutation = useMutation({\n    mutationFn: async (data: ResetPasswordForm) => {\n      return await apiRequest(\"POST\", \"/api/reset-password\", {\n        token,\n        newPassword: data.newPassword,\n      });\n    },\n    onSuccess: () => {\n      setResetSuccess(true);\n      toast({\n        title: \"Senha Redefinida\",\n        description: \"Sua senha foi alterada com sucesso. Você pode fazer login agora.\",\n      });\n      \n      setTimeout(() => {\n        setLocation(\"/login\");\n      }, 3000);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Erro\",\n        description: error.message || \"Não foi possível redefinir sua senha. O link pode estar expirado.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: ResetPasswordForm) => {\n    resetPasswordMutation.mutate(data);\n  };\n\n  if (!token) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 to-green-100 dark:from-gray-900 dark:to-gray-800 p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardHeader>\n            <div className=\"w-16 h-16 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center mx-auto mb-4\">\n              <XCircle className=\"h-8 w-8 text-red-600 dark:text-red-400\" />\n            </div>\n            <CardTitle className=\"text-center\">Link Inválido</CardTitle>\n            <CardDescription className=\"text-center\">\n              Este link de redefinição de senha é inválido.\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Link href=\"/login\">\n              <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-back-to-login\">\n                Voltar ao Login\n              </Button>\n            </Link>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-green-50 to-green-100 dark:from-gray-900 dark:to-gray-800 p-4\">\n      <Card className=\"w-full max-w-md\">\n        <CardHeader className=\"space-y-1\">\n          <CardTitle className=\"text-2xl font-bold text-center\">\n            Redefinir Senha\n          </CardTitle>\n          <CardDescription className=\"text-center\">\n            Digite sua nova senha abaixo\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {resetSuccess ? (\n            <div className=\"text-center space-y-4\">\n              <div className=\"w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto\">\n                <CheckCircle2 className=\"h-8 w-8 text-green-600 dark:text-green-400\" />\n              </div>\n              <div>\n                <h3 className=\"font-semibold text-lg mb-2\">\n                  Senha Redefinida com Sucesso!\n                </h3>\n                <p className=\"text-sm text-muted-foreground\">\n                  Sua senha foi alterada. Redirecionando para o login...\n                </p>\n              </div>\n            </div>\n          ) : (\n            <Form {...form}>\n              <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-4\">\n                <FormField\n                  control={form.control}\n                  name=\"newPassword\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Nova Senha</FormLabel>\n                      <FormControl>\n                        <Input\n                          {...field}\n                          type=\"password\"\n                          placeholder=\"Digite sua nova senha\"\n                          data-testid=\"input-new-password\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"confirmPassword\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Confirmar Nova Senha</FormLabel>\n                      <FormControl>\n                        <Input\n                          {...field}\n                          type=\"password\"\n                          placeholder=\"Confirme sua nova senha\"\n                          data-testid=\"input-confirm-password\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <Button\n                  type=\"submit\"\n                  className=\"w-full\"\n                  disabled={resetPasswordMutation.isPending}\n                  data-testid=\"button-submit-reset-password\"\n                >\n                  {resetPasswordMutation.isPending ? \"Redefinindo...\" : \"Redefinir Senha\"}\n                </Button>\n\n                <Link href=\"/login\">\n                  <Button variant=\"ghost\" className=\"w-full\" data-testid=\"button-cancel\">\n                    Cancelar\n                  </Button>\n                </Link>\n              </form>\n            </Form>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":6752},"client/src/components/MarketManagementPanel.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card } from \"@/components/ui/card\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Loader2, Wheat, CreditCard, TrendingUp, ChevronDown, ChevronRight } from \"lucide-react\";\n\ninterface MarketManagementPanelProps {\n  clientId: string;\n  clientName: string;\n  seasonId: string;\n  isOpen: boolean;\n  onClose: () => void;\n  onNextClient?: () => void;\n  hasNextClient?: boolean;\n}\n\ninterface CategoryData {\n  categoryId: string;\n  categoryName: string;\n  categoryType: string;\n  potencial: number;\n  cVale: number;\n  mercado: number;\n  subcategories?: Record<string, { mercado: number; cVale: number }>;\n}\n\ninterface ProductData {\n  globalApplicationId: string;\n  productName: string;\n  pricePerHa: number;\n  totalValue: number;\n  trackingId: string | null;\n}\n\ninterface ApplicationData {\n  categoria: string;\n  applicationNumber: number;\n  products: ProductData[];\n  totalValue: number;\n  status: 'ABERTO' | 'FECHADO' | null;\n}\n\nexport default function MarketManagementPanel({ \n  clientId, \n  clientName, \n  seasonId, \n  isOpen, \n  onClose,\n  onNextClient,\n  hasNextClient = false\n}: MarketManagementPanelProps) {\n  const { toast } = useToast();\n  const [expandedCategories, setExpandedCategories] = useState<Set<string>>(new Set());\n  const [editedValues, setEditedValues] = useState<{\n    creditLine?: number;\n    marketValues: Record<string, { value: number; subcategories?: Record<string, number> }>;\n    applicationStatuses: Record<string, 'ABERTO' | 'FECHADO' | null>;\n  }>({\n    marketValues: {},\n    applicationStatuses: {}\n  });\n\n  // Fetch data\n  const { data, isLoading, refetch } = useQuery({\n    queryKey: ['client-market-panel', clientId, seasonId],\n    queryFn: async () => {\n      const res = await fetch(`/api/client-market-panel/${clientId}/${seasonId}`);\n      if (!res.ok) throw new Error('Failed to fetch data');\n      return res.json();\n    },\n    enabled: isOpen && !!clientId && !!seasonId\n  });\n\n  // Reset edited values when client changes\n  useEffect(() => {\n    setEditedValues({\n      marketValues: {},\n      applicationStatuses: {}\n    });\n    setExpandedCategories(new Set());\n  }, [clientId, seasonId]);\n\n  // Helper function to get the current status (respects null as intentional clear)\n  const getApplicationStatus = (appKey: string, originalStatus: 'ABERTO' | 'FECHADO' | null) => {\n    return appKey in editedValues.applicationStatuses \n      ? editedValues.applicationStatuses[appKey] \n      : originalStatus;\n  };\n\n  // Save mutation\n  const saveMutation = useMutation({\n    mutationFn: async () => {\n      // Only save manually edited market values (if any)\n      const manualMarketValues = Object.entries(editedValues.marketValues).map(([categoryId, data]) => ({\n        categoryId,\n        marketValue: data.value,\n        subcategories: data.subcategories\n      }));\n      \n      const payload = {\n        seasonId,\n        creditLine: editedValues.creditLine,\n        marketValues: manualMarketValues,\n        applicationStatuses: Object.entries(editedValues.applicationStatuses).map(([id, status]) => ({\n          id,\n          status\n        }))\n      };\n      console.log(\"PATCH payload:\", payload);\n      return apiRequest('PATCH', `/api/client-market-panel/${clientId}`, payload);\n    },\n    onError: (error: any) => {\n      console.error(\"Save error:\", error);\n      toast({ title: \"Erro ao salvar dados\", description: error?.message || \"Erro desconhecido\", variant: \"destructive\" });\n    }\n  });\n\n  // Calculate FECHADO applications totals\n  const calculateFechadoValues = () => {\n    const fechadoByCategory: Record<string, { total: number; subcategories: Record<string, number> }> = {};\n    \n    // Map application categories to subcategories\n    const categoryMapping: Record<string, string> = {\n      'FUNGICIDAS': 'Fungicidas',\n      'INSETICIDAS': 'Inseticidas',\n      'DESSECAÇÃO': 'Dessecação',\n      'TRATAMENTO DE SEMENTE': 'Tratamento de semente'\n    };\n    \n    data?.applications?.forEach((app: ApplicationData) => {\n      const appKey = `${app.categoria}-${app.applicationNumber}`;\n      const status = getApplicationStatus(appKey, app.status);\n      \n      if (status === 'FECHADO') {\n        const subcategoryName = categoryMapping[app.categoria] || app.categoria;\n        \n        // Find the category ID for Agroquímicos\n        const agroquimicosCategory = data?.categories?.find((c: any) => c.type === 'agroquimicos');\n        if (agroquimicosCategory) {\n          if (!fechadoByCategory[agroquimicosCategory.id]) {\n            fechadoByCategory[agroquimicosCategory.id] = { total: 0, subcategories: {} };\n          }\n          fechadoByCategory[agroquimicosCategory.id].subcategories[subcategoryName] = \n            (fechadoByCategory[agroquimicosCategory.id].subcategories[subcategoryName] || 0) + app.totalValue;\n          fechadoByCategory[agroquimicosCategory.id].total += app.totalValue;\n        }\n      }\n    });\n    \n    return fechadoByCategory;\n  };\n  \n  const calculatedFechadoValues = calculateFechadoValues();\n\n  // Prepare category data\n  const categories = data?.categories ?? [];\n  const seasonName = data?.season?.name?.toLowerCase();\n  const isSojaSeason = seasonName?.includes('soja') ?? false;\n  \n  const categoryData: CategoryData[] = categories\n    .map((cat: any) => {\n      const potential = data.potentials?.find((p: any) => p.categoryId === cat.id);\n      const cVale = data.cVale?.find((c: any) => c.categoryId === cat.id);\n      \n      const potencialValue = potential?.investmentPerHa * data.client.area || 0;\n      const cValeValue = cVale?.value || 0;\n      const fechadoTotal = calculatedFechadoValues[cat.id]?.total || 0;\n      \n      // Calculate Mercado = Potencial - C.Vale - FECHADO\n      const mercadoValue = potencialValue - cValeValue - fechadoTotal;\n      \n      // Calculate subcategories for Agroquímicos\n      const combinedSubcategories: Record<string, { mercado: number; cVale: number }> = {};\n      const subcategoryNames = ['Tratamento de semente', 'Dessecação', 'Inseticidas', 'Fungicidas'];\n      \n      if (cat.type === 'agroquimicos') {\n        subcategoryNames.forEach(subName => {\n          const potencialSubValue = potential?.subcategories?.[subName] ? potential.subcategories[subName] * data.client.area : 0;\n          const cValeSubValue = cVale?.subcategories?.[subName] || 0;\n          const fechadoSubValue = calculatedFechadoValues[cat.id]?.subcategories?.[subName] || 0;\n          const mercadoSubValue = potencialSubValue - cValeSubValue - fechadoSubValue;\n          \n          if (potencialSubValue > 0 || cValeSubValue > 0 || fechadoSubValue > 0) {\n            combinedSubcategories[subName] = {\n              mercado: Math.max(0, mercadoSubValue),\n              cVale: cValeSubValue\n            };\n          }\n        });\n      }\n      \n      return {\n        categoryId: cat.id,\n        categoryName: cat.name,\n        categoryType: cat.type,\n        potencial: potencialValue,\n        cVale: cValeValue,\n        mercado: Math.max(0, mercadoValue),\n        subcategories: Object.keys(combinedSubcategories).length > 0 ? combinedSubcategories : undefined\n      };\n    })\n    .filter((cat: CategoryData) => {\n      // Filter out corn-related categories when viewing SOJA season\n      if (isSojaSeason) {\n        const cornCategories = ['Sementes Diversas', 'Sementes Trigo', 'Sementes Milho', 'Outros'];\n        return !cornCategories.includes(cat.categoryName);\n      }\n      return true;\n    });\n\n  // Calculate footer values\n  const valorCapturado = data?.applications?.filter((app: ApplicationData) => {\n    const appKey = `${app.categoria}-${app.applicationNumber}`;\n    return getApplicationStatus(appKey, app.status) === 'ABERTO';\n  }).reduce((sum: number, app: ApplicationData) => sum + app.totalValue, 0) || 0;\n\n  const toggleCategory = (categoryType: string) => {\n    const newExpanded = new Set(expandedCategories);\n    if (newExpanded.has(categoryType)) {\n      newExpanded.delete(categoryType);\n    } else {\n      newExpanded.add(categoryType);\n    }\n    setExpandedCategories(newExpanded);\n  };\n\n  const formatCurrency = (value: number) => {\n    return new Intl.NumberFormat('en-US', {\n      style: 'currency',\n      currency: 'USD',\n      minimumFractionDigits: 0\n    }).format(value);\n  };\n\n  if (!isOpen) return null;\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-7xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"text-2xl font-bold\">{clientName}</DialogTitle>\n        </DialogHeader>\n\n        {isLoading ? (\n          <div className=\"flex items-center justify-center py-12\">\n            <Loader2 className=\"h-8 w-8 animate-spin text-primary\" />\n          </div>\n        ) : (\n          <div className=\"space-y-6\">\n            {/* Top Cards */}\n            <div className=\"grid grid-cols-4 gap-4\">\n              <Card className=\"p-4 border-2 shadow-sm\">\n                <div className=\"flex items-center justify-center gap-2 text-amber-600 mb-2\">\n                  <Wheat className=\"h-5 w-5\" />\n                  <span className=\"text-sm font-medium\">Área de Plantio</span>\n                </div>\n                <div className=\"text-center text-2xl font-bold\">{data?.client?.area || 0} ha</div>\n              </Card>\n\n              <Card className=\"p-4 border-2 shadow-sm\">\n                <div className=\"flex items-center justify-center gap-2 text-blue-600 mb-2\">\n                  <CreditCard className=\"h-5 w-5\" />\n                  <span className=\"text-sm font-medium\">Linha de Crédito</span>\n                </div>\n                <Input\n                  type=\"number\"\n                  className=\"text-center text-xl font-semibold\"\n                  value={editedValues.creditLine ?? data?.client?.creditLine ?? ''}\n                  onChange={(e) => setEditedValues(prev => ({ \n                    ...prev, \n                    creditLine: parseFloat(e.target.value) || 0 \n                  }))}\n                  data-testid=\"input-credit-line\"\n                />\n              </Card>\n\n              <Card className=\"p-4 border-2 shadow-sm bg-green-50 dark:bg-green-950/20\">\n                <div className=\"flex items-center justify-center gap-2 text-green-600 mb-2\">\n                  <TrendingUp className=\"h-5 w-5\" />\n                  <span className=\"text-sm font-medium\">Vendas (safra Atual)</span>\n                </div>\n                <div className=\"text-center text-2xl font-bold text-green-700\">\n                  {formatCurrency(data?.sales?.currentSeason || 0)}\n                </div>\n              </Card>\n\n              <Card className=\"p-4 border-2 shadow-sm bg-gray-50 dark:bg-gray-950/20\">\n                <div className=\"flex items-center justify-center gap-2 text-gray-600 mb-2\">\n                  <TrendingUp className=\"h-5 w-5\" />\n                  <span className=\"text-sm font-medium\">Vendas (safra anterior)</span>\n                </div>\n                <div className=\"text-center text-2xl font-bold text-gray-700\">\n                  {formatCurrency(data?.sales?.previousSeason || 0)}\n                </div>\n              </Card>\n            </div>\n\n            {/* Main Content - Two Columns */}\n            <div className=\"grid grid-cols-2 gap-6\">\n              {/* Left Side - Potencial/C Vale/Mercado Table */}\n              <div className=\"space-y-2\">\n                <div className=\"grid grid-cols-4 gap-2 text-center font-semibold text-sm border-b-2 pb-2\">\n                  <div className=\"text-left\">Categorias</div>\n                  <div>Potencial</div>\n                  <div>C Vale</div>\n                  <div>Mercado</div>\n                </div>\n\n                {categoryData.map((category) => (\n                  <div key={category.categoryId} className=\"space-y-1\">\n                    <div className=\"grid grid-cols-4 gap-2 items-center\">\n                      <div className=\"flex items-center gap-1 col-span-1\">\n                        <span className=\"text-lg\">{getCategoryIcon(category.categoryType)}</span>\n                        <span className=\"text-sm font-medium\">{category.categoryName}</span>\n                        {category.categoryType === 'agroquimicos' && (\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            className=\"h-6 w-6 p-0\"\n                            onClick={() => toggleCategory(category.categoryType)}\n                            data-testid={`button-toggle-agroquimicos`}\n                          >\n                            {expandedCategories.has(category.categoryType) ? (\n                              <ChevronDown className=\"h-4 w-4\" />\n                            ) : (\n                              <ChevronRight className=\"h-4 w-4\" />\n                            )}\n                          </Button>\n                        )}\n                      </div>\n                      <div className=\"text-center text-green-600 font-semibold text-sm\">\n                        {formatCurrency(category.potencial)}\n                      </div>\n                      <div className=\"text-center font-semibold text-sm\">\n                        {formatCurrency(category.cVale)}\n                      </div>\n                      <div className=\"text-center font-semibold text-sm\">\n                        {formatCurrency(editedValues.marketValues[category.categoryId]?.value ?? category.mercado)}\n                      </div>\n                    </div>\n\n                    {/* Subcategories for Agroquímicos */}\n                    {category.categoryType === 'agroquimicos' && expandedCategories.has('agroquimicos') && category.subcategories && (\n                      <div className=\"ml-8 mt-2 border-l-2 border-green-200 pl-4\">\n                        <div className=\"grid grid-cols-4 gap-4 text-xs font-medium text-gray-500 mb-1\">\n                          <div></div>\n                          <div></div>\n                          <div className=\"text-center\">C.Vale</div>\n                          <div className=\"text-center\">Perdido</div>\n                        </div>\n                        {Object.entries(category.subcategories).map(([sub, values]) => (\n                          <div key={sub} className=\"grid grid-cols-4 gap-4 text-xs text-gray-700 py-0.5\">\n                            <div className=\"col-span-2\">{sub}</div>\n                            <div className=\"text-center font-semibold text-blue-600\">\n                              {formatCurrency(values.cVale)}\n                            </div>\n                            <div className=\"text-center font-semibold text-red-600\">\n                              {formatCurrency(values.mercado)}\n                            </div>\n                          </div>\n                        ))}\n                      </div>\n                    )}\n                  </div>\n                ))}\n              </div>\n\n              {/* Right Side - Applications Table */}\n              <div className=\"space-y-4\">\n                <div className=\"font-semibold text-center pb-2 border-b-2\">\n                  Oportunidades de Mercado\n                </div>\n\n                <Tabs defaultValue=\"fungicidas\" className=\"w-full\">\n                  <TabsList className=\"grid w-full grid-cols-4\">\n                    <TabsTrigger value=\"fungicidas\">Fungicidas</TabsTrigger>\n                    <TabsTrigger value=\"inseticidas\">Inseticidas</TabsTrigger>\n                    <TabsTrigger value=\"ts\">TS</TabsTrigger>\n                    <TabsTrigger value=\"dessecacao\">Dessecação</TabsTrigger>\n                  </TabsList>\n\n                  <TabsContent value=\"fungicidas\" className=\"space-y-2 mt-4\">\n                    <div className=\"grid grid-cols-12 gap-2 text-xs font-medium text-gray-500 border-b pb-1\">\n                      <div className=\"col-span-2\">Aplicação</div>\n                      <div className=\"col-span-5\">Produto</div>\n                      <div className=\"col-span-2 text-right\">Potencial</div>\n                      <div className=\"col-span-3 text-center\">Status</div>\n                    </div>\n                    {data?.applications?.filter((app: ApplicationData) => app.categoria === 'FUNGICIDAS').map((app: ApplicationData) => {\n                      const appKey = `${app.categoria}-${app.applicationNumber}`;\n                      const productsText = app.products.map(p => p.productName).join(' + ');\n                      return (\n                        <div key={appKey} className=\"grid grid-cols-12 gap-2 items-center text-xs p-2 border rounded\">\n                          <div className=\"col-span-2 font-medium\">\n                            Fungicida {app.applicationNumber}\n                          </div>\n                          <div className=\"col-span-5 text-gray-700\">\n                            {productsText}\n                          </div>\n                          <div className=\"col-span-2 text-right font-semibold\">\n                            {formatCurrency(app.totalValue)}\n                          </div>\n                          <div className=\"col-span-3 flex items-center justify-center gap-2\">\n                            <label className=\"flex items-center gap-1 cursor-pointer\">\n                              <Checkbox\n                                checked={getApplicationStatus(appKey, app.status) === 'FECHADO'}\n                                onCheckedChange={(checked) => {\n                                  setEditedValues(prev => ({\n                                    ...prev,\n                                    applicationStatuses: {\n                                      ...prev.applicationStatuses,\n                                      [appKey]: checked ? 'FECHADO' : null\n                                    }\n                                  }));\n                                }}\n                                data-testid={`checkbox-fechado-${appKey}`}\n                              />\n                              <span className=\"text-red-600 text-xs\">Fechado</span>\n                            </label>\n                            <label className=\"flex items-center gap-1 cursor-pointer\">\n                              <Checkbox\n                                checked={getApplicationStatus(appKey, app.status) === 'ABERTO'}\n                                onCheckedChange={(checked) => {\n                                  setEditedValues(prev => ({\n                                    ...prev,\n                                    applicationStatuses: {\n                                      ...prev.applicationStatuses,\n                                      [appKey]: checked ? 'ABERTO' : null\n                                    }\n                                  }));\n                                }}\n                                data-testid={`checkbox-aberto-${appKey}`}\n                              />\n                              <span className=\"text-green-600 text-xs\">Aberto</span>\n                            </label>\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </TabsContent>\n\n                  <TabsContent value=\"inseticidas\" className=\"space-y-2 mt-4\">\n                    <div className=\"grid grid-cols-12 gap-2 text-xs font-medium text-gray-500 border-b pb-1\">\n                      <div className=\"col-span-2\">Aplicação</div>\n                      <div className=\"col-span-5\">Produto</div>\n                      <div className=\"col-span-2 text-right\">Potencial</div>\n                      <div className=\"col-span-3 text-center\">Status</div>\n                    </div>\n                    {data?.applications?.filter((app: ApplicationData) => app.categoria === 'INSETICIDAS').map((app: ApplicationData) => {\n                      const appKey = `${app.categoria}-${app.applicationNumber}`;\n                      const productsText = app.products.map(p => p.productName).join(' + ');\n                      return (\n                        <div key={appKey} className=\"grid grid-cols-12 gap-2 items-center text-xs p-2 border rounded\">\n                          <div className=\"col-span-2 font-medium\">\n                            Inseticida {app.applicationNumber}\n                          </div>\n                          <div className=\"col-span-5 text-gray-700\">\n                            {productsText}\n                          </div>\n                          <div className=\"col-span-2 text-right font-semibold\">\n                            {formatCurrency(app.totalValue)}\n                          </div>\n                          <div className=\"col-span-3 flex items-center justify-center gap-2\">\n                            <label className=\"flex items-center gap-1 cursor-pointer\">\n                              <Checkbox\n                                checked={getApplicationStatus(appKey, app.status) === 'FECHADO'}\n                                onCheckedChange={(checked) => {\n                                  setEditedValues(prev => ({\n                                    ...prev,\n                                    applicationStatuses: {\n                                      ...prev.applicationStatuses,\n                                      [appKey]: checked ? 'FECHADO' : null\n                                    }\n                                  }));\n                                }}\n                                data-testid={`checkbox-fechado-${appKey}`}\n                              />\n                              <span className=\"text-red-600 text-xs\">Fechado</span>\n                            </label>\n                            <label className=\"flex items-center gap-1 cursor-pointer\">\n                              <Checkbox\n                                checked={getApplicationStatus(appKey, app.status) === 'ABERTO'}\n                                onCheckedChange={(checked) => {\n                                  setEditedValues(prev => ({\n                                    ...prev,\n                                    applicationStatuses: {\n                                      ...prev.applicationStatuses,\n                                      [appKey]: checked ? 'ABERTO' : null\n                                    }\n                                  }));\n                                }}\n                                data-testid={`checkbox-aberto-${appKey}`}\n                              />\n                              <span className=\"text-green-600 text-xs\">Aberto</span>\n                            </label>\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </TabsContent>\n\n                  <TabsContent value=\"ts\" className=\"space-y-2 mt-4\">\n                    <div className=\"grid grid-cols-12 gap-2 text-xs font-medium text-gray-500 border-b pb-1\">\n                      <div className=\"col-span-2\">Aplicação</div>\n                      <div className=\"col-span-5\">Produto</div>\n                      <div className=\"col-span-2 text-right\">Potencial</div>\n                      <div className=\"col-span-3 text-center\">Status</div>\n                    </div>\n                    {data?.applications?.filter((app: ApplicationData) => app.categoria === 'TRATAMENTO DE SEMENTE').map((app: ApplicationData) => {\n                      const appKey = `${app.categoria}-${app.applicationNumber}`;\n                      const productsText = app.products.map(p => p.productName).join(' + ');\n                      return (\n                        <div key={appKey} className=\"grid grid-cols-12 gap-2 items-center text-xs p-2 border rounded\">\n                          <div className=\"col-span-2 font-medium\">\n                            TS {app.applicationNumber}\n                          </div>\n                          <div className=\"col-span-5 text-gray-700\">\n                            {productsText}\n                          </div>\n                          <div className=\"col-span-2 text-right font-semibold\">\n                            {formatCurrency(app.totalValue)}\n                          </div>\n                          <div className=\"col-span-3 flex items-center justify-center gap-2\">\n                            <label className=\"flex items-center gap-1 cursor-pointer\">\n                              <Checkbox\n                                checked={getApplicationStatus(appKey, app.status) === 'FECHADO'}\n                                onCheckedChange={(checked) => {\n                                  setEditedValues(prev => ({\n                                    ...prev,\n                                    applicationStatuses: {\n                                      ...prev.applicationStatuses,\n                                      [appKey]: checked ? 'FECHADO' : null\n                                    }\n                                  }));\n                                }}\n                                data-testid={`checkbox-fechado-${appKey}`}\n                              />\n                              <span className=\"text-red-600 text-xs\">Fechado</span>\n                            </label>\n                            <label className=\"flex items-center gap-1 cursor-pointer\">\n                              <Checkbox\n                                checked={getApplicationStatus(appKey, app.status) === 'ABERTO'}\n                                onCheckedChange={(checked) => {\n                                  setEditedValues(prev => ({\n                                    ...prev,\n                                    applicationStatuses: {\n                                      ...prev.applicationStatuses,\n                                      [appKey]: checked ? 'ABERTO' : null\n                                    }\n                                  }));\n                                }}\n                                data-testid={`checkbox-aberto-${appKey}`}\n                              />\n                              <span className=\"text-green-600 text-xs\">Aberto</span>\n                            </label>\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </TabsContent>\n\n                  <TabsContent value=\"dessecacao\" className=\"space-y-2 mt-4\">\n                    <div className=\"grid grid-cols-12 gap-2 text-xs font-medium text-gray-500 border-b pb-1\">\n                      <div className=\"col-span-2\">Aplicação</div>\n                      <div className=\"col-span-5\">Produto</div>\n                      <div className=\"col-span-2 text-right\">Potencial</div>\n                      <div className=\"col-span-3 text-center\">Status</div>\n                    </div>\n                    {data?.applications?.filter((app: ApplicationData) => app.categoria === 'DESSECAÇÃO').map((app: ApplicationData) => {\n                      const appKey = `${app.categoria}-${app.applicationNumber}`;\n                      const productsText = app.products.map(p => p.productName).join(' + ');\n                      return (\n                        <div key={appKey} className=\"grid grid-cols-12 gap-2 items-center text-xs p-2 border rounded\">\n                          <div className=\"col-span-2 font-medium\">\n                            Dessecação {app.applicationNumber}\n                          </div>\n                          <div className=\"col-span-5 text-gray-700\">\n                            {productsText}\n                          </div>\n                          <div className=\"col-span-2 text-right font-semibold\">\n                            {formatCurrency(app.totalValue)}\n                          </div>\n                          <div className=\"col-span-3 flex items-center justify-center gap-2\">\n                            <label className=\"flex items-center gap-1 cursor-pointer\">\n                              <Checkbox\n                                checked={getApplicationStatus(appKey, app.status) === 'FECHADO'}\n                                onCheckedChange={(checked) => {\n                                  setEditedValues(prev => ({\n                                    ...prev,\n                                    applicationStatuses: {\n                                      ...prev.applicationStatuses,\n                                      [appKey]: checked ? 'FECHADO' : null\n                                    }\n                                  }));\n                                }}\n                                data-testid={`checkbox-fechado-${appKey}`}\n                              />\n                              <span className=\"text-red-600 text-xs\">Fechado</span>\n                            </label>\n                            <label className=\"flex items-center gap-1 cursor-pointer\">\n                              <Checkbox\n                                checked={getApplicationStatus(appKey, app.status) === 'ABERTO'}\n                                onCheckedChange={(checked) => {\n                                  setEditedValues(prev => ({\n                                    ...prev,\n                                    applicationStatuses: {\n                                      ...prev.applicationStatuses,\n                                      [appKey]: checked ? 'ABERTO' : null\n                                    }\n                                  }));\n                                }}\n                                data-testid={`checkbox-aberto-${appKey}`}\n                              />\n                              <span className=\"text-green-600 text-xs\">Aberto</span>\n                            </label>\n                          </div>\n                        </div>\n                      );\n                    })}\n                  </TabsContent>\n\n                  <div className=\"text-xs text-gray-500 mt-4 italic\">\n                    Marque \"Aberto\" para aplicações em negociação ou \"Fechado\" se perdeu para concorrente\n                  </div>\n                </Tabs>\n\n                {/* Footer - Valor Capturado */}\n                <div className=\"mt-6 pt-4 border-t-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <span className=\"text-sm font-medium\">Valor</span>\n                    <div className=\"flex items-center gap-2\">\n                      <div className=\"w-3 h-3 rounded-full bg-blue-500\"></div>\n                      <span className=\"font-semibold\">Capturado</span>\n                      <span className=\"text-2xl font-bold text-blue-600\">\n                        {formatCurrency(valorCapturado)}\n                      </span>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            {/* Save Buttons */}\n            <div className=\"flex justify-between gap-2 pt-4 border-t\">\n              <Button variant=\"outline\" onClick={onClose} data-testid=\"button-cancel\">\n                Cancelar\n              </Button>\n              <div className=\"flex gap-2\">\n                <Button \n                  variant=\"outline\"\n                  onClick={() => {\n                    saveMutation.mutate(undefined, {\n                      onSuccess: () => {\n                        toast({ title: \"Dados salvos com sucesso!\" });\n                        queryClient.invalidateQueries({ queryKey: ['client-market-panel'] });\n                        queryClient.invalidateQueries({ queryKey: ['kanban-metas'] });\n                        onClose();\n                      }\n                    });\n                  }} \n                  disabled={saveMutation.isPending}\n                  data-testid=\"button-save-close\"\n                >\n                  {saveMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                  Salvar e Fechar\n                </Button>\n                {hasNextClient && onNextClient && (\n                  <Button \n                    onClick={() => {\n                      saveMutation.mutate(undefined, {\n                        onSuccess: () => {\n                          toast({ title: \"Dados salvos! Próximo cliente carregado.\" });\n                          queryClient.invalidateQueries({ queryKey: ['client-market-panel'] });\n                          queryClient.invalidateQueries({ queryKey: ['kanban-metas'] });\n                          onNextClient();\n                        }\n                      });\n                    }} \n                    disabled={saveMutation.isPending}\n                    data-testid=\"button-save-next\"\n                  >\n                    {saveMutation.isPending && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\n                    Salvar e Próximo Cliente\n                  </Button>\n                )}\n              </div>\n            </div>\n          </div>\n        )}\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction getCategoryIcon(type: string): string {\n  const icons: Record<string, string> = {\n    fertilizantes: '🌱',\n    agroquimicos: '🌾',\n    especialidades: '🔬',\n    sementes: '🌽',\n    corretivos: '🔶'\n  };\n  return icons[type] || '📦';\n}\n","size_bytes":33714}},"version":2}